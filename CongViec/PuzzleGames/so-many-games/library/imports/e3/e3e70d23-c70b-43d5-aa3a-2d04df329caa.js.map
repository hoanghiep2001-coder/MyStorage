{"version":3,"sources":["assets\\src\\jump\\JumpStage.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { Block } from \"./JumpBlock\";\r\nimport { Player } from \"./JumpPlayer\";\r\nimport { JumpScene } from \"./JumpScene\";\r\n\r\nconst { ccclass, property, executeInEditMode } = cc._decorator;\r\n\r\n@ccclass\r\n// @executeInEditMode\r\nexport class Stage extends cc.Component {\r\n\r\n    @property(Player)\r\n    private player: Player = null;\r\n    @property(cc.Node)\r\n    private groundLayer: cc.Node = null;\r\n    @property(cc.Integer)\r\n    private gridNum: number = 20;\r\n    @property(cc.Graphics)\r\n    private g: cc.Graphics = null;\r\n    @property(cc.Integer)\r\n    private minBlockSpace: number = 1;//两个block最小间距\r\n    @property(cc.Integer)\r\n    private maxBlockSpace: number = 10;\r\n    @property(cc.Integer)\r\n    private minBlockLength: number = 1;\r\n    @property(cc.Integer)\r\n    private maxBlockLength: number = 7;\r\n    @property(cc.Float)\r\n    private cameraMoveDuration: number = 1;\r\n    @property(cc.Node)\r\n    private endScene: cc.Node = null;\r\n\r\n    private jumpScene: JumpScene = null;\r\n    private gridWidth: number = 32;\r\n    private groundOrigin: cc.Vec2 = cc.v2();\r\n    private offset: number = 0;\r\n    private currBlock: Block = null;// 同一屏只出现两个block，玩家站的是这个\r\n    private nextBlock: Block = null;\r\n\r\n    private playerIndex: number = null;\r\n    private animState: cc.AnimationState = null;\r\n    private isMovingStage: boolean = false;\r\n\r\n    onLoad() {\r\n        this.gridWidth = Math.floor(this.groundLayer.width / this.gridNum);\r\n        this.groundOrigin = this.groundLayer.position;\r\n    }\r\n\r\n    public init(jumpScene: JumpScene) {\r\n        this.jumpScene = jumpScene;\r\n    }\r\n\r\n    public showStartStory(cb, cbTarget) {\r\n        this.g.clear();\r\n        this.drawBlock(new Block(0, 5));\r\n        this.drawBlock(new Block(9, 5));\r\n        let anim = this.getComponent(cc.Animation);\r\n        anim.once(\"finished\", () => {\r\n            cb();\r\n        }, cbTarget);\r\n        this.animState = anim.play(\"start\");\r\n    }\r\n\r\n    public startGame() {\r\n        this.reset();\r\n    }\r\n\r\n    public endGame(cb, cbTarget) {\r\n        this.g.clear();\r\n        this.scheduleOnce(() => {\r\n            this.endScene.active = true;\r\n        }, 5);\r\n        this.scheduleOnce(() => {\r\n            this.player.node.getChildByName(\"name\").getComponent(cc.Label).string = \"\";\r\n        }, 10);\r\n        this.scheduleOnce(() => {\r\n            this.player.node.children.forEach((child) => {\r\n                child.color = new cc.Color().fromHEX(\"#58D639\");\r\n                let streak = this.player.getComponent(cc.MotionStreak);\r\n                streak.color = new cc.Color().fromHEX(\"#58D639\")\r\n            });\r\n        }, 15);\r\n        this.scheduleOnce(() => {\r\n            this.player.readyJump();\r\n        }, 20);\r\n        this.scheduleOnce(() => {\r\n            let far = cc.v2(this.player.node.x - 1000, this.player.node.y);\r\n            this.player.jumpTo(far, cb, cbTarget);\r\n        }, 25);\r\n\r\n    }\r\n\r\n    public reset() {\r\n        this.groundLayer.position = this.groundOrigin;\r\n        this.g.clear();\r\n        this.currBlock = new Block(0, 5);\r\n        this.nextBlock = new Block(9, 5);\r\n        this.drawBlock(this.currBlock);\r\n        this.drawBlock(this.nextBlock);\r\n        let center = this.currBlock.head + Math.floor(this.currBlock.length / 2);\r\n        this.playerIndex = center;\r\n        this.player.node.position = cc.v2(center * this.gridWidth + this.gridWidth / 2, 0);\r\n        this.isMovingStage = false;\r\n    }\r\n\r\n    private drawBlock(block: Block) {\r\n        this.g.rect(block.head * this.gridWidth, - this.gridWidth, this.gridWidth * block.length,this.gridWidth);\r\n        this.g.fill();\r\n    }\r\n\r\n    public addNewBlock() {\r\n        let cb = () => {\r\n            this.currBlock = this.nextBlock;\r\n            let space = Math.floor(this.minBlockSpace + Math.random() * (this.maxBlockSpace - this.minBlockSpace));\r\n            let head = this.currBlock.head + this.currBlock.length + space;\r\n            let length = Math.floor(this.minBlockLength + Math.random() * (this.maxBlockLength - this.minBlockLength));\r\n            this.nextBlock = new Block(head, length);\r\n            this.drawBlock(this.nextBlock);\r\n        }\r\n        this.moveStage(cb, this);\r\n    }\r\n\r\n    private moveStage(cb: Function, target: any) {\r\n        this.isMovingStage = true;\r\n        let moveLength = (this.nextBlock.head - this.currBlock.head) * this.gridWidth;\r\n        let moveAction = cc.moveBy(this.cameraMoveDuration, -moveLength, 0);\r\n        let action = cc.sequence(moveAction, cc.callFunc(() => {\r\n            this.isMovingStage = false;\r\n            cb();\r\n        }, target));\r\n        this.groundLayer.runAction(action);\r\n    }\r\n\r\n    private canReadyJump() {\r\n        return !this.isMovingStage && this.player.speed === 0;\r\n    }\r\n\r\n    public playerReadyJump() {\r\n        if (this.canReadyJump()) {\r\n            this.player.readyJump();\r\n        }\r\n    }\r\n\r\n    public ignoreStory() {\r\n        this.animState.speed = 4;\r\n    }\r\n\r\n    public playerDie(cb, cbTarget) {\r\n        let action = cc.sequence(cc.moveBy(1, 0, -1000), cc.callFunc(cb, cbTarget));\r\n        this.player.node.runAction(action);\r\n    }\r\n\r\n    public playerJump(cb, target) {\r\n        if (!this.player.isReadyJump) {\r\n            return;\r\n        }\r\n        let jumpGrids = Math.round(this.player.jumpDistance / this.gridWidth);\r\n        let targetGrid = this.playerIndex + jumpGrids;\r\n        let targetPos = cc.v2(this.gridWidth * targetGrid + this.gridWidth / 2, 0);\r\n        this.player.jumpTo(targetPos, () => {\r\n            this.playerIndex = targetGrid;\r\n            if (targetGrid <= this.currBlock.tail) {\r\n                cb(this.playerIndex, false);\r\n            } else if (targetGrid >= this.nextBlock.head && targetGrid <= this.nextBlock.tail) {\r\n                cb(this.playerIndex, true);\r\n            } else {\r\n                cb(-1, false);\r\n            }\r\n        }, this);\r\n    }\r\n\r\n}\r\n"]}