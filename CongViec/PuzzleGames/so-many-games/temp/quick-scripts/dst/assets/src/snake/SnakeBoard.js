
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/src/snake/SnakeBoard.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, 'a84adR6dohB5YJuAMwnUu08', 'SnakeBoard');
// src/snake/SnakeBoard.ts

Object.defineProperty(exports, "__esModule", { value: true });
var SnakeConstants_1 = require("./SnakeConstants");
var SnakePiece_1 = require("./SnakePiece");
var _a = cc._decorator, ccclass = _a.ccclass, property = _a.property;
var Board = /** @class */ (function (_super) {
    __extends(Board, _super);
    function Board() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.frameTime = 0.5;
        _this.levelRatio = 0.05;
        _this.piecePrefab = null;
        _this.layout = null;
        _this.isStart = false;
        _this.pastTime = 0;
        _this.rowsNum = 16;
        _this.colsNum = 16;
        _this.gridWidth = 0;
        _this.moveDir = SnakeConstants_1.DIRECTION.RIGHT;
        _this.level = 0;
        _this.snakeScene = null;
        return _this;
        // update(dt: number) {
        //     if (this.isStart) {
        //         this.pastTime += dt;
        //         if (this.pastTime >= this.frameTime * (this.levelRatio**this.level)) {
        //             this.moveSnake();
        //             this.pastTime = 0;
        //         }
        //     }
        // }
    }
    Board.prototype.onLoad = function () {
        this.gridWidth = this.layout.width / this.colsNum;
        this.pieceMap = [];
        for (var x = 0; x < this.colsNum; x++) {
            this.pieceMap[x] = [];
            for (var y = 0; y < this.rowsNum; y++) {
                var pieceNode = cc.instantiate(this.piecePrefab);
                this.layout.addChild(pieceNode);
                pieceNode.width = this.gridWidth;
                pieceNode.height = this.gridWidth;
                pieceNode.x = x * this.gridWidth + pieceNode.width / 2;
                pieceNode.y = y * this.gridWidth + pieceNode.height / 2;
                this.pieceMap[x][y] = pieceNode.getComponent(SnakePiece_1.Piece);
                this.pieceMap[x][y].x = x;
                this.pieceMap[x][y].y = y;
            }
        }
    };
    Board.prototype.updateTick = function () {
        this.unschedule(this.tickHandler);
        var time = this.frameTime - (this.levelRatio * this.level);
        if (time < 0.1) {
            time = 0.1;
        }
        this.schedule(this.tickHandler, time);
    };
    Board.prototype.tickHandler = function () {
        if (this.isStart) {
            this.moveSnake();
        }
    };
    Board.prototype.init = function (snakeScene) {
        this.snakeScene = snakeScene;
    };
    Board.prototype.startGame = function () {
        this.reset();
        for (var i = 0; i < 10; i++) {
            this.addFood();
        }
        this.isStart = true;
        this.updateTick();
    };
    Board.prototype.reset = function () {
        this.clear();
        this.snake = [];
        this.pieceMap[9][9].init(SnakeConstants_1.PIECE_TYPE.SNAKE_HEAD, SnakeConstants_1.DIRECTION.RIGHT, SnakeConstants_1.DIRECTION.RIGHT);
        this.pieceMap[8][9].init(SnakeConstants_1.PIECE_TYPE.SNAKE_BODY, SnakeConstants_1.DIRECTION.RIGHT, SnakeConstants_1.DIRECTION.RIGHT);
        this.pieceMap[7][9].init(SnakeConstants_1.PIECE_TYPE.SNAKE_BODY, SnakeConstants_1.DIRECTION.RIGHT, SnakeConstants_1.DIRECTION.UP);
        this.pieceMap[7][8].init(SnakeConstants_1.PIECE_TYPE.SNAKE_TAIL, SnakeConstants_1.DIRECTION.UP, SnakeConstants_1.DIRECTION.UP);
        this.snake.push(this.pieceMap[9][9]);
        this.snake.push(this.pieceMap[8][9]);
        this.snake.push(this.pieceMap[7][9]);
        this.snake.push(this.pieceMap[7][8]);
        this.moveDir = SnakeConstants_1.DIRECTION.RIGHT;
        this.level = 0;
    };
    Board.prototype.addFood = function () {
        var blankList = [];
        for (var x = 0; x < this.colsNum; x++) {
            for (var y = 0; y < this.rowsNum; y++) {
                if (this.pieceMap[x][y].type === SnakeConstants_1.PIECE_TYPE.BLANK) {
                    blankList.push(this.pieceMap[x][y]);
                }
            }
        }
        var randomPiece = blankList[(Math.random() * blankList.length) | 0];
        randomPiece.type = SnakeConstants_1.PIECE_TYPE.FOOD;
    };
    Board.prototype.clear = function () {
        for (var x = 0; x < this.colsNum; x++) {
            for (var y = 0; y < this.rowsNum; y++) {
                this.pieceMap[x][y].type = SnakeConstants_1.PIECE_TYPE.BLANK;
            }
        }
    };
    Board.prototype.updateLevel = function (level) {
        if (level !== this.level) {
            this.level = level;
            this.updateTick();
        }
    };
    Board.prototype.turnSnake = function (dir) {
        if (this.snake[0].outDir !== -dir) {
            this.moveDir = dir;
        }
    };
    Board.prototype.moveSnake = function () {
        var head = this.snake[0];
        head.inDir = this.snake[1].outDir;
        head.outDir = this.moveDir;
        var nextPiece;
        switch (head.outDir) {
            case SnakeConstants_1.DIRECTION.UP:
                if (head.y === this.rowsNum - 1) {
                    nextPiece = this.pieceMap[head.x][0];
                }
                else {
                    nextPiece = this.pieceMap[head.x][head.y + 1];
                }
                break;
            case SnakeConstants_1.DIRECTION.RIGHT:
                if (head.x === this.colsNum - 1) {
                    nextPiece = this.pieceMap[0][head.y];
                }
                else {
                    nextPiece = this.pieceMap[head.x + 1][head.y];
                }
                break;
            case SnakeConstants_1.DIRECTION.DOWN:
                if (head.y === 0) {
                    nextPiece = this.pieceMap[head.x][this.rowsNum - 1];
                }
                else {
                    nextPiece = this.pieceMap[head.x][head.y - 1];
                }
                break;
            case SnakeConstants_1.DIRECTION.LEFT:
                if (head.x === 0) {
                    nextPiece = this.pieceMap[this.colsNum - 1][head.y];
                }
                else {
                    nextPiece = this.pieceMap[head.x - 1][head.y];
                }
                break;
        }
        this.moveSnakeToPiece(nextPiece);
    };
    Board.prototype.moveSnakeToPiece = function (nextPiece) {
        var head = this.snake[0];
        switch (nextPiece.type) {
            case SnakeConstants_1.PIECE_TYPE.SNAKE_BODY:
            case SnakeConstants_1.PIECE_TYPE.SNAKE_TAIL:
                this.isStart = false;
                this.snakeScene.overGame();
                break;
            case SnakeConstants_1.PIECE_TYPE.FOOD:
                nextPiece.init(SnakeConstants_1.PIECE_TYPE.SNAKE_HEAD, head.outDir, head.inDir);
                head.init(SnakeConstants_1.PIECE_TYPE.SNAKE_BODY, head.outDir, head.inDir);
                this.snake.unshift(nextPiece);
                this.snakeScene.onEatFood();
                break;
            case SnakeConstants_1.PIECE_TYPE.BLANK:
                var newSnake_1 = [];
                this.snake.forEach(function (piece, index) {
                    switch (piece.type) {
                        case SnakeConstants_1.PIECE_TYPE.SNAKE_HEAD:
                            nextPiece.init(SnakeConstants_1.PIECE_TYPE.SNAKE_HEAD, piece.outDir, piece.inDir);
                            break;
                        case SnakeConstants_1.PIECE_TYPE.SNAKE_BODY:
                            nextPiece.init(SnakeConstants_1.PIECE_TYPE.SNAKE_BODY, nextPiece.outDir, piece.outDir);
                            break;
                        case SnakeConstants_1.PIECE_TYPE.SNAKE_TAIL:
                            nextPiece.init(SnakeConstants_1.PIECE_TYPE.SNAKE_TAIL, nextPiece.outDir, piece.outDir);
                            piece.type = SnakeConstants_1.PIECE_TYPE.BLANK;
                            break;
                    }
                    newSnake_1.push(nextPiece);
                    nextPiece = piece;
                });
                // for (let piece of this.snake) {
                // }
                this.snake = newSnake_1;
        }
    };
    __decorate([
        property(cc.Float)
    ], Board.prototype, "frameTime", void 0);
    __decorate([
        property(cc.Float)
    ], Board.prototype, "levelRatio", void 0);
    __decorate([
        property(cc.Prefab)
    ], Board.prototype, "piecePrefab", void 0);
    __decorate([
        property(cc.Node)
    ], Board.prototype, "layout", void 0);
    Board = __decorate([
        ccclass
    ], Board);
    return Board;
}(cc.Component));
exports.default = Board;

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc3JjXFxzbmFrZVxcU25ha2VCb2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbURBQXlEO0FBQ3pELDJDQUFxQztBQUcvQixJQUFBLEtBQXdCLEVBQUUsQ0FBQyxVQUFVLEVBQW5DLE9BQU8sYUFBQSxFQUFFLFFBQVEsY0FBa0IsQ0FBQztBQUc1QztJQUFtQyx5QkFBWTtJQUEvQztRQUFBLHFFQXlNQztRQXhNK0IsZUFBUyxHQUFHLEdBQUcsQ0FBQztRQUNoQixnQkFBVSxHQUFHLElBQUksQ0FBQztRQUNqQixpQkFBVyxHQUFjLElBQUksQ0FBQztRQUNoQyxZQUFNLEdBQVksSUFBSSxDQUFDO1FBRTNDLGFBQU8sR0FBRyxLQUFLLENBQUM7UUFDZixjQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsYUFBTyxHQUFXLEVBQUUsQ0FBQztRQUNyQixhQUFPLEdBQVcsRUFBRSxDQUFDO1FBQ3JCLGVBQVMsR0FBVyxDQUFDLENBQUM7UUFHdEIsYUFBTyxHQUFHLDBCQUFTLENBQUMsS0FBSyxDQUFDO1FBQzNCLFdBQUssR0FBRyxDQUFDLENBQUM7UUFFVCxnQkFBVSxHQUFlLElBQUksQ0FBQzs7UUFnTHRDLHVCQUF1QjtRQUN2QiwwQkFBMEI7UUFDMUIsK0JBQStCO1FBQy9CLGlGQUFpRjtRQUNqRixnQ0FBZ0M7UUFDaEMsaUNBQWlDO1FBQ2pDLFlBQVk7UUFDWixRQUFRO1FBQ1IsSUFBSTtJQUNSLENBQUM7SUF2TEcsc0JBQU0sR0FBTjtRQUNJLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUNsRCxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNuQyxJQUFJLENBQUMs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Q0FBQztRQUNsRixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQywyQkFBVSxDQUFDLFVBQVUsRUFBRSwwQkFBUyxDQUFDLEtBQUssRUFBRSwwQkFBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9FLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLDJCQUFVLENBQUMsVUFBVSxFQUFFLDBCQUFTLENBQUMsRUFBRSxFQUFFLDBCQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDNUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxPQUFPLEdBQUcsMEJBQVMsQ0FBQyxLQUFLLENBQUM7UUFDL0IsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVELHVCQUFPLEdBQVA7UUFDSSxJQUFJLFNBQVMsR0FBWSxFQUFFLENBQUM7UUFDNUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDbkMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxH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Qzs0QkFDOUIsTUFBTTtxQkFDYjtvQkFDRCxVQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUN6QixTQUFTLEdBQUcsS0FBSyxDQUFDO2dCQUN0QixDQUFDLENBQUMsQ0FBQztnQkFDSCxrQ0FBa0M7Z0JBRWxDLElBQUk7Z0JBQ0osSUFBSSxDQUFDLEtBQUssR0FBRyxVQUFRLENBQUM7U0FDN0I7SUFDTCxDQUFDO0lBN0xtQjtRQUFuQixRQUFRLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQzs0Q0FBeUI7SUFDeEI7UUFBbkIsUUFBUSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUM7NkNBQTJCO0lBQ3pCO1FBQXBCLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDOzhDQUF1QztJQUN4QztRQUFsQixRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQzt5Q0FBZ0M7SUFKakMsS0FBSztRQUR6QixPQUFPO09BQ2EsS0FBSyxDQXlNekI7SUFBRCxZQUFDO0NBek1ELEFBeU1DLENBek1rQyxFQUFFLENBQUMsU0FBUyxHQXlNOUM7a0JBek1vQixLQUFLIiwiZmlsZSI6IiIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRElSRUNUSU9OLCBQSUVDRV9UWVBFIH0gZnJvbSAnLi9TbmFrZUNvbnN0YW50cyc7XHJcbmltcG9ydCB7IFBpZWNlIH0gZnJvbSAnLi9TbmFrZVBpZWNlJztcclxuaW1wb3J0IHsgU25ha2VTY2VuZSB9IGZyb20gJy4vU25ha2VTY2VuZSc7XHJcblxyXG5jb25zdCB7IGNjY2xhc3MsIHByb3BlcnR5IH0gPSBjYy5fZGVjb3JhdG9yO1xyXG5cclxuQGNjY2xhc3NcclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQm9hcmQgZXh0ZW5kcyBjYy5Db21wb25lbnQge1xyXG4gICAgQHByb3BlcnR5KGNjLkZsb2F0KSBwcml2YXRlIGZyYW1lVGltZSA9IDAuNTtcclxuICAgIEBwcm9wZXJ0eShjYy5GbG9hdCkgcHJpdmF0ZSBsZXZlbFJhdGlvID0gMC4wNTtcclxuICAgIEBwcm9wZXJ0eShjYy5QcmVmYWIpIHByaXZhdGUgcGllY2VQcmVmYWI6IGNjLlByZWZhYiA9IG51bGw7XHJcbiAgICBAcHJvcGVydHkoY2MuTm9kZSkgcHJpdmF0ZSBsYXlvdXQ6IGNjLk5vZGUgPSBudWxsO1xyXG5cclxuICAgIHB1YmxpYyBpc1N0YXJ0ID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIHBhc3RUaW1lID0gMDtcclxuICAgIHByaXZhdGUgcm93c051bTogbnVtYmVyID0gMTY7XHJcbiAgICBwcml2YXRlIGNvbHNOdW06IG51bWJlciA9IDE2O1xyXG4gICAgcHJpdmF0ZSBncmlkV2lkdGg6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIHBpZWNlTWFwOiBQaWVjZVtdW107XHJcbiAgICBwcml2YXRlIHNuYWtlOiBQaWVjZVtdO1xyXG4gICAgcHJpdmF0ZSBtb3ZlRGlyID0gRElSRUNUSU9OLlJJR0hUO1xyXG4gICAgcHVibGljIGxldmVsID0gMDtcclxuXHJcbiAgICBwcml2YXRlIHNuYWtlU2NlbmU6IFNuYWtlU2NlbmUgPSBudWxsO1xyXG5cclxuICAgIG9uTG9hZCgpIHtcclxuICAgICAgICB0aGlzLmdyaWRXaWR0aCA9IHRoaXMubGF5b3V0LndpZHRoIC8gdGhpcy5jb2xzTnVtO1xyXG4gICAgICAgIHRoaXMucGllY2VNYXAgPSBbXTtcclxuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHRoaXMuY29sc051bTsgeCsrKSB7XHJcbiAgICAgICAgICAgIHRoaXMucGllY2VNYXBbeF0gPSBbXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLnJvd3NOdW07IHkrKykge1xyXG4gICAgICAgICAgICAgICAgbGV0IHBpZWNlTm9kZSA9IGNjLmluc3RhbnRpYXRlKHRoaXMucGllY2VQcmVmYWIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sYXlvdXQuYWRkQ2hpbGQocGllY2VOb2RlKTtcclxuICAgICAgICAgICAgICAgIHBpZWNlTm9kZS53aWR0aCA9IHRoaXMuZ3JpZFdpZHRoO1xyXG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLmhlaWdodCA9IHRoaXMuZ3JpZFdpZHRoO1xyXG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLnggPSB4ICogdGhpcy5ncmlkV2lkdGggKyBwaWVjZU5vZGUud2lkdGggLyAyO1xyXG4gICAgICAgICAgICAgICAgcGllY2VOb2RlLnkgPSB5ICogdGhpcy5ncmlkV2lkdGggKyBwaWVjZU5vZGUuaGVpZ2h0IC8gMjtcclxuICAgICAgICAgICAgICAgIHRoaXMucGllY2VNYXBbeF1beV0gPSBwaWVjZU5vZGUuZ2V0Q29tcG9uZW50KFBpZWNlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucGllY2VNYXBbeF1beV0ueCA9IHg7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBpZWNlTWFwW3hdW3ldLnkgPSB5O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVUaWNrKCkge1xyXG4gICAgICAgIHRoaXMudW5zY2hlZHVsZSh0aGlzLnRpY2tIYW5kbGVyKTtcclxuICAgICAgICBsZXQgdGltZSA9IHRoaXMuZnJhbWVUaW1lIC0gKHRoaXMubGV2ZWxSYXRpbyAqIHRoaXMubGV2ZWwpO1xyXG4gICAgICAgIGlmICh0aW1lIDwgMC4xKSB7XHJcbiAgICAgICAgICAgIHRpbWUgPSAwLjE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2NoZWR1bGUodGhpcy50aWNrSGFuZGxlciwgdGltZSk7XHJcbiAgICB9XHJcblxyXG4gICAgdGlja0hhbmRsZXIoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNTdGFydCkge1xyXG4gICAgICAgICAgICB0aGlzLm1vdmVTbmFrZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpbml0KHNuYWtlU2NlbmU6IFNuYWtlU2NlbmUpIHtcclxuICAgICAgICB0aGlzLnNuYWtlU2NlbmUgPSBzbmFrZVNjZW5lO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXJ0R2FtZSgpIHtcclxuICAgICAgICB0aGlzLnJlc2V0KCk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkRm9vZCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlzU3RhcnQgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMudXBkYXRlVGljaygpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc2V0KCkge1xyXG4gICAgICAgIHRoaXMuY2xlYXIoKTtcclxuICAgICAgICB0aGlzLnNuYWtlID0gW107XHJcbiAgICAgICAgdGhpcy5waWVjZU1hcFs5XVs5XS5pbml0KFBJRUNFX1RZUEUuU05BS0VfSEVBRCwgRElSRUNUSU9OLlJJR0hULCBESVJFQ1RJT04uUklHSFQpO1xyXG4gICAgICAgIHRoaXMucGllY2VNYXBbOF1bOV0uaW5pdChQSUVDRV9UWVBFLlNOQUtFX0JPRFksIERJUkVDVElPTi5SSUdIVCwgRElSRUNUSU9OLlJJR0hUKTtcclxuICAgICAgICB0aGlzLnBpZWNlTWFwWzddWzldLmluaXQoUElFQ0VfVFlQRS5TTkFLRV9CT0RZLCBESVJFQ1RJT04uUklHSFQsIERJUkVDVElPTi5VUCk7XHJcbiAgICAgICAgdGhpcy5waWVjZU1hcFs3XVs4XS5pbml0KFBJRUNFX1RZUEUuU05BS0VfVEFJTCwgRElSRUNUSU9OLlVQLCBESVJFQ1RJT04uVVApO1xyXG4gICAgICAgIHRoaXMuc25ha2UucHVzaCh0aGlzLnBpZWNlTWFwWzldWzldKTtcclxuICAgICAgICB0aGlzLnNuYWtlLnB1c2godGhpcy5waWVjZU1hcFs4XVs5XSk7XHJcbiAgICAgICAgdGhpcy5zbmFrZS5wdXNoKHRoaXMucGllY2VNYXBbN11bOV0pO1xyXG4gICAgICAgIHRoaXMuc25ha2UucHVzaCh0aGlzLnBpZWNlTWFwWzddWzhdKTtcclxuICAgICAgICB0aGlzLm1vdmVEaXIgPSBESVJFQ1RJT04uUklHSFQ7XHJcbiAgICAgICAgdGhpcy5sZXZlbCA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkRm9vZCgpIHtcclxuICAgICAgICBsZXQgYmxhbmtMaXN0OiBQaWVjZVtdID0gW107XHJcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLmNvbHNOdW07IHgrKykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMucm93c051bTsgeSsrKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5waWVjZU1hcFt4XVt5XS50eXBlID09PSBQSUVDRV9UWVBFLkJMQU5LKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYmxhbmtMaXN0LnB1c2godGhpcy5waWVjZU1hcFt4XVt5XSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHJhbmRvbVBpZWNlID0gYmxhbmtMaXN0WyhNYXRoLnJhbmRvbSgpICogYmxhbmtMaXN0Lmxlbmd0aCkgfCAwXTtcclxuICAgICAgICByYW5kb21QaWVjZS50eXBlID0gUElFQ0VfVFlQRS5GT09EO1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyKCkge1xyXG4gICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdGhpcy5jb2xzTnVtOyB4KyspIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLnJvd3NOdW07IHkrKykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5waWVjZU1hcFt4XVt5XS50eXBlID0gUElFQ0VfVFlQRS5CTEFOSztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVMZXZlbChsZXZlbDogbnVtYmVyKSB7XHJcbiAgICAgICAgaWYgKGxldmVsICE9PSB0aGlzLmxldmVsKSB7XHJcbiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSBsZXZlbDtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVUaWNrKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHR1cm5TbmFrZShkaXI6IERJUkVDVElPTikge1xyXG4gICAgICAgIGlmICh0aGlzLnNuYWtlWzBdLm91dERpciAhPT0gLWRpcikge1xyXG4gICAgICAgICAgICB0aGlzLm1vdmVEaXIgPSBkaXI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG1vdmVTbmFrZSgpIHtcclxuICAgICAgICBsZXQgaGVhZCA9IHRoaXMuc25ha2VbMF07XHJcbiAgICAgICAgaGVhZC5pbkRpciA9IHRoaXMuc25ha2VbMV0ub3V0RGlyO1xyXG4gICAgICAgIGhlYWQub3V0RGlyID0gdGhpcy5tb3ZlRGlyO1xyXG4gICAgICAgIGxldCBuZXh0UGllY2U6IFBpZWNlO1xyXG4gICAgICAgIHN3aXRjaCAoaGVhZC5vdXREaXIpIHtcclxuICAgICAgICAgICAgY2FzZSBESVJFQ1RJT04uVVA6XHJcbiAgICAgICAgICAgICAgICBpZiAoaGVhZC55ID09PSB0aGlzLnJvd3NOdW0gLSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV4dFBpZWNlID0gdGhpcy5waWVjZU1hcFtoZWFkLnhdWzBdO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UgPSB0aGlzLnBpZWNlTWFwW2hlYWQueF1baGVhZC55ICsgMV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBESVJFQ1RJT04uUklHSFQ6XHJcbiAgICAgICAgICAgICAgICBpZiAoaGVhZC54ID09PSB0aGlzLmNvbHNOdW0gLSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV4dFBpZWNlID0gdGhpcy5waWVjZU1hcFswXVtoZWFkLnldO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UgPSB0aGlzLnBpZWNlTWFwW2hlYWQueCArIDFdW2hlYWQueV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBESVJFQ1RJT04uRE9XTjpcclxuICAgICAgICAgICAgICAgIGlmIChoZWFkLnkgPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UgPSB0aGlzLnBpZWNlTWFwW2hlYWQueF1bdGhpcy5yb3dzTnVtIC0gMV07XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIG5leHRQaWVjZSA9IHRoaXMucGllY2VNYXBbaGVhZC54XVtoZWFkLnkgLSAxXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIERJUkVDVElPTi5MRUZUOlxyXG4gICAgICAgICAgICAgICAgaWYgKGhlYWQueCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5leHRQaWVjZSA9IHRoaXMucGllY2VNYXBbdGhpcy5jb2xzTnVtIC0gMV1baGVhZC55XTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV4dFBpZWNlID0gdGhpcy5waWVjZU1hcFtoZWFkLnggLSAxXVtoZWFkLnldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubW92ZVNuYWtlVG9QaWVjZShuZXh0UGllY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIG1vdmVTbmFrZVRvUGllY2UobmV4dFBpZWNlOiBQaWVjZSkge1xyXG4gICAgICAgIGxldCBoZWFkID0gdGhpcy5zbmFrZVswXTtcclxuICAgICAgICBzd2l0Y2ggKG5leHRQaWVjZS50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgUElFQ0VfVFlQRS5TTkFLRV9CT0RZOlxyXG4gICAgICAgICAgICBjYXNlIFBJRUNFX1RZUEUuU05BS0VfVEFJTDpcclxuICAgICAgICAgICAgICAgIHRoaXMuaXNTdGFydCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zbmFrZVNjZW5lLm92ZXJHYW1lKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBQSUVDRV9UWVBFLkZPT0Q6XHJcbiAgICAgICAgICAgICAgICBuZXh0UGllY2UuaW5pdChQSUVDRV9UWVBFLlNOQUtFX0hFQUQsIGhlYWQub3V0RGlyLCBoZWFkLmluRGlyKTtcclxuICAgICAgICAgICAgICAgIGhlYWQuaW5pdChQSUVDRV9UWVBFLlNOQUtFX0JPRFksIGhlYWQub3V0RGlyLCBoZWFkLmluRGlyKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc25ha2UudW5zaGlmdChuZXh0UGllY2UpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zbmFrZVNjZW5lLm9uRWF0Rm9vZCgpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgUElFQ0VfVFlQRS5CTEFOSzpcclxuICAgICAgICAgICAgICAgIGxldCBuZXdTbmFrZSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zbmFrZS5mb3JFYWNoKChwaWVjZSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBpZWNlLnR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBQSUVDRV9UWVBFLlNOQUtFX0hFQUQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0UGllY2UuaW5pdChQSUVDRV9UWVBFLlNOQUtFX0hFQUQsIHBpZWNlLm91dERpciwgcGllY2UuaW5EaXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUElFQ0VfVFlQRS5TTkFLRV9CT0RZOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dFBpZWNlLmluaXQoUElFQ0VfVFlQRS5TTkFLRV9CT0RZLCBuZXh0UGllY2Uub3V0RGlyLCBwaWVjZS5vdXREaXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUElFQ0VfVFlQRS5TTkFLRV9UQUlMOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dFBpZWNlLmluaXQoUElFQ0VfVFlQRS5TTkFLRV9UQUlMLCBuZXh0UGllY2Uub3V0RGlyLCBwaWVjZS5vdXREaXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UudHlwZSA9IFBJRUNFX1RZUEUuQkxBTks7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3U25ha2UucHVzaChuZXh0UGllY2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIG5leHRQaWVjZSA9IHBpZWNlO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAvLyBmb3IgKGxldCBwaWVjZSBvZiB0aGlzLnNuYWtlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zbmFrZSA9IG5ld1NuYWtlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyB1cGRhdGUoZHQ6IG51bWJlcikge1xyXG4gICAgLy8gICAgIGlmICh0aGlzLmlzU3RhcnQpIHtcclxuICAgIC8vICAgICAgICAgdGhpcy5wYXN0VGltZSArPSBkdDtcclxuICAgIC8vICAgICAgICAgaWYgKHRoaXMucGFzdFRpbWUgPj0gdGhpcy5mcmFtZVRpbWUgKiAodGhpcy5sZXZlbFJhdGlvKip0aGlzLmxldmVsKSkge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5tb3ZlU25ha2UoKTtcclxuICAgIC8vICAgICAgICAgICAgIHRoaXMucGFzdFRpbWUgPSAwO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gfVxyXG59XHJcbiJdfQ==