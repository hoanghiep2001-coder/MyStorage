{"version":3,"sources":["file:///D:/CocosProjects/Amobear/GTA_All/assets/scripts/camera/ThirdPersonCamera.ts"],"names":["_decorator","Component","Node","v3","Vec3","EasyController","EasyControllerEvent","GameInfo","ccclass","property","v3_1","v3_2","ROTATION_STRENGTH","ThirdPersonCamera","start","on","CAMERA_ROTATE","onCameraRotate","_targetLen","len","_targetAngles","set","node","eulerAngles","onDestroy","off","lateUpdate","deltaTime","target","t","Math","min","tweenTime","lerp","setRotationFromEuler","GTA_PA_08","isHitBrakeBtnFlag","fakeTarget","worldPosition","add","lookAtOffset","forward","multiplyScalar","subtract","setPosition","deltaX","deltaY","rotateVHSeparately","abs","x","y","z"],"mappings":"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","sourcesContent":["import { _decorator, Component, log, Node, v3, Vec3 } from 'cc';\nimport { EasyController, EasyControllerEvent } from '../joystick/EasyController';\nimport { GameInfo } from '../CONST/GameInfo';\nconst { ccclass, property } = _decorator;\n\nconst v3_1 = v3();\nconst v3_2 = v3();\n\nconst ROTATION_STRENGTH = 20.0;\n\n\n@ccclass('ThirdPersonCamera')\nexport class ThirdPersonCamera extends Component {\n    @property(Node)\n    target: Node;\n\n    @property(Node)\n    fakeTarget: Node;\n\n    @property\n    lookAtOffset: Vec3 = v3();\n\n    @property\n    zoomSensitivity: number = 1.0;\n\n    @property\n    lenMin: number = 1.0;\n\n    @property\n    lenMax: number = 10.0;\n\n    @property\n    len: number = 5;\n\n    @property\n    rotateVHSeparately: boolean = false;\n\n    @property\n    tweenTime: number = 0.2;\n\n\n    private _targetLen: number = 0;\n    private _targetAngles: Vec3 = v3();\n\n\n    start() {\n        EasyController.on(EasyControllerEvent.CAMERA_ROTATE, this.onCameraRotate, this);\n\n        this._targetLen = this.len;\n        this._targetAngles.set(this.node.eulerAngles);\n    }\n\n    onDestroy() {\n        EasyController.off(EasyControllerEvent.CAMERA_ROTATE, this.onCameraRotate, this);\n    }\n\n    lateUpdate(deltaTime: number) {\n        if (!this.target) {\n            return;\n        }\n        const t = Math.min(deltaTime / this.tweenTime, 1.0);\n\n        //rotation\n        v3_1.set(this.node.eulerAngles);\n        Vec3.lerp(v3_1, v3_1, this._targetAngles, t);\n        this.node.setRotationFromEuler(v3_1);\n\n        //lookat\n        if(GameInfo.GTA_PA_08.isHitBrakeBtnFlag) v3_1.set(this.fakeTarget.worldPosition);\n        else v3_1.set(this.target.worldPosition);\n        v3_1.add(this.lookAtOffset);\n\n        //len and position\n        this.len = this.len * (1.0 - t) + this._targetLen * t;\n        v3_2.set(this.node.forward);\n        v3_2.multiplyScalar(this.len);\n\n        v3_1.subtract(v3_2);\n        this.node.setPosition(v3_1);\n\n        // log(this.node.getPosition().z)\n    }\n\n    onCameraRotate(deltaX: number, deltaY: number) {\n        let eulerAngles = this.node.eulerAngles;\n        if (this.rotateVHSeparately) {\n            if (Math.abs(deltaX) > Math.abs(deltaY)) {\n                deltaY = 0;\n            }\n            else {\n                deltaX = 0;\n            }\n        }\n        this._targetAngles.set(eulerAngles.x + deltaX * ROTATION_STRENGTH, eulerAngles.y + deltaY * ROTATION_STRENGTH, eulerAngles.z);\n    }\n}\n\n/**\n * [1] Class member could be defined like this.\n * [2] Use `property` decorator if your want the member to be serializable.\n * [3] Your initialization goes here.\n * [4] Your update function goes here.\n *\n * Learn more about scripting: https://docs.cocos.com/creator/3.4/manual/en/scripting/\n * Learn more about CCClass: https://docs.cocos.com/creator/3.4/manual/en/scripting/decorator.html\n * Learn more about life-cycle callbacks: https://docs.cocos.com/creator/3.4/manual/en/scripting/life-cycle-callbacks.html\n */\n"]}