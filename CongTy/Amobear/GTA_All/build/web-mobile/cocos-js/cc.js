System.register([],(function(t,e){"use strict";return{execute:function(){t({BitMask:re,CCClass:Je,CacheMode:void 0,DebugMode:void 0,EAxisDirection:void 0,ERigidBodyType:void 0,Enum:oe,Eventify:tu,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:wA,WorldNode3DToWorldNodeUI:RA,absMax:En,absMaxComponent:Tn,approx:an,assert:E,assertID:B,bezier:Op,bezierByTime:Zp,ccenum:ce,clamp:sn,clamp01:cn,color:wn,computeRatioByType:lk,createDefaultPipeline:AO,debug:b,deserialize:Bh,earcut:yQ,enumerableProps:bn,equals:on,error:T,errorID:O,find:TM,fragmentText:jH,getBaselineOffset:function(){return 0},getError:F,getPathFromRoot:function(t,e){for(var n=t,i="";null!==n&&n!==e;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(t){return t[yc]},getWorldTransformUntilRoot:kG,instantiate:$h,inverseLerp:Sn,isCustomTargetModifier:qG,isDisplayStats:z,isElementModifier:jG,isPropertyModifier:WG,isUnicodeCJK:GH,isUnicodeSpace:HH,isValid:ml,lerp:ln,log:x,logID:P,markAsWarning:void 0,mat4:qn,murmurhash2_32_gc:go,nextPow2:gn,pingPong:xn,pseudoRandom:_n,pseudoRandomRange:mn,pseudoRandomRangeInt:vn,quat:Gn,randomRange:pn,randomRangeInt:dn,rect:ii,removeProperty:void 0,repeat:yn,replaceProperty:void 0,safeMeasureText:VH,sampleAnimationCurve:ck,setDefaultLogTimes:function(t){t>0&&(X=t)},setDisplayStats:k,size:ei,toDegree:hn,toRadian:un,tween:vEt,tweenUtil:gEt,v2:Qn,v3:Mn,v4:Jn,warn:S,warnID:M});var n=2147483647;function i(t){return(t>0)-(t<0)}function r(t){var e,n;return e=(t>65535)<<4,e|=n=((t>>>=e)>255)<<3,e|=n=((t>>>=n)>15)<<2,(e|=n=((t>>>=n)>3)<<1)|(t>>>=n)>>1}function o(t){var e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function a(t){return--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}var s=new Array(256);!function(t){for(var e=0;e<256;++e){var n=e,i=e,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;t[e]=i<<r&255}}(s);var c=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:n,INT_MIN:-2147483648,sign:i,abs:function(t){var e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:r,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:o,nextPow2:a,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return s[255&t]<<24|s[t>>>8&255]<<16|s[t>>>16&255]<<8|s[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,n){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){var e=t|t-1;return e+1|(~e&-~e)-1>>>o(t)+1}});t("bits",c);var l="undefined"==typeof window?global:window,u=t("cclegacy",{_global:l});u.internal={},l.CC_BUILD=!0,l.CC_TEST=!1,l.CC_EDITOR=false,l.CC_PREVIEW=!1,l.CC_DEV=!1,l.CC_DEBUG=!1,l.CC_JSB=!1,l.CC_BYTEDANCE=!1,l.CC_WECHAT=!1,l.CC_ALIPAY=!1,l.CC_XIAOMI=!1,l.CC_BAIDU=!1,l.CC_COCOSPLAY=!1,l.CC_HUAWEI=!1,l.CC_OPPO=!1,l.CC_VIVO=!1,l.CC_MINIGAME=!1,l.CC_RUNTIME_BASED=!1,l.CC_SUPPORT_JIT=!0;var h=t("VERSION","3.4.2");l.CocosEngine=u.ENGINE_VERSION=h,l.cc=u;var f="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",p=null,d=console.log.bind(console),_=d,m=d,v=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+y.apply(void 0,[e].concat(i)))}},g=d;function y(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return u.js.formatStr.apply(null,[t].concat(n))}function x(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return d.apply(void 0,[t].concat(n))}function S(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return _.apply(void 0,[t].concat(n))}function T(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return m.apply(void 0,[t].concat(n))}function E(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return v.apply(void 0,[t,e].concat(i))}function b(){return g.apply(void 0,arguments)}function C(t){if(d=_=m=v=g=function(){},t!==N.NONE){if(t>N.ERROR){var e=function(t){if(u.game.canvas){if(!p){var e=document.createElement("Div");e.setAttribute("id","logInfoDiv"),e.setAttribute("width","200"),e.setAttribute("height",u.game.canvas.height);var n=e.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(p=document.createElement("textarea")).setAttribute("rows","20"),p.setAttribute("cols","30"),p.setAttribute("disabled","true");var i=p.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",e.appendChild(p),u.game.canvas.parentNode.appendChild(e)}p.value=p.value+t+"\r\n",p.scrollTop=p.scrollHeight}};m=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("ERROR :  "+y.apply(void 0,[t].concat(i)))},v=function(t,n){if(!t){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];e("ASSERT: "+y.apply(void 0,[n].concat(r)))}},t!==N.ERROR_FOR_WEB_PAGE&&(_=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("WARN :  "+y.apply(void 0,[t].concat(i)))}),t===N.INFO_FOR_WEB_PAGE&&(d=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e(y.apply(void 0,[t].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),m=console.error.bind?console.error.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.error.apply(console,[t].concat(n))},v=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=y.apply(void 0,[e].concat(i));throw new Error(o)}});if(t!==N.ERROR&&(_=console.warn.bind?console.warn.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.warn.apply(console,[t].concat(n))}),t<=N.INFO&&(d=console.log.bind?console.log.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.log.apply(console,[t].concat(n))}),t<=N.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);g=function(){return n.apply(void 0,arguments)}}}}function A(t){T(t.stack||t)}function w(t){return function(e){for(var n=t+" "+e+", please go to "+f+"#"+e+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var R=w("Log");function P(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];x(R.apply(void 0,[t].concat(n)))}var I=w("Warning");function M(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];S(I.apply(void 0,[t].concat(n)))}var D=w("Error");function O(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];T(D.apply(void 0,[t].concat(n)))}var N,L=w("Assert");function B(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];E(!1,L.apply(void 0,[e].concat(i)))}}function F(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return D.apply(void 0,[t].concat(n))}function z(){return!!u.profiler&&u.profiler.isShowingStats()}function k(t){u.profiler&&(t?u.profiler.showStats():u.profiler.hideStats(),u.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(N||(N=t("DebugMode",{})));var U,G,H,V,W,j,q=Object.freeze({__proto__:null,log:x,warn:S,error:T,assert:E,debug:b,_resetDebugSetting:C,_throw:A,logID:P,warnID:M,errorID:O,assertID:B,get DebugMode(){return N},getError:F,isDisplayStats:z,setDisplayStats:k}),X=10,Y=0,K=new Map;function Q(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function Z(t,e,n){return e&&Q(t.prototype,e),n&&Q(t,n),t}function J(){return(J=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}).apply(this,arguments)}function $(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,et(t,e)}function tt(t){return(tt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function et(t,e){return(et=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function nt(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function it(t,e,n){return(it=nt()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&et(r,n.prototype),r}).apply(null,arguments)}function rt(t){var e="function"==typeof Map?new Map:void 0;return(rt=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return it(t,arguments,tt(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),et(i,t)})(t)}function ot(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function at(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function st(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return at(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?at(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}function ct(t,e,n,i){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function lt(t,e,n,i,r){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(t,e,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}V=function(t,e,n,i,r,o,a){var s=K.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,t+"."+e,n+"."+i),s.count++)},U=t("replaceProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=Y++;K.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var r=null!=n.target?n.target:t,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:e,s=r===t,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)t[n.name]=function(){var t;return V(e,n.name,a,o,S,i,c),(t=n.customFunction).call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(t,n.name,{get:function(){return V(e,n.name,a,o,S,i,c),n.customGetter.call(this)},set:function(t){V(e,n.name,a,o,S,i,c),n.customSetter.call(this,t)},enumerable:!1}):l?Object.defineProperty(t,n.name,{set:function(t){V(e,n.name,a,o,S,i,c),n.customSetter.call(this,t)},enumerable:!1}):u&&Object.defineProperty(t,n.name,{get:function(){return V(e,n.name,a,o,S,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,n.name,{get:function(){return V(e,n.name,a,o,S,i,c),s?this[o]:r[o]},set:function(t){V(e,n.name,a,o,S,i,c),s?this[o]=t:r[o]=t},enumerable:!1})}))})),j=function(t,e,n,i,r){var o=K.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,t+"."+e),o.count++)},G=t("removeProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=Y++;K.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(t,n.name,{get:function(){return j(e,n.name,T,i,r)},set:function(){j(e,n.name,T,i,r)},enumerable:!1})}))})),W=function(t,e,n,i,r){var o=K.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,t+"."+e),o.count++)},H=t("markAsWarning",(function(t,e,n){null!=t&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(t,i);if(r&&r.configurable){var o=Y++;K.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;t[i]=function(){return W(e,i,S,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(t,i,{configurable:!0,get:function(){return W(e,i,S,o,a),c}}),r.writable&&Object.defineProperty(t,i,{set:function(t){W(e,i,S,o,a),c=t}})}else!function(e,n,i,r,o,a){if(e.get){var s=e.get;e.get=function(){return W(n,i,r,o,a),s.call(this)}}if(e.set){var c=e.set;e.set=function(t){W(n,i,r,o,a),c.call(this,t)}}Object.defineProperty(t,i,e)}(r,e,i,S,o,a);Object.defineProperty(t,i,{enumerable:!1})}}))}));var ut=function(){function t(t){this.i=0,this.array=t}var e=t.prototype;return e.remove=function(t){var e=this.array.indexOf(t);e>=0&&this.removeAt(e)},e.removeAt=function(t){this.array.splice(t,1),t<=this.i&&--this.i},e.fastRemove=function(t){var e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)},e.fastRemoveAt=function(t){var e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i},e.push=function(t){this.array.push(t)},Z(t,[{key:"length",get:function(){return this.array.length},set:function(t){this.array.length=t,this.i>=t&&(this.i=t-1)}}]),t}();function ht(t,e){t.splice(e,1)}function ft(t,e){var n=t.length;e<0||e>=n||(t[e]=t[n-1],t.length=n-1)}function pt(t,e){var n=t.indexOf(e);return n>=0&&(ht(t,n),!0)}function dt(t,e){return t.indexOf(e)>=0}var _t=Object.freeze({__proto__:null,removeAt:ht,fastRemoveAt:ft,remove:pt,fastRemove:function(t,e){var n=t.indexOf(e);n>=0&&(t[n]=t[t.length-1],--t.length)},removeIf:function(t,e){var n=t.findIndex(e);if(n>=0){var i=t[n];return ht(t,n),i}},verifyType:function(t,e){if(t&&t.length>0)for(var n,i=st(t);!(n=i()).done;)if(!(n.value instanceof e))return P(1300),!1;return!0},removeArray:function(t,e){for(var n=0,i=e.length;n<i;n++)pt(t,e[n])},appendObjectsAt:function(t,e,n){return t.splice.apply(t,[n,0].concat(e)),t},contains:dt,copy:function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i+=1)n[i]=t[i];return n},MutableForwardIterator:ut}),mt=function(){function t(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return t.prototype.getNewId=function(){return this.prefix+ ++this.id},t}();mt.global=new mt("global");var vt=new mt("TmpCId."),gt="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),yt="__cid__";function xt(t){return"number"==typeof t||t instanceof Number}function St(t){return"string"==typeof t||t instanceof String}function Tt(t){for(var e in t)return!1;return!0}var Et,bt=(Et={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(t,e,n,i,r){Et.value=n,Et.writable=i,Et.enumerable=r,Object.defineProperty(t,e,Et),Et.value=void 0}),Ct=function(){var t={get:void 0,set:void 0,enumerable:!1};return function(e,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),t.get=i,t.set=r,t.enumerable=o,t.configurable=a,Object.defineProperty(e,n,t),t.get=void 0,t.set=void 0}}(),At=function(){var t={get:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.get=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.get=void 0}}(),wt=function(){var t={set:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.set=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.set=void 0}}();function Rt(t){var e=Object.create(null);return t&&(e["."]=1,e["/"]=1,delete e["."],delete e["/"]),e}function Pt(t){if("function"==typeof t){var e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;var n="";if(t.name&&(n=t.name),t.toString){var i,r=t.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return t&&t.constructor?Pt(t.constructor):""}function It(t,e,n,i){var r=/([^.]+)$/,o=r.exec(e)[0],a=r.exec(n)[0];function s(){return this[a]}i?Ct(t,o,s,(function(t){this[a]=t})):At(t,o,s)}function Mt(t,e,n,i){for(var r in n)It(t,e+"."+r,n[r],i)}var Dt=/(%d)|(%s)/,Ot=/%s/;function Nt(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+t;var r="string"==typeof t&&Dt.test(t);if(r)for(var o,a=st(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?Dt:Ot;if(c.test(t)){var l=""+s;t=t.replace(c,l)}else t+=" "+s}else for(var u,h=st(n);!(u=h()).done;){var f=u.value;t+=" "+f}return t}function Lt(){for(var t=arguments.length-1,e=new Array(t),n=0;n<t;++n)e[n]=arguments[n+1];return e}function Bt(t,e){for(;t;){var n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=Object.getPrototypeOf(t)}return null}function Ft(t,e,n){var i=Bt(e,t);i&&Object.defineProperty(n,t,i)}function zt(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){O(5402,a);continue}for(var s in a)s in t||Ft(s,a,t)}}return t}function kt(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){O(5403,a);continue}for(var s in a)Ft(s,a,t)}}return t}function Ut(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function Gt(t){var e=t.prototype,n=e&&Object.getPrototypeOf(e);return n&&n.constructor}function Ht(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=Gt(t)))return!1;if(t===e)return!0}}return!1}function Vt(t){for(var e=0,n=Object.keys(t);e<n.length;e++)delete t[n[e]]}var Wt=Rt(!0),jt=Rt(!0);function qt(t,e){return function(n,i){if(i.prototype.hasOwnProperty(t)&&delete e[i.prototype[t]],bt(i.prototype,t,n),n){var r=e[n];r&&r!==i?T("A Class already exists with the same "+t+' : "'+n+'".'):e[n]=i}}}var Xt=qt("__cid__",Wt),Yt=qt("__classname__",jt);function Kt(t,e){if(Yt(t,e),!e.prototype.hasOwnProperty(yt)){var n=t||vt.getNewId();n&&Xt(n,e)}}function Qt(t,e){var n=jt[e],i=Wt[e],r=!0;if(n&&n!==t&&(T('"'+e+'" has already been set as name or alias of another class.'),r=!1),i&&i!==t&&(T('"'+e+'" has already been set as id or alias of another class.'),r=!1),r){var o=t[gt];o||(o=[],t[gt]=o),o.push(e),jt[e]=t,Wt[e]=t}}function Zt(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var i=0,r=e;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete Wt[s];var c=a.__classname__;c&&delete jt[c];var l=a[gt];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete jt[h],delete Wt[h]}}}function Jt(t){return Wt[t]}function $t(t){return jt[t]}function te(t,e){if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(yt))return t.prototype.__cid__;if(t&&t.constructor){var n=t.constructor.prototype;if(n&&n.hasOwnProperty(yt))return t.__cid__}return""}var ee=function(){var t=e.prototype;function e(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===e?t:e,i=void 0===e?null:t;this.count=0,this._pool=new Array(n),this._cleanup=i}return t.get=function(){return this._get()},t._get=function(){if(this.count>0){--this.count;var t=this._pool[this.count];return this._pool[this.count]=null,t}return null},t.put=function(t){var e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}},t.resize=function(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))},e}(),ne=_t,ie={IDGenerator:mt,Pool:ee,array:_t,isNumber:xt,isString:St,isEmptyObject:Tt,getPropertyDescriptor:Bt,addon:zt,mixin:kt,extend:Ut,getSuper:Gt,isChildClassOf:Ht,clear:Vt,value:bt,getset:Ct,get:At,set:wt,unregisterClass:Zt,getClassName:Pt,setClassName:Kt,setClassAlias:Qt,getClassByName:$t,get _registeredClassNames(){return J({},jt)},set _registeredClassNames(t){Vt(jt),Object.assign(jt,t)},get _registeredClassIds(){return J({},Wt)},set _registeredClassIds(t){Vt(Wt),Object.assign(Wt,t)},_getClassId:te,_setClassId:Xt,_getClassById:Jt,obsolete:It,obsoletes:Mt,formatStr:Nt,shiftArguments:Lt,createMap:Rt};function re(t){if("__bitmask__"in t)return t;bt(t,"__bitmask__",null,!0);for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&bt(t,a,r)}return t}function oe(t){return"__enums__"in t?t:(bt(t,"__enums__",null,!0),oe.update(t))}function ae(t){t.hasOwnProperty("__enums__")}function se(t){ae(t);var e=t.__enums__||[];for(var n in e.length=0,t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),t.__enums__=e,e}function ce(t){"__enums__"in t||bt(t,"__enums__",null,!0)}u.js=ie,t("js",Object.freeze({__proto__:null,array:ne,js:ie,IDGenerator:mt,Pool:ee,isNumber:xt,isString:St,isEmptyObject:Tt,value:bt,getset:Ct,get:At,set:wt,createMap:Rt,getClassName:Pt,obsolete:It,obsoletes:Mt,formatStr:Nt,shiftArguments:Lt,getPropertyDescriptor:Bt,addon:zt,mixin:kt,extend:Ut,getSuper:Gt,isChildClassOf:Ht,clear:Vt,_idToClass:Wt,_nameToClass:jt,_setClassId:Xt,setClassName:Kt,setClassAlias:Qt,unregisterClass:Zt,_getClassById:Jt,getClassByName:$t,_getClassId:te})),re.isBitMask=function(t){return t&&t.hasOwnProperty("__bitmask__")},re.getList=function(t){if(t.__bitmask__)return t.__bitmask__;var e=t.__bitmask__=[];for(var n in t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),e},u.BitMask=re,oe.update=function(t){for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&bt(t,a,r)}return Array.isArray(t.__enums__)&&se(t),t},oe||(oe=t("Enum",{})),oe.isEnum=function(t){return t&&t.hasOwnProperty("__enums__")},oe.getList=function(t){return ae(t),t.__enums__?t.__enums__:se(t)},u.Enum=oe;var le=t("ValueType",function(){function t(){}var e=t.prototype;return e.clone=function(){return O(100,Pt(this)+".clone"),this},e.equals=function(){return!1},e.set=function(){O(100,Pt(this)+".set")},e.toString=function(){return""+{}},t}());Kt("cc.ValueType",le),u.ValueType=le;var ue=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});u.macro=ue;for(var he=/^(?:cc|dragonBones|sp|ccsg)\..+/,fe=new Array(123),pe=0;pe<123;++pe)fe[pe]=64;for(var de=0;de<64;++de)fe["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(de)]=de;var _e=fe;function me(t,e,n){function i(t,e,n,i){var r=Object.getOwnPropertyDescriptor(t,e);if(r)r.get&&(t[n]=r.get),r.set&&i&&(t[i]=r.set);else{var o=t[n];Ct(t,e,o,t[i])}}for(var r,o=t.prototype,a=0;a<e.length;a++){var s=(r=e[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function ve(t,e,n,i){var r=t[e];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):t[e]=i?[n,r]:[r,n]:t[e]=n}function ge(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));var n=e.parentNode;if(n)do{if(n===t)return!0;n=n.parentNode}while(null!==n);return!1}function ye(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function xe(t,e,n){t&&setTimeout((function(){t(e,n)}),0)}function Se(t){return!(!t||t.constructor!==Object)&&Tt(t)}function Te(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t<n?t:n}function Ee(t){return t*ue.RAD}function be(t){return t*ue.DEG}u.misc={BUILTIN_CLASSID_RE:he,BASE64_VALUES:_e,propertyDefine:me,pushToMap:ve,contains:ge,isDomNode:ye,callInNextTick:xe,isPlainEmptyObj_DEV:Se,clampf:Te,degreesToRadians:Ee,radiansToDegrees:be},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:he,BASE64_VALUES:_e,propertyDefine:me,pushToMap:ve,contains:ge,isDomNode:ye,callInNextTick:xe,tryCatchFunctor_EDITOR:function(t){return Function("target","try {\n  target."+t+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:Se,clampf:Te,degreesToRadians:Ee,radiansToDegrees:be}));var Ce="$_$";function Ae(t,e){var n=e?Object.create(e):{};return bt(t,"__attrs__",n),n}function we(t){if("function"!=typeof t)return Ae(t,Pe(t.constructor));for(var e,n=u.Class.getInheritanceChain(t),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||Ae(r,(e=n[i+1])&&e.__attrs__)}return Ae(t,(e=n[0])&&e.__attrs__),t.__attrs__}function Re(t,e){var n=Pe(t),i=e+Ce,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function Pe(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||we(t)}function Ie(t,e,n,i){Pe(t)[e+Ce+n]=i}var Me=function(){function t(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}return t.prototype.toString=function(){return this.name},t}(),De=t("CCInteger",new Me("Integer",0));u.Integer=De,u.CCInteger=De;var Oe=t("CCFloat",new Me("Float",0));u.Float=Oe,u.CCFloat=Oe;var Ne=t("CCBoolean",new Me("Boolean",!1));u.Boolean=Ne,u.CCBoolean=Ne;var Le=t("CCString",new Me("String",""));function Be(t,e){return function(n,i){var r='"'+Pt(n)+"."+i+'"',o=Re(n,i),a=o.type;if(a===De||a===Oe?a="Number":a!==Le&&a!==Ne||(a=""+a),a===t){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!Se(s)){var c=typeof s,l=t.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;M(3605,r,Pt(o.ctor))}else"Number"!==t&&M(3606,e,r,t);else{if("function"===c)return;t===Le.default&&null==s?M(3607,r):M(3611,e,r,c)}delete o.type}}}else M(3604,r)}}u.String=Le,u.CCString=Le;var Fe=Object.freeze({__proto__:null,DELIMETER:Ce,createAttrsSingle:Ae,createAttrs:we,attr:Re,getClassAttrs:Pe,setClassAttr:Ie,PrimitiveType:Me,CCInteger:De,CCFloat:Oe,CCBoolean:Ne,CCString:Le,getTypeChecker_ET:Be,getObjTypeChecker_ET:function(t){return function(e,n){Be("Object","type")(e,n);var i=Pe(e)[n+Ce+"default"],r=u.Class.getDefault(i);if(!Array.isArray(r)&&Ht(t,u.ValueType)){var o=Pt(t),a=Nt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Pt(e),n,o);i?x(a):M(3612,a,o,Pt(e),n,o)}}}}),ze={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function ke(t,e,n,i){if(!t.get&&!t.set&&t.hasOwnProperty("default")){var r="_N$"+e;t.get=function(){return this[r]},t.set=function(t){var e=this[r];this[r]=t,n.call(this,e)};var o={};for(var a in i[r]=o,ze){var s=ze[a];t.hasOwnProperty(a)&&(o[a]=t[a],s.canUsedInGet||delete t[a])}}}function Ue(t,e,n,i){if(Array.isArray(e)){if(!(e.length>0))return O(5508,n,i);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=u.String:e===Boolean?t.type=u.Boolean:e===Number&&(t.type=u.Float))}function Ge(t,e,n){var i=t?{_short:!0}:{_short:!0,default:e};return n&&(i.type=n),i}function He(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Ge(e,[],t);if("function"==typeof t){var n=t;return Ge(e,Ht(n,u.ValueType)?new n:null,n)}return Ge(e,t instanceof Me?t.default:t)}return null}var Ve=[];function We(){return Ve[Ve.length-1]}u._RF={push:function(t,e,n,i){void 0===n&&(n=e,e=""),Ve.push({uuid:e,script:n,module:t,exports:t.exports,beh:null,importMeta:i})},pop:function(){var t=Ve.pop(),e=t.module,n=e.exports;if(n===t.exports){for(var i in n)return;e.exports=n=t.cls}},peek:We};var je=Ce,qe={datas:null,push:function(t){if(this.datas)this.datas.push(t);else{this.datas=[t];var e=this;setTimeout((function(){e.init()}),0)}},init:function(){var t=this.datas;if(t){for(var e=0;e<t.length;++e){var n=t[e],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=Pt(i);r?Ze(i,o,r,i.$super,n.mixins):O(3633,o)}this.datas=null}}};function Xe(t,e,n,i){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,n),tn(t,i,e,n)}function Ye(t,e,n,i){var r=i.get;i.set,r&&(tn(t,i,e,n),Ie(t,n,"serializable",!1))}function Ke(t){return"function"==typeof t?t():t}function Qe(t,e,n){for(var i in e)t.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(t,i,Bt(e,i))}function Ze(t,e,n,i,r){if(t.__props__=[],i&&i.__props__&&(t.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(t.__props__=t.__props__.concat(a.__props__.filter((function(e){return t.__props__.indexOf(e)<0}))))}if(n)for(var s in function(t,e){for(var n in t){var i=t[n],r=He(i,!1);if(r&&(i=t[n]=r),i){var o=i.notify;o&&ke(i,n,o,t),"type"in i&&Ue(i,i.type,e,n)}}}(n,e),n){var c=n[s];c.get||c.set?Ye(t,e,s,c):Xe(t,e,s,c)}var l=Pe(t);t.__values__=t.__props__.filter((function(t){return!1!==l[t+je+"serializable"]}))}function Je(t){var e=t.name,n=t.extends,i=t.mixins,r=function(t,e,n,i){var r=u.Component,o=We();if(o&&Ht(e,r)){if(Ht(o.cls,r))return O(3615),null;t=t||o.script}var a=function(t,e,n,i){var r=i.ctor,o=[r],a=r;bt(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(e&&(a.$super=e),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Qe(s,l.prototype),Je._isCCClass(l)&&Qe(Pe(a),Pe(l))}s.constructor=a}return Kt(t,a),a}(t,e,n,i);if(o)if(Ht(e,r)){var s=o.uuid;s&&Xt(s,a),o.cls=a}else Ht(o.cls,r)||(o.cls=a);return a}(e,n,i,t);e||(e=u.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var o=t.properties;"function"==typeof o||n&&null===n.__props__||i&&i.some((function(t){return null===t.__props__}))?(qe.push({cls:r,props:o,mixins:i}),r.__props__=r.__values__=null):Ze(r,e,o,n,t.mixins);var a=t.editor;return a&&Ht(n,u.Component)&&u.Component._registerEditorProps(r,a),r}Je._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},Je.fastDefine=function(t,e,n){Kt(t,e);for(var i=e.__props__=e.__values__=Object.keys(n),r=Pe(e),o=0;o<i.length;o++){var a=i[o];r[a+je+"visible"]=!1,r[a+je+"default"]=n[a]}},Je.Attr=Fe,Je.attr=Re,Je.getInheritanceChain=function(t){for(var e=[];t=Gt(t);)t!==Object&&e.push(t);return e};var $e={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function tn(t,e,n,i){var r=null,o="";function a(){return o=i+je,r=Pe(t)}"type"in e&&void 0===e.type&&M(3660,i,n);var s=e.type;s&&($e[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?oe.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=oe.getList(s)):re.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=re.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in e&&((r||a())[o+"default"]=e.default);var c,l=function(t,n){if(t in e){var i=e[t];typeof i===n&&((r||a())[o+t]=i)}};e.editorOnly&&((r||a())[o+"editorOnly"]=!0),e.__noImplicit?(r||a())[o+"serializable"]=null!==(c=e.serializable)&&void 0!==c&&c:!1===e.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=e.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Je.isArray=function(t){return t=Ke(t),Array.isArray(t)},Je.getDefault=Ke,Je.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Je.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Je.getNewValueTypeCode=function(t){for(var e=Pt(t),n=t.constructor,i="new "+e+"(",r=0;r<n.__props__.length;r++)i+=t[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},u.Class=Je;var en=Math.PI/180,nn=180/Math.PI,rn=t("EPSILON",1e-6);function on(t,e){return Math.abs(t-e)<=rn*Math.max(1,Math.abs(t),Math.abs(e))}function an(t,e,n){return n=n||rn,Math.abs(t-e)<=n}function sn(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t>n?n:t}function cn(t){return t<0?0:t>1?1:t}function ln(t,e,n){return t+(e-t)*n}function un(t){return t*en}function hn(t){return t*nn}var fn=t("random",Math.random);function pn(t,e){return Math.random()*(e-t)+t}function dn(t,e){return Math.floor(pn(t,e))}function _n(t){return(t=(9301*t+49297)%233280)/233280}function mn(t,e,n){return _n(t)*(n-e)+e}function vn(t,e,n){return Math.floor(mn(t,e,n))}function gn(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function yn(t,e){return t-Math.floor(t/e)*e}function xn(t,e){return t=yn(t,2*e),e-Math.abs(t-e)}function Sn(t,e,n){return(n-t)/(e-t)}function Tn(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function En(t,e){return Math.abs(t)>Math.abs(e)?t:e}function bn(t,e){e.forEach((function(e){Object.defineProperty(t,e,{enumerable:!0})}))}var Cn=1/255,An=t("Color",function(t){function e(e,n,i,r){var o;return(o=t.call(this)||this)._val=0,"string"==typeof e?o.fromHEX(e):void 0!==n?o.set(e,n,i,r):o.set(e),o}$(e,t),e.clone=function(t){var n=new e;return t._val?n._val=t._val:n._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,n},e.copy=function(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t},e.set=function(t,e,n,i,r){return t.r=e,t.g=n,t.b=i,t.a=r,t},e.fromHEX=function(t,e){e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0;var n=parseInt(e.substr(6,2),16);return t.a=Number.isNaN(n)?255:n,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t},e.add=function(t,e,n){return t.r=e.r+n.r,t.g=e.g+n.g,t.b=e.b+n.b,t.a=e.a+n.a,t},e.subtract=function(t,e,n){return t.r=e.r-n.r,t.g=e.g-n.g,t.b=e.b-n.b,t.a=e.a-n.a,t},e.multiply=function(t,e,n){return t.r=e.r*n.r,t.g=e.g*n.g,t.b=e.b*n.b,t.a=e.a*n.a,t},e.divide=function(t,e,n){return t.r=e.r/n.r,t.g=e.g/n.g,t.b=e.b/n.b,t.a=e.a/n.a,t},e.scale=function(t,e,n){return t.r=e.r*n,t.g=e.g*n,t.b=e.b*n,t.a=e.a*n,t},e.lerp=function(t,e,n,i){var r=e.r,o=e.g,a=e.b,s=e.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,t._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),t},e.toArray=function(t,n,i){void 0===i&&(i=0);var r=n instanceof e||n.a>1?1/255:1;return t[i+0]=n.r*r,t[i+1]=n.g*r,t[i+2]=n.b*r,t[i+3]=n.a*r,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),e.r=255*t[n+0],e.g=255*t[n+1],e.b=255*t[n+2],e.a=255*t[n+3],e},e.strictEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.r-e.r)<=n*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=n*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=n*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=n*Math.max(1,Math.abs(t.a),Math.abs(e.a))},e.hex=function(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0};var n=e.prototype;return n.clone=function(){var t=new e;return t._val=this._val,t},n.equals=function(t){return t&&this._val===t._val},n.lerp=function(t,e){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(t.r-n)*e,i+=(t.g-i)*e,r+=(t.b-r)*e,o+=(t.a-o)*e,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(t){return void 0===t&&(t="rgba"),"rgba"===t?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*Cn).toFixed(2)+")":"rgb"===t?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(t)},n.fromHEX=function(t){t=0===t.indexOf("#")?t.substring(1):t;var e=parseInt(t.substr(0,2),16)||0,n=parseInt(t.substr(2,2),16)||0,i=parseInt(t.substr(4,2),16)||0,r=parseInt(t.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|e),this},n.toHEX=function(t){void 0===t&&(t="#rrggbb");var e="0",n=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===t&&n.push((this.a<16?e:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(t,e,n){var i=0,r=0,o=0;if(0===e)i=r=o=n;else if(0===n)i=r=o=0;else{1===t&&(t=0),t*=6;var a=Math.floor(t),s=t-a,c=n*(1-e),l=n*(1-e*s),u=n*(1-e*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var t=this.r*Cn,e=this.g*Cn,n=this.b*Cn,i={h:0,s:0,v:0},r=Math.max(t,e,n),o=Math.min(t,e,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=t===r?(e-n)/a:e===r?2+(n-t)/a:4+(t-e)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(t,e,n,i){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,n=t.b||0,i="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)),this},n.multiply=function(t){var e=(255&this._val)*t.r>>8,n=(65280&this._val)*t.g>>8,i=(16711680&this._val)*t.b>>8,r=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&r|16711680&i|65280&n|255&e,this},n._set_r_unsafe=function(t){return this._val=(4294967040&this._val|t)>>>0,this},n._set_g_unsafe=function(t){return this._val=(4294902015&this._val|t<<8)>>>0,this},n._set_b_unsafe=function(t){return this._val=(4278255615&this._val|t<<16)>>>0,this},n._set_a_unsafe=function(t){return this._val=(16777215&this._val|t<<24)>>>0,this},Z(e,[{key:"r",get:function(){return 255&this._val},set:function(t){t=~~sn(t,0,255),this._val=(4294967040&this._val|t)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(t){t=~~sn(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(t){t=~~sn(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(t){t=~~sn(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}},{key:"x",get:function(){return this.r*Cn},set:function(t){this.r=255*t}},{key:"y",get:function(){return this.g*Cn},set:function(t){this.g=255*t}},{key:"z",get:function(){return this.b*Cn},set:function(t){this.b=255*t}},{key:"w",get:function(){return this.a*Cn},set:function(t){this.a=255*t}}]),e}(le));function wn(t,e,n,i){return new An(t,e,n,i)}An.WHITE=Object.freeze(new An(255,255,255,255)),An.GRAY=Object.freeze(new An(127,127,127,255)),An.BLACK=Object.freeze(new An(0,0,0,255)),An.TRANSPARENT=Object.freeze(new An(0,0,0,0)),An.RED=Object.freeze(new An(255,0,0,255)),An.GREEN=Object.freeze(new An(0,255,0,255)),An.BLUE=Object.freeze(new An(0,0,255,255)),An.CYAN=Object.freeze(new An(0,255,255,255)),An.MAGENTA=Object.freeze(new An(255,0,255,255)),An.YELLOW=Object.freeze(new An(255,255,0,255)),Je.fastDefine("cc.Color",An,{r:0,g:0,b:0,a:255}),u.Color=An,u.color=wn;var Rn=t("Vec3",function(t){function e(e,n,i){var r;return r=t.call(this)||this,e&&"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z):(r.x=e||0,r.y=n||0,r.z=i||0),r}$(e,t),e.zero=function(t){return t.x=0,t.y=0,t.z=0,t},e.clone=function(t){return new e(t.x,t.y,t.z)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t},e.set=function(t,e,n,i){return t.x=e,t.y=n,t.z=i,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return Math.sqrt(n*n+i*i+r*r)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return n*n+i*i+r*r},e.len=function(t){var e=t.x,n=t.y,i=t.z;return Math.sqrt(e*e+n*n+i*i)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z;return e*e+n*n+i*i},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t},e.invert=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t},e.invertSafe=function(t,e){var n=e.x,i=e.y,r=e.z;return Math.abs(n)<rn?t.x=0:t.x=1/n,Math.abs(i)<rn?t.y=0:t.y=1/i,Math.abs(r)<rn?t.z=0:t.z=1/r,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=n*o,t.y=i*o,t.z=r*o),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},e.cross=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z;return t.x=r*c-o*s,t.y=o*a-i*c,t.z=i*s-r*a,t},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t},e.random=function(t,e){e=e||1;var n=2*fn()*Math.PI,i=2*fn()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,t.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,t.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,t},e.transformMat4Normal=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o)*a,t.y=(n.m01*i+n.m05*r+n.m09*o)*a,t.z=(n.m02*i+n.m06*r+n.m10*o)*a,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=i*n.m00+r*n.m03+o*n.m06,t.y=i*n.m01+r*n.m04+o*n.m07,t.z=i*n.m02+r*n.m05+o*n.m08,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13,t.x=n.m02*i+n.m06*r+n.m10*o+n.m14,t},e.transformQuat=function(t,e,n){var i=n.w*e.x+n.y*e.z-n.z*e.y,r=n.w*e.y+n.z*e.x-n.x*e.z,o=n.w*e.z+n.x*e.y-n.y*e.x,a=-n.x*e.x-n.y*e.y-n.z*e.z;return t.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,t.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,t.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,t},e.transformRTS=function(t,e,n,i,r){var o=e.x*r.x,a=e.y*r.y,s=e.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return t.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,t.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,t.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,t},e.transformInverseRTS=function(t,e,n,i,r){var o=e.x-i.x,a=e.y-i.y,s=e.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return t.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,t.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,t.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,t},e.rotateX=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateY=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateZ=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z},e.equals=function(t,e,n){void 0===n&&(n=rn);var i=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},e.angle=function(t,n){e.normalize(Pn,t),e.normalize(In,n);var i=e.dot(Pn,In);return i>1?0:i<-1?Math.PI:Math.acos(i)},e.projectOnPlane=function(t,n,i){return e.subtract(t,n,e.project(t,n,i))},e.project=function(t,n,i){var r=e.lengthSqr(i);return r<1e-6?e.set(t,0,0,0):e.multiplyScalar(t,i,e.dot(n,i)/r)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z)},n.set=function(t,e,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))},n.equals3f=function(t,e,n,i){return void 0===i&&(i=rn),Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},n.strictEquals3f=function(t,e,n){return this.x===t&&this.y===e&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.add3f=function(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.subtract3f=function(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.multiply3f=function(t,e,n){return this.x*=t,this.y*=e,this.z*=n,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},n.divide3f=function(t,e,n){return this.x/=t,this.y/=e,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(t,e){return this.x=sn(this.x,t.x,e.x),this.y=sn(this.y,t.y,e.y),this.z=sn(this.z,t.z,e.z),this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=t*t+e*e+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=t*i,this.y=e*i,this.z=n*i),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=t.m03*e+t.m07*n+t.m11*i+t.m15;return r=r?1/r:1,this.x=(t.m00*e+t.m04*n+t.m08*i+t.m12)*r,this.y=(t.m01*e+t.m05*n+t.m09*i+t.m13)*r,this.z=(t.m02*e+t.m06*n+t.m10*i+t.m14)*r,this},e}(le));Rn.UNIT_X=Object.freeze(new Rn(1,0,0)),Rn.UNIT_Y=Object.freeze(new Rn(0,1,0)),Rn.UNIT_Z=Object.freeze(new Rn(0,0,1)),Rn.RIGHT=Object.freeze(new Rn(1,0,0)),Rn.UP=Object.freeze(new Rn(0,1,0)),Rn.FORWARD=Object.freeze(new Rn(0,0,-1)),Rn.ZERO=Object.freeze(new Rn(0,0,0)),Rn.ONE=Object.freeze(new Rn(1,1,1)),Rn.NEG_ONE=Object.freeze(new Rn(-1,-1,-1));var Pn=new Rn,In=new Rn;function Mn(t,e,n){return new Rn(t,e,n)}Je.fastDefine("cc.Vec3",Rn,{x:0,y:0,z:0}),u.Vec3=Rn,u.v3=Mn;var Dn=t("Mat3",function(t){function e(e,n,i,r,o,a,s,c,l){var u;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=t.call(this)||this,"object"==typeof e?(u.m00=e.m00,u.m01=e.m01,u.m02=e.m02,u.m03=e.m03,u.m04=e.m04,u.m05=e.m05,u.m06=e.m06,u.m07=e.m07,u.m08=e.m08):(u.m00=e,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}$(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.set=function(t,e,n,i,r,o,a,s,c,l){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=n,t.m05=e.m07,t.m06=i,t.m07=r}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=u*a-s*l,f=-u*o+s*c,p=l*o-a*c,d=n*h+i*f+r*p;return 0===d?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(d=1/d,t.m00=h*d,t.m01=(-u*i+r*l)*d,t.m02=(s*i-r*a)*d,t.m03=f*d,t.m04=(u*n-r*c)*d,t.m05=(-s*n+r*o)*d,t.m06=p*d,t.m07=(-l*n+i*c)*d,t.m08=(a*n-i*o)*d,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08;return e*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=n.m00,p=n.m01,d=n.m02,_=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return t.m00=f*i+p*a+d*l,t.m01=f*r+p*s+d*u,t.m02=f*o+p*c+d*h,t.m03=_*i+m*a+v*l,t.m04=_*r+m*s+v*u,t.m05=_*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.multiplyMat4=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=n.m00,p=n.m01,d=n.m02,_=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return t.m00=f*i+p*a+d*l,t.m01=f*r+p*s+d*u,t.m02=f*o+p*c+d*h,t.m03=_*i+m*a+v*l,t.m04=_*r+m*s+v*u,t.m05=_*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.transform=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=n.x,p=n.y;return t.m00=i,t.m01=r,t.m02=o,t.m03=a,t.m04=s,t.m05=c,t.m06=f*i+p*a+l,t.m07=f*r+p*s+u,t.m08=f*o+p*c+h,t},e.scale=function(t,e,n){var i=n.x,r=n.y;return t.m00=i*e.m00,t.m01=i*e.m01,t.m02=i*e.m02,t.m03=r*e.m03,t.m04=r*e.m04,t.m05=r*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.rotate=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=Math.sin(n),p=Math.cos(n);return t.m00=p*i+f*a,t.m01=p*r+f*s,t.m02=p*o+f*c,t.m03=p*a-f*i,t.m04=p*s-f*r,t.m05=p*c-f*o,t.m06=l,t.m07=u,t.m08=h,t},e.fromMat4=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t},e.fromViewUp=function(t,n,i){return Rn.lengthSqr(n)<rn*rn?(e.identity(t),t):(i=i||Rn.UNIT_Y,Rn.normalize(On,Rn.cross(On,i,n)),Rn.lengthSqr(On)<rn*rn?(e.identity(t),t):(Rn.cross(Nn,n,On),e.set(t,On.x,On.y,On.z,Nn.x,Nn.y,Nn.z,n.x,n.y,n.z),t))},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=-n,t.m04=i,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,f=r*a,p=r*s,d=r*c,_=o*a,m=o*s,v=o*c;return t.m00=1-h-d,t.m03=u-v,t.m06=f+m,t.m01=u+v,t.m04=1-l-d,t.m07=p-_,t.m02=f-m,t.m05=p+_,t.m08=1-l-h,t},e.inverseTransposeMat4=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,f=e.m10,p=e.m11,d=e.m12,_=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,T=i*l-o*s,E=r*l-o*c,b=u*_-h*d,C=u*m-f*d,A=u*v-p*d,w=h*m-f*_,R=h*v-p*_,P=f*v-p*m,I=g*P-y*R+x*w+S*A-T*C+E*b;return I?(I=1/I,t.m00=(s*P-c*R+l*w)*I,t.m01=(c*A-a*P-l*C)*I,t.m02=(a*R-s*A+l*b)*I,t.m03=(r*R-i*P-o*w)*I,t.m04=(n*P-r*A+o*C)*I,t.m05=(i*A-n*R-o*b)*I,t.m06=(_*E-m*T+v*S)*I,t.m07=(m*x-d*E-v*y)*I,t.m08=(d*T-_*x+v*g)*I,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=n.m00*i+e.m00,t.m01=n.m01*i+e.m01,t.m02=n.m02*i+e.m02,t.m03=n.m03*i+e.m03,t.m04=n.m04*i+e.m04,t.m05=n.m05*i+e.m05,t.m06=n.m06*i+e.m06,t.m07=n.m07*i+e.m07,t.m08=n.m08*i+e.m08,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))};var n=e.prototype;return n.clone=function(){var t=this;return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},n.set=function(t,e,n,i,r,o,a,s,c){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08},n.toString=function(){var t=this;return"[\n"+t.m00+", "+t.m01+", "+t.m02+",\n"+t.m03+",\n"+t.m04+", "+t.m05+",\n"+t.m06+", "+t.m07+",\n"+t.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=n,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,f=t*l+e*u+n*h;return 0===f?(this.set(0,0,0,0,0,0,0,0,0),this):(f=1/f,this.m00=l*f,this.m01=(-c*e+n*s)*f,this.m02=(o*e-n*r)*f,this.m03=u*f,this.m04=(c*t-n*a)*f,this.m05=(-o*t+n*i)*f,this.m06=h*f,this.m07=(-s*t+e*a)*f,this.m08=(r*t-e*i)*f,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return t*(c*r-o*s)+e*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=t.m00,h=t.m01,f=t.m02,p=t.m03,d=t.m04,_=t.m05,m=t.m06,v=t.m07,g=t.m08;return this.m00=u*e+h*r+f*s,this.m01=u*n+h*o+f*c,this.m02=u*i+h*a+f*l,this.m03=p*e+d*r+_*s,this.m04=p*n+d*o+_*c,this.m05=p*i+d*a+_*l,this.m06=m*e+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this},n.scale=function(t){var e=t.x,n=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(t),h=Math.cos(t);return this.m00=h*e+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*e,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,f=i*a,p=i*s,d=r*o,_=r*a,m=r*s;return this.m00=1-u-p,this.m03=l-m,this.m06=h+_,this.m01=l+m,this.m04=1-c-p,this.m07=f-d,this.m02=h-_,this.m05=f+d,this.m08=1-c-u,this},e}(le));Dn.IDENTITY=Object.freeze(new Dn);var On=new Rn,Nn=new Rn;Je.fastDefine("cc.Mat3",Dn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),u.Mat3=Dn;var Ln=t("Quat",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}$(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.identity=function(t){return t.x=0,t.y=0,t.z=0,t.w=1,t},e.rotationTo=function(t,n,i){var r=Rn.dot(n,i);return r<-.999999?(Rn.cross(zn,Rn.UNIT_X,n),zn.length()<1e-6&&Rn.cross(zn,Rn.UNIT_Y,n),Rn.normalize(zn,zn),e.fromAxisAngle(t,zn,Math.PI),t):r>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(Rn.cross(zn,n,i),t.x=zn.x,t.y=zn.y,t.z=zn.z,t.w=1+r,e.normalize(t,t))},e.getAxisAngle=function(t,e){var n=2*Math.acos(e.w),i=Math.sin(n/2);return 0!==i?(t.x=e.x/i,t.y=e.y/i,t.z=e.z/i):(t.x=1,t.y=0,t.z=0),n},e.multiply=function(t,e,n){var i=e.x*n.w+e.w*n.x+e.y*n.z-e.z*n.y,r=e.y*n.w+e.w*n.y+e.z*n.x-e.x*n.z,o=e.z*n.w+e.w*n.z+e.x*n.y-e.y*n.x,a=e.w*n.w-e.x*n.x-e.y*n.y-e.z*n.z;return t.x=i,t.y=r,t.z=o,t.w=a,t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.rotateX=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+c*i,t.y=a*r+s*i,t.z=s*r-a*i,t.w=c*r-o*i,t},e.rotateY=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r-s*i,t.y=a*r+c*i,t.z=s*r+o*i,t.w=c*r-a*i,t},e.rotateZ=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+a*i,t.y=a*r-o*i,t.z=s*r+c*i,t.w=c*r-s*i,t},e.rotateAround=function(t,n,i,r){return e.invert(Bn,n),Rn.transformQuat(zn,i,Bn),e.fromAxisAngle(Bn,zn,r),e.multiply(t,n,Bn),t},e.rotateAroundLocal=function(t,n,i,r){return e.fromAxisAngle(Bn,i,r),e.multiply(t,n,Bn),t},e.calculateW=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.slerp=function(t,e,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=e.x*n.x+e.y*n.y+e.z*n.z+e.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),f=Math.sin(h);r=Math.sin((1-i)*h)/f,o=Math.sin(i*h)/f}else r=1-i,o=i;return t.x=r*e.x+o*a,t.y=r*e.y+o*s,t.z=r*e.z+o*c,t.w=r*e.w+o*l,t},e.sqlerp=function(t,n,i,r,o,a){return e.slerp(Bn,n,o,a),e.slerp(Fn,i,r,a),e.slerp(t,Bn,Fn,2*a*(1-a)),t},e.invert=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,i=n?1/n:0;return t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i,t},e.conjugate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t},e.len=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)},e.lengthSqr=function(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},e.normalize=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return n>0&&(n=1/Math.sqrt(n),t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n),t},e.fromAxes=function(t,n,i,r){return Dn.set(kn,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),e.normalize(t,e.fromMat3(t,kn))},e.fromViewUp=function(t,n,i){return Dn.fromViewUp(kn,n,i),e.normalize(t,e.fromMat3(t,kn))},e.fromAxisAngle=function(t,e,n){n*=.5;var i=Math.sin(n);return t.x=i*e.x,t.y=i*e.y,t.z=i*e.z,t.w=Math.cos(n),t},e.fromMat3=function(t,e){var n=e.m00,i=e.m03,r=e.m06,o=e.m01,a=e.m04,s=e.m07,c=e.m02,l=e.m05,u=e.m08,h=n+a+u;if(h>0){var f=.5/Math.sqrt(h+1);t.w=.25/f,t.x=(l-s)*f,t.y=(r-c)*f,t.z=(o-i)*f}else if(n>a&&n>u){var p=2*Math.sqrt(1+n-a-u);t.w=(l-s)/p,t.x=.25*p,t.y=(i+o)/p,t.z=(r+c)/p}else if(a>u){var d=2*Math.sqrt(1+a-n-u);t.w=(r-c)/d,t.x=(i+o)/d,t.y=.25*d,t.z=(s+l)/d}else{var _=2*Math.sqrt(1+u-n-a);t.w=(o-i)/_,t.x=(r+c)/_,t.y=(s+l)/_,t.z=.25*_}return t},e.fromEuler=function(t,e,n,i){e*=Un,n*=Un,i*=Un;var r=Math.sin(e),o=Math.cos(e),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return t.x=r*s*l+o*a*c,t.y=o*a*l+r*s*c,t.z=o*s*c-r*a*l,t.w=o*s*l-r*a*c,t},e.fromAngleZ=function(t,e){return e*=Un,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t},e.toAxisX=function(t,e){var n=2*e.y,i=2*e.z;return t.x=1-n*e.y-i*e.z,t.y=n*e.x+i*e.w,t.z=i*e.x+n*e.w,t},e.toAxisY=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=i*e.x-r*e.w,t.y=1-n*e.x-r*e.z,t.z=r*e.y+n*e.w,t},e.toAxisZ=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=r*e.x-i*e.w,t.y=r*e.y-n*e.w,t.z=1-n*e.x-i*e.y,t},e.toEuler=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=hn(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-hn(2*Math.atan2(i,a)),l=-90;else{var h=i*i,f=r*r,p=o*o;s=hn(Math.atan2(2*i*a-2*r*o,1-2*h-2*p)),c=hn(Math.atan2(2*r*a-2*i*o,1-2*f-2*p)),l=hn(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return t.x=s,t.y=c,t.z=l,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.getEulerAngles=function(t){return e.toEuler(t,this)},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this},n.slerp=function(t,n){return e.slerp(this,this,t,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},e}(le));Ln.IDENTITY=Object.freeze(new Ln);var Bn=new Ln,Fn=new Ln,zn=new Rn,kn=new Dn,Un=.5*Math.PI/180;function Gn(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),new Ln(t,e,n,i)}Je.fastDefine("cc.Quat",Ln,{x:0,y:0,z:0,w:1}),u.Quat=Ln,u.quat=Gn;var Hn=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Vn=t("Mat4",function(t){function e(e,n,i,r,o,a,s,c,l,u,h,f,p,d,_,m){var v;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===_&&(_=0),void 0===m&&(m=1),(v=t.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof e?(v.m00=e.m00,v.m01=e.m01,v.m02=e.m02,v.m03=e.m03,v.m04=e.m04,v.m05=e.m05,v.m06=e.m06,v.m07=e.m07,v.m08=e.m08,v.m09=e.m09,v.m10=e.m10,v.m11=e.m11,v.m12=e.m12,v.m13=e.m13,v.m14=e.m14,v.m15=e.m15):(v.m00=e,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=f,v.m12=p,v.m13=d,v.m14=_,v.m15=m),v}$(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.set=function(t,e,n,i,r,o,a,s,c,l,u,h,f,p,d,_,m){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t.m09=u,t.m10=h,t.m11=f,t.m12=p,t.m13=d,t.m14=_,t.m15=m,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m03,o=e.m06,a=e.m07,s=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=n,t.m06=e.m09,t.m07=e.m13,t.m08=i,t.m09=o,t.m11=e.m14,t.m12=r,t.m13=a,t.m14=s}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,f=e.m10,p=e.m11,d=e.m12,_=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,T=i*l-o*s,E=r*l-o*c,b=u*_-h*d,C=u*m-f*d,A=u*v-p*d,w=h*m-f*_,R=h*v-p*_,P=f*v-p*m,I=g*P-y*R+x*w+S*A-T*C+E*b;return 0===I?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(I=1/I,t.m00=(s*P-c*R+l*w)*I,t.m01=(r*R-i*P-o*w)*I,t.m02=(_*E-m*T+v*S)*I,t.m03=(f*T-h*E-p*S)*I,t.m04=(c*A-a*P-l*C)*I,t.m05=(n*P-r*A+o*C)*I,t.m06=(m*x-d*E-v*y)*I,t.m07=(u*E-f*x+p*y)*I,t.m08=(a*R-s*A+l*b)*I,t.m09=(i*A-n*R-o*b)*I,t.m10=(d*T-_*x+v*g)*I,t.m11=(h*x-u*T-p*g)*I,t.m12=(s*C-a*w-c*b)*I,t.m13=(n*w-i*C+r*b)*I,t.m14=(_*y-d*S-m*g)*I,t.m15=(u*S-h*y+f*g)*I,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,f=t.m11,p=t.m12,d=t.m13,_=t.m14,m=t.m15;return(e*a-n*o)*(h*m-f*_)-(e*s-i*o)*(u*m-f*d)+(e*c-r*o)*(u*_-h*d)+(n*s-i*a)*(l*m-f*p)-(n*c-r*a)*(l*_-h*p)+(i*c-r*s)*(l*d-u*p)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=e.m09,p=e.m10,d=e.m11,_=e.m12,m=e.m13,v=e.m14,g=e.m15,y=n.m00,x=n.m01,S=n.m02,T=n.m03;return t.m00=y*i+x*s+S*h+T*_,t.m01=y*r+x*c+S*f+T*m,t.m02=y*o+x*l+S*p+T*v,t.m03=y*a+x*u+S*d+T*g,y=n.m04,x=n.m05,S=n.m06,T=n.m07,t.m04=y*i+x*s+S*h+T*_,t.m05=y*r+x*c+S*f+T*m,t.m06=y*o+x*l+S*p+T*v,t.m07=y*a+x*u+S*d+T*g,y=n.m08,x=n.m09,S=n.m10,T=n.m11,t.m08=y*i+x*s+S*h+T*_,t.m09=y*r+x*c+S*f+T*m,t.m10=y*o+x*l+S*p+T*v,t.m11=y*a+x*u+S*d+T*g,y=n.m12,x=n.m13,S=n.m14,T=n.m15,t.m12=y*i+x*s+S*h+T*_,t.m13=y*r+x*c+S*f+T*m,t.m14=y*o+x*l+S*p+T*v,t.m15=y*a+x*u+S*d+T*g,t},e.transform=function(t,e,n){var i=n.x,r=n.y,o=n.z;if(e===t)t.m12=e.m00*i+e.m04*r+e.m08*o+e.m12,t.m13=e.m01*i+e.m05*r+e.m09*o+e.m13,t.m14=e.m02*i+e.m06*r+e.m10*o+e.m14,t.m15=e.m03*i+e.m07*r+e.m11*o+e.m15;else{var a=e.m00,s=e.m01,c=e.m02,l=e.m03,u=e.m04,h=e.m05,f=e.m06,p=e.m07,d=e.m08,_=e.m09,m=e.m10,v=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=a,t.m01=s,t.m02=c,t.m03=l,t.m04=u,t.m05=h,t.m06=f,t.m07=p,t.m08=d,t.m09=_,t.m10=m,t.m11=v,t.m12=a*i+u*r+d*o+e.m12,t.m13=s*i+h*r+_*o+e.m13,t.m14=c*i+f*r+m*o+e.m14,t.m15=l*i+p*r+v*o+e.m15}return t},e.translate=function(t,e,n){return console.warn("function changed"),e===t?(t.m12+=n.x,t.m13+=n.y,t.m14+=n.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=n.x,t.m13+=n.y,t.m14+=n.z,t.m15=e.m15),t},e.scale=function(t,e,n){var i=n.x,r=n.y,o=n.z;return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*r,t.m05=e.m05*r,t.m06=e.m06*r,t.m07=e.m07*r,t.m08=e.m08*o,t.m09=e.m09*o,t.m10=e.m10*o,t.m11=e.m11*o,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.rotate=function(t,e,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<rn)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=e.m00,f=e.m01,p=e.m02,d=e.m03,_=e.m04,m=e.m05,v=e.m06,g=e.m07,y=e.m08,x=e.m09,S=e.m10,T=e.m11,E=r*r*u+l,b=o*r*u+a*c,C=a*r*u-o*c,A=r*o*u-a*c,w=o*o*u+l,R=a*o*u+r*c,P=r*a*u+o*c,I=o*a*u-r*c,M=a*a*u+l;return t.m00=h*E+_*b+y*C,t.m01=f*E+m*b+x*C,t.m02=p*E+v*b+S*C,t.m03=d*E+g*b+T*C,t.m04=h*A+_*w+y*R,t.m05=f*A+m*w+x*R,t.m06=p*A+v*w+S*R,t.m07=d*A+g*w+T*R,t.m08=h*P+_*I+y*M,t.m09=f*P+m*I+x*M,t.m10=p*P+v*I+S*M,t.m11=d*P+g*I+T*M,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t},e.rotateX=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,f=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=o*r+l*i,t.m05=a*r+u*i,t.m06=s*r+h*i,t.m07=c*r+f*i,t.m08=l*r-o*i,t.m09=u*r-a*i,t.m10=h*r-s*i,t.m11=f*r-c*i,t},e.rotateY=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m08,u=e.m09,h=e.m10,f=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r-l*i,t.m01=a*r-u*i,t.m02=s*r-h*i,t.m03=c*r-f*i,t.m08=o*i+l*r,t.m09=a*i+u*r,t.m10=s*i+h*r,t.m11=c*i+f*r,t},e.rotateZ=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m04,u=e.m05,h=e.m06,f=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r+l*i,t.m01=a*r+u*i,t.m02=s*r+h*i,t.m03=c*r+f*i,t.m04=l*r-o*i,t.m05=u*r-a*i,t.m06=h*r-s*i,t.m07=f*r-c*i,t},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRotation=function(t,e,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<rn)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(e),c=Math.cos(e),l=1-c;return t.m00=i*i*l+c,t.m01=r*i*l+o*s,t.m02=o*i*l-r*s,t.m03=0,t.m04=i*r*l-o*s,t.m05=r*r*l+c,t.m06=o*r*l+i*s,t.m07=0,t.m08=i*o*l+r*s,t.m09=r*o*l-i*s,t.m10=o*o*l+c,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromXRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=i,t.m06=n,t.m07=0,t.m08=0,t.m09=-n,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromYRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=0,t.m02=-n,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=n,t.m09=0,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromZRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=0,t.m04=-n,t.m05=i,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRT=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,f=i*l,p=r*c,d=r*l,_=o*l,m=a*s,v=a*c,g=a*l;return t.m00=1-(p+_),t.m01=h+g,t.m02=f-v,t.m03=0,t.m04=h-g,t.m05=1-(u+_),t.m06=d+m,t.m07=0,t.m08=f+v,t.m09=d-m,t.m10=1-(u+p),t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.getTranslation=function(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t},e.getScaling=function(t,e){var n=jn.m00=e.m00,i=jn.m01=e.m01,r=jn.m02=e.m02,o=jn.m03=e.m04,a=jn.m04=e.m05,s=jn.m05=e.m06,c=jn.m06=e.m08,l=jn.m07=e.m09,u=jn.m08=e.m10;return t.x=Math.sqrt(n*n+i*i+r*r),t.y=Math.sqrt(o*o+a*a+s*s),t.z=Math.sqrt(c*c+l*l+u*u),Dn.determinant(jn)<0&&(t.x*=-1),t},e.getRotation=function(t,e){var n=e.m00+e.m05+e.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),t.w=.25*i,t.x=(e.m06-e.m09)/i,t.y=(e.m08-e.m02)/i,t.z=(e.m01-e.m04)/i):e.m00>e.m05&&e.m00>e.m10?(i=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/i,t.x=.25*i,t.y=(e.m01+e.m04)/i,t.z=(e.m08+e.m02)/i):e.m05>e.m10?(i=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/i,t.x=(e.m01+e.m04)/i,t.y=.25*i,t.z=(e.m06+e.m09)/i):(i=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/i,t.x=(e.m08+e.m02)/i,t.y=(e.m06+e.m09)/i,t.z=.25*i),t},e.toRTS=function(t,e,n,i){i.x=Rn.set(Wn,t.m00,t.m01,t.m02).length(),jn.m00=t.m00/i.x,jn.m01=t.m01/i.x,jn.m02=t.m02/i.x,i.y=Rn.set(Wn,t.m04,t.m05,t.m06).length(),jn.m03=t.m04/i.y,jn.m04=t.m05/i.y,jn.m05=t.m06/i.y,i.z=Rn.set(Wn,t.m08,t.m09,t.m10).length(),jn.m06=t.m08/i.z,jn.m07=t.m09/i.z,jn.m08=t.m10/i.z,Dn.determinant(jn)<0&&(i.x*=-1,jn.m00*=-1,jn.m01*=-1,jn.m02*=-1),Ln.fromMat3(e,jn),Rn.set(n,t.m12,t.m13,t.m14)},e.fromRTS=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=e.w,c=r+r,l=o+o,u=a+a,h=r*c,f=r*l,p=r*u,d=o*l,_=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,T=i.z;return t.m00=(1-(d+m))*x,t.m01=(f+y)*x,t.m02=(p-g)*x,t.m03=0,t.m04=(f-y)*S,t.m05=(1-(h+m))*S,t.m06=(_+v)*S,t.m07=0,t.m08=(p+g)*T,t.m09=(_-v)*T,t.m10=(1-(h+d))*T,t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.fromRTSOrigin=function(t,e,n,i,r){var o=e.x,a=e.y,s=e.z,c=e.w,l=o+o,u=a+a,h=s+s,f=o*l,p=o*u,d=o*h,_=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,T=i.y,E=i.z,b=r.x,C=r.y,A=r.z;return t.m00=(1-(_+v))*S,t.m01=(p+x)*S,t.m02=(d-y)*S,t.m03=0,t.m04=(p-x)*T,t.m05=(1-(f+v))*T,t.m06=(m+g)*T,t.m07=0,t.m08=(d+y)*E,t.m09=(m-g)*E,t.m10=(1-(f+_))*E,t.m11=0,t.m12=n.x+b-(t.m00*b+t.m04*C+t.m08*A),t.m13=n.y+C-(t.m01*b+t.m05*C+t.m09*A),t.m14=n.z+A-(t.m02*b+t.m06*C+t.m10*A),t.m15=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,f=r*a,p=r*s,d=r*c,_=o*a,m=o*s,v=o*c;return t.m00=1-h-d,t.m01=u+v,t.m02=f-m,t.m03=0,t.m04=u-v,t.m05=1-l-d,t.m06=p+_,t.m07=0,t.m08=f+m,t.m09=p-_,t.m10=1-l-h,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.frustum=function(t,e,n,i,r,o,a){var s=1/(n-e),c=1/(r-i),l=1/(o-a);return t.m00=2*o*s,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*o*c,t.m06=0,t.m07=0,t.m08=(n+e)*s,t.m09=(r+i)*c,t.m10=(a+o)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=a*o*2*l,t.m15=0,t},e.perspective=function(t,e,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(e/2),u=1/(i-r),h=o?l/n:l,f=(o?l:l*n)*s,p=Hn[c];return t.m00=h*p[0],t.m01=h*p[1],t.m02=0,t.m03=0,t.m04=f*p[2],t.m05=f*p[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(r-a*i)*u,t.m11=-1,t.m12=0,t.m13=0,t.m14=r*i*u*(1-a),t.m15=0,t},e.ortho=function(t,e,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(e-n),h=1/(i-r)*c,f=1/(o-a),p=-2*u,d=-2*h,_=(e+n)*u,m=(r+i)*h,v=Hn[l];return t.m00=p*v[0],t.m01=p*v[1],t.m02=0,t.m03=0,t.m04=d*v[2],t.m05=d*v[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=f*(1-s),t.m11=0,t.m12=_*v[0]+m*v[2],t.m13=_*v[1]+m*v[3],t.m14=(o-s*a)*f,t.m15=1,t},e.lookAt=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,f=a-n.z,p=1/Math.sqrt(u*u+h*h+f*f),d=c*(f*=p)-l*(h*=p),_=l*(u*=p)-s*f,m=s*h-c*u,v=h*(m*=p=1/Math.sqrt(d*d+_*_+m*m))-f*(_*=p),g=f*(d*=p)-u*m,y=u*_-h*d;return t.m00=d,t.m01=v,t.m02=u,t.m03=0,t.m04=_,t.m05=g,t.m06=h,t.m07=0,t.m08=m,t.m09=y,t.m10=f,t.m11=0,t.m12=-(d*r+_*o+m*a),t.m13=-(v*r+g*o+y*a),t.m14=-(u*r+h*o+f*a),t.m15=1,t},e.inverseTranspose=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,f=e.m10,p=e.m11,d=e.m12,_=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,T=i*l-o*s,E=r*l-o*c,b=u*_-h*d,C=u*m-f*d,A=u*v-p*d,w=h*m-f*_,R=h*v-p*_,P=f*v-p*m,I=g*P-y*R+x*w+S*A-T*C+E*b;return I?(I=1/I,t.m00=(s*P-c*R+l*w)*I,t.m01=(c*A-a*P-l*C)*I,t.m02=(a*R-s*A+l*b)*I,t.m03=0,t.m04=(r*R-i*P-o*w)*I,t.m05=(n*P-r*A+o*C)*I,t.m06=(i*A-n*R-o*b)*I,t.m07=0,t.m08=(_*E-m*T+v*S)*I,t.m09=(m*x-d*E-v*y)*I,t.m10=(d*T-_*x+v*g)*I,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t[n+9]=e.m09,t[n+10]=e.m10,t[n+11]=e.m11,t[n+12]=e.m12,t[n+13]=e.m13,t[n+14]=e.m14,t[n+15]=e.m15,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t.m09=e[n+9],t.m10=e[n+10],t.m11=e[n+11],t.m12=e[n+12],t.m13=e[n+13],t.m14=e[n+14],t.m15=e[n+15],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t.m09=e.m09+n.m09,t.m10=e.m10+n.m10,t.m11=e.m11+n.m11,t.m12=e.m12+n.m12,t.m13=e.m13+n.m13,t.m14=e.m14+n.m14,t.m15=e.m15+n.m15,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t.m09=e.m09-n.m09,t.m10=e.m10-n.m10,t.m11=e.m11-n.m11,t.m12=e.m12-n.m12,t.m13=e.m13-n.m13,t.m14=e.m14-n.m14,t.m15=e.m15-n.m15,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t.m09=e.m09*n,t.m10=e.m10*n,t.m11=e.m11*n,t.m12=e.m12*n,t.m13=e.m13*n,t.m14=e.m14*n,t.m15=e.m15*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=e.m00+n.m00*i,t.m01=e.m01+n.m01*i,t.m02=e.m02+n.m02*i,t.m03=e.m03+n.m03*i,t.m04=e.m04+n.m04*i,t.m05=e.m05+n.m05*i,t.m06=e.m06+n.m06*i,t.m07=e.m07+n.m07*i,t.m08=e.m08+n.m08*i,t.m09=e.m09+n.m09*i,t.m10=e.m10+n.m10*i,t.m11=e.m11+n.m11*i,t.m12=e.m12+n.m12*i,t.m13=e.m13+n.m13*i,t.m14=e.m14+n.m14*i,t.m15=e.m15+n.m15*i,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=n*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=n*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=n*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=n*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=n*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=n*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=n*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))};var n=e.prototype;return n.clone=function(){return new e(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(t,e,n,i,r,o,a,s,c,l,u,h,f,p,d,_){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===_&&(_=1),"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=f,this.m13=p,this.m14=d,this.m15=_,this.m00=t),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,p=this.m13,d=this.m14,_=this.m15,m=t*o-e*r,v=t*a-n*r,g=t*s-i*r,y=e*a-n*o,x=e*s-i*o,S=n*s-i*a,T=c*p-l*f,E=c*d-u*f,b=c*_-h*f,C=l*d-u*p,A=l*_-h*p,w=u*_-h*d,R=m*w-v*A+g*C+y*b-x*E+S*T;return 0===R?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(R=1/R,this.m00=(o*w-a*A+s*C)*R,this.m01=(n*A-e*w-i*C)*R,this.m02=(p*S-d*x+_*y)*R,this.m03=(u*x-l*S-h*y)*R,this.m04=(a*b-r*w-s*E)*R,this.m05=(t*w-n*b+i*E)*R,this.m06=(d*g-f*S-_*v)*R,this.m07=(c*S-u*g+h*v)*R,this.m08=(r*A-o*b+s*T)*R,this.m09=(e*b-t*A-i*T)*R,this.m10=(f*x-p*g+_*m)*R,this.m11=(l*g-c*x-h*m)*R,this.m12=(o*E-r*C-a*T)*R,this.m13=(t*C-e*E+n*T)*R,this.m14=(p*v-f*y-d*m)*R,this.m15=(c*y-l*v+u*m)*R,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,p=this.m13,d=this.m14,_=this.m15;return(t*o-e*r)*(u*_-h*d)-(t*a-n*r)*(l*_-h*p)+(t*s-i*r)*(l*d-u*p)+(e*a-n*o)*(c*_-h*f)-(e*s-i*o)*(c*d-u*f)+(n*s-i*a)*(c*p-l*f)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,f=this.m11,p=this.m12,d=this.m13,_=this.m14,m=this.m15,v=t.m00,g=t.m01,y=t.m02,x=t.m03;return this.m00=v*e+g*o+y*l+x*p,this.m01=v*n+g*a+y*u+x*d,this.m02=v*i+g*s+y*h+x*_,this.m03=v*r+g*c+y*f+x*m,v=t.m04,g=t.m05,y=t.m06,x=t.m07,this.m04=v*e+g*o+y*l+x*p,this.m05=v*n+g*a+y*u+x*d,this.m06=v*i+g*s+y*h+x*_,this.m07=v*r+g*c+y*f+x*m,v=t.m08,g=t.m09,y=t.m10,x=t.m11,this.m08=v*e+g*o+y*l+x*p,this.m09=v*n+g*a+y*u+x*d,this.m10=v*i+g*s+y*h+x*_,this.m11=v*r+g*c+y*f+x*m,v=t.m12,g=t.m13,y=t.m14,x=t.m15,this.m12=v*e+g*o+y*l+x*p,this.m13=v*n+g*a+y*u+x*d,this.m14=v*i+g*s+y*h+x*_,this.m15=v*r+g*c+y*f+x*m,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this},n.translate=function(t){return console.warn("function changed"),this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this},n.scale=function(t){var e=t.x,n=t.y,i=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(t,e){var n=e.x,i=e.y,r=e.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<rn)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(t),s=Math.cos(t),c=1-s,l=this.m00,u=this.m01,h=this.m02,f=this.m03,p=this.m04,d=this.m05,_=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,T=i*n*c+r*a,E=r*n*c-i*a,b=n*i*c-r*a,C=i*i*c+s,A=r*i*c+n*a,w=n*r*c+i*a,R=i*r*c-n*a,P=r*r*c+s;return this.m00=l*S+p*T+v*E,this.m01=u*S+d*T+g*E,this.m02=h*S+_*T+y*E,this.m03=f*S+m*T+x*E,this.m04=l*b+p*C+v*A,this.m05=u*b+d*C+g*A,this.m06=h*b+_*C+y*A,this.m07=f*b+m*C+x*A,this.m08=l*w+p*R+v*P,this.m09=u*w+d*R+g*P,this.m10=h*w+_*R+y*P,this.m11=f*w+m*R+x*P,this},n.getTranslation=function(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t},n.getScale=function(t){var e=jn.m00=this.m00,n=jn.m01=this.m01,i=jn.m02=this.m02,r=jn.m03=this.m04,o=jn.m04=this.m05,a=jn.m05=this.m06,s=jn.m06=this.m08,c=jn.m07=this.m09,l=jn.m08=this.m10;return t.x=Math.sqrt(e*e+n*n+i*i),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(s*s+c*c+l*l),Dn.determinant(jn)<0&&(t.x*=-1),t},n.getRotation=function(t){var e=this.m00+this.m05+this.m10,n=0;return e>0?(n=2*Math.sqrt(e+1),t.w=.25*n,t.x=(this.m06-this.m09)/n,t.y=(this.m08-this.m02)/n,t.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/n,t.x=.25*n,t.y=(this.m01+this.m04)/n,t.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/n,t.x=(this.m01+this.m04)/n,t.y=.25*n,t.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/n,t.x=(this.m08+this.m02)/n,t.y=(this.m06+this.m09)/n,t.z=.25*n),t},n.fromRTS=function(t,e,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,f=i*l,p=r*c,d=r*l,_=o*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(p+_))*y,this.m01=(h+g)*y,this.m02=(f-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+_))*x,this.m06=(d+m)*x,this.m07=0,this.m08=(f+v)*S,this.m09=(d-m)*S,this.m10=(1-(u+p))*S,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,f=i*a,p=i*s,d=r*o,_=r*a,m=r*s;return this.m00=1-u-p,this.m01=l+m,this.m02=h-_,this.m03=0,this.m04=l-m,this.m05=1-c-p,this.m06=f+d,this.m07=0,this.m08=h+_,this.m09=f-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},e}(le));Vn.IDENTITY=Object.freeze(new Vn);var Wn=new Rn,jn=new Dn;function qn(t,e,n,i,r,o,a,s,c,l,u,h,f,p,d,_){return new Vn(t,e,n,i,r,o,a,s,c,l,u,h,f,p,d,_)}Je.fastDefine("cc.Mat4",Vn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),u.Mat4=Vn,u.mat4=qn;var Xn=t("Vec2",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=n||0),i}$(e,t),e.clone=function(t){return new e(t.x,t.y)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t},e.set=function(t,e,n){return t.x=e,t.y=n,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return n*n+i*i},e.len=function(t){var e=t.x,n=t.y;return Math.sqrt(e*e+n*n)},e.lengthSqr=function(t){var e=t.x,n=t.y;return e*e+n*n},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y;return Math.abs(n)<rn?t.x=0:t.x=1/n,Math.abs(i)<rn?t.y=0:t.y=1/i,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),t.x=n*r,t.y=i*r),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y},e.cross=function(t,e,n){return t instanceof Rn?(t.x=t.y=0,t.z=e.x*n.y-e.y*n.x,t):t.x*e.y-t.y*e.x},e.lerp=function(t,e,n,i){var r=e.x,o=e.y;return t.x=r+i*(n.x-r),t.y=o+i*(n.y-o),t},e.random=function(t,e){e=e||1;var n=2*fn()*Math.PI;return t.x=Math.cos(n)*e,t.y=Math.sin(n)*e,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m03*r+n.m06,t.y=n.m01*i+n.m04*r+n.m07,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m04*r+n.m12,t.y=n.m01*i+n.m05*r+n.m13,t},e.str=function(t){return"Vec2("+t.x+", "+t.y+")"},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))},e.angle=function(t,n){e.normalize(Yn,t),e.normalize(Kn,n);var i=e.dot(Yn,Kn);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y)},n.set=function(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))},n.equals2f=function(t,e,n){return void 0===n&&(n=rn),Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y},n.strictEquals2f=function(t,e){return this.x===t&&this.y===e},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(t,e){var n=this.x,i=this.y;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this},n.clampf=function(t,e){return this.x=sn(this.x,t.x,e.x),this.y=sn(this.y,t.y,e.y),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this},n.add2f=function(t,e){return this.x+=t,this.y+=e,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},n.subtract2f=function(t,e){return this.x-=t,this.y-=e,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this},n.multiply2f=function(t,e){return this.x*=t,this.y*=e,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this},n.divide2f=function(t,e){return this.x/=t,this.y/=e,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(t){return this.x*t.x+this.y*t.y},n.cross=function(t){return this.x*t.y-this.y*t.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var t=this.x,e=this.y,n=t*t+e*e;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(t){var e=this.lengthSqr(),n=t.lengthSqr();if(0===e||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(t)/Math.sqrt(e*n);return i=sn(i,-1,1),Math.acos(i)},n.signAngle=function(t){var e=this.angle(t);return this.cross(t)<0?-e:e},n.rotate=function(t){var e=this.x,n=this.y,i=Math.sin(t),r=Math.cos(t);return this.x=r*e-i*n,this.y=i*e+r*n,this},n.project=function(t){var e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this},n.transformMat4=function(t){var e=this.x,n=this.y;return this.x=t.m00*e+t.m04*n+t.m12,this.y=t.m01*e+t.m05*n+t.m13,this},e}(le));Xn.ZERO=Object.freeze(new Xn(0,0)),Xn.ONE=Object.freeze(new Xn(1,1)),Xn.NEG_ONE=Object.freeze(new Xn(-1,-1)),Xn.UNIT_X=Object.freeze(new Xn(1,0)),Xn.UNIT_Y=Object.freeze(new Xn(0,1));var Yn=new Xn,Kn=new Xn;function Qn(t,e){return new Xn(t,e)}Je.fastDefine("cc.Vec2",Xn,{x:0,y:0}),u.Vec2=Xn,u.v2=Qn;var Zn=t("Vec4",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=r||0),o}$(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t.w=e.w+n.w,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t.w=e.w-n.w,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t.w=e.w*n.w,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t.w=e.w/n.w,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t.w=Math.min(e.w,n.w),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t.w=Math.max(e.w,n.w),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return Math.sqrt(n*n+i*i+r*r+o*o)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return n*n+i*i+r*r+o*o},e.len=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return Math.sqrt(e*e+n*n+i*i+r*r)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return e*e+n*n+i*i+r*r},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w;return Math.abs(n)<rn?t.x=0:t.x=1/n,Math.abs(i)<rn?t.y=0:t.y=1/i,Math.abs(r)<rn?t.z=0:t.z=1/r,Math.abs(o)<rn?t.w=0:t.w=1/o,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),t.x=n*a,t.y=i*a,t.z=r*a,t.w=o*a),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.random=function(t,e){e=e||1;var n=2*fn()*Math.PI,i=2*fn()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t.w=0,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,t.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,t.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,t.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,t.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,t.w=e.w,t},e.transformQuat=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,f=l*o+a*r-s*i,p=-a*i-s*r-c*o;return t.x=u*l+p*-a+h*-c-f*-s,t.y=h*l+p*-s+f*-a-u*-c,t.z=f*l+p*-c+u*-s-h*-a,t.w=e.w,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=i||0),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.equals4f=function(t,e,n,i,r){return void 0===r&&(r=rn),Math.abs(this.x-t)<=r*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=r*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.strictEquals4f=function(t,e,n,i){return this.x===t&&this.y===e&&this.z===n&&this.w===i},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this.z=r+e*(t.z-r),this.w=o+e*(t.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(t,e){return this.x=sn(this.x,t.x,e.x),this.y=sn(this.y,t.y,e.y),this.z=sn(this.z,t.z,e.z),this.w=sn(this.w,t.w,e.w),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},n.add4f=function(t,e,n,i){return this.x+=t,this.y+=e,this.z+=n,this.w+=i,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},n.subtract4f=function(t,e,n,i){return this.x-=t,this.y-=e,this.z-=n,this.w-=i,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},n.multiply4f=function(t,e,n,i){return this.x*=t,this.y*=e,this.z*=n,this.w*=i,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this},n.divide4f=function(t,e,n,i){return this.x/=t,this.y/=e,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return Math.sqrt(t*t+e*e+n*n+i*i)},n.lengthSqr=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return t*t+e*e+n*n+i*i},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=this.w,r=t*t+e*e+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=t*r,this.y=e*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=this.w;return this.x=t.m00*e+t.m04*n+t.m08*i+t.m12*r,this.y=t.m01*e+t.m05*n+t.m09*i+t.m13*r,this.z=t.m02*e+t.m06*n+t.m10*i+t.m14*r,this.w=t.m03*e+t.m07*n+t.m11*i+t.m15*r,this},e}(le));function Jn(t,e,n,i){return new Zn(t,e,n,i)}Zn.ZERO=Object.freeze(new Zn(0,0,0,0)),Zn.ONE=Object.freeze(new Zn(1,1,1,1)),Zn.NEG_ONE=Object.freeze(new Zn(-1,-1,-1,-1)),Je.fastDefine("cc.Vec4",Zn,{x:0,y:0,z:0,w:0}),u.Vec4=Zn,u.v4=Jn,U(Xn,"Vec2",[{name:"sub",newName:"subtract",target:Xn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Xn,targetName:"Vec2"},{name:"div",newName:"divide",target:Xn,targetName:"Vec2"},{name:"dist",newName:"distance",target:Xn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Xn,targetName:"Vec2"},{name:"mag",newName:"len",target:Xn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Xn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Xn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Xn,targetName:"Vec2"}]),U(Xn.prototype,"Vec2",[{name:"mag",newName:"length",target:Xn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Xn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Xn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Xn.prototype,targetName:"Vec2"}]),U(Rn,"Vec3",[{name:"sub",newName:"subtract",target:Rn,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Rn,targetName:"Vec3"},{name:"div",newName:"divide",target:Rn,targetName:"Vec3"},{name:"dist",newName:"distance",target:Rn,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Rn,targetName:"Vec3"},{name:"mag",newName:"len",target:Rn,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Rn,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Rn,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Rn,targetName:"Vec3"}]),U(Rn.prototype,"Vec3",[{name:"mag",newName:"length",target:Rn.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Rn.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Rn.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Rn.prototype,targetName:"Vec3"}]),U(Zn,"Vec4",[{name:"sub",newName:"subtract",target:Zn,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Zn,targetName:"Vec4"},{name:"div",newName:"divide",target:Zn,targetName:"Vec4"},{name:"dist",newName:"distance",target:Zn,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Zn,targetName:"Vec4"},{name:"mag",newName:"len",target:Zn,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Zn,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Zn,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Zn,targetName:"Vec4"}]),U(Zn.prototype,"Vec4",[{name:"mag",newName:"length",target:Zn.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Zn.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Zn.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Zn.prototype,targetName:"Vec4"}]),U(Ln,"Quat",[{name:"mag",newName:"len",target:Ln,targetName:"Quat"},{name:"mul",newName:"multiply",target:Ln,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Ln,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Ln,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ln,targetName:"Quat"}]),U(Ln.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Ln.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ln.prototype,targetName:"Quat"}]),U(An,"Color",[{name:"sub",newName:"subtract",target:An,targetName:"Color"},{name:"mul",newName:"multiply",target:An,targetName:"Color"},{name:"div",newName:"divide",target:An,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:An,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=e[1].toString(16);return u.Color.fromHEX(e[0],i)}}]),U(Dn,"Mat3",[{name:"sub",newName:"subtract",target:Dn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Dn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Dn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Dn,targetName:"Mat3"}]),U(Dn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Dn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Dn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Dn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Dn.prototype,targetName:"Mat3"}]),U(Vn,"Mat4",[{name:"sub",newName:"subtract",target:Vn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Vn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Vn,targetName:"Mat4"}]),U(Vn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Vn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Vn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Vn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Vn.prototype,targetName:"Mat4"}]);var $n=t("AffineTransform",function(){function t(t,e,n,i,r,o){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=t,this.b=e,this.c=n,this.d=i,this.tx=r,this.ty=o}return t.identity=function(){return new t},t.clone=function(e){return new t(e.a,e.b,e.c,e.d,e.tx,e.ty)},t.concat=function(t,e,n){var i=e.a,r=e.b,o=e.c,a=e.d,s=e.tx,c=e.ty;t.a=i*n.a+r*n.c,t.b=i*n.b+r*n.d,t.c=o*n.a+a*n.c,t.d=o*n.b+a*n.d,t.tx=s*n.a+c*n.c+n.tx,t.ty=s*n.b+c*n.d+n.ty},t.invert=function(t,e){var n=1/(e.a*e.d-e.b*e.c);t.a=n*e.d,t.b=-n*e.b,t.c=-n*e.c,t.d=n*e.a,t.tx=n*(e.c*e.ty-e.d*e.tx),t.ty=n*(e.b*e.tx-e.a*e.ty)},t.fromMat4=function(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13},t.transformVec2=function(t,e,n,i){var r,o;void 0===i?(i=n,r=e.x,o=e.y):(r=e,o=n),t.x=i.a*r+i.c*o+i.tx,t.y=i.b*r+i.d*o+i.ty},t.transformSize=function(t,e,n){t.width=n.a*e.width+n.c*e.height,t.height=n.b*e.width+n.d*e.height},t.transformRect=function(t,e,n){var i=e.x+e.width,r=e.y+e.height,o=n.a*e.x+n.c*e.y+n.tx,a=n.b*e.x+n.d*e.y+n.ty,s=n.a*i+n.c*e.y+n.tx,c=n.b*i+n.d*e.y+n.ty,l=n.a*e.x+n.c*r+n.tx,u=n.b*e.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,f=n.b*i+n.d*r+n.ty,p=Math.min(o,s,l,h),d=Math.max(o,s,l,h),_=Math.min(a,c,u,f),m=Math.max(a,c,u,f);t.x=p,t.y=_,t.width=d-p,t.height=m-_},t.transformObb=function(t,e,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;e.x=a,e.y=s,n.x=c+a,n.y=l+s,t.x=u+a,t.y=h+s,i.x=c+u+a,i.y=l+h+s},t}());u.AffineTransform=$n;var ti=t("Size",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.width=e.width,i.height=e.height):(i.width=e||0,i.height=n||0),i}$(e,t),e.lerp=function(t,e,n,i){return t.width=e.width+(n.width-e.width)*i,t.height=e.height+(n.height-e.height)*i,t};var n=e.prototype;return n.clone=function(){return new e(this.width,this.height)},n.set=function(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this},n.equals=function(t){return this.width===t.width&&this.height===t.height},n.lerp=function(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},Z(e,[{key:"x",get:function(){return this.width},set:function(t){this.width=t}},{key:"y",get:function(){return this.height},set:function(t){this.height=t}}]),e}(le));function ei(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new ti(t,e)}ti.ZERO=Object.freeze(new ti(0,0)),ti.ONE=Object.freeze(new ti(1,1)),Je.fastDefine("cc.Size",ti,{width:0,height:0}),u.size=ei,u.Size=ti;var ni=t("Rect",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.y=e.y,o.width=e.width,o.height=e.height,o.x=e.x):(o.x=e||0,o.y=n||0,o.width=i||0,o.height=r||0),o}$(e,t),e.fromMinMax=function(t,e,n){var i=Math.min(e.x,n.x),r=Math.min(e.y,n.y),o=Math.max(e.x,n.x),a=Math.max(e.y,n.y);return t.x=i,t.y=r,t.width=o-i,t.height=a-r,t},e.lerp=function(t,e,n,i){var r=e.x,o=e.y,a=e.width,s=e.height;return t.x=r+(n.x-r)*i,t.y=o+(n.y-o)*i,t.width=a+(n.width-a)*i,t.height=s+(n.height-s)*i,t},e.intersection=function(t,e,n){var i=e.x,r=e.y,o=e.x+e.width,a=e.y+e.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return t.x=Math.max(i,s),t.y=Math.max(r,c),t.width=Math.min(o,l)-t.x,t.height=Math.min(a,u)-t.y,t},e.union=function(t,e,n){var i=e.x,r=e.y,o=e.width,a=e.height,s=n.x,c=n.y,l=n.width,u=n.height;return t.x=Math.min(i,s),t.y=Math.min(r,c),t.width=Math.max(i+o,s+l)-t.x,t.height=Math.max(r+a,c+u)-t.y,t};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.width,this.height)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=n||0,this.height=i||0),this},n.equals=function(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(t.x-n)*e,this.y=i+(t.y-i)*e,this.width=r+(t.width-r)*e,this.height=o+(t.height-o)*e,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(t){var e=this.x+this.width,n=this.y+this.height,i=t.x+t.width,r=t.y+t.height;return!(e<t.x||i<this.x||n<t.y||r<this.y)},n.contains=function(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y},n.containsRect=function(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height},n.transformMat4=function(t){var e=this.x,n=this.y,i=e+this.width,r=n+this.height,o=t.m00*e+t.m04*n+t.m12,a=t.m01*e+t.m05*n+t.m13,s=t.m00*i+t.m04*n+t.m12,c=t.m01*i+t.m05*n+t.m13,l=t.m00*e+t.m04*r+t.m12,u=t.m01*e+t.m05*r+t.m13,h=t.m00*i+t.m04*r+t.m12,f=t.m01*i+t.m05*r+t.m13,p=Math.min(o,s,l,h),d=Math.max(o,s,l,h),_=Math.min(a,c,u,f),m=Math.max(a,c,u,f);return this.x=p,this.y=_,this.width=d-p,this.height=m-_,this},n.transformMat4ToPoints=function(t,e,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;e.x=t.m00*o+t.m04*a+t.m12,e.y=t.m01*o+t.m05*a+t.m13,r.x=t.m00*s+t.m04*a+t.m12,r.y=t.m01*s+t.m05*a+t.m13,n.x=t.m00*o+t.m04*c+t.m12,n.y=t.m01*o+t.m05*c+t.m13,i.x=t.m00*s+t.m04*c+t.m12,i.y=t.m01*s+t.m05*c+t.m13},Z(e,[{key:"xMin",get:function(){return this.x},set:function(t){this.width+=this.x-t,this.x=t}},{key:"yMin",get:function(){return this.y},set:function(t){this.height+=this.y-t,this.y=t}},{key:"xMax",get:function(){return this.x+this.width},set:function(t){this.width=t-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(t){this.height=t-this.y}},{key:"center",get:function(){return new Xn(this.x+.5*this.width,this.y+.5*this.height)},set:function(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}},{key:"origin",get:function(){return new Xn(this.x,this.y)},set:function(t){this.x=t.x,this.y=t.y}},{key:"size",get:function(){return new ti(this.width,this.height)},set:function(t){this.width=t.width,this.height=t.height}},{key:"z",get:function(){return this.width},set:function(t){this.width=t}},{key:"w",get:function(){return this.height},set:function(t){this.height=t}}]),e}(le));function ii(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),new ni(t,e,n,i)}Je.fastDefine("cc.Rect",ni,{x:0,y:0,width:0,height:0}),u.Rect=ni,u.rect=ii;var ri=t("MATH_FLOAT_ARRAY",Float64Array),oi=t("MathBase",function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.createFloatArray=function(t){return new ri(t)},Z(e,[{key:"array",get:function(){return this._array}}]),e}(le)),ai=Object.freeze({__proto__:null,bits:c,Vec2:Xn,v2:Qn,Vec3:Rn,v3:Mn,Vec4:Zn,v4:Jn,Quat:Ln,quat:Gn,Mat3:Dn,Mat4:Vn,mat4:qn,AffineTransform:$n,Size:ti,size:ei,Rect:ni,rect:ii,Color:An,color:wn,EPSILON:rn,equals:on,approx:an,clamp:sn,clamp01:cn,lerp:ln,toRadian:un,toDegree:hn,random:fn,randomRange:pn,randomRangeInt:dn,pseudoRandom:_n,pseudoRandomRange:mn,pseudoRandomRangeInt:vn,nextPow2:gn,repeat:yn,pingPong:xn,inverseLerp:Sn,absMaxComponent:Tn,absMax:En,enumerableProps:bn,MATH_FLOAT_ARRAY:ri,MathBase:oi});t("math",ai);var si,ci,li,ui,hi,fi,pi,di,_i,mi,vi,gi,yi,xi,Si,Ti,Ei,bi,Ci,Ai,wi,Ri,Pi,Ii,Mi,Di,Oi,Ni,Li,Bi,Fi,zi,ki,Ui,Gi,Hi,Vi,Wi,ji,qi,Xi,Yi=function(t,e,n){for(var i=0;i<e.length;++i)t.length<=i&&t.push(new n),t[i].copy(e[i]);t.length=e.length};!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SWAPCHAIN=1]="SWAPCHAIN",t[t.BUFFER=2]="BUFFER",t[t.TEXTURE=3]="TEXTURE",t[t.RENDER_PASS=4]="RENDER_PASS",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.SAMPLER=6]="SAMPLER",t[t.SHADER=7]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=10]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=13]="COMMAND_BUFFER",t[t.QUEUE=14]="QUEUE",t[t.QUERY_POOL=15]="QUERY_POOL",t[t.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=18]="BUFFER_BARRIER",t[t.COUNT=19]="COUNT"}(si||(si={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(ci||(ci={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(li||(li={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(ui||(ui={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_SRGB=7]="FORMAT_SRGB",t[t.FORMAT_ETC1=8]="FORMAT_ETC1",t[t.FORMAT_ETC2=9]="FORMAT_ETC2",t[t.FORMAT_DXT=10]="FORMAT_DXT",t[t.FORMAT_PVRTC=11]="FORMAT_PVRTC",t[t.FORMAT_ASTC=12]="FORMAT_ASTC",t[t.FORMAT_RGB8=13]="FORMAT_RGB8",t[t.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=17]="BLEND_MINMAX",t[t.COMPUTE_SHADER=18]="COMPUTE_SHADER",t[t.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",t[t.COUNT=20]="COUNT"}(hi||(hi={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.DEPTH=54]="DEPTH",t[t.DEPTH_STENCIL=55]="DEPTH_STENCIL",t[t.BC1=56]="BC1",t[t.BC1_ALPHA=57]="BC1_ALPHA",t[t.BC1_SRGB=58]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",t[t.BC2=60]="BC2",t[t.BC2_SRGB=61]="BC2_SRGB",t[t.BC3=62]="BC3",t[t.BC3_SRGB=63]="BC3_SRGB",t[t.BC4=64]="BC4",t[t.BC4_SNORM=65]="BC4_SNORM",t[t.BC5=66]="BC5",t[t.BC5_SNORM=67]="BC5_SNORM",t[t.BC6H_UF16=68]="BC6H_UF16",t[t.BC6H_SF16=69]="BC6H_SF16",t[t.BC7=70]="BC7",t[t.BC7_SRGB=71]="BC7_SRGB",t[t.ETC_RGB8=72]="ETC_RGB8",t[t.ETC2_RGB8=73]="ETC2_RGB8",t[t.ETC2_SRGB8=74]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=77]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",t[t.EAC_R11=79]="EAC_R11",t[t.EAC_R11SN=80]="EAC_R11SN",t[t.EAC_RG11=81]="EAC_RG11",t[t.EAC_RG11SN=82]="EAC_RG11SN",t[t.PVRTC_RGB2=83]="PVRTC_RGB2",t[t.PVRTC_RGBA2=84]="PVRTC_RGBA2",t[t.PVRTC_RGB4=85]="PVRTC_RGB4",t[t.PVRTC_RGBA4=86]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=87]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=88]="PVRTC2_4BPP",t[t.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",t[t.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",t[t.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",t[t.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",t[t.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",t[t.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",t[t.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",t[t.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",t[t.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",t[t.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",t[t.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",t[t.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",t[t.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",t[t.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",t[t.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",t[t.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",t[t.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",t[t.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",t[t.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",t[t.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",t[t.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",t[t.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",t[t.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",t[t.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",t[t.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",t[t.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",t[t.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",t[t.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",t[t.COUNT=117]="COUNT"}(fi||(fi={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(pi||(pi={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(di||(di={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(_i||(_i={})),function(t){t[t.NONE=0]="NONE"}(mi||(mi={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(vi||(vi={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(gi||(gi={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(yi||(yi={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(xi||(xi={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Si||(Si={})),function(t){t[t.ONE=0]="ONE",t[t.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",t[t.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",t[t.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Ti||(Ti={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON",t[t.RELAXED=2]="RELAXED",t[t.MAILBOX=3]="MAILBOX",t[t.HALF=4]="HALF"}(Ei||(Ei={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(bi||(bi={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(Ci||(Ci={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(Ai||(Ai={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(wi||(wi={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ri||(Ri={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Pi||(Pi={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(Ii||(Ii={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(Mi||(Mi={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(Di||(Di={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(Oi||(Oi={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=3]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=17]="TRANSFER_READ",t[t.HOST_READ=18]="HOST_READ",t[t.PRESENT=19]="PRESENT",t[t.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=25]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",t[t.HOST_WRITE=27]="HOST_WRITE"}(Ni||(Ni={})),function(t){t[t.NONE=0]="NONE",t[t.SAMPLE_ZERO=1]="SAMPLE_ZERO",t[t.AVERAGE=2]="AVERAGE",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Li||(Li={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(Bi||(Bi={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Fi||(Fi={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(zi||(zi={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(ki||(ki={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(Ui||(Ui={})),function(t){t[t.NONE=0]="NONE",t[t.LINE_WIDTH=1]="LINE_WIDTH",t[t.DEPTH_BIAS=2]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Gi||(Gi={})),function(t){t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK",t[t.ALL=3]="ALL"}(Hi||(Hi={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Vi||(Vi={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(Wi||(Wi={})),function(t){t[t.OCCLUSION=0]="OCCLUSION",t[t.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",t[t.TIMESTAMP=2]="TIMESTAMP"}(ji||(ji={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(qi||(qi={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(Xi||(Xi={}));var Ki,Qi=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),Zi=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,f,p,d,_,m,v,g,y,x,S){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===f&&(f=0),void 0===p&&(p=1),void 0===d&&(d=0),void 0===_&&(_=0),void 0===m&&(m=new Qi),void 0===v&&(v=new Qi),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=f,this.uboOffsetAlignment=p,this.maxComputeSharedMemorySize=d,this.maxComputeWorkGroupInvocations=_,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return t.prototype.copy=function(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.supportQuery=t.supportQuery,this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this},t}(),Ji=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),$i=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},t}(),tr=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.width=t,this.height=e,this.depth=n}return t.prototype.copy=function(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this},t}(),er=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=n}return t.prototype.copy=function(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),nr=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=n,this.layerCount=i}return t.prototype.copy=function(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),ir=function(){function t(t,e,n,i,r){void 0===t&&(t=new er),void 0===e&&(e=new Ji),void 0===n&&(n=new er),void 0===i&&(i=new Ji),void 0===r&&(r=new tr),this.srcSubres=t,this.srcOffset=e,this.dstSubres=n,this.dstOffset=i,this.extent=r}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this},t}(),rr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=new er),void 0===e&&(e=new Ji),void 0===n&&(n=new tr),void 0===i&&(i=new er),void 0===r&&(r=new Ji),void 0===o&&(o=new tr),this.srcSubres=t,this.srcOffset=e,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this},t}(),or=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=new Ji),void 0===i&&(i=new tr),void 0===r&&(r=new er),this.buffStride=t,this.buffTexHeight=e,this.texOffset=n,this.texExtent=i,this.texSubres=r}return t.prototype.copy=function(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this},t}(),ar=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=t,this.top=e,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return t.prototype.copy=function(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this},t}(),sr=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=n,this.w=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t}(),cr=function(){function t(t,e,n){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=0),this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=n}return t.prototype.copy=function(t){return this.bufferOffsets=t.bufferOffsets.slice(),this.samplerOffsets=t.samplerOffsets.slice(),this.flexibleSet=t.flexibleSet,this},t}(),lr=function(){function t(t,e,n,i){void 0===t&&(t=null),void 0===e&&(e=Ei.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=t,this.vsyncMode=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.windowHandle=t.windowHandle,this.vsyncMode=t.vsyncMode,this.width=t.width,this.height=t.height,this},t}(),ur=function(){function t(t){void 0===t&&(t=new cr),this.bindingMappingInfo=t}return t.prototype.copy=function(t){return this.bindingMappingInfo.copy(t.bindingMappingInfo),this},t}(),hr=function(){function t(t,e,n,i,r){void 0===t&&(t=_i.NONE),void 0===e&&(e=gi.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=mi.NONE),this.usage=t,this.memUsage=e,this.size=n,this.stride=i,this.flags=r}return t.prototype.copy=function(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this},t}(),fr=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=0),void 0===n&&(n=0),this.buffer=t,this.offset=e,this.range=n}return t.prototype.copy=function(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this},t}(),pr=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=t,this.firstVertex=e,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return t.prototype.copy=function(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this},t}(),dr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=t,this.groupCountY=e,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return t.prototype.copy=function(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this},t}(),_r=function(){function t(t){void 0===t&&(t=[]),this.drawInfos=t}return t.prototype.copy=function(t){return Yi(this.drawInfos,t.drawInfos,pr),this},t}(),mr=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=yi.TEX2D),void 0===e&&(e=xi.NONE),void 0===n&&(n=fi.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=Si.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Ti.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=t,this.usage=e,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return t.prototype.copy=function(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this.externalRes=t.externalRes,this},t}(),vr=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=null),void 0===e&&(e=yi.TEX2D),void 0===n&&(n=fi.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=t,this.type=e,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return t.prototype.copy=function(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this},t}(),gr=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=bi.LINEAR),void 0===e&&(e=bi.LINEAR),void 0===n&&(n=bi.NONE),void 0===i&&(i=Ci.WRAP),void 0===r&&(r=Ci.WRAP),void 0===o&&(o=Ci.WRAP),void 0===a&&(a=0),void 0===s&&(s=Ai.ALWAYS),this.minFilter=t,this.magFilter=e,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return t.prototype.copy=function(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this},t}(),yr=function(){function t(t,e,n){void 0===t&&(t=""),void 0===e&&(e=di.UNKNOWN),void 0===n&&(n=0),this.name=t,this.type=e,this.count=n}return t.prototype.copy=function(t){return this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),xr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.members=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,Yi(this.members,t.members,yr),this.count=t.count,this},t}(),Sr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=di.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),Tr=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Er=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=di.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),br=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=di.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=vi.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Cr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=vi.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.count=i,this.memoryAccess=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Ar=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),wr=function(){function t(t,e){void 0===t&&(t=Mi.NONE),void 0===e&&(e=""),this.stage=t,this.source=e}return t.prototype.copy=function(t){return this.stage=t.stage,this.source=t.source,this},t}(),Rr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=""),void 0===e&&(e=fi.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=t,this.format=e,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return t.prototype.copy=function(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this},t}(),Pr=function(){function t(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=""),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=t,this.stages=e,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return t.prototype.copy=function(t){return this.name=t.name,Yi(this.stages,t.stages,wr),Yi(this.attributes,t.attributes,Rr),Yi(this.blocks,t.blocks,xr),Yi(this.buffers,t.buffers,Cr),Yi(this.samplerTextures,t.samplerTextures,Sr),Yi(this.samplers,t.samplers,Tr),Yi(this.textures,t.textures,Er),Yi(this.images,t.images,br),Yi(this.subpassInputs,t.subpassInputs,Ar),this},t}(),Ir=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=t,this.vertexBuffers=e,this.indexBuffer=n,this.indirectBuffer=i}return t.prototype.copy=function(t){return Yi(this.attributes,t.attributes,Rr),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this},t}(),Mr=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=fi.UNKNOWN),void 0===e&&(e=Ti.ONE),void 0===n&&(n=Di.CLEAR),void 0===i&&(i=Oi.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Ni.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=t,this.sampleCount=e,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Dr=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=fi.UNKNOWN),void 0===e&&(e=Ti.ONE),void 0===n&&(n=Di.CLEAR),void 0===i&&(i=Oi.STORE),void 0===r&&(r=Di.CLEAR),void 0===o&&(o=Oi.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Ni.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=t,this.sampleCount=e,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Or=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Li.NONE),void 0===s&&(s=Li.NONE),this.inputs=t,this.colors=e,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return t.prototype.copy=function(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this},t}(),Nr=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=t,this.dstSubpass=e,this.srcAccesses=n,this.dstAccesses=i}return t.prototype.copy=function(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.srcAccesses=t.srcAccesses.slice(),this.dstAccesses=t.dstAccesses.slice(),this},t}(),Lr=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=new Dr),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=n,this.dependencies=i}return t.prototype.copy=function(t){return Yi(this.colorAttachments,t.colorAttachments,Mr),this.depthStencilAttachment.copy(t.depthStencilAttachment),Yi(this.subpasses,t.subpasses,Or),Yi(this.dependencies,t.dependencies,Nr),this},t}(),Br=function(){function t(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]),this.prevAccesses=t,this.nextAccesses=e}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this},t}(),Fr=function(){function t(t,e,n,i,r){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=t,this.nextAccesses=e,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this},t}(),zr=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=[]),void 0===n&&(n=null),this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=n}return t.prototype.copy=function(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this},t}(),kr=function(){function t(t,e,n,i,r){void 0===t&&(t=-1),void 0===e&&(e=Vi.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Mi.NONE),void 0===r&&(r=[]),this.binding=t,this.descriptorType=e,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return t.prototype.copy=function(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this},t}(),Ur=function(){function t(t){void 0===t&&(t=[]),this.bindings=t}return t.prototype.copy=function(t){return Yi(this.bindings,t.bindings,kr),this},t}(),Gr=function(){function t(t){void 0===t&&(t=null),this.layout=t}return t.prototype.copy=function(t){return this.layout=t.layout,this},t}(),Hr=function(){function t(t){void 0===t&&(t=[]),this.setLayouts=t}return t.prototype.copy=function(t){return this.setLayouts=t.setLayouts.slice(),this},t}(),Vr=function(){function t(t){void 0===t&&(t=[]),this.attributes=t}return t.prototype.copy=function(t){return Yi(this.attributes,t.attributes,Rr),this},t}(),Wr=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=qi.PRIMARY),this.queue=t,this.type=e}return t.prototype.copy=function(t){return this.queue=t.queue,this.type=t.type,this},t}(),jr=function(){function t(t){void 0===t&&(t=Wi.GRAPHICS),this.type=t}return t.prototype.copy=function(t){return this.type=t.type,this},t}(),qr=function(){function t(t,e,n){void 0===t&&(t=ji.OCCLUSION),void 0===e&&(e=65536),void 0===n&&(n=!0),this.type=t,this.maxQueryObjects=e,this.forceWait=n}return t.prototype.copy=function(t){return this.type=t.type,this.maxQueryObjects=t.maxQueryObjects,this.forceWait=t.forceWait,this},t}(),Xr=function(t,e,n,i,r,o,a,s){void 0===t&&(t=""),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=pi.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=t,this.size=e,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},Yr=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.bufferSize=t,this.textureSize=e}return t.prototype.copy=function(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this},t}(),Kr=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.writeMask=t,this.compareMask=e,this.reference=n}return t.prototype.copy=function(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this},t}(),Qr=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=new ar),void 0===e&&(e=new $i),void 0===n&&(n=new sr),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new Kr),void 0===u&&(u=new Kr),this.viewport=t,this.scissor=e,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return t.prototype.copy=function(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this},t}(),Zr=function(){function t(e){this._objectType=si.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=e,this._objectID=t._idTable[si.UNKNOWN]++,this._typedID=t._idTable[e]++}return Z(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}();Zr._idTable=Array(si.COUNT).fill(65536),function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(Ki||(Ki={}));var Jr=Object.freeze([new Xr("UNKNOWN",0,0,pi.NONE,!1,!1,!1,!1),new Xr("A8",1,1,pi.UNORM,!0,!1,!1,!1),new Xr("L8",1,1,pi.UNORM,!1,!1,!1,!1),new Xr("LA8",1,2,pi.UNORM,!0,!1,!1,!1),new Xr("R8",1,1,pi.UNORM,!1,!1,!1,!1),new Xr("R8SN",1,1,pi.SNORM,!1,!1,!1,!1),new Xr("R8UI",1,1,pi.UINT,!1,!1,!1,!1),new Xr("R8I",1,1,pi.INT,!1,!1,!1,!1),new Xr("R16F",2,1,pi.FLOAT,!1,!1,!1,!1),new Xr("R16UI",2,1,pi.UINT,!1,!1,!1,!1),new Xr("R16I",2,1,pi.INT,!1,!1,!1,!1),new Xr("R32F",4,1,pi.FLOAT,!1,!1,!1,!1),new Xr("R32UI",4,1,pi.UINT,!1,!1,!1,!1),new Xr("R32I",4,1,pi.INT,!1,!1,!1,!1),new Xr("RG8",2,2,pi.UNORM,!1,!1,!1,!1),new Xr("RG8SN",2,2,pi.SNORM,!1,!1,!1,!1),new Xr("RG8UI",2,2,pi.UINT,!1,!1,!1,!1),new Xr("RG8I",2,2,pi.INT,!1,!1,!1,!1),new Xr("RG16F",4,2,pi.FLOAT,!1,!1,!1,!1),new Xr("RG16UI",4,2,pi.UINT,!1,!1,!1,!1),new Xr("RG16I",4,2,pi.INT,!1,!1,!1,!1),new Xr("RG32F",8,2,pi.FLOAT,!1,!1,!1,!1),new Xr("RG32UI",8,2,pi.UINT,!1,!1,!1,!1),new Xr("RG32I",8,2,pi.INT,!1,!1,!1,!1),new Xr("RGB8",3,3,pi.UNORM,!1,!1,!1,!1),new Xr("SRGB8",3,3,pi.UNORM,!1,!1,!1,!1),new Xr("RGB8SN",3,3,pi.SNORM,!1,!1,!1,!1),new Xr("RGB8UI",3,3,pi.UINT,!1,!1,!1,!1),new Xr("RGB8I",3,3,pi.INT,!1,!1,!1,!1),new Xr("RGB16F",6,3,pi.FLOAT,!1,!1,!1,!1),new Xr("RGB16UI",6,3,pi.UINT,!1,!1,!1,!1),new Xr("RGB16I",6,3,pi.INT,!1,!1,!1,!1),new Xr("RGB32F",12,3,pi.FLOAT,!1,!1,!1,!1),new Xr("RGB32UI",12,3,pi.UINT,!1,!1,!1,!1),new Xr("RGB32I",12,3,pi.INT,!1,!1,!1,!1),new Xr("RGBA8",4,4,pi.UNORM,!0,!1,!1,!1),new Xr("BGRA8",4,4,pi.UNORM,!0,!1,!1,!1),new Xr("SRGB8_A8",4,4,pi.UNORM,!0,!1,!1,!1),new Xr("RGBA8SN",4,4,pi.SNORM,!0,!1,!1,!1),new Xr("RGBA8UI",4,4,pi.UINT,!0,!1,!1,!1),new Xr("RGBA8I",4,4,pi.INT,!0,!1,!1,!1),new Xr("RGBA16F",8,4,pi.FLOAT,!0,!1,!1,!1),new Xr("RGBA16UI",8,4,pi.UINT,!0,!1,!1,!1),new Xr("RGBA16I",8,4,pi.INT,!0,!1,!1,!1),new Xr("RGBA32F",16,4,pi.FLOAT,!0,!1,!1,!1),new Xr("RGBA32UI",16,4,pi.UINT,!0,!1,!1,!1),new Xr("RGBA32I",16,4,pi.INT,!0,!1,!1,!1),new Xr("R5G6B5",2,3,pi.UNORM,!1,!1,!1,!1),new Xr("R11G11B10F",4,3,pi.FLOAT,!1,!1,!1,!1),new Xr("RGB5A1",2,4,pi.UNORM,!0,!1,!1,!1),new Xr("RGBA4",2,4,pi.UNORM,!0,!1,!1,!1),new Xr("RGB10A2",2,4,pi.UNORM,!0,!1,!1,!1),new Xr("RGB10A2UI",2,4,pi.UINT,!0,!1,!1,!1),new Xr("RGB9E5",2,4,pi.FLOAT,!0,!1,!1,!1),new Xr("DEPTH",4,1,pi.FLOAT,!1,!0,!1,!1),new Xr("DEPTH_STENCIL",5,2,pi.FLOAT,!1,!0,!0,!1),new Xr("BC1",1,3,pi.UNORM,!1,!1,!1,!0),new Xr("BC1_ALPHA",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("BC1_SRGB",1,3,pi.UNORM,!1,!1,!1,!0),new Xr("BC1_SRGB_ALPHA",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("BC2",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("BC2_SRGB",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("BC3",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("BC3_SRGB",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("BC4",1,1,pi.UNORM,!1,!1,!1,!0),new Xr("BC4_SNORM",1,1,pi.SNORM,!1,!1,!1,!0),new Xr("BC5",1,2,pi.UNORM,!1,!1,!1,!0),new Xr("BC5_SNORM",1,2,pi.SNORM,!1,!1,!1,!0),new Xr("BC6H_UF16",1,3,pi.UFLOAT,!1,!1,!1,!0),new Xr("BC6H_SF16",1,3,pi.FLOAT,!1,!1,!1,!0),new Xr("BC7",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("BC7_SRGB",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ETC_RGB8",1,3,pi.UNORM,!1,!1,!1,!0),new Xr("ETC2_RGB8",1,3,pi.UNORM,!1,!1,!1,!0),new Xr("ETC2_SRGB8",1,3,pi.UNORM,!1,!1,!1,!0),new Xr("ETC2_RGB8_A1",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ETC2_SRGB8_A1",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ETC2_RGBA8",2,4,pi.UNORM,!0,!1,!1,!0),new Xr("ETC2_SRGB8_A8",2,4,pi.UNORM,!0,!1,!1,!0),new Xr("EAC_R11",1,1,pi.UNORM,!1,!1,!1,!0),new Xr("EAC_R11SN",1,1,pi.SNORM,!1,!1,!1,!0),new Xr("EAC_RG11",2,2,pi.UNORM,!1,!1,!1,!0),new Xr("EAC_RG11SN",2,2,pi.SNORM,!1,!1,!1,!0),new Xr("PVRTC_RGB2",2,3,pi.UNORM,!1,!1,!1,!0),new Xr("PVRTC_RGBA2",2,4,pi.UNORM,!0,!1,!1,!0),new Xr("PVRTC_RGB4",2,3,pi.UNORM,!1,!1,!1,!0),new Xr("PVRTC_RGBA4",2,4,pi.UNORM,!0,!1,!1,!0),new Xr("PVRTC2_2BPP",2,4,pi.UNORM,!0,!1,!1,!0),new Xr("PVRTC2_4BPP",2,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_4x4",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_5x4",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_5x5",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_6x5",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_6x6",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_8x5",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_8x6",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_8x8",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x5",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x6",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x8",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x10",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_12x10",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_12x12",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_4x4",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_5x4",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_5x5",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_6x5",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_6x6",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_8x5",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_8x6",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_8x8",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x5",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x6",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x8",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x10",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_12x10",1,4,pi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_12x12",1,4,pi.UNORM,!0,!1,!1,!0)]),$r=Vi.UNIFORM_BUFFER|Vi.DYNAMIC_UNIFORM_BUFFER|Vi.STORAGE_BUFFER|Vi.DYNAMIC_STORAGE_BUFFER,to=Vi.SAMPLER_TEXTURE|Vi.SAMPLER|Vi.TEXTURE|Vi.STORAGE_IMAGE|Vi.INPUT_ATTACHMENT,eo=Vi.DYNAMIC_STORAGE_BUFFER|Vi.DYNAMIC_UNIFORM_BUFFER,no=28;function io(t){return t>0&&0==(t&t-1)}function ro(t,e,n,i){if(!Jr[t].isCompressed)return e*n*i*Jr[t].size;switch(t){case fi.BC1:case fi.BC1_ALPHA:case fi.BC1_SRGB:case fi.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case fi.BC2:case fi.BC2_SRGB:case fi.BC3:case fi.BC3_SRGB:case fi.BC4:case fi.BC4_SNORM:case fi.BC6H_SF16:case fi.BC6H_UF16:case fi.BC7:case fi.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case fi.BC5:case fi.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(n/4)*32*i;case fi.ETC_RGB8:case fi.ETC2_RGB8:case fi.ETC2_SRGB8:case fi.ETC2_RGB8_A1:case fi.EAC_R11:case fi.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case fi.ETC2_RGBA8:case fi.ETC2_SRGB8_A1:case fi.EAC_RG11:case fi.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case fi.PVRTC_RGB2:case fi.PVRTC_RGBA2:case fi.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(n,8)/4)*i;case fi.PVRTC_RGB4:case fi.PVRTC_RGBA4:case fi.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(n,8)/2)*i;case fi.ASTC_RGBA_4X4:case fi.ASTC_SRGBA_4X4:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case fi.ASTC_RGBA_5X4:case fi.ASTC_SRGBA_5X4:return Math.ceil(e/5)*Math.ceil(n/4)*16*i;case fi.ASTC_RGBA_5X5:case fi.ASTC_SRGBA_5X5:return Math.ceil(e/5)*Math.ceil(n/5)*16*i;case fi.ASTC_RGBA_6X5:case fi.ASTC_SRGBA_6X5:return Math.ceil(e/6)*Math.ceil(n/5)*16*i;case fi.ASTC_RGBA_6X6:case fi.ASTC_SRGBA_6X6:return Math.ceil(e/6)*Math.ceil(n/6)*16*i;case fi.ASTC_RGBA_8X5:case fi.ASTC_SRGBA_8X5:return Math.ceil(e/8)*Math.ceil(n/5)*16*i;case fi.ASTC_RGBA_8X6:case fi.ASTC_SRGBA_8X6:return Math.ceil(e/8)*Math.ceil(n/6)*16*i;case fi.ASTC_RGBA_8X8:case fi.ASTC_SRGBA_8X8:return Math.ceil(e/8)*Math.ceil(n/8)*16*i;case fi.ASTC_RGBA_10X5:case fi.ASTC_SRGBA_10X5:return Math.ceil(e/10)*Math.ceil(n/5)*16*i;case fi.ASTC_RGBA_10X6:case fi.ASTC_SRGBA_10X6:return Math.ceil(e/10)*Math.ceil(n/6)*16*i;case fi.ASTC_RGBA_10X8:case fi.ASTC_SRGBA_10X8:return Math.ceil(e/10)*Math.ceil(n/8)*16*i;case fi.ASTC_RGBA_10X10:case fi.ASTC_SRGBA_10X10:return Math.ceil(e/10)*Math.ceil(n/10)*16*i;case fi.ASTC_RGBA_12X10:case fi.ASTC_SRGBA_12X10:return Math.ceil(e/12)*Math.ceil(n/10)*16*i;case fi.ASTC_RGBA_12X12:case fi.ASTC_SRGBA_12X12:return Math.ceil(e/12)*Math.ceil(n/12)*16*i;default:return 0}}function oo(t,e,n,i,r){for(var o=0,a=0;a<r;++a)o+=ro(t,e,n,i),e=Math.max(e>>1,1),n=Math.max(n>>1,1);return o}var ao=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function so(t){return ao[t]||0}function co(t){var e=t.size/t.count;switch(t.type){case pi.UNORM:case pi.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case pi.SNORM:case pi.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case pi.FLOAT:return Float32Array}return Float32Array}var lo=Object.freeze({__proto__:null,get ObjectType(){return si},get Status(){return ci},get API(){return li},get SurfaceTransform(){return ui},get Feature(){return hi},get Format(){return fi},get FormatType(){return pi},get Type(){return di},get BufferUsageBit(){return _i},get BufferFlagBit(){return mi},get MemoryAccessBit(){return vi},get MemoryUsageBit(){return gi},get TextureType(){return yi},get TextureUsageBit(){return xi},get TextureFlagBit(){return Si},get SampleCount(){return Ti},get VsyncMode(){return Ei},get Filter(){return bi},get Address(){return Ci},get ComparisonFunc(){return Ai},get StencilOp(){return wi},get BlendFactor(){return Ri},get BlendOp(){return Pi},get ColorMask(){return Ii},get ShaderStageFlagBit(){return Mi},get LoadOp(){return Di},get StoreOp(){return Oi},get AccessType(){return Ni},get ResolveMode(){return Li},get PipelineBindPoint(){return Bi},get PrimitiveMode(){return Fi},get PolygonMode(){return zi},get ShadeModel(){return ki},get CullMode(){return Ui},get DynamicStateFlagBit(){return Gi},get StencilFace(){return Hi},get DescriptorType(){return Vi},get QueueType(){return Wi},get QueryType(){return ji},get CommandBufferType(){return qi},get ClearFlagBit(){return Xi},Size:Qi,DeviceCaps:Zi,Offset:Ji,Rect:$i,Extent:tr,TextureSubresLayers:er,TextureSubresRange:nr,TextureCopy:ir,TextureBlit:rr,BufferTextureCopy:or,Viewport:ar,Color:sr,BindingMappingInfo:cr,SwapchainInfo:lr,DeviceInfo:ur,BufferInfo:hr,BufferViewInfo:fr,DrawInfo:pr,DispatchInfo:dr,IndirectBuffer:_r,TextureInfo:mr,TextureViewInfo:vr,SamplerInfo:gr,Uniform:yr,UniformBlock:xr,UniformSamplerTexture:Sr,UniformSampler:Tr,UniformTexture:Er,UniformStorageImage:br,UniformStorageBuffer:Cr,UniformInputAttachment:Ar,ShaderStage:wr,Attribute:Rr,ShaderInfo:Pr,InputAssemblerInfo:Ir,ColorAttachment:Mr,DepthStencilAttachment:Dr,SubpassInfo:Or,SubpassDependency:Nr,RenderPassInfo:Lr,GlobalBarrierInfo:Br,TextureBarrierInfo:Fr,FramebufferInfo:zr,DescriptorSetLayoutBinding:kr,DescriptorSetLayoutInfo:Ur,DescriptorSetInfo:Gr,PipelineLayoutInfo:Hr,InputState:Vr,CommandBufferInfo:Wr,QueueInfo:jr,QueryPoolInfo:qr,FormatInfo:Xr,MemoryStatus:Yr,DynamicStencilStates:Kr,DynamicStates:Qr,GFXObject:Zr,get AttributeName(){return Ki},FormatInfos:Jr,DESCRIPTOR_BUFFER_TYPE:$r,DESCRIPTOR_SAMPLER_TYPE:to,DESCRIPTOR_DYNAMIC_TYPE:eo,DRAW_INFO_SIZE:no,IsPowerOf2:io,FormatSize:ro,FormatSurfaceSize:oo,GetTypeSize:so,getTypedArrayConstructor:co}),uo=function(t){function e(){var e;return(e=t.call(this,si.BUFFER)||this)._usage=_i.NONE,e._memUsage=gi.NONE,e._size=0,e._stride=1,e._count=0,e._flags=mi.NONE,e._isBufferView=!1,e}return $(e,t),Z(e,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),e}(Zr),ho=function(t){function e(){var e;return(e=t.call(this,si.COMMAND_BUFFER)||this)._queue=null,e._type=qi.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}return $(e,t),Z(e,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),e}(Zr),fo=function(){function t(){this._gfxAPI=li.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(hi.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Yr,this._caps=new Zi,this._bindingMappingInfo=new cr,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return t.prototype.hasFeature=function(t){return this._features[t]},Z(t,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),t}();fo.canvas=void 0;var po=function(t){function e(){var e;return(e=t.call(this,si.SWAPCHAIN)||this)._transform=ui.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}return $(e,t),Z(e,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),e}(Zr),_o=function(t){function e(){var e;return(e=t.call(this,si.FRAMEBUFFER)||this)._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}return $(e,t),Z(e,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),e}(Zr),mo=String.prototype.charCodeAt;function vo(t){return this[t]}function go(t,e){for(var n=t.length,i=e^n,r=0,o="string"==typeof t?mo:vo;n>=4;){var a=255&o.call(t,r)|(255&o.call(t,++r))<<8|(255&o.call(t,++r))<<16|(255&o.call(t,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(t,r+2))<<16;case 2:i^=(255&o.call(t,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(t,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var yo=function(t){function e(){var e;return(e=t.call(this,si.INPUT_ASSEMBLER)||this)._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new pr,e}$(e,t);var n=e.prototype;return n.getVertexBuffer=function(t){return void 0===t&&(t=0),t<this._vertexBuffers.length?this._vertexBuffers[t]:null},n.computeAttributesHash=function(){for(var t="attrs",e=0;e<this.attributes.length;++e){var n=this.attributes[e];t+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return go(t,666)},Z(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(t){this._drawInfo.vertexCount=t}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(t){this._drawInfo.firstVertex=t}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(t){this._drawInfo.indexCount=t}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(t){this._drawInfo.firstIndex=t}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(t){this._drawInfo.vertexOffset=t}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(t){this._drawInfo.instanceCount=t}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(t){this._drawInfo.firstInstance=t}},{key:"drawInfo",get:function(){return this._drawInfo}}]),e}(Zr),xo=function(t){function e(){var e;return(e=t.call(this,si.DESCRIPTOR_SET)||this)._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}$(e,t);var n=e.prototype;return n.bindBuffer=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&$r){var o=this._layout.descriptorIndices[t];this._buffers[o+n]!==e&&(this._buffers[o+n]=e,this._isDirty=!0)}},n.bindSampler=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&to){var o=this._layout.descriptorIndices[t];this._samplers[o+n]!==e&&(this._samplers[o+n]=e,this._isDirty=!0)}},n.bindTexture=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&to){var o=this._layout.descriptorIndices[t];this._textures[o+n]!==e&&(this._textures[o+n]=e,this._isDirty=!0)}},n.getBuffer=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._buffers[n+e]},n.getSampler=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._samplers[n+e]},n.getTexture=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._textures[n+e]},Z(e,[{key:"layout",get:function(){return this._layout}}]),e}(Zr),So=function(t){function e(){var e;return(e=t.call(this,si.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}return $(e,t),Z(e,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),e}(Zr),To=function(t){function e(){var e;return(e=t.call(this,si.PIPELINE_LAYOUT)||this)._setLayouts=[],e}return $(e,t),Z(e,[{key:"setLayouts",get:function(){return this._setLayouts}}]),e}(Zr),Eo=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h){void 0===t&&(t=!1),void 0===e&&(e=zi.FILL),void 0===n&&(n=ki.GOURAND),void 0===i&&(i=Ui.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=t,this.polygonMode=e,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var e=t.prototype;return e.reset=function(){this.isDiscard=!1,this.polygonMode=zi.FILL,this.shadeModel=ki.GOURAND,this.cullMode=Ui.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},Z(t,[{key:"native",get:function(){return this}}]),t}(),bo=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,f,p,d,_,m,v,g){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===n&&(n=Ai.LESS),void 0===i&&(i=!1),void 0===r&&(r=Ai.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=wi.KEEP),void 0===c&&(c=wi.KEEP),void 0===l&&(l=wi.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===f&&(f=Ai.ALWAYS),void 0===p&&(p=65535),void 0===d&&(d=65535),void 0===_&&(_=wi.KEEP),void 0===m&&(m=wi.KEEP),void 0===v&&(v=wi.KEEP),void 0===g&&(g=1),this.depthTest=t,this.depthWrite=e,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=f,this.stencilReadMaskBack=p,this.stencilWriteMaskBack=d,this.stencilFailOpBack=_,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var e=t.prototype;return e.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Ai.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Ai.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=wi.KEEP,this.stencilZFailOpFront=wi.KEEP,this.stencilPassOpFront=wi.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Ai.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=wi.KEEP,this.stencilZFailOpBack=wi.KEEP,this.stencilPassOpBack=wi.KEEP,this.stencilRefBack=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},Z(t,[{key:"native",get:function(){return this}}]),t}(),Co=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=!1),void 0===e&&(e=Ri.ONE),void 0===n&&(n=Ri.ZERO),void 0===i&&(i=Pi.ADD),void 0===r&&(r=Ri.ONE),void 0===o&&(o=Ri.ZERO),void 0===a&&(a=Pi.ADD),void 0===s&&(s=Ii.ALL),this.blend=t,this.blendSrc=e,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var e=t.prototype;return e.reset=function(){this.blend=!1,this.blendSrc=Ri.ONE,this.blendDst=Ri.ZERO,this.blendEq=Pi.ADD,this.blendSrcAlpha=Ri.ONE,this.blendDstAlpha=Ri.ZERO,this.blendAlphaEq=Pi.ADD,this.blendColorMask=Ii.ALL},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},t}(),Ao=function(){function t(t,e,n,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===n&&(n=new sr),void 0===i&&(i=[new Co]),this.isA2C=t,this.isIndepend=e,this.blendColor=n,this.targets=i}var e=t.prototype;return e.setTarget=function(t,e){var n=this.targets[t];n||(n=this.targets[t]=new Co),Object.assign(n,e)},e.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},e.destroy=function(){},Z(t,[{key:"native",get:function(){return this}}]),t}(),wo=function(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null),void 0===i&&(i=new Vr),void 0===r&&(r=new Eo),void 0===o&&(o=new bo),void 0===a&&(a=new Ao),void 0===s&&(s=Fi.TRIANGLE_LIST),void 0===c&&(c=Gi.NONE),void 0===l&&(l=Bi.GRAPHICS),this.shader=t,this.pipelineLayout=e,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Ro=function(t){function e(){var e;return(e=t.call(this,si.PIPELINE_STATE)||this)._shader=null,e._pipelineLayout=null,e._primitive=Fi.TRIANGLE_LIST,e._is=null,e._rs=new Eo,e._dss=new bo,e._bs=new Ao,e._dynamicStates=Gi.NONE,e._renderPass=null,e}return $(e,t),Z(e,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),e}(Zr),Po=function(t){function e(){var e;return(e=t.call(this,si.QUEUE)||this)._type=Wi.GRAPHICS,e}return $(e,t),Z(e,[{key:"type",get:function(){return this._type}}]),e}(Zr),Io=function(t){function e(){var e;return(e=t.call(this,si.RENDER_PASS)||this)._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}return $(e,t),e.prototype.computeHash=function(){var t="";if(this._subpasses.length)for(var e=0;e<this._subpasses.length;++e){var n=this._subpasses[e];if(n.inputs.length){t+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];t+=","+r.format+","+r.sampleCount}}if(n.colors.length){t+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];t+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];t+="ds,"+s.format+","+s.sampleCount}}else{t+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];t+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(t+="ds,"+u.format+","+u.sampleCount)}return go(t,666)},Z(e,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),e}(Zr),Mo=function(t){function e(e,n){var i;return(i=t.call(this,si.SAMPLER)||this)._info=new gr,i._hash=0,i._info.copy(e),i._hash=n,i}return $(e,t),e.computeHash=function(t){var e=t.minFilter;return e|=t.magFilter<<2,e|=t.mipFilter<<4,e|=t.addressU<<6,e|=t.addressV<<8,e|=t.addressW<<10,(e|=t.maxAnisotropy<<12)|t.cmpFunc<<16},e.unpackFromHash=function(t){var e=new gr;return e.minFilter=(3&t)>>0,e.magFilter=(3&t)>>2,e.mipFilter=(3&t)>>4,e.addressU=(3&t)>>6,e.addressV=(3&t)>>8,e.addressW=(3&t)>>10,e.maxAnisotropy=(15&t)>>12,e.cmpFunc=(7&t)>>16,e},Z(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Zr),Do=function(t){function e(){var e;return(e=t.call(this,si.SHADER)||this)._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}return $(e,t),Z(e,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),e}(Zr),Oo=function(t){function e(){var e;return(e=t.call(this,si.TEXTURE)||this)._type=yi.TEX2D,e._usage=xi.NONE,e._format=fi.UNKNOWN,e._width=0,e._height=0,e._depth=1,e._layerCount=1,e._levelCount=1,e._samples=Ti.ONE,e._flags=Si.NONE,e._isPowerOf2=!1,e._size=0,e}return $(e,t),Z(e,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),e}(Zr),No=function(t){function e(e,n){var i;return(i=t.call(this,si.GLOBAL_BARRIER)||this)._info=new Br,i._hash=0,i._info.copy(e),i._hash=n,i}return $(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return go(e,666)},Z(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Zr),Lo=function(t){function e(e,n){var i;return(i=t.call(this,si.TEXTURE_BARRIER)||this)._info=new Fr,i._hash=0,i._info.copy(e),i._hash=n,i}return $(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,go(e+=t.dstQueue?t.dstQueue.type:0,666)},Z(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Zr),Bo={Device:fo,Swapchain:po,Buffer:uo,Texture:Oo,Sampler:Mo,Shader:Do,InputAssembler:yo,RenderPass:Io,Framebuffer:_o,DescriptorSet:xo,DescriptorSetLayout:So,PipelineLayout:To,PipelineState:Ro,CommandBuffer:ho,Queue:Po,GlobalBarrier:No,TextureBarrier:Lo,RasterizerState:Eo,BlendState:Ao,BlendTarget:Co,DepthStencilState:bo,PipelineStateInfo:wo};Object.assign(Bo,lo),u.gfx=Bo;var Fo={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var zo in u.gfx)if("__esModule"!==zo){var ko=Fo[zo];""===ko?ko=zo:void 0===ko&&(ko="GFX"+zo),U(u,"cc",[{name:ko,newName:zo,target:u.gfx,targetName:"cc.gfx"}])}t("gfx",Object.freeze({__proto__:null,DescriptorSet:xo,Buffer:uo,CommandBuffer:ho,get ObjectType(){return si},get Status(){return ci},get API(){return li},get SurfaceTransform(){return ui},get Feature(){return hi},get Format(){return fi},get FormatType(){return pi},get Type(){return di},get BufferUsageBit(){return _i},get BufferFlagBit(){return mi},get MemoryAccessBit(){return vi},get MemoryUsageBit(){return gi},get TextureType(){return yi},get TextureUsageBit(){return xi},get TextureFlagBit(){return Si},get SampleCount(){return Ti},get VsyncMode(){return Ei},get Filter(){return bi},get Address(){return Ci},get ComparisonFunc(){return Ai},get StencilOp(){return wi},get BlendFactor(){return Ri},get BlendOp(){return Pi},get ColorMask(){return Ii},get ShaderStageFlagBit(){return Mi},get LoadOp(){return Di},get StoreOp(){return Oi},get AccessType(){return Ni},get ResolveMode(){return Li},get PipelineBindPoint(){return Bi},get PrimitiveMode(){return Fi},get PolygonMode(){return zi},get ShadeModel(){return ki},get CullMode(){return Ui},get DynamicStateFlagBit(){return Gi},get StencilFace(){return Hi},get DescriptorType(){return Vi},get QueueType(){return Wi},get QueryType(){return ji},get CommandBufferType(){return qi},get ClearFlagBit(){return Xi},Size:Qi,DeviceCaps:Zi,Offset:Ji,Rect:$i,Extent:tr,TextureSubresLayers:er,TextureSubresRange:nr,TextureCopy:ir,TextureBlit:rr,BufferTextureCopy:or,Viewport:ar,Color:sr,BindingMappingInfo:cr,SwapchainInfo:lr,DeviceInfo:ur,BufferInfo:hr,BufferViewInfo:fr,DrawInfo:pr,DispatchInfo:dr,IndirectBuffer:_r,TextureInfo:mr,TextureViewInfo:vr,SamplerInfo:gr,Uniform:yr,UniformBlock:xr,UniformSamplerTexture:Sr,UniformSampler:Tr,UniformTexture:Er,UniformStorageImage:br,UniformStorageBuffer:Cr,UniformInputAttachment:Ar,ShaderStage:wr,Attribute:Rr,ShaderInfo:Pr,InputAssemblerInfo:Ir,ColorAttachment:Mr,DepthStencilAttachment:Dr,SubpassInfo:Or,SubpassDependency:Nr,RenderPassInfo:Lr,GlobalBarrierInfo:Br,TextureBarrierInfo:Fr,FramebufferInfo:zr,DescriptorSetLayoutBinding:kr,DescriptorSetLayoutInfo:Ur,DescriptorSetInfo:Gr,PipelineLayoutInfo:Hr,InputState:Vr,CommandBufferInfo:Wr,QueueInfo:jr,QueryPoolInfo:qr,FormatInfo:Xr,MemoryStatus:Yr,DynamicStencilStates:Kr,DynamicStates:Qr,GFXObject:Zr,get AttributeName(){return Ki},FormatInfos:Jr,DESCRIPTOR_BUFFER_TYPE:$r,DESCRIPTOR_SAMPLER_TYPE:to,DESCRIPTOR_DYNAMIC_TYPE:eo,DRAW_INFO_SIZE:no,IsPowerOf2:io,FormatSize:ro,FormatSurfaceSize:oo,GetTypeSize:so,getTypedArrayConstructor:co,Device:fo,Swapchain:po,Framebuffer:_o,InputAssembler:yo,DescriptorSetLayout:So,PipelineLayout:To,RasterizerState:Eo,DepthStencilState:bo,BlendTarget:Co,BlendState:Ao,PipelineStateInfo:wo,PipelineState:Ro,Queue:Po,RenderPass:Io,Sampler:Mo,Shader:Do,Texture:Oo,GlobalBarrier:No,TextureBarrier:Lo}));var Uo=new Rn,Go=new Rn,Ho=new Rn,Vo=new Rn,Wo=new Rn,jo=new Rn,qo=new Array(3),Xo=new Array(3);function Yo(t,e){return Rn.dot(e.n,t)-e.d}function Ko(t,e,n){return Rn.copy(t,e),Rn.subtract(Wo,n.center,n.halfExtents),Rn.add(jo,n.center,n.halfExtents),t.x=t.x<Wo.x?Wo.x:t.x,t.y=t.y<Wo.y?Wo.y:t.y,t.z=t.z<Wo.z?Wo.z:t.z,t.x=t.x>jo.x?jo.x:t.x,t.y=t.y>jo.y?jo.y:t.y,t.z=t.z>jo.z?jo.z:t.z,t}function Qo(t,e,n){Rn.set(Uo,n.orientation.m00,n.orientation.m01,n.orientation.m02),Rn.set(Go,n.orientation.m03,n.orientation.m04,n.orientation.m05),Rn.set(Ho,n.orientation.m06,n.orientation.m07,n.orientation.m08),qo[0]=Uo,qo[1]=Go,qo[2]=Ho,Xo[0]=n.halfExtents.x,Xo[1]=n.halfExtents.y,Xo[2]=n.halfExtents.z,Rn.subtract(Vo,e,n.center),Rn.set(t,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=Rn.dot(Vo,qo[i]);r>Xo[i]&&(r=Xo[i]),r<-Xo[i]&&(r=-Xo[i]),t.x+=r*qo[i].x,t.y+=r*qo[i].y,t.z+=r*qo[i].z}return t}var Zo=Object.freeze({__proto__:null,point_plane:Yo,pt_point_plane:function(t,e,n){var i=Yo(e,n);return Rn.subtract(t,e,Rn.multiplyScalar(t,n.n,i))},pt_point_aabb:Ko,pt_point_obb:Qo,pt_point_line:function(t,e,n,i){Rn.subtract(Uo,n,i);var r=Uo,o=Rn.lengthSqr(r);if(0==o)Rn.copy(t,n);else{Rn.subtract(Uo,e,n);var a=Rn.dot(Uo,r)/o;a<0?Rn.copy(t,n):a>1?Rn.copy(t,i):Rn.scaleAndAdd(t,n,r,a)}}}),Jo={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},$o=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Jo.SHAPE_LINE,this.s=new Rn(t,e,n),this.e=new Rn(i,r,o)}return t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)},t.copy=function(t,e){return Rn.copy(t.s,e.s),Rn.copy(t.e,e.e),t},t.fromPoints=function(t,e,n){return Rn.copy(t.s,e),Rn.copy(t.e,n),t},t.set=function(t,e,n,i,r,o,a){return t.s.x=e,t.s.y=n,t.s.z=i,t.e.x=r,t.e.y=o,t.e.z=a,t},t.len=function(t){return Rn.distance(t.s,t.e)},t.prototype.length=function(){return Rn.distance(this.s,this.e)},Z(t,[{key:"type",get:function(){return this._type}}]),t}(),ta=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Jo.SHAPE_RAY,this.o=new Rn(t,e,n),this.d=new Rn(i,r,o)}return t.create=function(e,n,i,r,o,a){return void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)},t.copy=function(t,e){return Rn.copy(t.o,e.o),Rn.copy(t.d,e.d),t},t.fromPoints=function(t,e,n){return Rn.copy(t.o,e),Rn.normalize(t.d,Rn.subtract(t.d,n,e)),t},t.set=function(t,e,n,i,r,o,a){return t.o.x=e,t.o.y=n,t.o.z=i,t.d.x=r,t.d.y=o,t.d.z=a,t},t.prototype.computeHit=function(t,e){Rn.normalize(t,this.d),Rn.scaleAndAdd(t,this.o,t,e)},Z(t,[{key:"type",get:function(){return this._type}}]),t}(),ea=new Rn,na=new Rn,ia=new Rn,ra=new Rn;function oa(t){return Math.max(Math.max(t.x,t.y),t.z)}var aa,sa=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new Rn(0,0,0),this._radius=0,this._type=void 0,this._type=Jo.SHAPE_SPHERE,this._center=new Rn(t,e,n),this._radius=i}t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.radius)},t.copy=function(t,e){return Rn.copy(t.center,e.center),t.radius=e.radius,t},t.fromPoints=function(t,e,n){return Rn.multiplyScalar(t.center,Rn.add(ea,e,n),.5),t.radius=.5*Rn.subtract(ea,n,e).length(),t},t.set=function(t,e,n,i,r){return t.center.x=e,t.center.y=n,t.center.z=i,t.radius=r,t};var e=t.prototype;return e.destroy=function(){},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.getBoundary=function(t,e){Rn.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Rn.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},e.transform=function(t,e,n,i,r){Rn.transformMat4(r.center,this.center,t),r.radius=this.radius*oa(i)},e.translateAndRotate=function(t,e,n){Rn.transformMat4(n.center,this.center,t)},e.setScale=function(t,e){e.radius=this.radius*oa(t)},e.mergePoint=function(t){this.radius<0&&(this.center.set(t),this.radius=0),Rn.subtract(na,t,this.center);var e=na.length();if(e>this.radius){var n=.5*(e-this.radius);this.radius+=n,Rn.multiplyScalar(na,na,n/e),Rn.add(this.center,this.center,na)}},e.mergePoints=function(t){var e=t.length;if(!(e<1)){this.radius=-1;for(var n=0;n<e;n++)this.mergePoint(t[n])}},e.mergeAABB=function(t){t.getBoundary(ia,ra),this.mergePoint(ia),this.mergePoint(ra)},Z(t,[{key:"center",get:function(){return this._center},set:function(t){this._center=t}},{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t}},{key:"type",get:function(){return this._type}}]),t}(),ca=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Jo.SHAPE_TRIANGLE,this.a=new Rn(t,e,n),this.b=new Rn(i,r,o),this.c=new Rn(a,s,c)}return t.create=function(e,n,i,r,o,a,s,c,l){return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new t(e,n,i,r,o,a,s,c,l)},t.clone=function(e){return new t(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)},t.copy=function(t,e){return Rn.copy(t.a,e.a),Rn.copy(t.b,e.b),Rn.copy(t.c,e.c),t},t.fromPoints=function(t,e,n,i){return Rn.copy(t.a,e),Rn.copy(t.b,n),Rn.copy(t.c,i),t},t.set=function(t,e,n,i,r,o,a,s,c,l){return t.a.x=e,t.a.y=n,t.a.z=i,t.b.x=r,t.b.y=o,t.b.z=a,t.c.x=s,t.c.y=c,t.c.z=l,t},Z(t,[{key:"type",get:function(){return this._type}}]),t}();!function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(aa||(aa={}));var la,ua,ha,fa,pa,da,_a,ma,va=(la=new Rn(0,0,0),function(t,e){var n=Rn.dot(t.d,e.n);if(Math.abs(n)<Number.EPSILON)return 0;Rn.multiplyScalar(la,e.n,e.d);var i=Rn.dot(Rn.subtract(la,la,t.o),e.n)/n;return i<0?0:i}),ga=(ua=new Rn(0,0,0),ha=new Rn(0,0,0),fa=new Rn(0,0,0),pa=new Rn(0,0,0),da=new Rn(0,0,0),function(t,e,n){Rn.subtract(ua,e.b,e.a),Rn.subtract(ha,e.c,e.a),Rn.cross(fa,t.d,ha);var i=Rn.dot(ua,fa);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;Rn.subtract(pa,t.o,e.a);var o=Rn.dot(pa,fa)*r;if(o<0||o>1)return 0;Rn.cross(da,pa,ua);var a=Rn.dot(t.d,da)*r;if(a<0||o+a>1)return 0;var s=Rn.dot(ha,da)*r;return s<0?0:s}),ya=function(){var t=new Rn(0,0,0);return function(e,n){var i=n.radius,r=n.center,o=e.o,a=e.d,s=i*i;Rn.subtract(t,r,o);var c=t.lengthSqr(),l=Rn.dot(t,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),f=c<s?l+h:l-h;return f<0?0:f}}(),xa=(_a=new Rn,ma=new Rn,function(t,e){return Rn.subtract(_a,e.center,e.halfExtents),Rn.add(ma,e.center,e.halfExtents),Sa(t,_a,ma)});function Sa(t,e,n){var i=t.o,r=t.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(e.x-i.x)*o,l=(n.x-i.x)*o,u=(e.y-i.y)*a,h=(n.y-i.y)*a,f=(e.z-i.z)*s,p=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(f,p)),_=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(f,p));return _<0||d>_?0:d>0?d:_}var Ta,Ea,ba,Ca,Aa=function(){var t=new Rn,e=new Rn,n=new Rn,i=new Rn,r=new Rn,o=new Rn,a=new Rn,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,f){s[0]=f.halfExtents.x,s[1]=f.halfExtents.y,s[2]=f.halfExtents.z,t=f.center,e=h.o,n=h.d,Rn.set(i,f.orientation.m00,f.orientation.m01,f.orientation.m02),Rn.set(r,f.orientation.m03,f.orientation.m04,f.orientation.m05),Rn.set(o,f.orientation.m06,f.orientation.m07,f.orientation.m08),Rn.subtract(a,t,e),c[0]=Rn.dot(i,n),c[1]=Rn.dot(r,n),c[2]=Rn.dot(o,n),l[0]=Rn.dot(i,a),l[1]=Rn.dot(r,a),l[2]=Rn.dot(o,a);for(var p=0;p<3;++p){if(0===c[p]){if(-l[p]-s[p]>0||-l[p]+s[p]<0)return 0;c[p]=1e-7}u[2*p+0]=(l[p]+s[p])/c[p],u[2*p+1]=(l[p]-s[p])/c[p]}var d=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),_=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return _<0||d>_?0:d>0?d:_}}(),wa=function(){var t=new Rn,e=new Rn,n=new Rn,i=new Rn,r=new Rn,o=new Rn,a=new Rn,s=new sa;return function(c,l){var u=l.radius*l.radius,h=Rn.normalize(t,c.d),f=l.ellipseCenter0,p=l.ellipseCenter1,d=Rn.subtract(e,p,f);if(d.equals(Rn.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),hs.raySphere(c,s);var _=c.o,m=Rn.subtract(n,_,f),v=Rn.cross(i,h,d),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=Rn.subtract(r,p,_);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),hs.raySphere(c,s)}var x=Rn.cross(r,m,d),S=d.lengthSqr(),T=2*Rn.dot(v,x),E=T*T-4*g*(x.lengthSqr()-u*S);if(E<0)return 0;var b=(-T-Math.sqrt(E))/(2*g);if(b<0){s.radius=l.radius;var C=Rn.subtract(o,p,_);return m.lengthSqr()<C.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),hs.raySphere(c,s)}var A=Rn.scaleAndAdd(o,c.o,h,b),w=Rn.subtract(a,A,f),R=Rn.dot(w,d)/S;return R>=0&&R<=1?b:R<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),hs.raySphere(c,s)):R>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),hs.raySphere(c,s)):0}}(),Ra=(Ta=ca.create(),Ea={distance:1/0,doubleSided:!1,mode:aa.ANY},ba=0,Ca=function(t,e,n,i,r,o){t===aa.CLOSEST?(ba>e||0===ba)&&(ba=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(ba=e,o&&o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(t,e,n){if(ba=0,0===e.geometricInfo.positions.length)return ba;var i=void 0===n?Ea:n;if(Sa(t,e.geometricInfo.boundingBox.min,e.geometricInfo.boundingBox.max)){var r=e.primitiveMode,o=e.geometricInfo;!function(t,e,n,i,r){if(n===Fi.TRIANGLE_LIST)for(var o=e.length,a=0;a<o;a+=3){var s=3*e[a],c=3*e[a+1],l=3*e[a+2];Rn.set(Ta.a,t[s],t[s+1],t[s+2]),Rn.set(Ta.b,t[c],t[c+1],t[c+2]),Rn.set(Ta.c,t[l],t[l+1],t[l+2]);var u=hs.rayTriangle(i,Ta,r.doubleSided);if(!(0===u||u>r.distance)&&(Ca(r.mode,u,s,c,l,r.result),r.mode===aa.ANY))return u}else if(n===Fi.TRIANGLE_STRIP)for(var h=e.length-2,f=0,p=0;p<h;p+=1){var d=3*e[p-f],_=3*e[p+f+1],m=3*e[p+2];Rn.set(Ta.a,t[d],t[d+1],t[d+2]),Rn.set(Ta.b,t[_],t[_+1],t[_+2]),Rn.set(Ta.c,t[m],t[m+1],t[m+2]),f=~f;var v=hs.rayTriangle(i,Ta,r.doubleSided);if(!(0===v||v>r.distance)&&(Ca(r.mode,v,d,_,m,r.result),r.mode===aa.ANY))return v}else if(n===Fi.TRIANGLE_FAN){var g=e.length-1,y=3*e[0];Rn.set(Ta.a,t[y],t[y+1],t[y+2]);for(var x=1;x<g;x+=1){var S=3*e[x],T=3*e[x+1];Rn.set(Ta.b,t[S],t[S+1],t[S+2]),Rn.set(Ta.c,t[T],t[T+1],t[T+2]);var E=hs.rayTriangle(i,Ta,r.doubleSided);if(!(0===E||E>r.distance)&&(Ca(r.mode,E,y,S,T,r.result),r.mode===aa.ANY))return E}}}(o.positions,o.indices,r,t,i)}return ba}),Pa=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:aa.ANY};return function(n,i,r){t=0;var o=void 0===r?e:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!Sa(n,s,c))return t;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=Ra(n,u,o);if(h)if(o.mode===aa.CLOSEST)(0===t||t>h)&&(t=h,o.subIndices&&(o.subIndices[0]=l));else if(t=h,o.subIndices&&o.subIndices.push(l),o.mode===aa.ANY)return h}return t&&o.mode===aa.CLOSEST&&(o.result&&(o.result[0].distance=t,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),t}}(),Ia=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:aa.ANY},n=new ta,i=new Vn;return function(r,o,a){t=0;var s=void 0===a?e:a,c=o.worldBounds;if(c&&!xa(r,c))return t;ta.copy(n,r),o.node&&(Vn.invert(i,o.node.getWorldMatrix(i)),Rn.transformMat4(n.o,r.o,i),Rn.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,f=Ra(n,h,s);if(f)if(s.mode===aa.CLOSEST)(0===t||t>f)&&(t=f,s.subIndices&&(s.subIndices[0]=u));else if(t=f,s.subIndices&&s.subIndices.push(u),s.mode===aa.ANY)return f}return t&&s.mode===aa.CLOSEST&&(s.result&&(s.result[0].distance=t,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),t}}(),Ma=function(){var t=new Rn(0,0,0);return function(e,n){Rn.subtract(t,e.e,e.s);var i=(n.d-Rn.dot(e.s,n.n))/Rn.dot(t,n.n);return i<0||i>1?0:i}}(),Da=function(){var t=new Rn(0,0,0),e=new Rn(0,0,0),n=new Rn(0,0,0),i=new Rn(0,0,0),r=new Rn(0,0,0),o=new Rn(0,0,0);return function(a,s,c){Rn.subtract(t,s.b,s.a),Rn.subtract(e,s.c,s.a),Rn.subtract(n,a.s,a.e),Rn.cross(r,t,e);var l=Rn.dot(n,r);if(l<=0)return 0;Rn.subtract(i,a.s,s.a);var u=Rn.dot(i,r);if(u<0||u>l)return 0;Rn.cross(o,n,i);var h=Rn.dot(e,o);if(h<0||h>l)return 0;var f=-Rn.dot(t,o);if(f<0||h+f>l)return 0;if(c){var p=1/l,d=1-(h*=p)-(f*=p);Rn.set(c,s.a.x*d+s.b.x*h+s.c.x*f,s.a.y*d+s.b.y*h+s.c.y*f,s.a.z*d+s.b.z*h+s.c.z*f)}return 1}}(),Oa=new ta;function Na(t,e){Oa.o.set(t.s),Rn.subtract(Oa.d,t.e,t.s),Oa.d.normalize();var n=xa(Oa,e);return n<=t.length()?n:0}function La(t,e){Oa.o.set(t.s),Rn.subtract(Oa.d,t.e,t.s),Oa.d.normalize();var n=Aa(Oa,e);return n<=t.length()?n:0}function Ba(t,e){Oa.o.set(t.s),Rn.subtract(Oa.d,t.e,t.s),Oa.d.normalize();var n=ya(Oa,e);return n<=t.length()?n:0}var Fa,za,ka,Ua,Ga=(Fa=new Rn,za=new Rn,ka=new Rn,Ua=new Rn,function(t,e){return Rn.subtract(Fa,t.center,t.halfExtents),Rn.add(za,t.center,t.halfExtents),Rn.subtract(ka,e.center,e.halfExtents),Rn.add(Ua,e.center,e.halfExtents),Fa.x<=Ua.x&&za.x>=ka.x&&Fa.y<=Ua.y&&za.y>=ka.y&&Fa.z<=Ua.z&&za.z>=ka.z});function Ha(t,e,n,i,r,o){Rn.set(o[0],t.x+n.x*e.x+i.x*e.y+r.x*e.z,t.y+n.y*e.x+i.y*e.y+r.y*e.z,t.z+n.z*e.x+i.z*e.y+r.z*e.z),Rn.set(o[1],t.x-n.x*e.x+i.x*e.y+r.x*e.z,t.y-n.y*e.x+i.y*e.y+r.y*e.z,t.z-n.z*e.x+i.z*e.y+r.z*e.z),Rn.set(o[2],t.x+n.x*e.x-i.x*e.y+r.x*e.z,t.y+n.y*e.x-i.y*e.y+r.y*e.z,t.z+n.z*e.x-i.z*e.y+r.z*e.z),Rn.set(o[3],t.x+n.x*e.x+i.x*e.y-r.x*e.z,t.y+n.y*e.x+i.y*e.y-r.y*e.z,t.z+n.z*e.x+i.z*e.y-r.z*e.z),Rn.set(o[4],t.x-n.x*e.x-i.x*e.y-r.x*e.z,t.y-n.y*e.x-i.y*e.y-r.y*e.z,t.z-n.z*e.x-i.z*e.y-r.z*e.z),Rn.set(o[5],t.x+n.x*e.x-i.x*e.y-r.x*e.z,t.y+n.y*e.x-i.y*e.y-r.y*e.z,t.z+n.z*e.x-i.z*e.y-r.z*e.z),Rn.set(o[6],t.x-n.x*e.x+i.x*e.y-r.x*e.z,t.y-n.y*e.x+i.y*e.y-r.y*e.z,t.z-n.z*e.x+i.z*e.y-r.z*e.z),Rn.set(o[7],t.x-n.x*e.x-i.x*e.y+r.x*e.z,t.y-n.y*e.x-i.y*e.y+r.y*e.z,t.z-n.z*e.x-i.z*e.y+r.z*e.z)}function Va(t,e){for(var n=Rn.dot(e,t[0]),i=n,r=1;r<8;++r){var o=Rn.dot(e,t[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Wa,ja,qa,Xa=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new Rn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Rn(0,0,0),i[r]=new Rn(0,0,0);var o=new Rn,a=new Rn;return function(e,r){Rn.set(t[0],1,0,0),Rn.set(t[1],0,1,0),Rn.set(t[2],0,0,1),Rn.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Rn.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Rn.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)Rn.cross(t[6+3*s],t[s],t[3]),Rn.cross(t[7+3*s],t[s],t[4]),Rn.cross(t[7+3*s],t[s],t[5]);Rn.subtract(o,e.center,e.halfExtents),Rn.add(a,e.center,e.halfExtents),function(t,e,n){Rn.set(n[0],t.x,e.y,e.z),Rn.set(n[1],t.x,e.y,t.z),Rn.set(n[2],t.x,t.y,e.z),Rn.set(n[3],t.x,t.y,t.z),Rn.set(n[4],e.x,e.y,e.z),Rn.set(n[5],e.x,e.y,t.z),Rn.set(n[6],e.x,t.y,e.z),Rn.set(n[7],e.x,t.y,t.z)}(o,a,n),Ha(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var c=0;c<15;++c){var l=Va(n,t[c]),u=Va(i,t[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Ya=function(t,e){var n=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),i=Rn.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1},Ka=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Ya(t,e.planes[n]))return 0;return 1},Qa=function(){for(var t=new Array(8),e=0,n=0,i=0;i<t.length;i++)t[i]=new Rn(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Ya(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)Rn.subtract(t[c],r.vertices[c],i.center);e=0,n=0;for(var l=0;l<r.vertices.length;l++)t[l].x>i.halfExtents.x?e++:t[l].x<-i.halfExtents.x&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var u=0;u<r.vertices.length;u++)t[u].y>i.halfExtents.y?e++:t[u].y<-i.halfExtents.y&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var h=0;h<r.vertices.length;h++)t[h].z>i.halfExtents.z?e++:t[h].z<-i.halfExtents.z&&n++;return e===r.vertices.length||n===r.vertices.length?0:1}}(),Za=(Wa=new Rn(0,0,0),ja=new Dn,function(t,e){return Rn.subtract(Wa,e,t.center),Rn.transformMat3(Wa,Wa,Dn.transpose(ja,t.orientation)),n=Wa,i=t.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Ja=(qa=function(t,e,n,i){return Math.abs(t.x*e+t.y*n+t.z*i)},function(t,e){var n=t.halfExtents.x*qa(e.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.halfExtents.y*qa(e.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.halfExtents.z*qa(e.n,t.orientation.m06,t.orientation.m07,t.orientation.m08),i=Rn.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1}),$a=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Ja(t,e.planes[n]))return 0;return 1},ts=function(){for(var t=new Array(8),e=0,n=0,i=0,r=0;r<t.length;r++)t[r]=new Rn(0,0,0);var o=function(t,e,n,i){return t.x*e+t.y*n+t.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Ja(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)Rn.subtract(t[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(e=o(t[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:e<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(e=o(t[f],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:e<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var p=0;p<a.vertices.length;p++)(e=o(t[p],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:e<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),es=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new Rn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Rn(0,0,0),i[r]=new Rn(0,0,0);return function(e,r){Rn.set(t[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),Rn.set(t[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),Rn.set(t[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),Rn.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Rn.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Rn.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)Rn.cross(t[6+3*o],t[o],t[3]),Rn.cross(t[7+3*o],t[o],t[4]),Rn.cross(t[8+3*o],t[o],t[5]);Ha(e.center,e.halfExtents,t[0],t[1],t[2],n),Ha(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var a=0;a<15;++a){var s=Va(n,t[a]),c=Va(i,t[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),ns=function(){for(var t=new sa,e=new Rn,n=new Rn,i=new Rn,r=new Array(8),o=0;o<8;o++)r[o]=new Rn;for(var a=new Array(8),s=0;s<8;s++)a[s]=new Rn;return function(o,s){if(0===Rn.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return t.radius=s.radius,t.center.set(s.ellipseCenter0),hs.sphereOBB(t,o);e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Ha(o.center,o.halfExtents,e,n,i,r);var c=a,l=Rn.copy(c[0],e),u=Rn.copy(c[1],n),h=Rn.copy(c[2],i);Rn.subtract(c[3],s.center,o.center).normalize();var f=Rn.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);f.normalize(),Rn.cross(c[5],l,f),Rn.cross(c[6],u,f),Rn.cross(c[7],h,f);for(var p=0;p<8;++p){var d=Va(r,c[p]),_=Rn.dot(c[p],s.ellipseCenter0),m=Rn.dot(c[p],s.ellipseCenter1),v=Math.max(_,m),g=Math.min(_,m)-s.radius,y=v+s.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),is=function(t,e){var n=Rn.dot(e.n,t.center),i=t.radius*e.n.length();return n+i<e.d?-1:n-i>e.d?0:1},rs=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===is(t,e.planes[n]))return 0;return 1},os=function(){var t=new Rn(0,0,0),e=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=Rn.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){Rn.add(t,s,Rn.multiplyScalar(t,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+e[r]){var f=i.planes[h];if(Rn.dot(f.n,t)<f.d)return 0}}}return 1}}(),as=function(t,e){var n=t.radius+e.radius;return Rn.squaredDistance(t.center,e.center)<n*n},ss=function(){var t=new Rn;return function(e,n){return Ko(t,e.center,n),Rn.squaredDistance(e.center,t)<e.radius*e.radius}}(),cs=function(){var t=new Rn;return function(e,n){return Qo(t,e.center,n),Rn.squaredDistance(e.center,t)<e.radius*e.radius}}(),ls=function(){var t=new Rn,e=new Rn;return function(n,i){var r=n.radius+i.radius,o=r*r,a=Rn.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return Rn.squaredDistance(n.center,i.center)<o;Rn.subtract(t,n.center,i.ellipseCenter0),Rn.subtract(e,i.ellipseCenter1,i.ellipseCenter0);var s=Rn.dot(t,e)/a;return s<0?Rn.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?Rn.squaredDistance(n.center,i.ellipseCenter1)<o:(Rn.scaleAndAdd(t,i.ellipseCenter0,e,s),Rn.squaredDistance(n.center,t)<o)}}(),us=function(){var t=new Rn,e=new Rn,n=new Rn,i=new Rn,r=new Rn,o=new Rn;return function(a,s){var c,l,u=Rn.subtract(t,a.ellipseCenter1,a.ellipseCenter0),h=Rn.subtract(e,s.ellipseCenter1,s.ellipseCenter0),f=Rn.subtract(n,a.ellipseCenter0,s.ellipseCenter0),p=Rn.dot(u,u),d=Rn.dot(u,h),_=Rn.dot(h,h),m=Rn.dot(u,f),v=Rn.dot(h,f),g=p*_-d*d,y=g,x=g;g<rn?(c=0,y=1,l=v,x=_):(l=p*v-d*m,(c=d*v-_*m)<0?(c=0,l=v,x=_):c>y&&(c=y,l=v+d,x=_)),l<0?(l=0,-m<0?c=0:-m>p?c=y:(c=-m,y=p)):l>x&&(l=x,-m+d<0?c=0:-m+d>p?c=y:(c=-m+d,y=p));var S=Math.abs(c)<rn?0:c/y,T=Math.abs(l)<rn?0:l/x,E=i;E.set(f),E.add(Rn.multiplyScalar(r,u,S)),E.subtract(Rn.multiplyScalar(o,h,T));var b=a.radius+s.radius;return E.lengthSqr()<b*b}}(),hs={raySphere:ya,rayAABB:xa,rayOBB:Aa,rayPlane:va,rayTriangle:ga,rayCapsule:wa,raySubMesh:Ra,rayMesh:Pa,rayModel:Ia,lineSphere:Ba,lineAABB:Na,lineOBB:La,linePlane:Ma,lineTriangle:Da,sphereWithSphere:as,sphereAABB:ss,sphereOBB:cs,spherePlane:is,sphereFrustum:rs,sphereFrustumAccurate:os,sphereCapsule:ls,aabbWithAABB:Ga,aabbWithOBB:Xa,aabbPlane:Ya,aabbFrustum:Ka,aabbFrustumAccurate:Qa,obbWithOBB:es,obbPlane:Ja,obbFrustum:$a,obbFrustumAccurate:ts,obbPoint:Za,obbCapsule:ns,capsuleWithCapsule:us,resolve:function(t,e,n){void 0===n&&(n=null);var i=t._type,r=e._type,o=this[i|r];return i<r?o(t,e,n):o(e,t,n)}};hs[Jo.SHAPE_RAY|Jo.SHAPE_SPHERE]=ya,hs[Jo.SHAPE_RAY|Jo.SHAPE_AABB]=xa,hs[Jo.SHAPE_RAY|Jo.SHAPE_OBB]=Aa,hs[Jo.SHAPE_RAY|Jo.SHAPE_PLANE]=va,hs[Jo.SHAPE_RAY|Jo.SHAPE_TRIANGLE]=ga,hs[Jo.SHAPE_RAY|Jo.SHAPE_CAPSULE]=wa,hs[Jo.SHAPE_LINE|Jo.SHAPE_SPHERE]=Ba,hs[Jo.SHAPE_LINE|Jo.SHAPE_AABB]=Na,hs[Jo.SHAPE_LINE|Jo.SHAPE_OBB]=La,hs[Jo.SHAPE_LINE|Jo.SHAPE_PLANE]=Ma,hs[Jo.SHAPE_LINE|Jo.SHAPE_TRIANGLE]=Da,hs[Jo.SHAPE_SPHERE]=as,hs[Jo.SHAPE_SPHERE|Jo.SHAPE_AABB]=ss,hs[Jo.SHAPE_SPHERE|Jo.SHAPE_OBB]=cs,hs[Jo.SHAPE_SPHERE|Jo.SHAPE_PLANE]=is,hs[Jo.SHAPE_SPHERE|Jo.SHAPE_FRUSTUM]=rs,hs[Jo.SHAPE_SPHERE|Jo.SHAPE_FRUSTUM_ACCURATE]=os,hs[Jo.SHAPE_SPHERE|Jo.SHAPE_CAPSULE]=ls,hs[Jo.SHAPE_AABB]=Ga,hs[Jo.SHAPE_AABB|Jo.SHAPE_OBB]=Xa,hs[Jo.SHAPE_AABB|Jo.SHAPE_PLANE]=Ya,hs[Jo.SHAPE_AABB|Jo.SHAPE_FRUSTUM]=Ka,hs[Jo.SHAPE_AABB|Jo.SHAPE_FRUSTUM_ACCURATE]=Qa,hs[Jo.SHAPE_OBB]=es,hs[Jo.SHAPE_OBB|Jo.SHAPE_PLANE]=Ja,hs[Jo.SHAPE_OBB|Jo.SHAPE_FRUSTUM]=$a,hs[Jo.SHAPE_OBB|Jo.SHAPE_FRUSTUM_ACCURATE]=ts,hs[Jo.SHAPE_OBB|Jo.SHAPE_CAPSULE]=ns,hs[Jo.SHAPE_CAPSULE]=us,U($o.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),G(hs,"intersect",[{name:"line_quad"}]);var fs,ps,ds,_s,ms,vs,gs,ys=new Rn(0,0,0),xs=new Rn(0,0,0),Ss=u.mat4(),Ts=u.v4(),Es=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Jo.SHAPE_PLANE,this.n=new Rn(t,e,n),this.d=i}return t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.n.x,e.n.y,e.n.z,e.d)},t.copy=function(t,e){return Rn.copy(t.n,e.n),t.d=e.d,t},t.fromPoints=function(t,e,n,i){return Rn.subtract(ys,n,e),Rn.subtract(xs,i,e),Rn.normalize(t.n,Rn.cross(t.n,ys,xs)),t.d=Rn.dot(t.n,e),t},t.set=function(t,e,n,i,r){return t.n.x=e,t.n.y=n,t.n.z=i,t.d=r,t},t.fromNormalAndPoint=function(t,e,n){return Rn.copy(t.n,e),t.d=Rn.dot(e,n),t},t.normalize=function(t,e){var n=e.n.length();return Rn.normalize(t.n,e.n),n>0&&(t.d=e.d/n),t},t.prototype.transform=function(t){Vn.invert(Ss,t),Vn.transpose(Ss,Ss),Zn.set(Ts,this.n.x,this.n.y,this.n.z,this.d),Zn.transformMat4(Ts,Ts,Ss),Rn.set(this.n,Ts.x,Ts.y,Ts.z),this.d=Ts.w},Z(t,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(t){this.n.x=t}},{key:"y",get:function(){return this.n.y},set:function(t){this.n.y=t}},{key:"z",get:function(){return this.n.z},set:function(t){this.n.z=t}},{key:"w",get:function(){return this.d},set:function(t){this.d=t}}]),t}(),bs=function(){function t(t,e,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<e)}return t.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},t}();!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(gs||(gs={}));var Cs,As,ws=function(){function t(t,e,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=e,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new bs(t,r,this._stride);var o=gs.NEVER,a=!1,s=!1;for(var c in e){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=e[c],a||o!==gs.FLOAT32?s||o!==gs.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var e=t.prototype;return e.alloc=function(){for(var t=0;t<this._freeLists.length;t++){var e=this._freeLists[t];if(e.length){var n=e[e.length-1];return e.length--,(t<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(t<<this._entryBits)+this._poolFlag},e.getBuffer=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][n]},e.getTypedArray=function(t,e){var n=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t,r=e,o=(this._dataType[e]===gs.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[e];return o.subarray(r,r+a)},e.free=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][n].fill(0),this._freeLists[e].push(n)},t}();!function(t){t[t.NODE=0]="NODE",t[t.PASS=1]="PASS",t[t.AABB=2]="AABB"}(Cs||(Cs={})),function(t){t[t.DIRTY_FLAG=0]="DIRTY_FLAG",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.LOCAL_SCALE=28]="LOCAL_SCALE",t[t.LOCAL_POSITION=31]="LOCAL_POSITION",t[t.LOCAL_ROTATION=34]="LOCAL_ROTATION",t[t.COUNT=38]="COUNT"}(As||(As={}));var Rs,Ps=((fs={})[As.DIRTY_FLAG]=gs.UINT32,fs[As.LAYER]=gs.UINT32,fs[As.WORLD_SCALE]=gs.FLOAT32,fs[As.WORLD_POSITION]=gs.FLOAT32,fs[As.WORLD_ROTATION]=gs.FLOAT32,fs[As.WORLD_MATRIX]=gs.FLOAT32,fs[As.LOCAL_SCALE]=gs.FLOAT32,fs[As.LOCAL_POSITION]=gs.FLOAT32,fs[As.LOCAL_ROTATION]=gs.FLOAT32,fs[As.COUNT]=gs.NEVER,fs),Is=((ps={})[As.DIRTY_FLAG]=As.LAYER-As.DIRTY_FLAG,ps[As.LAYER]=As.WORLD_SCALE-As.LAYER,ps[As.WORLD_SCALE]=As.WORLD_POSITION-As.WORLD_SCALE,ps[As.WORLD_POSITION]=As.WORLD_ROTATION-As.WORLD_POSITION,ps[As.WORLD_ROTATION]=As.WORLD_MATRIX-As.WORLD_ROTATION,ps[As.WORLD_MATRIX]=As.LOCAL_SCALE-As.WORLD_MATRIX,ps[As.LOCAL_SCALE]=As.LOCAL_POSITION-As.LOCAL_SCALE,ps[As.LOCAL_POSITION]=As.LOCAL_ROTATION-As.LOCAL_POSITION,ps[As.LOCAL_ROTATION]=As.COUNT-As.LOCAL_ROTATION,ps[As.COUNT]=1,ps),Ms=new ws(Cs.NODE,Ps,Is,As);!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.PRIMITIVE=3]="PRIMITIVE",t[t.BATCHING_SCHEME=4]="BATCHING_SCHEME",t[t.DYNAMIC_STATE=5]="DYNAMIC_STATE",t[t.HASH=6]="HASH",t[t.COUNT=7]="COUNT"}(Rs||(Rs={}));var Ds,Os=((ds={})[Rs.PRIORITY]=gs.UINT32,ds[Rs.STAGE]=gs.UINT32,ds[Rs.PHASE]=gs.UINT32,ds[Rs.PRIMITIVE]=gs.UINT32,ds[Rs.BATCHING_SCHEME]=gs.UINT32,ds[Rs.DYNAMIC_STATE]=gs.UINT32,ds[Rs.HASH]=gs.UINT32,ds[Rs.COUNT]=gs.NEVER,ds),Ns=((_s={})[Rs.PRIORITY]=Rs.STAGE-Rs.PRIORITY,_s[Rs.STAGE]=Rs.PHASE-Rs.STAGE,_s[Rs.PHASE]=Rs.PRIMITIVE-Rs.PHASE,_s[Rs.PRIMITIVE]=Rs.BATCHING_SCHEME-Rs.PRIMITIVE,_s[Rs.BATCHING_SCHEME]=Rs.DYNAMIC_STATE-Rs.BATCHING_SCHEME,_s[Rs.DYNAMIC_STATE]=Rs.HASH-Rs.DYNAMIC_STATE,_s[Rs.HASH]=Rs.COUNT-Rs.HASH,_s[Rs.COUNT]=1,_s),Ls=new ws(Cs.PASS,Os,Ns,Rs);!function(t){t[t.CENTER=0]="CENTER",t[t.HALFEXTENTS=3]="HALFEXTENTS",t[t.COUNT=6]="COUNT"}(Ds||(Ds={}));var Bs=((ms={})[Ds.CENTER]=gs.FLOAT32,ms[Ds.HALFEXTENTS]=gs.FLOAT32,ms[Ds.COUNT]=gs.NEVER,ms),Fs=((vs={})[Ds.CENTER]=Ds.HALFEXTENTS-Ds.CENTER,vs[Ds.HALFEXTENTS]=Ds.COUNT-Ds.HALFEXTENTS,vs[Ds.COUNT]=1,vs),zs=new ws(Cs.AABB,Bs,Fs,Ds),ks=new Rn,Us=new Rn,Gs=new Rn,Hs=new Rn,Vs=new Dn,Ws=function(t,e,n){Vs.m00=Math.abs(n.m00),Vs.m01=Math.abs(n.m01),Vs.m02=Math.abs(n.m02),Vs.m03=Math.abs(n.m04),Vs.m04=Math.abs(n.m05),Vs.m05=Math.abs(n.m06),Vs.m06=Math.abs(n.m08),Vs.m07=Math.abs(n.m09),Vs.m08=Math.abs(n.m10),Rn.transformMat3(t,e,Vs)},js=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=Jo.SHAPE_AABB,this.center=new Rn(t,e,n),this.halfExtents=new Rn(i,r,o)}t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)},t.copy=function(t,e){return Rn.copy(t.center,e.center),Rn.copy(t.halfExtents,e.halfExtents),t},t.fromPoints=function(t,e,n){return Rn.add(ks,n,e),Rn.subtract(Us,n,e),Rn.multiplyScalar(t.center,ks,.5),Rn.multiplyScalar(t.halfExtents,Us,.5),t},t.set=function(t,e,n,i,r,o,a){return t.center.set(e,n,i),t.halfExtents.set(r,o,a),t},t.merge=function(e,n,i){return Rn.subtract(ks,n.center,n.halfExtents),Rn.subtract(Us,i.center,i.halfExtents),Rn.add(Gs,n.center,n.halfExtents),Rn.add(Hs,i.center,i.halfExtents),Rn.max(Hs,Gs,Hs),Rn.min(Gs,ks,Us),t.fromPoints(e,Gs,Hs)},t.toBoundingSphere=function(t,e){return t.center.set(e.center),t.radius=e.halfExtents.length(),t},t.transform=function(t,e,n){return Rn.transformMat4(t.center,e.center,n),Ws(t.halfExtents,e.halfExtents,n),t};var e=t.prototype;return e.getBoundary=function(t,e){Rn.subtract(t,this.center,this.halfExtents),Rn.add(e,this.center,this.halfExtents)},e.transform=function(t,e,n,i,r){Rn.transformMat4(r.center,this.center,t),Ws(r.halfExtents,this.halfExtents,t)},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.mergePoint=function(t){this.getBoundary(ks,Us),t.x<ks.x&&(ks.x=t.x),t.y<ks.y&&(ks.y=t.y),t.z<ks.z&&(ks.z=t.z),t.x>Us.x&&(Us.x=t.x),t.y>Us.y&&(Us.y=t.y),t.z>Us.z&&(Us.z=t.z),Rn.add(Gs,ks,Us),this.center.set(Rn.multiplyScalar(Gs,Gs,.5)),this.halfExtents.set(Us.x-Gs.x,Us.y-Gs.y,Us.z-Gs.z)},e.mergePoints=function(t){if(!(t.length<1))for(var e=0;e<t.length;e++)this.mergePoint(t[e])},e.mergeFrustum=function(t){return this.mergePoints(t.vertices)},Z(t,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),t}(),qs=new Rn,Xs=new Rn,Ys=new Dn,Ks=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,f,p,d){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Jo.SHAPE_OBB,this.center=new Rn(t,e,n),this.halfExtents=new Rn(i,r,o),this.orientation=new Dn(a,s,c,l,u,h,f,p,d)}t.create=function(e,n,i,r,o,a,s,c,l,u,h,f,p,d,_){return new t(e,n,i,r,o,a,s,c,l,u,h,f,p,d,_)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)},t.copy=function(t,e){return Rn.copy(t.center,e.center),Rn.copy(t.halfExtents,e.halfExtents),Dn.copy(t.orientation,e.orientation),t},t.fromPoints=function(t,e,n){return Rn.multiplyScalar(t.center,Rn.add(qs,e,n),.5),Rn.multiplyScalar(t.halfExtents,Rn.subtract(Xs,n,e),.5),Dn.identity(t.orientation),t},t.set=function(t,e,n,i,r,o,a,s,c,l,u,h,f,p,d,_){return Rn.set(t.center,e,n,i),Rn.set(t.halfExtents,r,o,a),Dn.set(t.orientation,s,c,l,u,h,f,p,d,_),t};var e=t.prototype;return e.getBoundary=function(t,e){!function(t,e,n){Ys.m00=Math.abs(n.m00),Ys.m01=Math.abs(n.m01),Ys.m02=Math.abs(n.m02),Ys.m03=Math.abs(n.m03),Ys.m04=Math.abs(n.m04),Ys.m05=Math.abs(n.m05),Ys.m06=Math.abs(n.m06),Ys.m07=Math.abs(n.m07),Ys.m08=Math.abs(n.m08),Rn.transformMat3(t,e,Ys)}(qs,this.halfExtents,this.orientation),Rn.subtract(t,this.center,qs),Rn.add(e,this.center,qs)},e.transform=function(t,e,n,i,r){Rn.transformMat4(r.center,this.center,t),Dn.fromQuat(r.orientation,n),Rn.multiply(r.halfExtents,this.halfExtents,i)},e.translateAndRotate=function(t,e,n){Rn.transformMat4(n.center,this.center,t),Dn.fromQuat(n.orientation,e)},e.setScale=function(t,e){Rn.multiply(e.halfExtents,this.halfExtents,t)},Z(t,[{key:"type",get:function(){return this._type}}]),t}(),Qs=function(){function t(t,e,n){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Jo.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=n,this.center=new Rn,this.rotation=new Ln,this.ellipseCenter0=new Rn(0,e,0),this.ellipseCenter1=new Rn(0,-e,0),this.updateCache()}var e=t.prototype;return e.transform=function(t,e,n,i,r){var o=i,a=Tn(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,Rn.transformMat4(r.center,this.center,t),Ln.multiply(r.rotation,this.rotation,n),r.updateCache()},e.updateCache=function(){this.updateLocalCenter(),Rn.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Rn.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},e.updateLocalCenter=function(){var t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}},Z(t,[{key:"type",get:function(){return this._type}}]),t}(),Zs=new Array(8);Zs[0]=new Rn(1,1,1),Zs[1]=new Rn(-1,1,1),Zs[2]=new Rn(-1,-1,1),Zs[3]=new Rn(1,-1,1),Zs[4]=new Rn(1,1,-1),Zs[5]=new Rn(-1,1,-1),Zs[6]=new Rn(-1,-1,-1),Zs[7]=new Rn(1,-1,-1);var Js,$s,tc=new Rn,ec=new Rn,nc=new Rn,ic=function(){function t(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Jo.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=Es.create(0,0,0,0);this.vertices=new Array(8);for(var e=0;e<8;++e)this.vertices[e]=new Rn}t.createFromAABB=function(t,e){var n=new Rn,i=new Rn;return Rn.subtract(n,e.center,e.halfExtents),Rn.add(i,e.center,e.halfExtents),t.vertices[0].set(n.x,i.y,n.z),t.vertices[1].set(i.x,i.y,n.z),t.vertices[2].set(i.x,n.y,n.z),t.vertices[3].set(n.x,n.y,n.z),t.vertices[4].set(n.x,i.y,i.z),t.vertices[5].set(i.x,i.y,i.z),t.vertices[6].set(i.x,n.y,i.z),t.vertices[7].set(n.x,n.y,i.z),t._type!==Jo.SHAPE_FRUSTUM_ACCURATE||t.updatePlanes(),t},t.split=function(t,e,n,i,r){var o=Math.tan(.5*e.fov),a=o*e.aspect;tc.set(i*a,i*o,i),ec.set(r*a,r*o,r);var s=t.vertices;return nc.set(tc.x,tc.y,tc.z),Rn.transformMat4(s[0],nc,n),nc.set(-tc.x,tc.y,tc.z),Rn.transformMat4(s[1],nc,n),nc.set(-tc.x,-tc.y,tc.z),Rn.transformMat4(s[2],nc,n),nc.set(tc.x,-tc.y,tc.z),Rn.transformMat4(s[3],nc,n),nc.set(ec.x,ec.y,ec.z),Rn.transformMat4(s[4],nc,n),nc.set(-ec.x,ec.y,ec.z),Rn.transformMat4(s[5],nc,n),nc.set(-ec.x,-ec.y,ec.z),Rn.transformMat4(s[6],nc,n),nc.set(ec.x,-ec.y,ec.z),Rn.transformMat4(s[7],nc,n),t.updatePlanes(),t},t.create=function(){return new t},t.clone=function(e){return t.copy(new t,e)},t.copy=function(t,e){t._type=e._type;for(var n=0;n<6;++n)Es.copy(t.planes[n],e.planes[n]);for(var i=0;i<8;++i)Rn.copy(t.vertices[i],e.vertices[i]);return t};var e=t.prototype;return e.update=function(t,e){if(Rn.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),Rn.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),Rn.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),Rn.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),Rn.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),Rn.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===Jo.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();Rn.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)Rn.transformMat4(this.vertices[o],Zs[o],e)}},e.transform=function(t){if(this._type===Jo.SHAPE_FRUSTUM_ACCURATE){for(var e=0;e<8;e++)Rn.transformMat4(this.vertices[e],this.vertices[e],t);Es.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Es.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Es.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Es.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Es.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Es.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},e.updatePlanes=function(){Es.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Es.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Es.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Es.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Es.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Es.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},Z(t,[{key:"accurate",set:function(t){this._type=t?Jo.SHAPE_FRUSTUM_ACCURATE:Jo.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),t}();ic.createOrtho=function(t,e,n,i,r,o){var a=e/2,s=n/2;Rn.set(nc,a,s,-i),Rn.transformMat4(t.vertices[0],nc,o),Rn.set(nc,-a,s,-i),Rn.transformMat4(t.vertices[1],nc,o),Rn.set(nc,-a,-s,-i),Rn.transformMat4(t.vertices[2],nc,o),Rn.set(nc,a,-s,-i),Rn.transformMat4(t.vertices[3],nc,o),Rn.set(nc,a,s,-r),Rn.transformMat4(t.vertices[4],nc,o),Rn.set(nc,-a,s,-r),Rn.transformMat4(t.vertices[5],nc,o),Rn.set(nc,-a,-s,-r),Rn.transformMat4(t.vertices[6],nc,o),Rn.set(nc,a,-s,-r),Rn.transformMat4(t.vertices[7],nc,o),Es.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),Es.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),Es.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),Es.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),Es.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),Es.fromPoints(t.planes[5],t.vertices[7],t.vertices[5],t.vertices[6])},function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(Js||(Js={})),function(t){t[t.Default=Js.Default]="Default",t[t.Normal=Js.Normal]="Normal",t[t.Reverse=Js.Reverse]="Reverse",t[t.Loop=Js.Loop]="Loop",t[t.LoopReverse=Js.Loop|Js.Reverse]="LoopReverse",t[t.PingPong=Js.PingPong]="PingPong",t[t.PingPongReverse=Js.PingPong|Js.Reverse]="PingPongReverse"}($s||($s={})),ce($s);var rc=function(){function t(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return t.prototype.set=function(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex},t}();function oc(t,e,n){void 0===n&&(n=1e-6);for(var i=0,r=t.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=t[o];if(a>e+n)r=o-1;else{if(!(a<e-n))return o;i=o+1}}return~i}var ac=function(){},sc=function(){return ac},cc=lc((function(){}));function lc(t){return function(e){return"function"==typeof e?t(e):function(n){return t(n,e)}}}function uc(t){return function(e){return function(n){!function(t,e,n){var i=fc(t);if(i){var r=pc(i,"proto");pc(r,"editor")[e]=n}}(n,t,e)}}}var hc="__ccclassCache__";function fc(t){return pc(t,hc)}function pc(t,e){return t[e]||(t[e]={})}var dc=lc((function(t,e){var n=ie.getSuper(t);n===Object&&(n=null);var i={name:e,extends:n,ctor:t},r=t[hc];if(r){var o=r.proto;o&&ie.mixin(i,o),t[hc]=void 0}return Je(i)})),_c=uc("requireComponent"),mc=uc("executionOrder"),vc=cc;function gc(t,e,n){var i=null;function r(t,e,n){var r=fc(t.constructor);if(r){var o=pc(r,"proto"),a=pc(o,"properties");!function(t,e,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=He(i,s));var c=e[n],l=ie.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(t){var e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(r.initializer));else{var u=o.default||(o.default=function(t){var e;try{e=new t}catch(t){return{}}return e}(t));u.hasOwnProperty(n)&&(l.default=u[n])}e[n]=l}(t.constructor,a,e,i,n,r)}}return void 0===t?gc({type:void 0}):void 0===e?(i=t,r):void r(t,e,n)}var yc=Symbol("cc:SerializationMetadata"),xc=function(t,e,n){return gc(Ec({}))(t,e,n)};function Sc(t){return gc(Ec({formerlySerializedAs:t}))}var Tc=function(t,e,n){return gc({editorOnly:!0})(t,e,n)};function Ec(t){return t.__noImplicit=!0,"serializable"in t||(t.serializable=!0),t}var bc=ac,Cc=cc,Ac=sc,wc=cc,Rc=sc,Pc=sc,Ic=sc,Mc=ac,Dc=sc,Oc=ac,Nc=sc,Lc=sc,Bc=sc,Fc=sc,zc=sc,kc=sc,Uc=ac,Gc=sc,Hc=ac,Vc=ac,Wc=ac,jc=Kc(De),qc=Kc(Oe),Xc=Kc(Ne),Yc=Kc(Le);function Kc(t){return gc({type:t})}var Qc,Zc,Jc,$c,tl,el,nl,il,rl,ol=function(t,e,n){return gc({__noImplicit:!0,override:!0})(t,e,n)},al=dc("cc.KeyframeCurve")((Qc=Symbol.iterator,el=function(){function t(){ct(this,"_times",$c,this),ct(this,"_values",tl,this)}var e=t.prototype;return e[Qc]=function(){var t=this,e=0;return{next:function(){if(e>=t._times.length)return{done:!0,value:void 0};var n=[t._times[e],t._values[e]];return++e,{done:!1,value:n}}}},e.keyframes=function(){return this},e.times=function(){return this._times},e.values=function(){return this._values},e.getKeyframeTime=function(t){return this._times[t]},e.getKeyframeValue=function(t){return this._values[t]},e.addKeyFrame=function(t,e){return this._insertNewKeyframe(t,e)},e.removeKeyframe=function(t){this._times.splice(t,1),this._values.splice(t,1)},e.indexOfKeyframe=function(t){return oc(this._times,t)},e.updateTime=function(t,e){var n=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,n)},e.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return t[1]})))}},e.clear=function(){this._times.length=0,this._values.length=0},e.searchKeyframe=function(t){return oc(this._times,t)},e.setKeyframes=function(t,e){t.length,e.length,function(t){t.every((function(t,e,n){return 0===e||t>n[e-1]||an(t,n[e-1],1e-6)}))}(t),this._times=t,this._values=e},e._insertNewKeyframe=function(t,e){var n=this._times,i=this._values,r=n.length,o=oc(n,t);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(t),i.unshift(e)):a===r?(n.push(t),i.push(e)):(n.splice(a-1,0,t),i.splice(a-1,0,e)),a},Z(t,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),t}(),$c=lt((Jc=el).prototype,"_times",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tl=lt(Jc.prototype,"_values",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zc=Jc))||Zc;function sl(t){return t>-1e-9&&t<1e-9}!function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.CUBIC=2]="CUBIC"}(nl||(nl=t("RealInterpolationMode",{}))),function(t){t[t.LINEAR=0]="LINEAR",t[t.CLAMP=1]="CLAMP",t[t.LOOP=2]="LOOP",t[t.PING_PONG=3]="PING_PONG"}(il||(il=t("ExtrapolationMode",{}))),function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTH=3]="BOTH"}(rl||(rl=t("TangentWeightMode",{})));var cl,ll=t("editorExtrasTag","__editorExtras__"),ul=function(){},hl=Object.freeze({__proto__:null,uniquelyReferenced:bc,ccclass:dc,property:gc,requireComponent:_c,executionOrder:mc,disallowMultiple:vc,allowReplicated:function(t){Je.Attr.setClassAttr(t,"replicated","visible",!0)},executeInEditMode:Cc,menu:Ac,playOnFocus:wc,inspector:Rc,icon:Pc,help:Ic,type:Kc,integer:jc,float:qc,boolean:Xc,string:Yc});t("_decorator",hl);var fl=1<<22,pl=[],dl=t("CCObject",function(){function t(t){void 0===t&&(t=""),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}t._deferredDestroy=function(){for(var t=pl.length,e=0;e<t;++e){var n=pl[e];1&n._objFlags||n._destroyImmediate()}t===pl.length?pl.length=0:pl.splice(0,t)};var e=t.prototype;return e.destroy=function(){return 1&this._objFlags?(M(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,pl.push(this),0))},e._destruct=function(){var t=this.constructor,e=t.__destruct__;e||(e=function(t,e){var n,i=t instanceof u._BaseNode||t instanceof u.Component,r=i?"_id":null,o={};for(n in t)if(t.hasOwnProperty(n)){if(n===r)continue;switch(typeof t[n]){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(Je._isCCClass(e))for(var a=u.Class.Attr.getClassAttrs(e),s=e.__props__,c=0;c<s.length;c++){var l=(n=s[c])+u.Class.Attr.DELIMETER+"default";if(l in a){if(i&&"_id"===n)continue;switch(typeof a[l]){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var h="";for(n in o){var f;f=Je.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Je.escapeForJS(n)+"]=";var p=o[n];""===p&&(p='""'),h+=f+p+";\n"}return Function("o",h)}(this,t),bt(t,"__destruct__",e,!0)),e(this)},e._destroyImmediate=function(){1&this._objFlags?O(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},Z(t,[{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"hideFlags",get:function(){return this._objFlags&t.Flags.AllHideMasks},set:function(e){var n=e&t.Flags.AllHideMasks;this._objFlags=this._objFlags&~t.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&fl)},set:function(t){t?this._objFlags|=fl:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}()),_l=dl.prototype;function ml(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}_l._deserialize=null,_l._onPreDestroy=null,Je.fastDefine("cc.Object",dl,((cl={_name:"",_objFlags:0})[ll]={},cl)),Je.Attr.setClassAttr(dl,ll,"editorOnly",!0),Je.Attr.setClassAttr(dl,"replicated","visible",!1),bt(dl,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),u.isValid=ml,u.Object=dl;var vl=function(){function t(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=ie.createMap(!0),this._count=0)}var e=t.prototype;return e.add=function(t,e){return t in this._map||this._count++,this._map[t]=e},e.get=function(t){return this._map[t]},e.has=function(t){return t in this._map},e.remove=function(t){var e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e},e.clear=function(){0!==this._count&&(this._map=ie.createMap(!0),this._count=0)},e.forEach=function(t){for(var e in this._map)t(this._map[e],e)},e.find=function(t){for(var e in this._map)if(t(this._map[e],e))return this._map[e];return null},e.destroy=function(){this._map=null},Z(t,[{key:"count",get:function(){return this._count}}]),t}(),gl=function(){function t(e,n){this.id=t._pipelineId++,this.name="",this.pipes=[],this.name=e;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var e=t.prototype;return e.insert=function(t,e){return e>this.pipes.length?(M(4921),this):(this.pipes.splice(e,0,t),this)},e.append=function(t){return this.pipes.push(t),this},e.remove=function(t){return this.pipes.splice(t,1),this},e.sync=function(t){var e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(var n=0,i=e.length;n<i;){var r=(0,e[n])(t);if(r)return t.isFinish=!0,r;++n!==i&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output},e.async=function(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))},e._flow=function(t,e){var n=this;(0,this.pipes[t])(e,(function(i){i?(e.isFinish=!0,e.dispatch("complete",i)):++t<n.pipes.length?(e.input=e.output,e.output=null,n._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",i,e.output))}))},t}();gl._pipelineId=0,function(){function t(t){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(t)for(var e in t)this._weakMap[e]=new WeakRef(t[e])}var e=t.prototype;e.add=function(t,e){return this._weakMap[t]=new WeakRef(e),e},e.has=function(t){return t in this._weakMap&&!!this._weakMap[t].deref()},e.get=function(t){return this._weakMap[t]&&this._weakMap[t].deref()},e.remove=function(t){var e=this._weakMap[t];return delete this._weakMap[t],e&&e.deref()},e.clear=function(){this._weakMap=ie.createMap(!0)},e.forEach=function(t){for(var e in this._weakMap){var n=this.get(e);n&&t(n,e)}},e.find=function(t){for(var e in this._weakMap){var n=this.get(e);if(n&&t(n,e))return this._weakMap[e].deref()}return null},e.destroy=function(){this._weakMap={}},Z(t,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(t){return t.deref()})).length}}])}();var yl,xl=new vl,Sl=new vl,Tl=new vl,El=new vl,bl=new gl("normal load",[]),Cl=new gl("fetch",[]),Al=new gl("transform url",[]);!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(yl||(yl={}));var wl,Rl={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(wl||(wl={}));var Pl=function(){function t(e){this.id=t._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(e)}t.create=function(e){var n;return 0!==t._deadPool.length?(n=t._deadPool.pop()).set(e):n=new t(e),n};var e=t.prototype;return e.set=function(t){void 0===t&&(t=Object.create(null)),this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)},e.dispatch=function(t,e,n,i,r){switch(t){case"complete":this.onComplete&&this.onComplete(e,n);break;case"progress":this.onProgress&&this.onProgress(e,n,i,r);break;case"error":this.onError&&this.onError(e,n,i,r);break;default:var o="on"+t[0].toUpperCase()+t.substr(1);"function"==typeof this[o]&&this[o](e,n,i,r)}},e.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,t._deadPool.push(this))},t}();Pl.MAX_DEAD_NUM=500,Pl._taskId=0,Pl._deadPool=[];var Il="0123456789abcdef".split(""),Ml=["","","",""],Dl=Ml.concat(Ml,"-",Ml,"-",Ml,"-",Ml,"-",Ml,Ml,Ml),Ol=Dl.map((function(t,e){return"-"===t?NaN:e})).filter(isFinite);function Nl(t){var e=t.split("@")[0];if(22!==e.length)return t;Dl[0]=t[0],Dl[1]=t[1];for(var n=2,i=2;n<22;n+=2){var r=_e[t.charCodeAt(n)],o=_e[t.charCodeAt(n+1)];Dl[Ol[i++]]=Il[r>>2],Dl[Ol[i++]]=Il[(3&r)<<2|o>>4],Dl[Ol[i++]]=Il[15&o]}return t.replace(e,Dl.join(""))}var Ll=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Bl(t){var e=Ll.exec(t);return e?e[1]:""}function Fl(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;var n=El.find((function(e){return!!e.getAssetInfo(t)}));return n&&(e.bundle=n.name),Ul(t,e)}function zl(t){return!!t&&(t instanceof u.SceneAsset||t instanceof u.Scene)}function kl(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function Ul(t,e){var n=Pl.create({input:t,options:e}),i=[];try{for(var r,o=st(Al.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(t){for(var c,l=st(n.output);!(c=l()).done;)c.value.recycle();T(t.message,t.stack)}return n.recycle(),i.length>1?i:i[0]}var Gl=Object.freeze({__proto__:null,getUuidFromURL:Bl,getUrlWithUuid:Fl,isScene:zl,normalize:kl,transform:Ul,decodeUuid:Nl}),Hl=new(function(){function t(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var e=t.prototype;return e.addContainer=function(t){-1===t._poolHandle&&(t._poolHandle=this._pools.length,this._pools.push(t))},e.removeContainer=function(t){-1!==t._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=t._poolHandle,ie.array.fastRemoveAt(this._pools,t._poolHandle),t._poolHandle=-1)},e.tryShrink=function(){for(var t=0;t<this._pools.length;t++)this._pools[t].tryShrink()},e.update=function(t){this._lastShrinkPassed+=t,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},t}()),Vl=function(){function t(){this._poolHandle=-1,Hl.addContainer(this)}return t.prototype.destroy=function(){Hl.removeContainer(this)},t}(),Wl=t("Pool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=e,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(e());return r}$(e,t);var n=e.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var t=0;t<this._elementsPerBatch;t++)this._freepool[t]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(t){this._freepool[++this._nextAvail]=t},n.freeArray=function(t){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var t=this._nextAvail>>1;t<=this._nextAvail;t++)this._dtor(this._freepool[t]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var e=arguments.length>0?arguments[0]:null;e&&M(14100);var n=e||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,t.prototype.destroy.call(this)},e}(Vl)),jl=t("RecyclePool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=e,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=e();return r}$(e,t);var n=e.prototype;return n.reset=function(){this._count=0},n.resize=function(t){if(t>this._data.length)for(var e=this._data.length;e<t;++e)this._data[e]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,t.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var t=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var e=t;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=t}},n.removeAt=function(t){if(!(t>=this._count)){var e=this._count-1,n=this._data[t];this._data[t]=this._data[e],this._data[e]=n,this._count-=1}},Z(e,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}(Vl)),ql=t("CachedArray",function(t){function e(e,n){var i;return(i=t.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(e),i._initSize=e,i.length=0,i._compareFn=void 0!==n?n:function(t,e){return t-e},i}$(e,t);var n=e.prototype;return n.push=function(t){this.array[this.length++]=t},n.pop=function(){return this.array[--this.length]},n.get=function(t){return this.array[t]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,t.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(t){for(var e=0;e<t.length;++e)this.array[this.length++]=t[e]},n.fastRemove=function(t){if(!(t>=this.length||t<0)){var e=--this.length;this.array[t]=this.array[e]}},n.indexOf=function(t){for(var e=0,n=this.length;e<n;++e)if(this.array[e]===t)return e;return-1},e}(Vl));t("memop",Object.freeze({__proto__:null,Pool:Wl,RecyclePool:jl,CachedArray:ql}));var Xl=ne.fastRemoveAt;function Yl(){}var Kl=function(){function t(){this.callback=Yl,this.target=void 0,this.once=!1}var e=t.prototype;return e.set=function(t,e,n){this.callback=t||Yl,this.target=e,this.once=!!n},e.reset=function(){this.target=void 0,this.callback=Yl,this.once=!1},e.check=function(){return!(this.target instanceof dl&&!ml(this.target,!0))},t}(),Ql=new Wl((function(){return new Kl}),32),Zl=function(){function t(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var e=t.prototype;return e.removeByCallback=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.callback===t&&(n.reset(),Ql.free(n),Xl(this.callbackInfos,e),--e)}},e.removeByTarget=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.target===t&&(n.reset(),Ql.free(n),Xl(this.callbackInfos,e),--e)}},e.cancel=function(t){var e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:Xl(this.callbackInfos,t),Ql.free(e)),this.containCanceled=!0},e.cancelAll=function(){for(var t=0;t<this.callbackInfos.length;t++){var e=this.callbackInfos[t];e&&(e.reset(),Ql.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0},e.purgeCanceled=function(){for(var t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||Xl(this.callbackInfos,t);this.containCanceled=!1},e.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},t}(),Jl=new Wl((function(){return new Zl}),16),$l=function(){function t(){this._callbackTable=Rt(!0),this._offCallback=void 0}var e=t.prototype;return e.on=function(t,e,n,i){if(!this.hasEventListener(t,e,n)){var r=this._callbackTable[t];r||(r=this._callbackTable[t]=Jl.alloc());var o=Ql.alloc();o.set(e,n,i),r.callbackInfos.push(o)}return e},e.hasEventListener=function(t,e,n){var i=this._callbackTable&&this._callbackTable[t];if(!i)return!1;var r=i.callbackInfos;if(!e){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===e&&s.target===n)return!0}return!1},e.removeAll=function(t){var e=typeof t;if("string"===e||"number"===e){var n=this._callbackTable&&this._callbackTable[t];n&&(n.isInvoking?n.cancelAll():(n.clear(),Jl.free(n),delete this._callbackTable[t]))}else if(t)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===t&&r.cancel(a)}else r.removeByTarget(t)}},e.off=function(t,e,n){var i,r=this._callbackTable&&this._callbackTable[t];if(r){var o=r.callbackInfos;if(e)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===e&&s.target===n){r.cancel(a);break}}else this.removeAll(t)}null===(i=this._offCallback)||void 0===i||i.call(this)},e.emit=function(t,e,n,i,r,o){var a=this._callbackTable&&this._callbackTable[t];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var f=h.callback,p=h.target;h.once&&this.off(t,f,p),h.check()?p?f.call(p,e,n,i,r,o):f(e,n,i,r,o):this.off(t,f,p)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},e.clear=function(){for(var t in this._callbackTable){var e=this._callbackTable[t];e&&(e.clear(),Jl.free(e),delete this._callbackTable[t])}},e._registerOffCallback=function(t){this._offCallback=t},t}();function tu(t){for(var e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._callbackTable=Rt(!0),e}$(e,t);var n=e.prototype;return n.once=function(t,e,n){return this.on(t,e,n,!0)},n.targetOff=function(t){this.removeAll(t)},e}(t),n=$l.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in e.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(e.prototype,o,a)}}return e}var eu=t("EventTarget",tu((function(){})));u.EventTarget=eu;var nu,iu,ru,ou,au,su,cu,lu=new(function(){function t(){this._finalizationRegistry=null}var e=t.prototype;return e.registerGCObject=function(t){return t},e.unregisterGCObject=function(){},e.init=function(){},e.finalizationRegistryCallback=function(t){t.isValid&&t.destroy()},e.destroy=function(){},t}()),uu=dc("cc.GCObject")(nu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return e=t.call.apply(t,[this].concat(i))||this,lu.registerGCObject(ot(e))||ot(e)}$(e,t);var n=e.prototype;return n.equals=function(t){return!!t&&t===this},n.destroy=function(){return lu.unregisterGCObject(this),t.prototype.destroy.call(this)},e}(dl))||nu;!function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(iu||(iu={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(ru||(ru={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(ou||(ou={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(au||(au={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(su||(su={})),function(t){t.WEBP="WEBP",t.IMAGE_BITMAP="IMAGE_BITMAP",t.WEB_VIEW="WEB_VIEW",t.VIDEO_PLAYER="VIDEO_PLAYER",t.SAFE_AREA="SAFE_AREA",t.INPUT_TOUCH="INPUT_TOUCH",t.EVENT_KEYBOARD="EVENT_KEYBOARD",t.EVENT_MOUSE="EVENT_MOUSE",t.EVENT_TOUCH="EVENT_TOUCH",t.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(cu||(cu={}));var hu,fu,pu,du,_u=new(function(t){function e(){var e,n,i;(i=t.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(e=o.getBattery)||void 0===e||e.call(o).then((function(t){i._battery=t})),i.networkType=ou.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?su.MOBILE_BROWSER:su.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:ru.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,f=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);f&&(c=!0,u=f[1]||"",h=parseInt(u)||0),(f=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=f[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var p=au.UNKNOWN;-1!==o.appVersion.indexOf("Win")?p=au.WINDOWS:l?p=au.IOS:-1!==o.appVersion.indexOf("Mac")?p=au.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?p=au.LINUX:c?p=au.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(p=au.LINUX),i.os=p,i.osVersion=u,i.osMainVersion=h,i.browserType=iu.UNKNOWN;var d=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),_=d?d[0].toLowerCase():au.UNKNOWN;("safari"===_&&c||"qq"===_&&/android.*applewebkit/i.test(a))&&(_=iu.ANDROID);var m={micromessenger:iu.WECHAT,wechat:iu.WECHAT,weixin:iu.WECHAT,trident:iu.IE,edge:iu.EDGE,"360 aphone":iu.BROWSER_360,mxbrowser:iu.MAXTHON,"opr/":iu.OPERA,ubrowser:iu.UC,huaweibrowser:iu.HUAWEI};i.browserType=m[_]||_,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(t){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(t){x=!0,null==t||t.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,T=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[cu.WEBP]=g,n[cu.IMAGE_BITMAP]=x,n[cu.WEB_VIEW]=!0,n[cu.VIDEO_PLAYER]=!0,n[cu.SAFE_AREA]=!1,n[cu.INPUT_TOUCH]=S,n[cu.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[cu.EVENT_MOUSE]=T,n[cu.EVENT_TOUCH]=S||T,n[cu.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}$(e,t);var n=e.prototype;return n._registerEvent=function(){var t,e=this;t=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,e.emit("hide"))},r=function(t,i,r,o,a){n&&(n=!1,e.emit("show",t,i,r,o,a))};if(t)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(e){var n=document[t];(n=n||e.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(t){return this._featureMap[t]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(t){window.open(t)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},e}(eu)),mu=/(\.[^\.\/\?\\]*)(\?.*)?$/,vu=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,gu=/[^\.\/]+\/\.\.\//;function yu(){for(var t="",e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];t=(t+(""===t?"":"/")+a).replace(/(\/|\\\\)$/,"")}return t}function xu(t){var e=mu.exec(t);return e?e[1]:""}function Su(t){if(t){var e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function Tu(t,e){var n=t.indexOf("?");n>0&&(t=t.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!i)return t;var r=i[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?r.substring(0,r.length-e.length):r}function Eu(t){var e=vu.exec(t);return e?e[2]:""}function bu(t,e){e=e||"";var n=t.indexOf("?"),i="";return n>0&&(i=t.substring(n),t=t.substring(0,n)),(n=t.lastIndexOf("."))<0?t+e+i:t.substring(0,n)+e+i}function Cu(t,e,n){if(0===e.indexOf("."))return bu(t,e);var i=t.indexOf("?"),r="",o=n?xu(t):"";return i>0&&(r=t.substring(i),t=t.substring(0,i)),i=(i=t.lastIndexOf("/"))<=0?0:i+1,t.substring(0,i)+e+o+r}function Au(t){var e=t=String(t);do{e=t,t=t.replace(gu,"")}while(e.length!==t.length);return t}function wu(t){return t.replace(/[\/\\]$/,"")}function Ru(){return _u.os===au.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:yu,extname:xu,mainFileName:Su,basename:Tu,dirname:Eu,changeExtname:bu,changeBasename:Cu,_normalize:Au,stripSep:wu,getSeperator:Ru}));var Pu,Iu,Mu,Du=t("Asset",dc("cc.Asset")((du=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).loaded=!0,ct(e,"_native",pu,ot(e)),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(ot(e),"_uuid",{value:"",writable:!0}),e}$(e,t),e.deserialize=function(t){return u.deserialize(t)};var n=e.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(t,e){void 0===e&&(e=!0),this._native=!1!==e?t||"":"/"+t},n.addRef=function(){return this._ref++,this},n.decRef=function(t){return void 0===t&&(t=!0),this._ref>0&&this._ref--,t&&u.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(t){t&&(this._uuid=t),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return b(F(12101,this._uuid)),t.prototype.destroy.call(this)},Z(e,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=Fl(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=Fl(this._uuid,{__nativeName__:t,nativeExt:xu(t),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(t){this._file=t}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),e}(tu(uu)),pu=lt((fu=du).prototype,"_native",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),lt(fu.prototype,"_nativeAsset",[gc],Object.getOwnPropertyDescriptor(fu.prototype,"_nativeAsset"),fu.prototype),hu=fu))||hu);Du.prototype.createNode=null,u.Asset=Du;var Ou=t("Script",dc("cc.Script")(Pu=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(Du))||Pu);u._Script=Ou;var Nu=t("JavaScript",dc("cc.JavaScript")(Iu=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(Ou))||Iu);u._JavaScript=Nu;var Lu,Bu,Fu,zu,ku,Uu,Gu,Hu,Vu,Wu,ju,qu=t("TypeScript",dc("cc.TypeScript")(Mu=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(Ou))||Mu);u._TypeScript=qu;var Xu,Yu,Ku,Qu,Zu=new mt("Comp"),Ju=dl.Flags.IsOnLoadCalled,$u=t("Component",(Lu=dc("cc.Component"),Bu=Nc(),Fu=Kc(Ou),zu=Lc(),Lu((ju=Wu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"node",Gu,ot(e)),ct(e,"_enabled",Hu,ot(e)),ct(e,"__prefab",Vu,ot(e)),e._sceneGetter=null,e._id=Zu.getNewId(),e}$(e,t);var n=e.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(t){return this.node.addComponent(t)},n.getComponent=function(t){return this.node.getComponent(t)},n.getComponents=function(t){return this.node.getComponents(t)},n.getComponentInChildren=function(t){return this.node.getComponentInChildren(t)},n.getComponentsInChildren=function(t){return this.node.getComponentsInChildren(t)},n.destroy=function(){return!!t.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&u.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),u.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(t){return t||(t=u.instantiate._clone(this,this)),t&&(t.node=null),t},n.schedule=function(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=u.macro.REPEAT_FOREVER),void 0===i&&(i=0),B(t,1619),B((e=e||0)>=0,1620),n=Number.isNaN(n)?u.macro.REPEAT_FOREVER:n,i=i||0;var r=u.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(t,this,e,n,i,o)},n.scheduleOnce=function(t,e){void 0===e&&(e=0),this.schedule(t,0,0,e)},n.unschedule=function(t){t&&u.director.getScheduler().unschedule(t,this)},n.unscheduleAllCallbacks=function(){u.director.getScheduler().unscheduleAllForTarget(this)},Z(e,[{key:"name",get:function(){if(this._name)return this._name;var t=Pt(this),e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),this.node?this.node.name+"<"+t+">":t},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){var e=u.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Ju}}]),e}(dl),Wu.system=null,lt((Uu=ju).prototype,"__scriptAsset",[Bu,Fu,zu,Wc],Object.getOwnPropertyDescriptor(Uu.prototype,"__scriptAsset"),Uu.prototype),Gu=lt(Uu.prototype,"node",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hu=lt(Uu.prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Vu=lt(Uu.prototype,"__prefab",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ku=Uu))||ku)),th=$u.prototype;th.update=null,th.lateUpdate=null,th.__preload=null,th.onLoad=null,th.start=null,th.onEnable=null,th.onDisable=null,th.onDestroy=null,th.onFocusInEditor=null,th.onLostFocusInEditor=null,th.resetInEditor=null,th._getLocalBounds=null,th.onRestore=null,$u._requireComponent=null,$u._executionOrder=0,bt($u,"_registerEditorProps",(function(t,e){var n=e.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),t._requireComponent=n);var i=e.executionOrder;i&&"number"==typeof i&&(t._executionOrder=i)})),u.Component=$u;var eh,nh=t("MissingScript",dc("cc.MissingScript")(Xu=Rc()((Qu=function(t){function e(){var e;return ct(e=t.call(this)||this,"_$erialized",Ku,ot(e)),e}return $(e,t),e.safeFindClass=function(t){var e=Jt(t);if(e)return e;u.deserialize.reportMissingClass(t)},e.prototype.onLoad=function(){M(4600,this.node.name)},e}($u),Ku=lt((Yu=Qu).prototype,"_$erialized",[xc,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xu=Yu))||Xu)||Xu);u._MissingScript=nh;try{var ih=nh.__values__;0!==ih.length&&"_$erialized"===ih[ih.length-1]||(T("The '_$erialized' prop in MissingScript is missing. Please contact jare."),T("    Error props: ['"+ih+"']"))}catch(Xo){T("Error when checking MissingScript 5, "+Xo)}!function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE",t[t.AUTO=13]="AUTO"}(eh||(eh={}));var rh,oh={auto:eh.AUTO,landscape:eh.LANDSCAPE,portrait:eh.PORTRAIT};!function(t){t[t.Unknown=0]="Unknown",t[t.SubFrame=1]="SubFrame",t[t.BrowserWindow=2]="BrowserWindow",t[t.Fullscreen=3]="Fullscreen"}(rh||(rh={}));var ah=new(function(t){function e(){var e,n,i,r,o,a;(e=t.call(this)||this).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new ti(0,0),e._exactFitScreen=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=eh.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null===(n=e._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=e._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var s=e._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)e._fn[s[0][l]]=a[l];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}$(e,t);var n=e.prototype;return n.init=function(t,e){this._cbToUpdateFrameBuffer=e,this.orientation=oh[t.configOrientation],this._exactFitScreen=t.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var t=this;return new Promise((function(e,n){t.isFullScreen?e():(t._cachedFrameSize=t.windowSize,t._doRequestFullScreen().then((function(){e()})).catch((function(){var i=t._getFullscreenTarget();i?i.addEventListener(t._touchEventName,(function(){t._doRequestFullScreen().then((function(){e()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var t=this;return new Promise((function(e,n){var i=document[t._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){t.windowSize=t._cachedFrameSize,e()})).catch(n):(t.windowSize=t._cachedFrameSize,e())}))},n._registerEvent=function(){var t=this;document.addEventListener(this._fn.fullscreenerror,(function(){var e;null===(e=t._onFullscreenError)||void 0===e||e.call(t)})),window.addEventListener("resize",(function(){t.handleResizeEvent&&t._resizeFrame()})),"function"==typeof window.matchMedia&&function e(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){t.emit("window-resize"),e()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==t._orientationChangeTimeoutId&&clearTimeout(t._orientationChangeTimeoutId),t._orientationChangeTimeoutId=setTimeout((function(){t.handleResizeEvent&&(t._updateFrameState(),t._resizeFrame(),t.emit("orientation-change"),t._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var e;null===(e=t._onFullscreenChange)||void 0===e||e.call(t),t.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(t){var e=t.clone(),n=this.devicePixelRatio;return e.width/=n,e.height/=n,e},n._resizeFrame=function(t){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===rh.SubFrame){if(!t)return void this._updateContainer();this._gameFrame.style.width=t.width+"px",this._gameFrame.style.height=t.height+"px"}else{var e=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+e+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=e+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=e+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var t=this._windowType;return t===rh.Fullscreen?document[this._fn.fullscreenElement]:t===rh.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var t=this;return new Promise((function(e,n){if(t._supportFullScreen){var i=t._getFullscreenTarget();if(i){t._onFullscreenChange=void 0,t._onFullscreenError=void 0;var r=i[t._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(e).catch(n):(t._onFullscreenChange=e,t._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var t=this.orientation,e=window.innerWidth>window.innerHeight;this.isFrameRotated=_u.isMobile&&(e&&t===eh.PORTRAIT||!e&&t===eh.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void M(9201);var t,e,n=u.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,o=i.clientHeight,a=n.width,s=n.height,c=r/a,l=o/s,h=this._gameContainer.style;c<l?(t=r,e=s*c):(t=a*l,e=o),h.width=t+"px",h.height=e+"px"}else{var f=this._gameContainer.style;f.width="100%",f.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else M(9201)},Z(e,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var t;return Math.min(null!==(t=window.devicePixelRatio)&&void 0!==t?t:1,2)}},{key:"windowSize",get:function(){var t=this._windowSizeInCssPixels,e=this.devicePixelRatio;return t.width*=e,t.height*=e,t},set:function(t){this._windowType===rh.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(t)):M(9202)}},{key:"resolution",get:function(){var t=this.windowSize,e=this.resolutionScale;return new ti(t.width*e,t.height*e)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(t){var e;t!==this._resolutionScale&&(this._resolutionScale=t,null===(e=this._cbToUpdateFrameBuffer)||void 0===e||e.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(t){this._orientation!==t&&(this._orientation=t,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(t){this._isProportionalToFrame!==t&&(this._isProportionalToFrame=t,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new ti(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(M(9201),new ti(0,0));var t,e,n;switch(this._windowType){case rh.SubFrame:return this._gameFrame?new ti(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(M(9201),new ti(0,0));case rh.Fullscreen:return t=this._getFullscreenTarget(),e=this.isFrameRotated?t.clientHeight:t.clientWidth,n=this.isFrameRotated?t.clientWidth:t.clientHeight,new ti(e,n);case rh.BrowserWindow:return e=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new ti(e,n);case rh.Unknown:default:return new ti(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?rh.Fullscreen:this._gameFrame?this._exactFitScreen?rh.BrowserWindow:rh.SubFrame:(M(9201),rh.Unknown)}}]),e}(eu)),sh=function(){function t(){}var e=t.prototype;return e._init=function(t){ah.init(t,(function(){var t,e=u.director;(null===(t=e.root)||void 0===t?void 0:t.pipeline)?e.root.pipeline.pipelineSceneData.shadingScale=ah.resolutionScale:M(1220)}))},e.fullScreen=function(){return ah.isFullScreen},e.requestFullScreen=function(t,e,n){return arguments.length>0&&M(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),ah.requestFullScreen().then((function(){null==e||e()})).catch((function(t){console.error(t),null==n||n()}))},e.exitFullScreen=function(){return ah.exitFullScreen()},e.autoFullScreen=function(t,e){var n;null===(n=this.requestFullScreen(t,e))||void 0===n||n.catch((function(){}))},e.disableAutoFullScreen=function(){},Z(t,[{key:"devicePixelRatio",get:function(){return ah.devicePixelRatio}},{key:"windowSize",get:function(){return ah.windowSize},set:function(t){ah.windowSize=t}},{key:"resolution",get:function(){return ah.resolution}},{key:"supportsFullScreen",get:function(){return ah.supportFullScreen}}]),t}(),ch=t("screen",new sh);u.screen=ch;var lh=t("sys",{Feature:cu,hasFeature:function(t){return _u.hasFeature(t)},NetworkType:ou,Language:ru,OS:au,Platform:su,BrowserType:iu,isNative:_u.isNative,isBrowser:_u.isBrowser,isMobile:_u.isMobile,isLittleEndian:_u.isLittleEndian,platform:_u.platform,language:_u.language,languageCode:_u.nativeLanguage,os:_u.os,osVersion:_u.osVersion,osMainVersion:_u.osMainVersion,browserType:_u.browserType,browserVersion:_u.browserVersion,windowPixelResolution:ch.windowSize,capabilities:{canvas:!0,opengl:!0,webp:_u.hasFeature(cu.WEBP),imageBitmap:_u.hasFeature(cu.IMAGE_BITMAP),touches:_u.hasFeature(cu.INPUT_TOUCH),mouse:_u.hasFeature(cu.EVENT_MOUSE),keyboard:_u.hasFeature(cu.EVENT_KEYBOARD),accelerometer:_u.hasFeature(cu.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return _u.networkType},getBatteryLevel:function(){return _u.getBatteryLevel()},garbageCollect:function(){_u.triggerGC()},isObjectValid:function(t){return null!=t},dump:function(){var t="";t+="isMobile : "+this.isMobile+"\r\n",t+="language : "+this.language+"\r\n",t+="browserType : "+this.browserType+"\r\n",t+="browserVersion : "+this.browserVersion+"\r\n",t+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",t+="os : "+this.os+"\r\n",t+="osVersion : "+this.osVersion+"\r\n",t+="platform : "+this.platform+"\r\n",x(t+="Using "+(u.game.renderType===u.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(t){_u.openURL(t)},now:function(){return _u.now()},restartVM:function(){_u.restartJSVM()},getSafeAreaRect:function(){var t=u.view,e=ah.safeAreaEdge,n=ah.windowSize,i=new Xn(e.left,e.bottom),r=new Xn(n.width-e.right,n.height-e.top);t._convertToUISpace(i),t._convertToUISpace(r);var o=i.x,a=i.y,s=r.x-i.x,c=r.y-i.y;return new ni(o,a,s,c)}});!function(){try{var t=lh.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){var e=function(){M(5200)};lh.localStorage={getItem:e,setItem:e,clear:e,removeItem:e}}lh.__isWebIOS14OrIPadOS14Env=(lh.os===au.IOS||lh.os===au.OSX)&&_u.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),u.sys=lh;var uh=t("serializeTag",Symbol("[[Serialize]]")),hh=t("deserializeTag",Symbol("[[Deserialize]]")),fh=function(){function t(t,e){this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=e}return Z(t,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),t}();function ph(t){var e=t;return{chunks:e.chunks,document:e.document}}function dh(t){if(t.length<16)throw new _h(F(13102));var e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new _h(F(13100));var n=e.getUint32(4,!0);if(1!==n)throw new _h(F(13101,n));if(e.getUint32(8,!0)!==e.byteLength)throw new _h(F(13102));var i=12,r=e.getUint32(i,!0);i+=4;var o=new Uint8Array(e.buffer,i+e.byteOffset,r);i+=r;var a,s=function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis)return globalThis.Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString();throw new Error(F(13104))}(o);try{a=JSON.parse(s)}catch(t){throw new _h(t)}for(var c=[];i<e.byteLength;){i%8!=0&&(i+=8-i%8);var l=e.getUint32(i,!0);i+=4,c.push(new Uint8Array(e.buffer,i+e.byteOffset,l)),i+=l}if(i!==e.byteLength)throw new _h(F(13102));return new fh(a,c)}var _h=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(rt(Error));function mh(t,e,n,i,r){if(e instanceof u.ValueType){r||t.push("if(prop){");var o=Pt(e);t.push("s._deserializeFastDefinedObject(o"+n+",prop,"+o+");"),r||t.push("}else o"+n+"=null;")}else t.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function t(){this._viewOrPaddings=[],this._length=0}var e=t.prototype;e.alignAs=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},e.append=function(t){var e=this._length;return this._viewOrPaddings.push(t),this._length+=t.byteLength,e},e.get=function(){var t=new Uint8Array(this._length),e=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),e),e+=n.byteLength)})),t},Z(t,[{key:"byteLength",get:function(){return this._length}}])}(),u.internal.parseCCONJson=ph,u.internal.decodeCCONBinary=dh,u.internal.CCON=fh;var vh="$_$default",gh="$_$formerlySerializedAs",yh=function(t){function e(){return t.call(this,(function(t){t.clear()}),1)||this}return $(e,t),e.prototype.get=function(t,e,n,i,r){var o=this._get();return o?(o.reset(t,e,n,i,r),o):new xh(t,e,n,i,r)},e}(ee),xh=function(){function t(t,e,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced}var e=t.prototype;return e.reset=function(t,e,n,i){this.result=t,this.customEnv=i,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced},e.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},e.deserialize=function(t){var e,n=!1;t instanceof fh?(n=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:n};var i=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},e._deserializeObject=function(t,e,n,i){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,n,i):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}},e._deserializeTypedArrayView=function(t){return globalThis[t.ctor].from(t.array)},e._deserializeTypedArrayViewRef=function(t){var e=t.offset,n=t.length,i=t.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,n)},e._deserializeArray=function(t){for(var e,n=new Array(t.length),i=0;i<t.length;i++)"object"==typeof(e=t[i])&&e?this._deserializeAndAssignField(n,e,""+i)&&(n[i]=null):n[i]=e;return n},e._deserializePlainObject=function(t){var e={};return this._fillPlainObject(e,t),e},e._deserializeTypeTaggedObject=function(t,e,n,i){var r=this,o=t.__type__,a=this._classFinder(o,t,n,i);if(!a)return this._classFinder===Jt&&this._reportMissingClass(o),null;var s=function(t){var n=new t;return e>=0&&(r.deserializedList[e]=n),n}(a);return this._deserializeInto(t,s,a),s},e._deserializeInto=function(t,e,n,i){void 0===i&&(i=!1),i||!e[hh]?e._deserialize?e._deserialize(t.content,this):u.Class._isCCClass(n)?this._deserializeFireClass(e,t,n):this._deserializeFastDefinedObject(e,t,n):this._runCustomizedDeserialize(t,e,n)},e._runCustomizedDeserialize=function(t,e,n){var i=this,r={readProperty:function(e){var n=t[e];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(t,e,n,!0)},readSuper:function(){var r=Gt(n);r&&i._deserializeInto(t,e,r)}};e[hh](r,this._context)},e._deserializeFireClass=function(t,e,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(t,e){for(var n=Pe(e),i=e.__values__,r=["var prop;"],o=he.test(te(e)),a=0;a<i.length;a++){var s=i[a],c=void 0,l=void 0;Je.IDENTIFIER_RE.test(s)?(l='"'+s+'"',c="."+s):c="["+(l=Je.escapeForJS(s))+"]";var h=c;if(n[s+gh]){var f=n[s+gh];h=Je.IDENTIFIER_RE.test(f)?"."+f:"["+Je.escapeForJS(f)+"]"}r.push("prop=d"+h+";"),r.push('if(typeof prop!=="undefined"){');var p=Je.getDefault(n[s+vh]);if(o){var d=void 0,_=n[s+"$_$type"];if(void 0===p&&_)d=_ instanceof Me;else{var m=typeof p;d="string"===m||"number"===m||"boolean"===m}d?r.push("o"+c+"=prop;"):mh(r,p,c,l,!0)}else r.push('if(typeof prop!=="object"){o'+c+"=prop;}else{"),mh(r,p,c,l,!1),r.push("}");r.push("}")}return(u.js.isChildClassOf(e,u._BaseNode)||u.js.isChildClassOf(e,u.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===nh){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(T("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),T("    Error props: ['"+r+"']. Please contact jare."));var o=i;i=function(t,e,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||T("Unable to load previously serialized data. "+JSON.stringify(n))}catch(t){T("Error when checking MissingScript 7, "+t)}o(t,e,n,i)}}}catch(t){T("Error when checking MissingScript 6, "+t)}bt(n,"__deserialize__",i,!0)}i(this,t,e,n)},e._deserializeAndAssignField=function(t,e,n){var i=e.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)t[n]=r;else{var o,a=this._serializedData[i];t[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,t,n)}}else{var s=e.__uuid__;if(s){var c=e.__expectedType__;this.result.push(t,n,s,c)}else t[n]=this._deserializeObject(e,-1)}return!1},e._deserializeObjectField=function(t){var e=t.__id__;if("number"==typeof e){var n=this.deserializedList[e];if(n)return n;var i=this._serializedData[e];return this._deserializeObject(i,e,void 0,void 0)}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)},e._fillPlainObject=function(t,e){for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];"object"!=typeof i?"__type__"!==n&&(t[n]=i):i?this._deserializeAndAssignField(t,i,n)&&(t[n]=null):t[n]=null}},e._deserializeFastDefinedObject=function(t,e,n){if(n===u.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(n===u.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(n!==u.Color){if(n===u.Size)return t.width=e.width||0,void(t.height=e.height||0);for(var i=Pe(n),r=n.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];void 0!==s||e.hasOwnProperty(a)||(s=Je.getDefault(i[a+vh])),"object"!=typeof s?t[a]=s:s?this._deserializeAndAssignField(t,s,a):t[a]=null}}else{t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;var c=e.a;t.a=void 0===c?255:c}},t}();xh.pool=new yh;var Sh=[Xn,Rn,Zn,Ln,An,ti,ni,Vn];function Th(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}var Eh=[function(t,e){t.x=e[1],t.y=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.z=e[3]},Th,Th,function(t,e){t._val=e[1]},function(t,e){t.width=e[1],t.height=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},function(t,e){Vn.fromArray(t,e,1)}],bh=t("Details",function(){function t(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var e=t.prototype;return e.init=function(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},e.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},e.push=function(t,e,n,i){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(n),this.uuidTypeList.push(i||"")},t}());function Ch(t,e){for(var n=t[4][e[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=e[c];for(;c<e.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,Mh[u])(t,r,l,e[c])}return r}function Ah(t,e,n){var i=new e;return i._deserialize?i._deserialize(n,t[0]):O(5303,Pt(e)),i}function wh(t,e,n,i){i>=0?e[n]=t[5][i]:t[7][3*~i]=e}function Rh(t){return function(e,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)t(e,r,o,r[o])}}function Ph(t,e,n,i){e[n]=null,t[8][i]=e}function Ih(t,e,n,i){e[n]=Ch(t,i)}bh.pool=new ee((function(t){t.reset()}),5),bh.pool.get=function(){return this._get()||new bh};var Mh=new Array(13);function Dh(t,e,n){return t||n(e),Object}function Oh(t,e,n,i,r,o,a){var s=t(e);if(!s){if(r)return void(n[i]=function(e,n,i){return function(){var r=t(i)||Dh(o,i,a);return e[n]=r,new r}}(n,i,e));s=Dh(o,e,a)}n[i]=s}function Nh(t,e,n,i){for(var r=n||Jt,o=t[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Oh(r,s[0],s,0,e,n,i):Oh(r,s,o,a,e,n,i)}}function Lh(t){var e=t[4];if(e)for(var n=t[3],i=0;i<e.length;++i){var r=e[i];r[0]=n[r[0]]}}function Bh(t,e,n){"string"==typeof t&&(t=JSON.parse(t));var i,r=!e;if(e=e||bh.pool.get(),function(t){if(Array.isArray(t)){var e=t[0];return"number"==typeof e||e instanceof Fh}return!1}(t)){e.init(t),n=n||{};var o,a=t[0],s=!1;if("object"==typeof a&&(s=a.preprocessed,a=a.version),a<1)throw new Error(F(5304,a));n._version=a,n.result=e,t[0]=n,s||(Nh(t,!1,n.classFinder,null!==(o=n.reportMissingClass)&&void 0!==o?o:Bh.reportMissingClass),Lh(t)),u.game._isCloning=!0;var c=t[5],l=function(t){var e=t[5],n=t[6],i=0===n?0:n.length,r=e[e.length-1],o=e.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)e[a]=Ch(t,e[a]);for(var s=t[3],c=0;c<i;++c,++a){var l=n[c],u=e[a];if(l>=0){var h=s[l];e[a]=Ah(t,h,u)}else(0,Mh[l=~l])(t,e,a,u)}return r}(t);u.game._isCloning=!1,t[7]&&function(t,e,n){for(var i=t.length-1,r=0,o=3*t[i];r<o;r+=3){var a=t[r],s=e[t[r+2]],c=t[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=e[t[r]],u=e[t[r+2]],h=t[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(t[7],c,t[2]),function(t){for(var e=t[5],n=t[2],i=t[1],r=t[8],o=t[9],a=t[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=e[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(t),i=c[l]}else i=function(t,e,n){var i,r=(n=n||{}).classFinder||Jt,o=n.createAssetRefs||lh.platform===su.EDITOR_CORE,a=n.customEnv,s=n.ignoreEditorOnly,c=null!==(i=n.reportMissingClass)&&void 0!==i?i:u.deserialize.reportMissingClass;e.init();var l=xh.pool.get(e,r,c,a,s);u.game._isCloning=!0;var h=l.deserialize(t);return u.game._isCloning=!1,xh.pool.put(l),o&&e.assignAssetsBy(EditorExtends.serialize.asAsset),h}(t,e,n);return r&&bh.pool.put(e),i}Mh[0]=function(t,e,n,i){e[n]=i},Mh[1]=wh,Mh[2]=Rh(wh),Mh[3]=Rh(Ph),Mh[4]=Ih,Mh[5]=function(t,e,n,i){Eh[i[0]](e[n],i)},Mh[6]=Ph,Mh[7]=function(t,e,n,i){e[n].set(i)},Mh[8]=function(t,e,n,i){var r=new Sh[i[0]];Eh[i[0]](r,i),e[n]=r},Mh[9]=Rh(Ih),Mh[10]=function(t,e,n,i){var r=t[3][i[0]];e[n]=Ah(t,r,i[1])},Mh[11]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,Mh[s])(t,r,a,c)}},Mh[12]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,Mh[s])(t,r,o,a)}},Bh.Details=bh,Bh.reportMissingClass=function(t){O(5302,t)};var Fh=function(t){this.preprocessed=!0,this.version=t};function zh(t,e,n){return[1,0,0,[t],0,n?[e,-1]:[e],[0],0,[],[],[]]}u.deserialize=Bh;var kh,Uh,Gh,Hh,Vh,Wh,jh,qh,Xh,Yh,Kh,Qh=dl.Flags.Destroyed,Zh=dl.Flags.PersistentMask,Jh=[];function $h(t){var e;if(t instanceof dl){if(t._instantiate)return u.game._isCloning=!0,e=t._instantiate(null,!0),u.game._isCloning=!1,e;if(t instanceof u.Asset)throw new TypeError(F(6903))}return u.game._isCloning=!0,e=tf(t),u.game._isCloning=!1,e}function tf(t,e){var n;ef(t,n=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),e);for(var i=0,r=Jh.length;i<r;++i)Jh[i]._iN$t=null;return Jh.length=0,n}function ef(t,e,n){ie.value(t,"_iN$t",e,!0),Jh.push(t);var i=t.constructor;if(u.Class._isCCClass(i))!function(t,e,n,i){for(var r=t.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];if("object"==typeof s&&s){var c=n[a];c instanceof le&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||nf(s,i)}else n[a]=s}}(i,t,e,n);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var o=t[r];if("object"==typeof o&&o){if(o===e)continue;e[r]=o._iN$t||nf(o,n)}else e[r]=o}t instanceof dl&&(e._objFlags&=Zh)}function nf(t,e){if(t instanceof le)return t.clone();if(t instanceof u.Asset)return t;var n;if(ArrayBuffer.isView(t)){var i=t.length;n=new t.constructor(i),t._iN$t=n,Jh.push(t);for(var r=0;r<i;++r)n[r]=t[r];return n}if(Array.isArray(t)){var o=t.length;n=new Array(o),t._iN$t=n,Jh.push(t);for(var a=0;a<o;++a){var s=t[a];n[a]="object"==typeof s&&s?s._iN$t||nf(s,e):s}return n}if(t._objFlags&Qh)return null;var c=t.constructor;if(u.Class._isCCClass(c)){if(e)if(e instanceof u.Component){if(t instanceof u._BaseNode||t instanceof u.Component)return t}else if(e instanceof u._BaseNode)if(t instanceof u._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof u.Component&&t.node&&!t.node.isChildOf(e))return t;n=new c}else if(c===Object)n={};else{if(c)return t;n=Object.create(null)}return ef(t,n,e),n}function rf(t,e){return(e<<3)+t}function of(t){return sf[t]}function af(t){switch(t){case Yh.Uint8:return Uint8Array;case Yh.Uint16:return Uint16Array;case Yh.Uint32:return Uint32Array;case Yh.Int8:return Int8Array;case Yh.Int16:return Int16Array;case Yh.Int32:return Int32Array;case Yh.Float32:return Float32Array;case Yh.Float64:return Float64Array}}$h._clone=tf,u.instantiate=$h,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(Yh||(Yh={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(Kh||(Kh={})),t("CompactValueTypeArray",dc("cc.CompactValueTypeArray")((qh=jh=function(){function t(){ct(this,"_byteOffset",Gh,this),ct(this,"_unitCount",Hh,this),ct(this,"_unitElement",Vh,this),ct(this,"_length",Wh,this)}return t.lengthFor=function(t,e,n){return of(e).requiredUnits*t.length*af(n).BYTES_PER_ELEMENT},t.compress=function(e,n,i,r,o,a){for(var s=of(n),c=af(i),l=s.requiredUnits*e.length,u=new c(r,o,l),h=0;h<e.length;++h)s.compress(u,h,e[h]);var f=new t;return f._unitElement=rf(i,n),f._byteOffset=a,f._unitCount=l,f._length=e.length,f},t.prototype.decompress=function(t){for(var e,n={storageUnit:7&(e=this._unitElement),elementType:e>>3},i=n.storageUnit,r=of(n.elementType),o=new(af(i))(t,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},t}(),jh.StorageUnit=Yh,jh.ElementType=Kh,Gh=lt((Uh=qh).prototype,"_byteOffset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hh=lt(Uh.prototype,"_unitCount",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vh=lt(Uh.prototype,"_unitElement",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rf(Yh.Uint8,Kh.Scalar)}}),Wh=lt(Uh.prototype,"_length",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kh=Uh))||kh);var sf=((Xh={})[Kh.Scalar]={requiredUnits:1,compress:function(t,e,n){t[e]=n},decompress:function(t,e){return t[e]}},Xh[Kh.Vec2]={requiredUnits:2,compress:function(t,e,n){t[2*e]=n.x,t[2*e+1]=n.y},decompress:function(t,e){return new Rn(t[2*e],t[2*e+1])}},Xh[Kh.Vec3]={requiredUnits:3,compress:function(t,e,n){t[3*e]=n.x,t[3*e+1]=n.y,t[3*e+2]=n.z},decompress:function(t,e){return new Rn(t[3*e],t[3*e+1],t[3*e+2])}},Xh[Kh.Vec4]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new Zn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Xh[Kh.Quat]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new Ln(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Xh[Kh.Mat4]={requiredUnits:16,compress:function(t,e,n){Vn.toArray(t,n,16*e)},decompress:function(t,e){return Vn.fromArray(new Vn,t,16*e)}},Xh);function cf(){return 0}function lf(t){return t}function uf(t){return t*t}function hf(t){return t*(2-t)}function ff(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}function pf(t){return t*t*t}function df(t){return--t*t*t+1}function _f(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}function mf(t){return t*t*t*t}function vf(t){return 1- --t*t*t*t}function gf(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}function yf(t){return t*t*t*t*t}function xf(t){return--t*t*t*t*t+1}function Sf(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}function Tf(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function Ef(t){return Math.sin(t*Math.PI/2)}function bf(t){return.5*(1-Math.cos(Math.PI*t))}function Cf(t){return 0===t?0:Math.pow(1024,t-1)}function Af(t){return 1===t?1:1-Math.pow(2,-10*t)}function wf(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}function Rf(t){return 1-Math.sqrt(1-t*t)}function Pf(t){return Math.sqrt(1- --t*t)}function If(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}function Mf(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function Df(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function Of(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),(t*=2)<1?n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)}function Nf(t){if(1===t)return 1;var e=1.70158;return t*t*((e+1)*t-e)}function Lf(t){if(0===t)return 0;var e=1.70158;return--t*t*((e+1)*t+e)+1}function Bf(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}function Ff(t){return 1-zf(1-t)}function zf(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function kf(t){return t<.5?.5*Ff(2*t):.5*zf(2*t-1)+.5}function Uf(t){return t<=0?0:t>=1?1:t*t*(3-2*t)}function Gf(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)}u._decorator=hl;var Hf=Jf(uf,hf),Vf=Jf(pf,df),Wf=Jf(mf,vf),jf=Jf(yf,xf),qf=Jf(Tf,Ef),Xf=Jf(Cf,Af),Yf=Jf(Rf,Pf),Kf=Jf(Mf,Df),Qf=Jf(Nf,Lf),Zf=Jf(Ff,zf);function Jf(t,e){return function(n){return n<.5?e(2*n)/2:t(2*n-1)/2+.5}}var $f,tp,ep=Object.freeze({__proto__:null,constant:cf,linear:lf,quadIn:uf,quadOut:hf,quadInOut:ff,cubicIn:pf,cubicOut:df,cubicInOut:_f,quartIn:mf,quartOut:vf,quartInOut:gf,quintIn:yf,quintOut:xf,quintInOut:Sf,sineIn:Tf,sineOut:Ef,sineInOut:bf,expoIn:Cf,expoOut:Af,expoInOut:wf,circIn:Rf,circOut:Pf,circInOut:If,elasticIn:Mf,elasticOut:Df,elasticInOut:Of,backIn:Nf,backOut:Lf,backInOut:Bf,bounceIn:Ff,bounceOut:zf,bounceInOut:kf,smooth:Uf,fade:Gf,quadOutIn:Hf,cubicOutIn:Vf,quartOutIn:Wf,quintOutIn:jf,sineOutIn:qf,expoOutIn:Xf,circOutIn:Yf,elasticOutIn:Kf,backOutIn:Qf,bounceOutIn:Zf});t("easing",ep),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.QUAD_IN=2]="QUAD_IN",t[t.QUAD_OUT=3]="QUAD_OUT",t[t.QUAD_IN_OUT=4]="QUAD_IN_OUT",t[t.QUAD_OUT_IN=5]="QUAD_OUT_IN",t[t.CUBIC_IN=6]="CUBIC_IN",t[t.CUBIC_OUT=7]="CUBIC_OUT",t[t.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",t[t.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",t[t.QUART_IN=10]="QUART_IN",t[t.QUART_OUT=11]="QUART_OUT",t[t.QUART_IN_OUT=12]="QUART_IN_OUT",t[t.QUART_OUT_IN=13]="QUART_OUT_IN",t[t.QUINT_IN=14]="QUINT_IN",t[t.QUINT_OUT=15]="QUINT_OUT",t[t.QUINT_IN_OUT=16]="QUINT_IN_OUT",t[t.QUINT_OUT_IN=17]="QUINT_OUT_IN",t[t.SINE_IN=18]="SINE_IN",t[t.SINE_OUT=19]="SINE_OUT",t[t.SINE_IN_OUT=20]="SINE_IN_OUT",t[t.SINE_OUT_IN=21]="SINE_OUT_IN",t[t.EXPO_IN=22]="EXPO_IN",t[t.EXPO_OUT=23]="EXPO_OUT",t[t.EXPO_IN_OUT=24]="EXPO_IN_OUT",t[t.EXPO_OUT_IN=25]="EXPO_OUT_IN",t[t.CIRC_IN=26]="CIRC_IN",t[t.CIRC_OUT=27]="CIRC_OUT",t[t.CIRC_IN_OUT=28]="CIRC_IN_OUT",t[t.CIRC_OUT_IN=29]="CIRC_OUT_IN",t[t.ELASTIC_IN=30]="ELASTIC_IN",t[t.ELASTIC_OUT=31]="ELASTIC_OUT",t[t.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",t[t.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",t[t.BACK_IN=34]="BACK_IN",t[t.BACK_OUT=35]="BACK_OUT",t[t.BACK_IN_OUT=36]="BACK_IN_OUT",t[t.BACK_OUT_IN=37]="BACK_OUT_IN",t[t.BOUNCE_IN=38]="BOUNCE_IN",t[t.BOUNCE_OUT=39]="BOUNCE_OUT",t[t.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",t[t.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",t[t.SMOOTH=42]="SMOOTH",t[t.FADE=43]="FADE"}(tp||(tp={}));var np,ip,rp,op,ap,sp=(($f={})[tp.CONSTANT]=cf,$f[tp.LINEAR]=lf,$f[tp.QUAD_IN]=uf,$f[tp.QUAD_OUT]=hf,$f[tp.QUAD_IN_OUT]=ff,$f[tp.QUAD_OUT_IN]=Hf,$f[tp.CUBIC_IN]=pf,$f[tp.CUBIC_OUT]=df,$f[tp.CUBIC_IN_OUT]=_f,$f[tp.CUBIC_OUT_IN]=Vf,$f[tp.QUART_IN]=mf,$f[tp.QUART_OUT]=vf,$f[tp.QUART_IN_OUT]=gf,$f[tp.QUART_OUT_IN]=Wf,$f[tp.QUINT_IN]=yf,$f[tp.QUINT_OUT]=xf,$f[tp.QUINT_IN_OUT]=Sf,$f[tp.QUINT_OUT_IN]=jf,$f[tp.SINE_IN]=Tf,$f[tp.SINE_OUT]=Ef,$f[tp.SINE_IN_OUT]=bf,$f[tp.SINE_OUT_IN]=qf,$f[tp.EXPO_IN]=Cf,$f[tp.EXPO_OUT]=Af,$f[tp.EXPO_IN_OUT]=wf,$f[tp.EXPO_OUT_IN]=Xf,$f[tp.CIRC_IN]=Rf,$f[tp.CIRC_OUT]=Pf,$f[tp.CIRC_IN_OUT]=If,$f[tp.CIRC_OUT_IN]=Yf,$f[tp.ELASTIC_IN]=Mf,$f[tp.ELASTIC_OUT]=Df,$f[tp.ELASTIC_IN_OUT]=Of,$f[tp.ELASTIC_OUT_IN]=Kf,$f[tp.BACK_IN]=Nf,$f[tp.BACK_OUT]=Lf,$f[tp.BACK_IN_OUT]=Bf,$f[tp.BACK_OUT_IN]=Qf,$f[tp.BOUNCE_IN]=Ff,$f[tp.BOUNCE_OUT]=zf,$f[tp.BOUNCE_IN_OUT]=kf,$f[tp.BOUNCE_OUT_IN]=Zf,$f[tp.SMOOTH]=Uf,$f[tp.FADE]=Gf,$f);function cp(t){return sp[t]}var lp,up,hp,fp=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).interpolationMode=nl.LINEAR,e.tangentWeightMode=rl.NONE,e.value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e.easingMethod=tp.LINEAR,e}return $(e,t),e}(ul);function pp(t){var e=new fp;if("number"==typeof t)e.value=t;else{var n=t.interpolationMode,i=t.tangentWeightMode,r=t.value,o=t.rightTangent,a=t.rightTangentWeight,s=t.leftTangent,c=t.leftTangentWeight,l=t.easingMethod,u=t[ll];e.value=null!=r?r:e.value,e.rightTangent=null!=o?o:e.rightTangent,e.rightTangentWeight=null!=a?a:e.rightTangentWeight,e.leftTangent=null!=s?s:e.leftTangent,e.leftTangentWeight=null!=c?c:e.leftTangentWeight,e.interpolationMode=null!=n?n:e.interpolationMode,e.tangentWeightMode=null!=i?i:e.tangentWeightMode,e.easingMethod=null!=l?l:e.easingMethod,u&&(e[ll]=u)}return e}Je.fastDefine("cc.RealKeyframeValue",fp,{interpolationMode:nl.LINEAR,tangentWeightMode:rl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:tp.LINEAR}),Je.Attr.setClassAttr(fp,ll,"editorOnly",!0),(lp=fp,null!==(hp=(up=lp)[yc])&&void 0!==hp?hp:up[yc]={}).uniquelyReferenced=!0;var dp,_p=t("RealCurve",dc("cc.RealCurve")((ap=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",rp,ot(e)),ct(e,"postExtrapolation",op,ot(e)),e}$(e,t);var n=e.prototype;return n.evaluate=function(t){var e=this._times,n=this._values,i=e.length;if(0===i)return 0;var r=e[0],o=e[i-1];if(t<r){var a=this.preExtrapolation,s=n[0];if(a===il.CLAMP||i<2)return s.value;switch(a){case il.LINEAR:return Mp(r,n[0].value,e[1],n[1].value,t);case il.LOOP:t=Pp(t,r,o);break;case il.PING_PONG:t=Ip(t,r,o);break;default:return s.value}}else if(t>o){var c=this.postExtrapolation,l=n[i-1];if(c===il.CLAMP||i<2)return l.value;switch(c){case il.LINEAR:return Mp(o,l.value,e[i-2],n[i-2].value,t);case il.LOOP:t=Pp(t,r,o);break;case il.PING_PONG:t=Ip(t,r,o);break;default:return l.value}}var u=oc(e,t);if(u>=0)return n[u].value;var h=~u,f=h-1,p=e[f],d=n[f],_=e[h];return function(t,e,n,i,r){var o=n-t;switch(e.interpolationMode){default:case nl.CONSTANT:return e.value;case nl.LINEAR:var a=e.easingMethod===tp.LINEAR?r:cp(e.easingMethod)(r);return ln(e.value,i.value,a);case nl.CUBIC:var s=1/3,c=e.rightTangent,l=e.rightTangentWeight,u=0!=(e.tangentWeightMode&rl.RIGHT),h=i.leftTangent,f=i.leftTangentWeight,p=0!=(i.tangentWeightMode&rl.LEFT);if(u||p){var d=0;if(u)d=l;else{var _=o,m=o*c;d=Math.sqrt(_*_+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*d+t,y=Math.sin(v)*d+e.value,x=0;if(p)x=f;else{var S=o,T=o*h;x=Math.sqrt(S*S+T*T)*s}var E=Math.atan(h),b=(g-t)/o,C=(-Math.cos(E)*x+n-t)/o,A=y,w=-Math.sin(E)*x+i.value,R=[0,0,0],P=function(t,e,n,i,r){var o=n/i,a=e/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+t/i),u=c*c*c,h=l*l+u,f=0;if(sl(h)){if(sl(l))return r[0]=0,1;var p=Math.cbrt(-l);return r[0]=2*p,r[1]=-p,2}if(h<0){var d=1/3*Math.acos(-l/Math.sqrt(-u)),_=2*Math.sqrt(-c);r[0]=_*Math.cos(d),r[1]=-_*Math.cos(d+Math.PI/3),r[2]=-_*Math.cos(d-Math.PI/3),f=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,f=1}for(var y=1/3*o,x=0;x<f;++x)r[x]-=y;return f}(0-r,3*b,3*C-6*b,3*(b-C)+1,R),I=function(t,e,n){var i=n;if(1===e)i=t[0];else{i=-1/0;for(var r=0;r<e;++r){var o=t[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(R,P,r);return Dp(e.value,A,w,i.value,I)}var M=e.value+s*c*o,D=i.value-s*h*o;return Dp(e.value,M,D,i.value,r)}}(p,d,_,n[h],(t-p)/(_-p))},n.addKeyFrame=function(e,n){return t.prototype.addKeyFrame.call(this,e,pp(n))},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return pp(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return pp(t[1])})))}},n.isConstant=function(t){if(this._values.length<=1)return!0;var e=this._values[0].value;return this._values.every((function(n){return an(n.value,e,t)}))},n[uh]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+mp+mp+vp+gp*r+Ap*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=mp,o.setUint8(a,this.postExtrapolation),a+=mp,o.setUint32(a,r,!0),a+=vp,n.forEach((function(t,e){return o.setFloat32(a+gp*e,t,!0)})),a+=gp*r;for(var s,c=st(i);!(s=c()).done;){var l=s.value;a=wp(o,l,a)}var u=new Uint8Array(o.buffer,0,a);t.writeProperty("bytes",u);var h=i.map((function(t){return t[ll]}));h.some((function(t){return void 0!==t}))&&t.writeProperty("keyframeValueEditorExtras",h)}else t.writeThis()},n[hh]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=mp,this.postExtrapolation=i.getUint8(r),r+=mp;var o=i.getUint32(r,!0);r+=vp;var a=Array.from({length:o},(function(t,e){return i.getFloat32(r+gp*e,!0)}));r+=gp*o;for(var s=new Array(o),c=0;c<o;++c){var l=pp({});r=Rp(i,l,r),s[c]=l}n.byteLength;var u=t.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(t,e){return s[e][ll]=t}))),this._times=a,this._values=s}else t.readThis()},e}(al),rp=lt((ip=ap).prototype,"preExtrapolation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return il.CLAMP}}),op=lt(ip.prototype,"postExtrapolation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return il.CLAMP}}),np=ip))||np);!function(t){t[t.VALUE=1]="VALUE",t[t.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",t[t.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",t[t.LEFT_TANGENT=8]="LEFT_TANGENT",t[t.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",t[t.RIGHT_TANGENT=32]="RIGHT_TANGENT",t[t.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(dp||(dp={}));var mp=1,vp=4,gp=4,yp=pp({}),xp=yp.interpolationMode,Sp=yp.tangentWeightMode,Tp=yp.leftTangent,Ep=yp.leftTangentWeight,bp=yp.rightTangent,Cp=yp.rightTangentWeight,Ap=26;function wp(t,e,n){var i=0,r=n,o=r;r+=4;var a=e.value,s=e.interpolationMode,c=e.tangentWeightMode,l=e.rightTangent,u=e.rightTangentWeight,h=e.leftTangent,f=e.leftTangentWeight,p=e.easingMethod;return t.setFloat32(r,a,!0),r+=4,s!==xp&&(i|=dp.INTERPOLATION_MODE,t.setUint8(r,s),r+=1),c!==Sp&&(i|=dp.TANGENT_WEIGHT_MODE,t.setUint8(r,c),r+=1),h!==Tp&&(i|=dp.LEFT_TANGENT,t.setFloat32(r,h,!0),r+=4),f!==Ep&&(i|=dp.LEFT_TANGENT_WEIGHT,t.setFloat32(r,f,!0),r+=4),l!==bp&&(i|=dp.RIGHT_TANGENT,t.setFloat32(r,l,!0),r+=4),u!==Cp&&(i|=dp.RIGHT_TANGENT_WEIGHT,t.setFloat32(r,u,!0),r+=4),i|=p<<8,t.setUint32(o,i,!0),r}function Rp(t,e,n){var i=n,r=t.getUint32(i,!0);i+=4,e.value=t.getFloat32(i,!0),i+=4,r&dp.INTERPOLATION_MODE&&(e.interpolationMode=t.getUint8(i),i+=1),r&dp.TANGENT_WEIGHT_MODE&&(e.tangentWeightMode=t.getUint8(i),i+=1),r&dp.LEFT_TANGENT&&(e.leftTangent=t.getFloat32(i,!0),i+=4),r&dp.LEFT_TANGENT_WEIGHT&&(e.leftTangentWeight=t.getFloat32(i,!0),i+=4),r&dp.RIGHT_TANGENT&&(e.rightTangent=t.getFloat32(i,!0),i+=4),r&dp.RIGHT_TANGENT_WEIGHT&&(e.rightTangentWeight=t.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return e.easingMethod=o,i}function Pp(t,e,n){return e+yn(t-e,n-e)}function Ip(t,e,n){return e+xn(t-e,n-e)}function Mp(t,e,n,i,r){return e+(i-e)/(n-t)*(r-t)}function Dp(t,e,n,i,r){var o=1-r;return o*o*o*t+3*o*o*r*e+3*o*r*r*n+r*r*r*i}function Op(t,e,n,i,r){var o=1-r;return o*(o*(t+(3*e-t)*r)+3*n*r*r)+i*r*r*r}u.bezier=Op;var Np,Lp,Bp,Fp,zp,kp,Up,Gp,Hp,Vp,Wp,jp=Math.cos,qp=Math.acos,Xp=Math.max,Yp=2*Math.PI,Kp=Math.sqrt;function Qp(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function Zp(t,e){var n=function(t,e){var n,i,r,o,a=e-0,s=e-t[0],c=3*a,l=3*s,u=3*(e-t[2]),h=1/(-a+l-u+(e-1)),f=1/3,p=(c-6*s+u)*h,d=p*f,_=(-c+l)*h,m=(3*_-p*p)*f,v=m*f,g=(2*p*p*p-9*p*_+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*f,T=Kp(S*S*S),E=-g/(2*T),b=qp(E<-1?-1:E>1?1:E),C=2*Qp(T);return i=C*jp(b*f)-d,r=C*jp((b+Yp)*f)-d,o=C*jp((b+2*Yp)*f)-d,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Xp(i,r,o):Xp(i,r):o>=0&&o<=1?Xp(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Xp(r,o):r:o}if(0===x)return r=-(n=y<0?Qp(-y):-Qp(y))-d,(i=2*n-d)>=0&&i<=1?r>=0&&r<=1?Xp(i,r):i:r;var A=Kp(x);return(n=Qp(-y+A))-Qp(y+A)-d}(t,e),i=t[1];return((1-n)*(i+(t[3]-i)*n)*3+n*n)*n}u.bezierByTime=Zp,function(t){t[t.SLERP=0]="SLERP",t[t.CONSTANT=1]="CONSTANT"}(Wp||(Wp=t("QuatInterpolationMode",{})));var Jp=dc("cc.QuatKeyframeValue")(Np=bc((Bp=lt((Lp=function(t){var e=void 0===t?{}:t,n=e.value,i=e.interpolationMode,r=e.easingMethod;ct(this,"interpolationMode",Bp,this),ct(this,"value",Fp,this),ct(this,"easingMethod",zp,this),this.value=n?Ln.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wp.SLERP}}),Fp=lt(Lp.prototype,"value",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.clone(Ln.IDENTITY)}}),zp=lt(Lp.prototype,"easingMethod",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tp.LINEAR}}),Np=Lp))||Np)||Np;function $p(t){return new Jp(t)}var td,ed=t("QuatCurve",dc("cc.QuatCurve")((Vp=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",Gp,ot(e)),ct(e,"postExtrapolation",Hp,ot(e)),e}$(e,t);var n=e.prototype;return n.evaluate=function(t,e){var n;null!==(n=e)&&void 0!==n||(e=new Ln);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return e;var c=i[0],l=i[s-1];if(t<c){var u=r[0];switch(a){case il.LOOP:t=c+yn(t-c,l-c);break;case il.PING_PONG:t=c+xn(t-c,l-c);break;case il.CLAMP:default:return Ln.copy(e,u.value)}}else if(t>l){var h=r[s-1];switch(o){case il.LOOP:t=c+yn(t-c,l-c);break;case il.PING_PONG:t=c+xn(t-c,l-c);break;case il.CLAMP:default:return Ln.copy(e,h.value)}}var f=oc(i,t);if(f>=0)return Ln.copy(e,r[f].value);var p=~f,d=p-1,_=i[d],m=r[d],v=i[p],g=r[p],y=(t-_)/(v-_);switch(m.interpolationMode){default:case Wp.CONSTANT:return Ln.copy(e,m.value);case Wp.SLERP:var x=m.easingMethod,S=x===tp.LINEAR?y:Array.isArray(x)?Zp(x,y):cp(x)(y);return Ln.slerp(e,m.value,g.value,S)}},n.addKeyFrame=function(e,n){var i=new Jp(n);return t.prototype.addKeyFrame.call(this,e,i)},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return $p(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return $p(t[1])})))}},n[uh]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(t,e,n){var i=n[0];r&&t.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=fd*(r?1:o),s=i.reduce((function(t,e){var n=e.easingMethod;return t+(Array.isArray(n)?pd+4*_d:pd)}),0),c=0,l=new DataView(new ArrayBuffer(c+=cd+ld+ud*o+4*hd*o+s+a+0)),u=0,h=0;r&&(h|=td.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=cd,l.setUint32(u,o,!0),u+=ld,n.forEach((function(t,e){return l.setFloat32(u+ud*e,t,!0)})),u+=ud*o,i.forEach((function(t,e){var n=t.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*hd*e;l.setFloat32(s+0*hd,i,!0),l.setFloat32(s+1*hd,r,!0),l.setFloat32(s+2*hd,o,!0),l.setFloat32(s+3*hd,a,!0)})),u+=4*hd*o,i.forEach((function(t){var e=t.easingMethod;Array.isArray(e)?(l.setUint8(u,dd),++u,l.setFloat32(u+0*_d,e[0],!0),l.setFloat32(u+1*_d,e[1],!0),l.setFloat32(u+2*_d,e[2],!0),l.setFloat32(u+3*_d,e[3],!0),u+=4*_d):(l.setUint8(u,e),++u)}));var f=u;u+=a;var p=f;i.forEach((function(t){var e=t.interpolationMode;l.setUint8(p,e),r||(p+=fd)}));var d=new Uint8Array(l.buffer);t.writeProperty("bytes",d)}else t.writeThis()},n[hh]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=cd;var a=o&td.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=ld;var c=Array.from({length:s},(function(t,e){return i.getFloat32(r+ud*e,!0)})),l=r+=ud*s;r+=4*hd*s;var u=Array.from({length:s},(function(t,e){var n=l+4*hd*e,o=i.getFloat32(n+0*hd,!0),a=i.getFloat32(n+1*hd,!0),s=i.getFloat32(n+2*hd,!0),c=i.getFloat32(n+3*hd,!0),u=i.getUint8(r);++r;var h=$p({value:{x:o,y:a,z:s,w:c}});return u!==dd?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*_d,!0),i.getFloat32(r+1*_d,!0),i.getFloat32(r+2*_d,!0),i.getFloat32(r+3*_d,!0)],r+=4*_d),h}));if(a){var h=i.getUint8(r);++r;for(var f=0;f<s;++f)u[f].interpolationMode=h}else{for(var p=0;p<s;++p){var d=i.getUint8(r+p);u[p].interpolationMode=d}r+=s}this._times=c,this._values=u}else t.readThis()},e}(al),Gp=lt((Up=Vp).prototype,"preExtrapolation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return il.CLAMP}}),Hp=lt(Up.prototype,"postExtrapolation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return il.CLAMP}}),kp=Up))||kp);!function(t){t[t.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(td||(td={}));var nd,id,rd,od,ad,sd,cd=1,ld=4,ud=4,hd=4,fd=1,pd=1,dd=255,_d=4,md=t("ObjectCurve",dc("cc.ObjectCurve")(nd=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.prototype.evaluate=function(t){var e=this.searchKeyframe(t);if(e>=0)return this._values[e];var n=sn(~e-1,0,this._values.length-1);return this._values[n]},e}(al))||nd),vd=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Je.fastDefine("cc.Keyframe",vd,{time:0,value:0,inTangent:0,outTangent:0});var gd=function(){function t(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return t.prototype.evaluate=function(t){return e=t-this.time,n=this.coefficient,e*(e*(e*n[0]+n[1])+n[2])+n[3];var e,n},t}(),yd=dc("cc.AnimationCurve")((sd=ad=function(){function t(t){if(void 0===t&&(t=null),ct(this,"_curve",od,this),this.cachedKey=void 0,t instanceof _p)this._curve=t;else{var e=new _p;this._curve=e,e.preExtrapolation=il.LOOP,e.postExtrapolation=il.CLAMP,t?e.assignSorted(t.map((function(t){return[t.time,{interpolationMode:nl.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]}))):e.assignSorted([[0,{interpolationMode:nl.CUBIC,value:1}],[1,{interpolationMode:nl.CUBIC,value:1}]])}this.cachedKey=new gd}var e=t.prototype;return e.addKey=function(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:nl.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()},e.evaluate_slow=function(t){return this._curve.evaluate(t)},e.evaluate=function(t){var e=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=t,o=t<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case il.LOOP:r=yn(t-a,s-a)+a;break;case il.PING_PONG:r=xn(t-a,s-a)+a;break;case il.CLAMP:default:r=sn(t,a,s)}if(r>=e.time&&r<e.endTime)return e.evaluate(r);var c=this.findIndex(e,r),l=Math.min(c+1,i);return this.calcOptimizedKey(e,c,l),e.evaluate(r)},e.calcOptimizedKey=function(t,e,n){var i=this._curve.getKeyframeTime(e),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(e),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;t.index=e,t.time=i,t.endTime=r;var h=r-i,f=l-a,p=1/(h*h),d=s*h,_=u*h;t.coefficient[0]=(d+_-f-f)*p/h,t.coefficient[1]=(f+f+f-d-d-_)*p,t.coefficient[2]=s,t.coefficient[3]=a},e.findIndex=function(t,e){var n=this._curve,i=n.keyFramesCount,r=t.index;if(-1!==r)if(e>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>e)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=e)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=e?h=l:u=l;return u},Z(t,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(t){var e=t[0],n=t[1],i=new vd;return i.time=e,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(t){this._curve.assignSorted(t.map((function(t){return[t.time,{interpolationMode:nl.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]})))}},{key:"preWrapMode",get:function(){return Sd(this._curve.preExtrapolation)},set:function(t){this._curve.preExtrapolation=xd(t)}},{key:"postWrapMode",get:function(){return Sd(this._curve.postExtrapolation)},set:function(t){this._curve.postExtrapolation=xd(t)}}]),t}(),ad.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],od=lt((rd=sd).prototype,"_curve",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),id=rd))||id;function xd(t){switch(t){default:case Js.Default:case Js.Normal:case Js.Clamp:return il.CLAMP;case Js.PingPong:return il.PING_PONG;case Js.Loop:return il.LOOP}}function Sd(t){switch(t){default:case il.LINEAR:case il.CLAMP:return Js.Clamp;case il.PING_PONG:return Js.PingPong;case il.LOOP:return Js.Loop}}function Td(){var t=new _p;return t.assignSorted([[0,{interpolationMode:nl.CUBIC,value:1}],[1,{interpolationMode:nl.CUBIC,value:1}]]),t}function Ed(t,e){console.warn(t+" is deprecated, please use "+e+" instead.")}U(hs,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var bd=function(t){function e(){var e;return e=t.call(this)||this,Ed("line","Line"),e}return $(e,t),e}($o),Cd=function(t){function e(){var e;return e=t.call(this)||this,Ed("plane","Plane"),e}return $(e,t),e}(Es),Ad=function(t){function e(){var e;return e=t.call(this)||this,Ed("ray","Ray"),e}return $(e,t),e}(ta),wd=function(t){function e(){var e;return e=t.call(this)||this,Ed("triangle","Triangle"),e}return $(e,t),e}(ca),Rd=function(t){function e(){var e;return e=t.call(this)||this,Ed("sphere","Sphere"),e}return $(e,t),e}(sa),Pd=function(t){function e(){var e;return e=t.call(this)||this,Ed("aabb","AABB"),e}return $(e,t),e}(js),Id=function(t){function e(){var e;return e=t.call(this)||this,Ed("obb","OBB"),e}return $(e,t),e}(Ks),Md=function(t){function e(){var e;return e=t.call(this)||this,Ed("capsule","Capsule"),e}return $(e,t),e}(Qs),Dd=function(t){function e(){var e;return e=t.call(this)||this,Ed("frustum","Frustum"),e}return $(e,t),e}(ic),Od=Object.freeze({__proto__:null,distance:Zo,enums:Jo,intersect:hs,Line:$o,Plane:Es,Ray:ta,Triangle:ca,Sphere:sa,AABB:js,OBB:Ks,Capsule:Qs,Frustum:ic,Keyframe:vd,AnimationCurve:yd,get ERaycastMode(){return aa},line:bd,plane:Cd,ray:Ad,triangle:wd,sphere:Rd,aabb:Pd,obb:Id,capsule:Md,frustum:Dd});t("geometry",Od);var Nd={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Ld=t("Layers",function(){function t(){}return t.makeMaskInclude=function(t){for(var e,n=0,i=st(t);!(e=i()).done;)n|=e.value;return n},t.makeMaskExclude=function(e){return~t.makeMaskInclude(e)},t.addLayer=function(e,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;t.Enum[e],F(2104,e),t.Enum[e]=i,ie.value(t.Enum,String(i),e),t.BitMask[e]=i,ie.value(t.BitMask,String(i),e)}else console.warn("bitNum can't be undefined")},t.deleteLayer=function(e){if(e>19||e<0)console.warn("do not change buildin layers.");else{var n=1<<e;delete t.Enum[t.Enum[n]],delete t.Enum[n],delete t.BitMask[t.BitMask[n]],delete t.BitMask[n]}},t.nameToLayer=function(e){return void 0===e?(console.warn("name can't be undefined"),-1):r(t.Enum[e])},t.layerToName=function(e){return e>31||e<0?(console.warn("Unable to access unknown layer."),""):t.Enum[1<<e]},t}());Ld.Enum=oe(Nd),Ld.BitMask=re(J({},Nd)),u.Layers=Ld;var Bd,Fd,zd="MainFlow",kd="ForwardFlow",Ud="ShadowFlow";!function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(Bd||(Bd={})),u.RenderPassStage=Bd,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(Fd||(Fd={}));var Gd,Hd={bindings:[],layouts:{}},Vd={bindings:[],layouts:{}};!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",t[t.COUNT=7]="COUNT"}(Gd||(Gd={}));var Wd,jd=Gd.SAMPLER_SHADOWMAP,qd=Gd.COUNT-jd;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",t[t.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",t[t.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",t[t.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",t[t.COUNT=14]="COUNT"}(Wd||(Wd={}));var Xd,Yd=Wd.SAMPLER_JOINTS,Kd=Wd.COUNT-Yd;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(Xd||(Xd={}));var Qd=new cr;Qd.bufferOffsets=[0,jd+Yd,jd],Qd.samplerOffsets=[-jd,qd+Kd,qd-Yd],Qd.flexibleSet=1;var Zd=function(){};Zd.SIZE=4*(Zd.COUNT=4+(Zd.SCREEN_SIZE_OFFSET=4+(Zd.NATIVE_SIZE_OFFSET=4+(Zd.TIME_OFFSET=0)))),Zd.NAME="CCGlobal",Zd.BINDING=Gd.UBO_GLOBAL,Zd.DESCRIPTOR=new kr(Zd.BINDING,Vi.UNIFORM_BUFFER,1,Mi.ALL),Zd.LAYOUT=new xr(Xd.GLOBAL,Zd.BINDING,Zd.NAME,[new yr("cc_time",di.FLOAT4,1),new yr("cc_screenSize",di.FLOAT4,1),new yr("cc_nativeSize",di.FLOAT4,1)],1),Hd.layouts[Zd.NAME]=Zd.LAYOUT,Hd.bindings[Zd.BINDING]=Zd.DESCRIPTOR;var Jd=function(){};Jd.SIZE=4*(Jd.COUNT=4+(Jd.VIEW_PORT_OFFSET=4+(Jd.NEAR_FAR_OFFSET=4+(Jd.GLOBAL_FOG_ADD_OFFSET=4+(Jd.GLOBAL_FOG_BASE_OFFSET=4+(Jd.GLOBAL_FOG_COLOR_OFFSET=4+(Jd.AMBIENT_GROUND_OFFSET=4+(Jd.AMBIENT_SKY_OFFSET=4+(Jd.MAIN_LIT_COLOR_OFFSET=4+(Jd.MAIN_LIT_DIR_OFFSET=4+(Jd.EXPOSURE_OFFSET=4+(Jd.SCREEN_SCALE_OFFSET=4+(Jd.CAMERA_POS_OFFSET=16+(Jd.MAT_VIEW_PROJ_INV_OFFSET=16+(Jd.MAT_VIEW_PROJ_OFFSET=16+(Jd.MAT_PROJ_INV_OFFSET=16+(Jd.MAT_PROJ_OFFSET=16+(Jd.MAT_VIEW_INV_OFFSET=16+(Jd.MAT_VIEW_OFFSET=0))))))))))))))))))),Jd.NAME="CCCamera",Jd.BINDING=Gd.UBO_CAMERA,Jd.DESCRIPTOR=new kr(Jd.BINDING,Vi.UNIFORM_BUFFER,1,Mi.ALL),Jd.LAYOUT=new xr(Xd.GLOBAL,Jd.BINDING,Jd.NAME,[new yr("cc_matView",di.MAT4,1),new yr("cc_matViewInv",di.MAT4,1),new yr("cc_matProj",di.MAT4,1),new yr("cc_matProjInv",di.MAT4,1),new yr("cc_matViewProj",di.MAT4,1),new yr("cc_matViewProjInv",di.MAT4,1),new yr("cc_cameraPos",di.FLOAT4,1),new yr("cc_screenScale",di.FLOAT4,1),new yr("cc_exposure",di.FLOAT4,1),new yr("cc_mainLitDir",di.FLOAT4,1),new yr("cc_mainLitColor",di.FLOAT4,1),new yr("cc_ambientSky",di.FLOAT4,1),new yr("cc_ambientGround",di.FLOAT4,1),new yr("cc_fogColor",di.FLOAT4,1),new yr("cc_fogBase",di.FLOAT4,1),new yr("cc_fogAdd",di.FLOAT4,1),new yr("cc_nearFar",di.FLOAT4,1),new yr("cc_viewPort",di.FLOAT4,1)],1),Hd.layouts[Jd.NAME]=Jd.LAYOUT,Hd.bindings[Jd.BINDING]=Jd.DESCRIPTOR;var $d=function(){};$d.SIZE=4*($d.COUNT=4+($d.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+($d.SHADOW_COLOR_OFFSET=4+($d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+($d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+($d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+($d.SHADOW_PROJ_INFO_OFFSET=4+($d.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+($d.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+($d.MAT_LIGHT_VIEW_PROJ_OFFSET=16+($d.MAT_LIGHT_VIEW_OFFSET=16+($d.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),$d.NAME="CCShadow",$d.BINDING=Gd.UBO_SHADOW,$d.DESCRIPTOR=new kr($d.BINDING,Vi.UNIFORM_BUFFER,1,Mi.ALL),$d.LAYOUT=new xr(Xd.GLOBAL,$d.BINDING,$d.NAME,[new yr("cc_matLightPlaneProj",di.MAT4,1),new yr("cc_matLightView",di.MAT4,1),new yr("cc_matLightViewProj",di.MAT4,1),new yr("cc_shadowInvProjDepthInfo",di.FLOAT4,1),new yr("cc_shadowProjDepthInfo",di.FLOAT4,1),new yr("cc_shadowProjInfo",di.FLOAT4,1),new yr("cc_shadowNFLSInfo",di.FLOAT4,1),new yr("cc_shadowWHPBInfo",di.FLOAT4,1),new yr("cc_shadowLPNNInfo",di.FLOAT4,1),new yr("cc_shadowColor",di.FLOAT4,1),new yr("cc_planarNDInfo",di.FLOAT4,1)],1),Hd.layouts[$d.NAME]=$d.LAYOUT,Hd.bindings[$d.BINDING]=$d.DESCRIPTOR;var t_=Gd.SAMPLER_SHADOWMAP,e_=new kr(t_,Vi.SAMPLER_TEXTURE,1,Mi.FRAGMENT),n_=new Sr(Xd.GLOBAL,t_,"cc_shadowMap",di.SAMPLER2D,1);Hd.layouts.cc_shadowMap=n_,Hd.bindings[t_]=e_;var i_=Gd.SAMPLER_ENVIRONMENT,r_=new kr(i_,Vi.SAMPLER_TEXTURE,1,Mi.FRAGMENT),o_=new Sr(Xd.GLOBAL,i_,"cc_environment",di.SAMPLER_CUBE,1);Hd.layouts.cc_environment=o_,Hd.bindings[i_]=r_;var a_=Gd.SAMPLER_DIFFUSEMAP,s_=new kr(a_,Vi.SAMPLER_TEXTURE,1,Mi.FRAGMENT),c_=new Sr(Xd.GLOBAL,a_,"cc_diffuseMap",di.SAMPLER_CUBE,1);Hd.layouts.cc_diffuseMap=c_,Hd.bindings[a_]=s_;var l_=Gd.SAMPLER_SPOT_LIGHTING_MAP,u_=new kr(l_,Vi.SAMPLER_TEXTURE,1,Mi.FRAGMENT),h_=new Sr(Xd.GLOBAL,l_,"cc_spotLightingMap",di.SAMPLER2D,1);Hd.layouts.cc_spotLightingMap=h_,Hd.bindings[l_]=u_;var f_=function(){};f_.SIZE=4*(f_.COUNT=4+(f_.LIGHTINGMAP_UVPARAM=16+(f_.MAT_WORLD_IT_OFFSET=16+(f_.MAT_WORLD_OFFSET=0)))),f_.NAME="CCLocal",f_.BINDING=Wd.UBO_LOCAL,f_.DESCRIPTOR=new kr(f_.BINDING,Vi.UNIFORM_BUFFER,1,Mi.VERTEX|Mi.COMPUTE),f_.LAYOUT=new xr(Xd.LOCAL,f_.BINDING,f_.NAME,[new yr("cc_matWorld",di.MAT4,1),new yr("cc_matWorldIT",di.MAT4,1),new yr("cc_lightingMapUVParam",di.FLOAT4,1)],1),Vd.layouts[f_.NAME]=f_.LAYOUT,Vd.bindings[f_.BINDING]=f_.DESCRIPTOR;var p_=function(){};p_.SIZE=4*(p_.COUNT=4+(p_.WORLD_BOUND_HALF_EXTENTS=4+(p_.WORLD_BOUND_CENTER=0))),p_.NAME="CCWorldBound",p_.BINDING=Wd.UBO_LOCAL,p_.DESCRIPTOR=new kr(p_.BINDING,Vi.UNIFORM_BUFFER,1,Mi.VERTEX|Mi.COMPUTE),p_.LAYOUT=new xr(Xd.LOCAL,p_.BINDING,p_.NAME,[new yr("cc_worldBoundCenter",di.FLOAT4,1),new yr("cc_worldBoundHalfExtents",di.FLOAT4,1)],1),Vd.layouts[p_.NAME]=p_.LAYOUT,Vd.bindings[p_.BINDING]=p_.DESCRIPTOR;var d_="a_matWorld0",__=function(){};__.BATCHING_COUNT=10,__.MAT_WORLDS_OFFSET=0,__.SIZE=4*(__.COUNT=16*__.BATCHING_COUNT),__.NAME="CCLocalBatched",__.BINDING=Wd.UBO_LOCAL,__.DESCRIPTOR=new kr(__.BINDING,Vi.UNIFORM_BUFFER,1,Mi.VERTEX|Mi.COMPUTE),__.LAYOUT=new xr(Xd.LOCAL,__.BINDING,__.NAME,[new yr("cc_matWorlds",di.MAT4,__.BATCHING_COUNT)],1),Vd.layouts[__.NAME]=__.LAYOUT,Vd.bindings[__.BINDING]=__.DESCRIPTOR;var m_=function(){};m_.LIGHTS_PER_PASS=1,m_.SIZE=4*(m_.COUNT=(m_.LIGHT_DIR_OFFSET=(m_.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(m_.LIGHT_COLOR_OFFSET=(m_.LIGHT_POS_OFFSET=0)+4*m_.LIGHTS_PER_PASS)+4*m_.LIGHTS_PER_PASS)+4*m_.LIGHTS_PER_PASS)+4*m_.LIGHTS_PER_PASS),m_.NAME="CCForwardLight",m_.BINDING=Wd.UBO_FORWARD_LIGHTS,m_.DESCRIPTOR=new kr(m_.BINDING,Vi.DYNAMIC_UNIFORM_BUFFER,1,Mi.FRAGMENT),m_.LAYOUT=new xr(Xd.LOCAL,m_.BINDING,m_.NAME,[new yr("cc_lightPos",di.FLOAT4,m_.LIGHTS_PER_PASS),new yr("cc_lightColor",di.FLOAT4,m_.LIGHTS_PER_PASS),new yr("cc_lightSizeRangeAngle",di.FLOAT4,m_.LIGHTS_PER_PASS),new yr("cc_lightDir",di.FLOAT4,m_.LIGHTS_PER_PASS)],1),Vd.layouts[m_.NAME]=m_.LAYOUT,Vd.bindings[m_.BINDING]=m_.DESCRIPTOR;var v_=function(){};v_.LIGHTS_PER_PASS=10;var g_=function(){};g_.SIZE=4*(g_.COUNT=4+(g_.JOINTS_TEXTURE_INFO_OFFSET=0)),g_.NAME="CCSkinningTexture",g_.BINDING=Wd.UBO_SKINNING_TEXTURE,g_.DESCRIPTOR=new kr(g_.BINDING,Vi.UNIFORM_BUFFER,1,Mi.VERTEX),g_.LAYOUT=new xr(Xd.LOCAL,g_.BINDING,g_.NAME,[new yr("cc_jointTextureInfo",di.FLOAT4,1)],1),Vd.layouts[g_.NAME]=g_.LAYOUT,Vd.bindings[g_.BINDING]=g_.DESCRIPTOR;var y_=function(){};y_.SIZE=4*(y_.COUNT=4+(y_.JOINTS_ANIM_INFO_OFFSET=0)),y_.NAME="CCSkinningAnimation",y_.BINDING=Wd.UBO_SKINNING_ANIMATION,y_.DESCRIPTOR=new kr(y_.BINDING,Vi.UNIFORM_BUFFER,1,Mi.VERTEX),y_.LAYOUT=new xr(Xd.LOCAL,y_.BINDING,y_.NAME,[new yr("cc_jointAnimInfo",di.FLOAT4,1)],1),Vd.layouts[y_.NAME]=y_.LAYOUT,Vd.bindings[y_.BINDING]=y_.DESCRIPTOR;var x_="a_jointAnimInfo",S_=function(){};S_.SIZE=4*(S_.COUNT=360+(S_.JOINTS_OFFSET=0)),S_.NAME="CCSkinning",S_.BINDING=Wd.UBO_SKINNING_TEXTURE,S_.DESCRIPTOR=new kr(S_.BINDING,Vi.UNIFORM_BUFFER,1,Mi.VERTEX),S_.LAYOUT=new xr(Xd.LOCAL,S_.BINDING,S_.NAME,[new yr("cc_joints",di.FLOAT4,90)],1),Vd.layouts[S_.NAME]=S_.LAYOUT,Vd.bindings[S_.BINDING]=S_.DESCRIPTOR;var T_=function(){};T_.MAX_MORPH_TARGET_COUNT=60,T_.OFFSET_OF_WEIGHTS=0,T_.OFFSET_OF_VERTICES_COUNT=4+(T_.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(T_.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*T_.MAX_MORPH_TARGET_COUNT)),T_.COUNT_BASE_4_BYTES=4*Math.ceil(T_.MAX_MORPH_TARGET_COUNT/4)+4,T_.SIZE=4*T_.COUNT_BASE_4_BYTES,T_.NAME="CCMorph",T_.BINDING=Wd.UBO_MORPH,T_.DESCRIPTOR=new kr(T_.BINDING,Vi.UNIFORM_BUFFER,1,Mi.VERTEX),T_.LAYOUT=new xr(Xd.LOCAL,T_.BINDING,T_.NAME,[new yr("cc_displacementWeights",di.FLOAT4,T_.MAX_MORPH_TARGET_COUNT/4),new yr("cc_displacementTextureInfo",di.FLOAT4,1)],1),Vd.layouts[T_.NAME]=T_.LAYOUT,Vd.bindings[T_.BINDING]=T_.DESCRIPTOR;var E_=function(){};E_.NAME="CCUILocal",E_.BINDING=Wd.UBO_UI_LOCAL,E_.DESCRIPTOR=new kr(E_.BINDING,Vi.DYNAMIC_UNIFORM_BUFFER,1,Mi.VERTEX),E_.LAYOUT=new xr(Xd.LOCAL,E_.BINDING,E_.NAME,[new yr("cc_local_data",di.FLOAT4,1)],1),Vd.layouts[E_.NAME]=E_.LAYOUT,Vd.bindings[E_.BINDING]=E_.DESCRIPTOR;var b_=Wd.SAMPLER_JOINTS,C_=new kr(b_,Vi.SAMPLER_TEXTURE,1,Mi.VERTEX),A_=new Sr(Xd.LOCAL,b_,"cc_jointTexture",di.SAMPLER2D,1);Vd.layouts.cc_jointTexture=A_,Vd.bindings[b_]=C_;var w_=Wd.SAMPLER_MORPH_POSITION,R_=new kr(w_,Vi.SAMPLER_TEXTURE,1,Mi.VERTEX),P_=new Sr(Xd.LOCAL,w_,"cc_PositionDisplacements",di.SAMPLER2D,1);Vd.layouts.cc_PositionDisplacements=P_,Vd.bindings[w_]=R_;var I_=Wd.SAMPLER_MORPH_NORMAL,M_=new kr(I_,Vi.SAMPLER_TEXTURE,1,Mi.VERTEX),D_=new Sr(Xd.LOCAL,I_,"cc_NormalDisplacements",di.SAMPLER2D,1);Vd.layouts.cc_NormalDisplacements=D_,Vd.bindings[I_]=M_;var O_=Wd.SAMPLER_MORPH_TANGENT,N_=new kr(O_,Vi.SAMPLER_TEXTURE,1,Mi.VERTEX),L_=new Sr(Xd.LOCAL,O_,"cc_TangentDisplacements",di.SAMPLER2D,1);Vd.layouts.cc_TangentDisplacements=L_,Vd.bindings[O_]=N_;var B_=Wd.SAMPLER_LIGHTMAP,F_=new kr(B_,Vi.SAMPLER_TEXTURE,1,Mi.FRAGMENT),z_=new Sr(Xd.LOCAL,B_,"cc_lightingMap",di.SAMPLER2D,1);Vd.layouts.cc_lightingMap=z_,Vd.bindings[B_]=F_;var k_=Wd.SAMPLER_SPRITE,U_=new kr(k_,Vi.SAMPLER_TEXTURE,1,Mi.FRAGMENT),G_=new Sr(Xd.LOCAL,k_,"cc_spriteTexture",di.SAMPLER2D,1);Vd.layouts.cc_spriteTexture=G_,Vd.bindings[k_]=U_;var H_=Wd.SAMPLER_REFLECTION,V_=new kr(H_,Vi.SAMPLER_TEXTURE,1,Mi.FRAGMENT),W_=new Sr(Xd.LOCAL,H_,"cc_reflectionTexture",di.SAMPLER2D,1);Vd.layouts.cc_reflectionTexture=W_,Vd.bindings[H_]=V_;var j_=Wd.STORAGE_REFLECTION,q_=new kr(j_,Vi.STORAGE_IMAGE,1,Mi.COMPUTE),X_=new br(Xd.LOCAL,j_,"cc_reflectionStorage",di.IMAGE2D,1);Vd.layouts.cc_reflectionStorage=X_,Vd.bindings[j_]=q_;var Y_,K_,Q_=Ld.makeMaskExclude([Ld.BitMask.UI_2D,Ld.BitMask.GIZMOS,Ld.BitMask.EDITOR,Ld.BitMask.SCENE_GIZMO,Ld.BitMask.PROFILER]),Z_=Ld.makeMaskExclude([Ld.BitMask.UI_2D,Ld.BitMask.PROFILER]),J_=Ld.Enum.ALL;function $_(t){return t.hasFeature(hi.COLOR_FLOAT)&&t.hasFeature(hi.TEXTURE_FLOAT)&&!(t.gfxAPI===li.WEBGL)}t("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:zd,PIPELINE_FLOW_FORWARD:kd,PIPELINE_FLOW_SHADOW:Ud,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Bd},get RenderPriority(){return Fd},globalDescriptorSetLayout:Hd,localDescriptorSetLayout:Vd,get PipelineGlobalBindings(){return Gd},get ModelLocalBindings(){return Wd},get SetIndex(){return Xd},bindingMappingInfo:Qd,UBOGlobal:Zd,UBOCamera:Jd,UBOShadow:$d,UNIFORM_SHADOWMAP_BINDING:t_,UNIFORM_ENVIRONMENT_BINDING:i_,UNIFORM_DIFFUSEMAP_BINDING:a_,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:l_,UBOLocal:f_,UBOWorldBound:p_,INST_MAT_WORLD:d_,UBOLocalBatched:__,UBOForwardLight:m_,UBODeferredLight:v_,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:g_,UBOSkinningAnimation:y_,INST_JOINT_ANIM_INFO:x_,UBOSkinning:S_,UBOMorph:T_,UBOUILocal:E_,UNIFORM_JOINT_TEXTURE_BINDING:b_,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:w_,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:I_,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:O_,UNIFORM_LIGHTMAP_TEXTURE_BINDING:B_,UNIFORM_SPRITE_TEXTURE_BINDING:k_,UNIFORM_REFLECTION_TEXTURE_BINDING:H_,UNIFORM_REFLECTION_STORAGE_BINDING:j_,CAMERA_DEFAULT_MASK:Q_,CAMERA_EDITOR_MASK:Z_,MODEL_ALWAYS_MASK:J_,supportsHalfFloatTexture:function(t){return t.hasFeature(hi.COLOR_HALF_FLOAT)&&t.hasFeature(hi.TEXTURE_HALF_FLOAT)&&!(t.gfxAPI===li.WEBGL)},supportsFloatTexture:$_}));var tm=4227858432,em=66060288,nm=1044480,im=function(t,e,n,i){return void 0===i&&(i=0),e<<26&tm|t<<20&em|n<<12&nm|4095&i},rm=function(t){return(t&tm)>>>26},om=function(t){return(t&em)>>>20},am=function(t){return(t&nm)>>>12},sm=function(t){return 4095&t},cm=function(t,e){return 67108863&t|e<<26&tm},lm=((Y_={})[di.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Y_[di.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]},Y_[di.INT2]=function(t,e,n){return void 0===n&&(n=0),Xn.fromArray(e,t,n)},Y_[di.INT3]=function(t,e,n){return void 0===n&&(n=0),Rn.fromArray(e,t,n)},Y_[di.INT4]=function(t,e,n){return void 0===n&&(n=0),Zn.fromArray(e,t,n)},Y_[di.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]},Y_[di.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),Xn.fromArray(e,t,n)},Y_[di.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),Rn.fromArray(e,t,n)},Y_[di.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),Zn.fromArray(e,t,n)},Y_[di.MAT3]=function(t,e,n){return void 0===n&&(n=0),Dn.fromArray(e,t,n)},Y_[di.MAT4]=function(t,e,n){return void 0===n&&(n=0),Vn.fromArray(e,t,n)},Y_),um=((K_={})[di.UNKNOWN]=function(){return console.warn("illegal uniform handle")},K_[di.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},K_[di.INT2]=function(t,e,n){return void 0===n&&(n=0),Xn.toArray(t,e,n)},K_[di.INT3]=function(t,e,n){return void 0===n&&(n=0),Rn.toArray(t,e,n)},K_[di.INT4]=function(t,e,n){return void 0===n&&(n=0),Zn.toArray(t,e,n)},K_[di.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},K_[di.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),Xn.toArray(t,e,n)},K_[di.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),Rn.toArray(t,e,n)},K_[di.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),Zn.toArray(t,e,n)},K_[di.MAT3]=function(t,e,n){return void 0===n&&(n=0),Dn.toArray(t,e,n)},K_[di.MAT4]=function(t,e,n){return void 0===n&&(n=0),Vn.toArray(t,e,n)},K_),hm=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function fm(t){switch(t){case di.BOOL:case di.INT:case di.UINT:case di.FLOAT:return hm[0];case di.BOOL2:case di.INT2:case di.UINT2:case di.FLOAT2:return hm[1];case di.BOOL4:case di.INT4:case di.UINT4:case di.FLOAT4:return hm[2];case di.MAT4:return hm[3];case di.SAMPLER2D:return"default-texture";case di.SAMPLER_CUBE:return"default-cube-texture"}return hm[0]}function pm(t,e){for(var n=Object.entries(e),i=!1,r=0;r<n.length;r++)t[n[r][0]]!==n[r][1]&&(t[n[r][0]]=n[r][1],i=!0);return i}var dm=new Ur;function _m(t){return Math.ceil(Math.log2(Math.max(t,2)))}function mm(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn("unknown define type '"+t.type+"'"),"-1"}}function vm(t,e,n,i,r){for(var o=t.builtins[i],a=[],s=function(t){var e=o.blocks[t],i=n.layouts[e.name],s=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&s&&s.descriptorType&$r))return console.warn("builtin UBO '"+e.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(e.shaderInfo.blocks,a);for(var l=[],u=function(t){var e=o.samplerTextures[t],i=n.layouts[e.name],a=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&a&&a.descriptorType&to))return console.warn("builtin samplerTexture '"+e.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(e.shaderInfo.samplerTextures,l),r&&r.sort((function(t,e){return t.binding-e.binding}))}function gm(t){return t.members.reduce((function(t,e){return t+so(e.type)*e.count}),0)}function ym(t,e){for(var n=0;n<t.length;n++){var i=t[n];if("!"===i[0]){if(e[i.slice(1)])return!1}else if(!e[i])return!1}return!0}function xm(t){switch(t.gfxAPI){case li.GLES2:case li.WEBGL:return"glsl1";case li.GLES3:case li.WEBGL2:return"glsl3";default:return"glsl4"}}var Sm,Tm,Em,bm,Cm,Am,wm,Rm,Pm=new(function(){function t(){this._templates={},this._cache={},this._templateInfos={}}var e=t.prototype;return e.register=function(t){for(var e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name;for(var n=0;n<t.techniques.length;n++)for(var i=t.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},e.define=function(t){var e=this._templates[t.name];if(e&&e.hash===t.hash)return e;for(var n=J({},t),i=0,r=function(t){var e=n.defines[t],r=1;if("number"===e.type){var o=e.range;r=_m(o[1]-o[0]+1),e._map=function(t){return t-o[0]}}else"string"===e.type?(r=_m(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex((function(e){return e===t})))}):"boolean"===e.type&&(e._map=function(t){return t?1:0});e._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[t.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Pr,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(gm(l)),s.bindings.push(new kr(l.binding,Vi.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new xr(Xd.MATERIAL,l.binding,l.name,l.members.map((function(t){return new yr(t.name,t.type,t.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new kr(h.binding,Vi.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Sr(Xd.MATERIAL,h.binding,h.name,h.type,h.count))}for(var f=0;f<n.samplers.length;f++){var p=n.samplers[f];s.bindings.push(new kr(p.binding,Vi.SAMPLER,p.count,p.stageFlags)),s.shaderInfo.samplers.push(new Tr(Xd.MATERIAL,p.binding,p.name,p.count))}for(var d=0;d<n.textures.length;d++){var _=n.textures[d];s.bindings.push(new kr(_.binding,Vi.TEXTURE,_.count,_.stageFlags)),s.shaderInfo.textures.push(new Er(Xd.MATERIAL,_.binding,_.name,_.type,_.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new kr(v.binding,Vi.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Cr(Xd.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new kr(y.binding,Vi.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new br(Xd.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<n.subpassInputs.length;x++){var S=n.subpassInputs[x];s.bindings.push(new kr(S.binding,Vi.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new Ar(Xd.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var T=0;T<n.attributes.length;T++){var E=n.attributes[T];s.gfxAttributes.push(new Rr(E.name,E.format,E.isNormalized,0,E.isInstanced,E.location))}vm(n,s,Vd,"locals"),s.shaderInfo.stages.push(new wr(Mi.VERTEX,"")),s.shaderInfo.stages.push(new wr(Mi.FRAGMENT,"")),s.handleMap=function(t){for(var e={},n=0;n<t.blocks.length;n++)for(var i=t.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];e[s.name]=im(i.binding,s.type,s.count,o),o+=(so(s.type)>>2)*s.count}for(var c=0;c<t.samplerTextures.length;c++){var l=t.samplerTextures[c];e[l.name]=im(l.binding,l.type,l.count)}return e}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},e.getTemplate=function(t){return this._templates[t]},e.getTemplateInfo=function(t){var e=this._templates[t].hash;return this._templateInfos[e]},e.getDescriptorSetLayout=function(t,e,n){void 0===n&&(n=!1);var i=this._templates[e],r=this._templateInfos[i.hash];return r.setLayouts.length||(dm.bindings=r.bindings,r.setLayouts[Xd.MATERIAL]=t.createDescriptorSetLayout(dm),dm.bindings=Vd.bindings,r.setLayouts[Xd.LOCAL]=t.createDescriptorSetLayout(dm)),r.setLayouts[n?Xd.LOCAL:Xd.MATERIAL]},e.hasProgram=function(t){return void 0!==this._templates[t]},e.getKey=function(t,e){var n=this._templates[t],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=e[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],f=e[h.name];f&&h._map&&(l|=h._map(f)<<h._offset)}return l.toString(16)+"|"+n.hash},e.destroyShaderByDefines=function(t){var e=this,n=Object.keys(t);if(n.length)for(var i=n.map((function(e){var n=t[e];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+e+n)})),r=Object.keys(this._cache).filter((function(t){return i.every((function(n){return n.test(e._cache[t].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];b("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},e.getGFXShader=function(t,e,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(e,n));var o=this._cache[r];if(o)return o;var a=this._templates[e],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(t,e),vm(a,s,Hd,"globals"),s.setLayouts[Xd.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=t.createPipelineLayout(new Hr(s.setLayouts)));var c=function(t,e){for(var n=[],i=0;i<e.length;i++){var r=e[i],o=r.name,a=t[o],s=mm(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(t,e){return t+"#define "+e.name+" "+e.value+"\n"}),""),u=a.glsl3,h=xm(t);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(t,e,n){for(var i=[],r=t.attributes,o=e.gfxAttributes,a=0;a<r.length;a++)ym(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(t,e){return t+e.reduce((function(t,e){return e.isDefault?t:t+"|"+e.name+e.value}),"")}(e,c),this._cache[r]=t.createShader(s.shaderInfo)},t}());u.programLib=Pm;var Im=t("EffectAsset",dc("cc.EffectAsset")((Rm=wm=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"techniques",Em,ot(e)),ct(e,"shaders",bm,ot(e)),ct(e,"combinations",Cm,ot(e)),ct(e,"hideInEditor",Am,ot(e)),e}$(e,t),e.register=function(t){e._effects[t.name]=t},e.remove=function(t){if("string"!=typeof t)e._effects[t.name]&&e._effects[t.name].equals(t)&&delete e._effects[t.name];else{if(e._effects[t])return void delete e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return void delete e._effects[n]}},e.get=function(t){if(e._effects[t])return e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return e._effects[n];return null},e.getAll=function(){return e._effects};var n=e.prototype;return n.onLoaded=function(){Pm.register(this),e.register(this),u.game.once(u.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var t=this,e=u.director.root,n=function(n){var i=t.shaders[n],r=t.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(t,e){return t.reduce((function(t,n){for(var i=r[e],o=0;o<i.length;++o){var a=J({},n);a[e]=i[o],t.push(a)}return t}),[])}),[{}]).forEach((function(t){return Pm.getGFXShader(e.device,i.name,t,e.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return e.remove(this),t.prototype.destroy.call(this)},n.initDefault=function(n){t.prototype.initDefault.call(this,n);var i=e.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},e}(Du),wm._effects={},Em=lt((Tm=Rm).prototype,"techniques",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bm=lt(Tm.prototype,"shaders",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cm=lt(Tm.prototype,"combinations",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Am=lt(Tm.prototype,"hideInEditor",[xc,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Sm=Tm))||Sm);u.EffectAsset=Im;var Mm,Dm,Om,Nm,Lm,Bm,Fm,zm,km,Um,Gm,Hm,Vm,Wm,jm,qm=1024;!function(t){t[t.RGB565=fi.R5G6B5]="RGB565",t[t.RGB5A1=fi.RGB5A1]="RGB5A1",t[t.RGBA4444=fi.RGBA4]="RGBA4444",t[t.RGB888=fi.RGB8]="RGB888",t[t.RGB32F=fi.RGB32F]="RGB32F",t[t.RGBA8888=fi.RGBA8]="RGBA8888",t[t.RGBA32F=fi.RGBA32F]="RGBA32F",t[t.A8=fi.A8]="A8",t[t.I8=fi.L8]="I8",t[t.AI8=fi.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=fi.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=fi.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=qm++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=fi.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=fi.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=qm++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=fi.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=qm++]="RGBA_ETC1",t[t.RGB_ETC2=fi.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=fi.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=fi.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=fi.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=fi.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=fi.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=fi.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=fi.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=fi.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=fi.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=fi.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=fi.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=fi.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=fi.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=fi.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=fi.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Mm||(Mm={})),function(t){t[t.REPEAT=Ci.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=Ci.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=Ci.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=Ci.BORDER]="CLAMP_TO_BORDER"}(Dm||(Dm={})),function(t){t[t.NONE=bi.NONE]="NONE",t[t.LINEAR=bi.LINEAR]="LINEAR",t[t.NEAREST=bi.POINT]="NEAREST"}(Om||(Om={})),ce(fi);var Xm,Ym,Km,Qm,Zm=new mt("Tex"),Jm=dc("cc.TextureBase")((jm=Wm=function(t){function e(){var e;return ct(e=t.call(this)||this,"_format",Bm,ot(e)),ct(e,"_minFilter",Fm,ot(e)),ct(e,"_magFilter",zm,ot(e)),ct(e,"_mipFilter",km,ot(e)),ct(e,"_wrapS",Um,ot(e)),ct(e,"_wrapT",Gm,ot(e)),ct(e,"_wrapR",Hm,ot(e)),ct(e,"_anisotropy",Vm,ot(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new gr,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=Zm.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=go(e._id,666),e}$(e,t);var n=e.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(t,e,n){void 0===n&&(n=t),this._wrapS=t,this._samplerInfo.addressU=t,this._wrapT=e,this._samplerInfo.addressV=e,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(t,e){this._minFilter=t,this._samplerInfo.minFilter=t,this._magFilter=e,this._samplerInfo.magFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(t){this._mipFilter=t,this._samplerInfo.mipFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(t){this._anisotropy=t,this._samplerInfo.maxAnisotropy=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var e,n=t.prototype.destroy.call(this);return n&&(null===(e=u.director.root)||void 0===e?void 0:e.batcher2D)&&u.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):O(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(t){var e=t.split(",");e.unshift(""),e.length>=5&&(this.setFilters(parseInt(e[1]),parseInt(e[2])),this.setWrapMode(parseInt(e[3]),parseInt(e[4]))),e.length>=7&&(this.setMipFilter(parseInt(e[5])),this.setAnisotropy(parseInt(e[6])))},n._getGFXDevice=function(){return u.director.root?u.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(t){this._format=void 0===t?Mm.RGBA8888:t},n._getGFXPixelFormat=function(t){return t===Mm.RGBA_ETC1?t=Mm.RGB_ETC1:t===Mm.RGB_A_PVRTC_4BPPV1?t=Mm.RGB_PVRTC_4BPPV1:t===Mm.RGB_A_PVRTC_2BPPV1&&(t=Mm.RGB_PVRTC_2BPPV1),t},Z(e,[{key:"isCompressed",get:function(){return this._format>=Mm.RGB_ETC1&&this._format<=Mm.RGBA_ASTC_12x12||this._format>=Mm.RGB_A_PVRTC_2BPPV1&&this._format<=Mm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(Du),Wm.PixelFormat=Mm,Wm.WrapMode=Dm,Wm.Filter=Om,Bm=lt((Lm=jm).prototype,"_format",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mm.RGBA8888}}),Fm=lt(Lm.prototype,"_minFilter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Om.LINEAR}}),zm=lt(Lm.prototype,"_magFilter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Om.LINEAR}}),km=lt(Lm.prototype,"_mipFilter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Om.NONE}}),Um=lt(Lm.prototype,"_wrapS",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dm.REPEAT}}),Gm=lt(Lm.prototype,"_wrapT",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dm.REPEAT}}),Hm=lt(Lm.prototype,"_wrapR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dm.REPEAT}}),Vm=lt(Lm.prototype,"_anisotropy",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nm=Lm))||Nm;function $m(t){return!!(u.sys.hasFeature(u.sys.Feature.IMAGE_BITMAP)&&t instanceof ImageBitmap)}u.TextureBase=Jm;var tv=t("ImageAsset",dc("cc.ImageAsset")((Qm=Km=function(t){function e(e){var n;return(n=t.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=Mm.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&n.reset(e),n}$(e,t);var n=e.prototype;return n.reset=function(t){$m(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):$m(this.data)&&this.data.close&&this.data.close(),t.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(t){var n="";"string"==typeof t?n=t:(this._width=t.w,this._height=t.h,n=t.fmt);for(var i,r=u.director.root?u.director.root.device:null,o=n.split("_"),a=Number.MAX_VALUE,s=this._format,c="",l=u.macro.SUPPORT_TEXTURE_FORMATS,h=st(o);!(i=h()).done;){var f=i.value.split("@"),p=parseInt(f[0],void 0),d=e.extnames[p]||f[0],_=l.indexOf(d);if(-1!==_&&_<a){var m=f[1]?parseInt(f[1]):this._format;if(!(".astc"!==d||r&&r.hasFeature(hi.FORMAT_ASTC)))continue;if(!(".pvr"!==d||r&&r.hasFeature(hi.FORMAT_PVRTC)))continue;if(!(m!==Mm.RGB_ETC1&&m!==Mm.RGBA_ETC1||r&&r.hasFeature(hi.FORMAT_ETC1)))continue;if(!(m!==Mm.RGB_ETC2&&m!==Mm.RGBA_ETC2||r&&r.hasFeature(hi.FORMAT_ETC2)))continue;if(".webp"===d&&!u.sys.hasFeature(u.sys.Feature.WEBP))continue;a=_,c=d,s=m}}c?(this._setRawAsset(c),this._format=s):M(3121)},n.initDefault=function(n){if(t.prototype.initDefault.call(this,n),e._sharedPlaceHolderCanvas)this.reset(e._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),e._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},Z(e,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(t){t instanceof HTMLElement||$m(t)||(t.format=t.format||this._format),this.reset(t)}},{key:"data",get:function(){return this._nativeData&&((t=this._nativeData)instanceof HTMLImageElement||t instanceof HTMLCanvasElement||$m(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Mm.RGB_ETC1&&this._format<=Mm.RGBA_ASTC_12x12||this._format>=Mm.RGB_A_PVRTC_2BPPV1&&this._format<=Mm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),e}(Du),Km.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Km._sharedPlaceHolderCanvas=null,lt((Ym=Qm).prototype,"_nativeAsset",[ol],Object.getOwnPropertyDescriptor(Ym.prototype,"_nativeAsset"),Ym.prototype),Xm=Ym))||Xm);u.ImageAsset=tv;var ev=new WeakMap,nv=new WeakSet,iv=new WeakSet;function rv(t,e){var n;n=nh.safeFindClass;var i,r=bh.pool.get();try{i=Bh(t,r,{classFinder:n,customEnv:e})}catch(t){throw T(t),bh.pool.put(r),t}i._uuid=e.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:Nl(h),owner:a[u],prop:s[u],type:ie._getClassById(c[u])}}return ev.set(i,l),i._native&&nv.add(i),bh.pool.put(r),i}var ov,av=new(function(){function t(){this._depends=new vl}var e=t.prototype;return e.init=function(){this._depends.clear()},e.getNativeDep=function(t){var e=this._depends.get(t);return e&&e.nativeDep?J({},e.nativeDep):null},e.getDeps=function(t){return this._depends.has(t)?this._depends.get(t).deps:[]},e.getDepsRecursively=function(t){var e=Object.create(null),n=[];return this._descend(t,e,n),n},e.remove=function(t){this._depends.remove(t)},e.parse=function(t,e){var n,i,r=null;if(Array.isArray(e)||e.__type__||e instanceof fh){if(this._depends.has(t))return this._depends.get(t);if(!Array.isArray(e)||"number"==typeof(i=(n=e[5])[n.length-1])&&i<0)try{var o=rv(e,{__uuid__:t});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=t),Tl.add(t+"@import",o)}catch(e){Sl.remove(t+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(e)}}else{if(this._depends.has(t)&&(r=this._depends.get(t)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(e)}return this._depends.add(t,r),r},e._parseDepsFromAsset=function(t){for(var e={deps:[],parsedFromExistAsset:!0},n=ev.get(t),i=0,r=n.length;i<r;i++)e.deps.push(n[i].uuid);return nv.has(t)&&(e.nativeDep=t._nativeDep),e},e._parseDepsFromJson=function(t){var e=function(t){return n=(e=t)[1],e[10].map((function(t){return n[t]}));var e,n}(t);return e.forEach((function(t,n){return e[n]=Nl(t)})),e},e._descend=function(t,e,n){for(var i=this.getDeps(t),r=0;r<i.length;r++){var o=i[r];e[o]||(e[o]=!0,n.push(o),this._descend(o,e,n))}},t}()),sv=[new or];function cv(t){return t&&0==(t&t-1)}var lv,uv,hv,fv,pv,dv,_v=dc("cc.SimpleTexture")(ov=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gfxTexture=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e}$(e,t);var n=e.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),t.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(t,e,n){if(void 0===e&&(e=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=e)){var i=this._getGFXDevice();if(i){var r=sv[0];r.texExtent.width=this._textureWidth>>e,r.texExtent.height=this._textureHeight>>e,r.texSubres.mipLevel=e,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(t)?i.copyBuffersToTexture([t],this._gfxTexture,sv):i.copyTexImagesToTexture([t],this._gfxTexture,sv)}}},n._assignImage=function(t,e,n){var i=t.data;if(i&&(this.uploadData(i,e,n),this._checkTextureLoaded(),ue.CLEANUP_IMAGE_CACHE)){var r=av.getDeps(this._uuid),o=r.indexOf(t._uuid);-1!==o&&(ft(r,o),t.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(t){this._mipmapLevel=t<1?1:t},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var t=this._getGFXDevice();t&&this._createTexture(t)}},n._createTexture=function(t){if(0!==this._width&&0!==this._height){var e=Si.NONE;this._mipFilter!==Om.NONE&&function(t,e,n){return!(t.gfxAPI===li.WEBGL)||cv(e)&&cv(n)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){for(var n=Math.max(t,e),i=0;n;)n>>=1,i++;return i}(this._width,this._height),e=Si.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:xi.SAMPLED|xi.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e});if(n){var i=t.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},Z(e,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),e}(Jm))||ov;u.SimpleTexture=_v;var mv,vv,gv,yv,xv,Sv,Tv,Ev=t("Texture2D",(lv=dc("cc.Texture2D"),uv=Kc([tv]),lv((dv=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_mipmaps",pv,ot(e)),e}$(e,t);var n=e.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.create=function(t,e,n,i){void 0===n&&(n=Mm.RGBA8888),void 0===i&&(i=1),this.reset({width:t,height:e,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(t,e){if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),i=0;i<n;++i){var r=t+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new tv,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,ie._getClassId(tv))}},n._getGfxTextureCreateInfo=function(t){var e=new mr(yi.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new tv;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},Z(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){e._assignImage(t,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(_v),pv=lt((fv=dv).prototype,"_mipmaps",[uv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hv=fv))||hv));u.Texture2D=Ev,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(Tv||(Tv={}));var bv=t("TextureCube",dc("cc.TextureCube")((Sv=xv=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"isRGBE",gv,ot(e)),ct(e,"_mipmaps",yv,ot(e)),e}$(e,t),e.fromTexture2DArray=function(t,n){for(var i=[],r=t.length/6,o=0;o<r;o++){var a=6*o;i.push({front:t[a+Tv.front].image,back:t[a+Tv.back].image,left:t[a+Tv.left].image,right:t[a+Tv.right].image,top:t[a+Tv.top].image,bottom:t[a+Tv.bottom].image})}return(n=n||new e).mipmaps=i,n};var n=e.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(t,e){var n=this;if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=function(e){var i=t+e;Cv(n._mipmaps[i],(function(t,e){n._assignImage(t,i,e)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new tv,back:new tv,left:new tv,right:new tv,top:new tv,bottom:new tv};var o=i.mipmaps[r],a=ie._getClassId(tv);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(t){var e=new mr(yi.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new tv;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(t){return!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)}))},Z(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){Cv(t,(function(t,i){e._assignImage(t,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(_v),xv.FaceIndex=Tv,gv=lt((vv=Sv).prototype,"isRGBE",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yv=lt(vv.prototype,"_mipmaps",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mv=vv))||mv);function Cv(t,e){e(t.front,Tv.front),e(t.back,Tv.back),e(t.left,Tv.left),e(t.right,Tv.right),e(t.top,Tv.top),e(t.bottom,Tv.bottom)}u.TextureCube=bv;var Av,wv,Rv,Pv=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2554907268,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:730673320,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:4277052359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),Iv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Mv=function(){function t(){this._device=null,this._resources={}}var e=t.prototype;return e.initBuiltinRes=function(t){var e=this;this._device=t;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=0,l=0;l<4;l++)i[c]=0,i[c+1]=0,i[c+2]=0,i[c+3]=255,r[c]=0,r[c+1]=0,r[c+2]=0,r[c+3]=0,o[c]=119,o[c+1]=119,o[c+2]=119,o[c+3]=255,a[c]=255,a[c+1]=255,a[c+2]=255,a[c+3]=255,s[c]=127,s[c+1]=127,s[c+2]=255,s[c+3]=255,c+=4;var h=new Uint8Array(1024);c=0;for(var f=0;f<256;f++)h[c]=221,h[c+1]=221,h[c+2]=221,h[c+3]=255,c+=4;c=0;for(var p=0;p<8;p++){for(var d=0;d<8;d++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}c+=32;for(var _=0;_<8;_++){for(var m=0;m<8;m++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}var v={width:2,height:2,_data:i,_compressed:!1,format:Ev.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:Ev.PixelFormat.RGBA8888},y={width:2,height:2,_data:o,_compressed:!1,format:Ev.PixelFormat.RGBA8888},x={width:2,height:2,_data:a,_compressed:!1,format:Ev.PixelFormat.RGBA8888},S={width:2,height:2,_data:s,_compressed:!1,format:Ev.PixelFormat.RGBA8888},T={width:16,height:16,_data:h,_compressed:!1,format:Ev.PixelFormat.RGBA8888},E=new tv(v),b=new Ev;b._uuid="black-texture",b.image=E,n[b._uuid]=b;var C=new tv(g),A=new Ev;A._uuid="empty-texture",A.image=C,n[A._uuid]=A;var w=new bv;w._uuid="black-cube-texture",w.setMipFilter(bv.Filter.NEAREST),w.image={front:new tv(v),back:new tv(v),left:new tv(v),right:new tv(v),top:new tv(v),bottom:new tv(v)},n[w._uuid]=w;var R=new tv(y),P=new Ev;P._uuid="grey-texture",P.image=R,n[P._uuid]=P;var I=new tv(x),M=new Ev;M._uuid="white-texture",M.image=I,n[M._uuid]=M;var D=new bv;D._uuid="white-cube-texture",D.setMipFilter(bv.Filter.NEAREST),D.image={front:new tv(x),back:new tv(x),left:new tv(x),right:new tv(x),top:new tv(x),bottom:new tv(x)},n[D._uuid]=D;var O=new tv(S),N=new Ev;N._uuid="normal-texture",N.image=O,n[N._uuid]=N;var L=new tv(T),B=new Ev;B._uuid="default-texture",B.image=L,n[B._uuid]=B;var F=new bv;if(F.setMipFilter(bv.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new tv(T),back:new tv(T),left:new tv(T),right:new tv(T),top:new tv(T),bottom:new tv(T)},n[F._uuid]=F,u.SpriteFrame){var z=new u.SpriteFrame,k=E,U=new Ev;U.image=k,z.texture=U,z._uuid="default-spriteframe",n[z._uuid]=z}var G=xm(t);if(!G)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var H=Iv[G];return H?Promise.resolve().then((function(){Pv.forEach((function(t,e){var n=Object.assign(new u.EffectAsset,t);n.shaders.forEach((function(t,n){var i=H[e][n];i&&(t[G]=i)})),n.hideInEditor=!0,n.onLoaded()})),e._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+G+" but shaders of that version are not assembled in this build."))},e.get=function(t){return this._resources[t]},e._initMaterials=function(){var t=this._resources,e=[],n=new u.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),t[n._uuid]=n,e.push(n);var i=new u.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",u.color("#ffff00")),t[i._uuid]=i,e.push(i);var r=new u.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",u.color("#ff00ff")),t[r._uuid]=r,e.push(r);var o=new u.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[o._uuid]=o,e.push(o);var a=new u.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[a._uuid]=a,e.push(a);var s=new u.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[s._uuid]=s,e.push(s);var c=new u.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[c._uuid]=c,e.push(c);var l=new u.Material;l._uuid="ui-sprite-gray-material",l.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[l._uuid]=l,e.push(l);var h=new u.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[h._uuid]=h,e.push(h);var f=new u.Material;f._uuid="ui-sprite-gray-alpha-sep-material",f.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[f._uuid]=f,e.push(f);var p=new u.Material;p._uuid="ui-graphics-material",p.initialize({effectName:"graphics"}),t[p._uuid]=p,e.push(p);var d=new u.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),t[d._uuid]=d,e.push(d);var _=new u.Material;_._uuid="default-particle-gpu-material",_.initialize({effectName:"particle-gpu"}),t[_._uuid]=_,e.push(_);var m=new u.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),t[m._uuid]=m,e.push(m);var v=new u.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),t[v._uuid]=v,e.push(v);var g=new u.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[g._uuid]=g,e.push(g),u.game.on(u.Game.EVENT_GAME_INITED,(function(){for(var t=0;t<e.length;++t)for(var n=e[t],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},t}(),Dv=t("builtinResMgr",u.builtinResMgr=new Mv),Ov=t("getPhaseID",(Av=new Map,wv=0,function(t){return"number"==typeof t?t:(Av.has(t)||(Av.set(t,1<<wv),wv++),Av.get(t))})),Nv=t("InstancedBuffer",function(){function t(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.instances.length;++t){var e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0},e.merge=function(t,e,n,i){void 0===i&&(i=null);var r=e.buffer.length;if(r){var o=t.inputAssembler,a=t.descriptorSet.getTexture(B_),s=i;s||(s=t.shaders[n]);for(var c=t.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,f=u.data;u.data=new Uint8Array(h),u.data.set(f),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(e.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var p=this._device.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,32*r,r)),d=new Uint8Array(32*r),_=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<e.attributes.length;g++){var y=e.attributes[g],x=new Rr(y.name,y.format,y.isNormalized,_.length,!0);m.push(x)}d.set(e.buffer),_.push(p);var S=new Ir(m,_,v),T=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:p,data:d,ia:T,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},e.uploadBuffers=function(t){for(var e=0;e<this.instances.length;++e){var n=this.instances[e];n.count&&(n.ia.instanceCount=n.count,t.updateBuffer(n.vb,n.data))}},e.clear=function(){for(var t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1},t}()),Lv=function(){function t(t){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.batches.length;++t){for(var e=this.batches[t],n=0;n<e.vbs.length;++n)e.vbs[n].destroy();e.vbIdx.destroy(),e.ia.destroy(),e.ubo.destroy()}this.batches.length=0},e.merge=function(t,e,n){var i=t.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=t.passes[e],c=t.shaders[e],l=t.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var f=this.batches[h];if(f.vbs.length===i.length&&f.mergeCount<__.BATCHING_COUNT){u=!0;for(var p=0;p<f.vbs.length;++p)if(f.vbs[p].stride!==i[p].stride){u=!1;break}if(u){for(var d=0;d<f.vbs.length;++d){var _=i[d],m=f.vbs[d],v=f.vbDatas[d];(r=(a+f.vbCount)*_.stride)>m.size&&(m.resize(r),f.vbDatas[d]=new Uint8Array(r),f.vbDatas[d].set(v)),f.vbDatas[d].set(_.buffer,f.vbCount*_.stride)}var g=f.vbIdxData;(o=4*(a+f.vbCount))>f.vbIdx.size&&(f.vbIdx.resize(o),f.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),f.vbIdxData.set(g),g=f.vbIdxData);var y=f.vbCount,x=y+a,S=f.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var T=y;T<x;T++)g[T]=S+.1;return Vn.toArray(f.uboData,n.transform.worldMatrix,__.MAT_WORLDS_OFFSET+16*f.mergeCount),f.mergeCount||(l.bindBuffer(__.BINDING,f.ubo),l.update(),f.pass=s,f.shader=c,f.descriptorSet=l),++f.mergeCount,f.vbCount+=a,void(f.ia.vertexCount+=a)}}}for(var E=[],b=[],C=[],A=0;A<i.length;++A){var w=i[A],R=this._device.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,w.count*w.stride,w.stride));R.update(w.buffer.buffer),E.push(R),b.push(new Uint8Array(R.size)),C.push(R)}var P=this._device.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,4*a,4)),I=new Float32Array(a);I.fill(0),P.update(I),C.push(P);for(var M=t.inputAssembler.attributes,D=new Array(M.length+1),O=0;O<M.length;++O)D[O]=M[O];D[M.length]=new Rr("a_dyn_batch_id",fi.R32F,!1,i.length);var N=new Ir(D,C),L=this._device.createInputAssembler(N),B=this._device.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,__.SIZE,__.SIZE));l.bindBuffer(__.BINDING,B),l.update();var F=new Float32Array(__.COUNT);Vn.toArray(F,n.transform.worldMatrix,__.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:b,vbIdx:P,vbIdxData:I,vbCount:a,ia:L,ubo:B,uboData:F,pass:s,shader:c,descriptorSet:l})}},e.clear=function(){for(var t=0;t<this.batches.length;++t){var e=this.batches[t];e.vbCount=0,e.mergeCount=0,e.ia.vertexCount=0}},t}(),Bv=new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.DEVICE),Fv=new fr(null),zv=new Gr(null);!function(t){t[t.NONE=0]="NONE",t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(Rv||(Rv={}));var kv=function(){function t(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Ao,this._dss=new bo,this._rs=new Eo,this._priority=Fd.DEFAULT,this._stage=Bd.DEFAULT,this._phase=Ov("default"),this._primitive=Fi.TRIANGLE_LIST,this._batchingScheme=Rv.NONE,this._dynamicStates=Gi.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=t,this._device=t.device}t.fillPipelineInfo=function(t,e){void 0!==e.priority&&t._setPriority(e.priority),void 0!==e.primitive&&t._setPrimitive(e.primitive),void 0!==e.stage&&t._setStage(e.stage),void 0!==e.dynamicStates&&t._setDynamicState(e.dynamicStates),void 0!==e.phase&&t._setPhase(Ov(e.phase));var n=t._bs;if(e.blendState){var i=e.blendState,r=i.targets;r&&r.forEach((function(t,e){n.setTarget(e,t)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)},t.getPassHash=function(t){var e,n=Pm.getKey(t.program,t.defines)+","+t._primitive+","+t._dynamicStates;return n+=function(t){for(var e,n=",bs,"+t.isA2C,i=st(t.targets);!(e=i()).done;){var r=e.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(t._bs),n+=function(t){var e=",dss,"+t.depthTest+","+t.depthWrite+","+t.depthFunc;return e+=","+t.stencilTestFront+","+t.stencilFuncFront+","+t.stencilRefFront+","+t.stencilReadMaskFront,e+=","+t.stencilFailOpFront+","+t.stencilZFailOpFront+","+t.stencilPassOpFront+","+t.stencilWriteMaskFront,(e+=","+t.stencilTestBack+","+t.stencilFuncBack+","+t.stencilRefBack+","+t.stencilReadMaskBack)+","+t.stencilFailOpBack+","+t.stencilZFailOpBack+","+t.stencilPassOpBack+","+t.stencilWriteMaskBack}(t._dss),go(n+=",rs,"+(e=t._rs).cullMode+","+e.depthBias+","+e.isFrontFaceCCW,666)};var e=t.prototype;return e.initialize=function(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()},e.getHandle=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=di.UNKNOWN);var i=this._propertyHandleMap[t];return i?(n?i=cm(i,n):e&&(i=cm(i,rm(i)-e)),i+e):0},e.getBinding=function(e){var n=this.getHandle(e);return n?t.getBindingFromHandle(n):-1},e.setUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);um[r](a,n,o),this._setRootBufferDirty(!0)},e.getUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);return lm[r](a,n,o)},e.setUniformArray=function(e,n){for(var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=so(r)>>2,a=this._getBlockView(r,i),s=t.getOffsetFromHandle(e),c=0;c<n.length;c++,s+=o)null!==n[c]&&um[r](a,n[c],s);this._setRootBufferDirty(!0)},e.bindTexture=function(t,e,n){this._descriptorSet.bindTexture(t,e,n||0)},e.bindSampler=function(t,e,n){this._descriptorSet.bindSampler(t,e,n||0)},e.setDynamicState=function(t,e){var n=this._dynamics[t];n&&n.value===e||(n.value=e,n.dirty=!0)},e.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},e._setRootBufferDirty=function(t){this._rootBufferDirty=t},e.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):O(12006)},e.getInstancedBuffer=function(t){return void 0===t&&(t=0),this._instancedBuffers[t]||(this._instancedBuffers[t]=new Nv(this))},e.getBatchedBuffer=function(t){return void 0===t&&(t=0),this._batchedBuffers[t]||(this._batchedBuffers[t]=new Lv(this))},e._initNative=function(){},e._destroy=function(){},e.destroy=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++){var e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},e.resetUniform=function(e){var n=this.getHandle(e);if(n){for(var i=t.getTypeFromHandle(n),r=t.getBindingFromHandle(n),o=t.getOffsetFromHandle(n),a=t.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[e],l=c&&c.value||fm(i),u=(so(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},e.resetTexture=function(e,n){var i=this.getHandle(e);if(i){var r=t.getTypeFromHandle(i),o=t.getBindingFromHandle(i),a=this._properties[e],s=a&&a.value,c=s?s+"-texture":fm(r),l=Dv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Mo.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),f=this._device.getSampler(h);this._descriptorSet.bindSampler(o,f,n),this._descriptorSet.bindTexture(o,u,n)}},e.resetUBOs=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++)for(var e=this._shaderInfo.blocks[t],n=0,i=0;i<e.members.length;i++){for(var r=e.members[i],o=this._getBlockView(r.type,e.binding),a=this._properties[r.name],s=a&&a.value||fm(r.type),c=(so(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},e.resetTextures=function(){for(var t=0;t<this._shaderInfo.samplerTextures.length;t++)for(var e=this._shaderInfo.samplerTextures[t],n=0;n<e.count;n++)this.resetTexture(e.name,n)},e.tryCompile=function(){var e=this._root.pipeline;if(!e)return!1;this._syncBatchingScheme();var n=Pm.getGFXShader(this._device,this._programName,this._defines,e);return n?(this._shader=n,this._setPipelineLayout(Pm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},e.getShaderVariant=function(t){if(void 0===t&&(t=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!t)return this._shader;for(var e=this._root.pipeline,n=0;n<t.length;n++){var i=t[n];this._defines[i.name]=i.value}for(var r=Pm.getGFXShader(this._device,this._programName,this._defines,e),o=0;o<t.length;o++){var a=t[o];delete this._defines[a.name]}return r},e.beginChangeStatesSilently=function(){},e.endChangeStatesSilently=function(){},e._setPriority=function(t){this._priority=t},e._setStage=function(t){this._stage=t},e._setPhase=function(t){this._phase=t},e._setPrimitive=function(t){this._primitive=t},e._setState=function(t,e,n,i){this._bs=t,this._dss=e,this._rs=n,this._descriptorSet=i},e._doInit=function(e,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Fd.DEFAULT),this._setStage(Bd.DEFAULT),this._setPhase(Ov("default")),this._setPrimitive(Fi.TRIANGLE_LIST),this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=n?J({},e.defines):e.defines,this._shaderInfo=Pm.getTemplate(e.program),this._properties=e.properties||this._properties;var i=this._device;t.fillPipelineInfo(this,e),e.stateOverrides&&t.fillPipelineInfo(this,e.stateOverrides),zv.layout=Pm.getDescriptorSetLayout(this._device,e.program),this._descriptorSet=this._device.createDescriptorSet(zv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=Pm.getTemplateInfo(e.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,f=0;f<r.length;f++){var p=a[f];l.push(h),h+=Math.ceil(p/c)*c,u=p}var d=l[l.length-1]+u;d&&(Bv.size=16*Math.ceil(d/16),this._rootBuffer=i.createBuffer(Bv),this._rootBlock=new ArrayBuffer(d));for(var _=0,m=0;_<r.length;_++){var v=r[_].binding,g=a[_];Fv.buffer=this._rootBuffer,Fv.offset=l[m++],Fv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Fv);this._blocks[v]=new Float32Array(this._rootBlock,Fv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var T in this._properties){var E=this._properties[T];E.handleInfo&&(S[T]=this.getHandle.apply(this,E.handleInfo))}Object.assign(x,S)},e._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(hi.INSTANCED_ARRAYS)?this._setBatchingScheme(Rv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Rv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Rv.VB_MERGING):this._setBatchingScheme(Rv.NONE)},e._setBatchingScheme=function(t){this._batchingScheme=t},e._setDynamicState=function(t){this._dynamicStates=t},e._setHash=function(t){this._hash=t},e._getBlockView=function(t,e){return t<di.FLOAT?this._blocksInt[e]:this._blocks[e]},e._setPipelineLayout=function(t){this._pipelineLayout=t},e._initPassFromTarget=function(t,e,n,i){this._initNative(),this._setPriority(t.priority),this._setStage(t.stage),this._setPhase(t.phase),this._setBatchingScheme(t.batchingScheme),this._setPrimitive(t.primitive),this._setDynamicState(t.dynamicStates),this._setState(n,e,t.rasterizerState,t.descriptorSet),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._blocksInt=t._blocksInt,this._dynamics=t._dynamics,this._shader=t._shader,this._setPipelineLayout(Pm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t._hash^i)},Z(t,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Pm.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),t}();kv.getTypeFromHandle=rm,kv.getBindingFromHandle=om,kv.getCountFromHandle=am,kv.getOffsetFromHandle=sm;var Uv=t("PipelineStateManager",function(){function t(){}return t.getOrCreatePipelineState=function(t,e,n,i,r){var o=e.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=e.pipelineLayout,c=new Vr(r.attributes),l=new wo(n,s,i,c,e.rasterizerState,e.depthStencilState,e.blendState,e.primitive,e.dynamicStates);a=t.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},t}());Uv._PSOHashMap=new Map;var Gv=new ar,Hv=new $i;function Vv(t,e){t.x=e.x*e.x,t.y=e.y*e.y,t.z=e.z*e.z}var Wv,jv,qv,Xv,Yv,Kv,Qv,Zv,Jv,$v,tg=null;function eg(t,e,n,i,r){if(i&&i.enabled&&r===tg){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;Gv.width=Hv.width=r.window.width,Gv.height=Hv.height=r.window.height;var u=Uv.getOrCreatePipelineState(t,s[0],c[0],e,a);n.setViewport(Gv),n.setScissor(Hv),n.bindPipelineState(u),n.bindDescriptorSet(Xd.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(Xd.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var ng,ig,rg,og,ag,sg=new Zn,cg=t("Material",(Wv=dc("cc.Material"),jv=Kc(Im),Wv(($v=function(t){function e(){var e;return ct(e=t.call(this)||this,"_effectAsset",Yv,ot(e)),ct(e,"_techIdx",Kv,ot(e)),ct(e,"_defines",Qv,ot(e)),ct(e,"_states",Zv,ot(e)),ct(e,"_props",Jv,ot(e)),e._passes=[],e._hash=0,e}$(e,t),e.getHash=function(t){for(var e,n=0,i=st(t.passes);!(e=i()).done;)n^=e.value.hash;return n};var n=e.prototype;return n.initialize=function(t){this._passes.length?M(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(t),this._update())},n.reset=function(t){this.initialize(t)},n.destroy=function(){return this._doDestroy(),t.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(t){void 0===t&&(t=!0),this._props.length=this._passes.length;for(var e=0;e<this._props.length;e++)this._props[e]={};if(t)for(var n,i=st(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(t,e,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,t,e)&&(this._props[c.propertyIndex][t]=e,i=!0)}i||console.warn("illegal property name: "+t+".")},n.getProperty=function(t,e){if(void 0===e)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(t in o)return o[t]}else{if(e>=this._props.length)return console.warn("illegal pass index: "+e+"."),null;var a=this._props[this._passes[e].propertyIndex];if(t in a)return a[t]}return null},n.copy=function(t,e){this._techIdx=t._techIdx,this._props.length=t._props.length;for(var n=0;n<t._props.length;n++)this._props[n]=J({},t._props[n]);this._defines.length=t._defines.length;for(var i=0;i<t._defines.length;i++)this._defines[i]=J({},t._defines[i]);this._states.length=t._states.length;for(var r=0;r<t._states.length;r++)this._states[r]=J({},t._states[r]);this._effectAsset=t._effectAsset,e&&this._fillInfo(e),this._update()},n._fillInfo=function(t){void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Im.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states)},n._prepareInfo=function(t,e){var n=t;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(e[r]||(e[r]={}),n[r])},n._createPasses=function(){var t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];for(var e=t.passes.length,n=[],i=0;i<e;++i){var r=t.passes[i],o=r.passIndex=i,a=r.defines=this._defines[o]||(this._defines[o]={});if(r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var s=new kv(u.director.root);s.initialize(r),n.push(s)}}return n},n._update=function(t){var n=this;if(void 0===t&&(t=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,t)this._passes.forEach((function(t,e){var i=n._props[e];for(var r in i||(i=n._props[e]={}),void 0!==t.propertyIndex&&Object.assign(i,n._props[t.propertyIndex]),i)n._uploadProperty(t,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=e.getHash(this)},n._uploadProperty=function(t,e,n){var i=t.getHandle(e);if(!i)return!1;if(kv.getTypeFromHandle(i)<di.SAMPLER1D)if(Array.isArray(n))t.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=t.properties[e])||void 0===r?void 0:r.linear){var o=n;Vv(sg,o),sg.w=o.w,n=sg}t.setUniform(i,n)}else t.resetUniform(e);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(t,i,n[a],a);else n?this._bindTexture(t,i,n):t.resetTexture(e);return!0},n._bindTexture=function(t,e,n,i){var r=kv.getBindingFromHandle(e);if(n instanceof Oo)t.bindTexture(r,n,i);else if(n instanceof Jm){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;t.bindTexture(r,o,i),t.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var t,e=st(this._passes);!(t=e()).done;)t.value.destroy();this._passes.length=0},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new An("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},Z(e,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),e}(Du),Yv=lt((Xv=$v).prototype,"_effectAsset",[jv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kv=lt(Xv.prototype,"_techIdx",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qv=lt(Xv.prototype,"_defines",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zv=lt(Xv.prototype,"_states",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jv=lt(Xv.prototype,"_props",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qv=Xv))||qv));u.Material=cg,function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(ng||(ng={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(ig||(ig={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(rg||(rg={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(og||(og={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(ag||(ag={}));var lg=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],ug=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],hg=[100,200,400,800],fg=new Rn,pg=new Rn,dg=new Vn,_g=Xi.STENCIL<<1,mg=[],vg=function(){function t(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=ng.VERTICAL,this._fov=un(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new sr(.2,.2,.2,1),this._viewport=new ni(0,0,1,1),this._orientedViewport=new ni(0,0,1,1),this._curTransform=ui.IDENTITY,this._isProjDirty=!0,this._matView=new Vn,this._matProj=new Vn,this._matProjInv=new Vn,this._matViewProj=new Vn,this._matViewProjInv=new Vn,this._frustum=new ic,this._forward=new Rn,this._position=new Rn,this._priority=0,this._aperture=rg.F16_0,this._apertureValue=void 0,this._shutter=ag.D125,this._shutterValue=0,this._iso=og.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Xi.NONE,this._clearDepth=1,this._visibility=Q_,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=lg[this._aperture],this._shutterValue=ug[this._shutter],this._isoValue=hg[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!mg.length){var e=t.capabilities.clipSpaceSignY;mg[ui.IDENTITY]=new Vn(1,0,0,0,0,e),mg[ui.ROTATE_90]=new Vn(0,1,0,0,-e,0),mg[ui.ROTATE_180]=new Vn(-1,0,0,0,0,-e),mg[ui.ROTATE_270]=new Vn(0,-1,0,0,e,0)}}var e=t.prototype;return e._setWidth=function(t){this._width=t},e._setHeight=function(t){this._height=t},e._setScene=function(t){this._scene=t},e._updateAspect=function(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){var e=this.window.swapchain;(e&&e.surfaceTransform||ui.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},e._init=function(){},e.initialize=function(t){this._init(t),this.node=t.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Xi.NONE,this.clearDepth=1,this.visibility=Q_,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)},e._destroy=function(){},e.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},e.attachToScene=function(t){this._enabled=!0,this._setScene(t)},e.detachFromScene=function(){this._enabled=!1,this._setScene(null)},e.resize=function(t,e){this._window&&(this._setWidth(t),this._setHeight(e),this._updateAspect())},e.setFixedSize=function(t,e){this._setWidth(t),this._setHeight(e),this._updateAspect(!1),this.isWindowSize=!1},e.syncCameraEditor=function(){},e.update=function(t){var e;if(void 0===t&&(t=!1),this._node){var n=!1;(this._node.hasChangedFlags||t)&&(Vn.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(e=this.window)||void 0===e?void 0:e.swapchain,r=i&&i.surfaceTransform||ui.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===ig.PERSPECTIVE)Vn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===ng.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Vn.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Vn.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Vn.multiply(this._matViewProj,this._matProj,this._matView),Vn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},e.setViewportInOrientedSpace=function(t){var e,n=t.x,i=t.width,r=t.height,o=this._device.capabilities.screenSpaceSignY<0?1-t.y-r:t.y,a=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(a&&a.surfaceTransform||ui.IDENTITY){case ui.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case ui.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case ui.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case ui.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},e.changeTargetWindow=function(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);var e=t||u.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;var n=e.swapchain;(n&&n.surfaceTransform||ui.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}},e.detachCamera=function(){this._window&&this._window.detachCamera(this)},e.screenPointToRay=function(t,e,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===ig.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Hn[this._curTransform];Rn.set(fg,(e-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var f=fg.x,p=fg.y;return fg.x=f*h[0]+p*h[2]*u,fg.y=f*h[1]+p*h[3]*u,Rn.transformMat4(l?fg:t.o,fg,this._matViewProjInv),l?(this._node.getWorldPosition(pg),ta.fromPoints(t,pg,fg)):Rn.transformQuat(t.d,Rn.FORWARD,this._node.worldRotation),t},e.screenToWorld=function(t,e){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Hn[this._curTransform];if(this._proj===ig.PERSPECTIVE){Rn.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,1);var u=t.x,h=t.y;t.x=u*l[0]+h*l[2]*c,t.y=u*l[1]+h*l[3]*c,Rn.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(fg),Rn.lerp(t,fg,t,ln(this._nearClip/this._farClip,1,e.z))}else{Rn.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,2*e.z-1);var f=t.x,p=t.y;t.x=f*l[0]+p*l[2]*c,t.y=f*l[1]+p*l[3]*c,Rn.transformMat4(t,t,this._matViewProjInv)}return t},e.worldToScreen=function(t,e){var n=this._device.capabilities.clipSpaceSignY,i=Hn[this._curTransform];Rn.transformMat4(t,e,this._matViewProj);var r=t.x,o=t.y;t.x=r*i[0]+o*i[2]*n,t.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return t.x=c+.5*(t.x+1)*u,t.y=l+.5*(t.y+1)*h,t.z=.5*t.z+.5,t},e.worldMatrixToScreen=function(t,e,n,i){Vn.multiply(t,this._matViewProj,e),Vn.multiply(t,mg[this._curTransform],t);var r=n/2,o=i/2;return Vn.identity(dg),Vn.transform(dg,dg,Rn.set(fg,r,o,0)),Vn.scale(dg,dg,Rn.set(fg,r,o,1)),Vn.multiply(t,dg,t),t},e.setExposure=function(t){this._exposure=.833333/Math.pow(2,t)},e.updateExposure=function(){var t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)},Z(t,[{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(t){this._proj=t,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){this._fovAxis=t,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(t){this._nearClip=t,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(t){this._farClip=t,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}},{key:"viewport",get:function(){return this._viewport},set:function(t){M(8302),this.setViewportInOrientedSpace(t)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(t){this._frustum=t}},{key:"window",get:function(){return this._window},set:function(t){this._window=t}},{key:"forward",get:function(){return this._forward},set:function(t){this._forward=t}},{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._apertureValue=lg[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._shutterValue=ug[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._isoValue=hg[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(t){this._ec=t}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),t}(),gg=oe({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),yg=oe({Planar:0,ShadowMap:1}),xg=oe({HARD:0,SOFT:1,SOFT_2X:2}),Sg=yg.ShadowMap+1,Tg=function(){function t(){this.fixedSphere=new sa(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Vn,this.matShadowProj=new Vn,this.matShadowViewProj=new Vn,this._normal=new Rn(0,1,0),this._shadowColor=new An(0,0,0,76),this._matLight=new Vn,this._material=null,this._instancingMaterial=null,this._size=new Xn(512,512),this._enabled=!1,this._distance=0,this._type=Sg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var e=t.prototype;return e.getPlanarShader=function(t){return this._material||(this._material=new cg,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(t)},e.getPlanarInstanceShader=function(t){return this._instancingMaterial||(this._instancingMaterial=new cg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(t)},e._setEnable=function(t){this._enabled=t},e._setType=function(t){this._type=this.enabled?t:Sg},e.initialize=function(t){this.near=t.near,this.far=t.far,this.invisibleOcclusionRange=t.invisibleOcclusionRange,this.shadowDistance=t.shadowDistance,this.orthoSize=t.orthoSize,this.size=t.size,this.pcf=t.pcf,this.normal=t.normal,this.distance=t.distance,this.shadowColor=t.shadowColor,this.bias=t.bias,this.normalBias=t.normalBias,this.maxReceived=t.maxReceived,this.fixedArea=t.fixedArea,this._setEnable(t.enabled),this._setType(t.type),this.saturation=t.saturation},e.activate=function(){this.enabled&&this.type===yg.Planar&&this._updatePlanarInfo()},e._updatePlanarInfo=function(){this._material||(this._material=new cg,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new cg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},e._destroy=function(){},e.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},Z(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(t){Rn.copy(this._normal,t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor=t}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=t}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=t}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.activate()}},{key:"near",get:function(){return this._near},set:function(t){this._near=t}},{key:"far",get:function(){return this._far},set:function(t){this._far=t}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t}},{key:"size",get:function(){return this._size},set:function(t){this._size.set(t)}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(t){this._shadowMapDirty=t}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t}},{key:"saturation",get:function(){return this._saturation},set:function(t){this._saturation=t}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),t}();Tg.MAX_FAR=2e3,Tg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),u.Shadows=Tg;var Eg=new Rn,bg=(new Rn,new Rn,new Rn),Cg=new Vn,Ag=new js,wg=new js,Rg=!1,Pg=sa.create(0,0,0,1),Ig=new sa,Mg=new ic;Mg.accurate=!0;var Dg=new ic;Dg.accurate=!0;var Og=new ic,Ng=new Vn,Lg=new Vn,Bg=new Vn,Fg=new Vn,zg=new Vn,kg=new Vn,Ug=new Vn,Gg=new Rn,Hg=new Xn,Vg=new Rn,Wg=new Rn,jg=new Rn(0,0,0),qg=(new js,new Wl((function(){return{model:null,depth:0}}),128)),Xg=new Wl((function(){return{model:null,depth:0}}),128),Yg=new Wl((function(){return{model:null,depth:0}}),128);function Kg(t,e){var n=0;t.node&&(Rn.subtract(Eg,t.node.worldPosition,e.position),n=Rn.dot(Eg,e.forward));var i=qg.alloc();return i.model=t,i.depth=n,i}function Qg(t,e){var n=0;t.node&&(Rn.subtract(Eg,t.node.worldPosition,e.position),n=Rn.dot(Eg,e.forward));var i=Xg.alloc();return i.model=t,i.depth=n,i}function Zg(t,e){var n=0;t.node&&(Rn.subtract(Eg,t.node.worldPosition,e.position),n=Rn.dot(Eg,e.forward));var i=Yg.alloc();return i.model=t,i.depth=n,i}function Jg(t,e,n){var i=e.direction,r=t.normal,o=t.distance+.001,a=1/Rn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,f=r.z,p=t.matLight;p.m00=1-u*s,p.m01=-u*c,p.m02=-u*l,p.m03=0,p.m04=-h*s,p.m05=1-h*c,p.m06=-h*l,p.m07=0,p.m08=-f*s,p.m09=-f*c,p.m10=1-f*l,p.m11=0,p.m12=s*o,p.m13=c*o,p.m14=l*o,p.m15=1,Vn.toArray(n,p,$d.MAT_LIGHT_PLANE_PROJ_OFFSET)}function $g(t,e){Rn.normalize(Eg,t.normal),e[$d.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Eg.x,e[$d.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Eg.y,e[$d.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Eg.z,e[$d.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=t.distance}function ty(t,e){var n=t.pipelineSceneData.validPunctualLights;n.length=0;for(var i=e.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(sa.set(Pg,o.position.x,o.position.y,o.position.z,o.range),hs.sphereFrustum(Pg,e.frustum)&&n.push(o))}for(var a=e.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(sa.set(Pg,c.position.x,c.position.y,c.position.z,c.range),hs.sphereFrustum(Pg,e.frustum)&&n.push(c))}}function ey(t,e){var n=e.scene,i=n.mainLight,r=t.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;qg.freeArray(s),s.length=0;var c=r.castShadowObjects;Yg.freeArray(c),c.length=0,Rg=!1;var l=null;if(o.enabled&&(t.pipelineUBO.updateShadowUBORange($d.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===yg.ShadowMap))if(l=t.pipelineSceneData.dirShadowObjects,Xg.freeArray(l),l.length=0,i&&i.node)!function(t,e,n,i,r){var o=e.device;if(r.fixedArea){var a=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;Vn.fromRT(Ng,n.node.getWorldRotation(),n.node.getWorldPosition()),Vn.invert(Lg,Ng),Vn.ortho(Fg,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),Vn.multiply(zg,Fg,Lg),Vn.invert(Bg,Lg),r.matShadowView=Lg,r.matShadowProj=Fg,r.matShadowViewProj=zg,ic.createOrtho(t,2*a,2*s,c,l,Bg)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(t,e){if(e.node){var n=e.node,i=n.getWorldPosition(),r=n.getWorldRotation();Vn.fromRT(t,r,i),t.m08*=-1,t.m09*=-1,t.m10*=-1}}(Cg,i),ic.split(Mg,i,Cg,.1,r.shadowDistance),Dg=ic.clone(Mg),Vn.fromRT(Ng,n.node.rotation,jg),Vn.invert(Lg,Ng),Vn.invert(Bg,Lg);var f=Lg.clone();Dg.transform(Lg),js.fromPoints(Ag,new Rn(1e7,1e7,1e7),new Rn(-1e7,-1e7,-1e7)),Ag.mergeFrustum(Dg);var p=2*Ag.halfExtents.z;bg.set(Ag.center.x,Ag.center.y,Ag.center.z+Ag.halfExtents.z+u),Rn.transformMat4(bg,bg,Bg),Vn.fromRT(Ng,n.node.rotation,bg),Vn.invert(Lg,Ng),Vn.invert(Bg,Lg);var d=Rn.distance(Mg.vertices[0],Mg.vertices[6]);Ig.center.set(0,0,0),Ig.radius=-1,Ig.mergePoints(Mg.vertices);var _=.8*d+.4*Ig.radius;r.shadowCameraFar=p+u;var m=.5*_;if(Vn.ortho(Fg,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){Vn.multiply(kg,Fg,f),Rn.transformMat4(Gg,bg,kg);var v=2/h;Hg.set(v,v);var g=Gg.x%Hg.x,y=Gg.y%Hg.y;Vg.set(Gg.x-g,Gg.y-y,Gg.z),Vn.invert(Ug,kg),Rn.transformMat4(Wg,Vg,Ug),Vn.fromRT(Ng,n.node.rotation,Wg),Vn.invert(Lg,Ng),Vn.invert(Bg,Lg),ic.createOrtho(t,_,_,.1,r.shadowCameraFar,Bg)}else{for(var x=0;x<8;x++)t.vertices[x].set(0,0,0);t.updatePlanes()}Vn.multiply(zg,Fg,Lg),r.matShadowView=Lg,r.matShadowProj=Fg,r.matShadowViewProj=zg}}(Og,t,i,e,o);else{for(var u=0;u<8;u++)Og.vertices[u].set(0,0,0);Og.updatePlanes()}i&&o.type===yg.Planar&&function(t,e){var n=t.pipelineSceneData.shadows,i=e.direction,r=n.normal,o=n.distance+.001,a=1/Rn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,f=r.z,p=n.matLight;p.m00=1-u*s,p.m01=-u*c,p.m02=-u*l,p.m03=0,p.m04=-h*s,p.m05=1-h*c,p.m06=-h*l,p.m07=0,p.m08=-f*s,p.m09=-f*c,p.m10=1-f*l,p.m11=0,p.m12=s*o,p.m13=c*o,p.m14=l*o,p.m15=1,t.pipelineUBO.updateShadowUBORange($d.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(t,i),a.enabled&&a.model&&e.clearFlag&_g&&s.push(Kg(a.model,e));for(var h=n.models,f=e.visibility,p=0;p<h.length;p++){var d=h[p];if(d.enabled&&(d.castShadow&&c.push(Zg(d,e)),o.firstSetCSM&&d.worldBounds&&(Rg||(wg.copy(d.worldBounds),Rg=!0),js.merge(wg,wg,d.worldBounds)),d.node&&(f&d.node.layer)===d.node.layer||f&d.visFlags)){if(null!=l&&d.castShadow&&d.worldBounds&&hs.aabbFrustum(d.worldBounds,Og)&&l.push(Qg(d,e)),d.worldBounds&&!hs.aabbFrustum(d.worldBounds,e.frustum))continue;s.push(Kg(d,e))}}o.firstSetCSM&&(o.shadowDistance=2*wg.halfExtents.length(),o.firstSetCSM=!1)}var ny,iy,ry,oy=new gr(bi.LINEAR,bi.LINEAR,bi.NONE,Ci.CLAMP,Ci.CLAMP,Ci.CLAMP),ay=new gr(bi.POINT,bi.POINT,bi.NONE,Ci.CLAMP,Ci.CLAMP,Ci.CLAMP),sy=function(){function t(t){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t.device,this._linearSampler=this._device.getSampler(oy),this._pointSampler=this._device.getSampler(ay);var e=new Ur(Hd.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new Gr(this._descriptorSetLayout))}var e=t.prototype;return e.bindBuffer=function(t,e){this._globalDescriptorSet.bindBuffer(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(t,e),i=n.next()},e.bindSampler=function(t,e){this._globalDescriptorSet.bindSampler(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(t,e),i=n.next()},e.bindTexture=function(t,e){this._globalDescriptorSet.bindTexture(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(t,e),i=n.next()},e.update=function(){this._globalDescriptorSet.update();for(var t=this._descriptorSetMap.values(),e=t.next();!e.done;)e.value.update(),e=t.next()},e.getOrCreateDescriptorSet=function(t){var e=this._device;if(!this._descriptorSetMap.has(t)){var n=this._globalDescriptorSet,i=e.createDescriptorSet(new Gr(this._descriptorSetLayout));this._descriptorSetMap.set(t,i);for(var r=Gd.UBO_GLOBAL;r<Gd.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=e.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,$d.SIZE,$d.SIZE));i.bindBuffer($d.BINDING,o),i.update()}return this._descriptorSetMap.get(t)},e.destroy=function(){this._descriptorSetLayout.destroy()},Z(t,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),t}();function cy(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);var n=e*e,i=(.860117757+.000154118254*e+1.28641212e-7*n)/(1+.000842420235*e+7.08145163e-7*n),r=(.317398726+422806245e-13*e+4.20481691e-8*n)/(1-289741816e-13*e+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);t.x=3.2404542*c-1.5371385+-.4985314*l,t.y=-.969266*c+1.8760108+.041556*l,t.z=.0556434*c-.2040259+1.0572252*l}!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(ny||(ny={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(iy||(iy={})),u.internal.TransformBit=iy,function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(ry||(ry={}));var ly,uy,hy,fy,py,dy,_y,my,vy,gy,yy=function(t){return 4*Math.PI*Math.PI*t*t},xy=function(){function t(){this._baked=!1,this._color=new Rn(1,1,1),this._colorTemp=6550,this._colorTempRGB=new Rn(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=ry.UNKNOWN}var e=t.prototype;return e._init=function(){},e._destroy=function(){},e.initialize=function(){this._init(),this.color=new Rn(1,1,1),this.colorTemperature=6550},e.attachToScene=function(t){this._scene=t},e.detachFromScene=function(){this._scene=null},e.destroy=function(){this._name=null,this._node=null,this._destroy()},e.update=function(){},Z(t,[{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"color",get:function(){return this._color},set:function(t){this._color.set(t)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(t){this._colorTemp=t,cy(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,this._node&&(this._node.hasChangedFlags|=iy.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Sy=new Vn,Ty=new Vn,Ey=new Vn,by=new Zn,Cy=new Zn(0,0,1,0),Ay=function(){function t(){this._globalUBO=new Float32Array(Zd.COUNT),this._cameraUBO=new Float32Array(Jd.COUNT),this._shadowUBO=new Float32Array($d.COUNT)}t.updateGlobalUBOView=function(t,e){var n=u.director.root,i=e,r=Math.floor(t.width),o=Math.floor(t.height);i[Zd.TIME_OFFSET]=n.cumulativeTime,i[Zd.TIME_OFFSET+1]=n.frameTime,i[Zd.TIME_OFFSET+2]=u.director.getTotalFrames(),i[Zd.SCREEN_SIZE_OFFSET]=r,i[Zd.SCREEN_SIZE_OFFSET+1]=o,i[Zd.SCREEN_SIZE_OFFSET+2]=1/r,i[Zd.SCREEN_SIZE_OFFSET+3]=1/o,i[Zd.NATIVE_SIZE_OFFSET]=r,i[Zd.NATIVE_SIZE_OFFSET+1]=o,i[Zd.NATIVE_SIZE_OFFSET+2]=1/i[Zd.NATIVE_SIZE_OFFSET],i[Zd.NATIVE_SIZE_OFFSET+3]=1/i[Zd.NATIVE_SIZE_OFFSET+1]},t.updateCameraUBOView=function(t,e,n){var i=(n.scene?n.scene:u.director.getScene().renderScene).mainLight,r=t.pipelineSceneData,o=r.ambient,a=r.fog,s=r.shadows,c=e,l=n.exposure,h=r.isHDR;if(c[Jd.SCREEN_SCALE_OFFSET]=r.shadingScale,c[Jd.SCREEN_SCALE_OFFSET+1]=r.shadingScale,c[Jd.SCREEN_SCALE_OFFSET+2]=1/c[Jd.SCREEN_SCALE_OFFSET],c[Jd.SCREEN_SCALE_OFFSET+3]=1/c[Jd.SCREEN_SCALE_OFFSET+1],c[Jd.EXPOSURE_OFFSET]=l,c[Jd.EXPOSURE_OFFSET+1]=1/l,c[Jd.EXPOSURE_OFFSET+2]=h?1:0,c[Jd.EXPOSURE_OFFSET+3]=0,i){var f=s.enabled&&s.type===yg.ShadowMap?1:0,p=i.direction;if(Cy.set(p.x,p.y,p.z,f),Zn.toArray(c,Cy,Jd.MAIN_LIT_DIR_OFFSET),Rn.toArray(c,i.color,Jd.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var d=i.colorTemperatureRGB;c[Jd.MAIN_LIT_COLOR_OFFSET]*=d.x,c[Jd.MAIN_LIT_COLOR_OFFSET+1]*=d.y,c[Jd.MAIN_LIT_COLOR_OFFSET+2]*=d.z}c[Jd.MAIN_LIT_COLOR_OFFSET+3]=h?i.illuminance*l:i.illuminance}else Cy.set(0,0,1,0),Zn.toArray(c,Cy,Jd.MAIN_LIT_DIR_OFFSET),Zn.toArray(c,Zn.ZERO,Jd.MAIN_LIT_COLOR_OFFSET);var _=o.skyColor;_.w=h?o.skyIllum*l:o.skyIllum,c[Jd.AMBIENT_SKY_OFFSET+0]=_.x,c[Jd.AMBIENT_SKY_OFFSET+1]=_.y,c[Jd.AMBIENT_SKY_OFFSET+2]=_.z,c[Jd.AMBIENT_SKY_OFFSET+3]=_.w,c[Jd.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,c[Jd.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,c[Jd.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,c[Jd.AMBIENT_GROUND_OFFSET+3]=o.mipmapCount,Vn.toArray(c,n.matView,Jd.MAT_VIEW_OFFSET),Vn.toArray(c,n.node.worldMatrix,Jd.MAT_VIEW_INV_OFFSET),Rn.toArray(c,n.position,Jd.CAMERA_POS_OFFSET),Vn.toArray(c,n.matProj,Jd.MAT_PROJ_OFFSET),Vn.toArray(c,n.matProjInv,Jd.MAT_PROJ_INV_OFFSET),Vn.toArray(c,n.matViewProj,Jd.MAT_VIEW_PROJ_OFFSET),Vn.toArray(c,n.matViewProjInv,Jd.MAT_VIEW_PROJ_INV_OFFSET),c[Jd.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var m=a.colorArray;c[Jd.GLOBAL_FOG_COLOR_OFFSET]=m.x,c[Jd.GLOBAL_FOG_COLOR_OFFSET+1]=m.y,c[Jd.GLOBAL_FOG_COLOR_OFFSET+2]=m.z,c[Jd.GLOBAL_FOG_COLOR_OFFSET+3]=m.z,c[Jd.GLOBAL_FOG_BASE_OFFSET]=a.fogStart,c[Jd.GLOBAL_FOG_BASE_OFFSET+1]=a.fogEnd,c[Jd.GLOBAL_FOG_BASE_OFFSET+2]=a.fogDensity,c[Jd.GLOBAL_FOG_ADD_OFFSET]=a.fogTop,c[Jd.GLOBAL_FOG_ADD_OFFSET+1]=a.fogRange,c[Jd.GLOBAL_FOG_ADD_OFFSET+2]=a.fogAtten,c[Jd.NEAR_FAR_OFFSET]=n.nearClip,c[Jd.NEAR_FAR_OFFSET+1]=n.farClip,c[Jd.VIEW_PORT_OFFSET]=r.shadingScale*n.window.width*n.viewport.x,c[Jd.VIEW_PORT_OFFSET+1]=r.shadingScale*n.window.height*n.viewport.y,c[Jd.VIEW_PORT_OFFSET+2]=r.shadingScale*n.window.width*n.viewport.z,c[Jd.VIEW_PORT_OFFSET+3]=r.shadingScale*n.window.height*n.viewport.w},t.updateShadowUBOView=function(t,e,n){var i=t.device,r=n.scene.mainLight,o=t.pipelineSceneData.shadows,a=e;if(o.enabled){if(r&&o.type===yg.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;o.fixedArea?(s=o.near,c=o.far):(s=.1,c=o.shadowCameraFar),Vn.toArray(e,l,$d.MAT_LIGHT_VIEW_OFFSET),a[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[$d.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[$d.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[$d.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[$d.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Vn.toArray(e,h,$d.MAT_LIGHT_VIEW_PROJ_OFFSET);var f=$_(i)?0:1;a[$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=f,a[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===yg.Planar&&(Jg(o,r,a),$g(o,a));An.toArray(a,o.shadowColor,$d.SHADOW_COLOR_OFFSET)}},t.updateShadowUBOLightView=function(t,e,n){var i=t.device,r=t.pipelineSceneData.shadows,o=e,a=$_(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case ry.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),Vn.toArray(e,l,$d.MAT_LIGHT_VIEW_OFFSET),o[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[$d.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[$d.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[$d.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[$d.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Vn.toArray(e,h,$d.MAT_LIGHT_VIEW_PROJ_OFFSET),by.set(s,c,0,1-r.saturation),Zn.toArray(o,by,$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),by.set(0,a,r.normalBias,0),Zn.toArray(o,by,$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case ry.SPOT:Vn.invert(Sy,n.node.getWorldMatrix()),Vn.toArray(o,Sy,$d.MAT_LIGHT_VIEW_OFFSET),Vn.perspective(Ty,n.angle,n.aspect,.001,n.range),Vn.multiply(Ey,Ty,Sy),Vn.toArray(o,Ey,$d.MAT_LIGHT_VIEW_PROJ_OFFSET),by.set(.01,n.range,0,1-r.saturation),Zn.toArray(o,by,$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),by.set(1,a,r.normalBias,0),Zn.toArray(o,by,$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}by.set(r.size.x,r.size.y,r.pcf,r.bias),Zn.toArray(o,by,$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),An.toArray(o,r.shadowColor,$d.SHADOW_COLOR_OFFSET)},t.getCombineSignY=function(){return t._combineSignY};var e=t.prototype;return e._initCombineSignY=function(){var e=this._device;t._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},e.activate=function(t,e){this._device=t,this._pipeline=e;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=t.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,Zd.SIZE,Zd.SIZE));n.bindBuffer(Zd.BINDING,i);var r=t.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,Jd.SIZE,Jd.SIZE));n.bindBuffer(Jd.BINDING,r);var o=t.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,$d.SIZE,$d.SIZE));n.bindBuffer($d.BINDING,o)},e.updateGlobalUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),t.updateGlobalUBOView(e,this._globalUBO),r[0].updateBuffer(i.getBuffer(Zd.BINDING),this._globalUBO),n.bindBuffer(Zd.BINDING,i.getBuffer(Zd.BINDING)),n.update()},e.updateCameraUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;t.updateCameraUBOView(this._pipeline,this._cameraUBO,e),r[0].updateBuffer(i.getBuffer(Jd.BINDING),this._cameraUBO),n.bindBuffer(Jd.BINDING,i.getBuffer(Jd.BINDING)),n.update()},e.updateShadowUBO=function(e){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=e.scene.mainLight;a&&o.has(a)&&i.bindTexture(t_,o.get(a).colorTextures[0]),t.updateShadowUBOView(this._pipeline,this._shadowUBO,e),i.update(),r[0].updateBuffer(i.getBuffer($d.BINDING),this._shadowUBO)}},e.updateShadowUBOLight=function(e,n){t.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),e.bindTexture(t_,Dv.get("default-texture").getGFXTexture()),e.bindTexture(l_,Dv.get("default-texture").getGFXTexture()),e.update(),e.getBuffer($d.BINDING).update(this._shadowUBO)},e.updateShadowUBORange=function(t,e){e instanceof Vn?Vn.toArray(this._shadowUBO,e,t):e instanceof An&&An.toArray(this._shadowUBO,e,t)},e.destroy=function(){},t}();Ay._combineSignY=0;var wy,Ry,Py,Iy,My,Dy,Oy,Ny,Ly,By,Fy,zy,ky,Uy=t("RenderStage",(ly=dc("RenderStage"),uy=Gc(),hy=Gc(),fy=Gc(),ly((gy=function(){function t(){ct(this,"_name",_y,this),ct(this,"_priority",my,this),this._enabled=!0,ct(this,"_tag",vy,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,t.tag&&(this._tag=t.tag),!0},e.activate=function(t,e){this._pipeline=t,this._flow=e},Z(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}}]),t}(),_y=lt((dy=gy).prototype,"_name",[uy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),my=lt(dy.prototype,"_priority",[hy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vy=lt(dy.prototype,"_tag",[fy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),py=dy))||py));u.RenderStage=Uy;var Gy,Hy=t("RenderFlow",(wy=dc("RenderFlow"),Ry=Gc(),Py=Gc(),Iy=Gc(),My=Gc(),Dy=Kc([Uy]),wy((ky=function(){function t(){ct(this,"_name",Ly,this),ct(this,"_priority",By,this),ct(this,"_tag",Fy,this),ct(this,"_stages",zy,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,this._stages=t.stages,t.tag&&(this._tag=t.tag),!0},e.activate=function(t){this._pipeline=t,this._stages.sort((function(t,e){return t.priority-e.priority}));for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].activate(t,this)},e.render=function(t){for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].enabled&&this._stages[e].render(t)},e.destroy=function(){for(var t=0,e=this._stages.length;t<e;t++)this._stages[t].destroy();this._stages.length=0},Z(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),t}(),Ly=lt((Ny=ky).prototype,"_name",[Ry,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),By=lt(Ny.prototype,"_priority",[Py,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fy=lt(Ny.prototype,"_tag",[Iy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zy=lt(Ny.prototype,"_stages",[My,Dy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Oy=Ny))||Oy));u.RenderFlow=Hy,function(t){t.RENDER_FRAME_BEGIN="render-frame-begin",t.RENDER_FRAME_END="render-frame-end",t.RENDER_CAMERA_BEGIN="render-camera-begin",t.RENDER_CAMERA_END="render-camera-end",t.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(Gy||(Gy=t("PipelineEventType",{})));var Vy,Wy,jy,qy,Xy,Yy,Ky,Qy,Zy,Jy,$y,tx,ex,nx,ix,rx=t("PipelineEventProcessor",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e}$(e,t);var n=e.prototype;return n.on=function(t,e,n,i){return this.eventTargetOn(t,e,n,i)},n.once=function(t,e,n){return this.eventTargetOnce(t,e,n)},e}(eu)),ox=new $i,ax=new ar,sx=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},cx=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},lx=t("RenderPipeline",(Vy=dc("cc.RenderPipeline"),Wy=Gc(),jy=Gc(),qy=Kc([Hy]),Vy((Zy=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_tag",Ky,ot(e)),ct(e,"_flows",Qy,ot(e)),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new rx,e._commandBuffers=[],e._pipelineUBO=new Ay,e._macros={},e._constantMacros="",e._profiler=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new $i,e._clusterEnabled=!1,e._bloomEnabled=!1,e}$(e,t);var n=e.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(t){return this._flows=t.flows,t.tag&&(this._tag=t.tag),!0},n.createRenderPass=function(t,e,n){var i=this._device,r=new Mr,o=new Dr;r.format=e,o.format=n,o.stencilStoreOp=Oi.DISCARD,o.depthStoreOp=Oi.DISCARD,t&Xi.COLOR||(t&_g?r.loadOp=Di.DISCARD:(r.loadOp=Di.LOAD,r.beginAccesses=[Ni.COLOR_ATTACHMENT_WRITE])),(t&Xi.DEPTH_STENCIL)!==Xi.DEPTH_STENCIL&&(t&Xi.DEPTH||(o.depthLoadOp=Di.LOAD),t&Xi.STENCIL||(o.stencilLoadOp=Di.LOAD)),o.beginAccesses=[Ni.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Lr([r],o);return i.createRenderPass(a)},n.getRenderPass=function(t,e){var n=this._renderPasses.get(t);return n||(n=this.createRenderPass(t,e.colorTextures[0].format,e.depthStencilTexture.format),this._renderPasses.set(t,n),n)},n.applyFramebufferRatio=function(t){for(var e=this.pipelineSceneData,n=this._width*e.shadingScale,i=this._height*e.shadingScale,r=t.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);t.depthStencilTexture&&t.depthStencilTexture.resize(n,i),t.destroy(),t.initialize(new zr(t.renderPass,r,t.depthStencilTexture))},n.generateRenderArea=function(t,e){var n=t.viewport,i=t.window.width,r=t.window.height;e.x=n.x*i,e.y=n.y*r,e.width=n.width*i,e.height=n.height*r},n.generateViewport=function(t,e){this.generateRenderArea(t,ox),e||(e=ax);var n=this.pipelineSceneData.shadingScale;return e.left=ox.x*n,e.top=ox.y*n,e.width=ox.width*n,e.height=ox.height*n,e},n.generateScissor=function(t,e){e||(e=ox),this.generateRenderArea(t,e);var n=this.pipelineSceneData.shadingScale;return e.x*=n,e.y*=n,e.width*=n,e.height*=n,e},n.activate=function(){var t=u.director.root;this._device=t.device,this._generateConstantMacros(),this._globalDSManager=new sy(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(t){if(0!==t.length){this._commandBuffers[0].begin(),this.emit(Gy.RENDER_FRAME_BEGIN,t),this._ensureEnoughSize(t),function(t){for(var e=t.length-1;e>=0;--e){var n=t[e];if(n.window.swapchain)return void(tg=n)}tg=null}(t);for(var e=0;e<t.length;e++){var n=t[e];if(n.scene){this.emit(Gy.RENDER_CAMERA_BEGIN,n),ty(this,n),ey(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(Gy.RENDER_CAMERA_END,n)}}this.emit(Gy.RENDER_FRAME_END,t),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var t,e=this._pipelineRenderData.bloom;if(null!==e){e.prefiterTex&&e.prefiterTex.destroy(),e.prefilterFramebuffer&&e.prefilterFramebuffer.destroy();for(var n=0;n<e.downsampleTexs.length;++n)e.downsampleTexs[n].destroy(),e.downsampleFramebuffers[n].destroy();e.downsampleTexs.length=0,e.downsampleFramebuffers.length=0;for(var i=0;i<e.upsampleTexs.length;++i)e.upsampleTexs[i].destroy(),e.upsampleFramebuffers[i].destroy();e.upsampleTexs.length=0,e.upsampleFramebuffers.length=0,e.combineTex&&e.combineTex.destroy(),e.combineFramebuffer&&e.combineFramebuffer.destroy(),null===(t=e.renderPass)||void 0===t||t.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(t,e){var n=new Float32Array(16),i=e.x/this._width,r=(e.x+e.width)/this._width,o=e.y/this._height,a=(e.y+e.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(t){case ui.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case ui.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case ui.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case ui.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var t=new cx,e=4*Float32Array.BYTES_PER_ELEMENT,n=4*e,i=this._device.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE|gi.HOST,n,e));if(!i)return t;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.DEVICE,o,r));if(!a)return t;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Rr("a_position",fi.RG32F),c[1]=new Rr("a_texCoord",fi.RG32F);var l=this._device.createInputAssembler(new Ir(c,[i],a));return t.quadIB=a,t.quadVB=i,t.quadIA=l,t},n.updateQuadVertexData=function(t,e){var n=this._lastUsedRenderArea;if(n.x!==t.x||n.y!==t.y||n.width!==t.width||n.height!==t.height){var i=this._genQuadVertexData(ui.IDENTITY,t);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(e.swapchain&&e.swapchain.surfaceTransform||ui.IDENTITY,t);this._quadVBOnscreen.update(r),n.copy(t)}},n.destroy=function(){for(var e,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),t.prototype.destroy.call(this)},n._generateConstantMacros=function(){var t="";t+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(hi.TEXTURE_FLOAT)?1:0)+"\n",t+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",t+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",t+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",t+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(hi.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",t+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(_u.os===au.ANDROID&&_u.isBrowser?1:0)+"\n",t+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(ue.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=t},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var t=this._pipelineRenderData.bloom=new sx,e=this.device,n=new Mr;n.format=fi.RGBA8,n.loadOp=Di.CLEAR,n.storeOp=Oi.STORE,n.endAccesses=[Ni.COLOR_ATTACHMENT_WRITE],t.renderPass=e.createRenderPass(new Lr([n]));var i=this._width,r=this._height;t.prefiterTex=e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,fi.RGBA8,i>>1,r>>1)),t.prefilterFramebuffer=e.createFramebuffer(new zr(t.renderPass,[t.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)t.downsampleTexs.push(e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,fi.RGBA8,i>>1,r>>1))),t.downsampleFramebuffers[o]=e.createFramebuffer(new zr(t.renderPass,[t.downsampleTexs[o]])),t.upsampleTexs.push(e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,fi.RGBA8,i,r))),t.upsampleFramebuffers[o]=e.createFramebuffer(new zr(t.renderPass,[t.upsampleTexs[o]])),i>>=1,r>>=1;t.combineTex=e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,fi.RGBA8,this._width,this._height)),t.combineFramebuffer=e.createFramebuffer(new zr(t.renderPass,[t.combineTex])),t.sampler=this.globalDSManager.linearSampler}},n.on=function(t,e,n,i){return this._eventProcessor.on(t,e,n,i)},n.once=function(t,e,n){return this._eventProcessor.once(t,e,n)},n.off=function(t,e,n){this._eventProcessor.off(t,e,n)},n.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},n.targetOff=function(t){this._eventProcessor.targetOff(t)},n.removeAll=function(t){this._eventProcessor.removeAll(t)},n.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},Z(e,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(t){this._profiler=t}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(t){this._clusterEnabled=t}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(t){this._bloomEnabled=t}}]),e}(Du),Ky=lt((Yy=Zy).prototype,"_tag",[Wy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qy=lt(Yy.prototype,"_flows",[jy,qy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xy=Yy))||Xy));u.RenderPipeline=lx,function(t){t[t.BLOOM=18]="BLOOM",t[t.POST_PROCESS=19]="POST_PROCESS",t[t.UI=20]="UI"}(Jy||(Jy={})),function(t){t[t.FORWARD=10]="FORWARD"}($y||($y={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.FORWARD=1]="FORWARD",t[t.UI=10]="UI"}(tx||(tx={})),function(t){t[t.GBUFFER=10]="GBUFFER",t[t.LIGHTING=15]="LIGHTING",t[t.TRANSPARENT=18]="TRANSPARENT"}(ex||(ex={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.MAIN=1]="MAIN",t[t.UI=10]="UI"}(nx||(nx={}));var ux=new Mr;ux.format=fi.RGBA8,ux.beginAccesses=[Ni.FRAGMENT_SHADER_READ_TEXTURE],ux.endAccesses=[Ni.FRAGMENT_SHADER_READ_TEXTURE];var hx=new Dr;hx.format=fi.DEPTH_STENCIL;var fx,px,dx,_x,mx,vx,gx,yx,xx,Sx,Tx,Ex,bx,Cx,Ax,wx,Rx,Px,Ix,Mx,Dx,Ox,Nx,Lx,Bx,Fx,zx,kx,Ux,Gx,Hx,Vx,Wx,jx,qx,Xx,Yx,Kx,Qx,Zx,Jx,$x,tS,eS,nS,iS,rS,oS,aS,sS,cS,lS,uS,hS,fS,pS,dS,_S,mS,vS,gS,yS,xS,SS,TS,ES,bS,CS,AS,wS,RS,PS,IS,MS,DS,OS,NS,LS,BS,FS=new Lr([ux],hx),zS={width:1,height:1,renderPassInfo:FS},kS=t("RenderTexture",dc("cc.RenderTexture")(ix=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._window=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)},n.reset=function(t){this.initialize(t)},n.destroy=function(){if(this._window){var e=u.director.root;null==e||e.destroyWindow(this._window),this._window=null}return t.prototype.destroy.call(this)},n.resize=function(t,e){this._width=Math.floor(sn(t,1,2048)),this._height=Math.floor(sn(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(e,n){var i=e;this._width=i.w,this._height=i.h,this._name=i.n,t.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(t){var e=u.director.root;zS.title=this._name,zS.width=this._width,zS.height=this._height,zS.renderPassInfo=t&&t.passInfo?t.passInfo:FS,this._window?(this._window.destroy(),this._window.initialize(e.device,zS)):this._window=e.createWindow(zS)},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return O(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return O(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new or;return u.texOffset.x=t,u.texOffset.y=e,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},Z(e,[{key:"window",get:function(){return this._window}}]),e}(Jm))||ix);u.RenderTexture=kS,ce(yi),ce(xi),ce(Oi),ce(Di),ce(Ni),function(t){t[t.SCENE=0]="SCENE",t[t.POSTPROCESS=1]="POSTPROCESS",t[t.UI=2]="UI"}(BS||(BS={})),ce(BS),fx=dc("RenderTextureDesc"),px=Kc(yi),dx=Kc(xi),_x=Kc(fi),fx((vx=lt((mx=function(){ct(this,"name",vx,this),ct(this,"type",gx,this),ct(this,"usage",yx,this),ct(this,"format",xx,this),ct(this,"width",Sx,this),ct(this,"height",Tx,this)}).prototype,"name",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gx=lt(mx.prototype,"type",[px],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yi.TEX2D}}),yx=lt(mx.prototype,"usage",[dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xi.COLOR_ATTACHMENT}}),xx=lt(mx.prototype,"format",[_x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.UNKNOWN}}),Sx=lt(mx.prototype,"width",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Tx=lt(mx.prototype,"height",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),mx));var US,GS=(Ex=dc("RenderTextureConfig"),bx=Kc(kS),Ex((wx=lt((Ax=function(){ct(this,"name",wx,this),ct(this,"texture",Rx,this)}).prototype,"name",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Rx=lt(Ax.prototype,"texture",[bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cx=Ax))||Cx),HS=(Px=dc("MaterialConfig"),Ix=Kc(cg),Px((Dx=lt((Mx=function(){ct(this,"name",Dx,this),ct(this,"material",Ox,this)}).prototype,"name",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ox=lt(Mx.prototype,"material",[Ix],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mx)),Nx=dc("FrameBufferDesc"),Lx=Kc([Le]),Bx=Kc(kS),Nx((zx=lt((Fx=function(){ct(this,"name",zx,this),ct(this,"renderPass",kx,this),ct(this,"colorTextures",Ux,this),ct(this,"depthStencilTexture",Gx,this),ct(this,"texture",Hx,this)}).prototype,"name",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kx=lt(Fx.prototype,"renderPass",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ux=lt(Fx.prototype,"colorTextures",[Lx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gx=lt(Fx.prototype,"depthStencilTexture",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hx=lt(Fx.prototype,"texture",[Bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fx)),Vx=dc("ColorDesc"),Wx=Kc(fi),jx=Kc(Di),qx=Kc(Oi),Xx=Kc([Ni]),Yx=Kc([Ni]),Vx((Zx=lt((Qx=function(){ct(this,"format",Zx,this),ct(this,"loadOp",Jx,this),ct(this,"storeOp",$x,this),ct(this,"sampleCount",tS,this),ct(this,"beginAccesses",eS,this),ct(this,"endAccesses",nS,this)}).prototype,"format",[Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.UNKNOWN}}),Jx=lt(Qx.prototype,"loadOp",[jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.CLEAR}}),$x=lt(Qx.prototype,"storeOp",[qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oi.STORE}}),tS=lt(Qx.prototype,"sampleCount",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),eS=lt(Qx.prototype,"beginAccesses",[Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nS=lt(Qx.prototype,"endAccesses",[Yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Ni.COLOR_ATTACHMENT_WRITE]}}),Kx=Qx))||Kx),VS=(iS=dc("DepthStencilDesc"),rS=Kc(fi),oS=Kc(Di),aS=Kc(Oi),sS=Kc(Di),cS=Kc(Oi),lS=Kc([Ni]),uS=Kc([Ni]),iS((pS=lt((fS=function(){ct(this,"format",pS,this),ct(this,"depthLoadOp",dS,this),ct(this,"depthStoreOp",_S,this),ct(this,"stencilLoadOp",mS,this),ct(this,"stencilStoreOp",vS,this),ct(this,"sampleCount",gS,this),ct(this,"beginAccesses",yS,this),ct(this,"endAccesses",xS,this)}).prototype,"format",[rS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.UNKNOWN}}),dS=lt(fS.prototype,"depthLoadOp",[oS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.CLEAR}}),_S=lt(fS.prototype,"depthStoreOp",[aS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oi.STORE}}),mS=lt(fS.prototype,"stencilLoadOp",[sS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.CLEAR}}),vS=lt(fS.prototype,"stencilStoreOp",[cS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oi.STORE}}),gS=lt(fS.prototype,"sampleCount",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yS=lt(fS.prototype,"beginAccesses",[lS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xS=lt(fS.prototype,"endAccesses",[uS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Ni.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),hS=fS))||hS);SS=dc("RenderPassDesc"),TS=Kc([HS]),ES=Kc(VS),SS((CS=lt((bS=function(){ct(this,"index",CS,this),ct(this,"colorAttachments",AS,this),ct(this,"depthStencilAttachment",wS,this)}).prototype,"index",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),AS=lt(bS.prototype,"colorAttachments",[TS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wS=lt(bS.prototype,"depthStencilAttachment",[ES],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new VS}}),bS)),function(t){t[t.FRONT_TO_BACK=0]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(US||(US={})),ce(US);var WS=(RS=dc("RenderQueueDesc"),PS=Kc(US),IS=Kc([Le]),RS((OS=lt((DS=function(){ct(this,"isTransparent",OS,this),ct(this,"sortMode",NS,this),ct(this,"stages",LS,this)}).prototype,"isTransparent",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NS=lt(DS.prototype,"sortMode",[PS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return US.FRONT_TO_BACK}}),LS=lt(DS.prototype,"stages",[IS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MS=DS))||MS);function jS(t,e){return t.hash-e.hash||t.depth-e.depth||t.shaderId-e.shaderId}function qS(t,e){return t.hash-e.hash||e.depth-t.depth||t.shaderId-e.shaderId}var XS=function(){function t(t){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new jl((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new ql(64,this._passDesc.sortFunc)}var e=t.prototype;return e.clear=function(){this.queue.clear(),this._passPool.reset()},e.insertRenderPass=function(t,e,n){var i=t.model.subModels[e],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=t.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},e.sort=function(){this.queue.sort()},e.recordCommandBuffer=function(t,e,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=Uv.getOrCreatePipelineState(t,c,l,e,s);n.bindPipelineState(u),n.bindDescriptorSet(Xd.MATERIAL,c.descriptorSet),n.bindDescriptorSet(Xd.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}();function YS(t){for(var e=0,n=0;n<t.stages.length;n++)e|=Ov(t.stages[n]);var i=jS;switch(t.sortMode){case US.BACK_TO_FRONT:i=qS;break;case US.FRONT_TO_BACK:i=jS}return new XS({isTransparent:t.isTransparent,phases:e,sortFunc:i})}function KS(t){t.clear()}function QS(t){t.sort()}var ZS=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);t.updateBuffer(r.vbIdx,r.vbIdxData.buffer),t.updateBuffer(r.ubo,r.uboData)}}n=e.next()}},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=Uv.getOrCreatePipelineState(t,s.pass,c,e,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(Xd.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet(Xd.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},t}(),JS=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(t),n=e.next()},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(Xd.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,f=Uv.getOrCreatePipelineState(t,s,h,e,u.ia);c!==f&&(n.bindPipelineState(f),c=f),n.bindDescriptorSet(Xd.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},t}(),$S=function(){function t(){this._groundAlbedoHDR=new Zn(.2,.2,.2,1),this._skyColorHDR=new Zn(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Zn(.2,.2,.2,1),this._skyColorLDR=new Zn(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}var e=t.prototype;return e.initialize=function(t){this._skyColorHDR=t.skyColorHDR,this._groundAlbedoHDR.set(t.groundAlbedoHDR),this._skyIllumHDR=t.skyIllumHDR,this._skyColorLDR=t.skyColorLDR,this._groundAlbedoLDR.set(t.groundAlbedoLDR),this._skyIllumLDR=t.skyIllumLDR},e._destroy=function(){},e.destroy=function(){this._destroy()},Z(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"skyColor",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t)}},{key:"skyIllum",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t}},{key:"groundAlbedo",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(t){this._mipmapCount=t}},{key:"native",get:function(){return this._nativeObj}}]),t}();$S.SUN_ILLUM=65e3,$S.SKY_ILLUM=2e4,u.Ambient=$S;var tT,eT=function(){function t(){this._enabled=!1,this._minPos=new Rn(0,0,0),this._maxPos=new Rn(0,0,0),this._depth=0}var e=t.prototype;return e.initialize=function(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth},e._destroy=function(){},e.destroy=function(){this._destroy()},Z(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),nT=new Gr(null),iT=function(){function t(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Fd.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var e=t.prototype;return e._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},e._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},e._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},e._createDescriptorSet=function(t){this._descriptorSet=this._device.createDescriptorSet(t)},e._createWorldBoundDescriptorSet=function(t){this._worldBoundDescriptorSet=this._device.createDescriptorSet(t)},e._setInputAssembler=function(t){this._inputAssembler=this._device.createInputAssembler(t)},e._setSubMesh=function(t){this._subMesh=t},e._init=function(){},e.initialize=function(t,e,n){void 0===n&&(n=null);var i=u.director.root;this._device=i.device,nT.layout=e[0].localSetLayout,this._init(),this._setInputAssembler(t.iaInfo),this._createDescriptorSet(nT);var r=u.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new Gr(null);if(o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(t),this._patches=n,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===Rv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Fd.DEFAULT,e[0].phase===Ov("reflection")){var a=i.mainWindow.width,s=i.mainWindow.height,c=512;s<a?(a=c*a/s,s=c):s=c*s/(a=c),this._reflectionTex=this._device.createTexture(new mr(yi.TEX2D,xi.STORAGE|xi.TRANSFER_SRC|xi.SAMPLED,fi.RGBA8,a,s)),this.descriptorSet.bindTexture(H_,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new gr(bi.LINEAR,bi.LINEAR,bi.NONE,Ci.CLAMP,Ci.CLAMP,Ci.CLAMP)),this.descriptorSet.bindSampler(H_,this._reflectionSampler),this.descriptorSet.bindTexture(j_,this._reflectionTex)}},e._initNativePlanarShadowShader=function(t){this._planarShader=t.getPlanarShader(this._patches)},e.initPlanarShadowShader=function(){var t=u.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(t)},e._initNativePlanarShadowInstanceShader=function(t){this._planarInstanceShader=t.getPlanarInstanceShader(this._patches)},e.initPlanarShadowInstanceShader=function(){var t=u.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(t)},e._destroy=function(){},e.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Fd.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},e.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},e.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var n=t[e];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},e.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var n=0;n<e.length;n++){var i=e[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},e._flushPassInfo=function(){var t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(var e=0,n=t.length;e<n;e++)this._shaders[e]=t[e].getShaderVariant(this.patches)}},Z(t,[{key:"passes",get:function(){return this._passes},set:function(t){t.length>8?O(12004,8):(this._passes=t,this._flushPassInfo(),this._passes[0].batchingScheme===Rv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),nT.layout=t[0].localSetLayout,this._createDescriptorSet(nT)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===Rv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(t)}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),t}(),rT=new Vn,oT=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(tT||(tT={}));var aT=new gr(bi.LINEAR,bi.LINEAR,bi.NONE,Ci.CLAMP,Ci.CLAMP,Ci.CLAMP),sT=new gr(bi.LINEAR,bi.LINEAR,bi.LINEAR,Ci.CLAMP,Ci.CLAMP,Ci.CLAMP),cT=function(){function t(){this.type=tT.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(f_.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Zn,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Ld.Enum.NONE,this._device=u.director.root.device}var e=t.prototype;return e._setReceiveShadow=function(t){this._receiveShadow=t},e._init=function(){},e.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Ld.Enum.NONE,this._inited=!0)},e._destroySubmodel=function(t){t.destroy()},e._destroy=function(){},e.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var n=this._subModels[e];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},e.attachToScene=function(t){this.scene=t,this._localDataUpdated=!0},e.detachFromScene=function(){this.scene=null},e.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e._applyLocalData=function(){},e._applyLocalBuffer=function(){},e._applyWorldBoundBuffer=function(){},e.updateUBOs=function(t){for(var e=this._subModels,n=0;n<e.length;n++)e[n].update();if(this._updateStamp=t,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(t,e,n,i){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,n[0]=t.m04,n[1]=t.m05,n[2]=t.m06,n[3]=t.m13,i[0]=t.m08,i[1]=t.m09,i[2]=t.m10,i[3]=t.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Vn.toArray(this._localData,i,f_.MAT_WORLD_OFFSET),Vn.inverseTranspose(rT,i);var a=Math.abs(Vn.determinant(rT)),s=1/Math.sqrt(a);Vn.multiplyScalar(rT,rT,s),Vn.toArray(this._localData,rT,f_.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},e._updateNativeBounds=function(){},e.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=js.fromPoints(js.create(),t,e),this._worldBounds=js.clone(this._modelBounds),this._updateNativeBounds())},e._createSubModel=function(){return new iT},e.initSubModel=function(t,e,n){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,n.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t)},e.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},e.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},e.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},e.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},e.updateLightingmap=function(t,e){Zn.toArray(this._localData,e,f_.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=Dv.get("empty-texture"));var n=t.getGFXTexture();if(n)for(var i=this._device.getSampler(t.mipmaps.length>1?sT:aT),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(B_,n),a.bindSampler(B_,i),a.update()}},e.getMacroPatches=function(){return this.receiveShadow?oT:null},e._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);var n=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(n.attributes,e.passes[0])}},e._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,n=0;n<e.length;n++)if(e[n].name===t)return n;return-1},e._setInstMatWorldIdx=function(t){this._instMatWorldIdx=t},e._updateInstancedAttributes=function(t,e){if(e.device.hasFeature(hi.INSTANCED_ARRAYS)){for(var n=0,i=0;i<t.length;i++){var r=t[i];r.isInstanced&&(n+=Jr[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<t.length;s++){var c=t[s];if(c.isInstanced){var l=new Rr;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=Jr[c.format],h=new(co(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}e.batchingScheme===Rv.INSTANCING&&e.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(d_)),this._localDataUpdated=!0}},e._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.DEVICE,f_.SIZE,f_.SIZE)),this._applyLocalBuffer())},e._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.DEVICE,p_.SIZE,p_.SIZE)),this._applyWorldBoundBuffer())},e._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(f_.BINDING,this._localBuffer)},e._updateWorldBoundDescriptors=function(t,e){this._worldBoundBuffer&&e.bindBuffer(p_.BINDING,this._worldBoundBuffer)},Z(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._setReceiveShadow(t),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),lT=function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t){return this._name=t.name,!0},e.activate=function(){},e.update=function(t){var e=this._mainLight;e&&e.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(t),c.updateUBOs(t))}},e._destroy=function(){},e.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},e.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},e.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},e.removeCameras=function(){for(var t,e=st(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},e.setMainLight=function(t){this._mainLight=t},e.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=iy.ROTATION));this.setMainLight(null)}},e.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},e.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},e.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t)},e.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),void this._sphereLights.splice(e,1)},e.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t)},e.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),void this._spotLights.splice(e,1)},e.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0},e.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[]},e.addModel=function(t){t.attachToScene(this),this._models.push(t)},e.removeModel=function(t){for(var e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),void this._models.splice(e,1)},e.removeModels=function(){for(var t,e=st(this._models);!(t=e()).done;){var n=t.value;n.detachFromScene(),n.destroy()}this._models.length=0},e.addBatch=function(t){this._batches.push(t)},e.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return void this._batches.splice(e,1)},e.removeBatches=function(){this._batches.length=0},e.onGlobalPipelineStateChanged=function(){for(var t,e=st(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},e.generateModelId=function(){return this._modelId++},e._createNativeObject=function(){},Z(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),t}();G(lT.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),G(lT.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var uT={};G(uT,"CameraVisFlags",[{name:"GENERAL"}]),U(uT,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Ld.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Ld.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Ld.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Ld.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Ld.BitMask,targetName:"UI_2D"}]),u.CameraVisFlags=uT;var hT={};G(hT,"VisibilityFlags",[{name:"GENERAL"}]),U(hT,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Ld.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Ld.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Ld.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Ld.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Ld.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Ld.Enum,targetName:"UI_2D"}]),u.VisibilityFlags=hT,U(kv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),G(vg.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),G(Tg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]);var fT=new Rn(0,0,-1),pT=new Rn,dT=function(t){function e(){var e;return(e=t.call(this)||this)._dir=new Rn(1,-1,-1),e._illuminanceHDR=$S.SUN_ILLUM,e._illuminanceLDR=1,e._type=ry.DIRECTIONAL,e}$(e,t);var n=e.prototype;return n.initialize=function(){t.prototype.initialize.call(this),this.illuminance=$S.SUN_ILLUM,this.direction=new Rn(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=Rn.transformQuat(pT,fT,this._node.worldRotation))},Z(e,[{key:"direction",get:function(){return this._dir},set:function(t){Rn.normalize(this._dir,t)}},{key:"illuminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(t){this._illuminanceHDR=t}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(t){this._illuminanceLDR=t}}]),e}(xy),_T=function(t){function e(e,n){var i;(i=t.call(this,e.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=e,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var f=c._descriptorSet.getSampler(u.binding,h),p=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,f,h),i._descriptorSet.bindTexture(u.binding,p,h)}return t.prototype.tryCompile.call(ot(i)),i}$(e,t);var n=e.prototype;return n.overridePipelineStates=function(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),kv.fillPipelineInfo(this,t),kv.fillPipelineInfo(this,e),this._onStateChange()},n.tryCompile=function(e){if(e&&!pm(this._defines,e))return!1;var n=t.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Rv.NONE)},n._onStateChange=function(){this._setHash(kv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},Z(e,[{key:"parent",get:function(){return this._parent}}]),e}(kv),mT=function(t){function e(e){var n;return(n=t.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=e.parent,n._owner=e.owner||null,n._subModelIdx=e.subModelIdx||0,n.copy(n._parent),n}$(e,t);var n=e.prototype;return n.recompileShaders=function(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(var n,i=st(this._passes);!(n=i()).done;)n.value.tryCompile(t);else this._passes[e].tryCompile(t)},n.overridePipelineStates=function(t,e){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in t)o[a]=t[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[e]||(this._states[e]={});for(var c in t)s[c]=t[c];this._passes[e].overridePipelineStates(n[e],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(t){this._hash=cg.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var t=[],e=this._parent.passes;if(!e)return t;for(var n=0;n<e.length;++n)t.push(new _T(e[n],this));return t},Z(e,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),e}(cg),vT=null,gT=null,yT=function(){function t(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var e=t.prototype;return e._setEnabled=function(t){this._enabled=t},e._setUseIBL=function(t){this._useIBL=t},e._setUseHDR=function(t){this._useHDR=t},e._setUseDiffuseMap=function(t){this._useDiffuseMap=t},e.initialize=function(t){this._setEnabled(t.enabled),this._setUseIBL(t.useIBL),this._setUseDiffuseMap(t.applyDiffuseMap),this._setUseHDR(t.useHDR)},e.setEnvMaps=function(t,e){this._envmapHDR=t,this._envmapLDR=e;var n=u.director.root;n.pipeline.pipelineSceneData.isHDR?t&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel):e&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},e.setDiffuseMaps=function(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()},e.activate=function(){var t=u.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=Dv.get("default-cube-texture"),this._model||(this._model=u.director.root.createModel(u.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var e=this._default.isRGBE;if(this.envmap&&(e=this.envmap.isRGBE),!gT){var n=new cg;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:e}}),gT=new mT({parent:n})}this.enabled&&(vT||(vT=u.utils.createMesh(u.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,vT.renderingSubMeshes[0],gT)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},e._updatePipeline=function(){var t=u.director.root,e=t.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;e.macros.CC_USE_IBL===n&&e.macros.CC_USE_DIFFUSEMAP===i&&e.macros.CC_USE_HDR===r||(e.macros.CC_USE_IBL=n,e.macros.CC_USE_DIFFUSEMAP=i,e.macros.CC_USE_HDR=r,t.onGlobalPipelineStateChanged()),this.enabled&&gT&&gT.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,gT)},e._updateGlobalBinding=function(){if(this._globalDSManager){var t=u.director.root.device,e=this.envmap?this.envmap:this._default;if(e){var n=e.getGFXTexture(),i=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(i_,i),this._globalDSManager.bindTexture(i_,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var o=r.getGFXTexture(),a=t.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(a_,a),this._globalDSManager.bindTexture(a_,o)}this._globalDSManager.update()}},e._destroy=function(){},e.destroy=function(){this._destroy()},Z(t,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnabled(t),t?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(t){this._setUseHDR(t),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._setUseIBL(t),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(t){this._useDiffuseMap=t,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}},{key:"diffuseMap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}},{key:"native",get:function(){return this._nativeObj}}]),t}();u.Skybox=yT;var xT=function(t){$(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=js.create(),e._pos=new Rn,e._type=ry.SPHERE,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/yy(.15),this.luminanceLDR=1},e.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=this._range;js.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}},Z(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",set:function(t){this._luminanceLDR=t}},{key:"aabb",get:function(){return this._aabb}}]),n}(xy),ST=new Rn(0,0,-1),TT=new Ln,ET=new Vn,bT=new Vn,CT=new Vn,AT=new Vn,wT=function(t){$(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._dir=new Rn(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._aspect=0,e._aabb=js.create(),e._frustum=ic.create(),e._pos=new Rn,e._type=ry.SPOT,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e._setDirection=function(t){this._dir.set(t)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/yy(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new Rn(1,-1,-1))},e.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Rn.transformQuat(this._dir,ST,this._node.getWorldRotation(TT)),Rn.normalize(this._dir,this._dir),js.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(ET),Vn.invert(ET,ET),Vn.perspective(bT,this._angle,1,.001,this._range),Vn.multiply(CT,bT,ET),this._frustum.update(CT,AT),this._needUpdate=!1)},Z(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(t){this._luminanceLDR=t}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(t){this._aspect=t,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(xy),RT=Object.freeze({__proto__:null,Ambient:$S,Octree:eT,get CameraFOVAxis(){return ng},get CameraProjection(){return ig},get CameraAperture(){return rg},get CameraISO(){return og},get CameraShutter(){return ag},SKYBOX_FLAG:_g,Camera:vg,CameraVisFlags:uT,VisibilityFlags:hT,DirectionalLight:dT,ColorTemperatureToRGB:cy,get LightType(){return ry},nt2lm:yy,Light:xy,get ModelType(){return tT},Model:cT,ShadowSize:gg,ShadowType:yg,PCFType:xg,Shadows:Tg,RenderScene:lT,Skybox:yT,SphereLight:xT,SpotLight:wT,SubModel:iT,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null}),PT=new Wl((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),IT=new Float32Array(4),MT=[],DT=[],OT=new Vn,NT=new Vn;function LT(t,e){return!(!e.worldBounds||hs.aabbWithAABB(e.worldBounds,t.aabb))}function BT(t,e){return!(!e.worldBounds||hs.aabbWithAABB(e.worldBounds,t.aabb)&&hs.aabbFrustum(e.worldBounds,t.frustum))}var FT=Ov("forward-add"),zT=[];function kT(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===FT){o=a,n=!0;break}e.push(o)}return n}var UT,GT,HT,VT,WT,jT,qT,XT,YT,KT,QT,ZT=function(){function t(t){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array($d.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=t,this._device=t.device,this._instancedQueue=new JS,this._batchedQueue=new ZS;var e=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(m_.SIZE/e)*e,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new fr(this._lightBuffer,0,m_.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var e=t.prototype;return e.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var t=0;t<this._lightPasses.length;t++){var e=this._lightPasses[t];e.dynamicOffsets.length=0,e.lights.length=0}PT.freeArray(this._lightPasses),this._lightPasses.length=0},e.destroy=function(){for(var t=this._pipeline.globalDSManager.descriptorSetMap,e=t.keys,n=0;n<e.length;n++){var i=e[n],r=t.get(i);r&&(r.getBuffer($d.BINDING).destroy(),r.getTexture(t_).destroy(),r.getTexture(l_).destroy(),r.destroy()),t.delete(i)}},e.gatherLightPasses=function(t,e){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(t,e),this._updateLightDescriptorSet(t,e);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(kT(a,zT)&&(DT.length=0,this._lightCulling(o,n),DT.length))for(var s=0;s<a.length;s++){var c=zT[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(m_.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(e),this._batchedQueue.uploadBuffers(e)}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],f=a.inputAssembler,p=Uv.getOrCreatePipelineState(t,u,h,e,f),d=u.descriptorSet,_=a.descriptorSet;n.bindPipelineState(p),n.bindDescriptorSet(Xd.MATERIAL,d),n.bindInputAssembler(f);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);MT[0]=c[m],n.bindDescriptorSet(Xd.GLOBAL,g),n.bindDescriptorSet(Xd.LOCAL,_,MT),n.draw(f)}}},e._lightCulling=function(t,e){for(var n=0;n<e.length;n++){var i=e[n],r=!1;switch(i.type){case ry.SPHERE:r=LT(i,t);break;case ry.SPOT:r=BT(i,t)}r||DT.push(n)}},e._addRenderQueue=function(t,e,n,i){var r=t.batchingScheme;if(r===Rv.INSTANCING)for(var o=0;o<DT.length;o++){var a=DT[o],s=t.getInstancedBuffer(a);s.merge(e,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===Rv.VB_MERGING)for(var c=0;c<DT.length;c++){var l=DT[c],u=t.getBatchedBuffer(l);u.merge(e,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=PT.alloc();h.subModel=e,h.passIdx=i;for(var f=0;f<DT.length;f++){var p=DT[f];h.lights.push(p),h.dynamicOffsets.push(this._lightBufferStride*p)}this._lightPasses.push(h)}},e._updateLightDescriptorSet=function(t,e){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=t.scene.mainLight,s=$_(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],f=c.getOrCreateDescriptorSet(u);if(f){var p=void 0,d=void 0;switch(h.type){case ry.SPHERE:a&&(Jg(r,a,this._shadowUBO),$g(r,this._shadowUBO)),this._shadowUBO[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,An.toArray(this._shadowUBO,r.shadowColor,$d.SHADOW_COLOR_OFFSET);break;case ry.SPOT:if(a&&(Jg(r,a,this._shadowUBO),$g(r,this._shadowUBO)),Vn.invert(OT,h.node.getWorldMatrix()),Vn.perspective(NT,h.angle,h.aspect,.001,h.range),p=NT.clone(),d=NT.clone().invert(),Vn.multiply(NT,NT,OT),Vn.toArray(this._shadowUBO,OT,$d.MAT_LIGHT_VIEW_OFFSET),Vn.toArray(this._shadowUBO,NT,$d.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[$d.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[$d.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[$d.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[$d.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[$d.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[$d.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[$d.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[$d.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[$d.SHADOW_PROJ_INFO_OFFSET+0]=p.m00,this._shadowUBO[$d.SHADOW_PROJ_INFO_OFFSET+1]=p.m05,this._shadowUBO[$d.SHADOW_PROJ_INFO_OFFSET+2]=1/p.m00,this._shadowUBO[$d.SHADOW_PROJ_INFO_OFFSET+3]=1/p.m05,An.toArray(this._shadowUBO,r.shadowColor,$d.SHADOW_COLOR_OFFSET),o.has(h)){var _,m=null===(_=o.get(h))||void 0===_?void 0:_.colorTextures[0];m&&f.bindTexture(l_,m)}}f.update(),e.updateBuffer(f.getBuffer($d.BINDING),this._shadowUBO)}}},e._updateUBOs=function(t,e){var n=t.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=gn(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new fr(this._lightBuffer,0,m_.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case ry.SPHERE:if(Rn.toArray(IT,l.position),IT[3]=0,this._lightBufferData.set(IT,c+m_.LIGHT_POS_OFFSET),IT[0]=l.size,IT[1]=l.range,IT[2]=0,IT[3]=o.enabled&&o.type===yg.ShadowMap?1:0,this._lightBufferData.set(IT,c+m_.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Rn.toArray(IT,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;IT[0]*=u.x,IT[1]*=u.y,IT[2]*=u.z}IT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(IT,c+m_.LIGHT_COLOR_OFFSET);break;case ry.SPOT:if(Rn.toArray(IT,l.position),IT[3]=1,this._lightBufferData.set(IT,c+m_.LIGHT_POS_OFFSET),IT[0]=l.size,IT[1]=l.range,IT[2]=l.spotAngle,IT[3]=o.enabled&&o.type===yg.ShadowMap?1:0,this._lightBufferData.set(IT,c+m_.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Rn.toArray(IT,l.direction),this._lightBufferData.set(IT,c+m_.LIGHT_DIR_OFFSET),Rn.toArray(IT,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;IT[0]*=h.x,IT[1]*=h.y,IT[2]*=h.z}IT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(IT,c+m_.LIGHT_COLOR_OFFSET)}}e.updateBuffer(this._lightBuffer,this._lightBufferData)},t}(),JT=new js,$T=function(){function t(t){this._pendingModels=[],this._castModels=[],this._instancedQueue=new JS,this._pipeline=void 0,this._pipeline=t}var e=t.prototype;return e.gatherShadowPasses=function(t,e){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===yg.Planar&&!(i.normal.length()<1e-6)){var r=t.scene,o=t.frustum,a=0!=(t.visibility&Ld.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var f=this._castModels[h];if(!f.worldBounds||(js.transform(JT,f.worldBounds,i.matLight),hs.aabbFrustum(JT,o)))if(f.isInstancingEnabled)for(var p=f.subModels,d=0;d<p.length;d++){var _=p[d];u.merge(_,f.instancedAttributes,0,_.planarInstanceShader)}else this._pendingModels.push(f)}this._instancedQueue.uploadBuffers(e)}}},e.recordCommandBuffer=function(t,e,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===yg.Planar&&(this._instancedQueue.recordCommandBuffer(t,e,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(Xd.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,f=u.inputAssembler,p=Uv.getOrCreatePipelineState(t,r,h,e,f);n.bindPipelineState(p),n.bindDescriptorSet(Xd.LOCAL,u.descriptorSet),n.bindInputAssembler(f),n.draw(f)}}},t}(),tE=function(){function t(){this._phaseID=Ov("default")}var e=t.prototype;return e.activate=function(t){this._pipeline=t},e.render=function(t,e){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=t.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(t.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var f=s.shaders[u],p=s.inputAssembler,d=Uv.getOrCreatePipelineState(i,h,f,e,p);r.bindPipelineState(d),r.bindDescriptorSet(Xd.MATERIAL,h.descriptorSet);var _=s.descriptorSet;r.bindDescriptorSet(Xd.LOCAL,_),r.bindInputAssembler(p),r.draw(p)}}}},t}(),eE=[new sr(0,0,0,1)],nE=t("ForwardStage",(UT=dc("ForwardStage"),GT=Kc([WS]),HT=Gc(),UT((XT=qT=function(t){function e(){var e;return ct(e=t.call(this)||this,"renderQueues",jT,ot(e)),e._renderQueues=[],e._renderArea=new $i,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Ov("default"),e._clearFlag=4294967295,e._batchedQueue=new ZS,e._instancedQueue=new JS,e._uiPhase=new tE,e}$(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=YS(this.renderQueues[i]);this._additiveLightQueue=new ZT(this._pipeline),this._planarQueue=new $T(this._pipeline),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(KS);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var f=h[o];if(f.phase===this._phaseID){var p=f.batchingScheme;if(p===Rv.INSTANCING){var d=f.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(p===Rv.VB_MERGING){var _=f.getBatchedBuffer();_.merge(u,o,c.model),this._batchedQueue.queue.add(_)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(QS);var m=e.commandBuffers[0];e.pipelineUBO.updateShadowUBO(t),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(t,m),this._planarQueue.gatherShadowPasses(t,m),t.clearFlag&Xi.COLOR&&(eE[0].x=t.clearColor.x,eE[0].y=t.clearColor.y,eE[0].z=t.clearColor.z,eE[0].w=t.clearColor.w),e.generateRenderArea(t,this._renderArea);var v=t.window.framebuffer,g=e.getRenderPass(t.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,eE,t.clearDepth,t.clearStencil),m.bindDescriptorSet(Xd.GLOBAL,e.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(Xd.GLOBAL,e.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._uiPhase.render(t,g),eg(n,g,m,e.profiler,t),m.endRenderPass()},e}(Uy),qT.initInfo={name:"ForwardStage",priority:$y.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:US.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:US.BACK_TO_FRONT,stages:["default","planarShadow"]}]},jT=lt((WT=XT).prototype,"renderQueues",[GT,xc,HT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VT=WT))||VT)),iE=t("ForwardFlow",dc("ForwardFlow")((QT=KT=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new nE;n.initialize(nE.initInfo),this._stages.push(n)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(Hy),KT.initInfo={name:kd,priority:tx.FORWARD,stages:[]},YT=QT))||YT),rE=new Vn,oE=new Vn,aE=new Vn,sE=new js,cE=Ov("shadow-caster"),lE=[];function uE(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===cE){o=a,n=!0;break}e.push(o)}return n}var hE,fE,pE,dE,_E,mE,vE=function(){function t(t){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new JS,this._batchedQueue=new ZS}var e=t.prototype;return e.gatherLightPasses=function(t,e,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===yg.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case ry.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;uE(l.subModels,lE)&&this.add(l,lE)}break;case ry.SPOT:Vn.invert(rE,n.node.getWorldMatrix()),Vn.perspective(oE,n.angle,n.aspect,.001,n.range),Vn.multiply(aE,oE,rE);for(var u=0;u<s.length;u++){var h=s[u].model;uE(h.subModels,lE)&&(h.worldBounds&&(js.transform(sE,h.worldBounds,aE),!hs.aabbFrustum(sE,e.frustum))||this.add(h,lE))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},e.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},e.add=function(t,e){for(var n=t.subModels,i=0;i<n.length;i++){var r=n[i],o=e[i],a=r.passes[o];if(a.batchingScheme===Rv.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,t.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===Rv.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,t),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=Uv.getOrCreatePipelineState(t,a,o,e,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Xd.MATERIAL,l),n.bindDescriptorSet(Xd.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}(),gE=[new sr(1,1,1,1)],yE=t("ShadowStage",dc("ShadowStage")((pE=fE=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowFrameBuffer=null,e._renderArea=new $i,e._light=null,e._globalDS=null,e}$(e,t);var n=e.prototype;return n.setUsage=function(t,e,n){this._globalDS=t,this._light=e,this._shadowFrameBuffer=n},n.destroy=function(){var t;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(t=this._additiveShadowQueue)||void 0===t||t.clear()},n.clearFramebuffer=function(t){if(this._light&&this._shadowFrameBuffer){gE[0].w=t.clearColor.w;var e=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;e.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,gE,t.clearDepth,t.clearStencil),e.endRenderPass()}},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=e.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,t,this._light,a);var s=t.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=e.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,gE,t.clearDepth,t.clearStencil),a.bindDescriptorSet(Xd.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._additiveShadowQueue=new vE(e)},e}(Uy),fE.initInfo={name:"ShadowStage",priority:$y.FORWARD,tag:0},hE=pE))||hE),xE=[],SE=t("ShadowFlow",dc("ShadowFlow")((mE=_E=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowRenderPass=null,e}$(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new yE;n.initialize(yE.initInfo),this._stages.push(n)}return!0},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData.shadows,i=e.pipelineSceneData.shadowFrameBufferMap,r=e.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===yg.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===ry.SPOT&&(xE.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=t.scene.mainLight;if(l){var u=e.descriptorSet;i.has(l)||this._initShadowFrameBuffer(e,l,t.window.swapchain);for(var h=i.get(l),f=0;f<this._stages.length;f++){var p=this._stages[f];p.setUsage(u,l,h),p.render(t)}}for(var d=0;d<xE.length;d++){var _=xE[d],m=e.globalDSManager.getOrCreateDescriptorSet(d);i.has(_)||this._initShadowFrameBuffer(e,_,t.window.swapchain);for(var v=i.get(_),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,_,v),y.render(t)}}xE.length=0}else this.clearShadowMap(xE,t)}},n.destroy=function(){if(t.prototype.destroy.call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(e.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(t,e){var n=t.device,i=t.pipelineSceneData.shadows.size,r=t.pipelineSceneData.shadowFrameBufferMap,o=$_(n)?fi.R32F:fi.RGBA8;if(!this._shadowRenderPass){var a=new Mr;a.format=o,a.loadOp=Di.CLEAR,a.storeOp=Oi.STORE,a.sampleCount=1;var s=new Dr;s.format=fi.DEPTH_STENCIL,s.depthLoadOp=Di.CLEAR,s.depthStoreOp=Oi.DISCARD,s.stencilLoadOp=Di.CLEAR,s.stencilStoreOp=Oi.DISCARD,s.sampleCount=1;var c=new Lr([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new mr(yi.TEX2D,xi.DEPTH_STENCIL_ATTACHMENT,fi.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new zr(this._shadowRenderPass,l,u));r.set(e,h)},n.clearShadowMap=function(t,e){var n=this._pipeline,i=n.pipelineSceneData,r=e.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,e.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(e)}}for(var l=0;l<t.length;l++){var u=t[l],h=i.shadowFrameBufferMap.get(u),f=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var p=0;p<this._stages.length;p++){var d=this._stages[p];d.setUsage(f,u,h),d.clearFramebuffer(e)}}},n.resizeShadowMap=function(){for(var t=this._pipeline.pipelineSceneData.shadows,e=t.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=$_(i)?fi.R32F:fi.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,o,e.x,e.y)));var u=c.depthStencilTexture;u&&u.resize(e.x,e.y);var h=c.renderPass;c.destroy(),c.initialize(new zr(h,l,u)),s=a.next()}else s=a.next()}t.shadowMapDirty=!1},e}(Hy),_E.initInfo={name:Ud,priority:tx.SHADOW,tag:BS.SCENE,stages:[]},dE=mE))||dE),TE=new Zn,EE=oe({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),bE=EE.LAYERED+1,CE=function(){function t(){this._fogColor=new An("#C8C8C8"),this._colorArray=new Zn(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var e=t.prototype;return e._setType=function(t){this._type=this.enabled?t:bE},e._setEnable=function(t){this._enabled=t},e._setAccurate=function(t){this._accurate=t},e.initialize=function(t){this.fogColor=t.fogColor,this._setEnable(t.enabled),this._setAccurate(t.accurate),this._setType(t.type),this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange},e.activate=function(){this._updatePipeline()},e._updatePipeline=function(){var t=u.director.root,e=this.enabled?this.type:bE,n=this.accurate?1:0,i=t.pipeline;i.macros.CC_USE_FOG===e&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=e,i.macros.CC_USE_ACCURATE_FOG=n,t.onGlobalPipelineStateChanged())},e._destroy=function(){},e.destroy=function(){this._destroy()},Z(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),t?this.activate():(this._type=bE,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._setAccurate(t),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),TE.set(t.x,t.y,t.z,t.w),Vv(this._colorArray,TE)}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),t}();function AE(t,e){for(var n,i=st(e);!(n=i()).done;){var r=n.value;Array.isArray(r)?AE(t,r):t.push(r)}}function wE(t){var e=[];return AE(e,t),e.join("")}u.Fog=CE;var RE=dl.Flags.Destroyed,PE=dl.Flags.PersistentMask,IE=Je.IDENTIFIER_RE,ME="var ",DE="o",OE={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},NE=Je.escapeForJS,LE=function(){function t(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}return t.prototype.toString=function(){return ME+this.varName+"="+this.expression+";"},t}();function BE(t,e){return e instanceof LE?new LE(e.varName,t+e.expression):t+e}function FE(t,e,n){Array.isArray(n)?(n[0]=BE(e,n[0]),t.push(n)):t.push(BE(e,n)+";")}var zE=function(){function t(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}var e=t.prototype;return e.append=function(t,e){this._exps.push([t,e])},e.writeCode=function(t){var e;if(this._exps.length>1)t.push("t="+this._targetExp+";"),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];FE(t,e+kE(i[0])+"=",i[1])}},t}();function kE(t){return IE.test(t)?"."+t:"["+NE(t)+"]"}zE.pool=void 0,zE.pool=new ee((function(t){t._exps.length=0,t._targetExp=null}),1),zE.pool.get=function(t){var e=this._get()||new zE;return e._targetExp=t,e};var UE=function(){function t(t,e){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Rt(),kt(this.funcModuleCache,OE),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(n=ME+this.globalVariables.join(",")+";");var i=wE(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var e=t.prototype;return e.getFuncModule=function(t,e){var n=Pt(t);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=t===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(t){}}}var o=this.funcs.indexOf(t);o<0&&(o=this.funcs.length,this.funcs.push(t));var a="F["+o+"]";return e&&(a="("+a+")"),this.funcModuleCache[n]=a,a},e.getObjRef=function(t){var e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),"O["+e+"]"},e.setValueType=function(t,e,n,i){var r=zE.pool.get(i),o=e.constructor.__props__;o||(o=Object.keys(e));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(e[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(t),zE.pool.put(r)},e.enumerateCCClass=function(t,e,n){for(var i=n.__values__,r=Pe(n),o=0;o<i.length;o++){var a=i[o],s=e[a],c=r[a+"$_$default"];if(!GE(c,s))if("object"==typeof s&&s instanceof u.ValueType&&(c=Je.getDefault(c))&&c.constructor===s.constructor){var l=DE+kE(a);this.setValueType(t,c,s,l)}else this.setObjProp(t,e,a,s)}},e.instantiateArray=function(t){if(0===t.length)return"[]";var e="a"+ ++this.localVariableId,n=[new LE(e,"new Array("+t.length+")")];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(var i=0;i<t.length;++i)FE(n,e+"["+i+"]=",this.enumerateField(t,i,t[i]));return n},e.instantiateTypedArray=function(t){var e=t.constructor.name;if(0===t.length)return"new "+e;var n="a"+ ++this.localVariableId,i=[new LE(n,"new "+e+"("+t.length+")")];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(var r=0;r<t.length;++r)0!==t[r]&&FE(i,n+"["+r+"]=",t[r]);return i},e.enumerateField=function(t,e,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=BE(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?NE(n):("_objFlags"===e&&t instanceof dl&&(n&=PE),n)},e.setObjProp=function(t,e,n,i){FE(t,DE+kE(n)+"=",this.enumerateField(e,n,i))},e.enumerateObject=function(t,e){var n=e.constructor;if(u.Class._isCCClass(n))this.enumerateCCClass(t,e,n);else for(var i in e)if(e.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=e[i];"object"==typeof r&&r&&r===e._iN$t||this.setObjProp(t,e,i,r)}},e.instantiateObj=function(t){if(t instanceof u.ValueType)return Je.getNewValueTypeCode(t);if(t instanceof u.Asset)return this.getObjRef(t);if(t._objFlags&RE)return null;var e,n=t.constructor;if(u.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof u.Component){if(t instanceof u._BaseNode||t instanceof u.Component)return this.getObjRef(t)}else if(this.parent instanceof u._BaseNode)if(t instanceof u._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof u.Component){var i;if(!(null===(i=t.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(t)}e=new LE(DE,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)e=new LE(DE,"{}");else{if(n)return this.getObjRef(t);e=new LE(DE,"Object.create(null)")}var r=[e];return t._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(t),this.enumerateObject(r,t),["(function(){",r,"return o;})();"]},t}();function GE(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof u.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return Tt(t)&&Tt(e)}return!1}var HE,VE,WE,jE,qE,XE,YE,KE,QE,ZE,JE=function(){function t(t){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}return t.prototype.applyOpacity=function(t){this._opacity=this._localOpacity*t},t.markOpacityTree=function(){},Z(t,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(t){this._uiTransformComp=t}},{key:"uiComp",get:function(){return this._uiComp},set:function(t){this._uiComp&&t?M(12002):this._uiComp=t}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(t){this._localOpacity=t,this.colorDirty=!0}}]),t}();dl.Flags.Destroying,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed",t.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(HE||(HE={}));var $E=dl.Flags.Destroying,tb=dl.Flags.DontDestroy,eb=dl.Flags.Deactivating,nb=new mt("Node");function ib(t){return t?"string"==typeof t?$t(t):t:(O(3804),null)}var rb,ob,ab,sb,cb,lb,ub,hb,fb,pb,db,_b=t("BaseNode",dc("cc.BaseNode")((ZE=QE=function(t){$(n,t),n._setScene=function(t){t._updateScene()},n._findComponent=function(t,e){var n=e,i=t._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===e)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof e)return s}return null},n._findComponents=function(t,e,n){var i=e,r=t._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===e&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof e&&n.push(c)}},n._findChildComponent=function(t,e){for(var i=0;i<t.length;++i){var r=t[i],o=n._findComponent(r,e);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,e)))return o}return null},n._findChildComponents=function(t,e,i){for(var r=0;r<t.length;++r){var o=t[r];n._findComponents(o,e,i),o._children.length>0&&n._findChildComponents(o._children,e,i)}};var e=n.prototype;function n(e){var n;return ct(n=t.call(this,e)||this,"_parent",jE,ot(n)),ct(n,"_children",qE,ot(n)),ct(n,"_active",XE,ot(n)),ct(n,"_components",YE,ot(n)),ct(n,"_prefab",KE,ot(n)),n._scene=null,n._activeInHierarchy=!1,n._id=nb.getNewId(),n._name=void 0,n._eventProcessor=new u.NodeEventProcessor(ot(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==e?e:"New Node",n}return e._updateScene=function(){null==this._parent?T("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},e.attr=function(t){kt(this,t)},e.getParent=function(){return this._parent},e.setParent=function(t,e){if(void 0===e&&(e=!1),this._parent!==t){var n=this._parent,i=t;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,e),this.emit&&this.emit(HE.PARENT_CHANGED,n),n&&!(n._objFlags&$E)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(HE.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(HE.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},e.getChildByUuid=function(t){if(!t)return x("Invalid uuid"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._id===t)return e[n];return null},e.getChildByName=function(t){if(!t)return x("Invalid name"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._name===t)return e[n];return null},e.getChildByPath=function(t){for(var e=t.split("/"),n=this,i=function(t){var i=e[t];if(0===i.length)return"continue";var r=n.children.find((function(t){return t.name===i}));if(!r)return{v:null};n=r},r=0;r<e.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},e.addChild=function(t){t.setParent(this)},e.insertChild=function(t,e){t.parent=this,t.setSiblingIndex(e)},e.getSiblingIndex=function(){return this._siblingIndex},e.setSiblingIndex=function(t){if(this._parent)if(this._parent._objFlags&eb)O(3821);else{var e=this._parent._children;t=-1!==t?t:e.length-1;var n=e.indexOf(this);t!==n&&(e.splice(n,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}},e.walk=function(t,e){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&t?t(o):l&&e&&e(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},e.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},e.removeChild=function(t){this._children.indexOf(t)>-1&&(t.parent=null)},e.removeAllChildren=function(){for(var t=this._children,e=t.length-1;e>=0;e--){var n=t[e];n&&(n.parent=null)}this._children.length=0},e.isChildOf=function(t){var e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1},e.getComponent=function(t){var e=ib(t);return e?n._findComponent(this,e):null},e.getComponents=function(t){var e=ib(t),i=[];return e&&n._findComponents(this,e,i),i},e.getComponentInChildren=function(t){var e=ib(t);return e?n._findChildComponent(this._children,e):null},e.getComponentsInChildren=function(t){var e=ib(t),i=[];return e&&(n._findComponents(this,e,i),n._findChildComponents(this._children,e,i)),i},e.addComponent=function(t){var e;if("string"==typeof t){if(!(e=$t(t)))throw u._RF.peek()&&O(3808,t),TypeError(F(3807,t))}else{if(!t)throw TypeError(F(3804));e=t}if("function"!=typeof e)throw TypeError(F(3809));if(!Ht(e,u.Component))throw TypeError(F(3810));var n=e._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var o=n;this.getComponent(o)||this.addComponent(o)}var a=new e;return a.node=this,this._components.push(a),this._activeInHierarchy&&u.director._nodeActivator.activateComp(a),a},e.removeComponent=function(t){if(t){var e=null;(e=t instanceof $u?t:this.getComponent(t))&&e.destroy()}else O(3813)},e.on=function(t,e,n,i){switch(void 0===i&&(i=!1),t){case HE.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,n,i)},e.off=function(t,e,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(t,e,n,i),!this._eventProcessor.hasEventListener(t))switch(t){case HE.TRANSFORM_CHANGED:this._eventMask&=-2}},e.once=function(t,e,n,i){this._eventProcessor.once(t,e,n,i)},e.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},e.dispatchEvent=function(t){this._eventProcessor.dispatchEvent(t)},e.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},e.targetOff=function(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(HE.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},e.destroy=function(){return!!t.prototype.destroy.call(this)&&(this.active=!1,!0)},e.destroyAllChildren=function(){for(var t=this._children,e=0;e<t.length;++e)t[e].destroy()},e._removeComponent=function(t){if(t){if(!(this._objFlags&$E)){var e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&O(3815)}}else O(3814)},e._updateSiblingIndex=function(){for(var t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(HE.SIBLING_ORDER_CHANGED)},e._onSetParent=function(t){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},e._onPostActivated=function(){},e._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},e._onPreDestroy=function(){this._onPreDestroyBase()},e._onHierarchyChanged=function(t){return this._onHierarchyChangedBase(t)},e._instantiate=function(t,e){return t||(t=u.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t},e._onHierarchyChangedBase=function(){var t=this._parent;!this._persistNode||t instanceof u.Scene||u.game.removePersistRootNode(this);var e=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==e&&u.director._nodeActivator.activateNode(this,e)},e._onPreDestroyBase=function(){this._objFlags|=$E;var t=this._parent,e=!!t&&0!=(t._objFlags&$E);if(this._persistNode&&u.game.removePersistRootNode(this),!e&&t){this.emit(HE.PARENT_CHANGED,this);var n=t._children.indexOf(this);t._children.splice(n,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(HE.CHILD_REMOVED,this)}this.emit(HE.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return e},Z(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&tb)>0},set:function(t){t?this._objFlags|=tb:this._objFlags&=~tb}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(t){if(this._active!==t){this._active=t;var e=this._parent;e&&e._activeInHierarchy&&u.director._nodeActivator.activateNode(this,t)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(t){this.setParent(t)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(dl),QE.idGenerator=nb,QE._stacks=[[]],QE._stackId=0,lt((WE=ZE).prototype,"_persistNode",[gc],Object.getOwnPropertyDescriptor(WE.prototype,"_persistNode"),WE.prototype),lt(WE.prototype,"name",[Mc],Object.getOwnPropertyDescriptor(WE.prototype,"name"),WE.prototype),lt(WE.prototype,"children",[Mc],Object.getOwnPropertyDescriptor(WE.prototype,"children"),WE.prototype),lt(WE.prototype,"active",[Mc],Object.getOwnPropertyDescriptor(WE.prototype,"active"),WE.prototype),lt(WE.prototype,"activeInHierarchy",[Mc],Object.getOwnPropertyDescriptor(WE.prototype,"activeInHierarchy"),WE.prototype),lt(WE.prototype,"parent",[Mc],Object.getOwnPropertyDescriptor(WE.prototype,"parent"),WE.prototype),jE=lt(WE.prototype,"_parent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qE=lt(WE.prototype,"_children",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),XE=lt(WE.prototype,"_active",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),YE=lt(WE.prototype,"_components",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KE=lt(WE.prototype,"_prefab",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VE=WE))||VE);u._BaseNode=_b;var mb=new Rn,vb=new Ln,gb=new Ln,yb=new Ln,xb=new Dn,Sb=new Dn,Tb=new Vn,Eb=[],bb=[],Cb=[],Ab=function(){function t(){this._chunks=[],this._freelists=[],this._createChunk()}var e=t.prototype;return e.alloc=function(){for(var t=this._freelists.length,e=0;e<t;++e)if(this._freelists[e].length)return this._createView(e);return this._createChunk(),this._createView(t)},e.free=function(t,e){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===t)return void this._freelists[i].push(e)},e.clear=function(){for(var t=this._chunks.length,e=0;e<t;++e)this._chunks[e].fill(0)},e._createChunk=function(){this._chunks.push(new Uint32Array(t.CAPACITY_PER_CHUNK));for(var e=[],n=t.CAPACITY_PER_CHUNK-1;n>=0;n--)e.push(n);this._freelists.push(e)},e._createView=function(t){return Cb[0]=this._chunks[t],Cb[1]=this._freelists[t].pop(),Cb},t}();Ab.CAPACITY_PER_CHUNK=256;var wb,Rb,Pb,Ib,Mb,Db,Ob,Nb,Lb,Bb,Fb,zb,kb,Ub,Gb,Hb,Vb,Wb,jb,qb,Xb,Yb,Kb,Qb,Zb,Jb,$b,tC,eC,nC,iC,rC,oC,aC,sC,cC,lC,uC,hC,fC,pC,dC,_C,mC,vC,gC,yC,xC,SC,TC,EC,bC,CC,AC,wC,RC,PC,IC,MC,DC,OC,NC,LC,BC,FC,zC,kC,UC,GC,HC=new Ab,VC=Symbol("ReserveContentsForAllSyncablePrefab"),WC=t("Node",(rb=dc("cc.Node"),ob=Kc(Rn),rb((db=pb=function(t){$(n,t);var e=n.prototype;function n(e){var n;return(n=t.call(this,e)||this)._uiProps=new JE(ot(n)),n._static=!1,ct(n,"_lpos",cb,ot(n)),ct(n,"_lrot",lb,ot(n)),ct(n,"_lscale",ub,ot(n)),ct(n,"_layer",hb,ot(n)),ct(n,"_euler",fb,ot(n)),n._dirtyFlagsPri=iy.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return e._init=function(){var t=HC.alloc(),e=t[0],n=t[1];this._hasChangedFlagsChunk=e,this._hasChangedFlagsOffset=n;var i=new Uint32Array(e.buffer,e.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new Rn,this._rot=new Ln,this._scale=new Rn(1,1,1),this._mat=new Vn},n.isNode=function(t){return t instanceof n&&(t.constructor===n||!(t instanceof u.Scene))},e._onPreDestroy=function(){var t=this._onPreDestroyBase();return HC.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),t},e[uh]=function(t){t.writeThis()},e.setParent=function(e,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),t.prototype.setParent.call(this,e,n)},e._onSetParent=function(e,n){if(t.prototype._onSetParent.call(this,e,n),n){var i=this._parent;i?(i.updateWorldTransform(),Vn.multiply(Tb,Vn.invert(Tb,i._mat),this._mat),Vn.toRTS(Tb,this._lrot,this._lpos,this._lscale)):(Rn.copy(this._lpos,this._pos),Ln.copy(this._lrot,this._rot),Rn.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(iy.TRS)},e._onHierarchyChanged=function(e){this.eventProcessor.reattach(),t.prototype._onHierarchyChangedBase.call(this,e)},e._onBatchCreated=function(t){this.hasChangedFlags=iy.TRS,this._dirtyFlags|=iy.TRS;for(var e=this._children.length,n=0;n<e;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(t)},e._onBeforeSerialize=function(){this.eulerAngles},e._onPostActivated=function(t){t?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(iy.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},e.translate=function(t,e){var n=e||ny.LOCAL;if(n===ny.LOCAL)Rn.transformQuat(mb,t,this._lrot),this._lpos.x+=mb.x,this._lpos.y+=mb.y,this._lpos.z+=mb.z;else if(n===ny.WORLD)if(this._parent){Ln.invert(vb,this._parent.worldRotation),Rn.transformQuat(mb,t,vb);var i=this.worldScale;this._lpos.x+=mb.x/i.x,this._lpos.y+=mb.y/i.y,this._lpos.z+=mb.z/i.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(iy.POSITION),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.POSITION)},e.rotate=function(t,e){var n=e||ny.LOCAL;if(Ln.normalize(vb,t),n===ny.LOCAL)Ln.multiply(this._lrot,this._lrot,vb);else if(n===ny.WORLD){var i=this.worldRotation;Ln.multiply(gb,vb,i),Ln.invert(vb,i),Ln.multiply(gb,vb,gb),Ln.multiply(this._lrot,this._lrot,gb)}this._eulerDirty=!0,this.invalidateChildren(iy.ROTATION),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.ROTATION)},e.lookAt=function(t,e){this.getWorldPosition(mb),Rn.subtract(mb,mb,t),Rn.normalize(mb,mb),Ln.fromViewUp(vb,mb,e),this.setWorldRotation(vb)},e._setDirtyNode=function(t,e){Eb[t]=e},e.invalidateChildren=function(t){var e,n,i,r=0,o=0,a=0,s=0,c=0,l=t|iy.POSITION;for(Eb[0]=this;r>=0;){if(c=(e=Eb[r--])._hasChangedFlags[0],s=e._dirtyFlagsPri,e.isValid&&(s&c&t)!==t)for(s|=t,e._dirtyFlagsPri=s,e._hasChangedFlags[0]=c|t,a=(i=e._children).length,o=0;o<a;o++)n=i[o],Eb[++r]=n;t=l}},e.updateWorldTransform=function(){if(this._dirtyFlags){for(var t,e=this,n=0;e&&e._dirtyFlags;)this._setDirtyNode(n++,e),e=e._parent;for(var i=0;n;)i|=(t=Eb[--n])._dirtyFlags,e?(i&iy.POSITION&&(Rn.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&iy.RS&&(Vn.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),Vn.multiply(t._mat,e._mat,t._mat),i&iy.ROTATION&&Ln.multiply(t._rot,e._rot,t._lrot),Dn.fromQuat(xb,Ln.conjugate(yb,t._rot)),Dn.multiplyMat4(xb,xb,t._mat),t._scale.x=xb.m00,t._scale.y=xb.m04,t._scale.z=xb.m08)):(i&iy.POSITION&&(Rn.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&iy.RS&&(i&iy.ROTATION&&Ln.copy(t._rot,t._lrot),i&iy.SCALE&&(Rn.copy(t._scale,t._lscale),Vn.fromRTS(t._mat,t._rot,t._pos,t._scale)))),t._dirtyFlags=iy.NONE,e=t}},e.setPosition=function(t,e,n){void 0===e&&void 0===n?Rn.copy(this._lpos,t):void 0===n?Rn.set(this._lpos,t,e,this._lpos.z):Rn.set(this._lpos,t,e,n),this.invalidateChildren(iy.POSITION),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.POSITION)},e.getPosition=function(t){return t?Rn.set(t,this._lpos.x,this._lpos.y,this._lpos.z):Rn.copy(new Rn,this._lpos)},e.setRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?Ln.copy(this._lrot,t):Ln.set(this._lrot,t,e,n,i),this._eulerDirty=!0,this.invalidateChildren(iy.ROTATION),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.ROTATION)},e.setRotationFromEuler=function(t,e,n){var i=void 0===n?this._euler.z:n;void 0===e?(Rn.copy(this._euler,t),Ln.fromEuler(this._lrot,t.x,t.y,t.z)):(Rn.set(this._euler,t,e,i),Ln.fromEuler(this._lrot,t,e,i)),this._eulerDirty=!1,this.invalidateChildren(iy.ROTATION),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.ROTATION)},e.getRotation=function(t){return t?Ln.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Ln.copy(new Ln,this._lrot)},e.setScale=function(t,e,n){void 0===e&&void 0===n?Rn.copy(this._lscale,t):void 0===n?Rn.set(this._lscale,t,e,this._lscale.z):Rn.set(this._lscale,t,e,n),this.invalidateChildren(iy.SCALE),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.SCALE)},e.getScale=function(t){return t?Rn.set(t,this._lscale.x,this._lscale.y,this._lscale.z):Rn.copy(new Rn,this._lscale)},e.inverseTransformPoint=function(t,e){Rn.copy(t,e);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)Rn.transformInverseRTS(t,t,n._lrot,n._lpos,n._lscale),n=Eb[--i];return t},e.setWorldPosition=function(t,e,n){void 0===e||void 0===n?Rn.copy(this._pos,t):Rn.set(this._pos,t,e,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),Rn.transformMat4(r,this._pos,Vn.invert(Tb,i._mat))):Rn.copy(r,this._pos),this.invalidateChildren(iy.POSITION),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.POSITION)},e.getWorldPosition=function(t){return this.updateWorldTransform(),t?Rn.copy(t,this._pos):Rn.copy(new Rn,this._pos)},e.setWorldRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?Ln.copy(this._rot,t):Ln.set(this._rot,t,e,n,i),this._parent?(this._parent.updateWorldTransform(),Ln.multiply(this._lrot,Ln.conjugate(this._lrot,this._parent._rot),this._rot)):Ln.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(iy.ROTATION),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.ROTATION)},e.setWorldRotationFromEuler=function(t,e,n){Ln.fromEuler(this._rot,t,e,n),this._parent?(this._parent.updateWorldTransform(),Ln.multiply(this._lrot,Ln.conjugate(this._lrot,this._parent._rot),this._rot)):Ln.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(iy.ROTATION),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.ROTATION)},e.getWorldRotation=function(t){return this.updateWorldTransform(),t?Ln.copy(t,this._rot):Ln.copy(new Ln,this._rot)},e.setWorldScale=function(t,e,n){void 0===e||void 0===n?Rn.copy(this._scale,t):Rn.set(this._scale,t,e,n);var i=this._parent;i?(i.updateWorldTransform(),Dn.fromQuat(xb,Ln.conjugate(yb,i._rot)),Dn.multiplyMat4(xb,xb,i._mat),Sb.m00=this._scale.x,Sb.m04=this._scale.y,Sb.m08=this._scale.z,Dn.multiply(xb,Sb,Dn.invert(xb,xb)),this._lscale.x=Rn.set(mb,xb.m00,xb.m01,xb.m02).length(),this._lscale.y=Rn.set(mb,xb.m03,xb.m04,xb.m05).length(),this._lscale.z=Rn.set(mb,xb.m06,xb.m07,xb.m08).length()):Rn.copy(this._lscale,this._scale),this.invalidateChildren(iy.SCALE),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.SCALE)},e.getWorldScale=function(t){return this.updateWorldTransform(),t?Rn.copy(t,this._scale):Rn.copy(new Rn,this._scale)},e.getWorldMatrix=function(t){this.updateWorldTransform();var e=t||new Vn;return Vn.copy(e,this._mat)},e.getWorldRS=function(t){this.updateWorldTransform();var e=t||new Vn;return Vn.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e},e.getWorldRT=function(t){this.updateWorldTransform();var e=t||new Vn;return Vn.fromRT(e,this._rot,this._pos)},e.setRTS=function(t,e,n){var i=0;t&&(i|=iy.ROTATION,void 0!==t.w?(Ln.copy(this._lrot,t),this._eulerDirty=!0):(Rn.copy(this._euler,t),Ln.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(Rn.copy(this._lpos,e),i|=iy.POSITION),n&&(Rn.copy(this._lscale,n),i|=iy.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,i))},e.pauseSystemEvents=function(t){this._eventProcessor.setEnabled(!1,t)},e.resumeSystemEvents=function(t){this._eventProcessor.setEnabled(!0,t)},n.resetHasChangedFlags=function(){HC.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,Eb.length=0,bb.length=0)},Z(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(t){this._dirtyFlagsPri=t}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(t){this.setPosition(t)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(t){this.setWorldPosition(t)}},{key:"rotation",get:function(){return this._lrot},set:function(t){this.setRotation(t)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Ln.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(t){this.setRotationFromEuler(t.x,t.y,t.z)}},{key:"angle",get:function(){return this._euler.z},set:function(t){Rn.set(this._euler,0,0,t),Ln.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(iy.ROTATION),1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(t){this.setWorldRotation(t)}},{key:"scale",get:function(){return this._lscale},set:function(t){this.setScale(t)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(t){this.setWorldScale(t)}},{key:"matrix",set:function(t){Vn.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(iy.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(HE.TRANSFORM_CHANGED,iy.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Rn.transformQuat(new Rn,Rn.FORWARD,this.worldRotation)},set:function(t){var e=t.length();Rn.multiplyScalar(mb,t,-1/e),Ln.fromViewUp(vb,mb),this.setWorldRotation(vb)}},{key:"up",get:function(){return Rn.transformQuat(new Rn,Rn.UP,this.worldRotation)}},{key:"right",get:function(){return Rn.transformQuat(new Rn,Rn.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(t){this._layer=t,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(HE.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(t){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=t}}]),n}(_b),pb.EventType=HE,pb.NodeSpace=ny,pb.TransformDirtyBit=iy,pb.TransformBit=iy,pb.reserveContentsForAllSyncablePrefabTag=VC,pb.ClearFrame=0,pb.ClearRound=1e3,cb=lt((sb=db).prototype,"_lpos",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),lb=lt(sb.prototype,"_lrot",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln}}),ub=lt(sb.prototype,"_lscale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(1,1,1)}}),hb=lt(sb.prototype,"_layer",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ld.Enum.DEFAULT}}),fb=lt(sb.prototype,"_euler",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),lt(sb.prototype,"eulerAngles",[ob],Object.getOwnPropertyDescriptor(sb.prototype,"eulerAngles"),sb.prototype),lt(sb.prototype,"angle",[Mc],Object.getOwnPropertyDescriptor(sb.prototype,"angle"),sb.prototype),lt(sb.prototype,"layer",[Mc],Object.getOwnPropertyDescriptor(sb.prototype,"layer"),sb.prototype),ab=sb))||ab));u.Node=WC;var jC=dc("cc.TargetInfo")((Pb=lt((Rb=function(){ct(this,"localID",Pb,this)}).prototype,"localID",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wb=Rb))||wb,qC=(Ib=dc("cc.TargetOverrideInfo"),Mb=Kc(dl),Db=Kc(jC),Ob=Kc(WC),Nb=Kc(jC),Ib((Fb=lt((Bb=function(){ct(this,"source",Fb,this),ct(this,"sourceInfo",zb,this),ct(this,"propertyPath",kb,this),ct(this,"target",Ub,this),ct(this,"targetInfo",Gb,this)}).prototype,"source",[xc,Mb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zb=lt(Bb.prototype,"sourceInfo",[xc,Db],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kb=lt(Bb.prototype,"propertyPath",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ub=lt(Bb.prototype,"target",[xc,Ob],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gb=lt(Bb.prototype,"targetInfo",[xc,Nb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lb=Bb))||Lb),XC=dc("cc.CompPrefabInfo")((Wb=lt((Vb=function(){ct(this,"fileId",Wb,this)}).prototype,"fileId",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hb=Vb))||Hb,YC=(jb=dc("CCPropertyOverrideInfo"),qb=Kc(jC),jb((Jb=function(){function t(){ct(this,"targetInfo",Kb,this),ct(this,"propertyPath",Qb,this),ct(this,"value",Zb,this)}return t.prototype.isTarget=function(){},t}(),Kb=lt((Yb=Jb).prototype,"targetInfo",[xc,qb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qb=lt(Yb.prototype,"propertyPath",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zb=lt(Yb.prototype,"value",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Xb=Yb))||Xb),KC=($b=dc("cc.MountedChildrenInfo"),tC=Kc(jC),eC=Kc([WC]),$b((aC=function(){function t(){ct(this,"targetInfo",rC,this),ct(this,"nodes",oC,this)}return t.prototype.isTarget=function(){},t}(),rC=lt((iC=aC).prototype,"targetInfo",[xc,tC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oC=lt(iC.prototype,"nodes",[xc,eC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nC=iC))||nC),QC=(sC=dc("cc.MountedComponentsInfo"),cC=Kc(jC),lC=Kc([$u]),sC((dC=function(){function t(){ct(this,"targetInfo",fC,this),ct(this,"components",pC,this)}return t.prototype.isTarget=function(){},t}(),fC=lt((hC=dC).prototype,"targetInfo",[xc,cC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pC=lt(hC.prototype,"components",[xc,lC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uC=hC))||uC),ZC=(_C=dc("cc.PrefabInstance"),mC=Kc(WC),vC=Kc([KC]),gC=Kc([QC]),yC=Kc([YC]),xC=Kc([jC]),_C((PC=function(){function t(){ct(this,"fileId",EC,this),ct(this,"prefabRootNode",bC,this),ct(this,"mountedChildren",CC,this),ct(this,"mountedComponents",AC,this),ct(this,"propertyOverrides",wC,this),ct(this,"removedComponents",RC,this),this.targetMap={}}var e=t.prototype;return e.findPropertyOverride=function(){},e.removePropertyOverride=function(){},t}(),EC=lt((TC=PC).prototype,"fileId",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bC=lt(TC.prototype,"prefabRootNode",[xc,mC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),CC=lt(TC.prototype,"mountedChildren",[xc,vC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AC=lt(TC.prototype,"mountedComponents",[xc,gC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wC=lt(TC.prototype,"propertyOverrides",[xc,yC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RC=lt(TC.prototype,"removedComponents",[xc,xC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SC=TC))||SC),JC=(IC=dc("cc.PrefabInfo"),MC=Kc(WC),DC=Kc(ZC),OC=Kc([qC]),IC((BC=lt((LC=function(){ct(this,"root",BC,this),ct(this,"asset",FC,this),ct(this,"fileId",zC,this),ct(this,"instance",kC,this),ct(this,"targetOverrides",UC,this),ct(this,"nestedPrefabInstanceRoots",GC,this)}).prototype,"root",[xc,MC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),FC=lt(LC.prototype,"asset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zC=lt(LC.prototype,"fileId",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kC=lt(LC.prototype,"instance",[xc,DC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),UC=lt(LC.prototype,"targetOverrides",[xc,OC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),GC=lt(LC.prototype,"nestedPrefabInstanceRoots",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),NC=LC))||NC);function $C(t){var e=t._prefab;if(e&&e.instance){if(!e.asset)return O(3701,t.name),void(e.instance=void 0);var n=t._objFlags,i=t._parent,r=t._id,o=t._prefab;t[ll],u.game._isCloning=!0,e.asset._doInstantiate(t),u.game._isCloning=!1,t._objFlags=n,t._parent=i,t._id=r,t._prefab&&(t._prefab.instance=null==o?void 0:o.instance)}}function tA(t,e,n){var i;if(e&&t){var r=e,o=null===(i=t._prefab)||void 0===i?void 0:i.instance;!n&&o&&(e[o.fileId]={},r=e[o.fileId]);var a=t._prefab;a&&(r[a.fileId]=t);for(var s=t.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<t.children.length;u++)tA(t.children[u],r,!1)}}function eA(t,e){if(!t)return null;for(var n=e,i=0;i<t.length;i++){if(!n)return null;n=n[t[i]]}return n}function nA(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=eA(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,tA(u,a,!1),u._siblingIndex=o._children.length-1,sA(u,!0))}}}}function iA(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=eA(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function rA(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r){var o=eA(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function oA(t,e,n){if(!(e.length<=0))for(var i=null,r=0;r<e.length;r++){var o=e[r];if(o&&o.targetInfo){if(!(i=eA(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof le?a[c].set(o.value):a[c]=o.value}}}}function aA(t){var e,n=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=eA(c.localID,h.targetMap))}if(s){var f,p=a.targetInfo;if(p){var d=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(d&&d.targetMap&&(f=eA(p.localID,d.targetMap))){var _=a.propertyPath.slice(),m=s;if(_.length>0){var v=_.pop();if(!v)return;for(var g=0;g<_.length&&(m=m[_[g]]);g++);if(!m)continue;m[v]=f}}}}}}function sA(t,e){void 0===e&&(e=!1);var n=t._prefab,i=null==n?void 0:n.instance;if(i){$C(t);var r={};i.targetMap=r,tA(t,r,!0),nA(0,i.mountedChildren,r),rA(0,i.removedComponents,r),iA(0,i.mountedComponents,r),oA(0,i.propertyOverrides,r)}e&&t&&t.children&&t.children.forEach((function(t){sA(t,!0)}))}function cA(t){var e=t._prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach((function(t){sA(t)}))}u._PrefabInfo=JC;var lA,uA,hA,fA,pA,dA,_A,mA,vA,gA,yA,xA,SA,TA,EA=Object.freeze({__proto__:null,TargetInfo:jC,TargetOverrideInfo:qC,CompPrefabInfo:XC,PropertyOverrideInfo:YC,MountedChildrenInfo:KC,MountedComponentsInfo:QC,PrefabInstance:ZC,PrefabInfo:JC,createNodeWithPrefab:$C,generateTargetMap:tA,getTarget:eA,applyMountedChildren:nA,applyMountedComponents:iA,applyRemovedComponents:rA,applyPropertyOverrides:oA,applyTargetOverrides:aA,expandPrefabInstanceNode:sA,expandNestedPrefabInstanceNode:cA}),bA=oe({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),CA=t("Prefab",dc("cc.Prefab")((_A=dA=function(t){function e(){var e;return ct(e=t.call(this)||this,"data",hA,ot(e)),ct(e,"optimizationPolicy",fA,ot(e)),ct(e,"persistent",pA,ot(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}$(e,t);var n=e.prototype;return n.createNode=function(t){var e=u.instantiate(this);e.name=this.name,t(null,e)},n.compileCreateFunction=function(){var t,e;this._createFunction=(e=(t=this.data)instanceof u._BaseNode&&t,new UE(t,e).result)},n._doInstantiate=function(t){return this.data._prefab||M(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)},n._instantiate=function(){var t;return this.optimizationPolicy!==bA.SINGLE_INSTANCE&&(this.optimizationPolicy===bA.MULTI_INSTANCE||this._instantiatedTimes+1>=e.OptimizationPolicyThreshold)?(t=this._doInstantiate(),this.data._instantiate(t)):t=this.data._instantiate(),++this._instantiatedTimes,t},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.data=new WC,this.data.name="(Missing Node)";var n=new u._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var t=this.data;cA(t),aA(t)},e}(Du),dA.OptimizationPolicy=bA,dA.OptimizationPolicyThreshold=3,hA=lt((uA=_A).prototype,"data",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fA=lt(uA.prototype,"optimizationPolicy",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bA.AUTO}}),pA=lt(uA.prototype,"persistent",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lA=uA))||lA);ie.value(CA,"_utils",EA),u.Prefab=CA,It(u,"cc._Prefab","Prefab"),t("PrefabLink",(mA=dc("cc.PrefabLink"),vA=Kc(CA),gA=Dc(),mA((TA=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"prefab",SA,ot(e)),e}return $(e,t),e}($u),SA=lt((xA=TA).prototype,"prefab",[vA,xc,gA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yA=xA))||yA));var AA=new Rn;function wA(t,e,n,i){i||(i=new Rn),t.convertToUINode(e,n,i);var r=n.position;return i.add(r),i}function RA(t,e,n){return n||(n=new Rn),t.worldToScreen(e,n),n.x/=u.view.getScaleX(),n.y/=u.view.getScaleY(),n}var PA,IA,MA=t("convertUtils",{WorldNode3DToLocalNodeUI:wA,WorldNode3DToWorldNodeUI:RA});u.pipelineUtils=MA,U(u.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=e[0],r=e[3]||AA;return i.convertToUINode(e[1],e[2],r),r.add(e[2].position),e[3]||r.clone()}}]),G(Jm.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),U(kS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var DA,OA=t("BufferAsset",dc("cc.BufferAsset")((lt((IA=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._buffer=null,e}$(e,t);var n=e.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},Z(e,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}}]),e}(Du)).prototype,"_nativeAsset",[ol],Object.getOwnPropertyDescriptor(IA.prototype,"_nativeAsset"),IA.prototype),PA=IA))||PA);u.BufferAsset=OA;var NA=((DA={})[pi.UNORM]="Uint",DA[pi.SNORM]="Int",DA[pi.UINT]="Uint",DA[pi.INT]="Int",DA[pi.UFLOAT]="Float",DA[pi.FLOAT]="Float",DA.default="Uint",DA);function LA(t){return""+(NA[t.type]||NA.default)+t.size/t.count*8}function BA(t,e,n,i,r){void 0===n&&(n=fi.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=Jr[n];r||(r=o.size);for(var a="set"+LA(o),s=o.size/o.count,c=Math.floor(e.length/o.count),l=lh.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,f=0;f<o.count;++f){var p=h+s*f;t[a](p,e[o.count*u+f],l)}}function FA(t,e,n,i,r,o){void 0===e&&(e=fi.R32F),void 0===n&&(n=0),void 0===i&&(i=t.byteLength-n),void 0===r&&(r=0),void 0===o&&(o=[]);var a=Jr[e];r||(r=a.size);for(var s="get"+LA(a),c=a.size/a.count,l=Math.floor(i/r),u=lh.isLittleEndian,h=0;h<l;++h)for(var f=n+r*h,p=0;p<a.count;++p){var d=f+c*p;o[a.count*h+p]=t[s](d,u)}return o}function zA(t,e,n,i,r,o,a){void 0===n&&(n=fi.R32F),void 0===i&&(i=0),void 0===r&&(r=t.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));var s=Jr[n];o||(o=s.size);for(var c="set"+LA(s),l="get"+LA(s),u=s.size/s.count,h=Math.floor(r/o),f=lh.isLittleEndian,p=0;p<h;++p)for(var d=i+o*p,_=0;_<s.count;++_){var m=d+u*_,v=t[l](m,f);a[c](m,e(v,_,t),f)}return a}var kA,UA,GA=t("RenderingSubMesh",function(){var t=e.prototype;function e(t,e,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new Ir(e,t,i,r),this._init()}return t._init=function(){},t.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var t=this.mesh,e=0,n=t.struct.primitives[this.subMeshIdx];n.indexView&&(e=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=t.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(t.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=t.readIndices(this.subMeshIdx),f=0;f<e;++f)for(var p=f*s,d=h[f]*s,_=0;_<s;++_)u[p+_]=l[d+_];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(t.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},t.destroy=function(){for(var t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var e=0;e<this._jointMappedBufferIndices.length;e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},t.enableVertexIdChannel=function(t){if(!this._vertexIdChannel){var e=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(t);this._vertexBuffers.push(i),this._attributes.push(new Rr("a_vertexId",fi.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:n}}},t._allocVertexIdBuffer=function(t){for(var e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(e),i=0;i<e;++i)n[i]=i+.5;var r=t.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},Z(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Rn.ZERO,max:Rn.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Rn.ZERO,max:Rn.ZERO}};var t=this.mesh,e=this.subMeshIdx,n=t.readAttribute(e,Ki.ATTR_POSITION),i=t.readIndices(e),r=new Rn,o=new Rn,a=this.attributes.find((function(t){return t.name===Ki.ATTR_POSITION}));if(a){var s=Jr[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var t=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var e=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,a=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===a.jointMapIndex||!o.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=u.director.root.device,c=0;c<a.vertexBundelIndices.length;c++){var l=o.vertexBundles[a.vertexBundelIndices[c]];r=0,i=fi.UNKNOWN;for(var h=0;h<l.attributes.length;h++){var f=l.attributes[h];if(f.name===Ki.ATTR_JOINTS){i=f.format;break}r+=Jr[f.format].size}i?function(){var u=new Uint8Array(t.mesh.data.buffer,l.view.offset,l.view.length),h=new DataView(u.slice().buffer),f=o.jointMaps[a.jointMapIndex];zA(h,(function(t){return f.indexOf(t)}),i,r,l.view.length,l.view.stride,h);var p=s.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE,l.view.length,l.view.stride));p.update(h.buffer),e.push(p),n.push(c)}():e.push(this.vertexBuffers[a.vertexBundelIndices[c]])}return this._vertexIdChannel&&e.push(this._allocVertexIdBuffer(s)),e}},{key:"iaInfo",get:function(){return this._iaInfo}}]),e}());!function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(kA||(kA=t("SystemEventType",{}))),function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.KEY_DOWN="keydown",t.KEY_PRESSING="key-pressing",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion"}(UA||(UA={})),u.SystemEventType=kA;var HA,VA=new Array(16),WA=null,jA=new Xn,qA=[HE.TOUCH_START,HE.TOUCH_MOVE,HE.TOUCH_END,HE.TOUCH_CANCEL],XA=[HE.MOUSE_DOWN,HE.MOUSE_ENTER,HE.MOUSE_MOVE,HE.MOUSE_LEAVE,HE.MOUSE_UP,HE.MOUSE_WHEEL];!function(t){t[t.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",t[t.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",t[t.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(HA||(HA={}));var YA,KA,QA,ZA,JA,$A,tw,ew,nw,iw,rw,ow,aw,sw,cw,lw,uw,hw,fw,pw,dw,_w,mw,vw,gw,yw,xw,Sw,Tw,Ew,bw,Cw,Aw,ww,Rw,Pw,Iw,Mw,Dw,Ow,Nw,Lw,Bw,Fw,zw,kw,Uw,Gw,Hw,Vw,Ww,jw,qw,Xw,Yw,Kw,Qw,Zw,Jw,$w,tR,eR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,fR,pR,dR,_R,mR,vR,gR,yR,xR,SR,TR,ER,bR,CR,AR,wR,RR,PR,IR,MR,DR,OR,NR,LR,BR,FR,zR,kR,UR,GR,HR,VR,WR,jR,qR,XR,YR,KR,QR,ZR,JR,$R,tP,eP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,fP,pP,dP,_P,mP,vP,gP,yP,xP,SP,TP,EP,bP,CP,AP,wP,RP,PP,IP,MP,DP,OP,NP,LP,BP,FP,zP,kP,UP,GP,HP,VP,WP,jP,qP,XP,YP,KP,QP,ZP,JP,$P,tI,eI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,fI,pI,dI,_I,mI,vI,gI,yI,xI,SI,TI,EI,bI,CI,AI,wI=function(){var t=e.prototype;function e(t){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=t}return t.setEnabled=function(t,n){if(void 0===n&&(n=!1),this._isEnabled!==t){this._isEnabled=t;var i=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(HA.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(t,!0)}},t._searchComponentsInParent=function(t){var e=this.node;if(t){for(var n=0,i=[],r=e;r&&WC.isNode(r);r=r.parent,++n){var o=r.getComponent(t);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t.reattach=function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))},t.destroy=function(){WA===this._node&&(WA=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(HA.REMOVE_POINTER_EVENT_PROCESSOR,this)},t._isTouchEvent=function(t){return-1!==qA.indexOf(t)},t._isMouseEvent=function(t){return-1!==XA.indexOf(t)},t._hasTouchListeners=function(){for(var t=0;t<qA.length;++t){var e=qA[t];if(this.hasEventListener(e))return!0}return!1},t._hasMouseListeners=function(){for(var t=0;t<XA.length;++t){var e=XA[t];if(this.hasEventListener(e))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(HA.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,n=new $l;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(HA.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n},t.on=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n),e},t.once=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n,!0),e},t.off=function(t,e,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(t,e,n)},t.targetOff=function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(HA.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(t,e,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(t,e,n,i,r,o)},t.dispatchEvent=function(t){var e,n=this.node,i=0;for(t.target=n,VA.length=0,this.getCapturingTargets(t.type,VA),t.eventPhase=1,i=VA.length-1;i>=0;--i)if((e=VA[i]).eventProcessor.capturingTarget&&(t.currentTarget=e,e.eventProcessor.capturingTarget.emit(t.type,t,VA),t.propagationStopped))return void(VA.length=0);if(VA.length=0,t.eventPhase=2,t.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(t.type,t),!t.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(this.getBubblingTargets(t.type,VA),t.eventPhase=3,i=0;i<VA.length;++i)if((e=VA[i]).eventProcessor.bubblingTarget&&(t.currentTarget=e,e.eventProcessor.bubblingTarget.emit(t.type,t),t.propagationStopped))return void(VA.length=0);VA.length=0},t.hasEventListener=function(t,e,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(t,e,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(t,e,n)),i},t.getCapturingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t.getBubblingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t._handleEventMouse=function(t){switch(t.type){case UA.MOUSE_DOWN:return this._handleMouseDown(t);case UA.MOUSE_MOVE:return this._handleMouseMove(t);case UA.MOUSE_UP:return this._handleMouseUp(t);case UA.MOUSE_WHEEL:return this._handleMouseWheel(t);default:return!1}},t._handleMouseDown=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(jA=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(jA)||(t.type=HE.MOUSE_DOWN,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseMove=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(jA=t.getUILocation(),e._uiProps.uiTransformComp.isHit(jA)?(this.previousMouseIn||(WA&&WA!==e&&(t.type=HE.MOUSE_LEAVE,WA.dispatchEvent(t),WA.eventProcessor.previousMouseIn=!1),WA=e,t.type=HE.MOUSE_ENTER,e.dispatchEvent(t),this.previousMouseIn=!0),t.type=HE.MOUSE_MOVE,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0):(this.previousMouseIn&&(t.type=HE.MOUSE_LEAVE,e.dispatchEvent(t),this.previousMouseIn=!1,WA=null),1)))},t._handleMouseUp=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(jA=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(jA)||(t.type=HE.MOUSE_UP,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseWheel=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(jA=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(jA)||(t.type=HE.MOUSE_WHEEL,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleEventTouch=function(t){switch(t.type){case UA.TOUCH_START:return this._handleTouchStart(t);case UA.TOUCH_MOVE:return this._handleTouchMove(t);case UA.TOUCH_END:return this._handleTouchEnd(t);case UA.TOUCH_CANCEL:return this._handleTouchCancel(t);default:return!1}},t._handleTouchStart=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.getUILocation(jA),!e._uiProps.uiTransformComp.isHit(jA)||(t.type=HE.TOUCH_START,t.bubbles=!0,e.dispatchEvent(t),0)))},t._handleTouchMove=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.type=HE.TOUCH_MOVE,t.bubbles=!0,e.dispatchEvent(t),0))},t._handleTouchEnd=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.getUILocation(jA),e._uiProps.uiTransformComp.isHit(jA)?t.type=HE.TOUCH_END:t.type=HE.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},t._handleTouchCancel=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.type=HE.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},Z(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();wI._maskComp=null,wI.callbacksInvoker=new $l,u.NodeEventProcessor=wI;var RI=new Rn(0,1,0),PI=new Rn,II=new Zn,MI=new An,DI=new Ln,OI=function(t){var e=1/Math.max(Math.max(Math.max(t.x,t.y),t.z),1e-4);e<1&&(t.x*=e,t.y*=e,t.z*=e)},NI=(YA=dc("cc.AmbientInfo"),KA=Ic(),QA=Sc("_skyColor"),ZA=Sc("_skyIllum"),JA=Sc("_groundAlbedo"),$A=Dc(),tw=Lc(),ew=Kc(Oe),nw=Lc(),iw=Dc(),rw=Lc(),YA(ow=KA((pw=function(){function t(){ct(this,"_skyColorHDR",sw,this),ct(this,"_skyIllumHDR",cw,this),ct(this,"_groundAlbedoHDR",lw,this),ct(this,"_skyColorLDR",uw,this),ct(this,"_skyIllumLDR",hw,this),ct(this,"_groundAlbedoLDR",fw,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},Z(t,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var t=u.director.root.pipeline.pipelineSceneData.isHDR;return II.set(t?this._skyColorHDR:this._skyColorLDR),OI(II),MI.set(255*II.x,255*II.y,255*II.z,255)},set:function(t){II.set(t.x,t.y,t.z,t.w),u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(II):this._skyColorLDR.set(II),this._resource&&this._resource.skyColor.set(II)}},{key:"skyColor",set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._resource&&this._resource.skyColor.set(t)}},{key:"skyIllum",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t,this._resource&&(this._resource.skyIllum=t)}},{key:"groundLightingColor",get:function(){var t=u.director.root.pipeline.pipelineSceneData.isHDR;return II.set(t?this._groundAlbedoHDR:this._groundAlbedoLDR),OI(II),MI.set(255*II.x,255*II.y,255*II.z,255)},set:function(t){II.set(t.x,t.y,t.z,t.w),u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(II):this._groundAlbedoLDR.set(II),this._resource&&this._resource.groundAlbedo.set(II)}},{key:"groundAlbedo",set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._resource&&this._resource.groundAlbedo.set(t)}}]),t}(),sw=lt((aw=pw).prototype,"_skyColorHDR",[xc,QA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.5,.8,1)}}),cw=lt(aw.prototype,"_skyIllumHDR",[xc,ZA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $S.SKY_ILLUM}}),lw=lt(aw.prototype,"_groundAlbedoHDR",[xc,JA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.2,.2,1)}}),uw=lt(aw.prototype,"_skyColorLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.5,.8,1)}}),hw=lt(aw.prototype,"_skyIllumLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $S.SKY_ILLUM}}),fw=lt(aw.prototype,"_groundAlbedoLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.2,.2,1)}}),lt(aw.prototype,"skyLightingColor",[$A,Mc,tw],Object.getOwnPropertyDescriptor(aw.prototype,"skyLightingColor"),aw.prototype),lt(aw.prototype,"skyIllum",[Mc,ew,nw],Object.getOwnPropertyDescriptor(aw.prototype,"skyIllum"),aw.prototype),lt(aw.prototype,"groundLightingColor",[iw,Mc,rw],Object.getOwnPropertyDescriptor(aw.prototype,"groundLightingColor"),aw.prototype),ow=aw))||ow)||ow);u.AmbientInfo=NI;var LI=(dw=dc("cc.SkyboxInfo"),_w=Ic(),mw=Kc(bv),vw=Sc("_envmap"),gw=Kc(bv),yw=Kc(bv),xw=Kc(bv),Sw=Dc(),Tw=Lc(),Ew=Gc(),bw=Lc(),Cw=Lc(),Aw=Lc(),ww=Kc(bv),Rw=Lc(),Pw=Dc(),Iw=Kc(bv),Mw=Gc(),dw(Dw=_w((Hw=function(){function t(){ct(this,"_applyDiffuseMap",Nw,this),ct(this,"_envmapHDR",Lw,this),ct(this,"_envmapLDR",Bw,this),ct(this,"_diffuseMapHDR",Fw,this),ct(this,"_diffuseMapLDR",zw,this),ct(this,"_enabled",kw,this),ct(this,"_useIBL",Uw,this),ct(this,"_useHDR",Gw,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},Z(t,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(t){this._applyDiffuseMap=t,this._resource&&(this._resource.useDiffuseMap=t)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR=t,this._useHDR=t,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=t:this._envmapLDR=t,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=t)}},{key:"diffuseMap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=t:this._diffuseMapLDR=t,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),t}(),Nw=lt((Ow=Hw).prototype,"_applyDiffuseMap",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lw=lt(Ow.prototype,"_envmapHDR",[xc,mw,vw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bw=lt(Ow.prototype,"_envmapLDR",[xc,gw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fw=lt(Ow.prototype,"_diffuseMapHDR",[xc,yw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zw=lt(Ow.prototype,"_diffuseMapLDR",[xc,xw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kw=lt(Ow.prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uw=lt(Ow.prototype,"_useIBL",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gw=lt(Ow.prototype,"_useHDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(Ow.prototype,"applyDiffuseMap",[Sw,Mc,Tw,Ew],Object.getOwnPropertyDescriptor(Ow.prototype,"applyDiffuseMap"),Ow.prototype),lt(Ow.prototype,"enabled",[Mc,bw],Object.getOwnPropertyDescriptor(Ow.prototype,"enabled"),Ow.prototype),lt(Ow.prototype,"useIBL",[Mc,Cw],Object.getOwnPropertyDescriptor(Ow.prototype,"useIBL"),Ow.prototype),lt(Ow.prototype,"useHDR",[Mc,Aw],Object.getOwnPropertyDescriptor(Ow.prototype,"useHDR"),Ow.prototype),lt(Ow.prototype,"envmap",[Mc,ww,Rw],Object.getOwnPropertyDescriptor(Ow.prototype,"envmap"),Ow.prototype),lt(Ow.prototype,"diffuseMap",[Pw,Mc,Oc,Iw,Mw],Object.getOwnPropertyDescriptor(Ow.prototype,"diffuseMap"),Ow.prototype),Dw=Ow))||Dw)||Dw);u.SkyboxInfo=LI;var BI=(Vw=dc("cc.FogInfo"),Ww=Ic(),jw=Lc(),qw=Gc(),Xw=Lc(),Yw=Gc(),Kw=Lc(),Qw=Kc(EE),Zw=Gc(),Jw=Lc(),$w=Dc(),tR=Kc(Oe),eR=Bc(),nR=kc(),iR=Lc(),rR=Dc(),oR=Kc(Oe),aR=kc(),sR=Lc(),cR=Dc(),lR=Kc(Oe),uR=kc(),hR=Lc(),fR=Dc(),pR=Kc(Oe),dR=Fc(),_R=kc(),mR=Lc(),vR=Dc(),gR=Kc(Oe),yR=kc(),xR=Lc(),SR=Dc(),TR=Kc(Oe),ER=kc(),bR=Lc(),Vw(CR=Ww((zR=FR=function(){function t(){ct(this,"_type",wR,this),ct(this,"_fogColor",RR,this),ct(this,"_enabled",PR,this),ct(this,"_fogDensity",IR,this),ct(this,"_fogStart",MR,this),ct(this,"_fogEnd",DR,this),ct(this,"_fogAtten",OR,this),ct(this,"_fogTop",NR,this),ct(this,"_fogRange",LR,this),ct(this,"_accurate",BR,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.activate()},Z(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._accurate!==t&&(this._accurate=t,this._resource&&(this._resource.accurate=t,t&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}}]),t}(),FR.FogType=EE,wR=lt((AR=zR).prototype,"_type",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EE.LINEAR}}),RR=lt(AR.prototype,"_fogColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An("#C8C8C8")}}),PR=lt(AR.prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IR=lt(AR.prototype,"_fogDensity",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),MR=lt(AR.prototype,"_fogStart",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),DR=lt(AR.prototype,"_fogEnd",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),OR=lt(AR.prototype,"_fogAtten",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),NR=lt(AR.prototype,"_fogTop",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),LR=lt(AR.prototype,"_fogRange",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),BR=lt(AR.prototype,"_accurate",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(AR.prototype,"enabled",[Mc,jw,qw],Object.getOwnPropertyDescriptor(AR.prototype,"enabled"),AR.prototype),lt(AR.prototype,"accurate",[Mc,Xw,Yw],Object.getOwnPropertyDescriptor(AR.prototype,"accurate"),AR.prototype),lt(AR.prototype,"fogColor",[Mc,Kw],Object.getOwnPropertyDescriptor(AR.prototype,"fogColor"),AR.prototype),lt(AR.prototype,"type",[Mc,Qw,Zw,Jw],Object.getOwnPropertyDescriptor(AR.prototype,"type"),AR.prototype),lt(AR.prototype,"fogDensity",[$w,tR,eR,nR,Uc,iR],Object.getOwnPropertyDescriptor(AR.prototype,"fogDensity"),AR.prototype),lt(AR.prototype,"fogStart",[rR,oR,aR,sR],Object.getOwnPropertyDescriptor(AR.prototype,"fogStart"),AR.prototype),lt(AR.prototype,"fogEnd",[cR,lR,uR,hR],Object.getOwnPropertyDescriptor(AR.prototype,"fogEnd"),AR.prototype),lt(AR.prototype,"fogAtten",[fR,pR,dR,_R,mR],Object.getOwnPropertyDescriptor(AR.prototype,"fogAtten"),AR.prototype),lt(AR.prototype,"fogTop",[vR,gR,yR,xR],Object.getOwnPropertyDescriptor(AR.prototype,"fogTop"),AR.prototype),lt(AR.prototype,"fogRange",[SR,TR,ER,bR],Object.getOwnPropertyDescriptor(AR.prototype,"fogRange"),AR.prototype),CR=AR))||CR)||CR),FI=(kR=dc("cc.ShadowsInfo"),UR=Ic(),GR=Lc(),HR=Kc(yg),VR=Dc(),WR=Dc(),jR=Lc(),qR=Kc(Oe),XR=Lc(),YR=Dc(),KR=Bc(),QR=Kc(Oe),ZR=Lc(),JR=Dc(),$R=Kc(xg),tP=Lc(),eP=Dc(),nP=Kc(De),iP=Dc(),rP=Kc(Oe),oP=Lc(),aP=Dc(),sP=Kc(Oe),cP=Lc(),lP=Dc(),uP=Kc(gg),hP=Lc(),fP=Dc(),pP=Kc(Ne),dP=Lc(),_P=Dc(),mP=Kc(Oe),vP=Lc(),gP=Dc(),yP=Kc(Oe),xP=Lc(),SP=Dc(),TP=Bc(),EP=Kc(Oe),bP=Lc(),CP=Dc(),AP=Bc(),wP=Kc(Oe),RP=Lc(),PP=Dc(),IP=Kc(Oe),MP=Lc(),DP=Dc(),kR(OP=UR(($P=function(){function t(){ct(this,"_type",LP,this),ct(this,"_enabled",BP,this),ct(this,"_normal",FP,this),ct(this,"_distance",zP,this),ct(this,"_shadowColor",kP,this),ct(this,"_firstSetCSM",UP,this),ct(this,"_fixedArea",GP,this),ct(this,"_pcf",HP,this),ct(this,"_bias",VP,this),ct(this,"_normalBias",WP,this),ct(this,"_near",jP,this),ct(this,"_far",qP,this),ct(this,"_shadowDistance",XP,this),ct(this,"_invisibleOcclusionRange",YP,this),ct(this,"_orthoSize",KP,this),ct(this,"_maxReceived",QP,this),ct(this,"_size",ZP,this),ct(this,"_saturation",JP,this),this._resource=null}var e=t.prototype;return e.setPlaneFromNode=function(t){t.getWorldRotation(DI),this.normal=Rn.transformQuat(PI,RI,DI),t.getWorldPosition(PI),this.distance=Rn.dot(this._normal,PI)},e.activate=function(t){this.pcf=Math.min(this._pcf,xg.SOFT_2X),this._resource=t,this._resource.initialize(this),this._resource.activate()},Z(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}},{key:"normal",get:function(){return this._normal},set:function(t){Rn.copy(this._normal,t),this._resource&&(this._resource.normal=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t,this._resource&&(this._resource.distance=t)}},{key:"saturation",get:function(){return this._saturation},set:function(t){t>1?(this._saturation=t/t,this._resource&&(this._resource.saturation=t/t)):(this._saturation=t,this._resource&&(this._resource.saturation=t))}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t,this._resource&&(this._resource.bias=t)}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t,this._resource&&(this._resource.normalBias=t)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t,this._resource&&(this._resource.fixedArea=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._resource&&(this._resource.near=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=Math.min(t,Tg.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=Math.min(t,Tg.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=Math.min(t,Tg.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}}]),t}(),LP=lt((NP=$P).prototype,"_type",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yg.Planar}}),BP=lt(NP.prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FP=lt(NP.prototype,"_normal",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(0,1,0)}}),zP=lt(NP.prototype,"_distance",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kP=lt(NP.prototype,"_shadowColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(0,0,0,76)}}),UP=lt(NP.prototype,"_firstSetCSM",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GP=lt(NP.prototype,"_fixedArea",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HP=lt(NP.prototype,"_pcf",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xg.HARD}}),VP=lt(NP.prototype,"_bias",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),WP=lt(NP.prototype,"_normalBias",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jP=lt(NP.prototype,"_near",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),qP=lt(NP.prototype,"_far",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),XP=lt(NP.prototype,"_shadowDistance",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),YP=lt(NP.prototype,"_invisibleOcclusionRange",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),KP=lt(NP.prototype,"_orthoSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),QP=lt(NP.prototype,"_maxReceived",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),ZP=lt(NP.prototype,"_size",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(512,512)}}),JP=lt(NP.prototype,"_saturation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),lt(NP.prototype,"enabled",[Mc,GR],Object.getOwnPropertyDescriptor(NP.prototype,"enabled"),NP.prototype),lt(NP.prototype,"type",[Mc,HR],Object.getOwnPropertyDescriptor(NP.prototype,"type"),NP.prototype),lt(NP.prototype,"shadowColor",[VR],Object.getOwnPropertyDescriptor(NP.prototype,"shadowColor"),NP.prototype),lt(NP.prototype,"normal",[WR,jR],Object.getOwnPropertyDescriptor(NP.prototype,"normal"),NP.prototype),lt(NP.prototype,"distance",[qR,XR,YR],Object.getOwnPropertyDescriptor(NP.prototype,"distance"),NP.prototype),lt(NP.prototype,"saturation",[Mc,KR,Uc,QR,ZR,JR],Object.getOwnPropertyDescriptor(NP.prototype,"saturation"),NP.prototype),lt(NP.prototype,"pcf",[$R,tP,eP],Object.getOwnPropertyDescriptor(NP.prototype,"pcf"),NP.prototype),lt(NP.prototype,"maxReceived",[nP,iP],Object.getOwnPropertyDescriptor(NP.prototype,"maxReceived"),NP.prototype),lt(NP.prototype,"bias",[rP,oP,aP],Object.getOwnPropertyDescriptor(NP.prototype,"bias"),NP.prototype),lt(NP.prototype,"normalBias",[sP,cP,lP],Object.getOwnPropertyDescriptor(NP.prototype,"normalBias"),NP.prototype),lt(NP.prototype,"shadowMapSize",[uP,hP,fP],Object.getOwnPropertyDescriptor(NP.prototype,"shadowMapSize"),NP.prototype),lt(NP.prototype,"fixedArea",[pP,dP,_P],Object.getOwnPropertyDescriptor(NP.prototype,"fixedArea"),NP.prototype),lt(NP.prototype,"near",[mP,vP,gP],Object.getOwnPropertyDescriptor(NP.prototype,"near"),NP.prototype),lt(NP.prototype,"far",[yP,xP,SP],Object.getOwnPropertyDescriptor(NP.prototype,"far"),NP.prototype),lt(NP.prototype,"invisibleOcclusionRange",[Mc,TP,Uc,EP,bP,CP],Object.getOwnPropertyDescriptor(NP.prototype,"invisibleOcclusionRange"),NP.prototype),lt(NP.prototype,"shadowDistance",[Mc,AP,Uc,wP,RP,PP],Object.getOwnPropertyDescriptor(NP.prototype,"shadowDistance"),NP.prototype),lt(NP.prototype,"orthoSize",[IP,MP,DP],Object.getOwnPropertyDescriptor(NP.prototype,"orthoSize"),NP.prototype),OP=NP))||OP)||OP);u.ShadowsInfo=FI;var zI=new Rn(-1024,-1024,-1024),kI=new Rn(1024,1024,1024),UI=(tI=dc("cc.OctreeInfo"),eI=Ic(),nI=Lc(),iI=Lc(),rI=Nc(),oI=Lc(),aI=Nc(),sI=Bc(),cI=Kc(De),lI=Lc(),tI(uI=eI((mI=function(){function t(){ct(this,"_enabled",fI,this),ct(this,"_minPos",pI,this),ct(this,"_maxPos",dI,this),ct(this,"_depth",_I,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},Z(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t,this._resource&&(this._resource.minPos=t)}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t,this._resource&&(this._resource.maxPos=t)}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t,this._resource&&(this._resource.depth=t)}}]),t}(),fI=lt((hI=mI).prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pI=lt(hI.prototype,"_minPos",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(zI)}}),dI=lt(hI.prototype,"_maxPos",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(kI)}}),_I=lt(hI.prototype,"_depth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),lt(hI.prototype,"enabled",[Mc,nI],Object.getOwnPropertyDescriptor(hI.prototype,"enabled"),hI.prototype),lt(hI.prototype,"minPos",[Mc,iI,rI],Object.getOwnPropertyDescriptor(hI.prototype,"minPos"),hI.prototype),lt(hI.prototype,"maxPos",[Mc,oI,aI],Object.getOwnPropertyDescriptor(hI.prototype,"maxPos"),hI.prototype),lt(hI.prototype,"depth",[Mc,sI,cI,lI],Object.getOwnPropertyDescriptor(hI.prototype,"depth"),hI.prototype),uI=hI))||uI)||uI),GI=(vI=dc("cc.SceneGlobals"),gI=Kc(LI),vI((AI=function(){function t(){ct(this,"ambient",SI,this),ct(this,"shadows",TI,this),ct(this,"_skybox",EI,this),ct(this,"fog",bI,this),ct(this,"octree",CI,this)}return t.prototype.activate=function(){var t=u.director.root.pipeline.pipelineSceneData;this.skybox.activate(t.skybox),this.ambient.activate(t.ambient),this.shadows.activate(t.shadows),this.fog.activate(t.fog),this.octree.activate(t.octree)},Z(t,[{key:"skybox",get:function(){return this._skybox},set:function(t){this._skybox=t}}]),t}(),SI=lt((xI=AI).prototype,"ambient",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new NI}}),TI=lt(xI.prototype,"shadows",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new FI}}),EI=lt(xI.prototype,"_skybox",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new LI}}),bI=lt(xI.prototype,"fog",[Mc,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BI}}),lt(xI.prototype,"skybox",[Mc,gI],Object.getOwnPropertyDescriptor(xI.prototype,"skybox"),xI.prototype),CI=lt(xI.prototype,"octree",[Mc,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new UI}}),yI=xI))||yI);u.SceneGlobals=GI;var HI=t("Event",function(){function t(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}var e=t.prototype;return e.unuse=function(){this.type=t.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=t.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},e.reuse=function(t,e){this.type=t,this.bubbles=e||!1},e.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},e.getCurrentTarget=function(){return this.currentTarget},e.getType=function(){return this.type},t}());HI.NO_TYPE="no_type",HI.TOUCH="touch",HI.MOUSE="mouse",HI.KEYBOARD="keyboard",HI.ACCELERATION="acceleration",HI.NONE=0,HI.CAPTURING_PHASE=1,HI.AT_TARGET=2,HI.BUBBLING_PHASE=3,u.Event=HI;var VI=t("EventAcceleration",function(t){function e(e,n){var i;return(i=t.call(this,kA.DEVICEMOTION,n)||this).acc=void 0,i.acc=e,i}return $(e,t),e}(HI));HI.EventAcceleration=VI;var WI=t("EventKeyboard",function(t){function e(e,n,i){var r;return"boolean"==typeof n&&(n=n?kA.KEY_DOWN:kA.KEY_UP),(r=t.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==kA.KEY_UP,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r}return $(e,t),Z(e,[{key:"isPressed",get:function(){return this._isPressed}}]),e}(HI));HI.EventKeyboard=WI;var jI=t("EventMouse",function(t){function e(n,i,r){var o;return(o=t.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=e.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}$(e,t);var n=e.prototype;return n.setScrollData=function(t,e){this._scrollX=t,this._scrollY=e},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(t,e){this._x=t,this._y=e},n.getLocation=function(t){return t||(t=new Xn),Xn.set(t,this._x,this._y),t},n.getLocationInView=function(t){return t||(t=new Xn),Xn.set(t,this._x,u.view._designResolutionSize.height-this._y),t},n.getUILocation=function(t){return t||(t=new Xn),Xn.set(t,this._x,this._y),u.view._convertToUISpace(t),t},n.getPreviousLocation=function(t){return t||(t=new Xn),Xn.set(t,this._prevX,this._prevY),t},n.getUIPreviousLocation=function(t){return t||(t=new Xn),Xn.set(t,this._prevX,this._prevY),u.view._convertToUISpace(t),t},n.getDelta=function(t){return t||(t=new Xn),Xn.set(t,this._x-this._prevX,this._y-this._prevY),t},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(t){return t||(t=new Xn),Xn.set(t,(this._x-this._prevX)/u.view.getScaleX(),(this._y-this._prevY)/u.view.getScaleY()),t},n.getUIDeltaX=function(){return(this._x-this._prevX)/u.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/u.view.getScaleY()},n.setButton=function(t){this._button=t},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var t=u.view.getViewportRect();return(this._x-t.x)/u.view.getScaleX()},n.getUILocationY=function(){var t=u.view.getViewportRect();return(this._y-t.y)/u.view.getScaleY()},Z(e,[{key:"eventType",get:function(){return this._eventType}}]),e}(HI));jI.BUTTON_MISSING=-1,jI.BUTTON_LEFT=0,jI.BUTTON_RIGHT=2,jI.BUTTON_MIDDLE=1,jI.BUTTON_4=3,jI.BUTTON_5=4,jI.BUTTON_6=5,jI.BUTTON_7=6,jI.BUTTON_8=7,HI.EventMouse=jI;var qI=new Xn,XI=t("EventTouch",function(t){function e(e,n,i,r){var o;return void 0===r&&(r=[]),(o=t.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=e||[],o._allTouches=r,o}$(e,t);var n=e.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)},n.getLocation=function(t){return this.touch?this.touch.getLocation(t):new Xn},n.getUILocation=function(t){return this.touch?this.touch.getUILocation(t):new Xn},n.getLocationInView=function(t){return this.touch?this.touch.getLocationInView(t):new Xn},n.getPreviousLocation=function(t){return this.touch?this.touch.getPreviousLocation(t):new Xn},n.getStartLocation=function(t){return this.touch?this.touch.getStartLocation(t):new Xn},n.getUIStartLocation=function(t){return this.touch?this.touch.getUIStartLocation(t):new Xn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(t){return this.touch?this.touch.getDelta(t):new Xn},n.getUIDelta=function(t){return this.touch?this.touch.getUIDelta(t):new Xn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(qI).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(qI).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},e}(HI));XI.MAX_TOUCHES=5,HI.EventTouch=XI;var YI,KI=t("Acceleration",(function(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=n,this.timestamp=i}));!function(t){t[t.NONE=0]="NONE",t[t.MOBILE_BACK=6]="MOBILE_BACK",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT_LEFT=16]="SHIFT_LEFT",t[t.CTRL_LEFT=17]="CTRL_LEFT",t[t.ALT_LEFT=18]="ALT_LEFT",t[t.PAUSE=19]="PAUSE",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESCAPE=27]="ESCAPE",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.ARROW_LEFT=37]="ARROW_LEFT",t[t.ARROW_UP=38]="ARROW_UP",t[t.ARROW_RIGHT=39]="ARROW_RIGHT",t[t.ARROW_DOWN=40]="ARROW_DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_1=49]="DIGIT_1",t[t.DIGIT_2=50]="DIGIT_2",t[t.DIGIT_3=51]="DIGIT_3",t[t.DIGIT_4=52]="DIGIT_4",t[t.DIGIT_5=53]="DIGIT_5",t[t.DIGIT_6=54]="DIGIT_6",t[t.DIGIT_7=55]="DIGIT_7",t[t.DIGIT_8=56]="DIGIT_8",t[t.DIGIT_9=57]="DIGIT_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MULTIPLY=106]="NUM_MULTIPLY",t[t.NUM_PLUS=107]="NUM_PLUS",t[t.NUM_SUBTRACT=109]="NUM_SUBTRACT",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIVIDE=111]="NUM_DIVIDE",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.COMMA=188]="COMMA",t[t.DASH=189]="DASH",t[t.PERIOD=190]="PERIOD",t[t.SLASH=191]="SLASH",t[t.BACK_QUOTE=192]="BACK_QUOTE",t[t.BRACKET_LEFT=219]="BRACKET_LEFT",t[t.BACKSLASH=220]="BACKSLASH",t[t.BRACKET_RIGHT=221]="BRACKET_RIGHT",t[t.QUOTE=222]="QUOTE",t[t.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",t[t.CTRL_RIGHT=2001]="CTRL_RIGHT",t[t.ALT_RIGHT=2002]="ALT_RIGHT",t[t.NUM_ENTER=2003]="NUM_ENTER"}(YI||(YI=t("KeyCode",{})));var QI=new Xn,ZI=t("Touch",function(){function t(t,e,n){void 0===n&&(n=0),this._point=new Xn,this._prevPoint=new Xn,this._lastModified=0,this._id=0,this._startPoint=new Xn,this._startPointCaptured=!1,this.setTouchInfo(n,t,e)}var e=t.prototype;return e.getLocation=function(t){return t||(t=new Xn),t.set(this._point.x,this._point.y),t},e.getLocationX=function(){return this._point.x},e.getLocationY=function(){return this._point.y},e.getUILocation=function(t){return t||(t=new Xn),t.set(this._point.x,this._point.y),u.view._convertToUISpace(t),t},e.getUILocationX=function(){var t=u.view.getViewportRect();return(this._point.x-t.x)/u.view.getScaleX()},e.getUILocationY=function(){var t=u.view.getViewportRect();return(this._point.y-t.y)/u.view.getScaleY()},e.getPreviousLocation=function(t){return t||(t=new Xn),t.set(this._prevPoint.x,this._prevPoint.y),t},e.getUIPreviousLocation=function(t){return t||(t=new Xn),t.set(this._prevPoint.x,this._prevPoint.y),u.view._convertToUISpace(t),t},e.getStartLocation=function(t){return t||(t=new Xn),t.set(this._startPoint.x,this._startPoint.y),t},e.getUIStartLocation=function(t){return t||(t=new Xn),t.set(this._startPoint.x,this._startPoint.y),u.view._convertToUISpace(t),t},e.getDelta=function(t){return t||(t=new Xn),t.set(this._point),t.subtract(this._prevPoint),t},e.getUIDelta=function(t){return t||(t=new Xn),QI.set(this._point),QI.subtract(this._prevPoint),t.set(u.view.getScaleX(),u.view.getScaleY()),Xn.divide(t,QI,t),t},e.getLocationInView=function(t){return t||(t=new Xn),t.set(this._point.x,u.view._designResolutionSize.height-this._point.y),t},e.getPreviousLocationInView=function(t){return t||(t=new Xn),t.set(this._prevPoint.x,u.view._designResolutionSize.height-this._prevPoint.y),t},e.getStartLocationInView=function(t){return t||(t=new Xn),t.set(this._startPoint.x,u.view._designResolutionSize.height-this._startPoint.y),t},e.getID=function(){return this._id},e.setTouchInfo=function(t,e,n){void 0===t&&(t=0),this._prevPoint=this._point,this._point=new Xn(e||0,n||0),this._id=t,this._startPointCaptured||(this._startPoint=new Xn(this._point),this._startPointCaptured=!0)},e.setPoint=function(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=u.game.frameStartTime},e.setPrevPoint=function(t,e){this._prevPoint="object"==typeof t?new Xn(t.x,t.y):new Xn(t||0,e||0),this._lastModified=u.game.frameStartTime},Z(t,[{key:"lastModified",get:function(){return this._lastModified}}]),t}());u.Touch=ZI;var JI,$I,tM=function(){function t(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new eu,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,_u.browserType===iu.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var e=t.prototype;return e._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._didAccelerate=function(t){var e=performance.now();if(!(e-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=e;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=t.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=t;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(ah.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),_u.os===au.ANDROID&&_u.browserType!==iu.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new KI(n,i,r,l),h=new VI(u);this._eventTarget.emit(UA.DEVICEMOTION,h)}},e.start=function(){var t=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){"granted"===e&&t._registerEvent()})).catch((function(){})):this._registerEvent()},e.stop=function(){this._unregisterEvent()},e.setInterval=function(t){this._intervalInMileSeconds=t},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),eM={Backspace:YI.BACKSPACE,Tab:YI.TAB,Enter:YI.ENTER,ShiftLeft:YI.SHIFT_LEFT,ControlLeft:YI.CTRL_LEFT,AltLeft:YI.ALT_LEFT,ShiftRight:YI.SHIFT_RIGHT,ControlRight:YI.CTRL_RIGHT,AltRight:YI.ALT_RIGHT,Pause:YI.PAUSE,CapsLock:YI.CAPS_LOCK,Escape:YI.ESCAPE,Space:YI.SPACE,PageUp:YI.PAGE_UP,PageDown:YI.PAGE_DOWN,End:YI.END,Home:YI.HOME,ArrowLeft:YI.ARROW_LEFT,ArrowUp:YI.ARROW_UP,ArrowRight:YI.ARROW_RIGHT,ArrowDown:YI.ARROW_DOWN,Insert:YI.INSERT,Delete:YI.DELETE,Digit0:YI.DIGIT_0,Digit1:YI.DIGIT_1,Digit2:YI.DIGIT_2,Digit3:YI.DIGIT_3,Digit4:YI.DIGIT_4,Digit5:YI.DIGIT_5,Digit6:YI.DIGIT_6,Digit7:YI.DIGIT_7,Digit8:YI.DIGIT_8,Digit9:YI.DIGIT_9,KeyA:YI.KEY_A,KeyB:YI.KEY_B,KeyC:YI.KEY_C,KeyD:YI.KEY_D,KeyE:YI.KEY_E,KeyF:YI.KEY_F,KeyG:YI.KEY_G,KeyH:YI.KEY_H,KeyI:YI.KEY_I,KeyJ:YI.KEY_J,KeyK:YI.KEY_K,KeyL:YI.KEY_L,KeyM:YI.KEY_M,KeyN:YI.KEY_N,KeyO:YI.KEY_O,KeyP:YI.KEY_P,KeyQ:YI.KEY_Q,KeyR:YI.KEY_R,KeyS:YI.KEY_S,KeyT:YI.KEY_T,KeyU:YI.KEY_U,KeyV:YI.KEY_V,KeyW:YI.KEY_W,KeyX:YI.KEY_X,KeyY:YI.KEY_Y,KeyZ:YI.KEY_Z,Numpad0:YI.NUM_0,Numpad1:YI.NUM_1,Numpad2:YI.NUM_2,Numpad3:YI.NUM_3,Numpad4:YI.NUM_4,Numpad5:YI.NUM_5,Numpad6:YI.NUM_6,Numpad7:YI.NUM_7,Numpad8:YI.NUM_8,Numpad9:YI.NUM_9,NumpadMultiply:YI.NUM_MULTIPLY,NumpadAdd:YI.NUM_PLUS,NumpadSubtract:YI.NUM_SUBTRACT,NumpadDecimal:YI.NUM_DECIMAL,NumpadDivide:YI.NUM_DIVIDE,NumpadEnter:YI.NUM_ENTER,F1:YI.F1,F2:YI.F2,F3:YI.F3,F4:YI.F4,F5:YI.F5,F6:YI.F6,F7:YI.F7,F8:YI.F8,F9:YI.F9,F10:YI.F10,F11:YI.F11,F12:YI.F12,NumLock:YI.NUM_LOCK,ScrollLock:YI.SCROLL_LOCK,Semicolon:YI.SEMICOLON,Equal:YI.EQUAL,Comma:YI.COMMA,Minus:YI.DASH,Period:YI.PERIOD,Slash:YI.SLASH,Backquote:YI.BACK_QUOTE,BracketLeft:YI.BRACKET_LEFT,Backslash:YI.BACKSLASH,BracketRight:YI.BRACKET_RIGHT,Quote:YI.QUOTE},nM=function(){function t(){this._eventTarget=new eu,this._registerEvent()}var e=t.prototype;return e._registerEvent=function(){var t=this,e=document.getElementById("GameCanvas");null==e||e.addEventListener("keydown",(function(e){if(e.stopPropagation(),e.preventDefault(),e.repeat){var n=t._getInputEvent(e,UA.KEY_PRESSING);t._eventTarget.emit(UA.KEY_PRESSING,n)}else{var i=t._getInputEvent(e,UA.KEY_DOWN);t._eventTarget.emit(UA.KEY_DOWN,i)}})),null==e||e.addEventListener("keyup",(function(e){var n=t._getInputEvent(e,UA.KEY_UP);e.stopPropagation(),e.preventDefault(),t._eventTarget.emit(UA.KEY_UP,n)}))},e._getInputEvent=function(t,e){var n,i=(n=t.code,eM[n]||YI.NONE);return new WI(i,e)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),iM=function(){function t(){this._canvas=void 0,this._eventTarget=new eu,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Xn,_u.hasFeature(cu.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new ni(e.x,e.y,e.width,e.height):new ni(0,0,0,0)},e._getLocation=function(t){var e=this._getCanvasRect(),n=ah.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+t.movementX:t.clientX-e.x,r=this._pointLocked?this._preMousePos.y/n-t.movementY:e.y+e.height-t.clientY;return new Xn(i*=n,r*=n)},e._registerEvent=function(){var t,e,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(t=this._canvas)||void 0===t||t.addEventListener("mousedown",this._createCallback(UA.MOUSE_DOWN)),null===(e=this._canvas)||void 0===e||e.addEventListener("mousemove",this._createCallback(UA.MOUSE_MOVE));var o=this._createCallback(UA.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},e._registerPointerLockEvent=function(){var t=this,e=function(){var e=t._canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)},e._createCallback=function(t){var e=this;return function(n){var i,r=e._getLocation(n),o=n.button;switch(t){case UA.MOUSE_DOWN:null===(i=e._canvas)||void 0===i||i.focus(),e._isPressed=!0;break;case UA.MOUSE_UP:e._isPressed=!1;break;case UA.MOUSE_MOVE:e._isPressed||(o=jI.BUTTON_MISSING)}var a=new jI(t,!1,e._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,e._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),e._eventTarget.emit(t,a)}},e._handleMouseWheel=function(t){var e=UA.MOUSE_WHEEL,n=this._getLocation(t),i=t.button,r=new jI(e,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=t.movementX,r.movementY=t.movementY,r.setScrollData(5*t.deltaX,5*-t.deltaY),this._preMousePos.set(n.x,n.y),t.stopPropagation(),t.target===this._canvas&&t.preventDefault(),this._eventTarget.emit(e,r)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),rM=new Xn,oM=new(function(){function t(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var e=t.prototype;return e._cloneTouch=function(t){var e=t.getID();t.getStartLocation(rM);var n=new ZI(rM.x,rM.y,e);return t.getLocation(rM),n.setPoint(rM.x,rM.y),t.getPreviousLocation(rM),n.setPrevPoint(rM),n},e._createTouch=function(t,e,n){if(this._touchMap.has(t))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(t)){var i=new ZI(e,n,t);return this._touchMap.set(t,i),this._updateTouch(i,e,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},e.releaseTouch=function(t){this._touchMap.has(t)&&this._touchMap.delete(t)},e.getTouch=function(t,e,n){var i=this._touchMap.get(t);return i?this._updateTouch(i,e,n):i=this._createTouch(t,e,n),i?this._cloneTouch(i):void 0},e.getAllTouches=function(){var t=this,e=[];return this._touchMap.forEach((function(n){if(n){var i=t._cloneTouch(n);e.push(i)}})),e},e._updateTouch=function(t,e,n){t.getLocation(rM),t.setPrevPoint(rM),t.setPoint(e,n)},e._checkTouchMapSizeMoreThanMax=function(t){var e=this;if(this._touchMap.has(t))return!1;var n=ue.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(t){i-t.lastModified>ue.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+t.getID()+"."),e.releaseTouch(t.getID()))})),n>=this._touchMap.size},t}()),aM=function(){function t(){this._canvas=void 0,this._eventTarget=new eu,_u.hasFeature(cu.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._registerEvent=function(){var t,e,n,i;null===(t=this._canvas)||void 0===t||t.addEventListener("touchstart",this._createCallback(UA.TOUCH_START)),null===(e=this._canvas)||void 0===e||e.addEventListener("touchmove",this._createCallback(UA.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(UA.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(UA.TOUCH_CANCEL))},e._createCallback=function(t){var e=this;return function(n){for(var i,r=e._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=e._getLocation(c,r),h=oM.getTouch(l,u.x,u.y);h&&(t!==UA.TOUCH_END&&t!==UA.TOUCH_CANCEL||oM.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),t===UA.TOUCH_START&&(null===(i=e._canvas)||void 0===i||i.focus()),o.length>0){var f=new XI(o,!1,t,ue.ENABLE_MULTI_TOUCH?oM.getAllTouches():o);e._eventTarget.emit(t,f)}}},e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new ni(e.x,e.y,e.width,e.height):new ni(0,0,0,0)},e._getLocation=function(t,e){var n=t.clientX-e.x,i=e.y+e.height-t.clientY;if(ah.isFrameRotated){var r=n;n=e.height-i,i=r}var o=ah.devicePixelRatio;return new Xn(n*=o,i*=o)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}();!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.UI=1]="UI"}($I||($I={}));var sM=function(){function t(t){this.priority=$I.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}return t.prototype.dispatchEvent=function(t){return this._inputEventTarget.emit(t.type,t),!0},t}(),cM=((JI={})[UA.MOUSE_DOWN]=UA.TOUCH_START,JI[UA.MOUSE_MOVE]=UA.TOUCH_MOVE,JI[UA.MOUSE_UP]=UA.TOUCH_END,JI),lM=t("Input",function(){function t(){this._dispatchImmediately=!0,this._eventTarget=new eu,this._touchInput=new aM,this._mouseInput=new iM,this._keyboardInput=new nM,this._accelerometerInput=new tM,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new sM(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var e=t.prototype;return e.on=function(t,e,n){return this._eventTarget.on(t,e,n),e},e.once=function(t,e,n){return this._eventTarget.once(t,e,n),e},e.off=function(t,e,n){this._eventTarget.off(t,e,n)},e.setAccelerometerEnabled=function(t){t?this._accelerometerInput.start():this._accelerometerInput.stop()},e.setAccelerometerInterval=function(t){this._accelerometerInput.setInterval(t)},e._simulateEventTouch=function(t){var e=cM[t.type],n=oM.getTouch(0,t.getLocationX(),t.getLocationY());if(n){var i=[n],r=new XI(i,!1,e,i);e===UA.TOUCH_END&&oM.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},e._registerEventDispatcher=function(t){this._eventDispatcherList.push(t),this._eventDispatcherList.sort((function(t,e){return e.priority-t.priority}))},e._emitEvent=function(t){for(var e=this._eventDispatcherList.length,n=0;n<e&&this._eventDispatcherList[n].dispatchEvent(t);++n);},e._registerEvent=function(){var t=this;if(lh.hasFeature(lh.Feature.INPUT_TOUCH)){var e=this._eventTouchList;this._touchInput.on(UA.TOUCH_START,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(UA.TOUCH_MOVE,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(UA.TOUCH_END,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(UA.TOUCH_CANCEL,(function(n){t._dispatchOrPushEventTouch(n,e)}))}if(lh.hasFeature(lh.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(UA.MOUSE_DOWN,(function(e){t._needSimulateTouchMoveEvent=!0,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(UA.MOUSE_MOVE,(function(e){t._needSimulateTouchMoveEvent&&t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(UA.MOUSE_UP,(function(e){t._needSimulateTouchMoveEvent=!1,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(UA.MOUSE_WHEEL,(function(e){t._dispatchOrPushEvent(e,n)}))}if(lh.hasFeature(lh.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(UA.KEY_DOWN,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(UA.KEY_PRESSING,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(UA.KEY_UP,(function(e){t._dispatchOrPushEvent(e,i)}))}if(lh.hasFeature(lh.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(UA.DEVICEMOTION,(function(e){t._dispatchOrPushEvent(e,r)}))}},e._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},e._dispatchOrPushEvent=function(t,e){this._dispatchImmediately?this._emitEvent(t):e.push(t)},e._dispatchOrPushEventTouch=function(t,e){if(this._dispatchImmediately)for(var n=t.getTouches(),i=n.length,r=0;r<i;++r)t.touch=n[r],t.propagationStopped=t.propagationImmediateStopped=!1,this._emitEvent(t);else e.push(t)},e._frameDispatchEvents=function(){for(var t=this._eventMouseList,e=0,n=t.length;e<n;++e){var i=t[e];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,f=0,p=h.length;f<p;++f){var d=h[f];this._emitEvent(d)}for(var _=this._eventAccelerationList,m=0,v=_.length;m<v;++m){var g=_[m];this._emitEvent(g)}this._clearEvents()},t}());lM.EventType=UA;var uM=t("input",new lM),hM=t("SystemEvent",function(t){function e(){var e;return e=t.call(this)||this,uM.on(UA.MOUSE_DOWN,(function(t){e.emit(kA.MOUSE_DOWN,t)})),uM.on(UA.MOUSE_MOVE,(function(t){e.emit(kA.MOUSE_MOVE,t)})),uM.on(UA.MOUSE_UP,(function(t){e.emit(kA.MOUSE_UP,t)})),uM.on(UA.MOUSE_WHEEL,(function(t){e.emit(kA.MOUSE_WHEEL,t)})),uM.on(UA.TOUCH_START,(function(t){e.emit(kA.TOUCH_START,t.touch,t)})),uM.on(UA.TOUCH_MOVE,(function(t){e.emit(kA.TOUCH_MOVE,t.touch,t)})),uM.on(UA.TOUCH_END,(function(t){e.emit(kA.TOUCH_END,t.touch,t)})),uM.on(UA.TOUCH_CANCEL,(function(t){e.emit(kA.TOUCH_CANCEL,t.touch,t)})),uM.on(UA.KEY_DOWN,(function(t){e.emit(kA.KEY_DOWN,t)})),uM.on(UA.KEY_PRESSING,(function(t){e.emit(kA.KEY_DOWN,t)})),uM.on(UA.KEY_UP,(function(t){e.emit(kA.KEY_UP,t)})),uM.on(UA.DEVICEMOTION,(function(t){e.emit(kA.DEVICEMOTION,t)})),e}$(e,t);var n=e.prototype;return n.setAccelerometerEnabled=function(t){uM.setAccelerometerEnabled(t)},n.setAccelerometerInterval=function(t){uM.setAccelerometerInterval(t)},n.on=function(e,n,i,r){return t.prototype.on.call(this,e,n,i,r),n},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i)},e}(eu));hM.EventType=kA,u.SystemEvent=hM;var fM,pM=t("systemEvent",new hM);u.systemEvent=pM,U(kA,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),U(HI,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:hM.EventType,targetName:"SystemEvent.EventType"}]),H(HI,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),U(jI,"EventMouse",["DOWN","UP","MOVE"].map((function(t){return{name:t,newName:"MOUSE_"+t,target:hM.EventType,targetName:"SystemEvent.EventType"}}))),U(jI,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:hM.EventType,targetName:"SystemEvent.EventType"}]),H(jI.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),U(XI,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:hM.EventType,targetName:"SystemEvent.EventType"}]),U(XI,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:hM.EventType,targetName:"SystemEvent.EventType"}]),U(XI,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:hM.EventType,targetName:"SystemEvent.EventType"}]),U(XI,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:hM.EventType,targetName:"SystemEvent.EventType"}]),H(XI.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),U(XI.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:XI,targetName:"EventTouch"}]),H(ue.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(t){return{name:t}}))),H(ue.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),H(ue.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),H(ue.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),H(ue,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),U(_b.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),U(WC.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(t){this._uiProps.uiTransformComp.width=t}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(t){this._uiProps.uiTransformComp.height=t}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(t){this._uiProps.uiTransformComp.anchorX=t}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(t){this._uiProps.uiTransformComp.anchorY=t}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new Xn),t.set(this._uiProps.uiTransformComp.anchorPoint),t}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){this._uiProps.uiTransformComp.setAnchorPoint(t,e)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new ti),t.set(this._uiProps.uiTransformComp.contentSize),t}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){"number"==typeof t?this._uiProps.uiTransformComp.setContentSize(t,e):this._uiProps.uiTransformComp.setContentSize(t)}}]),G(GI.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),G(WC.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),U(JE.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),G(Ld,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),U(Ld,"Layers",[{name:"Default",newName:"DEFAULT",target:Ld.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Ld.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Ld.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Ld.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Ld.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Ld.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Ld.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Ld.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Ld,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Ld,targetName:"Layers"}]),G(Ld.Enum,"Layers.Enum",[{name:"ALWAYS"}]),G(Ld.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var dM,_M,mM,vM,gM=dl.Flags.HideInHierarchy,yM=dl.Flags.DontSave,xM=t("PrivateNode",dc("cc.PrivateNode")(fM=function(t){function e(e){var n;return M(12003,(n=t.call(this,e)||this).name),n.hideFlags|=yM|gM,n}return $(e,t),e}(WC))||fM);U(kA,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(t){return{name:t,target:WC.EventType,targetName:"Node.EventType"}}))),U(WC.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:hM.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:hM.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:hM.EventType,targetName:"SystemEvent.EventType"}]),u.PrivateNode=xM;var SM=t("Scene",dc("cc.Scene")((lt((_M=function(t){$(n,t);var e=n.prototype;function n(e){var n;return ct(n=t.call(this,e)||this,"autoReleaseAssets",mM,ot(n)),ct(n,"_globals",vM,ot(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=Rn.ZERO,n._rot=Ln.IDENTITY,n._scale=Rn.ONE,n._mat=Vn.IDENTITY,n._dirtyFlags=0,n._lpos=Rn.ZERO,n._lrot=Ln.IDENTITY,n._lscale=Rn.ONE,n._activeInHierarchy=!1,u.director&&u.director.root&&(n._renderScene=u.director.root.createScene({})),n._inited=!u.game||!u.game._isCloning,n._init(),n}return e._updateScene=function(){this._scene=this},e._init=function(){},e.destroy=function(){var t=dl.prototype.destroy.call(this);if(t)for(var e=this._children,n=0;n<e.length;++n)e[n].active=!1;return this._renderScene&&u.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t},e.addComponent=function(){throw new Error(F(3822))},e._onHierarchyChanged=function(){},e._onBatchCreated=function(e){t.prototype._onBatchCreated.call(this,e);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)},e.getPosition=function(t){return Rn.copy(t||new Rn,Rn.ZERO)},e.getRotation=function(t){return Ln.copy(t||new Ln,Ln.IDENTITY)},e.getScale=function(t){return Rn.copy(t||new Rn,Rn.ONE)},e.getWorldPosition=function(t){return Rn.copy(t||new Rn,Rn.ZERO)},e.getWorldRotation=function(t){return Ln.copy(t||new Ln,Ln.IDENTITY)},e.getWorldScale=function(t){return Rn.copy(t||new Rn,Rn.ONE)},e.getWorldMatrix=function(t){return Vn.copy(t||new Vn,Vn.IDENTITY)},e.getWorldRS=function(t){return Vn.copy(t||new Vn,Vn.IDENTITY)},e.getWorldRT=function(t){return Vn.copy(t||new Vn,Vn.IDENTITY)},e.updateWorldTransform=function(){},e._instantiate=function(){},e._load=function(){this._inited||(cA(this),aA(this),this._onBatchCreated(false),this._inited=!0),this.walk(_b._setScene)},e._activate=function(t){t=!1!==t,u.director._nodeActivator.activateNode(this,t),this._globals.activate(),this._renderScene&&this._renderScene.activate()},Z(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return Rn.ZERO}},{key:"worldPosition",get:function(){return Rn.ZERO}},{key:"rotation",get:function(){return Ln.IDENTITY}},{key:"worldRotation",get:function(){return Ln.IDENTITY}},{key:"scale",get:function(){return Rn.ONE}},{key:"worldScale",get:function(){return Rn.ONE}},{key:"eulerAngles",get:function(){return Rn.ZERO}},{key:"worldMatrix",get:function(){return Vn.IDENTITY}}]),n}(_b)).prototype,"globals",[Mc],Object.getOwnPropertyDescriptor(_M.prototype,"globals"),_M.prototype),mM=lt(_M.prototype,"autoReleaseAssets",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vM=lt(_M.prototype,"_globals",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new GI}}),dM=_M))||dM);function TM(t,e){if(!e){var n=u.director.getScene();if(!n)return null;e=n}return e.getChildByPath(t)}u.Scene=SM,u.find=TM;var EM=ne.fastRemoveAt,bM=dl.Flags.IsStartCalled,CM=dl.Flags.IsOnEnableCalled;function AM(t,e){for(var n=e.constructor._executionOrder,i=e._id,r=0,o=t.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=t[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function wM(t,e){for(var n=t.array,i=t.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(t.removeAt(i),e&&(r._objFlags&=~e))}}dl.Flags.IsEditorOnEnableCalled;var RM=function(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var e=ut;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t};function PM(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}RM.stableRemoveInactive=wM;var IM=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)},n.remove=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)},n.cancelInactive=function(t){wM(this._zero,t),wM(this._neg,t),wM(this._pos,t)},n.invoke=function(){var t=this._neg;t.array.length>0&&(t.array.sort(PM),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var e=this._pos;e.array.length>0&&(e.array.sort(PM),this._invoke(e),e.array.length=0)},e}(RM),MM=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{var n=e<0?this._neg.array:this._pos.array,i=AM(n,t);i<0&&n.splice(~i,0,t)}},n.remove=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{var n=e<0?this._neg:this._pos,i=AM(n.array,t);i>=0&&n.removeAt(i)}},n.invoke=function(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)},e}(RM);function DM(t,e,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+t+"}",r=e?Function("it","dt",i):Function("it",i);return function(t,e,n){return function(i,r){try{e(i,r)}catch(e){u._throw(e);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{t(o[i.i],r)}catch(t){u._throw(t),n&&(o[i.i]._objFlags|=n)}}}}(Function("c","dt",t),r,n)}var OM=DM("c.start();c._objFlags|="+bM,!1,bM),NM=DM("c.update(dt)",!0),LM=DM("c.lateUpdate(dt)",!0),BM=function(t){var e=u.director._compScheduler,n=t.array;for(t.i=0;t.i<n.length;++t.i){var i=n[t.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||e._onEnabled(i))}},FM=function(){function t(){this._deferredComps=[],this.unscheduleAll()}var e=t.prototype;return e.unscheduleAll=function(){this.startInvoker=new IM(OM),this.updateInvoker=new MM(NM),this.lateUpdateInvoker=new MM(LM),this._updating=!1},e._onEnabled=function(t){u.director.getScheduler().resumeTarget(t),t._objFlags|=CM,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)},e._onDisabled=function(t){u.director.getScheduler().pauseTarget(t),t._objFlags&=~CM;var e=this._deferredComps.indexOf(t);e>=0?EM(this._deferredComps,e):(!t.start||t._objFlags&bM||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))},e.enableComp=function(t,e){if(!(t._objFlags&CM)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}},e.disableComp=function(t){t._objFlags&CM&&(t.onDisable&&t.onDisable(),this._onDisabled(t))},e.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},e.updatePhase=function(t){this.updateInvoker.invoke(t)},e.lateUpdatePhase=function(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()},e._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},e._scheduleImmediate=function(t){"function"!=typeof t.start||t._objFlags&bM||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)},e._deferredSchedule=function(){for(var t=this._deferredComps,e=0,n=t.length;e<n;e++)this._scheduleImmediate(t[e]);t.length=0},t}(),zM=dl.Flags.IsPreloadStarted,kM=dl.Flags.IsOnLoadStarted,UM=dl.Flags.IsOnLoadCalled,GM=dl.Flags.Deactivating,HM=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.add=function(t){this._zero.array.push(t)},n.remove=function(t){this._zero.fastRemove(t)},n.cancelInactive=function(t){RM.stableRemoveInactive(this._zero,t)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},e}(RM),VM=DM("c.__preload();"),WM=DM("c.onLoad();c._objFlags|="+UM,!1,UM),jM=new ee(4);function qM(t,e,n){O(3817,t.name,n),console.log("Corrupted component value:",e),e?t._removeComponent(e):ne.removeAt(t._components,n)}jM.get=function(){var t=this._get()||{preload:new HM(VM),onLoad:new IM(WM),onEnable:new IM(BM)};t.preload._zero.i=-1;var e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,(e=t.onEnable)._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};var XM,YM,KM,QM,ZM,JM,$M,tD,eD=t("NodeActivator",function(){function t(){this.resetComp=void 0,this.reset()}var e=t.prototype;return e.reset=function(){this._activatingStack=[]},e.activateNode=function(t,e){if(e){var n=jM.get();this._activatingStack.push(n),this._activateNodeRecursively(t,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),jM.put(n)}else{this._deactivateNodeRecursively(t);for(var i,r=st(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(zM),o.onLoad.cancelInactive(kM),o.onEnable.cancelInactive()}}t.emit(HE.ACTIVE_IN_HIERARCHY_CHANGED,t)},e.activateComp=function(t,e,n,i){if(ml(t,!0)&&(t._objFlags&zM||(t._objFlags|=zM,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&kM||(t._objFlags|=kM,t.onLoad?n?n.add(t):(t.onLoad(),t._objFlags|=UM):t._objFlags|=UM),t._enabled)){if(!t.node._activeInHierarchy)return;u.director._compScheduler.enableComp(t,i)}},e.destroyComp=function(t){u.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&UM&&t.onDestroy()},e._activateNodeRecursively=function(t,e,n,i){if(t._objFlags&GM)O(3816,t.name);else{t._activeInHierarchy=!0;for(var r=t._components.length,o=0;o<r;++o){var a=t._components[o];a instanceof u.Component?this.activateComp(a,e,n,i):(qM(t,a,o),--o,--r)}for(var s=0,c=t._children.length;s<c;++s){var l=t._children[s];l._active&&this._activateNodeRecursively(l,e,n,i)}t._onPostActivated(!0)}},e._deactivateNodeRecursively=function(t){t._objFlags|=GM,t._activeInHierarchy=!1;for(var e=t._components.length,n=0;n<e;++n){var i=t._components[n];if(i._enabled&&(u.director._compScheduler.disableComp(i),t._activeInHierarchy))return void(t._objFlags&=~GM)}for(var r=0,o=t._children.length;r<o;++r){var a=t._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),t._activeInHierarchy))return void(t._objFlags&=~GM)}t._onPostActivated(!1),t._objFlags&=~GM},t}()),nD=t("SceneAsset",dc("cc.SceneAsset")((QM=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"scene",KM,ot(e)),e}$(e,t);var n=e.prototype;return n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.scene=new SM("New Scene")},n.validate=function(){return!!this.scene},e}(Du),KM=lt((YM=QM).prototype,"scene",[Mc,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XM=YM))||XM);u.SceneAsset=nD;var iD,rD,oD,aD,sD=t("TextAsset",dc("cc.TextAsset")((tD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"text",$M,ot(e)),e}return $(e,t),e.prototype.toString=function(){return this.text},e}(Du),$M=lt((JM=tD).prototype,"text",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZM=JM))||ZM);u.TextAsset=sD;var cD=t("JsonAsset",dc("cc.JsonAsset")((aD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"json",oD,ot(e)),e}return $(e,t),e}(Du),oD=lt((rD=aD).prototype,"json",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iD=rD))||iD);u.JsonAsset=cD;var lD,uD,hD,fD,pD,dD,_D,mD,vD,gD,yD,xD,SD,TD,ED,bD,CD,AD,wD,RD,PD,ID,MD,DD,OD,ND,LD,BD,FD,zD,kD,UD,GD,HD,VD,WD,jD,qD,XD=function(){var t=e.prototype;function e(){this.fog=new CE,this.ambient=new $S,this.skybox=new yT,this.shadows=new Tg,this.octree=new eT,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return t._init=function(){},t.activate=function(t,e){return this._device=t,this._pipeline=e,this.initOcclusionQuery(),!0},t.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var t=new cg;t._uuid="default-occlusion-query-material",t.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=t,this._occlusionQueryShader=t.passes[0].getShaderVariant()}},t.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},t.onGlobalPipelineStateChanged=function(){},t.destroy=function(){var t,e,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(t=this._occlusionQueryInputAssembler)||void 0===t||t.destroy(),this._occlusionQueryInputAssembler=null,null===(e=this._occlusionQueryVertexBuffer)||void 0===e||e.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},t._createOcclusionQueryIA=function(){var t=this._device,e=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=t.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(e);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=t.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Rr("a_position",fi.RGB32F)],c=new Ir(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return t.createInputAssembler(c)},Z(e,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(t){this._isHDR=t}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(t){this._shadingScale!==t&&(this._shadingScale=t,this._pipeline.emit(Gy.ATTACHMENT_SCALE_CAHNGED,t))}}]),e}(),YD=t("ForwardPipeline",(lD=dc("ForwardPipeline"),uD=Kc([GS]),hD=Gc(),lD((_D=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"renderTextures",dD,ot(e)),e._postRenderPass=null,e}$(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new SE;n.initialize(SE.initInfo),this._flows.push(n);var i=new iE;i.initialize(iE.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new XD,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(O(2402),1))},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n._activeRenderer=function(){var t=this.device;this._commandBuffers.push(t.commandBuffer);var e=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(t_,e),this._descriptorSet.bindTexture(t_,Dv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(l_,e),this._descriptorSet.bindTexture(l_,Dv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Zd.BINDING).destroy(),this._descriptorSet.getBuffer($d.BINDING).destroy(),this._descriptorSet.getBuffer(Jd.BINDING).destroy(),this._descriptorSet.getTexture(t_).destroy(),this._descriptorSet.getTexture(l_).destroy())},Z(e,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),e}(lx),dD=lt((pD=_D).prototype,"renderTextures",[uD,xc,hD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fD=pD))||fD)),KD=[new sr(0,0,0,0),new sr(0,0,0,0),new sr(0,0,0,0)],QD=t("GbufferStage",(mD=dc("GbufferStage"),vD=Kc([WS]),gD=Gc(),mD((ED=TD=function(t){function e(){var e;return ct(e=t.call(this)||this,"renderQueues",SD,ot(e)),e._renderQueues=[],e._renderArea=new $i,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Ov("default"),e._batchedQueue=new ZS,e._instancedQueue=new JS,e}$(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=YS(this.renderQueues[i])},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(KS),e.generateRenderArea(t,this._renderArea),e.updateQuadVertexData(this._renderArea,t.window);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var f=h[o];if(f.phase===this._phaseID){var p=f.batchingScheme;if(p===Rv.INSTANCING){var d=f.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(p===Rv.VB_MERGING){var _=f.getBatchedBuffer();_.merge(u,o,c.model),this._batchedQueue.queue.add(_)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(QS);var m=e.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),t.clearFlag&Xi.COLOR&&(e.pipelineSceneData.isHDR?Vv(KD[0],t.clearColor):(KD[0].x=t.clearColor.x,KD[0].y=t.clearColor.y,KD[0].z=t.clearColor.z)),KD[0].w=t.clearColor.w;var v=e.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,KD,t.clearDepth,t.clearStencil),m.setScissor(e.generateScissor(t)),m.setViewport(e.generateViewport(t)),m.bindDescriptorSet(Xd.GLOBAL,e.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},e}(Uy),TD.initInfo={name:"GbufferStage",priority:ex.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:US.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:US.BACK_TO_FRONT,stages:["default"]}]},SD=lt((xD=ED).prototype,"renderQueues",[vD,xc,gD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yD=xD))||yD)),ZD=[new sr(0,0,0,1)],JD=t("LightingStage",(bD=dc("LightingStage"),CD=Kc(cg),AD=Gc(),wD=Kc([WS]),RD=Gc(),bD((ND=OD=function(t){function e(){var e;return(e=t.call(this)||this)._deferredLitsBufs=null,e._maxDeferredLights=v_.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new $i,e._uiPhase=void 0,ct(e,"_deferredMaterial",MD,ot(e)),ct(e,"renderQueues",DD,ot(e)),e._phaseID=Ov("default"),e._renderQueues=[],e._uiPhase=new tE,e}$(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.gatherLights=function(t){for(var e=this._pipeline,n=e.commandBuffers[0],i=t.scene.sphereLights,r=t.scene.spotLights,o=sa.create(0,0,0,1),a=new Float32Array(4),s=t.exposure,c=0,l=Zn.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var f=i[h];if(sa.set(o,f.position.x,f.position.y,f.position.z,f.range),hs.sphereFrustum(o,t.frustum)){if(Rn.toArray(a,f.position),a[3]=0,this._lightBufferData.set(a,c*l),Rn.toArray(a,f.color),f.useColorTemperature){var p=f.colorTemperatureRGB;a[0]*=p.x,a[1]*=p.y,a[2]*=p.z}e.pipelineSceneData.isHDR?a[3]=f.luminance*s*this._lightMeterScale:a[3]=f.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=f.size,a[1]=f.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var d=0;d<r.length&&c<this._maxDeferredLights;d++,++c){var _=r[d];if(sa.set(o,_.position.x,_.position.y,_.position.z,_.range),hs.sphereFrustum(o,t.frustum)){if(Rn.toArray(a,_.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),Rn.toArray(a,_.color),_.useColorTemperature){var m=_.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}e.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=_.spotAngle,this._lightBufferData.set(a,c*l+2*u),Rn.toArray(a,_.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._uiPhase.activate(e);for(var i=e.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=YS(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new fr(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new Ur(Vd.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Gr(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(m_.BINDING,a),this._planarQueue=new $T(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var t;null===(t=this._deferredLitsBufs)||void 0===t||t.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(t){var e=this._pipeline,n=e.device,i=e.commandBuffers[0],r=e.pipelineSceneData,o=r.renderObjects;this.gatherLights(t),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(t,i),i.bindDescriptorSet(Xd.LOCAL,this._descriptorSet,[0]),e.generateRenderArea(t,this._renderArea),t.clearFlag&Xi.COLOR&&(ZD[0].x=t.clearColor.x,ZD[0].y=t.clearColor.y,ZD[0].z=t.clearColor.z),ZD[0].w=0;var a=e.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;e.pipelineUBO.updateShadowUBO(t),i.beginRenderPass(c,s,this._renderArea,ZD,t.clearDepth,t.clearStencil),i.setScissor(e.generateScissor(t)),i.setViewport(e.generateViewport(t)),i.bindDescriptorSet(Xd.GLOBAL,e.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.bindTexture(3,a.outputDepth),l.descriptorSet.bindSampler(3,a.sampler),l.descriptorSet.update(),i.bindDescriptorSet(Xd.MATERIAL,l.descriptorSet);var f=e.quadIAOffscreen,p=null;null!=l&&null!=u&&null!=f&&(p=Uv.getOrCreatePipelineState(n,l,u,c,f)),null!=p&&(i.bindPipelineState(p),i.bindInputAssembler(f),i.draw(f)),this._renderQueues.forEach(KS);for(var d=0,_=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(d=0;d<y.length;++d){var x=y[d].passes;for(_=0;_<x.length;++_)if(x[_].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,d,_)}}if(o.length>0){this._renderQueues.forEach(QS);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(t,c),i.endRenderPass()},e}(Uy),OD.initInfo={name:"LightingStage",priority:ex.LIGHTING,tag:0},MD=lt((ID=ND).prototype,"_deferredMaterial",[CD,xc,AD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DD=lt(ID.prototype,"renderQueues",[wD,xc,RD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PD=ID))||PD)),$D=[new sr(0,0,0,1)],tO=t("PostProcessStage",(LD=dc("PostProcessStage"),BD=Kc(cg),FD=Gc(),zD=Kc([WS]),kD=Gc(),LD((jD=WD=function(t){function e(){var e;return ct(e=t.call(this)||this,"_postProcessMaterial",HD,ot(e)),ct(e,"renderQueues",VD,ot(e)),e._renderArea=new $i,e._uiPhase=new tE,e}$(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){var e=this._pipeline,n=e.device,i=e.pipelineSceneData,r=e.commandBuffers[0];e.pipelineUBO.updateCameraUBO(t);var o=t.viewport;this._renderArea.x=o.x*t.window.width,this._renderArea.y=o.y*t.window.height,this._renderArea.width=o.width*t.window.width,this._renderArea.height=o.height*t.window.height;var a=e.getPipelineRenderData(),s=t.window.framebuffer,c=e.getRenderPass(t.clearFlag,s);t.clearFlag&Xi.COLOR&&($D[0].x=t.clearColor.x,$D[0].y=t.clearColor.y,$D[0].z=t.clearColor.z),$D[0].w=t.clearColor.w,r.beginRenderPass(c,s,this._renderArea,$D,t.clearDepth,t.clearStencil),r.bindDescriptorSet(Xd.GLOBAL,e.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();e.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update(),r.bindDescriptorSet(Xd.MATERIAL,l.descriptorSet);var h=t.window.swapchain?e.quadIAOnscreen:e.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=h&&(f=Uv.getOrCreatePipelineState(n,l,u,c,h));var p=e.pipelineSceneData.renderObjects;null!=f&&p.length>0&&(r.bindPipelineState(f),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(t,c),eg(n,c,r,e.profiler,t),r.endRenderPass()},e}(Uy),WD.initInfo={name:"PostProcessStage",priority:Jy.POST_PROCESS,tag:0},HD=lt((GD=jD).prototype,"_postProcessMaterial",[BD,xc,FD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VD=lt(GD.prototype,"renderQueues",[zD,xc,kD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),UD=GD))||UD));!function(t){t[t.NONE=0]="NONE",t[t.FXAA=1]="FXAA"}(qD||(qD={}));var eO,nO,iO,rO,oO,aO,sO,cO,lO=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._antiAliasing=qD.NONE,e}$(e,t);var n=e.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var t=this._bloomMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();for(var e=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),e.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var t=this.postprocessMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var t=new cg;t._uuid="builtin-deferred-material",t.initialize({effectName:"deferred-lighting"});for(var e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredLightingMaterial=t;var n=new cg;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new cg;r._uuid="builtin-post-process-material",ue.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=qD.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(e,n){return t.prototype.activate.call(this,e,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var t=this._deferredLightingMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},Z(e,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(t){if(this._antiAliasing=t,this._postprocessMaterial){var e=this._postprocessMaterial.passes[0].defines;Object.assign(e,{ANTIALIAS_TYPE:t});var n=new cg;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:e});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(t){this._bloomMaterial!==t&&t&&(this._bloomMaterial=t,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(t){this._postprocessMaterial!==t&&t&&(this._postprocessMaterial=t,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(t){this._deferredLightingMaterial!==t&&t&&(this._deferredLightingMaterial=t,this.updatePipelinePassInfo())}}]),e}(XD),uO=[new sr(0,0,0,1)],hO=function(){};hO.SIZE=4*(hO.COUNT=4+(hO.TEXTURE_SIZE_OFFSET=0));var fO,pO,dO,_O,mO,vO,gO,yO,xO,SO,TO=t("BloomStage",(eO=dc("BloomStage"),nO=Kc(cg),iO=Gc(),eO((cO=sO=function(t){function e(){var e;return(e=t.call(this)||this).threshold=1,e.intensity=.8,e.iterations=2,ct(e,"_bloomMaterial",aO,ot(e)),e._renderArea=new $i,e._bloomUBO=[],e}$(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(t){var e,n=this._pipeline;if(n.generateBloomRenderData(),((null===(e=t.window)||void 0===e?void 0:e.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,hO.SIZE,hO.SIZE));t.clearFlag&Xi.COLOR&&(uO[0].x=t.clearColor.x,uO[0].y=t.clearColor.y,uO[0].z=t.clearColor.z),uO[0].w=t.clearColor.w,this._prefilterPass(t,n),this._downsamplePass(t,n),this._upsamplePass(t,n),this._combinePass(t,n)}},n._prefilterPass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial.passes[0],r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(hO.COUNT);a[hO.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,uO,0,0),n.bindDescriptorSet(Xd.GLOBAL,e.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(Xd.MATERIAL,i.descriptorSet);var s=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=Uv.getOrCreatePipelineState(e.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData().bloom,o=new Float32Array(hO.COUNT),a=0;a<this.iterations;++a){o[hO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[hO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,uO,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Xd.MATERIAL,s.descriptorSet);var l=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=Uv.getOrCreatePipelineState(e.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(t,e){var n=e.getPipelineRenderData().bloom;e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=e.commandBuffers[0],r=e.pipelineSceneData.bloomMaterial,o=new Float32Array(hO.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[hO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[hO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,uO,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(Xd.MATERIAL,c.descriptorSet);var u=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=Uv.getOrCreatePipelineState(e.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(t,e){e.generateRenderArea(t,this._renderArea);var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(hO.COUNT);a[hO.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,uO,0,0),n.bindDescriptorSet(Xd.GLOBAL,e.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Xd.MATERIAL,s.descriptorSet);var c=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=Uv.getOrCreatePipelineState(e.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},e}(Uy),sO.initInfo={name:"BloomStage",priority:Jy.BLOOM,tag:0},aO=lt((oO=cO).prototype,"_bloomMaterial",[nO,xc,iO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rO=oO))||rO)),EO=t("MainFlow",dc("MainFlow")((dO=pO=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new QD;n.initialize(QD.initInfo),this._stages.push(n);var i=new JD;i.initialize(JD.initInfo),this._stages.push(i);var r=new TO;r.initialize(TO.initInfo),this._stages.push(r);var o=new tO;o.initialize(tO.initInfo),this._stages.push(o)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(Hy),pO.initInfo={name:zd,priority:nx.MAIN,stages:[]},fO=dO))||fO),bO=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).gbufferFrameBuffer=null,e.gbufferRenderTargets=[],e}return $(e,t),e}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),CO=t("DeferredPipeline",(_O=dc("DeferredPipeline"),mO=Kc([GS]),vO=Gc(),_O((SO=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gbufferRenderPass=null,e._lightingRenderPass=null,ct(e,"renderTextures",xO,ot(e)),e}$(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new SE;n.initialize(SE.initInfo),this._flows.push(n);var i=new EO;i.initialize(EO.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new lO,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(O(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(t){var e=this.device;this._commandBuffers.push(e.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(t_,n),this._descriptorSet.bindTexture(t_,Dv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(l_,n),this._descriptorSet.bindTexture(l_,Dv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new cx;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Mr;o.format=fi.RGBA16F,o.loadOp=Di.CLEAR,o.storeOp=Oi.STORE;var a=new Mr;a.format=fi.RGBA16F,a.loadOp=Di.CLEAR,a.storeOp=Oi.STORE;var s=new Mr;s.format=fi.RGBA16F,s.loadOp=Di.CLEAR,s.storeOp=Oi.STORE;var c=new Dr;c.format=fi.DEPTH_STENCIL,c.depthLoadOp=Di.CLEAR,c.depthStoreOp=Oi.STORE,c.stencilLoadOp=Di.CLEAR,c.stencilStoreOp=Oi.STORE;var l=new Lr([o,a,s],c);this._gbufferRenderPass=e.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Mr;u.format=fi.RGBA8,u.loadOp=Di.CLEAR,u.storeOp=Oi.STORE,u.endAccesses=[Ni.COLOR_ATTACHMENT_WRITE];var h=new Dr;h.format=fi.DEPTH_STENCIL,h.depthLoadOp=Di.LOAD,h.depthStoreOp=Oi.DISCARD,h.stencilLoadOp=Di.LOAD,h.stencilStoreOp=Oi.DISCARD,h.beginAccesses=[Ni.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Ni.DEPTH_STENCIL_ATTACHMENT_WRITE];var f=new Lr([u],h);this._lightingRenderPass=e.createRenderPass(f)}return this._width=t.width,this._height=t.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Zd.BINDING).destroy(),this._descriptorSet.getBuffer($d.BINDING).destroy(),this._descriptorSet.getBuffer(Jd.BINDING).destroy(),this._descriptorSet.getTexture(t_).destroy(),this._descriptorSet.getTexture(l_).destroy())},n._destroyDeferredData=function(){var t=this._pipelineRenderData;if(t){t.gbufferFrameBuffer&&t.gbufferFrameBuffer.destroy(),t.outputFrameBuffer&&t.outputFrameBuffer.destroy(),t.outputDepth&&t.outputDepth.destroy();for(var e=0;e<t.gbufferRenderTargets.length;e++)t.gbufferRenderTargets[e].destroy();t.gbufferRenderTargets.length=0;for(var n=0;n<t.outputRenderTargets.length;n++)t.outputRenderTargets[n].destroy();t.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var t=this,e=this.device,n=this._pipelineRenderData=new bO,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,fi.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=e.createTexture(new mr(yi.TEX2D,xi.DEPTH_STENCIL_ATTACHMENT|xi.SAMPLED,fi.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=e.createFramebuffer(new zr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,fi.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=e.createFramebuffer(new zr(this._lightingRenderPass,n.outputRenderTargets,null)),this.on(Gy.ATTACHMENT_SCALE_CAHNGED,(function(e){n.sampler=e<1?t.globalDSManager.pointSampler:t.globalDSManager.linearSampler,t.applyFramebufferRatio(n.gbufferFrameBuffer),t.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},e}(lx),xO=lt((yO=SO).prototype,"renderTextures",[mO,xc,vO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gO=yO))||gO));function AO(){var t=new YD;return t.initialize({flows:[]}),t}var wO=new Xn,RO=function(){var t=e.prototype;function e(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return t.pauseRendering=function(){this.isPause=!0},t.resumeRendering=function(){this.isPause=!1},t.main=function(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){var e=this.settings=window._CCSettings.splashScreen;e.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,e.base64src=this.settings.base64src||"",e.effect=this.settings.effect||"FADE-INOUT",e.clearColor=this.settings.clearColor||new sr(.88,.88,.88,1),e.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,e.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new sr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{u.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?u.view.setDesignResolutionSize(n.width,n.height,n.policy):u.view.setDesignResolutionSize(960,640,4),this.device=t.device,this.swapchain=t.mainWindow.swapchain,this.framebuffer=t.mainWindow.framebuffer,u.game.once(u.Game.EVENT_GAME_INITED,(function(){u.director._lateUpdate=performance.now()}),u.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else T("RENDER ROOT IS NULL.")},t.setOnFinish=function(t){if(this._directCall&&t)return e._ins=void 0,void t();this.callBack=t},t._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),u.game.resume())},t.preInit=function(){var t=this.settings.clearColor;this.clearColors=[new sr(t.x,t.y,t.z,t.w)];var e=this.device,n=this.swapchain;this.renderArea=new $i(0,0,n.width,n.height),this.cmdBuff=e.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=e.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=e.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Rr("a_position",fi.RG32F),new Rr("a_texCoord",fi.RG32F)],u=new Ir(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(u),this.projection=new Vn,Vn.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,n.surfaceTransform)},t.init=function(){var t=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),u.game.pause(),this.handle=requestAnimationFrame((function e(n){if(!t.cancelAnimate){var i=t.settings,r=t.device,o=t.swapchain;Vn.ortho(t.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;t.startTime<0&&(t.startTime=n);var l=n-t.startTime,u=df(cn(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=t.logoTexture.width,f=t.logoTexture.height,p=c*i.displayRatio,d=p*h/f,_=p;if(o.surfaceTransform!==ui.ROTATE_90&&o.surfaceTransform!==ui.ROTATE_270||(d=p*a/s,_=p*f/h*s/a),t.logoMat.setProperty("resolution",wO.set(a,s),0),t.logoMat.setProperty("scale",wO.set(d,_),0),t.logoMat.setProperty("translate",wO.set(.5*a,.5*s),0),t.logoMat.setProperty("percent",u),t.logoMat.setProperty("u_projection",t.projection),t.logoMat.passes[0].update(),i.displayWatermark&&t.watermarkMat){var m=.5*c,v=t.watermarkTexture.width,g=m,y=m*t.watermarkTexture.height/v;o.surfaceTransform!==ui.ROTATE_90&&o.surfaceTransform!==ui.ROTATE_270||(g=.5*m,y=m*a/s*.5),t.watermarkMat.setProperty("resolution",wO.set(a,s),0),t.watermarkMat.setProperty("scale",wO.set(g,y),0),t.watermarkMat.setProperty("translate",wO.set(.5*a,.1*s),0),t.watermarkMat.setProperty("percent",u),t.watermarkMat.setProperty("u_projection",t.projection),t.watermarkMat.passes[0].update()}t.isPause||(t.frame(),l>i.totalTime&&(t.splashFinish=!0)),requestAnimationFrame(e)}}))},t.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},t.initLogo=function(){var t=this.device;this.logoMat=new cg,this.logoMat.initialize({effectName:"splash-screen"});var e=new gr;e.addressU=Ci.CLAMP,e.addressV=Ci.CLAMP,e.addressW=Ci.CLAMP,this.sampler=t.getSampler(e),this.logoTexture=t.createTexture(new mr(yi.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,fi.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new or;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},t.initWarterMark=function(){var t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=""+t.width,t.style.height=""+t.height;var e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=e.measureText(n);e.fillText(n,(330-i.width)/2,6);var r=new or;r.texExtent.width=t.width,r.texExtent.height=t.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new mr(yi.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,fi.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[r]),this.watermarkMat=new cg,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},t.frame=function(){var t=this.device,e=this.swapchain;t.acquire([e]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=e.width,r.height=e.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=Uv.getOrCreatePipelineState(t,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(Xd.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=Uv.getOrCreatePipelineState(t,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(Xd.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),t.flushCommands([n]),t.queue.submit([n]),t.present()},t.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,e._ins=void 0},Z(e,[{key:"splashFinish",set:function(t){this._splashFinish=t,this._tryToStart()}},{key:"loadFinish",set:function(t){this._loadFinish=t,this._tryToStart()}}],[{key:"instance",get:function(){return e._ins||(e._ins=new e),e._ins}}]),e}();RO._ins=void 0,u.internal.SplashScreen=RO;var PO=t("System",function(){function t(){this._id="",this._priority=0,this._executeInEditMode=!1}t.sortByPriority=function(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0};var e=t.prototype;return e.init=function(){},e.update=function(){},e.postUpdate=function(){},Z(t,[{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"id",get:function(){return this._id},set:function(t){this._id=t}}]),t}());PO.Priority=oe({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var IO=new mt("Scheduler"),MO=function(t,e,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=n,this.markedForDeletion=i};MO.get=function(t,e,n,i){var r=MO._listEntries.pop();return r?(r.target=t,r.priority=e,r.paused=n,r.markedForDeletion=i):r=new MO(t,e,n,i),r},MO.put=function(t){MO._listEntries.length<20&&(t.target=null,MO._listEntries.push(t))},MO._listEntries=[];var DO=function(t,e,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=n,this.callback=i};DO.get=function(t,e,n,i){var r=DO._hashUpdateEntries.pop();return r?(r.list=t,r.entry=e,r.target=n,r.callback=i):r=new DO(t,e,n,i),r},DO.put=function(t){DO._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,DO._hashUpdateEntries.push(t))},DO._hashUpdateEntries=[];var OO=function(t,e,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};OO.get=function(t,e,n,i,r,o){var a=OO._hashTimerEntries.pop();return a?(a.timers=t,a.target=e,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new OO(t,e,n,i,r,o),a},OO.put=function(t){OO._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,OO._hashTimerEntries.push(t))},OO._hashTimerEntries=[];var NO=function(){function t(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var e=t.prototype;return e.initWithCallback=function(t,e,n,i,r,o){return this._lock=!1,this._scheduler=t,this._target=n,this._callback=e,this._elapsed=-1,this._interval=i,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===u.macro.REPEAT_FOREVER,!0},e.getInterval=function(){return this._interval},e.setInterval=function(t){this._interval=t},e.update=function(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},e.getCallback=function(){return this._callback},e.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},e.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},t}();NO._timers=[],NO.get=function(){return NO._timers.pop()||new NO},NO.put=function(t){NO._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,NO._timers.push(t))};var LO,BO=t("Scheduler",function(t){function e(){var e;return(e=t.call(this)||this)._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=Rt(!0),e._hashForTimers=Rt(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}$(e,t),e.enableForTarget=function(t){var e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?M(1513):t.id=IO.getNewId())};var n=e.prototype;return n.setTimeScale=function(t){this._timeScale=t},n.getTimeScale=function(){return this._timeScale},n.update=function(t){var e,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,i=(n=this._updatesNegList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updates0List).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updatesPosList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);var a=this._arrayForTimers;for(e=0;e<a.length;e++){if(o=a[e],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(t),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,n=this._updatesNegList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updates0List;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updatesPosList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(t,e,n,i,r,o){if("function"!=typeof t){var a=t;t=e,e=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!i,i=u.macro.REPEAT_FOREVER,r=0),B(e,1502);var s=e.uuid||e.id;if(s){var c,l,h=this._hashForTimers[s];if(h?h.paused!==o&&M(1511):(h=OO.get(null,e,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[s]=h),null==h.timers)h.timers=[];else for(l=0;l<h.timers.length;++l)if((c=h.timers[l])&&t===c._callback)return P(1507,c.getInterval(),n),void(c._interval=n);(c=NO.get()).initWithCallback(this,t,e,n,i,r),h.timers.push(c),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else O(1510)},n.scheduleUpdate=function(t,e,n){var i=t.uuid||t.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===e)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return P(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(t)}var o,a=MO.get(t,e,n,!1);0===e?(o=this._updates0List,this._appendIn(o,a)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,e)),this._hashForUpdates[i]=DO.get(o,a,t,null)}else O(1510)},n.unschedule=function(t,e){if(e&&t){var n=e.uuid||e.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(t===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),NO.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else O(1510)}},n.unscheduleUpdate=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForUpdates[e];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else O(1510)}},n.unscheduleAllForTarget=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)NO.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(t)}else O(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(PO.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(t){var e,n,i,r=this._arrayForTimers;for(e=r.length-1;e>=0;e--)n=r[e],this.unscheduleAllForTarget(n.target);var o=0;if(t<0)for(e=0;e<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[e])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&e++},n.isScheduled=function(t,e){B(t,1508),B(e,1509);var n=e.uuid||e.id;if(!n)return O(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(t===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(PO.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(t){var e,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(e=a[n])&&(e.paused=!0,o.push(e.target));if(t<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));if(t<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)this.resumeTarget(t[e])},n.pauseTarget=function(t){B(t,1503);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!0);var i=this._hashForUpdates[e];i&&(i.entry.paused=!0)}else O(1510)},n.resumeTarget=function(t){B(t,1504);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!1);var i=this._hashForUpdates[e];i&&(i.entry.paused=!1)}else O(1510)},n.isTargetPaused=function(t){B(t,1505);var e=t.uuid||t.id;if(!e)return O(1510),!1;var n=this._hashForTimers[e];if(n)return n.paused;var i=this._hashForUpdates[e];return!!i&&i.entry.paused},n._removeHashElement=function(t){var e=t.target.uuid||t.target.id;delete this._hashForTimers[e];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===t){n.splice(i,1);break}OO.put(t)},n._removeUpdateFromHash=function(t){var e=t.target.uuid||t.target.id,n=this._hashForUpdates[e];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[e],MO.put(r),DO.put(n)}},n._priorityIn=function(t,e,n){for(var i=0;i<t.length;i++)if(n<t[i].priority)return void t.splice(i,0,e);t.push(e)},n._appendIn=function(t,e){t.push(e)},e}(PO));BO.ID="scheduler",u.Scheduler=BO;var FO=((LO={})[eh.PORTRAIT]=ui.IDENTITY,LO[eh.LANDSCAPE_RIGHT]=ui.ROTATE_90,LO[eh.PORTRAIT_UPSIDE_DOWN]=ui.ROTATE_180,LO[eh.LANDSCAPE_LEFT]=ui.ROTATE_270,LO),zO=function(){function t(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}t.registerCreateFunc=function(e){e._createWindowFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t,e){if(this._init(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchain&&(this._swapchain=e.swapchain),this._width=e.width,this._height=e.height,this._renderPass=t.createRenderPass(e.renderPassInfo),e.swapchain)this._setSwapchain(e.swapchain),this._colorTextures.push(e.swapchain.colorTexture),this._depthStencilTexture=e.swapchain.depthStencilTexture;else{for(var n=0;n<e.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(t.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED|xi.TRANSFER_SRC,e.renderPassInfo.colorAttachments[n].format,this._width,this._height)));e.renderPassInfo.depthStencilAttachment.format!==fi.UNKNOWN&&(this._depthStencilTexture=t.createTexture(new mr(yi.TEX2D,xi.DEPTH_STENCIL_ATTACHMENT|xi.SAMPLED,e.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(t.createFramebuffer(new zr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},e.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var t=0;t<this._colorTextures.length;t++){var e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._destroy()},e.resize=function(t,e){if(this._swapchain)this._swapchain.resize(t,e,FO[ah.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(t,e);this._depthStencilTexture&&this._depthStencilTexture.resize(t,e),this._width=t,this._height=e}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new zr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=st(this._cameras);!(i=r()).done;)i.value.resize(t,e)},e.extractRenderCameras=function(t){for(var e=0;e<this._cameras.length;e++){var n=this._cameras[e];n.enabled&&(n.update(),t.push(n))}},e.attachCamera=function(t){for(var e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()},e.detachCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)},e.clearCameras=function(){this._cameras.length=0},e.sortCameras=function(){this._cameras.sort((function(t,e){return t.priority-e.priority}))},e._init=function(){},e._destroy=function(){},e._setSwapchain=function(t){this._swapchain=t},e._setFrameBuffer=function(t){this._framebuffer=t},Z(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),t}(),kO=function(){var t=e.prototype;function e(t){var e=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=u.internal.DataPoolManager&&new u.internal.DataPoolManager(t),lT.registerCreateFunc(this),zO.registerCreateFunc(this),this._cameraPool=new Wl((function(){return new vg(e._device)}),4,(function(t){return t.destroy()}))}return t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(t){this._cumulativeTime+=t},t._setFrameTime=function(t){this._frameTime=t},t.initialize=function(){this._init();var t=u.game._swapchain,e=new Mr;e.format=t.colorTexture.format;var n=new Dr;n.format=t.depthStencilTexture.format,n.depthStoreOp=Oi.DISCARD,n.stencilStoreOp=Oi.DISCARD;var i=new Lr([e],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:i,swapchain:t}),this._curWindow=this._mainWindow,Promise.resolve(Dv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(t,e){for(var n,i=st(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(t,e)}},t.setRenderPipeline=function(t){t instanceof CO&&(this._useDeferredPipeline=!0);var e=!1;if(t||(t=AO(),e=!0),this._pipeline=t,this._useDeferredPipeline&&this.device.hasFeature(hi.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return e&&this._pipeline.destroy(),this._pipeline=null,!1;var n=u.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&u.internal.Batcher2D&&(this._batcher=new u.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(t){this._curWindow=t},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(t){this._setFrameTime(t),++this._frameCount,this._setCumulativeTime(t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([u.game._swapchain]);var o=this._scenes,a=u.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);u.director.emit(u.Director.EVENT_BEFORE_COMMIT),i.sort((function(t,e){return t.priority-e.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(t){var e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e},t.destroyWindow=function(t){for(var e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)},t.destroyWindows=function(){for(var t,e=st(this._windows);!(t=e()).done;)t.value.destroy();this._windows.length=0},t.createScene=function(t){var e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e},t.destroyScene=function(t){for(var e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)},t.destroyScenes=function(){for(var t,e=st(this._scenes);!(t=e()).done;)t.value.destroy();this._scenes.length=0},t.createModel=function(t){var e=this._modelPools.get(t);e||(this._modelPools.set(t,new Wl((function(){return new t}),10,(function(t){return t.destroy()}))),e=this._modelPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyModel=function(t){var e=this._modelPools.get(t.constructor);e?(e.free(t),t.scene&&t.scene.removeModel(t)):M(1300,t.constructor.name),t.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(t){var e=this._lightPools.get(t);e||(this._lightPools.set(t,new Wl((function(){return new t}),4,(function(t){return t.destroy()}))),e=this._lightPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyLight=function(t){var e=this._lightPools.get(t.constructor);if(e&&(e.free(t),t.scene))switch(t.type){case ry.SPHERE:t.scene.removeSphereLight(t);break;case ry.SPOT:t.scene.removeSpotLight(t)}t.destroy()},Z(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(t){this._curWindow=t}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(t){this._tempWindow=t}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}();u.Root=kO;var UO=t("Game",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).frame=null,e.container=null,e.canvas=null,e.renderType=-1,e.eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e.config={},e.onStart=null,e.frameTime=1e3/60,e.collisionMatrix=[],e.groupList=[],e._persistRootNodes={},e._gfxDevice=null,e._swapchain=null,e._configLoaded=!1,e._isCloning=!1,e._inited=!1,e._engineInited=!1,e._rendererInitialized=!1,e._paused=!0,e._frameRate=60,e._intervalId=0,e._initTime=0,e._startTime=0,e._deltaTime=0,e._onEngineInitedCallback=[],e}$(e,t);var n=e.prototype;return n.setFrameRate=function(t){this.frameRate=t},n.getFrameRate=function(){return this.frameRate},n.step=function(){u.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(uM._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var t=this;return new Promise((function(t){return u.director.once(u.Director.EVENT_END_FRAME,(function(){return t()}))})).then((function(){for(var n in t._persistRootNodes)t.removePersistRootNode(t._persistRootNodes[n]);return u.director.getScene().destroy(),u.Object._deferredDestroy(),u.director.reset(),u.profiler.reset(),t.pause(),t._setRenderPipelineNShowSplash().then((function(){t.resume(),t._safeEmit(e.EVENT_RESTART)}))}))},n.end=function(){_u.close()},n.on=function(t,n,i,r){return(this._engineInited&&t===e.EVENT_ENGINE_INITED||this._inited&&t===e.EVENT_GAME_INITED||this._rendererInitialized&&t===e.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(t,n,i,r)},n.once=function(t,n,i){return this._engineInited&&t===e.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(t,n,i)},n.init=function(t){var e=this;if(this._initConfig(t),ch._init({configOrientation:t.orientation||"auto",exactFitScreen:t.exactFitScreen}),this.config.assetOptions&&u.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,i=0;i<n.length;i++){var o=n[i],a=r(o.value);Ld.addLayer(o.name,a)}return this._initEngine().then((function(){return e._initEvents(),u.director.root&&u.director.root.dataPoolManager&&u.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),e._engineInited}))},n.run=function(t,e){var n,i=this;return"function"!=typeof t&&t?(n=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,lu.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},n.addPersistRootNode=function(t){if(u.Node.isNode(t)&&t.uuid){var e=t.uuid;if(!this._persistRootNodes[e]){var n=u.director._scene;if(u.isValid(n))if(t.parent){if(!(t.parent instanceof u.Scene))return void M(3801);if(t.parent!==n)return void M(3802);t._originalSceneId=n.uuid}else t.parent=n;this._persistRootNodes[e]=t,t._persistNode=!0,u.assetManager._releaseManager._addPersistNodeRef(t)}}else M(3800)},n.removePersistRootNode=function(t){var e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",u.assetManager._releaseManager._removePersistNodeRef(t))},n.isPersistRootNode=function(t){return!!t._persistNode},n.onEngineInitedAsync=function(t){this._onEngineInitedCallback.push(t)},n._initEngine=function(){var t=this;this._initDevice();var n=u.director;return Promise.resolve(n._init()).then((function(){u.view.init(),x("Cocos Creator v"+h),t.emit(e.EVENT_ENGINE_INITED),t._engineInited=!0,u.internal.dynamicAtlasManager&&(u.internal.dynamicAtlasManager.enabled=!ue.CLEANUP_IMAGE_CACHE)})).then((function(){var e=t._onEngineInitedCallback.map((function(t){return t()})).filter(Boolean);return t._onEngineInitedCallback.length=0,Promise.all(e)}))},n._setAnimFrame=function(){var t=this._frameRate,e=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==t&&30!==t?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=e||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(t){var e=performance.now(),n=Math.max(0,e-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(t,i)},n._ctTime=function(t){window.clearTimeout(t)},n._calculateDT=function(t){return t||(t=performance.now()),this._deltaTime=t>this._startTime?(t-this._startTime)/1e3:0,this._deltaTime>e.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=t,this._deltaTime},n._updateCallback=function(){var t,e=this,n=u.director;if(30===this._frameRate){var i=!0;t=function(t){e._intervalId=window.rAF(e._frameCB),(i=!i)||n.tick(e._calculateDT(t))}}else t=function(t){n.tick(e._calculateDT(t)),e._intervalId=window.rAF(e._frameCB)};this._frameCB=t},n._runMainLoop=function(){if(this._inited){var t=this.config,e=u.director;k(!!t.showFPS),e.startAnimation(),this.resume()}},n._initConfig=function(t){"number"!=typeof t.debugMode&&(t.debugMode=N.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);var e=t.renderMode;("number"!=typeof e||e>3||e<0)&&(t.renderMode=0),t.showFPS=!!t.showFPS,C(t.debugMode),this.config=t,this._configLoaded=!0,this.frameRate=t.frameRate},n._determineRenderType=function(){var t=this.config,n=parseInt(t.renderMode,10);this.renderType=e.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=e.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=e.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=e.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(F(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var t=this.config.adapter;if(t&&(this.canvas=t.canvas,this.frame=t.frame,this.container=t.container),this._determineRenderType(),this.renderType===e.RENDER_TYPE_WEBGL){var n=new ur(Qd),i=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||lh.browserType===iu.UC)&&(i=!1);var o=[];i&&u.WebGL2Device&&o.push(u.WebGL2Device),u.WebGLDevice&&o.push(u.WebGLDevice),u.EmptyDevice&&o.push(u.EmptyDevice),fo.canvas=this.canvas;for(var a=0;a<o.length&&(this._gfxDevice=new o[a],!this._gfxDevice.initialize(n));a++);}else this.renderType===e.RENDER_TYPE_HEADLESS&&u.EmptyDevice&&(this._gfxDevice=new u.EmptyDevice,this._gfxDevice.initialize(new ur(Qd)));if(!this._gfxDevice)return T("can not support canvas rendering in 3D"),void(this.renderType=e.RENDER_TYPE_CANVAS);var s=new lr(this.canvas),c=ch.windowSize;s.width=c.width,s.height=c.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){_u.on("show",this._onShow,this),_u.on("hide",this._onHide,this)},n._onHide=function(){this.emit(e.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(e.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var t=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(t._showSplashScreen()).then((function(){t._inited=!0,t._initTime=performance.now(),t._runMainLoop(),t._safeEmit(e.EVENT_GAME_INITED),t.onStart&&t.onStart()}))}))},n._setupRenderPipeline=function(){var t=this,e=this.config.renderPipeline;return e?new Promise((function(t,n){u.assetManager.loadAny(e,(function(e,i){return!e&&i instanceof lx?t(i):n(e)}))})).then((function(e){t._setRenderPipeline(e)})).catch((function(n){S(n),S("Failed load render pipeline: "+e+", engine failed to initialize, will fallback to default pipeline"),t._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(u.internal.SplashScreen){var t=u.internal.SplashScreen.instance;return t.main(u.director.root),new Promise((function(e){t.setOnFinish((function(){return e()})),t.loadFinish=!0}))}return null},n._setRenderPipeline=function(t){u.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(e.EVENT_RENDERER_INITED)},n._safeEmit=function(t){this.emit(t)},Z(e,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),e}(eu));UO.EVENT_HIDE="game_on_hide",UO.EVENT_SHOW="game_on_show",UO.EVENT_LOW_MEMORY="game_on_low_memory",UO.EVENT_GAME_INITED="game_inited",UO.EVENT_ENGINE_INITED="engine_inited",UO.EVENT_RENDERER_INITED="renderer_inited",UO.EVENT_RESTART="game_on_restart",UO.RENDER_TYPE_CANVAS=0,UO.RENDER_TYPE_WEBGL=1,UO.RENDER_TYPE_OPENGL=2,UO.RENDER_TYPE_HEADLESS=3,UO.DEBUG_DT_THRESHOLD=1,u.Game=UO;var GO=t("game",u.game=new UO),HO=t("Director",function(t){function e(){var e;return(e=t.call(this)||this)._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new BO,e._compScheduler=new FM,e._nodeActivator=new eD,e._systems=[],GO.once(UO.EVENT_RENDERER_INITED,e._initOnRendererInitialized,ot(e)),e}$(e,t);var n=e.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var t=this;this.once(e.EVENT_END_FRAME,(function(){t.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),u.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),u.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(e.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(t,e,n){t instanceof nD&&(t=t.scene),B(t instanceof SM,1216),t._load();for(var i=Object.keys(GO._persistRootNodes).map((function(t){return GO._persistRootNodes[t]})),r=0;r<i.length;r++){var o=i[r];o.emit(u.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);var a=t.uuid===o._originalSceneId&&t.getChildByUuid(o.uuid);if(a){var s=a.getSiblingIndex();a._destroyImmediate(),t.insertChild(o,s)}else o.parent=t}var c=this._scene;u.isValid(c)&&c.destroy(),u.assetManager._releaseManager._autoRelease(c,t,GO._persistRootNodes),this._scene=null,dl._deferredDestroy(),e&&e(),this.emit(u.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,t),this.emit(u.Director.EVENT_AFTER_SCENE_LAUNCH,t)},n.runScene=function(t,e,n){var i=this;t instanceof nD&&(t=t.scene),B(t,1205),B(t instanceof SM,1216),t._load(),this.once(u.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(t,e,n)}))},n.loadScene=function(t,e,n){var i=this;if(this._loadingScene)return M(1208,t,this._loadingScene),!1;var r=u.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));return r?(this.emit(u.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time("LoadScene "+t),r.loadScene(t,(function(r,o){console.timeEnd("LoadScene "+t),i._loadingScene="",r?(T(r),e&&e(r)):i.runSceneImmediate(o,n,e)})),!0):(O(1209,t),!1)},n.preloadScene=function(t,e,n){var i=u.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));if(i)i.preloadScene(t,null,e,n);else{var r='Can not preload the scene "'+t+'" because it is not in the build settings.';n&&n(new Error(r)),T("preloadScene: "+r)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return GO.deltaTime},n.getTotalTime=function(){return GO.totalTime},n.getCurrentTime=function(){return GO.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(BO.ID,t,200))},n.registerSystem=function(t,e,n){e.id=t,e.priority=n,e.init(),this._systems.push(e),this._systems.sort(PO.sortByPriority)},n.unregisterSystem=function(t){ne.fastRemove(this._systems,t),this._systems.sort(PO.sortByPriority)},n.getSystem=function(t){return this._systems.find((function(e){return e.id===t}))},n.getAnimationManager=function(){return this.getSystem(u.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(t){var e;e=GO._calculateDT(t),this.tick(e)},n.tick=function(t){if(!this._invalid){if(this.emit(e.EVENT_BEGIN_FRAME),uM._frameDispatchEvents(),!this._paused){this.emit(e.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var n=0;n<this._systems.length;++n)this._systems[n].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(e.EVENT_AFTER_UPDATE),dl._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(t)}this.emit(e.EVENT_BEFORE_DRAW),this._root.frameMove(t),this.emit(e.EVENT_AFTER_DRAW),WC.resetHasChangedFlags(),WC.clearNodeArray(),Hl.update(t),this.emit(e.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(BO.ID,this._scheduler,200),this.emit(e.EVENT_INIT)},n._init=function(){return this._root=new kO(GO._gfxDevice),this._root.initialize({}).catch((function(t){return O(1217),Promise.reject(t)}))},Z(e,[{key:"root",get:function(){return this._root}}]),e}(eu));HO.EVENT_INIT="director_init",HO.EVENT_RESET="director_reset",HO.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",HO.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",HO.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",HO.EVENT_BEFORE_UPDATE="director_before_update",HO.EVENT_AFTER_UPDATE="director_after_update",HO.EVENT_BEFORE_DRAW="director_before_draw",HO.EVENT_AFTER_DRAW="director_after_draw",HO.EVENT_BEFORE_COMMIT="director_before_commit",HO.EVENT_BEFORE_PHYSICS="director_before_physics",HO.EVENT_AFTER_PHYSICS="director_after_physics",HO.EVENT_BEGIN_FRAME="director_begin_frame",HO.EVENT_END_FRAME="director_end_frame",HO.instance=void 0,u.Director=HO;var VO=t("director",HO.instance=u.director=new HO),WO={};U(WO,"vmath",[{name:"vec2",newName:"Vec2",target:ai,targetName:"math"},{name:"vec3",newName:"Vec3",target:ai,targetName:"math"},{name:"vec4",newName:"Vec4",target:ai,targetName:"math"},{name:"quat",newName:"Quat",target:ai,targetName:"math"},{name:"mat3",newName:"Mat3",target:ai,targetName:"math"},{name:"mat4",newName:"Mat4",target:ai,targetName:"math"},{name:"color4",newName:"Color",target:ai,targetName:"math"},{name:"rect",newName:"Rect",target:ai,targetName:"math"},{name:"approx",newName:"approx",target:ai,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:ai,targetName:"math"},{name:"equals",newName:"equals",target:ai,targetName:"math"},{name:"clamp",newName:"clamp",target:ai,targetName:"math"},{name:"clamp01",newName:"clamp01",target:ai,targetName:"math"},{name:"lerp",newName:"lerp",target:ai,targetName:"math"},{name:"toRadian",newName:"toRadian",target:ai,targetName:"math"},{name:"toDegree",newName:"toDegree",target:ai,targetName:"math"},{name:"random",newName:"random",target:ai,targetName:"math"},{name:"randomRange",newName:"randomRange",target:ai,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:ai,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:ai,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:ai,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:ai,targetName:"math"},{name:"repeat",newName:"repeat",target:ai,targetName:"math"},{name:"pingPong",newName:"pingPong",target:ai,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:ai,targetName:"math"}]),u.vmath=WO,U(BO.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:BO,targetName:"Scheduler"}]),U(BO,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return PO.Priority.SCHEDULER}}]),G(BO,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),U(iT.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),G(iT.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),U(kO.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),H(GO,"game",[{name:"collisionMatrix"},{name:"groupList"}]),H(HO.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),G(HO.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var jO,qO={topLeft:u.v2(0,0),topRight:u.v2(0,0),top:u.v2(0,0),bottomLeft:u.v2(0,0),bottomRight:u.v2(0,0),bottom:u.v2(0,0),center:u.v2(0,0),left:u.v2(0,0),right:u.v2(0,0),width:0,height:0,init:function(t){var e=this.width=t.width,n=this.height=t.height,i=t.x,r=t.y,o=r+n,a=i+e;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+e/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+e/2,this.bottom.y=r,this.center.x=i+e/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};u.visibleRect=qO;var XO=new ti,YO=((jO={})[ue.ORIENTATION_AUTO]=eh.AUTO,jO[ue.ORIENTATION_LANDSCAPE]=eh.LANDSCAPE,jO[ue.ORIENTATION_PORTRAIT]=eh.PORTRAIT,jO),KO=t("View",function(t){function e(){var e;(e=t.call(this)||this)._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var n=QO,i=ZO;return e._designResolutionSize=new ti(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new ni(0,0,0,0),e._visibleRect=new ni(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new JO(n.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new JO(n.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new JO(n.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new JO(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new JO(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}$(e,t);var n=e.prototype;return n.init=function(){var t=ch.windowSize,e=t.width,n=t.height;this._designResolutionSize.width=e,this._designResolutionSize.height=n,this._viewportRect.width=e,this._viewportRect.height=n,this._visibleRect.width=e,this._visibleRect.height=n,XO.width=this._visibleRect.width,XO.height=this._visibleRect.height,qO&&qO.init(this._visibleRect),ah.on("window-resize",this._updateAdaptResult,this),ah.on("orientation-change",this._updateAdaptResult,this),ah.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(t){ah.handleResizeEvent=t},n.setResizeCallback=function(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)},n.setOrientation=function(t){ah.orientation=YO[t]},n.adjustViewportMeta=function(){},n.enableRetina=function(t){this._retinaEnabled=!!t},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&ch.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(t,e){ah.resolutionScale=1;var n=ah.devicePixelRatio,i=new ti(t*n,e*n);ch.windowSize=i},n.getCanvasSize=function(){return ch.windowSize},n.getFrameSize=function(){var t=ah.devicePixelRatio,e=ch.windowSize;return e.width/=t,e.height/=t,e},n.setFrameSize=function(t,e){var n=ah.devicePixelRatio;ch.windowSize=new ti(t*n,e*n)},n.getVisibleSize=function(){return new ti(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new ti(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Xn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Xn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(t){if(t instanceof JO)this._resolutionPolicy=t;else{var e=JO;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(t){this._updateResolutionPolicy(t);var e=$O.getDesignResolutionSize();$O.setDesignResolutionSize(e.width,e.height,t)},n.setDesignResolutionSize=function(t,e,n){if(t>0&&e>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=t,this._designResolutionSize.height=e;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),XO.width=this._visibleRect.width,XO.height=this._visibleRect.height,qO&&qO.init(this._visibleRect),this.emit("design-resolution-changed")}else O(2200)},n.getDesignResolutionSize=function(){return new ti(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(t,e,n){document.documentElement.style.width=t+"px",document.body.style.width=t+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(t,e,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return ah.devicePixelRatio},n.convertToLocationInView=function(t,e,n,i){void 0===i&&(i=new Xn);var r=ah.devicePixelRatio*(t-n.left),o=ah.devicePixelRatio*(n.top+n.height-e);return ah.isFrameRotated?(i.x=ch.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(t){var e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY},n._updateAdaptResult=function(){var t;u.director.root.resize(ch.windowSize.width,ch.windowSize.height);var e=this._designResolutionSize.width,n=this._designResolutionSize.height;e>0&&this.setDesignResolutionSize(e,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(t=this._resizeCallback)||void 0===t||t.call(this)},e}(eu));KO.instance=void 0;var QO=function(){function t(){this.name="ContainerStrategy"}var e=t.prototype;return e.preApply=function(){},e.apply=function(){},e.postApply=function(){},e._setupCanvas=function(){var t=GO.canvas;if(t){var e=ch.windowSize;t.width=e.width,t.height=e.height}},t}();QO.EQUAL_TO_FRAME=void 0,QO.PROPORTION_TO_FRAME=void 0;var ZO=function(){function t(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var e=t.prototype;return e.preApply=function(){},e.apply=function(){return{scale:[1,1]}},e.postApply=function(){},e._buildResult=function(t,e,n,i,r,o){Math.abs(t-n)<2&&(n=t),Math.abs(e-i)<2&&(i=e);var a=new ni(Math.round((t-n)/2),Math.round((e-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},t}();ZO.EXACT_FIT=void 0,ZO.SHOW_ALL=void 0,ZO.NO_BORDER=void 0,ZO.FIXED_HEIGHT=void 0,ZO.FIXED_WIDTH=void 0,function(){var t=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="EqualToFrame",e}return $(e,t),e.prototype.apply=function(){ah.isProportionalToFrame=!1,this._setupCanvas()},e}(QO),e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ProportionalToFrame",e}return $(e,t),e.prototype.apply=function(){ah.isProportionalToFrame=!0,this._setupCanvas()},e}(QO);QO.EQUAL_TO_FRAME=new t,QO.PROPORTION_TO_FRAME=new e;var n=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ExactFit",e}return $(e,t),e.prototype.apply=function(t,e){var n=ch.windowSize,i=n.width,r=n.height,o=i/e.width,a=r/e.height;return this._buildResult(i,r,i,r,o,a)},e}(ZO),i=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ShowAll",e}return $(e,t),e.prototype.apply=function(t,e){var n,i,r=ch.windowSize,o=r.width,a=r.height,s=e.width,c=e.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},e}(ZO),r=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="NoBorder",e}return $(e,t),e.prototype.apply=function(t,e){var n,i,r,o=ch.windowSize,a=o.width,s=o.height,c=e.width,l=e.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},e}(ZO),o=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedHeight",e}return $(e,t),e.prototype.apply=function(t,e){var n=ch.windowSize,i=n.width,r=n.height,o=r/e.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(ZO),a=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedWidth",e}return $(e,t),e.prototype.apply=function(t,e){var n=ch.windowSize,i=n.width,r=n.height,o=i/e.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(ZO);ZO.EXACT_FIT=new n,ZO.SHOW_ALL=new i,ZO.NO_BORDER=new r,ZO.FIXED_HEIGHT=new o,ZO.FIXED_WIDTH=new a}();var JO=t("ResolutionPolicy",function(){function t(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}var e=t.prototype;return e.preApply=function(t){this._contentStrategy.preApply(t)},e.apply=function(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)},e.postApply=function(t){this._contentStrategy.postApply(t)},e.setContainerStrategy=function(t){t instanceof QO&&(this._containerStrategy=t)},e.setContentStrategy=function(t){t instanceof ZO&&(this._contentStrategy=t)},Z(t,[{key:"canvasSize",get:function(){return ch.windowSize}}]),t}());JO.EXACT_FIT=0,JO.NO_BORDER=1,JO.SHOW_ALL=2,JO.FIXED_HEIGHT=3,JO.FIXED_WIDTH=4,JO.UNKNOWN=5,JO.ContainerStrategy=QO,JO.ContentStrategy=ZO,u.ResolutionPolicy=JO;var $O=t("view",KO.instance=u.view=new KO);u.winSize=XO,G(KO.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),H(KO.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),H(u,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),H(lh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),U(lh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(t){return{name:"LANGUAGE_"+t,newName:t,target:lh.Language,targetName:"sys.Language"}}))),U(lh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(t){return{name:"OS_"+t,newName:t,target:lh.OS,targetName:"sys.OS"}}))),U(lh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(t){return{name:"BROWSER_TYPE_"+t,newName:t,target:lh.BrowserType,targetName:"sys.BrowserType"}}))),U(lh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:lh.BrowserType,targetName:"sys.BrowserType"}]),U(lh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(t){return{name:t,target:lh.Platform,targetName:"sys.Platform"}}))),U(lh,"sys",[{name:"IPHONE",newName:"IOS",target:lh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:lh.Platform,targetName:"sys.Platform"}]),G(lh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(t){return{name:t}}))),U(lh,"sys",[{name:"windowPixelResolution",target:ch,targetName:"screen",newName:"windowSize"}]),H(ch,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var tN=function(){function t(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new vl,this.scenes=new vl,this.paths=new vl}var e=t.prototype;return e.init=function(t){var e=this;!function(t){var e=t.uuids,n=t.paths,i=t.types,r=t.deps,o=t.paths=Object.create(null);if(!1===t.debug){for(var a=0,s=e.length;a<s;a++)e[a]=Nl(e[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),f=0,p=e.length;f<p;f++){var d=e[f];e[f]=h[d]=Nl(d)}e=h}for(var _ in n){var m=n[_];o[e[_]]=m}var v=t.scenes;for(var g in v){var y=v[g];v[g]=e[y]}var x=t.packs;for(var S in x)for(var T=x[S],E=0;E<T.length;++E)T[E]=e[T[E]];var b=t.versions;if(b)for(var C in b)for(var A=b[C],w=0;w<A.length;w+=2){var R=A[w];A[w]=e[R]||R}var P=t.redirect;if(P)for(var I=0;I<P.length;I+=2)P[I]=e[P[I]],P[I+1]=r[P[I+1]];if(t.extensionMap){var M=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(i,r){t.extensionMap[n][r]=e[i]||i}))};for(var D in t.extensionMap)M(D)}}(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(t){var i=e.assetInfos.get(t);i&&(i.extension=n)}))};for(var i in t.extensionMap)n(i)},e.getInfoWithPath=function(t,e){if(!t)return null;t=kl(t);var n=this.paths.get(t);if(n){if(!e)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(ie.isChildClassOf(o.ctor,e))return o}}return null},e.getDirWithPath=function(t,e,n){"/"===(t=kl(t))[t.length-1]&&(t=t.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(t)&&function(t,e){return!(t.length>e.length)||47===t.charCodeAt(e.length)}(r,t)||!t)for(var o=0,a=n.length;o<a;o++){var s=n[o];e&&!ie.isChildClassOf(s.ctor,e)||i.push(s)}})),i},e.getAssetInfo=function(t){return this.assetInfos.get(t)||null},e.getSceneInfo=function(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t="/"+t),this.scenes.find((function(e,n){return n.endsWith(t)}))},e.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},e._initUuid=function(t){if(t){this.assetInfos.clear();for(var e=0,n=t.length;e<n;e++){var i=t[e];this.assetInfos.add(i,{uuid:i})}}},e._initPath=function(t){if(t){var e=this.paths;for(var n in e.clear(),t){var i=t[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=ie._getClassById(o),e.has(r)?a?e.get(r).push(s):e.get(r).unshift(s):e.add(r,[s])}}},e._initScene=function(t){if(t){var e=this.scenes;e.clear();var n=this.assetInfos;for(var i in t){var r=t[i],o=n.get(r);o.url=i,e.add(i,o)}}},e._initPackage=function(t){if(t){var e=this.assetInfos;for(var n in t){var i=t[n],r={uuid:n,packedUuids:i,ext:".json"};e.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=e.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},e._initVersion=function(t){if(t){var e=this.assetInfos,n=t.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];e.get(o).ver=n[i+1]}if(n=t.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];e.get(c).nativeVer=n[a+1]}}},e._initRedirect=function(t){if(t)for(var e=this.assetInfos,n=0,i=t.length;n<i;n+=2){var r=t[n];e.get(r).redirect=t[n+1]}},t}();function eN(t,e){t._uuid&&e.push(t._uuid)}function nN(t,e){for(var n=Object.getOwnPropertyNames(t),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=t[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Du&&eN(s,e)}else if(o.constructor&&o.constructor!==Object)o instanceof Du&&eN(o,e);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Du&&eN(u,e)}}}}function iN(t,e){for(var n=0;n<t._components.length;n++)nN(t._components[n],e);for(var i=0;i<t._children.length;i++)iN(t._children[i],e)}function rN(t,e,n,i){n.push(t._uuid);for(var r=av.getDeps(t._uuid),o=0,a=r.length;o<a;o++){var s=xl.get(r[o]);if(s){var c=s._uuid;c in e?e[c]+=i:e[c]=s.refCount+i,n.includes(c)||rN(s,e,n,i)}}}var oN=[],aN=new(function(){function t(){this._persistNodeDeps=new vl,this._toDelete=new vl,this._eventListener=!1}var e=t.prototype;return e.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},e._addPersistNodeRef=function(t){var e=[];iN(t,e);for(var n=0,i=e.length;n<i;n++){var r=xl.get(e[n]);r&&r.addRef()}this._persistNodeDeps.add(t.uuid,e)},e._removePersistNodeRef=function(t){if(this._persistNodeDeps.has(t.uuid)){for(var e=this._persistNodeDeps.get(t.uuid),n=0,i=e.length;n<i;n++){var r=xl.get(e[n]);r&&r.decRef()}this._persistNodeDeps.remove(t.uuid)}},e._autoRelease=function(t,e,n){if(t){for(var i=av.getDeps(t.uuid),r=0,o=i.length;r<o;r++){var a=xl.get(i[r]);a&&a.decRef(t.autoReleaseAssets)}var s=av._depends.get(t.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=xl.get(c[l]);h&&h.decRef(t.autoReleaseAssets)}t.uuid!==e.uuid&&av.remove(t.uuid)}var f=av._depends.get(e.uuid);for(var p in f&&(f.persistDeps=[]),n){for(var d,_,m=n[p],v=this._persistNodeDeps.get(m.uuid),g=st(v);!(_=g()).done;){var y=_.value,x=xl.get(y);x&&x.addRef()}f&&(d=f.persistDeps).push.apply(d,v)}},e.tryRelease=function(t,e){void 0===e&&(e=!1),t instanceof Du&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,xe(this._freeAssets.bind(this)))))},e._freeAssets=function(){var t=this;this._eventListener=!1,this._toDelete.forEach((function(e){t._free(e)})),this._toDelete.clear()},e._free=function(t,e){void 0===e&&(e=!1);var n=t._uuid;if(this._toDelete.remove(n),ml(t,!0)&&!(!e&&t.refCount>0&&function(t){var e=Object.create(null);if(e[t._uuid]=t.refCount,rN(t,e,oN,-1),oN.length=0,0!==e[t._uuid])return e[t._uuid];for(var n in e)0!==e[n]&&rN(xl.get(n),e,oN,1);return oN.length=0,e[t._uuid]}(t)>0)){xl.remove(n);for(var i=av.getDeps(n),r=0,o=i.length;r<o;r++){var a=xl.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}t.destroy(),av.remove(n)}},t}()),sN=null;function cN(t,e){for(var n=0,i=t.input.length;n<i;n++){var r=t.input[n];e&&!r.isNative&&r.content instanceof Du&&r.content.decRef(!1),r.recycle()}t.input=null}function lN(t,e){return e?/\?/.test(t)?t+"&_t="+Date.now():t+"?_t="+Date.now():t}function uN(t,e,n,i,r){void 0===r&&(r=0),t(r,(function(o,a){r++,!o||r>e?i&&i(o,a):setTimeout((function(){uN(t,e,n,i,r)}),n)}))}function hN(t,e,n,i,r){try{for(var o=av.parse(t,e),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(J({},o.nativeDep)))}catch(t){T(t.message,t.stack)}}function fN(t,e,n){e&&(n=void 0!==n?n:u.assetManager.cacheAsset,zl(e)||!n||e.isDefault||xl.add(t,e))}function pN(t,e,n){var i=0,r=[],o=t.length;0===o&&n&&n(r);for(var a=function(t){t&&r.push(t),++i===o&&n&&n(r)},s=0;s<o;s++)e(t[s],a)}function dN(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a="function"==typeof t;e?(o=e,a||(r=null)):void 0===e&&a&&(o=t,i=null,r=null),void 0!==e&&a&&(r=t,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function _N(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a=ie.isChildClassOf(t,Du);e?(o=e,a&&(r=null)):void 0!==e||a||(o=t,r=null,i=null),void 0===e||a||(r=t,i=null)}return{type:i,onProgress:r||sN,onComplete:o}}function mN(t,e,n,i){if(void 0===i&&(i={}),!n[e]||i[e])return!1;i[e]=!0;var r=!1,o=av.getDeps(e);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===t||mN(t,c,n,i)){r=!0;break}}return r}function vN(t){return function(e,n){if(t){var i=[];Array.isArray(n)?n.forEach((function(t){return t instanceof Du&&i.push(t.addRef())})):n instanceof Du&&i.push(n.addRef()),xe((function(){i.forEach((function(t){return t.decRef(!1)})),t(e,n)}))}}}var gN=function(){function t(){this._config=new tN}var e=t.prototype;return e.getInfoWithPath=function(t,e){return this._config.getInfoWithPath(t,e)},e.getDirWithPath=function(t,e,n){return this._config.getDirWithPath(t,e,n)},e.getAssetInfo=function(t){return this._config.getAssetInfo(t)},e.getSceneInfo=function(t){return this._config.getSceneInfo(t)},e.init=function(t){this._config.init(t),El.add(t.name,this)},e.load=function(t,e,n,i){var r=_N(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c={__requestType__:yl.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(t)};u.assetManager.loadAny(t,c,a,s)},e.preload=function(t,e,n,i){var r=_N(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;u.assetManager.preloadAny(t,{__requestType__:yl.PATH,type:o,bundle:this.name},a,s)},e.loadDir=function(t,e,n,i){var r=_N(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;u.assetManager.loadAny(t,{__requestType__:yl.DIR,type:o,bundle:this.name,__outputAsArray__:!0},a,s)},e.preloadDir=function(t,e,n,i){var r=_N(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;u.assetManager.preloadAny(t,{__requestType__:yl.DIR,type:o,bundle:this.name},a,s)},e.loadScene=function(t,e,n,i){var r=dN(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,u.assetManager.loadAny({scene:t},o,a,(function(t,e){if(t)T(t.message,t.stack);else if(e instanceof nD&&e.scene){var n=e.scene;n._id=e._uuid,n.name=e.name}else t=new Error("The asset "+e._uuid+" is not a scene");s&&s(t,e)}))},e.preloadScene=function(t,e,n,i){var r=dN(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.bundle=this.name,u.assetManager.preloadAny({scene:t},o,a,(function(e){e&&O(1210,t,e.message),s&&s(e)}))},e.get=function(t,e){var n=this.getInfoWithPath(t,e);return n&&xl.get(n.uuid)||null},e.release=function(t,e){var n=this.get(t,e);n&&aN.tryRelease(n,!0)},e.releaseUnusedAssets=function(){var t=this;xl.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&aN.tryRelease(e)}))},e.releaseAll=function(){var t=this;xl.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&aN.tryRelease(e,!0)}))},e._destroy=function(){this._config.destroy()},Z(t,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),t}(),yN=t("resources",new gN);function xN(t,e,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(F(4930,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=t,i}function SN(t,e,n,i){var r=new XMLHttpRequest,o="download failed: "+t+", status: ";if(r.open("GET",t,!0),void 0!==e.xhrResponseType&&(r.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(r.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(r.timeout=e.xhrTimeout),e.xhrHeader)for(var a in e.xhrHeader)r.setRequestHeader(a,e.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(t){t.lengthComputable&&n(t.loaded,t.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}u.resources=yN;var TN={};function EN(t,e,n){if(TN[t])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),TN[t]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(F(4928,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=e.scriptAsyncLoading||!1,i.src=t,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var bN=/^(?:\w+:\/\/|\.+\/).+/,CN=function(t,e,n){(lh.hasFeature(lh.Feature.IMAGE_BITMAP)&&u.assetManager.allowImageBitmap?AN:xN)(t,e,n)},AN=function(t,e,n){e.xhrResponseType="blob",SN(t,e,e.onFileProgress,n)},wN=function(t,e,n){e.xhrResponseType="json",SN(t,e,e.onFileProgress,n)},RN=function(t,e,n){e.xhrResponseType="arraybuffer",SN(t,e,e.onFileProgress,n)},PN=function(t,e,n){wN(t,e,(function(e,i){if(e)n(e);else{var r=ph(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){RN(""+Su(t)+n,{},(function(t,n){e?r(e):i(new Uint8Array(n))}))}))}))).then((function(t){var e=new fh(r.document,t);n(null,e)})).catch((function(t){n(t)}))}}))},IN=function(t,e,n){RN(t,e,(function(t,e){if(t)n(t);else try{var i=dh(new Uint8Array(e));n(null,i)}catch(t){n(t)}}))},MN=function(t,e,n){e.xhrResponseType="text",SN(t,e,e.onFileProgress,n)},DN=function(t,e,n){var i=Tu(t),r=t;bN.test(r)||(r=-1!==ON.remoteBundles.indexOf(i)?ON.remoteServerAddress+"remote/"+i:"assets/"+i);var o=e.version||ON.bundleVers[i],a=0,s=null,c=null;wN(r+"/config."+(o?o+".":"")+"json",e,(function(t,e){c=t,(s=e)&&(s.base=r+"/"),2==++a&&n(c,s)})),EN(r+"/index."+(o?o+".":"")+"js",e,(function(t){c=t,2==++a&&n(t,s)}))},ON=new(function(){function t(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=xN,this.downloadDomAudio=null,this.downloadFile=SN,this.downloadScript=EN,this._downloaders={".png":CN,".jpg":CN,".bmp":CN,".jpeg":CN,".gif":CN,".ico":CN,".tiff":CN,".webp":CN,".image":CN,".pvr":RN,".pkm":RN,".astc":RN,".txt":MN,".xml":MN,".vsh":MN,".fsh":MN,".atlas":MN,".tmx":MN,".tsx":MN,".json":wN,".ExportJson":wN,".plist":MN,".ccon":PN,".cconb":IN,".fnt":MN,".binary":RN,".bin":RN,".dbbin":RN,".skel":RN,".js":EN,bundle:DN,default:MN},this._downloading=new vl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var e=t.prototype;return e.init=function(t,e,n){void 0===t&&(t=""),void 0===e&&(e={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=n},e.register=function(t,e){"object"==typeof t?kt(this._downloaders,t):this._downloaders[t]=e},e.download=function(t,e,n,i,r){var o=this,a=Sl.get(t);if(a)r(null,a);else{var s=this._downloading.get(t);if(s){s.push(r);var c=this._queue.find((function(e){return e.id===t}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,f=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,p=this._downloaders[n]||this._downloaders.default;uN((function(n,a){if(0===n&&o._downloading.add(t,[r]),o.limited){o._updateTime();var s=function(t,e){o._totalNum--,o._handleQueueInNextFrame(h,f),a(t,e)};o._totalNum<h&&o._totalNumThisPeriod<f?(p(lN(e,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:t,priority:i.priority||0,url:e,options:i,done:s,handler:p}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,f))}else p(lN(e,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(e,n){e||Sl.add(t,n);for(var i=o._downloading.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))}}},e.loadSubpackage=function(t,e){u.assetManager.loadBundle(t,null,e)},e._updateTime=function(){var t=performance.now(),e=u.game.deltaTime,n=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=t)},e._handleQueue=function(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort((function(t,e){return t.priority-e.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(lN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(t,e)},e._handleQueueInNextFrame=function(t,e){!this._checkNextPeriod&&this._queue.length>0&&(xe(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)},Z(t,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),t}());function NN(t,e,n,i){var r=null,o=null;try{(r=new tv)._nativeUrl=t,r._nativeAsset=e}catch(t){o=t}i(o,r)}function LN(t,e,n,i){var r=new cD;r.json=e,i(null,r)}function BN(t,e,n,i){var r=new sD;r.text=e,i(null,r)}function FN(t,e,n,i){var r=new OA;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function zN(t,e,n,i){var r=new Du;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function kN(t,n,i,r){var o=El.get(n.name);o||(o=n.name===wl.RESOURCES?yN:new gN,n.base=n.base||t+"/",o.init(n)),e.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var UN=new(function(){function t(){this._creating=new vl,this._producers={".png":NN,".jpg":NN,".bmp":NN,".jpeg":NN,".gif":NN,".ico":NN,".tiff":NN,".webp":NN,".image":NN,".pvr":NN,".pkm":NN,".txt":BN,".xml":BN,".vsh":BN,".fsh":BN,".atlas":BN,".tmx":BN,".tsx":BN,".fnt":BN,".json":LN,".ExportJson":LN,".binary":FN,".bin":FN,".dbbin":FN,".skel":FN,bundle:kN,default:zN}}var e=t.prototype;return e.register=function(t,e){"object"==typeof t?ie.mixin(this._producers,t):this._producers[t]=e},e.create=function(t,e,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=xl.get(t);if(i.reloadAsset||!s){var c=this._creating.get(t);c?c.push(r):(this._creating.add(t,[r]),a(t,e,i,(function(e,n){!e&&n instanceof Du&&(n._uuid=t,fN(t,n,i.cacheAsset));for(var r=o._creating.remove(t),a=0,s=r.length;a<s;a++)r[a](e,n)})))}else r(null,s)},t}()),GN=new(function(){function t(){this._loading=new vl,this._unpackers={".json":this.unpackJson}}var e=t.prototype;return e.unpackJson=function(t,e,n,i){var r=ie.createMap(!0),o=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(F(5304,t[0]));Nh(t,!0,void 0,Bh.reportMissingClass),Lh(t);for(var e=new Fh(t[0]),n=t[1],i=t[2],r=t[3],o=t[4],a=t[5],s=0;s<a.length;++s)a[s].unshift(e,n,i,r,o);return a}(e)).length!==t.length&&O(4915);for(var a=0;a<t.length;a++)r[t[a]+"@import"]=e[a]}else{var s=ie._getClassId(Ev),c=ie._getClassId(tv);if(e.type===s&&e.data){var l=e.data;l.length!==t.length&&O(4915);for(var u=0;u<t.length;u++)r[t[u]+"@import"]=zh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(e.type===c&&e.data){var h=e.data;h.length!==t.length&&O(4915);for(var f=0;f<t.length;f++)r[t[f]+"@import"]=h[f]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},e.init=function(){this._loading.clear()},e.register=function(t,e){"object"==typeof t?ie.mixin(this._unpackers,t):this._unpackers[t]=e},e.unpack=function(t,e,n,i,r){e?(0,this._unpackers[n])(t,e,i,r):r(new Error("package data is wrong!"))},e.load=function(t,e,n){var i=this;if(!t.isNative&&t.info&&t.info.packs)if(Sl.has(t.id))n(null,Sl.get(t.id));else{var r=t.info.packs,o=r.find((function(t){return i._loading.has(t.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:t.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:t.id}]);var a=Ul(o.uuid,{ext:o.ext,bundle:t.config.name});ON.download(o.uuid,a,o.ext,t.options,(function(e,n){Sl.remove(o.uuid),e&&T(e.message,e.stack),i.unpack(o.packedUuids,n,o.ext,t.options,(function(t,n){if(!t)for(var r in n)Sl.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(e||t)l.onComplete(e||t);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else ON.download(t.id,t.url,t.ext,t.options,n)},t}());function HN(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var i=t.options,r=t.progress,o=[],a=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);t.output=[],pN(t.input,(function(i,c){if(!i.isNative&&xl.has(i.uuid)){var l=xl.get(i.uuid);return i.content=l.addRef(),t.output.push(i),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,i),void c()}GN.load(i,t.options,(function(l,h){l?t.isFinish||(!u.assetManager.force||n?(T(l.message,l.stack),r.canInvoke=!1,e(l)):(t.output.push(i),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,i))):t.isFinish||(i.file=h,t.output.push(i),i.isNative||(s[i.uuid]=!0,hN(i.uuid,h,s,o,i.config),r.total=a+o.length),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,i)),c()}))}),(function(){if(t.isFinish)return cN(t,!0),void t.dispatch("error");if(o.length>0){var a=Pl.create({input:o,progress:r,options:i,onProgress:t.onProgress,onError:Pl.prototype.recycle,onComplete:function(i){var r;i||((r=t.output).push.apply(r,a.output),a.recycle()),n&&VN(t),e(i)}});Cl.async(a)}else n&&VN(t),e()}))}function VN(t){for(var e=t.output,n=0,i=e.length;n<i;n++)e[n].content&&e[n].content.decRef(!1)}var WN=new(function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.parse=function(t){var e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return M(5100),{};for(var n=null,i=0,r=e.childNodes.length;i<r&&1!==(n=e.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(t){var e=null,n=t.tagName;if("dict"===n)e=this._parseDict(t);else if("array"===n)e=this._parseArray(t);else if("string"===n)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(var i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].nodeValue}else"false"===n?e=!1:"true"===n?e=!0:"real"===n?e=parseFloat(t.firstChild.nodeValue):"integer"===n&&(e=parseInt(t.firstChild.nodeValue,10));return e},n._parseArray=function(t){for(var e=[],n=0,i=t.childNodes.length;n<i;n++){var r=t.childNodes[n];1===r.nodeType&&e.push(this._parseNode(r))}return e},n._parseDict=function(t){for(var e={},n="",i=0,r=t.childNodes.length;i<r;i++){var o=t.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:e[n]=this._parseNode(o))}return e},e}(function(){function t(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var e=t.prototype;return e.parse=function(t){return this._parseXML(t)},e._parseXML=function(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")},t}()));function jN(t,e){return t[e]<<8|t[e+1]}var qN=new(function(){function t(){this._parsing=new vl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var e=t.prototype;return e.parseImage=function(t,e,n){t instanceof HTMLImageElement?n(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((function(t){n(null,t)}),(function(t){n(t,null)}))},e.parsePVRTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],f=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:f,height:h,format:0}}}catch(t){i=t}n(i,r)},e.parsePKMTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o),s=jN(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=jN(a,12),l=jN(a,14);jN(a,8),jN(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(t){i=t}n(i,r)},e.parseASTCTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(t,e){return 4===t?Mm.RGBA_ASTC_4x4:5===t?4===e?Mm.RGBA_ASTC_5x4:Mm.RGBA_ASTC_5x5:6===t?5===e?Mm.RGBA_ASTC_6x5:Mm.RGBA_ASTC_6x6:8===t?5===e?Mm.RGBA_ASTC_8x5:6===e?Mm.RGBA_ASTC_8x6:Mm.RGBA_ASTC_8x8:10===t?5===e?Mm.RGBA_ASTC_10x5:6===e?Mm.RGBA_ASTC_10x6:8===e?Mm.RGBA_ASTC_10x8:Mm.RGBA_ASTC_10x10:10===e?Mm.RGBA_ASTC_12x10:Mm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),f=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:f,format:u}}catch(t){i=t}n(i,r)},e.parsePlist=function(t,e,n){var i=null,r=WN.parse(t);r||(i=new Error("parse failed")),n(i,r)},e.parseImport=function(t,e,n){if(t){var i=null,r=null;try{i=rv(t,e)}catch(t){r=t}n(r,i)}else n(new Error("The json file of asset "+e.__uuid__+" is empty or missing"))},e.init=function(){this._parsing.clear()},e.register=function(t,e){"object"==typeof t?kt(this._parsers,t):this._parsers[t]=e},e.parse=function(t,e,n,i,r){var o=this,a=Tl.get(t);if(a)r(null,a);else{var s=this._parsing.get(t);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(t,[r]),c(e,i,(function(e,n){e?Sl.remove(t):zl(n)||Tl.add(t,n);for(var i=o._parsing.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))):r(null,e)}}},t}());function XN(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var i=t.options,r=t.progress;i.__exclude__=i.__exclude__||Object.create(null),t.output=[],pN(t.input,(function(o,a){var s=Pl.create({input:o,onProgress:t.onProgress,options:i,progress:r,onComplete:function(i,c){i&&!t.isFinish&&(!u.assetManager.force||n?(T(i.message,i.stack),r.canInvoke=!1,e(i)):r.canInvoke&&t.dispatch("progress",++r.finish,r.total,o)),t.output.push(c),s.recycle(),a(null)}});YN.async(s)}),(function(){if(i.__exclude__=null,t.isFinish)return cN(t,!0),void t.dispatch("error");!function(t){var e=t.source;if(t.options.__outputAsArray__||1!==e.length)for(var n=t.output=[],i=0,r=e.length;i<r;i++)n.push(e[i].content);else t.output=e[0].content}(t),cN(t,!0),e()}))}var YN=new gl("loadOneAsset",[function(t,e){var n=t.output=t.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&xl.has(o)?e():GN.load(n,t.options,(function(t,i){n.file=i,e(t)}))},function(t,e){var n=t.output=t.input,i=t.progress,r=t.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)qN.parse(o,a,n.ext,s,(function(r,a){r?e(r):(n.content=a,i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),Sl.remove(o),Tl.remove(o),e())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,f=l.err,p=l.callbacks;i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),u||mN(c,c,r)?(h&&h.addRef(),n.content=h,e(f)):p.push({done:e,item:n})}else if(!s.reloadAsset&&xl.has(c)){var d=xl.get(c);n.content=d.addRef(),i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),e()}else s.__uuid__=c,qN.parse(o,a,"import",s,(function(n,i){n?e(n):function(t,e,n){var i=t.input,r=t.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];e.addRef&&e.addRef(),hN(a,e,Object.create(null),h,l),r.canInvoke&&t.dispatch("progress",++r.finish,r.total+=h.length,i);var f=t.options.__exclude__[a]={content:e,finish:!1,callbacks:[{done:n,item:i}]},p=Pl.create({input:h,options:t.options,onProgress:t.onProgress,onError:Pl.prototype.recycle,progress:r,onComplete:function(t){if(e.decRef&&e.decRef(!1),f.finish=!0,f.err=t,!t){for(var n,i=Array.isArray(p.output)?p.output:[p.output],r=Object.create(null),o=st(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Du?c._uuid+"@import":a+"@native"]=c)}!function(t,e,n){var i=ev.get(e);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(T("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Du){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}ev.delete(e)}nv.has(e)&&(n[t+"@native"]?e._nativeAsset=n[t+"@native"]:(!0,console.error("the native asset of "+t+" is missing!")),nv.delete(e))}(a,e,r);try{"function"!=typeof e.onLoaded||iv.has(e)||nv.has(e)||(e.onLoaded(),iv.add(e))}catch(t){T("The asset "+a+" is invalid for some reason, detail message: "+t.message+", stack: "+t.stack)}Sl.remove(s),Tl.remove(s),fN(a,e,u),p.recycle()}for(var l=f.callbacks,h=0,d=l.length;h<d;h++){var _=l[h];e.addRef&&e.addRef(),_.item.content=e,_.done(t)}l.length=0}});bl.async(p)}(t,i,e)}))}}]);function KN(t,e){var n=t.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case yl.PATH:case yl.UUID:case yl.DIR:case yl.SCENE:case yl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}t.options=r;var a=Pl.create({input:t.input,options:i}),s=null;try{t.output=t.source=Al.sync(a)}catch(t){s=t;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),e(s)}var QN=function(){function t(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return t.create=function(){return 0!==t._deadPool.length?t._deadPool.pop():new t},t.prototype.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),t._deadPool.push(this))},Z(t,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),t}();QN.MAX_DEAD_NUM=500,QN._deadPool=[];var ZN=[];function JN(t){var e=t.options,n=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(var i=function(i){var r,o=n[i],a=QN.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[e.__requestType__||yl.UUID]=n[i]),"object"==typeof o)for(var l in zt(o,e),o.preset&&zt(o,Rl[o.preset]),o){switch(l){case yl.UUID:if("break"===function(){var t,e=a.uuid=Nl(o.uuid);if(!o.bundle){var n=El.find((function(t){return!!t.getAssetInfo(e)}));o.bundle=n&&n.name}if(El.has(o.bundle)){if(s=El.get(o.bundle).config,(c=s.getAssetInfo(e))&&c.redirect){if(!El.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=El.get(c.redirect).config,c=s.getAssetInfo(e)}a.config=s,a.info=c}return a.ext=o.ext||(null===(t=c)||void 0===t?void 0:t.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case yl.DIR:if(El.has(o.bundle)){El.get(o.bundle).config.getDirWithPath(o.dir,o.type,ZN);for(var u,h=st(ZN);!(u=h()).done;){var f=u.value;n.push({uuid:f.uuid,__isNative__:!1,ext:f.extension||".json",bundle:o.bundle})}ZN.length=0}a.recycle(),a=null;break;case yl.PATH:if(El.has(o.bundle)){if(s=El.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!El.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=El.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case yl.SCENE:if(!o.bundle){var p=El.find((function(t){return!!t.getSceneInfo(o.scene)}));o.bundle=p&&p.name}if(El.has(o.bundle)){if(s=El.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!El.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=El.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case yl.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||xu(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(t.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function $N(t){for(var e=t.output=t.input,n=0;n<e.length;n++){var i=e[n];if(!i.url){var r,o,a=i.config;o=i.isNative?a&&a.nativeBase?a.base+a.nativeBase:u.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:u.assetManager.generalImportBase;var s=i.uuid,c="";i.info&&(c=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),r=".ttf"===i.ext?o+"/"+s.slice(0,2)+"/"+s+c+"/"+i.options.__nativeName__:o+"/"+s.slice(0,2)+"/"+s+c+i.ext,i.url=r}}return null}var tL=t("AssetManager",function(){function t(){this.pipeline=bl.append(KN).append(XN),this.fetchPipeline=Cl.append(KN).append(HN),this.transformPipeline=Al.append(JN).append($N),this.bundles=El,this.assets=xl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=av,this.force=!1,this.allowImageBitmap=!lh.isMobile,this.utils=Gl,this.downloader=ON,this.parser=qN,this.packManager=GN,this.cacheAsset=!0,this.cacheManager=null,this.presets=Rl,this.factory=UN,this.preprocessPipe=KN,this.fetchPipe=HN,this.loadPipe=XN,this.references=null,this._releaseManager=aN,this._files=Sl,this._parsed=Tl,this._parsePipeline=null}var e=t.prototype;return e.init=function(t){void 0===t&&(t={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();var e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));var n=t.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=e,this.generalNativeBase=n},e.getBundle=function(t){return El.get(t)||null},e.removeBundle=function(t){t._destroy(),El.remove(t.name)},e.loadAny=function(t,e,n,i){var r=dN(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",t=Array.isArray(t)?t.slice():t;var c=Pl.create({input:t,onProgress:a,onComplete:vN(s),options:o});bl.async(c)},e.preloadAny=function(t,e,n,i){var r=dN(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",t=Array.isArray(t)?t.slice():t;var c=Pl.create({input:t,onProgress:a,onComplete:vN(s),options:o});Cl.async(c)},e.loadRemote=function(t,e,n){var i=dN(e,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(t)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:t},r,null,(function(e,n){e?(T(e.message,e.stack),o&&o(e,n)):UN.create(t,n,r.ext||xu(t),r,(function(t,e){o&&o(t,e)}))}))):vN(o)(null,this.assets.get(t))},e.loadBundle=function(t,e,n){var i=dN(e,void 0,n),r=i.options,o=i.onComplete,a=Tu(t);this.bundles.has(a)?vN(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:t},r,null,(function(e,n){e?(T(e.message,e.stack),o&&o(e,n)):UN.create(t,n,"bundle",r,(function(t,e){o&&o(t,e)}))})))},e.releaseAsset=function(t){aN.tryRelease(t,!0)},e.releaseUnusedAssets=function(){xl.forEach((function(t){aN.tryRelease(t)}))},e.releaseAll=function(){xl.forEach((function(t){aN.tryRelease(t,!0)}))},e.loadWithJson=function(){throw new Error("Only valid in Editor")},Z(t,[{key:"main",get:function(){return El.get(wl.MAIN)||null}},{key:"resources",get:function(){return El.get(wl.RESOURCES)||null}}]),t}());tL.Pipeline=gl,tL.Task=Pl,tL.Cache=vl,tL.RequestItem=QN,tL.Bundle=gN,tL.BuiltinBundleName=wl;var eL=t("assetManager",u.assetManager=new tL);u.AssetManager=tL;var nL=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],iL=[".mp3",".ogg",".wav",".m4a"];function rL(){return!0}var oL={transformURL:function(t){var e=Bl(t);if(!e)return t;var n=El.find((function(t){return!!t.getAssetInfo(e)}));if(!n)return t;var i,r=n.getAssetInfo(e);if(!(i=t.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==t.indexOf(i))return t;var o=!1;if(".ttf"===xu(t)&&(o=!0),o){var a=Eu(t),s=Tu(t);t=a+"."+i+"/"+s}else t=t.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(t){return t+"."+i}));return t}},aL=t("CCLoader",function(){function t(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=_N}var e=t.prototype;return e.load=function(t,e,n){void 0===n&&void 0!==e&&(n=e,e=null);for(var i=Array.isArray(t)?t:[t],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];eL.loadAny(i,null,(function(t,n,i){i.content&&(nL.includes(i.ext)?a.push(i.content):iL.includes(i.ext)&&s.push(i.content)),e&&e(t,n,i)}),(function(t,e){var r=null;if(!t){e=Array.isArray(e)?e:[e];for(var o=function(t){var n=e[t];if(!(n instanceof Du)){var r=n,o=i[t].url;a.includes(r)?UN.create(o,n,".png",{},(function(n,i){r=e[t]=i})):s.includes(r)&&UN.create(o,n,".mp3",{},(function(n,i){r=e[t]=i})),xl.add(o,r)}},c=0;c<e.length;c++)o(c);if(e.length>1){var l=Object.create(null);e.forEach((function(t){l[t._uuid]=t})),r={isCompleted:rL,_map:l}}else r=e[0]}n&&n(t,r)}))},e.getXMLHttpRequest=function(){return new XMLHttpRequest},e.getItem=function(t){return eL.assets.has(t)?{content:eL.assets.get(t)}:null},e.loadRes=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=xu(t);c&&!yN.getInfoWithPath(t,o)&&(t=t.slice(0,-c.length)),yN.load(t,o,a,s)},e.loadResArray=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;t.forEach((function(e,n){var i=xu(e);i&&!yN.getInfoWithPath(e,o)&&(t[n]=e.slice(0,-i.length))})),yN.load(t,o,a,s)},e.loadResDir=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;yN.loadDir(t,o,a,(function(e,n){var i=[];e||(i=yN.getDirWithPath(t,o).map((function(t){return t.path}))),s&&s(e,n,i)}))},e.getRes=function(t,e){return xl.has(t)?xl.get(t):yN.get(t,e)},e.getResCount=function(){return xl.count},e.getDependsRecursively=function(t){if(!t)return[];var e="string"==typeof t?t:t._uuid;return av.getDepsRecursively(e).concat([e])},e.addDownloadHandlers=function(t){var e=Object.create(null),n=function(n){var i=t[n];e["."+n]=function(t,e,n){i({url:t},n)}};for(var i in t)n(i);ON.register(e)},e.addLoadHandlers=function(t){var e=Object.create(null),n=function(n){var i=t[n];e["."+n]=function(t,e,n){i({content:t},n)}};for(var i in t)n(i);qN.register(e)},e.release=function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++){var n=t[e];"string"==typeof n&&(n=xl.get(n)),eL.releaseAsset(n)}else t&&("string"==typeof t&&(t=xl.get(t)),eL.releaseAsset(t))},e.releaseAsset=function(t){eL.releaseAsset(t)},e.releaseRes=function(t,e){yN.release(t,e)},e.releaseAll=function(){eL.releaseAll(),xl.clear()},e.removeItem=function(t){return!!xl.remove(t)},e.setAutoRelease=function(t,e){"object"==typeof t&&(t=t._uuid),this._autoReleaseSetting[t]=!!e},e.setAutoReleaseRecursively=function(t,e){"object"==typeof t&&(t=t._uuid),e=!!e,this._autoReleaseSetting[t]=e;for(var n=av.getDepsRecursively(t),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=e},e.isAutoRelease=function(t){return"object"==typeof t&&(t=t._uuid),!!this._autoReleaseSetting[t]},Z(t,[{key:"onProgress",set:function(t){sN=t}},{key:"_cache",get:function(){if(xl instanceof vl)return xl._map;var t={};return xl.forEach((function(e,n){t[n]=e})),t}},{key:"md5Pipe",get:function(){return oL}},{key:"downloader",get:function(){return ON}},{key:"loader",get:function(){return eL.parser}}]),t}()),sL=t("loader",new aL),cL=t("AssetLibrary",{init:function(t){t.importBase=t.libraryPath,t.nativeBase=t.rawAssetsBase,eL.init(t),t.rawAssets&&yN.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:wl.RESOURCES,importBase:t.importBase,nativeBase:t.nativeBase,paths:t.rawAssets.assets,uuids:Object.keys(t.rawAssets.assets),extensionMap:{}})},loadAsset:function(t,e){eL.loadAny(t,e)}}),lL=t("url",{});U(lL,"url",[{name:"normalize",target:eL.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(t){return t.startsWith("resources/")?Ul({path:bu(t.substr(10)),bundle:wl.RESOURCES,__isNative__:!0,ext:xu(t)}):""}}]),G(cL,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),G(sL,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),U(u,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return sL}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return cL}},{name:"Pipeline",target:tL,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return lL}}]),G(u,"cc",[{name:"LoadingItems",suggest:F(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),U(ue,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:ON,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),U(VO,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(t){var e;return eL.main?null===(e=eL.main.getSceneInfo(t))||void 0===e?void 0:e.uuid:""}}]),U(GO,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var t=[];return eL.main&&eL.main.config.scenes.forEach((function(e){t.push(e)})),t}}]);var uL,hL,fL,pL,dL,_L,mL,vL,gL,yL,xL,SL,TL,EL,bL=aN._autoRelease;aN._autoRelease=function(t,e,n){bL.call(aN,t,e,n);for(var i=sL._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=xl.get(a);s&&aN.tryRelease(s)}}};var CL,AL,wL,RL,PL,IL,ML,DL,OL,NL,LL,BL,FL,zL,kL,UL,GL,HL,VL,WL,jL,qL,XL,YL,KL,QL,ZL,JL,$L,tB,eB,nB,iB,rB,oB,aB,sB,cB,lB,uB,hB,fB,pB,dB,_B,mB,vB,gB,yB,xB,SB,TB,EB,bB,CB,AB,wB,RB,PB,IB,MB,DB,OB,NB,LB,BB,FB,zB=t("EventHandler",(uL=dc("cc.ClickEvent"),hL=Kc(u.Node),fL=Lc(),pL=Lc(),dL=Lc(),_L=Lc(),uL((EL=function(){function t(){ct(this,"target",gL,this),ct(this,"component",yL,this),ct(this,"_componentId",xL,this),ct(this,"handler",SL,this),ct(this,"customEventData",TL,this)}t.emitEvents=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=e.length;o<a;o++){var s=e[o];s instanceof t&&s.emit(i)}};var e=t.prototype;return e.emit=function(t){var e=this.target;if(u.isValid(e)){this._genCompIdIfNeeded();var n=u.js._getClassById(this._componentId),i=e.getComponent(n);if(u.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),r.apply(i,t))}}},e._compName2Id=function(t){var e=u.js.getClassByName(t);return u.js._getClassId(e)},e._compId2Name=function(t){var e=u.js._getClassById(t);return u.js.getClassName(e)},e._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},Z(t,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(t){this._componentId=this._compName2Id(t)}}]),t}(),gL=lt((vL=EL).prototype,"target",[xc,hL,xc,fL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yL=lt(vL.prototype,"component",[xc,Mc,pL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xL=lt(vL.prototype,"_componentId",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SL=lt(vL.prototype,"handler",[xc,Mc,dL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),TL=lt(vL.prototype,"customEventData",[xc,Mc,_L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mL=vL))||mL));u.Component.EventHandler=zB;var kB,UB,GB,HB,VB,WB,jB,qB,XB,YB,KB,QB=new Rn,ZB=oe(ig),JB=oe(ng),$B=oe(rg),tF=oe(ag),eF=oe(og),nF=oe({SKYBOX:_g|Xi.DEPTH_STENCIL,SOLID_COLOR:Xi.ALL,DEPTH_ONLY:Xi.DEPTH_STENCIL,DONT_CLEAR:Xi.NONE}),iF=(CL=dc("cc.Camera"),AL=Ic(),wL=Ac(),RL=Gc(),PL=Lc(),IL=Kc(Ld.BitMask),ML=Gc(),DL=Lc(),OL=Kc(nF),NL=Gc(),LL=Lc(),BL=Gc(),FL=Lc(),zL=Gc(),kL=Lc(),UL=Gc(),GL=Lc(),HL=Kc(ZB),VL=Gc(),WL=Lc(),jL=Kc(JB),qL=Gc(),XL=Lc(),YL=Gc(),KL=Lc(),QL=Gc(),ZL=Lc(),JL=Gc(),$L=Lc(),tB=Gc(),eB=Lc(),nB=Kc($B),iB=Gc(),rB=Lc(),oB=Kc(tF),aB=Gc(),sB=Lc(),cB=Kc(eF),lB=Gc(),uB=Lc(),hB=Gc(),fB=Lc(),pB=Kc(kS),dB=Gc(),_B=Lc(),kB=CL(mB=AL(mB=wL(mB=Cc((FB=BB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_projection",gB,ot(e)),ct(e,"_priority",yB,ot(e)),ct(e,"_fov",xB,ot(e)),ct(e,"_fovAxis",SB,ot(e)),ct(e,"_orthoHeight",TB,ot(e)),ct(e,"_near",EB,ot(e)),ct(e,"_far",bB,ot(e)),ct(e,"_color",CB,ot(e)),ct(e,"_depth",AB,ot(e)),ct(e,"_stencil",wB,ot(e)),ct(e,"_clearFlags",RB,ot(e)),ct(e,"_rect",PB,ot(e)),ct(e,"_aperture",IB,ot(e)),ct(e,"_shutter",MB,ot(e)),ct(e,"_iso",DB,ot(e)),ct(e,"_screenScale",OB,ot(e)),ct(e,"_visibility",NB,ot(e)),ct(e,"_targetTexture",LB,ot(e)),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e}$(e,t);var n=e.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=iy.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(t,e,n){return n||(n=ta.create()),this._camera&&this._camera.screenPointToRay(n,t,e),n},n.worldToScreen=function(t,e){return e||(e=new Rn),this._camera&&this._camera.worldToScreen(e,t),e},n.screenToWorld=function(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e},n.convertToUINode=function(t,e,n){if(n||(n=new Rn),!this._camera)return n;this.worldToScreen(t,QB);var i=e.getComponent("cc.UITransform"),r=$O.getVisibleSize(),o=QB.x-.5*this._camera.width,a=QB.y-.5*this._camera.height;return QB.x=o/u.view.getScaleX()+.5*r.width,QB.y=a/u.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(QB,n),n},n._createCamera=function(){this._camera||(this._camera=u.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?u.director.root&&u.director.root.mainWindow:u.director.root&&u.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=un(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(t){var e=this;t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(t){e._camera&&e._camera.setFixedSize(t.width,t.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}},Z(e,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t,this._camera&&(this._camera.priority=t)}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}},{key:"clearColor",get:function(){return this._color},set:function(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}},{key:"clearStencil",get:function(){return this._stencil},set:function(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}},{key:"projection",get:function(){return this._projection},set:function(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===ng.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._camera&&(this._camera.fov=un(t))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._camera&&(this._camera.nearClip=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=t,this._camera&&(this._camera.farClip=t)}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._camera&&(this._camera.iso=t)}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect=t,this._camera&&this._camera.setViewportInOrientedSpace(t)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(t){if(this._targetTexture!==t){var n=this._targetTexture;this._targetTexture=t,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(e.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?u.director.root&&u.director.root.mainWindow:u.director.root&&u.director.root.tempWindow)}}]),e}($u),BB.ProjectionType=ZB,BB.FOVAxis=JB,BB.ClearFlag=nF,BB.Aperture=$B,BB.Shutter=tF,BB.ISO=eF,BB.TARGET_TEXTURE_CHANGE="tex-change",gB=lt((vB=FB).prototype,"_projection",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZB.PERSPECTIVE}}),yB=lt(vB.prototype,"_priority",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xB=lt(vB.prototype,"_fov",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),SB=lt(vB.prototype,"_fovAxis",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JB.VERTICAL}}),TB=lt(vB.prototype,"_orthoHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),EB=lt(vB.prototype,"_near",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bB=lt(vB.prototype,"_far",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),CB=lt(vB.prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An("#333333")}}),AB=lt(vB.prototype,"_depth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wB=lt(vB.prototype,"_stencil",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RB=lt(vB.prototype,"_clearFlags",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nF.SOLID_COLOR}}),PB=lt(vB.prototype,"_rect",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(0,0,1,1)}}),IB=lt(vB.prototype,"_aperture",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $B.F16_0}}),MB=lt(vB.prototype,"_shutter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tF.D125}}),DB=lt(vB.prototype,"_iso",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eF.ISO100}}),OB=lt(vB.prototype,"_screenScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),NB=lt(vB.prototype,"_visibility",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Q_}}),LB=lt(vB.prototype,"_targetTexture",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(vB.prototype,"priority",[RL,PL],Object.getOwnPropertyDescriptor(vB.prototype,"priority"),vB.prototype),lt(vB.prototype,"visibility",[IL,ML,DL],Object.getOwnPropertyDescriptor(vB.prototype,"visibility"),vB.prototype),lt(vB.prototype,"clearFlags",[OL,NL,LL],Object.getOwnPropertyDescriptor(vB.prototype,"clearFlags"),vB.prototype),lt(vB.prototype,"clearColor",[BL,FL],Object.getOwnPropertyDescriptor(vB.prototype,"clearColor"),vB.prototype),lt(vB.prototype,"clearDepth",[zL,kL],Object.getOwnPropertyDescriptor(vB.prototype,"clearDepth"),vB.prototype),lt(vB.prototype,"clearStencil",[UL,GL],Object.getOwnPropertyDescriptor(vB.prototype,"clearStencil"),vB.prototype),lt(vB.prototype,"projection",[HL,VL,WL],Object.getOwnPropertyDescriptor(vB.prototype,"projection"),vB.prototype),lt(vB.prototype,"fovAxis",[jL,qL,XL],Object.getOwnPropertyDescriptor(vB.prototype,"fovAxis"),vB.prototype),lt(vB.prototype,"fov",[YL,KL],Object.getOwnPropertyDescriptor(vB.prototype,"fov"),vB.prototype),lt(vB.prototype,"orthoHeight",[QL,ZL],Object.getOwnPropertyDescriptor(vB.prototype,"orthoHeight"),vB.prototype),lt(vB.prototype,"near",[JL,$L],Object.getOwnPropertyDescriptor(vB.prototype,"near"),vB.prototype),lt(vB.prototype,"far",[tB,eB],Object.getOwnPropertyDescriptor(vB.prototype,"far"),vB.prototype),lt(vB.prototype,"aperture",[nB,iB,rB],Object.getOwnPropertyDescriptor(vB.prototype,"aperture"),vB.prototype),lt(vB.prototype,"shutter",[oB,aB,sB],Object.getOwnPropertyDescriptor(vB.prototype,"shutter"),vB.prototype),lt(vB.prototype,"iso",[cB,lB,uB],Object.getOwnPropertyDescriptor(vB.prototype,"iso"),vB.prototype),lt(vB.prototype,"rect",[hB,fB],Object.getOwnPropertyDescriptor(vB.prototype,"rect"),vB.prototype),lt(vB.prototype,"targetTexture",[pB,dB,_B],Object.getOwnPropertyDescriptor(vB.prototype,"targetTexture"),vB.prototype),mB=vB))||mB)||mB)||mB)||mB,t({Camera:kB,CameraComponent:kB}),kB);u.Camera=iF;var rF,oF,aF,sF,cF,lF,uF,hF,fF={parent:null,owner:null,subModelIdx:0},pF=t("RenderableComponent",(UB=dc("cc.RenderableComponent"),GB=Kc([cg]),HB=Kc(cg),VB=Gc(),WB=Nc(),UB((KB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_materials",XB,ot(e)),ct(e,"_visFlags",YB,ot(e)),e._materialInstances=[],e._models=[],e}$(e,t);var n=e.prototype;return n.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},n.setMaterial=function(t,e){t&&t instanceof mT&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var n=this._materialInstances[e];n&&(n.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])},n.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){fF.parent=this._materials[t],fF.owner=this,fF.subModelIdx=t;var e=new mT(fF);fF.parent=null,fF.owner=null,fF.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]},n.setMaterialInstance=function(t,e){if("number"==typeof t){M(12007);var n=t;t=e,e=n}var i=this._materialInstances[e];t&&t.parent?t!==i&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||i)&&this.setMaterial(t,e)},n.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},Z(e,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){var e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(var n=this._materials.length-e;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=t[i]&&this.setMaterialInstance(t[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}}]),e}($u),XB=lt((qB=KB).prototype,"_materials",[GB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),YB=lt(qB.prototype,"_visFlags",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ld.Enum.NONE}}),lt(qB.prototype,"sharedMaterials",[HB,VB,WB],Object.getOwnPropertyDescriptor(qB.prototype,"sharedMaterials"),qB.prototype),jB=qB))||jB));function dF(t){return"string"==typeof t||"number"==typeof t}u.RenderableComponent=pF,U(iF,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),U(iF.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),u.CameraComponent=iF,ie.setClassAlias(iF,"cc.CameraComponent");var _F,mF,vF,gF,yF,xF,SF,TF,EF,bF,CF,AF,wF,RF,PF,IF,MF,DF,OF,NF,LF,BF,FF=dc("cc.animation.HierarchyPath")((sF=function(){function t(t){ct(this,"path",aF,this),this.path=t||""}return t.prototype.get=function(t){return t instanceof WC?t.getChildByPath(this.path)||(M(3926,t.name,this.path),null):(M(3925),null)},t}(),aF=lt((oF=sF).prototype,"path",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rF=oF))||rF,zF=dc("cc.animation.ComponentPath")((hF=function(){function t(t){ct(this,"component",uF,this),this.component=t||""}return t.prototype.get=function(t){return t instanceof WC?t.getComponent(this.component)||(M(3928,t.name,this.component),null):(M(3927),null)},t}(),uF=lt((lF=hF).prototype,"component",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cF=lF))||cF,kF=dc("cc.animation.UniformProxyFactory")((xF=function(){function t(t,e){ct(this,"passIndex",vF,this),ct(this,"uniformName",gF,this),ct(this,"channelIndex",yF,this),this.passIndex=e||0,this.uniformName=t||""}return t.prototype.forTarget=function(t){var e=t.passes[this.passIndex],n=e.getHandle(this.uniformName);if(!n)throw new Error('Material "'+t.name+'" has no uniform "'+this.uniformName+'"');if(kv.getTypeFromHandle(n)<di.SAMPLER1D){var i=void 0===this.channelIndex?n:e.getHandle(this.uniformName,this.channelIndex,di.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+t.name+") has no channel "+this.channelIndex+'"');return function(t,e){for(var n,i=st(t.shaderInfo.blocks);!(n=i()).done;)for(var r,o=st(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===e)return a.count>1}return!1}(e,this.uniformName)?{set:function(t){e.setUniformArray(i,t)}}:{set:function(t){e.setUniform(i,t)}}}var r=kv.getBindingFromHandle(n),o=e.properties[this.uniformName],a=o&&o.value?o.value+"-texture":fm(o.type),s=Dv.get(a);return s||(S("Illegal texture default value: "+a+"."),s=Dv.get("default-texture")),{set:function(t){t||(t=s);var n=t.getGFXTexture();n&&n.width&&n.height&&(e.bindTexture(r,n),t instanceof Jm&&e.bindSampler(r,u.game._gfxDevice.getSampler(t.getSamplerInfo())))}}},t}(),vF=lt((mF=xF).prototype,"passIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gF=lt(mF.prototype,"uniformName",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yF=lt(mF.prototype,"channelIndex",[qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),_F=mF))||_F,UF=dc("cc.animation.MorphWeightValueProxy")((CF=function(){function t(){ct(this,"subMeshIndex",EF,this),ct(this,"shapeIndex",bF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeight(n,e.subMeshIndex,e.shapeIndex)}}},t}(),EF=lt((TF=CF).prototype,"subMeshIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bF=lt(TF.prototype,"shapeIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SF=TF))||SF,GF=dc("cc.animation.MorphWeightsValueProxy")((PF=function(){function t(){ct(this,"subMeshIndex",RF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeights(n,e.subMeshIndex)}}},t}(),RF=lt((wF=PF).prototype,"subMeshIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AF=wF))||AF,HF=dc("cc.animation.MorphWeightsAllValueProxy")(IF=function(){function t(){}return t.prototype.forTarget=function(t){return{set:function(e){for(var n,i,r=null!==(n=null===(i=t.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)t.setWeights(e,o)}}},t}())||IF;function VF(t,e,n,i){var r,o,a,s,c,l,u=new e,h=new e,f=new e,p=dc(t)((l=function(){function t(t,n,i){ct(this,"dataPoint",a,this),ct(this,"inTangent",s,this),ct(this,"outTangent",c,this),this.dataPoint=t||new e,this.inTangent=n||new e,this.outTangent=i||new e}var r=t.prototype;return r.lerp=function(t,e,r){var o=this.dataPoint,a=t.dataPoint;h=n(h,this.inTangent,r),f=n(f,t.outTangent,r);var s=e*e*e,c=e*e,l=s-2*c+e,p=-2*s+3*c,d=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,p),u=i(u,u,f,d)},r.getNoLerp=function(){return this.dataPoint},t}(),a=lt((o=l).prototype,"dataPoint",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=lt(o.prototype,"inTangent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),c=lt(o.prototype,"outTangent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),r=o))||r;if(e===Ln){var d=p.prototype.lerp;p.prototype.lerp=function(t,e,n){var i=d.call(this,t,e,n);return Ln.normalize(i,i),i}}return p}var WF=t("CubicSplineVec2Value",VF("cc.CubicSplineVec2Value",Xn,Xn.multiplyScalar,Xn.scaleAndAdd));u.CubicSplineVec2Value=WF;var jF=t("CubicSplineVec3Value",VF("cc.CubicSplineVec3Value",Rn,Rn.multiplyScalar,Rn.scaleAndAdd));u.CubicSplineVec3Value=jF;var qF=t("CubicSplineVec4Value",VF("cc.CubicSplineVec4Value",Zn,Zn.multiplyScalar,Zn.scaleAndAdd));u.CubicSplineVec4Value=qF;var XF=t("CubicSplineQuatValue",VF("cc.CubicSplineQuatValue",Ln,Ln.multiplyScalar,Ln.scaleAndAdd));u.CubicSplineQuatValue=XF;var YF=t("CubicSplineNumberValue",dc("cc.CubicSplineNumberValue")((BF=function(){function t(t,e,n){ct(this,"dataPoint",OF,this),ct(this,"inTangent",NF,this),ct(this,"outTangent",LF,this),this.dataPoint=t,this.inTangent=e,this.outTangent=n}var e=t.prototype;return e.lerp=function(t,e,n){var i=this.dataPoint,r=t.dataPoint,o=e*e*e,a=e*e;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+e)+r*(-2*o+3*a)+t.inTangent*n*(o-a)},e.getNoLerp=function(){return this.dataPoint},t}(),OF=lt((DF=BF).prototype,"dataPoint",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NF=lt(DF.prototype,"inTangent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LF=lt(DF.prototype,"outTangent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MF=DF))||MF);u.CubicSplineNumberValue=YF;var KF,QF,ZF,JF,$F,tz,ez,nz,iz,rz,oz,az,sz,cz,lz,uz,hz,fz,pz,dz,_z,mz,vz,gz,yz,xz,Sz,Tz=Symbol("CreateEval"),Ez=Symbol("NormalizedFollow"),bz=Symbol("ConvertAsTrsPath"),Cz=Symbol("TrackBinding"),Az=dc("cc.animation.TrackPath")((JF=function(){function t(){ct(this,"_paths",ZF,this)}var e=t.prototype;return e.toProperty=function(t){return this._paths.push(t),this},e.toElement=function(t){return this._paths.push(t),this},e.toHierarchy=function(t){return this._paths.push(new FF(t)),this},e.toComponent=function(t){var e=new zF("string"==typeof t?t:ie.getClassName(t));return this._paths.push(e),this},e.toCustomized=function(t){return this._paths.push(t),this},e.append=function(){for(var t,e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];var r=(t=this._paths).concat.apply(t,n.map((function(t){return t._paths})));return this._paths=r,this},e.isPropertyAt=function(t){return"string"==typeof this._paths[t]},e.parsePropertyAt=function(t){return this._paths[t]},e.isElementAt=function(t){return"number"==typeof this._paths[t]},e.parseElementAt=function(t){return this._paths[t]},e.isHierarchyAt=function(t){return this._paths[t]instanceof FF},e.parseHierarchyAt=function(t){return this.isHierarchyAt(t),this._paths[t].path},e.isComponentAt=function(t){return this._paths[t]instanceof zF},e.parseComponentAt=function(t){return this.isComponentAt(t),this._paths[t].component},e.slice=function(e,n){var i=new t;return i._paths=this._paths.slice(e,n),i},e.trace=function(t,e,n){var i,r;return null!==(i=e)&&void 0!==i||(e=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[Ez](t,e,n)},e[bz]=function(){for(var t,e=this._paths,n=e.length,i=0,r="";i<n;++i){var o=e[i];if(!(o instanceof FF))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(e[i]){case"position":case"scale":case"rotation":case"eulerAngles":t=e[i];break;default:return null}return{node:r,property:t}},e[Ez]=function(t,e,n){for(var i=this._paths,r=t,o=e;o<n;++o){var a=i[o];if(dF(a)){if(!(a in r))return M(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},Z(t,[{key:"length",get:function(){return this._paths.length}}]),t}(),ZF=lt((QF=JF).prototype,"_paths",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KF=QF))||KF,wz=dc("cc.animation.TrackBinding")($F=bc((iz=function(){function t(){ct(this,"path",ez,this),ct(this,"proxy",nz,this)}var e=t.prototype;return e.parseTrsPath=function(){return this.proxy?null:this.path[bz]()},e.createRuntimeBinding=function(t,e,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[Ez](t,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(t){c.set(t)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return O(3921),null}var h=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),f=i[Ez](t,0,o-1);return null===f?null:e&&f instanceof WC&&function(t){return"position"===t||"rotation"===t||"scale"===t||"eulerAngles"===t}(h)?e.createPoseWriter(f,h,n):{setValue:function(t){f[h]=t},getValue:function(){return f[h]}}},t}(),ez=lt((tz=iz).prototype,"path",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Az}}),nz=lt(tz.prototype,"proxy",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$F=tz))||$F)||$F,Rz=dc("cc.animation.Track")((sz=function(){function t(){ct(this,"_binding",az,this)}var e=t.prototype;return e.channels=function(){return[]},e.range=function(){for(var t,e={min:1/0,max:-1/0},n=st(this.channels());!(t=n()).done;){var i=t.value;e.min=Math.min(e.min,i.curve.rangeMin),e.max=Math.max(e.max,i.curve.rangeMax)}return e},Z(t,[{key:"path",get:function(){return this._binding.path},set:function(t){this._binding.path=t}},{key:"proxy",get:function(){return this._binding.proxy},set:function(t){this._binding.proxy=t}},{key:Cz,get:function(){return this._binding}}]),t}(),az=lt((oz=sz).prototype,"_binding",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wz}}),rz=oz))||rz,Pz=dc("cc.animation.Channel")((hz=function(){function t(t){this.name="",ct(this,"_curve",uz,this),this._curve=t}return Z(t,[{key:"curve",get:function(){return this._curve}}]),t}(),uz=lt((lz=hz).prototype,"_curve",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cz=lz))||cz,Iz=dc("cc.animation.SingleChannelTrack")((_z=function(t){function e(){var e;return ct(e=t.call(this)||this,"_channel",dz,ot(e)),e._channel=new Pz(e.createCurve()),e}$(e,t);var n=e.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[Tz]=function(){var t=this._channel.curve;return new Mz(t)},Z(e,[{key:"channel",get:function(){return this._channel}}]),e}(Rz),dz=lt((pz=_z).prototype,"_channel",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fz=pz))||fz,Mz=function(){function t(t){this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t)},t}(),Dz=dc("cc.animation.RealTrack")(mz=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.prototype.createCurve=function(){return new _p},e}(Iz))||mz;function Oz(t){return 0===t.keyFramesCount?void 0:t}var Nz,Lz,Bz,Fz,zz,kz,Uz,Gz,Hz,Vz,Wz=["X","Y","Z","W"],jz=dc("cc.animation.VectorTrack")((Sz=function(t){function e(){var e;ct(e=t.call(this)||this,"_channels",yz,ot(e)),ct(e,"_nComponents",xz,ot(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new Pz(new _p);i.name=Wz[n],e._channels[n]=i}return e}$(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[Tz]=function(){switch(this._nComponents){default:case 2:return new qz(Oz(this._channels[0].curve),Oz(this._channels[1].curve));case 3:return new Xz(Oz(this._channels[0].curve),Oz(this._channels[1].curve),Oz(this._channels[2].curve));case 4:return new Yz(Oz(this._channels[0].curve),Oz(this._channels[1].curve),Oz(this._channels[2].curve),Oz(this._channels[3].curve))}},Z(e,[{key:"componentsCount",get:function(){return this._nComponents},set:function(t){this._nComponents=t}}]),e}(Rz),yz=lt((gz=Sz).prototype,"_channels",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),xz=lt(gz.prototype,"_nComponents",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),vz=gz))||vz,qz=function(){function t(t,e){this._result=new Xn,this._x=t,this._y=e}return t.prototype.evaluate=function(t,e){return this._x&&this._y||!e.getValue||Xn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._result},t}(),Xz=function(){function t(t,e,n){this._result=new Rn,this._x=t,this._y=e,this._z=n}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z||!e.getValue||Rn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._result},t}(),Yz=function(){function t(t,e,n,i){this._result=new Zn,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||Zn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._w&&(this._result.w=this._w.evaluate(t)),this._result},t}(),Kz=dc("cc.animation.QuatTrack")(Nz=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.createCurve=function(){return new ed},n[Tz]=function(){return new Qz(this.channels()[0].curve)},e}(Iz))||Nz,Qz=function(){function t(t){this._result=new Ln,this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t,this._result),this._result},t}(),Zz=["Red","Green","Blue","Alpha"],Jz=dc("cc.animation.ColorTrack")((zz=function(t){function e(){var e;ct(e=t.call(this)||this,"_channels",Fz,ot(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new Pz(new _p);i.name=Zz[n],e._channels[n]=i}return e}$(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[Tz]=function(){return new $z(Oz(this._channels[0].curve),Oz(this._channels[1].curve),Oz(this._channels[2].curve),Oz(this._channels[3].curve))},e}(Rz),Fz=lt((Bz=zz).prototype,"_channels",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Lz=Bz))||Lz,$z=function(){function t(t,e,n,i){this._result=new An,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||An.copy(this._result,e.getValue()),this._x&&(this._result.r=this._x.evaluate(t)),this._y&&(this._result.g=this._y.evaluate(t)),this._z&&(this._result.b=this._z.evaluate(t)),this._w&&(this._result.a=this._w.evaluate(t)),this._result},t}(),tk=["Width","Height"],ek=dc("cc.animation.SizeTrack")((Hz=function(t){function e(){var e;ct(e=t.call(this)||this,"_channels",Gz,ot(e)),e._channels=new Array(2);for(var n=0;n<e._channels.length;++n){var i=new Pz(new _p);i.name=tk[n],e._channels[n]=i}return e}$(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[Tz]=function(){return new nk(Oz(this._channels[0].curve),Oz(this._channels[1].curve))},e}(Rz),Gz=lt((Uz=Hz).prototype,"_channels",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kz=Uz))||kz,nk=function(){function t(t,e){this._result=new ti,this._width=t,this._height=e}return t.prototype.evaluate=function(t,e){if((!this._width||!this._height)&&e.getValue){var n=e.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(t)),this._height&&(this._result.height=this._height.evaluate(t)),this._result},t}(),ik=dc("cc.animation.ObjectTrack")(Vz=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.prototype.createCurve=function(){return new md},e}(Iz))||Vz;t("animation",Object.freeze({__proto__:null,UniformProxyFactory:kF,MorphWeightValueProxy:UF,MorphWeightsValueProxy:GF,MorphWeightsAllValueProxy:HF,Track:Rz,TrackPath:Az,RealTrack:Dz,VectorTrack:jz,QuatTrack:Kz,ColorTrack:Jz,SizeTrack:ek,ObjectTrack:ik,isPropertyPath:dF,isCustomPath:function(t,e){return t instanceof e},HierarchyPath:FF,ComponentPath:zF,CubicSplineVec2Value:WF,CubicSplineVec3Value:jF,CubicSplineVec4Value:qF,CubicSplineQuatValue:XF,CubicSplineNumberValue:YF}));var rk=Symbol("BakeNodeCurves"),ok=t("SkelAnimDataHub",function(){function t(){}return t.getOrExtract=function(e){var n=t.pool.get(e);if(!n||n.samples!==e.sample){n&&u.director.root.dataPoolManager.releaseAnimationClip(e);var i=Math.ceil(e.sample*e.duration)+1,r=e.sample;n=e[rk](0,r,i),t.pool.set(e,n)}return n},t.destroy=function(e){t.pool.delete(e)},t}());ok.pool=new Map;var ak=t("RatioSampler",function(){function t(t){var e,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var i=!0,r=1,o=t.length;r<o;r++)if(e=t[r]-t[r-1],1===r)n=e;else if(Math.abs(e-n)>1e-6){i=!1;break}this._findRatio=i?uk:oc}return t.prototype.sample=function(t){return this._findRatio(this.ratios,t)},t}());u.RatioSampler=ak;var sk=t("AnimCurve",function(){function t(e,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=e.values;var i=function(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?t.Linear:t.Bezier(e):t.Linear};if(void 0!==e.easingMethod)this.type=i(e.easingMethod);else if(Array.isArray(e.easingMethods))this.types=e.easingMethods.map(i);else if(void 0!==e.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(e.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(e.easingMethods[a])}}else this.type=null;var s=e.values[0];(void 0===e.interpolate||e.interpolate)&&(this._lerp=yk(s)),void 0!==e._arrayLength&&(this._array=new Array(e._arrayLength))}t.Bezier=function(t){return t};var e=t.prototype;return e.hasLerp=function(){return!!this._lerp},e.valueAt=function(t){if(void 0===this._array){var e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*t+n];return this._array},e.valueBetween=function(t,e,n,i,r){if(this._lerp){var o=this.types?this.types[e]:this.type,a=r-n,s=(t-n)/a;if(o&&(s=lk(s,o)),void 0===this._array){var c=this._values[e],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*e+u],f=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,f,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(var p=0;p<this._array.length;++p)this._array[p]=this._values[this._array.length*e+p];return this._array},e.empty=function(){return 0===this._values.length},e.constant=function(){return 1===this._values.length},t}());function ck(t,e,n){var i=e.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=e.ratios.length))return t.valueBetween(n,i-1,e.ratios[i-1],i,e.ratios[i]);i=e.ratios.length-1}return t.valueAt(i)}function lk(t,e){if("string"==typeof e){var n=ep[e];n?t=n(t):O(3906,e)}else Array.isArray(e)&&(t=Zp(e,t));return t}function uk(t,e){var n=t.length-1;if(0===n)return 0;var i=t[0];if(e<i)return 0;var r=t[n];if(e>r)return n;var o=(e=(e-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}sk.Linear=null,u.AnimCurve=sk,t("EventInfo",function(){function t(){this.events=[]}return t.prototype.add=function(t,e){this.events.push({func:t||"",params:e||[]})},t}()),u.sampleAnimationCurve=ck;var hk,fk,pk,dk,_k,mk,vk,gk,yk=function(){function t(t,e,n,i){return t.lerp(e,n,i)}return function(e){if(null!==e){if("number"==typeof e)return ln;if("object"==typeof e&&e.constructor){if(e instanceof Ln)return n=new Ln,function(t,e,i){return Ln.slerp(n,t,e,i)};if(e instanceof le)return function(t){var e=new t;return function(n,i,r){return t.lerp(e,n,i,r),e}}(e.constructor);if(e.constructor===Number)return ln;if("function"==typeof e.lerp)return t}var n}}}(),xk=dc("cc.animation.UntypedTrackChannel")((dk=function(t){function e(){var e;return ct(e=t.call(this,new _p)||this,"property",pk,ot(e)),e}return $(e,t),e}(Pz),pk=lt((fk=dk).prototype,"property",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hk=fk))||hk,Sk=dc("cc.animation.UntypedTrack")((gk=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_channels",vk,ot(e)),e}$(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[Tz]=function(t){var e=this;if(!t.getValue)throw new Error(F(3930));var n=function(t){var n;return null===(n=e._channels.find((function(e){return e.property===t})))||void 0===n?void 0:n.curve},i=t.getValue();switch(!0){default:throw new Error(F(3931));case i instanceof Xn:return new qz(n("x"),n("y"));case i instanceof Rn:return new Xz(n("x"),n("y"),n("z"));case i instanceof Zn:return new Yz(n("x"),n("y"),n("z"),n("w"));case i instanceof An:return new $z(n("r"),n("g"),n("b"),n("a"));case i instanceof ti:return new nk(n("width"),n("height"))}},n.addChannel=function(t){var e=new xk;return e.property=t,this._channels.push(e),e},n.upgrade=function(t){var e=this,n=function(t,n){var i=e.channels().find((function(e){return e.property===t}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=t(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new jz;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new Jz,h=u.channels(),f=h[0],p=h[1],d=h[2],_=h[3];return n("r",f),n("g",p),n("b",d),n("a",_),n("x",f),n("y",p),n("z",d),n("w",_),u;case"size":}return null},e}(Rz),vk=lt((mk=gk).prototype,"_channels",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_k=mk))||_k,Tk=function(){function t(t){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}var e=t.prototype;return e.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},e.toTracks=function(){for(var t,e=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(t,e,n){for(var i,r=new Az,o=st(e);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof FF?r.toHierarchy(a.path):a instanceof zF?r.toComponent(a.component):r.toCustomized(a)}t.path=r,t.proxy=n},a=r.map((function(t){var n=new Sk;return o(n,t.modifiers,t.valueAdapter),e.push(n),n})),s=function(){var i,r=t.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var f=new bk(s,l.length),p=function(t){o(t,r.modifiers,r.valueAdapter)},d=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(t){return"number"==typeof t})))return M(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return M(3933),"continue";var _=r.modifiers[0],m=a[r.commonTarget].addChannel(_).curve;d=m}!function(){if("number"==typeof u){if(!c.every((function(t){return"number"==typeof t})))return void M(3934);var t;if(d)t=d;else{var n=new Dz;p(n),e.push(n),t=n.channel.curve}var i=h?nl.LINEAR:nl.CONSTANT;return t.assignSorted(l,c.map((function(t){return{value:t,interpolationMode:i}}))),void f.convert(t)}if("object"==typeof u)switch(!0){default:break;case Ek(c,Xn):case Ek(c,Rn):case Ek(c,Zn):var r=u instanceof Xn?2:u instanceof Rn?3:4,o=new jz;p(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,_=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?nl.LINEAR:nl.CONSTANT,y=function(t){return{value:t,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(t){return y(t.w)}))),f.convert(v);case 3:m.assignSorted(l,c.map((function(t){return y(t.z)}))),f.convert(m);default:s.assignSorted(l,c.map((function(t){return y(t.x)}))),f.convert(s),_.assignSorted(l,c.map((function(t){return y(t.y)}))),f.convert(_)}return void e.push(o);case Ek(c,Ln):var x=new Kz;p(x);var S=h?Wp.SLERP:Wp.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(t){return{value:Ln.clone(t),interpolationMode:S}}))),f.convertQuatCurve(x.channel.curve),void e.push(x);case Ek(c,An):var T=new Jz;p(T);var E=T.channels(),b=E[0].curve,C=E[1].curve,A=E[2].curve,w=E[3].curve,R=h?nl.LINEAR:nl.CONSTANT,P=function(t){return{value:t,interpolationMode:R}};return b.assignSorted(l,c.map((function(t){return P(t.r)}))),f.convert(b),C.assignSorted(l,c.map((function(t){return P(t.g)}))),f.convert(C),A.assignSorted(l,c.map((function(t){return P(t.b)}))),f.convert(A),w.assignSorted(l,c.map((function(t){return P(t.a)}))),f.convert(w),void e.push(T);case Ek(c,ti):var I=new ek;p(I);var D=I.channels(),O=D[0].curve,N=D[1].curve,L=h?nl.LINEAR:nl.CONSTANT,B=function(t){return{value:t,interpolationMode:L}};return O.assignSorted(l,c.map((function(t){return B(t.width)}))),f.convert(O),N.assignSorted(l,c.map((function(t){return B(t.height)}))),f.convert(N),void e.push(I);case Ek(c,YF):var F=new Dz;p(F);var z=h?nl.CUBIC:nl.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(t){return{value:t.dataPoint,leftTangent:t.inTangent,rightTangent:t.outTangent,interpolationMode:z}}))),void e.push(F);case Ek(c,WF):case Ek(c,jF):case Ek(c,qF):var k=u instanceof WF?2:u instanceof jF?3:4,U=new jz;p(U),U.componentsCount=k;var G=U.channels(),H=G[0],V=G[1],W=G[2],j=G[3],q=h?nl.LINEAR:nl.CONSTANT,X=function(t,e,n){return{value:t,leftTangent:e,rightTangent:n,interpolationMode:q}};switch(k){case 4:j.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.w,t.inTangent.w,t.outTangent.w)})));case 3:W.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.z,t.inTangent.z,t.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.y,t.inTangent.y,t.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.x,t.inTangent.x,t.outTangent.x)})))}return void e.push(U);case c.every((function(t){return t instanceof XF})):M(3935)}var Y=new ik;p(Y),Y.channel.curve.assignSorted(l,c),e.push(Y)}()},c=st(i);!(t=c()).done;)s();return e},e._createPropertyCurves=function(){var t=this;this._ratioSamplers=this._keys.map((function(e){return new ak(e.map((function(e){return e/t._duration})))})),this._runtimeCurves=this._curves.map((function(e){return{curve:new sk(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys],commonTarget:e.commonTarget}}))},Z(t,[{key:"keys",get:function(){return this._keys},set:function(t){this._keys=t}},{key:"curves",get:function(){return this._curves},set:function(t){this._curves=t,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(t){this._commonTargets=t}},{key:"data",get:function(){return this._data}}]),t}();function Ek(t,e){return t.every((function(t){return t instanceof e}))}var bk=function(){function t(t,e){this._easingMethods=void 0;var n=t.easingMethods;Array.isArray(n)?0===n.length&&0!==e?this._easingMethods=new Array(e).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(e).fill(t.easingMethod):Array.from({length:e},(function(t,e){var i;return null!==(i=n[e])&&void 0!==i?i:null}))}var e=t.prototype;return e.convert=function(t){var e,n,i,r,o,a,s,c,l,u,h,f,p,d,_,m,v,g,y,x,S,T,E=this._easingMethods;if(E){var b=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(E)&&E.length;for(var C=b-1,A=0;A<C;++A){var w=E[A];w&&(Array.isArray(w)?(e=w,n=t.getKeyframeTime(A),i=t.getKeyframeValue(A),r=t.getKeyframeTime(A+1),o=t.getKeyframeValue(A+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,f=void 0,p=void 0,d=void 0,_=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,T=void 0,s=e[0],c=e[1],l=e[2],u=e[3],h=i.value,f=3*(r-n),p=3*(o.value-h),m=(1-l)*f,v=(1-u)*p,g=1/3,y=(_=c*p)/(d=s*f),x=Math.sqrt(d*d+_*_)*g,S=v/m,T=Math.sqrt(m*m+v*v)*g,i.interpolationMode=nl.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===rl.NONE?rl.RIGHT:a===rl.LEFT?rl.BOTH:a,i.rightTangent=y,i.rightTangentWeight=x,o.tangentWeightMode=function(t){return t===rl.NONE?rl.LEFT:t===rl.RIGHT?rl.BOTH:t}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=T):Ck(w,t,A))}}}},e.convertQuatCurve=function(t){var e=this._easingMethods;if(e){var n=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(e)&&e.length;for(var i=n-1,r=0;r<i;++r){var o=e[r];o&&(Array.isArray(o)?t.getKeyframeValue(r).easingMethod=o.slice():Ak(o,t,r))}}}},Z(t,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(t){return null==t}))}}]),t}();function Ck(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=nU[t];r===tp.CONSTANT?i.interpolationMode=nl.CONSTANT:(i.interpolationMode=nl.LINEAR,i.easingMethod=r)}function Ak(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=nU[t];i.easingMethod=r}var wk,Rk,Pk,Ik,Mk,Dk,Ok,Nk,Lk,Bk,Fk,zk,kk,Uk,Gk,Hk,Vk,Wk,jk,qk,Xk,Yk,Kk,Qk,Zk,Jk,$k,tU,eU,nU={constant:tp.CONSTANT,linear:tp.LINEAR,quadIn:tp.QUAD_IN,quadOut:tp.QUAD_OUT,quadInOut:tp.QUAD_IN_OUT,quadOutIn:tp.QUAD_OUT_IN,cubicIn:tp.CUBIC_IN,cubicOut:tp.CUBIC_OUT,cubicInOut:tp.CUBIC_IN_OUT,cubicOutIn:tp.CUBIC_OUT_IN,quartIn:tp.QUART_IN,quartOut:tp.QUART_OUT,quartInOut:tp.QUART_IN_OUT,quartOutIn:tp.QUART_OUT_IN,quintIn:tp.QUINT_IN,quintOut:tp.QUINT_OUT,quintInOut:tp.QUINT_IN_OUT,quintOutIn:tp.QUINT_OUT_IN,sineIn:tp.SINE_IN,sineOut:tp.SINE_OUT,sineInOut:tp.SINE_IN_OUT,sineOutIn:tp.SINE_OUT_IN,expoIn:tp.EXPO_IN,expoOut:tp.EXPO_OUT,expoInOut:tp.EXPO_IN_OUT,expoOutIn:tp.EXPO_OUT_IN,circIn:tp.CIRC_IN,circOut:tp.CIRC_OUT,circInOut:tp.CIRC_IN_OUT,circOutIn:tp.CIRC_OUT_IN,elasticIn:tp.ELASTIC_IN,elasticOut:tp.ELASTIC_OUT,elasticInOut:tp.ELASTIC_IN_OUT,elasticOutIn:tp.ELASTIC_OUT_IN,backIn:tp.BACK_IN,backOut:tp.BACK_OUT,backInOut:tp.BACK_IN_OUT,backOutIn:tp.BACK_OUT_IN,bounceIn:tp.BOUNCE_IN,bounceOut:tp.BOUNCE_OUT,bounceInOut:tp.BOUNCE_IN_OUT,bounceOutIn:tp.BOUNCE_OUT_IN,smooth:tp.SMOOTH,fade:tp.FADE};function iU(){throw new Error("split() only valid in Editor.")}dc("cc.animation.ExoticAnimation")((Pk=function(){function t(){ct(this,"_nodeAnimations",Rk,this)}var e=t.prototype;return e.createEvaluator=function(t){return new pU(this._nodeAnimations,t)},e.addNodeAnimation=function(t){var e=new rU(t);return this._nodeAnimations.push(e),e},e.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(t){return t.path}))))},e.split=function(){return iU()},e.toHashString=function(){return this._nodeAnimations.map((function(t){return t.toHashString()})).join("\n")},t}(),Rk=lt((wk=Pk).prototype,"_nodeAnimations",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wk));var rU=dc("cc.animation.ExoticNodeAnimation")((Bk=function(){function t(t){ct(this,"_path",Dk,this),ct(this,"_position",Ok,this),ct(this,"_rotation",Nk,this),ct(this,"_scale",Lk,this),this._path=t}var e=t.prototype;return e.createPosition=function(t,e){this._position=new uU(t,new cU(e))},e.createRotation=function(t,e){this._rotation=new uU(t,new lU(e))},e.createScale=function(t,e){this._scale=new uU(t,new cU(e))},e.createEvaluator=function(t){return new dU(this._path,this._position,this._rotation,this._scale,t)},e.split=function(){return iU()},e.toHashString=function(){var t,e,n,i,r,o;return this._path+"\n"+(null!==(t=null===(e=this._position)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},Z(t,[{key:"path",get:function(){return this._path}}]),t}(),Dk=lt((Mk=Bk).prototype,"_path",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ok=lt(Mk.prototype,"_position",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nk=lt(Mk.prototype,"_rotation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lk=lt(Mk.prototype,"_scale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ik=Mk))||Ik;function oU(t){return t.toPrecision(2)}function aU(t){return t.map(oU).join(" ")}var sU=dc("cc.animation.ExoticVectorLikeTrackValues")((Gk=function(){function t(t){ct(this,"_values",kk,this),ct(this,"_isQuantized",Uk,this),this._values=t,this._isQuantized=!1}var e=t.prototype;return e.quantize=function(t){this._isQuantized,this._values=function(t,e){var n=mU[e],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;t.forEach((function(t){r=Math.min(t,r),o=Math.max(t,o)}));var a=o-r,s=n.from(t,(function(t){return(t-r)/a*i}));return new MU(vU(t),s,a,r)}(this._values,t),this._isQuantized=!0},e.toHashString=function(){var t=this._isQuantized,e=this._values;return t+" "+(t?e.toHashString():aU(e))},Z(t,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:vU(this._values)}}]),t}(),kk=lt((zk=Gk).prototype,"_values",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Uk=lt(zk.prototype,"_isQuantized",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Fk=zk))||Fk,cU=dc("cc.animation.ExoticVec3TrackValues")(Hk=function(t){function e(){return t.apply(this,arguments)||this}$(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?NU(n,t,e):Rn.fromArray(e,n,3*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(NU(a,t,i),NU(a,e,r)):(Rn.fromArray(i,a,3*t),Rn.fromArray(r,a,3*e)),Rn.lerp(o,i,r,n)},e}(sU))||Hk,lU=dc("cc.animation.ExoticQuatTrackValues")(Vk=function(t){function e(){return t.apply(this,arguments)||this}$(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?LU(n,t,e):Ln.fromArray(e,n,4*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(LU(a,t,i),LU(a,e,r)):(Ln.fromArray(i,a,4*t),Ln.fromArray(r,a,4*e)),Ln.slerp(o,i,r,n)},e}(sU))||Vk,uU=dc("cc.animation.ExoticTrack")((Yk=function(){function t(t,e){ct(this,"times",qk,this),ct(this,"values",Xk,this),this.times=t,this.values=e}return t.prototype.toHashString=function(){var t=this.times,e=this.values;return"times: "+aU(t)+"; values: "+e.toHashString()},t}(),qk=lt((jk=Yk).prototype,"times",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Xk=lt(jk.prototype,"values",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Wk=jk))||Wk;function hU(t,e){t.length,t.length;var n=0,i=0,r=oc(t,e);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=t[o],c=t[a];i=(e-c)/(s-c)}return{index:n,ratio:i}}!function(){function t(){this._reset()}var e=t.prototype;e.transformTime=function(t){return t-this._timeOffset},e.calculate=function(t,e,n){this._reset();var i=t.length;if(i){var r=t[0],o=t[i-1],a=sn(e,r,o),s=sn(n,r,o);this._timeOffset=a;var c=function(t,e,n){var i=t.length;n>=e&&e>=t[0]&&t[i-1];var r=hU(t,e),o=r.index,a=r.ratio,s=hU(t,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(t,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,f=c.toRatio,p=!u,d=!f;l!==h||u!==f?(p||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=p?l:l+1,this.directKeyframesEnd=h+1,d||(this.postLerpIndex=h,this.postLerpRatio=f)):p?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},e._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},Z(t,[{key:"keyframesCount",get:function(){var t=this.preLerpIndex,e=this.directKeyframesBegin;return 0+(t<0?0:1)+(this.directKeyframesEnd-e)+(this.postLerpIndex<0?0:1)}}])}();var fU,pU=function(){function t(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((function(t){return t.createEvaluator(e)}))}return t.prototype.evaluate=function(t){this._nodeEvaluations.forEach((function(e){e.evaluate(t)}))},t}(),dU=function(){function t(t,e,n,i,r){this._position=null,this._rotation=null,this._scale=null,e&&(this._position=OU(e.times,e.values,Rn,t,"position",r)),n&&(this._rotation=OU(n.times,n.values,Ln,t,"rotation",r)),i&&(this._scale=OU(i.times,i.values,Rn,t,"scale",r))}return t.prototype.evaluate=function(t){if(this._position){var e=this._position.evaluator.evaluate(t);this._position.runtimeBinding.setValue(e)}if(this._rotation){var n=this._rotation.evaluator.evaluate(t);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(t);this._scale.runtimeBinding.setValue(i)}},t}(),_U=function(){function t(t,e,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=e,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return t.prototype.evaluate=function(t){var e=this._times,n=this._values,i=this._resultValue;if(0===e.length)return i;var r=function(t,e,n){var i=t.length,r=t[0],o=t[i-1];if(e<r)n.just=!0,n.index=0;else if(e>o)n.just=!0,n.index=i-1;else{var a=oc(t,e);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=t[c],u=t[s],h=(e-t[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(e,t,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},t}(),mU={uint8:Uint8Array,uint16:Uint16Array};function vU(t){switch(t.BYTES_PER_ELEMENT){default:case 4:return fU.FLOAT_32;case 8:return fU.FLOAT_64}}!function(t){t[t.FLOAT_32=0]="FLOAT_32",t[t.FLOAT_64=1]="FLOAT_64"}(fU||(fU={}));var gU,yU,xU,SU,TU,EU,bU,CU,AU,wU,RU,PU,IU,MU=dc("cc.animation.QuantizedFloatArray")((eU=function(){function t(t,e,n,i){void 0===i&&(i=0),ct(this,"originalPrecision",Zk,this),ct(this,"min",Jk,this),ct(this,"extent",$k,this),ct(this,"values",tU,this),this.originalPrecision=t,this.values=e,this.extent=n,this.min=i}return t.prototype.toHashString=function(){var t=this.originalPrecision,e=this.min,n=this.extent,i=this.values;return t+" "+oU(e)+" "+oU(n)+" "+i.join(" ")},Z(t,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),t}(),Zk=lt((Qk=eU).prototype,"originalPrecision",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Jk=lt(Qk.prototype,"min",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$k=lt(Qk.prototype,"extent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),tU=lt(Qk.prototype,"values",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Kk=Qk))||Kk;function DU(t,e){return t.values[e]/(1<<t.values.BYTES_PER_ELEMENT)*t.extent+t.min}function OU(t,e,n,i,r,o){var a=new wz;a.path=(new Az).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new _U(t,e,n)}:null}function NU(t,e,n){Rn.set(n,DU(t,3*e+0),DU(t,3*e+1),DU(t,3*e+2))}function LU(t,e,n){Ln.set(n,DU(t,4*e+0),DU(t,4*e+1),DU(t,4*e+2),DU(t,4*e+3))}var BU=Symbol("SearchForRootBonePath"),FU=Symbol("ExoticAnimation"),zU=t("AnimationClip",dc("cc.AnimationClip")((IU=PU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"sample",xU,ot(e)),ct(e,"speed",SU,ot(e)),ct(e,"wrapMode",TU,ot(e)),ct(e,"enableTrsBlending",EU,ot(e)),ct(e,"_duration",bU,ot(e)),ct(e,"_hash",CU,ot(e)),e.frameRate=0,ct(e,"_tracks",AU,ot(e)),ct(e,"_exoticAnimation",wU,ot(e)),e._legacyData=void 0,e._legacyDataDirty=!1,ct(e,"_events",RU,ot(e)),e._runtimeEvents={ratios:[],eventGroups:[]},e}$(e,t),e.createWithSpriteFrames=function(t,n){var i=new e;i.sample=n||i.sample,i.duration=t.length/i.sample;var r=1/i.sample,o=new ik;return o.path=(new Az).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(t.map((function(t,e){return[r*e,t]}))),i.addTrack(o),i};var n=e.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var t={min:1/0,max:-1/0},e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i].range();t.min=Math.min(t.min,r.min),t.max=Math.max(t.max,r.max)}return t},n.getTrack=function(t){return this._tracks[t]},n.addTrack=function(t){var e=this._tracks.length;return this._tracks.push(t),e},n.removeTrack=function(t){this._tracks.splice(t,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(t){return new qU(t,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(t){var e=this,n=t.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,e.enableTrsBlending?t.pose:void 0,!1);return null!=r?r:void 0}),t.rootMotion)},n.destroy=function(){var e;return(null===(e=u.director.root)||void 0===e?void 0:e.dataPoolManager)&&u.director.root.dataPoolManager.releaseAnimationClip(this),ok.destroy(this),t.prototype.destroy.call(this)},n[rk]=function(t,e,n){for(var i=1/e,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new Vn}))};var c=r.reduce((function(t,e){return t[e]=new GU,t}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var f=l.substring(0,h),p=c[f];p&&(u.parent=p)}}for(var d=this._createEvalWithBinder(void 0,(function(t){var e=t.parseTrsPath();if(e){var n=c[e.node];if(n)return jU(n,e.property)}}),void 0),_=0;_<n;++_){var m=t+i*_;d.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Vn.copy(a[g].transforms[_],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:e,frames:n,joints:a}},n.upgradeUntypedTracks=function(t){for(var e=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof Sk){var s=a.upgrade(t);s&&(e.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)ne.remove(i,n[l]);i.push.apply(i,e)},n[BU]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(t,e,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(t,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(t){return 0===t.curve.keyFramesCount}))){var h=e(u[Cz]);if(h){var f=u[Tz](h);a.push({binding:h,trackEval:f})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(e)),new kU(a,o,i)},n._createRootMotionEvaluation=function(t,e,n){if(t instanceof WC){var i=this._searchForRootBonePath();if(i){var r=t.getChildByPath(i);if(r){for(var o=new UU,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[Cz].parseTrsPath();if(h&&h.node===i){n.push(u);var f=jU(o,h.property);if(f){var p=u[Tz](f);a.push({binding:f,trackEval:p})}}}return new VU(r,this._duration,o,a)}M(3924)}else M(3923)}else O(3920)},n._searchForRootBonePath=function(){var t=this._tracks.map((function(t){var e=t[Cz].parseTrsPath();if(e){var n=e.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));t.sort((function(t,e){return t.rank-e.rank}));var e=t.findIndex((function(t){return 0!==t.rank}));if(e<0)return"";for(var n=t.length,i=t[e],r=!0,o=e+1;o<n;++o){var a=t[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var t=new Tk(this._duration);return t.keys=[],t.curves=[],t.commonTargets=[],t},n._fromLegacy=function(t){for(var e=t.toTracks(),n=e.length,i=0;i<n;++i)this.addTrack(e[i])},n._collectAnimatedJoints=function(){for(var t=new Set,e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i][Cz].parseTrsPath();r&&t.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)t.add(o[s]);return Array.from(t)},Z(e,[{key:"duration",get:function(){return this._duration},set:function(t){this._duration=t}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var t,e;if(this._hash)return this._hash;var n="Exotic:"+(null!==(t=null===(e=this._exoticAnimation)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"");return this._hash=go(n,666)}},{key:"events",get:function(){return this._events},set:function(t){var e=this;this._events=t;for(var n=[],i=[],r=this.events.sort((function(t,e){return t.frame-e.frame})),o=r.length,a=function(t){var o=r[t],a=o.frame/e._duration,s=n.findIndex((function(t){return t===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:FU,get:function(){return this._exoticAnimation}},{key:FU,set:function(t){this._exoticAnimation=t}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().keys=t}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(t){this._getLegacyData().curves=t}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=t}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),e}(Du),PU.WrapMode=$s,xU=lt((yU=IU).prototype,"sample",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),SU=lt(yU.prototype,"speed",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),TU=lt(yU.prototype,"wrapMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $s.Normal}}),EU=lt(yU.prototype,"enableTrsBlending",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bU=lt(yU.prototype,"_duration",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CU=lt(yU.prototype,"_hash",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AU=lt(yU.prototype,"_tracks",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wU=lt(yU.prototype,"_exoticAnimation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RU=lt(yU.prototype,"_events",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gU=yU))||gU);u.AnimationClip=zU;var kU=function(){function t(t,e,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=e,this._rootMotionEvaluation=n}var e=t.prototype;return e.evaluate=function(t){for(var e=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=e.length,r=0;r<i;++r){var o=e[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}n&&n.evaluate(t)},e.evaluateRootMotion=function(t,e){var n=this._rootMotionEvaluation;n&&n.evaluate(t,e)},t}(),UU=function(){function t(){this.position=new Rn,this.scale=new Rn(1,1,1),this.rotation=new Ln,this.eulerAngles=new Rn}return t.prototype.getTransform=function(t){Vn.fromRTS(t,this.rotation,this.position,this.scale)},t}(),GU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).parent=null,e._dirty=!0,e._transform=new Vn,e}return $(e,t),e.prototype.invalidate=function(){this._dirty=!0},Z(e,[{key:"globalTransform",get:function(){var t=this._transform;return this._dirty&&(this._dirty=!1,Vn.fromRTS(t,this.rotation,this.position,this.scale),this.parent&&Vn.multiply(t,this.parent.globalTransform,t)),this._transform}}]),e}(UU),HU=new Vn,VU=function(){function t(t,e,n,i){this._initialTransformCache=new Vn,this._clipEndTransformCache=new Vn,this._startTransformCache=new Vn,this._endTransformCache=new Vn,this._motionTransformCache=new Vn,this._translationMotionCache=new Rn,this._rotationMotionCache=new Ln,this._scaleMotionCache=new Rn,this._rootBone=t,this._duration=e,this._boneTransform=n,this._trackEvalStatuses=i}var e=t.prototype;return e.evaluate=function(t,e){var n=this._calcMotionTransform(t,e,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Vn.toRTS(n,r,i,o),Rn.add(i,i,a.position),a.setPosition(i),Ln.multiply(r,r,a.rotation),a.setRotation(r),Rn.multiply(o,o,a.scale),a.setScale(o)},e._calcMotionTransform=function(t,e,n){var i=this._duration,r=i-t,o=this._evaluateAt(t,this._startTransformCache);if(e<r){var a=this._evaluateAt(t+e,this._endTransformCache);WU(n,o,a)}else{Vn.identity(n);var s=function(t,e){WU(HU,t,e),Vn.multiply(n,n,HU)},c=e-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),f=this._evaluateAt(i,this._clipEndTransformCache),p=this._evaluateAt(u,this._endTransformCache);s(o,f),WU(HU,h,f);for(var d=0;d<l;++d)Vn.multiply(n,n,HU);s(h,p)}return n},e._evaluateAt=function(t,e){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}return this._boneTransform.getTransform(e),e},t}();function WU(t,e,n){Vn.invert(t,e),Vn.multiply(t,n,t)}function jU(t,e){switch(e){default:return;case"position":return{setValue:function(e){Rn.copy(t.position,e)}};case"rotation":return{setValue:function(e){Ln.copy(t.rotation,e)}};case"scale":return{setValue:function(e){Rn.copy(t.scale,e)}};case"eulerAngles":return{setValue:function(e){Rn.copy(t.eulerAngles,e)}}}}var qU=function(){function t(t,e,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=e,this._eventGroups=n,this._wrapMode=i}var e=t.prototype;return e.setWrapMode=function(t){this._wrapMode=t},e.ignore=function(t,e){this._ignoreIndex=-1,this._sampled=!1;var n=YU(t,this._ratios);n<0&&(n=~n-1,e<0&&(n+=1),this._ignoreIndex=n)},e.sample=function(t,e,n){var i=this._eventGroups.length,r=YU(t,this._ratios);if(r<0&&(r=~r-1,e<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=e);var o=this._wrapMode,a=XU(n),s=XU(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){e=l;do{if(c!==r){if(-1===e&&0===c&&r>0?((o&Js.PingPong)===Js.PingPong?e*=-1:c=i,s++):1===e&&c===i-1&&r<i-1&&((o&Js.PingPong)===Js.PingPong?e*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=e,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=e},e._doFire=function(t,e){e?u.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[t]):this._checkAndFire(t)},e._checkAndFire=function(t){if(this._targetNode&&this._targetNode.isValid){var e=this._eventGroups;if(!(t<0||t>=e.length||this._ignoreIndex===t))for(var n=e[t],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},t}();function XU(t){return t-(0|t)==0&&(t-=1),0|t}function YU(t,e){return oc(e,t)}var KU,QU=function(){function t(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var e=t.prototype;return e.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(F(3912)):(this._isPlaying=!0,this.onPlay())},e.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},e.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},e.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},e.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},e.update=function(){},e.onPlay=function(){},e.onPause=function(){},e.onResume=function(){},e.onStop=function(){},e.onError=function(){},Z(t,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),t}(),ZU=function(){function t(t){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this._blendStateWriters.length;++t)this._pose.destroyWriter(this._blendStateWriters[t]);this._blendStateWriters.length=0},e.createPoseWriter=function(t,e,n){var i=this._pose.createWriter(t,e,this,n);return this._blendStateWriters.push(i),i},t}();!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(KU||(KU={})),ce(KU);var JU=t("AnimationState",function(t){function e(e,n){var i;return void 0===n&&(n=""),(i=t.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=$s.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new rc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=e,i._name=n||e&&e.name,i._playbackRange={min:0,max:e.duration},i._playbackDuration=e.duration,e.duration||b("Clip "+e.name+" has zero duration."),i}$(e,t);var n=e.prototype;return n.initialize=function(t,e){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=t;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Js.Loop)===Js.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var i,r,o,a=null!==(i=null!=e?e:null===(r=u.director.getAnimationManager())||void 0===r?void 0:r.blendState)&&void 0!==i?i:null;a&&(this._poseOutput=new ZU(a)),this._clipEval=n.createEvaluator({target:t,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||u.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];u.director.getAnimationManager().pushDelayEvent(this._emit,this,e)},n.on=function(t,e,n){return this._target&&this._target.isValid?this._target.on(t,e,n):null},n.once=function(t,e,n){return this._target&&this._target.isValid?this._target.once(t,e,n):null},n.off=function(t,e,n){this._target&&this._target.isValid&&this._target.off(t,e,n)},n.allowLastFrameEvent=function(t){this._allowLastFrame=t},n._setEventTarget=function(t){this._target=t},n.setTime=function(t){this._currentFramePlayed=!1,this.time=t||0;var e,n=this.getWrappedInfo(t,this._wrappedInfo);null===(e=this._clipEventEval)||void 0===e||e.ignore(n.ratio,n.direction)},n.update=function(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.time),this._sampleEvents(t),t},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(KU.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(KU.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(KU.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(KU.PAUSE,this)},n._sampleCurves=function(t){var e=this._poseOutput,n=this._clipEval;e&&(e.weight=this.weight),n&&n.evaluate(t)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var t,e=this.sample();this._allowLastFrame&&(t=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new rc(e),this.repeatCount>1&&(0|e.iterations)>(0|t.iterations)&&this.emit(KU.LASTFRAME,this),t.set(e)),e.stopped&&(this.stop(),this.emit(KU.FINISHED,this))},n.simpleProcess=function(){var t=this._playbackRange.min,e=this._playbackDuration,n=this.time%e;n<0&&(n+=e);var i=(t+n)*this._invDuration;this._sampleCurves(t+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(KU.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(t){var e=this.wrapMode,n=!1;return(e&Js.PingPong)===Js.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(n=!n)),(e&Js.Reverse)===Js.Reverse&&(n=!n),n},n.getWrappedInfo=function(t,e){e=e||new rc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(t-=n)>0?t/i:-t/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),t=s*i*(t>0?1:-1)}if(t>i){var c=t%i;t=0===c?i:c}else t<0&&0!=(t%=i)&&(t+=i);var l=!1,u=this._wrapMode&Js.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(t=i-t),e.time=n+t,e.ratio=e.time/this.duration,e.direction=h,e.stopped=r,e.iterations=a,e},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(t){var e;null===(e=this._clipEventEval)||void 0===e||e.sample(t.ratio,t.direction,t.iterations)},n._emit=function(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)},n._onReplayOrResume=function(){u.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){u.director.getAnimationManager().removeAnimation(this)},Z(e,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(t){var e;this._wrapMode=t,this.time=0,t&Js.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(e=this._clipEventEval)||void 0===e||e.setWrapMode(t)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t;var e=this._wrapMode&Js.ShouldWrap,n=(this.wrapMode&Js.Reverse)===Js.Reverse;this._useSimpleProcess=t===1/0&&!e&&!n}},{key:"delay",get:function(){return this._delay},set:function(t){this._delayTime=this._delay=t}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(t){this._weight=t,this._poseOutput&&(this._poseOutput.weight=t)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),e}(QU));u.AnimationState=JU;var $U,tG,eG,nG,iG,rG,oG,aG,sG,cG,lG,uG,hG,fG,pG,dG,_G,mG=function(t){function e(e){var n;return(n=t.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=e?e:u.director.getAnimationManager(),n}$(e,t);var n=e.prototype;return n.update=function(t){if(!this.isMotionless){var e=this._managedStates,n=this._fadings;if(1===e.length&&1===n.length){var i=e[0].state;i&&(i.weight=1)}else this._calculateWeights(t);1===e.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(t,e){var n;0===this._managedStates.length&&(e=0),0===e&&this.clear();var i=this._managedStates.find((function(e){return e.state===t}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var t=0;t<this._managedStates.length;++t){var e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){t.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){t.prototype.onPause.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){t.prototype.onResume.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){t.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(t){for(var e=this._managedStates,n=this._fadings,i=0;i<e.length;++i){var r=e[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=t;var l=0===c.easeDuration?1:cn(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var f=n[h];--f.target.reference,f.target.reference<=0&&(f.target.state&&f.target.state.stop(),pt(this._managedStates,f.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},e}(QU),vG=function(e){return t({AnimationComponent:e,Animation:e}),e}(($U=dc("cc.Animation"),tG=Ic(),eG=mc(99),nG=Ac(),iG=Kc([zU]),rG=Lc(),oG=Kc(zU),aG=Lc(),sG=Lc(),cG=Kc([zU]),$U(lG=tG(lG=eG(lG=Cc(lG=nG((_G=dG=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"playOnLoad",hG,ot(e)),e._crossFade=new mG,e._nameToState=Rt(!0),ct(e,"_clips",fG,ot(e)),ct(e,"_defaultClip",pG,ot(e)),e._hasBeenPlayed=!1,e}$(e,t);var n=e.prototype;return n.onLoad=function(){for(var t in this.clips=this._clips,this._nameToState)this._nameToState[t].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var t in this._crossFade.stop(),this._nameToState)this._nameToState[t].destroy();this._nameToState=Rt(!0)},n.play=function(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)},n.crossFade=function(t,e){void 0===e&&(e=.3),this._hasBeenPlayed=!0;var n=this._nameToState[t];n&&this.doPlayOrCrossFade(n,e)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(t){return this.getState(t)},n.getState=function(t){var e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null},n.createState=function(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)},n.removeState=function(t){var e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])},n.addClip=function(t,e){return dt(this._clips,t)||this._clips.push(t),this.createState(t,e)},n.removeClip=function(t,e){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===t){n=r;break}}if(t===this._defaultClip){if(!e)return void M(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!e)return void M(3903);n.stop()}this._clips=this._clips.filter((function(e){return e!==t})),n&&delete this._nameToState[n.name]},n.on=function(e,n,i,r){var o=t.prototype.on.call(this,e,n,i,r);return e===KU.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(e,n,i){var r=t.prototype.once.call(this,e,n,i);return e===KU.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i),e===KU.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(t,e){return new JU(t,e)},n._doCreateState=function(t,e){var n=this._createState(t,e);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(KU.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(t,e){this._crossFade.play(),this._crossFade.crossFade(t,e)},n._removeStateOfAutomaticClip=function(t){for(var e in this._nameToState){var n=this._nameToState[e];gG(t,n.clip)&&(n.stop(),delete this._nameToState[e])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(KU.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(KU.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)},Z(e,[{key:"clips",get:function(){return this._clips},set:function(t){var e=this;this._crossFade&&this._crossFade.clear();for(var n,i=st(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=st(t);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=t.find((function(t){return gG(t,e._defaultClip)}));this._defaultClip=c||null,this._clips=t}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){this._defaultClip=t,t&&(this._clips.findIndex((function(e){return gG(e,t)}))>=0||(this._clips.push(t),this.createState(t)))}}]),e}(tu($u)),dG.EventType=KU,lt((uG=_G).prototype,"clips",[iG,rG],Object.getOwnPropertyDescriptor(uG.prototype,"clips"),uG.prototype),lt(uG.prototype,"defaultClip",[oG,aG],Object.getOwnPropertyDescriptor(uG.prototype,"defaultClip"),uG.prototype),hG=lt(uG.prototype,"playOnLoad",[xc,sG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fG=lt(uG.prototype,"_clips",[cG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pG=lt(uG.prototype,"_defaultClip",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lG=uG))||lG)||lG)||lG)||lG)||lG));function gG(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}u.Animation=vG,U(vG.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var t=arguments.length<=0?void 0:arguments[0];return vG.prototype.removeState.call(this,t.name)}}]),u.AnimationComponent=vG,ie.setClassAlias(vG,"cc.AnimationComponent");var yG,xG,SG,TG=function(){function t(){this._nodeBlendStates=new Map}var e=t.prototype;return e.createWriter=function(t,e,n,i){var r=this.ref(t,e);return new EG(t,e,r,n,i)},e.destroyWriter=function(t){var e=t;this.deRef(e.node,e.property)},e.ref=function(t,e){var n=this._nodeBlendStates.get(t);return n||(n=new wG,this._nodeBlendStates.set(t,n)),n.refProperty(e)},e.deRef=function(t,e){var n=this._nodeBlendStates.get(t);n&&(n.deRefProperty(e),n.empty&&this._nodeBlendStates.delete(t))},e.apply=function(){this._nodeBlendStates.forEach((function(t,e){t.apply(e)}))},t}(),EG=function(){function t(t,e,n,i,r){this._node=t,this._property=e,this._propertyBlendState=n,this._host=i,this._constants=r}var e=t.prototype;return e.getValue=function(){return this._node[this._property]},e.setValue=function(t){var e=this._propertyBlendState,n=this._host.weight;e.blend(t,n)},Z(t,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),t}(),bG=function(t){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=t},CG=function(t){function e(){return t.call(this,new Rn)||this}$(e,t);var n=e.prototype;return n.blend=function(t,e){var n=this.blendedValue;1===e?Rn.copy(n,t):Rn.scaleAndAdd(n,n,t,e),this.blendedWeight+=e},n.reset=function(){this.blendedWeight=0,Rn.zero(this.blendedValue)},e}(bG),AG=function(t){function e(){return t.call(this,new Ln)||this}$(e,t);var n=e.prototype;return n.blend=function(t,e){if(0!==e){var n=this.blendedValue,i=this.blendedWeight;if(1===e)Ln.copy(n,t);else{var r=e/(i+e);Ln.slerp(n,n,t,r)}this.blendedWeight+=e}},n.reset=function(){this.blendedWeight=0,Ln.identity(this.blendedValue)},e}(bG),wG=function(){function t(){this._properties={}}var e=t.prototype;return e.refProperty=function(t){var e,n,i,r=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":i=null!==(e=r[t])&&void 0!==e?e:r[t]=new CG;break;case"rotation":i=null!==(n=r[t])&&void 0!==n?n:r[t]=new AG}return++i.refCount,i},e.deRefProperty=function(t){var e=this._properties,n=e[t];n&&(--n.refCount,n.refCount>0||delete e[t])},e.apply=function(t){var e,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,f=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(t.position,1-o.blendedWeight),e=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(t.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(f=!0,c.blendedWeight<1&&c.blend(t.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(t.rotation,1-s.blendedWeight),i=s.blendedValue),(i||e||n)&&t.setRTS(i,e,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),f&&c.reset()},Z(t,[{key:"empty",get:function(){var t=this._properties;return!(t.position||t.rotation||t.eulerAngles||t.scale)}}]),t}(),RG=[],PG=new Map;function IG(t,e){for(var n=0,i=Vn.IDENTITY;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){i=t.world,t.stamp=e;break}t.stamp=e,RG[n++]=t,t=t.parent}for(;n>0;){t=RG[--n],RG[n]=null;var r=t.node;Vn.fromRTS(t.local,r.rotation,r.position,r.scale),i=Vn.multiply(t.world,i,t.local)}return i}function MG(t,e){for(var n,i=null,r=0;t!==e;){var o=t.uuid;if(PG.has(o)){i=PG.get(o);break}i={node:t,local:new Vn,world:new Vn,stamp:-1,parent:null},PG.set(o,i),RG[r++]=i,t=t.parent,i=null}for(;r>0;)n=RG[--r],RG[r]=null,n.parent=i,i=n;return i}function DG(t){for(var e=PG.get(t.uuid)||null;e;)PG.delete(e.node.uuid),e=e.parent}var OG=t("AnimationManager",dc((SG=xG=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._anims=new ut([]),e._crossFades=new ut([]),e._delayEvents=[],e._blendStateBuffer=new TG,e._sockets=[],e}$(e,t);var n=e.prototype;return n.addCrossFade=function(t){-1===this._crossFades.array.indexOf(t)&&this._crossFades.push(t)},n.removeCrossFade=function(t){var e=this._crossFades.array.indexOf(t);e>=0?this._crossFades.fastRemoveAt(e):O(3907)},n.update=function(t){var e=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(t);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(t)}this._blendStateBuffer.apply();for(var c=u.director.getTotalFrames(),l=0,h=i.length;l<h;l++){var f=i[l],p=f.target,d=f.transform;p.matrix=IG(d,c)}for(var _=0,m=e.length;_<m;_++){var v=e[_];v.fn.apply(v.thisArg,v.args)}e.length=0},n.destruct=function(){},n.addAnimation=function(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)},n.removeAnimation=function(t){var e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):O(3907)},n.pushDelayEvent=function(t,e,n){this._delayEvents.push({fn:t,thisArg:e,args:n})},n.addSockets=function(t,e){for(var n=this,i=function(i){var r=e[i];if(n._sockets.find((function(t){return t.target===r.target})))return"continue";var o=t.getChildByPath(r.path),a=r.target&&o&&MG(o,t);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<e.length;++r)i(r)},n.removeSockets=function(t,e){for(var n=0;n<e.length;++n)for(var i=e[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){DG(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},Z(e,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),e}(PO),xG.ID="animation",yG=SG))||yG);VO.on(HO.EVENT_INIT,(function(){var t=new OG;VO.registerSystem(OG.ID,t,PO.Priority.HIGH)})),u.AnimationManager=OG;var NG,LG,BG,FG,zG=new Vn;function kG(t,e,n){for(Vn.identity(n);t!==e;)Vn.fromRTS(zG,t.rotation,t.position,t.scale),Vn.multiply(n,zG,n),t=t.parent;return n}u.easing=ep;var UG=t("HierachyModifier",dc("cc.HierachyModifier")(NG=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(FF))||NG);u.HierachyModifier=UG;var GG=t("ComponentModifier",dc("cc.ComponentModifier")(LG=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(zF))||LG);u.ComponentModifier=GG;var HG=t("CurveValueAdapter",dc("cc.CurveValueAdapter")(BG=function(){function t(){}return t.prototype.forTarget=function(){return{set:function(){}}},t}())||BG);u.CurveValueAdapter=HG;var VG=t("UniformCurveValueAdapter",dc("cc.UniformCurveValueAdapter")(FG=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(kF))||FG);function WG(t){return"string"==typeof t}function jG(t){return"number"==typeof t}function qG(t,e){return t instanceof e}u.UniformCurveValueAdapter=VG,u.isPropertyModifier=WG,u.isElementModifier=jG,u.isCustomTargetModifier=qG,u.math=ai,u.geometry=Od;var XG=new Rn,YG=new Vn;function KG(t,e,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;t.getWorldMatrix(YG);for(var c=0,l=0;l<s;l++){var u=o[l];Rn.set(XG,u.x,u.y,0),Rn.transformMat4(XG,XG,YG),a[c++]=XG.x,a[c++]=XG.y,a[c++]=XG.z,An.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,f=r.vertexOffset,p=r.vertexAccessor.getMeshBuffer(r.bufferId),d=r.vertexAccessor.getIndexBuffer(h),_=p.indexOffset,m=0,v=s/4;m<v;m++){var g=f+4*m;d[_++]=g,d[_++]=g+1,d[_++]=g+2,d[_++]=g+1,d[_++]=g+3,d[_++]=g+2}p.indexOffset+=n.indexCount,p.setDirty()}var QG=function(){function t(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new ZG;n.initWithSize(t,e),this._texture=n,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var e=t.prototype;return e.insertSpriteFrame=function(t){var e=t.rect,n=t.texture,i=this._innerTextureInfos[n.getId()],r=e.x,o=e.y;if(i)r+=i.x,o+=i.y;else{var a=n.width,s=n.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;u.internal.dynamicAtlasManager.textureBleeding&&((a<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,o+=this._y,this._x+=a+2}var c={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(t),c},e.deleteInnerTexture=function(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)},e.isEmpty=function(){return this._count<=0},e.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var t=this._innerSpriteFrames,e=0,n=t.length;e<n;e++){var i=t[e];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},e.destroy=function(){this.reset(),this._texture.destroy()},t}(),ZG=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=Mm.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new or;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(Ev),JG=function(){function t(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var e=t.prototype;return e.newAtlas=function(){var t=this._atlases[++this._atlasIndex];return t||(t=new QG(this._textureSize,this._textureSize),this._atlases.push(t)),t},e.beforeSceneLoad=function(){this.reset()},e.insertSpriteFrame=function(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;var e=t.texture.getSamplerInfo();if(e.minFilter!==Om.LINEAR||e.magFilter!==Om.LINEAR||e.mipFilter!==Om.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(t);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(t)},e.reset=function(){for(var t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1},e.deleteAtlasSpriteFrame=function(t){if(t._original){for(var e,n=this._atlases.length-1;n>=0;n--)e=this._atlases[n],ie.array.fastRemove(e._innerSpriteFrames,t);var i=t._original._texture;this.deleteAtlasTexture(i)}},e.deleteAtlasTexture=function(t){if(t)for(var e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)},e.packToDynamicAtlas=function(t,e){if(e&&!e._original&&e.packable&&e.texture&&e.texture.width>0&&e.texture.height>0){var n=this.insertSpriteFrame(e);n&&e._setDynamicAtlasFrame(n)}},Z(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(t?(this.reset(),u.director.on(u.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),u.director.off(u.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(t){this._maxAtlasCount=t}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(t){this._textureBleeding=t}},{key:"textureSize",get:function(){return this._textureSize},set:function(t){this._textureSize=t}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(t){this._maxFrameSize=t}}]),t}();JG.instance=void 0;var $G,tH,eH,nH=t("dynamicAtlasManager",JG.instance=new JG);u.internal.dynamicAtlasManager=nH;var iH,rH,oH,aH,sH=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],cH=t("SpriteFrame",dc("cc.SpriteFrame")((eH=tH=function(t){function e(){var e;return(e=t.call(this)||this).vertices=null,e.uv=[],e.unbiasUV=[],e.uvSliced=[],e._rect=new ni,e._offset=new Xn,e._originalSize=new ti,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._isFlipUVY=!1,e._isFlipUVX=!1,e._original=null,e._packable=!0,e}$(e,t),e.createWithImage=function(t){var n=t instanceof tv?t:new tv(t),i=new Ev;i.image=n;var r=new e;return r.texture=i,r};var n=e.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(t){this.rotated=t},n.getRect=function(t){return t?(t.set(this._rect),t):this._rect.clone()},n.setRect=function(t){this.rect=t},n.getOriginalSize=function(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()},n.setOriginalSize=function(t){this.originalSize=t},n.getOffset=function(t){return t?(t.set(this._offset),t):this._offset.clone()},n.setOffset=function(t){this.offset=t},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(t,e){void 0===e&&(e=!1);var n=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),t&&(t.texture&&(this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(t){var e=this._rect,n=e.x,i=e.y;return this._rotated?(n+=e.height,i+=e.width):(n+=e.width,i+=e.height),n>t.width?(O(3300,this.name+"/"+t.name,n,t.width),!1):!(i>t.height&&(O(3301,this.name+"/"+t.name,i,t.height),1))},n.destroy=function(){return this._packable&&nH&&nH.deleteAtlasSpriteFrame(this),t.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var t=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=t.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=t.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){sH[0].u=t.x/i,sH[1].u=(t.x+l)/i,sH[2].u=(t.x+l+u)/i,sH[3].u=(t.x+t.height)/i,sH[3].v=t.y/r,sH[2].v=(t.y+o)/r,sH[1].v=(t.y+o+s)/r,sH[0].v=(t.y+t.width)/r;for(var f=0;f<4;++f)for(var p=sH[f],d=0;d<4;++d){var _=sH[3-d];h.push({u:p.u,v:_.v})}}else{sH[0].u=t.x/i,sH[1].u=(t.x+o)/i,sH[2].u=(t.x+o+s)/i,sH[3].u=(t.x+t.width)/i,sH[3].v=t.y/r,sH[2].v=(t.y+c)/r,sH[1].v=(t.y+c+u)/r,sH[0].v=(t.y+t.height)/r;for(var m=0;m<4;++m)for(var v=sH[m],g=0;g<4;++g){var y=sH[g];h.push({u:y.u,v:v.v})}}this.emit(e.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var t=this._rect,e=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:t.x/r,s=0===r?1:(t.x+t.height)/r,c=0===o?0:t.y/o,l=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=s,e[1]=l,e[2]=s,e[3]=c,e[4]=a,e[5]=l,e[6]=a,e[7]=c):this._isFlipUVX?(e[0]=s,e[1]=c,e[2]=s,e[3]=l,e[4]=a,e[5]=c,e[6]=a,e[7]=l):this._isFlipUVY?(e[0]=a,e[1]=l,e[2]=a,e[3]=c,e[4]=s,e[5]=l,e[6]=s,e[7]=c):(e[0]=a,e[1]=c,e[2]=a,e[3]=l,e[4]=s,e[5]=c,e[6]=s,e[7]=l);var u=0===r?0:t.x/r,h=0===r?1:(t.x+t.height)/r,f=0===o?0:t.y/o,p=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=p,n[2]=h,n[3]=f,n[4]=u,n[5]=p,n[6]=u,n[7]=f):this._isFlipUVX?(n[0]=h,n[1]=f,n[2]=h,n[3]=p,n[4]=u,n[5]=f,n[6]=u,n[7]=p):this._isFlipUVY?(n[0]=u,n[1]=p,n[2]=u,n[3]=f,n[4]=h,n[5]=p,n[6]=h,n[7]=f):(n[0]=u,n[1]=f,n[2]=u,n[3]=p,n[4]=h,n[5]=f,n[6]=h,n[7]=p)}else{var d=0===r?0:t.x/r,_=0===r?1:(t.x+t.width)/r,m=0===o?1:(t.y+t.height)/o,v=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=_,e[1]=v,e[2]=d,e[3]=v,e[4]=_,e[5]=m,e[6]=d,e[7]=m):this._isFlipUVX?(e[0]=_,e[1]=m,e[2]=d,e[3]=m,e[4]=_,e[5]=v,e[6]=d,e[7]=v):this._isFlipUVY?(e[0]=d,e[1]=v,e[2]=_,e[3]=v,e[4]=d,e[5]=m,e[6]=_,e[7]=m):(e[0]=d,e[1]=m,e[2]=_,e[3]=m,e[4]=d,e[5]=v,e[6]=_,e[7]=v);var g=0===r?0:t.x/r,y=0===r?1:(t.x+t.width)/r,x=0===o?1:(t.y+t.height)/o,S=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var T=this.vertices;if(T){T.nu.length=0,T.nv.length=0;for(var E=0;E<T.u.length;E++)T.nu[E]=T.u[E]/r,T.nv[E]=T.v[E]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var t=nH;if(t){var e=this._texture;if(e instanceof Ev&&!e.isCompressed){var n=this.width,i=this.height;!e.image||n>t.maxFrameSize||i>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(t){var e=t,n=e.rect;n&&(this._rect=new ni(n.x,n.y,n.width,n.height));var i=e.offset;e.offset&&(this._offset=new Xn(i.x,i.y));var r=e.originalSize;e.originalSize&&(this._originalSize=new ti(r.width,r.height)),this._rotated=!!e.rotated,this._name=e.name,this._packable=!!e.packable;var o=e.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=e.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var t,n,i,r,o,a,s,c,l=new e,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(t=u.nu)||void 0===t?void 0:t.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(t){this._texture=t;var e=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(n.rect=new ni(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new ti(e.width,e.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new Ev;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},Z(e,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t)}},{key:"rotated",get:function(){return this._rotated},set:function(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(t){t?this.reset({texture:t},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(t){this._atlasUuid=t}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(t){this._isFlipUVX=t,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(t){this._isFlipUVY=t,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(t){this._packable=t}},{key:"original",get:function(){return this._original}}]),e}(Du),tH.EVENT_UV_UPDATED="uv_updated",$G=eH))||$G);u.SpriteFrame=cH;var lH,uH=t("SpriteAtlas",dc("cc.SpriteAtlas")((aH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"spriteFrames",oH,ot(e)),e}$(e,t);var n=e.prototype;return n.getTexture=function(){var t=Object.keys(this.spriteFrames);if(t.length>0){var e=this.spriteFrames[t[0]];return e&&e.texture}return null},n.getSpriteFrame=function(t){var e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null},n.getSpriteFrames=function(){for(var t=[],e=this.spriteFrames,n=0,i=Object.keys(e);n<i.length;n++){var r=i[n];t.push(e[r])}return t},n._serialize=function(){},n._deserialize=function(t,e){var n=t;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=Rt();for(var r=0;r<i.length;r+=2)e.result.push(this.spriteFrames,i[r],i[r+1],te(cH))},e}(Du),oH=lt((rH=aH).prototype,"spriteFrames",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rt()}}),iH=rH))||iH);u.SpriteAtlas=uH;var hH,fH,pH,dH,_H=t("Font",dc("cc.Font")(lH=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(Du))||lH);u.Font=_H;var mH,vH,gH,yH,xH,SH,TH,EH,bH,CH=t("TTFFont",dc("cc.TTFFont")((dH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_fontFamily",pH,ot(e)),e}return $(e,t),e.prototype.initDefault=function(e){this._fontFamily="Arial",t.prototype.initDefault.call(this,e)},Z(e,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(t){this._fontFamily=t||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:xu(this._native),__isNative__:!0}}}]),e}(_H),pH=lt((fH=dH).prototype,"_fontFamily",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(fH.prototype,"_nativeAsset",[ol,Yc],Object.getOwnPropertyDescriptor(fH.prototype,"_nativeAsset"),fH.prototype),lt(fH.prototype,"_nativeDep",[ol],Object.getOwnPropertyDescriptor(fH.prototype,"_nativeDep"),fH.prototype),hH=fH))||hH);u.TTFFont=CH;var AH,wH=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},RH=function(){function t(t){this.letterDefinitions={},this.texture=t}var e=t.prototype;return e.addLetterDefinitions=function(t,e){this.letterDefinitions[t]=e},e.cloneLetterDefinition=function(){for(var t={},e=0,n=Object.keys(this.letterDefinitions);e<n.length;e++){var i=n[e],r=new wH;kt(r,this.letterDefinitions[i]),t[i]=r}return t},e.getTexture=function(){return this.texture},e.getLetter=function(t){return this.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t){var e=t.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(e)?this.letterDefinitions[e]:null},e.clear=function(){this.letterDefinitions={}},t}(),PH=t("BitmapFont",(mH=dc("cc.BitmapFont"),vH=Kc(cH),mH((bH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"fntDataStr",xH,ot(e)),ct(e,"spriteFrame",SH,ot(e)),ct(e,"fontSize",TH,ot(e)),ct(e,"fntConfig",EH,ot(e)),e}return $(e,t),e.prototype.onLoaded=function(){var t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new RH(t.texture));var e=this.fntConfig;if(e){var n=e.fontDefDictionary;for(var i in n){var r=new wH,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else S("The fnt config is not exists!")},e}(_H),xH=lt((yH=bH).prototype,"fntDataStr",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SH=lt(yH.prototype,"spriteFrame",[vH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TH=lt(yH.prototype,"fontSize",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),EH=lt(yH.prototype,"fntConfig",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gH=yH))||gH));u.BitmapFont=PH;var IH=t("LabelAtlas",dc("cc.LabelAtlas")(AH=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(PH))||AH);u.LabelAtlas=IH;var MH=t("BASELINE_RATIO",.26),DH=t("MIDDLE_RATIO",(MH+1)/2-MH);var OH=new ee(2);OH.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var NH,LH=new(function(){function t(t){this.count=0,this.limit=0,this.datas={},this.limit=t}var e=t.prototype;return e.moveToHead=function(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t},e.put=function(t,e){var n=OH.get();if(n.key=t,n.value=e,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,OH.put(i)}this.moveToHead(n)},e.remove=function(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--},e.get=function(t){var e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null},e.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},e.has=function(t){return!!this.datas[t]},e.delete=function(t){var e=this.datas[t];this.remove(e)},t}())(100),BH=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,FH=/^[!,.:;'}\]%\?>、‘“》？。，！]/,zH=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,kH=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,UH=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function GH(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function HH(t){var e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function VH(t,e,n){var i=(n||t.font)+"🎮"+e,r=LH.get(i);if(null!==r)return r;var o=t.measureText(e),a=o&&o.width||0;return LH.put(i,a),a}function WH(t,e,n){var i=e,r=n,o=t[e];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==e){var a=t[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return t.substring(i,r)}function jH(t,e,n,i){var r=[];if(0===t.length||n<0)return r.push(""),r;for(var o=t;e>n&&o.length>1;){for(var a=o.length*(n/e)|0,s=WH(o,a),c=e-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=e-i(s=WH(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var f=BH.exec(s);u=f?f[0].length:1,l=s}c=e-i(s=WH(o,a+=u))}0==(a-=u)?(a=1,l=WH(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=WH(o,2));var p=WH(o,0,a),d=void 0;FH.test(l||s)&&(0==(a-=(d=zH.exec(p))?d[0].length:0)&&(a=1),l=WH(o,a),p=WH(o,0,a)),UH.test(l)&&(d=kH.exec(p))&&p!==d[0]&&(l=WH(o,a-=d[0].length),p=WH(o,0,a)),(0===r.length||(p=p.trim()).length>0)&&r.push(p),e=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var qH=t("CanvasPool",function(){function t(){this.pool=[]}t.getInstance=function(){return NH||(NH=new t),NH};var e=t.prototype;return e.get=function(){var t=this.pool.pop();if(!t){var e=document.createElement("canvas"),n=e.getContext("2d");t={canvas:e,context:n}}return t},e.put=function(t){this.pool.length>=ue.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)},t}()),XH=An.WHITE.clone(),YH=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},KH="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",QH=function(){function t(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}var e=t.prototype;return e.updateRenderData=function(){this._updateProperties(),this._updateTexture()},e.destroy=function(){this.image=null},e._updateProperties=function(){if(this.data=qH.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var t=VH(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+MH)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*MH/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new tv),this.image.reset(this.canvas)},e._updateTexture=function(){if(this.context&&this.canvas){var t=this.context,e=this.labelInfo,n=this.canvas.width,i=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,n,i),t.fillStyle=KH,t.fillRect(0,0,n,i),t.font=e.fontDesc;var r=e.fontSize,o=n/2,a=i/2+r*DH+0*r,s=e.color;if(t.lineJoin="round",t.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",e.isOutlined){var c=e.out||XH;t.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",t.lineWidth=2*e.margin,t.strokeText(this.char,o,a)}t.fillText(this.char,o,a)}},t}(),ZH=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=Mm.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new or;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(Ev),JH=function(){function t(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new ZH;n.initWithSize(t,e),this.fontDefDictionary=new RH(n),this._halfBleed=1,this._width=t,this._height=e,VO.on(HO.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var e=t.prototype;return e.insertLetterTexture=function(t){var e=t.image,n=VO.root.device;if(!e||!this.fontDefDictionary||!n)return null;var i=e.width,r=e.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return M(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;var o=new YH;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=t.width-2,o.h=t.height-2,o.xAdvance=o.w,o.offsetY=t.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(t.hash,o),o},e.update=function(){this._dirty&&(this._dirty=!1)},e.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},e.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},e.getTexture=function(){return this.fontDefDictionary.getTexture()},e.beforeSceneLoad=function(){this.clearAllCache()},e.clearAllCache=function(){this.destroy();var t=new ZH;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t},e.getLetter=function(t){return this.fontDefDictionary.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t,e){var n=t.charCodeAt(0)+e.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new QH(t,e);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},Z(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(),$H={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:An.WHITE.clone(),isOutlined:!1,out:An.WHITE.clone(),margin:0},tV=[new Rr(Ki.ATTR_POSITION,fi.RGB32F)],eV=[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_COLOR,fi.RGBA32F)],nV=[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD,fi.RG32F),new Rr(Ki.ATTR_COLOR,fi.RGBA32F)],iV=[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD,fi.RG32F),new Rr(Ki.ATTR_COLOR,fi.RGBA32F),new Rr(Ki.ATTR_COLOR2,fi.RGBA32F)];function rV(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=Jr[i.format].count}return e}function oV(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=Jr[i.format].size}return e}u.internal.vfmtPosUvColor=nV,u.internal.vfmtPosUvTwoColor=iV,t("UIVertexFormat",Object.freeze({__proto__:null,vfmt:tV,vfmtPosColor:eV,vfmtPosUvColor:nV,vfmtPosUvTwoColor:iV,getComponentPerVertex:rV,getAttributeStride:oV}));var aV,sV,cV,lV,uV,hV,fV,pV,dV,_V,mV,vV,gV,yV,xV,SV=oV(nV)>>2,TV=new Wl((function(){return{x:0,y:0,z:0,u:0,v:0,color:An.WHITE.clone()}}),128),EV=null,bV=t("BaseRenderData",function(){function t(t){void 0===t&&(t=nV),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=nV,this._floatStride=t===nV?SV:oV(t)>>2,this._vertexFormat=t}return t.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},Z(t,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),t}()),CV=t("RenderData",function(t){function e(e,n){var i;return void 0===e&&(e=nV),(i=t.call(this,e)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=VO.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}$(e,t),e.add=function(t,n){void 0===t&&(t=nV),EV||(EV=new jl((function(){return new e}),32));var i=EV.add();return i._floatStride=t===nV?SV:oV(t)>>2,i._vertexFormat=t,n||(n=VO.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},e.remove=function(t){var e=EV.data.indexOf(t);-1!==e&&(t.clear(),t._accessor=null,EV.removeAt(e))};var n=e.prototype;return n.resize=function(t,e){t===this._vc&&e===this._ic&&this.chunk||(this._vc=t,this._ic=e,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(t,e),this.updateHash())},n.resizeAndCopy=function(t,e){if(t!==this._vc||e!==this._ic||!this.chunk){this._vc=t,this._ic=e;var n=this.chunk;this.chunk=this._accessor.allocateChunk(t,e),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(t){this.layer=t.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(t){this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(t){this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var t=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=go(t,666),this.hashDirty=!1},n.updateRenderData=function(t,e){if(this.passDirty&&(this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=t.node.scene?t._getRenderScene():null;this.layer=t.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(t,e,n,i){t===this._width&&e===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=t,this._height=e,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},Z(e,[{key:"dataLength",get:function(){return this._data.length},set:function(t){var e=this._data;if(e.length!==t){var n=e.length,i=0;for(i=t;i<n;i++)TV.free(e[i]);for(i=n;i<t;i++)e[i]=TV.alloc();e.length=t}}},{key:"data",get:function(){return this._data}}]),e}(bV)),AV=t("MeshRenderData",function(t){function e(e){var n;return void 0===e&&(e=nV),(n=t.call(this,e)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}$(e,t),e.add=function(t){void 0===t&&(t=nV);var e=wV.add();return e._floatStride=t===nV?SV:oV(t)>>2,e._vertexFormat=t,e},e.remove=function(t){var e=wV.data.indexOf(t);-1!==e&&(wV.data[e].clear(),wV.removeAt(e))};var n=e.prototype;return n.request=function(t,e){var n=this._byteLength+t*this.stride;return!!this.reserve(t,e)&&(this._vc+=t,this._ic+=e,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(t,e){var n=this._byteLength+t*this.stride,i=this.indexCount+e;if(t+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(t,e){var n=t*this.stride;t>=0&&e>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=t,this._ic=e,this._byteLength=n,this.updateRange(0,t,0,e)},n.updateRange=function(t,e,n,i){e>=0&&i>=0&&e<=this._vc&&this._ic,this.vertexStart=t,this.indexStart=n,this.vertexRange=e,this.indexRange=i},n.requestIA=function(t){this._initIAInfo(t);var e=this._iaPool.add();return e.firstIndex=this.indexStart,e.indexCount=this.indexRange,e},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var t=this._ic,e=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,t),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(e);var r=t<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(t){var e=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(t.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=t.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.DEVICE,r,r))),this._iaInfo=new Ir(this._vertexFormat,i,this._indexBuffer),this._iaPool=new jl((function(){return t.createInputAssembler(e._iaInfo)}),1,(function(t){t.destroy()}))}},n._reallocBuffer=function(t,e){var n=this.vData;this.vData=new Float32Array(t),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(e),i&&this.iData.set(i,0)},Z(e,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),e}(bV)),wV=new jl((function(){return new AV}),32),RV=new Xn,PV=new Xn,IV=(new Rn,new Vn),MV=new Vn,DV=new Vn,OV=new Vn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),NV=new ni,LV=function(e){return t({UITransform:e,UITransformComponent:e}),e}((aV=dc("cc.UITransform"),sV=Ic(),cV=mc(110),lV=Ac(),uV=Gc(),hV=Lc(),fV=Gc(),pV=Lc(),aV(dV=sV(dV=cV(dV=lV(dV=vc(dV=Cc((yV=gV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._priority=0,ct(e,"_contentSize",mV,ot(e)),ct(e,"_anchorPoint",vV,ot(e)),e}$(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&e.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(HE.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(HE.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(t,e){var n=this._contentSize;if(void 0===e){if((t=t).width===n.width&&t.height===n.height)return;n.width=t.width,n.height=t.height}else{if(t===n.width&&e===n.height)return;n.width=t,n.height=e}this.node.emit(HE.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(t,e){var n=this._anchorPoint;if(void 0===e){if((t=t).x===n.x&&t.y===n.y)return;n.x=t.x,n.y=t.y}else{if(t===n.x&&e===n.y)return;n.x=t,n.y=e}this.node.emit(HE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(t){for(var e,n=this._contentSize.width,i=this._contentSize.height,r=RV,o=PV,a=null===(e=this.node)||void 0===e?void 0:e.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(IV);var u=IV.m12,h=IV.m13,f=qO.center;if(IV.m12=f.x-(IV.m00*u+IV.m04*h),IV.m13=f.y-(IV.m01*u+IV.m05*h),Vn.invert(IV,IV),Xn.transformMat4(r,t,IV),this.node.getWorldMatrix(DV),Vn.invert(IV,DV),!Vn.strictEquals(IV,OV)){Xn.transformMat4(o,r,IV),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var p=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(p=!0,a&&a.maskList))for(var d=a.maskList,_=this.node,m=d?d.length:0,v=0,g=0;_&&g<m;++v,_=_.parent){var y=d[g];if(v===y.index){if(_!==y.comp.node){d.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){p=!1;break}g++}else if(v>y.index){d.length=g;break}}if(p)return!0}}}return!1},n.convertToNodeSpaceAR=function(t,e){return this.node.getWorldMatrix(DV),Vn.invert(IV,DV),e||(e=new Rn),Rn.transformMat4(e,t,IV)},n.convertToWorldSpaceAR=function(t,e){return this.node.getWorldMatrix(DV),e||(e=new Rn),Rn.transformMat4(e,t,DV)},n.getBoundingBox=function(){Vn.fromRTS(MV,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,e=this._contentSize.height,n=new ni(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return n.transformMat4(MV),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(DV),this.getBoundingBoxTo(DV)):this.getBoundingBox()},n.getBoundingBoxTo=function(t){Vn.fromRTS(MV,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new ni(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Vn.multiply(DV,t,MV),r.transformMat4(DV),!this.node.children)return r;for(var o,a=st(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(e);if(c){var l=c.getBoundingBoxTo(t);l&&ni.union(r,r,l)}}}return r},n.getComputeAABB=function(t){var e=this._contentSize.width,n=this._contentSize.height;NV.set(-this._anchorPoint.x*e,-this._anchorPoint.y*n,e,n),NV.transformMat4(this.node.worldMatrix);var i=NV.x+.5*NV.width,r=NV.y+.5*NV.height,o=this.node.worldPosition.z,a=NV.width/2,s=NV.height/2;return null!=t?(js.set(t,i,r,o,a,s,.001),t):new js(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&e.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var t=this.node._uiProps.uiComp;t&&(t.markForUpdateRenderData(),t.renderData&&(t.renderData.vertDirty=!0))},e.insertChangeMap=function(t){var n=t.uuid;e.priorityChangeNodeMap.has(n)||e.priorityChangeNodeMap.set(n,t)},e._sortChildrenSibling=function(t){var e=t.children;e&&e.sort((function(t,e){var n=t._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?t.getSiblingIndex()-e.getSiblingIndex():r}))},e._sortSiblings=function(){e.priorityChangeNodeMap.forEach((function(t){e._sortChildrenSibling(t),t._updateSiblingIndex(),t.emit("childrenSiblingOrderChanged")})),e.priorityChangeNodeMap.clear()},e._cleanChangeMap=function(){e.priorityChangeNodeMap.clear()},Z(e,[{key:"contentSize",get:function(){return this._contentSize},set:function(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(HE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(HE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(HE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(HE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(HE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(HE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority!==t&&(this.node.getComponent("cc.RenderRoot2D")?M(6706):(this._priority=t,this.node.parent&&e.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var t=VO.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}},{key:"cameraPriority",get:function(){var t=VO.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}}]),e}($u),gV.EventType=HE,gV.priorityChangeNodeMap=new Map,lt((_V=yV).prototype,"contentSize",[uV,hV],Object.getOwnPropertyDescriptor(_V.prototype,"contentSize"),_V.prototype),lt(_V.prototype,"anchorPoint",[fV,pV],Object.getOwnPropertyDescriptor(_V.prototype,"anchorPoint"),_V.prototype),mV=lt(_V.prototype,"_contentSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(100,100)}}),vV=lt(_V.prototype,"_anchorPoint",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(.5,.5)}}),dV=_V))||dV)||dV)||dV)||dV)||dV)||dV));VO.on(HO.EVENT_AFTER_UPDATE,LV._sortSiblings),VO.on(HO.EVENT_BEFORE_SCENE_LAUNCH,LV._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(xV||(xV={}));var BV,FV,zV,kV,UV,GV,HV,VV,WV,jV,qV,XV,YV,KV,QV,ZV,JV,$V,tW,eW,nW=t("StencilManager",function(){function t(){this.stage=xV.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Ai.ALWAYS,stencilMask:65535,writeMask:65535,failOp:wi.KEEP,zFailOp:wi.KEEP,passOp:wi.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var e=t.prototype;return e.pushMask=function(t){this._maskStack.push(t)},e.clear=function(t){t.stencilStage=t.inverted?xV.CLEAR_INVERTED:xV.CLEAR},e.enterLevel=function(t){t.graphics.stencilStage=t.inverted?xV.ENTER_LEVEL_INVERTED:xV.ENTER_LEVEL},e.enableMask=function(){this.stage=xV.ENABLED},e.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=xV.DISABLED:this.stage=xV.ENABLED)},e.getWriteMask=function(){return 1<<this._maskStack.length-1},e.getExitWriteMask=function(){return 1<<this._maskStack.length},e.getStencilRef=function(){for(var t=0,e=0;e<this._maskStack.length;++e)t+=1<<e;return t},e.reset=function(){this._maskStack.length=0,this.stage=xV.DISABLED},e.destroy=function(){this.stencilStateMap.forEach((function(t){t.destroy()})),this.stencilStateMap.clear()},e.getStencilStage=function(t,e){var n=0,i=!1,r=!1,o=Ai.LESS,a=this.stencilStateMap;if(e&&e.passes[0]){var s=e.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|t<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=t<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(t);var u=new bo(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},e.getStencilHash=function(t){return t<<8|this._maskStack.length},e.setStateFromStage=function(t){var e=this._stencilPattern;t===xV.DISABLED?(e.stencilTest=!1,e.func=Ai.ALWAYS,e.failOp=wi.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===xV.ENABLED?(e.func=Ai.EQUAL,e.failOp=wi.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===xV.CLEAR?(e.func=Ai.NEVER,e.failOp=wi.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===xV.CLEAR_INVERTED||t===xV.ENTER_LEVEL?(e.func=Ai.NEVER,e.failOp=wi.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===xV.ENTER_LEVEL_INVERTED&&(e.func=Ai.NEVER,e.failOp=wi.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))},Z(t,[{key:"pattern",get:function(){return this._stencilPattern}}]),t}());nW.sharedManager=null,nW.sharedManager=new nW,ce(Ri),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(eW||(eW=t("InstanceMaterialType",{})));var iW,rW,oW,aW,sW,cW,lW,uW,hW,fW,pW,dW,_W,mW,vW,gW,yW,xW,SW,TW,EW,bW,CW,AW,wW,RW,PW,IW,MW,DW,OW,NW,LW,BW,FW,zW,kW,UW,GW,HW,VW,WW,jW,qW,XW,YW,KW,QW,ZW,JW,$W,tj,ej,nj,ij,rj,oj,aj,sj,cj,lj,uj,hj,fj,pj,dj,_j,mj,vj,gj,yj=function(e){return t({Renderable2D:e,RenderComponent:e,UIRenderable:e}),e}((BV=dc("cc.Renderable2D"),FV=_c(LV),zV=Dc(),kV=Kc(cg),UV=Kc(cg),GV=Gc(),HV=Lc(),VV=Nc(),WV=Gc(),jV=Lc(),BV(qV=FV(qV=vc(qV=Cc((tW=$V=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_materials",YV,ot(e)),ct(e,"_customMaterial",KV,ot(e)),e.stencilStage=xV.DISABLED,ct(e,"_srcBlendFactor",QV,ot(e)),ct(e,"_dstBlendFactor",ZV,ot(e)),ct(e,"_color",JV,ot(e)),e._assembler=null,e._postAssembler=null,e._renderData=null,e._renderDataFlag=!0,e._renderFlag=!0,e._delegateSrc=null,e._instanceMaterialType=-1,e._blendState=new Ao,e._blendHash=0,e._lastParent=null,e}$(e,t);var n=e.prototype;return n.updateBlendHash=function(){var t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(HE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(HE.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(HE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(HE.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var t=0;t<this._materialInstances.length;t++){var e=this._materialInstances[t];e&&e.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(t){if(void 0===t&&(t=!0),this._renderFlag=this._canRender(),t){var e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else this._renderDataFlag=t},n.requestRenderData=function(){var t=CV.add();return this._renderData=t,t},n.destroyRenderData=function(){this._renderData&&(CV.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(t){this._renderDataFlag&&(this._assembler.updateRenderData(this,t),this._renderDataFlag=!1),this._renderFlag&&this._render(t)},n.postUpdateAssembler=function(t){this._postAssembler&&this._renderFlag&&this._postRender(t)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._renderData&&(this._renderData.material=t,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var t=this._blendState.targets[0];t||(t=new Co,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=Ri.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var t=0;t<this.node.children.length;++t){var n=this.node.children[t].getComponent(e);n&&n.markForUpdateRenderData()}},n._onMaterialModified=function(e,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),t.prototype._onMaterialModified.call(this,e,n)},n._updateBuiltinMaterial=function(){var t;switch(this._instanceMaterialType){case eW.ADD_COLOR:t=Dv.get("ui-base-material");break;case eW.GRAYSCALE:t=Dv.get("ui-sprite-gray-material");break;case eW.USE_ALPHA_SEPARATED:t=Dv.get("ui-sprite-alpha-sep-material");break;case eW.USE_ALPHA_SEPARATED_AND_GRAY:t=Dv.get("ui-sprite-gray-alpha-sep-material");break;default:t=Dv.get("ui-sprite-material")}return t},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},Z(e,[{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&M(12001),this._srcBlendFactor},set:function(t){this._customMaterial?M(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&M(12001),this._dstBlendFactor},set:function(t){this._customMaterial?M(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color.equals(t)||(this._color.set(t),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(t){this._delegateSrc=t}},{key:"blendHash",get:function(){return this._blendHash}}]),e}(pF),$V.BlendState=Ri,$V.Assembler=null,$V.PostAssembler=null,YV=lt((XV=tW).prototype,"_materials",[ol],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lt(XV.prototype,"sharedMaterials",[ol,zV],Object.getOwnPropertyDescriptor(XV.prototype,"sharedMaterials"),XV.prototype),KV=lt(XV.prototype,"_customMaterial",[kV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(XV.prototype,"customMaterial",[UV,GV,HV,VV],Object.getOwnPropertyDescriptor(XV.prototype,"customMaterial"),XV.prototype),lt(XV.prototype,"color",[WV,jV],Object.getOwnPropertyDescriptor(XV.prototype,"color"),XV.prototype),QV=lt(XV.prototype,"_srcBlendFactor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.SRC_ALPHA}}),ZV=lt(XV.prototype,"_dstBlendFactor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.ONE_MINUS_SRC_ALPHA}}),JV=lt(XV.prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),qV=XV))||qV)||qV)||qV)||qV));u.internal.Renderable2D=yj,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(_j||(_j=t("HorizontalTextAlignment",{}))),ce(_j),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(mj||(mj=t("VerticalTextAlignment",{}))),ce(mj),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(vj||(vj=t("Overflow",{}))),ce(vj),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(gj||(gj=t("CacheMode",{}))),ce(gj);var xj=function(e){return t({Label:e,LabelComponent:e}),e}((iW=dc("cc.Label"),rW=Ic(),oW=mc(110),aW=Ac(),sW=Gc(),cW=Lc(),lW=Kc(_j),uW=Gc(),hW=Lc(),fW=Kc(mj),pW=Gc(),dW=Lc(),_W=Gc(),mW=Lc(),vW=Gc(),gW=Dc(),yW=Lc(),xW=Gc(),SW=Lc(),TW=Dc(),EW=Gc(),bW=Lc(),CW=Kc(vj),AW=Gc(),wW=Lc(),RW=Gc(),PW=Lc(),IW=Kc(_H),MW=Gc(),DW=Dc(),OW=Lc(),NW=Gc(),LW=Lc(),BW=Kc(gj),FW=Gc(),zW=Lc(),kW=Gc(),UW=Lc(),GW=Gc(),HW=Lc(),VW=Gc(),WW=Lc(),jW=Dc(),qW=Gc(),XW=Lc(),iW(YW=rW(YW=oW(YW=aW((dj=pj=function(t){function e(){var e;return ct(e=t.call(this)||this,"_string",QW,ot(e)),ct(e,"_horizontalAlign",ZW,ot(e)),ct(e,"_verticalAlign",JW,ot(e)),ct(e,"_actualFontSize",$W,ot(e)),ct(e,"_fontSize",tj,ot(e)),ct(e,"_fontFamily",ej,ot(e)),ct(e,"_lineHeight",nj,ot(e)),ct(e,"_overflow",ij,ot(e)),ct(e,"_enableWrapText",rj,ot(e)),ct(e,"_font",oj,ot(e)),ct(e,"_isSystemFontUsed",aj,ot(e)),ct(e,"_spacingX",sj,ot(e)),ct(e,"_isItalic",cj,ot(e)),ct(e,"_isBold",lj,ot(e)),ct(e,"_isUnderline",uj,ot(e)),ct(e,"_underlineHeight",hj,ot(e)),ct(e,"_cacheMode",fj,ot(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}$(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var e=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),e){var n=e;n.image&&n.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,t.prototype.onDestroy.call(this)},n.updateRenderData=function(t){void 0===t&&(t=!1),this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){t.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!t.prototype._canRender.call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof PH){var n=e.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var t=this._font;if(t instanceof PH){var e=t.spriteFrame;e&&e.texture&&(this._texture=e,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===gj.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new cH,this._assemblerData=this._assembler.getAssemblerData();var n=new tv(this._assemblerData.canvas),i=new Ev;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==gj.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var t=!1;if(this.cacheMode!==gj.CHAR){var e=this._texture.texture;if(e instanceof Jm){var n=e.getPixelFormat();t=n===Mm.RGBA_ETC1||n===Mm.RGB_A_PVRTC_4BPPV1||n===Mm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?eW.USE_ALPHA_SEPARATED:eW.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},Z(e,[{key:"string",get:function(){return this._string},set:function(t){t=null==t?"":t.toString(),this._string!==t&&(this._string=t,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(t){this._actualFontSize=t}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode!==gj.BITMAP||this._font instanceof PH||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===gj.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(t){this._fontAtlas=t}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof PH?this._font.fontSize:-1}}]),e}(yj),pj.HorizontalAlign=_j,pj.VerticalAlign=mj,pj.Overflow=vj,pj.CacheMode=gj,pj._canvasPool=qH.getInstance(),lt((KW=dj).prototype,"string",[sW,cW,Vc],Object.getOwnPropertyDescriptor(KW.prototype,"string"),KW.prototype),lt(KW.prototype,"horizontalAlign",[lW,uW,hW],Object.getOwnPropertyDescriptor(KW.prototype,"horizontalAlign"),KW.prototype),lt(KW.prototype,"verticalAlign",[fW,pW,dW],Object.getOwnPropertyDescriptor(KW.prototype,"verticalAlign"),KW.prototype),lt(KW.prototype,"fontSize",[_W,mW],Object.getOwnPropertyDescriptor(KW.prototype,"fontSize"),KW.prototype),lt(KW.prototype,"fontFamily",[vW,gW,yW],Object.getOwnPropertyDescriptor(KW.prototype,"fontFamily"),KW.prototype),lt(KW.prototype,"lineHeight",[xW,SW],Object.getOwnPropertyDescriptor(KW.prototype,"lineHeight"),KW.prototype),lt(KW.prototype,"spacingX",[TW,EW,bW],Object.getOwnPropertyDescriptor(KW.prototype,"spacingX"),KW.prototype),lt(KW.prototype,"overflow",[CW,AW,wW],Object.getOwnPropertyDescriptor(KW.prototype,"overflow"),KW.prototype),lt(KW.prototype,"enableWrapText",[RW,PW],Object.getOwnPropertyDescriptor(KW.prototype,"enableWrapText"),KW.prototype),lt(KW.prototype,"font",[IW,MW,DW,OW],Object.getOwnPropertyDescriptor(KW.prototype,"font"),KW.prototype),lt(KW.prototype,"useSystemFont",[NW,LW],Object.getOwnPropertyDescriptor(KW.prototype,"useSystemFont"),KW.prototype),lt(KW.prototype,"cacheMode",[BW,FW,zW],Object.getOwnPropertyDescriptor(KW.prototype,"cacheMode"),KW.prototype),lt(KW.prototype,"isBold",[kW,UW],Object.getOwnPropertyDescriptor(KW.prototype,"isBold"),KW.prototype),lt(KW.prototype,"isItalic",[GW,HW],Object.getOwnPropertyDescriptor(KW.prototype,"isItalic"),KW.prototype),lt(KW.prototype,"isUnderline",[VW,WW],Object.getOwnPropertyDescriptor(KW.prototype,"isUnderline"),KW.prototype),lt(KW.prototype,"underlineHeight",[jW,Mc,qW,XW],Object.getOwnPropertyDescriptor(KW.prototype,"underlineHeight"),KW.prototype),QW=lt(KW.prototype,"_string",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),ZW=lt(KW.prototype,"_horizontalAlign",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _j.CENTER}}),JW=lt(KW.prototype,"_verticalAlign",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mj.CENTER}}),$W=lt(KW.prototype,"_actualFontSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tj=lt(KW.prototype,"_fontSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),ej=lt(KW.prototype,"_fontFamily",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),nj=lt(KW.prototype,"_lineHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),ij=lt(KW.prototype,"_overflow",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vj.NONE}}),rj=lt(KW.prototype,"_enableWrapText",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),oj=lt(KW.prototype,"_font",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aj=lt(KW.prototype,"_isSystemFontUsed",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sj=lt(KW.prototype,"_spacingX",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cj=lt(KW.prototype,"_isItalic",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lj=lt(KW.prototype,"_isBold",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uj=lt(KW.prototype,"_isUnderline",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hj=lt(KW.prototype,"_underlineHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),fj=lt(KW.prototype,"_cacheMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gj.NONE}}),YW=KW))||YW)||YW)||YW)||YW));u.Label=xj;var Sj,Tj,Ej=0,bj={};function Cj(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function Aj(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(Sj||(Sj={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(Tj||(Tj={}));var wj,Rj,Pj,Ij=function(){function t(t){this._device=void 0,this._format=fi.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new or,this._region1=new or,this._region2=new or,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}var e=t.prototype;return e.initialize=function(t){var e=Jr[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=co(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)},e.destroy=function(){for(var t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0},e.alloc=function(t,e){t=Aj(t,this._alignment);var n=-1,i=-1;if(void 0!==e&&(n=e,i=this._findAvailableSpace(t,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(t,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=t;var a={chunkIdx:n,start:i,end:i+t,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(t/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,Cj(s)),l=this._chunks[this.createChunk(c)];l.start+=t;var u={chunkIdx:this._chunkCount-1,start:0,end:t,texture:l.texture};return this._handles.push(u),u},e.free=function(t){for(var e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)},e.createChunk=function(t){var e=t*t*this._formatSize;b("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+e+", format: "+this._format);var n={texture:this._device.createTexture(new mr(yi.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,this._format,t,t)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=n,this._chunkCount++},e.update=function(t,e){var n=[],i=[],r=t.start/this._formatSize,o=e.byteLength/this._formatSize,a=r%t.texture.width,s=Math.floor(r/t.texture.width),c=Math.min(t.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(o/t.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,t.texture,i)},e._findAvailableSpace=function(t,e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(t){return t.chunkIdx===e})).sort((function(t,e){return t.start-e.start})),a=0;a<o.length;a++){var s=o[a];if(r+t<=s.start){i=!0;break}r=s.end}!i&&r+t<=n.size&&(i=!0)}return i?r:-1},e._McDonaldAlloc=function(t){t=Aj(t,this._alignment);for(var e=0;e<this._chunkCount;++e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.end?i=!0:r>n.end?r+t<=n.size?i=!0:t<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,t<=n.end&&(i=!0)),i){n.start+=t;var o={chunkIdx:e,start:r,end:r+t,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(t/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,Cj(a)),c=this._chunks[this.createChunk(s)];c.start+=t;var l={chunkIdx:this._chunkCount,start:0,end:t,texture:c.texture};return this._handles.push(l),l},t}(),Mj=function(t){if(void 0===bj[t]){var e=1<<Ej;bj[t]=e,Ej+=1}},Dj=Object.freeze({__proto__:null,addStage:Mj,scene:RT,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;for(var n=[],i=e.positions.length/3,r=0;r<i;++r)n.push(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),e.normals&&n.push(e.normals[3*r],e.normals[3*r+1],e.normals[3*r+2]),e.uvs&&n.push(e.uvs[2*r],e.uvs[2*r+1]),e.colors&&n.push(e.colors[3*r],e.colors[3*r+1],e.colors[3*r+2]);var o=[];o.push(new Rr(Ki.ATTR_POSITION,fi.RGB32F)),e.normals&&o.push(new Rr(Ki.ATTR_NORMAL,fi.RGB32F)),e.uvs&&o.push(new Rr(Ki.ATTR_TEX_COORD,fi.RG32F)),e.colors&&o.push(new Rr(Ki.ATTR_COLOR,fi.RGB32F));var a=t.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return e.indices&&(s=t.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.DEVICE,2*e.indices.length,2))).update(new Uint16Array(e.indices)),t.createInputAssembler(new Ir(o,[a],s))},get RenderQueue(){return Sj},get PassStage(){return Tj},genHandle:im,getTypeFromHandle:rm,getBindingFromHandle:om,getCountFromHandle:am,getOffsetFromHandle:sm,customizeType:cm,type2reader:lm,type2writer:um,getDefaultFromType:fm,overrideMacros:pm,get BatchingSchemes(){return Rv},Pass:kv,getDeviceShaderVersion:xm,programLib:Pm,nearestPOT:Cj,TextureBufferPool:Ij,MaterialInstance:mT,PassInstance:_T,get PoolType(){return Cs},NULL_HANDLE:0,get NodeView(){return As},NodePool:Ms,get PassView(){return Rs},PassPool:Ls,get AABBView(){return Ds},AABBPool:zs});t("renderer",Dj),function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(wj||(wj={})),ce(wj),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(Rj||(Rj={})),ce(Rj),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(Pj||(Pj={})),ce(Pj);var Oj=Math.PI,Nj=Math.min,Lj=Math.max,Bj=Math.cos,Fj=Math.sin,zj=Math.abs,kj=Math.sign,Uj=.5522847493;function Gj(t,e,n,i,r){t.moveTo(e-i,n),t.bezierCurveTo(e-i,n+r*Uj,e-i*Uj,n+r,e,n+r),t.bezierCurveTo(e+i*Uj,n+r,e+i,n+r*Uj,e+i,n),t.bezierCurveTo(e+i,n-r*Uj,e+i*Uj,n-r,e,n-r),t.bezierCurveTo(e-i*Uj,n-r,e-i,n-r*Uj,e-i,n),t.close()}function Hj(t,e,n,i,r,o,a,s,c,l,u){var h,f,p,d,_,m,v,g,y,x,S,T,E,b,C,A;l>10||(_=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(e+i))+(p=.5*(i+o))),g=.5*((f=.5*(n+r))+(d=.5*(r+a))),((C=zj((i-s)*(b=c-n)-(r-c)*(E=s-e)))+(A=zj((o-s)*b-(a-c)*E)))*(C+A)<t.tessTol*(E*E+b*b)?t.addPoint(s,c,0===u?u|Pj.PT_BEVEL:u):(Hj(t,e,n,h,f,v,g,S=.5*(v+(y=.5*(p+_))),T=.5*(g+(x=.5*(d+m))),l+1,0),Hj(t,S,T,y,x,_,m,s,c,l+1,u)))}var Vj,Wj,jj,qj,Xj,Yj,Kj,Qj,Zj,Jj,$j,tq,eq,nq,iq,rq,oq,aq,sq,cq,lq,uq,hq,fq,pq,dq,_q,mq,vq,gq,yq,xq,Sq,Tq,Eq,bq,Cq,Aq,wq,Rq,Pq,Iq,Mq,Dq,Oq,Nq,Lq,Bq=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return $(e,t),e.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},e}(Xn),Fq=function(){function t(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return t.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},t}(),zq=function(){function t(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=An.WHITE.clone(),this.lineCap=wj.BUTT,this.strokeColor=An.BLACK.clone(),this.lineJoin=Rj.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var e=t.prototype;return e.moveTo=function(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,Pj.PT_CORNER),this._commandX=t,this._commandY=e},e.lineTo=function(t,e){this.addPoint(t,e,Pj.PT_CORNER),this._commandX=t,this._commandY=e},e.bezierCurveTo=function(t,e,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==t||s.y!==e||n!==r||i!==o?(Hj(this,s.x,s.y,t,e,n,i,r,o,0,Pj.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},e.quadraticCurveTo=function(t,e,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(t-r),o+2/3*(e-o),n+2/3*(t-n),i+2/3*(e-i),n,i)},e.arc=function(t,e,n,i,r,o){!function(t,e,n,i,r,o,a){var s,c,l=0,u=0,h=0,f=0,p=0,d=0,_=0,m=0,v=0,g=0,y=0,x=0,S=0,T=0;if(u=o-r,a=a||!1)if(zj(u)>=2*Oj)u=2*Oj;else for(;u<0;)u+=2*Oj;else if(zj(u)>=2*Oj)u=2*-Oj;else for(;u>0;)u-=2*Oj;for(c=0|Lj(1,Nj(zj(u)/(.5*Oj)+.5,5)),h=zj(4/3*(1-Bj(s=u/c/2))/Fj(s)),a||(h=-h),T=0;T<=c;T++)d=e+(f=Bj(l=r+u*(T/c)))*i,_=n+(p=Fj(l))*i,m=-p*i*h,v=f*i*h,0===T?t.moveTo(d,_):t.bezierCurveTo(g+x,y+S,d-m,_-v,d,_),g=d,y=_,x=m,S=v}(this,t,e,n,i,r,o)},e.ellipse=function(t,e,n,i){Gj(this,t,e,n,i),this._curPath.complex=!1},e.circle=function(t,e,n){Gj(this,t,e,n,n),this._curPath.complex=!1},e.rect=function(t,e,n,i){this.moveTo(t,e),this.lineTo(t+n,e),this.lineTo(t+n,e+i),this.lineTo(t,e+i),this.close(),this._curPath.complex=!1},e.roundRect=function(t,e,n,i,r){!function(t,e,n,i,r,o){if(o<.1)t.rect(e,n,i,r);else{var a=Nj(o,.5*zj(i))*kj(i),s=Nj(o,.5*zj(r))*kj(r);t.moveTo(e,n+s),t.lineTo(e,n+r-s),t.bezierCurveTo(e,n+r-s*(1-Uj),e+a*(1-Uj),n+r,e+a,n+r),t.lineTo(e+i-a,n+r),t.bezierCurveTo(e+i-a*(1-Uj),n+r,e+i,n+r-s*(1-Uj),e+i,n+r-s),t.lineTo(e+i,n+s),t.bezierCurveTo(e+i,n+s*(1-Uj),e+i-a*(1-Uj),n,e+i-a,n),t.lineTo(e+a,n),t.bezierCurveTo(e+a*(1-Uj),n,e,n+s*(1-Uj),e,n+s),t.close()}}(this,t,e,n,i,r),this._curPath.complex=!1},e.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDataList,e=0,n=t.length;e<n;e++){var i=t[e];i&&AV.remove(i)}this._renderDataList.length=0},e.close=function(){this._curPath.closed=!0},e.requestRenderData=function(){var t=AV.add();return this._renderDataList.push(t),t},e.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},e.addPoint=function(t,e,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=t,a.y=e):(a=new Bq(t,e),r.push(a)),a.flags=n,o.push(a)}},e._addPath=function(){var t=this.pathLength,e=this.paths[t];return e?e.reset():(e=new Fq,this.paths.push(e)),this.pathLength++,this._curPath=e,e},t}(),kq=eV.concat([new Rr("a_dist",fi.R32F)]),Uq=rV(kq),Gq=oV(kq),Hq=function(e){return t({Graphics:e,GraphicsComponent:e}),e}((Vj=dc("cc.Graphics"),Wj=Ic(),jj=mc(110),qj=Ac(),Xj=Lc(),Yj=Kc(Rj),Kj=Lc(),Qj=Kc(wj),Zj=Lc(),Jj=Lc(),$j=Lc(),tq=Lc(),eq=Dc(),Vj(nq=Wj(nq=jj(nq=qj((hq=uq=function(t){function e(){var e;return(e=t.call(this)||this).impl=null,e.model=null,ct(e,"_lineWidth",rq,ot(e)),ct(e,"_strokeColor",oq,ot(e)),ct(e,"_lineJoin",aq,ot(e)),ct(e,"_lineCap",sq,ot(e)),ct(e,"_fillColor",cq,ot(e)),ct(e,"_miterLimit",lq,ot(e)),e._isDrawing=!1,e._isNeedUploadData=!0,e._graphicsUseSubMeshes=[],e._instanceMaterialType=eW.ADD_COLOR,e.impl=new zq,e}$(e,t);var n=e.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=VO.root.createModel(cT),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){t.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&(VO.root.destroyModel(this.model),this.model=null);var e=this._graphicsUseSubMeshes.length;if(e>0){for(var n=0;n<e;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),t.prototype.onDestroy.call(this)},n.moveTo=function(t,e){this.impl&&this.impl.moveTo(t,e)},n.lineTo=function(t,e){this.impl&&this.impl.lineTo(t,e)},n.bezierCurveTo=function(t,e,n,i,r,o){this.impl&&this.impl.bezierCurveTo(t,e,n,i,r,o)},n.quadraticCurveTo=function(t,e,n,i){this.impl&&this.impl.quadraticCurveTo(t,e,n,i)},n.arc=function(t,e,n,i,r,o){this.impl&&this.impl.arc(t,e,n,i,r,o)},n.ellipse=function(t,e,n,i){this.impl&&this.impl.ellipse(t,e,n,i)},n.circle=function(t,e,n){this.impl&&this.impl.circle(t,e,n)},n.rect=function(t,e,n,i){this.impl&&this.impl.rect(t,e,n,i)},n.roundRect=function(t,e,n,i,r){this.impl&&this.impl.roundRect(t,e,n,i,r)},n.fillRect=function(t,e,n,i){this.rect(t,e,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var t;this._customMaterial?t=this.getMaterialInstance(0):(t=Dv.get("ui-graphics-material"),this.setMaterial(t,0),(t=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(t){if(this.model){if(this.model.subModels.length<=t){var e=u.director.root.device,n=e.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE,65535*Gq,Gq)),i=e.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new GA([n],kq,Fi.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(t,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else M(4500,this.node.name)},n._uploadData=function(){var t=this.impl;if(t){var e=t&&t.getRenderDataList();if(!(e.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<e.length;i++){var r=e[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*Uq);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(t){if(this._isNeedUploadData){if(this.impl){var e=this.impl.getRenderDataList(),n=this.model.subModels.length;if(e.length>n)for(var i=n;i<e.length;i++)this.activeSubModel(i)}this._uploadData()}t.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t)},n._canRender=function(){return!!t.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},Z(e,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}},{key:"lineCap",get:function(){return this._lineCap},set:function(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(t){this._miterLimit=t}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),e}(yj),uq.LineJoin=Rj,uq.LineCap=wj,lt((iq=hq).prototype,"lineWidth",[Mc,Xj],Object.getOwnPropertyDescriptor(iq.prototype,"lineWidth"),iq.prototype),lt(iq.prototype,"lineJoin",[Yj,Kj],Object.getOwnPropertyDescriptor(iq.prototype,"lineJoin"),iq.prototype),lt(iq.prototype,"lineCap",[Qj,Zj],Object.getOwnPropertyDescriptor(iq.prototype,"lineCap"),iq.prototype),lt(iq.prototype,"strokeColor",[Jj],Object.getOwnPropertyDescriptor(iq.prototype,"strokeColor"),iq.prototype),lt(iq.prototype,"fillColor",[$j],Object.getOwnPropertyDescriptor(iq.prototype,"fillColor"),iq.prototype),lt(iq.prototype,"miterLimit",[tq],Object.getOwnPropertyDescriptor(iq.prototype,"miterLimit"),iq.prototype),lt(iq.prototype,"color",[ol,eq],Object.getOwnPropertyDescriptor(iq.prototype,"color"),iq.prototype),rq=lt(iq.prototype,"_lineWidth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oq=lt(iq.prototype,"_strokeColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.BLACK.clone()}}),aq=lt(iq.prototype,"_lineJoin",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rj.MITER}}),sq=lt(iq.prototype,"_lineCap",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wj.BUTT}}),cq=lt(iq.prototype,"_fillColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),lq=lt(iq.prototype,"_miterLimit",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),nq=iq))||nq)||nq)||nq)||nq));u.Graphics=Hq;var Vq,Wq=new Vn,jq=new Xn,qq=new Vn,Xq=[];!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(Vq||(Vq={})),ce(Vq);var Yq=function(e){return t({Mask:e,MaskComponent:e}),e}((fq=dc("cc.Mask"),pq=Ic(),dq=mc(110),_q=Ac(),mq=Kc(Vq),vq=Lc(),gq=Gc(),yq=Lc(),xq=Dc(),Sq=Kc(cH),Tq=Dc(),Eq=Dc(),bq=Bc(),Cq=Dc(),Aq=Dc(),fq(wq=pq(wq=dq(wq=_q((Lq=Nq=function(t){function e(){var e;return(e=t.call(this)||this)._clearStencilMtl=null,e._clearModel=null,ct(e,"_type",Pq,ot(e)),ct(e,"_inverted",Iq,ot(e)),ct(e,"_segments",Mq,ot(e)),ct(e,"_spriteFrame",Dq,ot(e)),ct(e,"_alphaThreshold",Oq,ot(e)),e._graphics=null,e._clearModelMesh=null,e._instanceMaterialType=eW.ADD_COLOR,e}$(e,t);var n=e.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),t.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){t.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(VO.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),t.prototype.onDestroy.call(this)},n.isHit=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=n.width,r=n.height,o=jq;this.node.getWorldMatrix(Wq),Vn.invert(qq,Wq),Xn.transformMat4(o,t,qq);var a=e.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===Vq.RECT||this.type===Vq.GRAPHICS_STENCIL||this.type===Vq.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===Vq.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(t){t.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(t){this._postAssembler&&t.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(e){t.prototype._nodeStateChange.call(this,e),this._updateGraphics()},n._canRender=function(){return!!t.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==Vq.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this),n=e.PostAssembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var t=this._graphics=new Hq;t._objFlags|=dl.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;var e=An.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===Vq.RECT||this._type===Vq.ELLIPSE)){var t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();var n=t.contentSize,i=n.width,r=n.height,o=t.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===Vq.RECT)e.rect(a,s,i,r);else if(this._type===Vq.ELLIPSE){for(var c=function(t,e,n){Xq.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)Xq.push(new Rn(e.x*Math.cos(i*r)+t.x,e.y*Math.sin(i*r)+t.y,0));return Xq}(new Rn(a+i/2,s+r/2,0),new Rn(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?e.moveTo(u.x,u.y):e.lineTo(u.x,u.y)}e.close()}e.fill()}},n._createClearModel=function(){if(!this._clearModel){var t=Dv.get("default-clear-stencil");this._clearStencilMtl=new mT({parent:t,owner:this,subModelIdx:0}),this._clearModel=VO.root.createModel(cT),this._clearModel.node=this._clearModel.transform=this.node;var e=oV(tV),n=u.director.root.device,i=n.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE,4*e,e)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var o=n.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new GA([i],tV,Fi.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var t,e=this._graphics;e.stencilStage=xV.DISABLED,this._type===Vq.IMAGE_STENCIL?(t=Dv.get("ui-alpha-test-material"),e.setMaterial(t,0),(t=e.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(t=Dv.get("ui-graphics-material"),e.setMaterial(t,0),e.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==Vq.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},Z(e,[{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==Vq.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(t){this._inverted=t,this.stencilStage=xV.DISABLED,this._graphics&&(this._graphics.stencilStage=xV.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(t){this._segments!==t&&(this._segments=sn(t,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this._type===Vq.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===Vq.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),e}(yj),Nq.Type=Vq,lt((Rq=Lq).prototype,"type",[mq,vq],Object.getOwnPropertyDescriptor(Rq.prototype,"type"),Rq.prototype),lt(Rq.prototype,"inverted",[gq,yq],Object.getOwnPropertyDescriptor(Rq.prototype,"inverted"),Rq.prototype),lt(Rq.prototype,"segments",[xq],Object.getOwnPropertyDescriptor(Rq.prototype,"segments"),Rq.prototype),lt(Rq.prototype,"spriteFrame",[Sq,Tq],Object.getOwnPropertyDescriptor(Rq.prototype,"spriteFrame"),Rq.prototype),lt(Rq.prototype,"alphaThreshold",[Eq,bq,Uc],Object.getOwnPropertyDescriptor(Rq.prototype,"alphaThreshold"),Rq.prototype),lt(Rq.prototype,"color",[ol,Cq],Object.getOwnPropertyDescriptor(Rq.prototype,"color"),Rq.prototype),lt(Rq.prototype,"customMaterial",[ol,Aq],Object.getOwnPropertyDescriptor(Rq.prototype,"customMaterial"),Rq.prototype),Pq=lt(Rq.prototype,"_type",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vq.RECT}}),Iq=lt(Rq.prototype,"_inverted",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mq=lt(Rq.prototype,"_segments",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Dq=lt(Rq.prototype,"_spriteFrame",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oq=lt(Rq.prototype,"_alphaThreshold",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),wq=Rq))||wq)||wq)||wq)||wq));wI._maskComp=Yq,u.Mask=Yq;var Kq,Qq,Zq,Jq,$q,tX,eX,nX,iX,rX,oX,aX,sX,cX,lX,uX,hX,fX,pX,dX,_X,mX,vX,gX,yX,xX,SX,TX,EX,bX,CX,AX,wX,RX,PX,IX,MX,DX,OX,NX,LX,BX,FX,zX,kX,UX,GX,HX,VX,WX,jX,qX,XX,YX,KX,QX,ZX,JX,$X,tY,eY,nY,iY=/^(click)(\s)*=|(param)(\s)*=/,rY=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,oY=t("HtmlTextParser",function(){function t(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var e=t.prototype;return e.parse=function(t){this._resultObjectArray.length=0,this._stack.length=0;for(var e=0,n=t.length;e<n;){var i=t.indexOf(">",e),r=-1;if(i>=0&&(r=t.lastIndexOf("<",i))<e-1&&(r=t.indexOf("<",i+1),i=t.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(t.substring(e)),e=n;else{var o=t.substring(e,r),a=t.substring(r+1,i);""===a&&(o=t.substring(e,i+1)),this._processResult(o),-1===i?i=r:"/"===t.charAt(r+1)?this._stack.pop():this._addToStack(a),e=i+1}}return this._resultObjectArray},e._attributeToObject=function(t){t=t.trim();var e={},n=/^(color|size)(\s)*=/.exec(t),i="",r=0,o="";if(n){if(i=n[0],""===(t=t.substring(i.length).trim()))return e;switch(r=t.indexOf(" "),i[0]){case"c":e.color=r>-1?t.substring(0,r).trim():t;break;case"s":e.size=parseInt(t)}return r>-1&&(o=t.substring(r+1).trim(),e.event=this._processEventHandler(o)),e}if((n=/^(br(\s)*\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=rY.exec(t);for(var c=!1;n;){if(i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}e.isImage=!0,e.src=s}else if("height"===i)e.imageHeight=parseInt(s);else if("width"===i)e.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}e.imageAlign=s.toLowerCase()}else"offset"===i?e.imageOffset=s:"click"===i&&(e.event=this._processEventHandler(i+"="+s));e.event&&"param"===i&&(e.event[i]=s.replace(/^"|"$/g,"")),n=rY.exec(t)}return c&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(t)){var l={color:"#ffffff",width:1};if(t=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(t);n;)i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),"click"===i?e.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),e.event&&"param"===i&&(e.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(t)}e.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(t))&&n[0].length>0){switch(i=n[0],t=t.substring(i.length).trim(),i[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e},e._processEventHandler=function(t){for(var e={},n=0,i=!1,r=iY.exec(t);r;){var o=r[0],a="";if(i=!1,'"'===(t=t.substring(o.length).trim()).charAt(0))(n=t.indexOf('"',1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else if("'"===t.charAt(0))(n=t.indexOf("'",1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(t);n=(a=s?s[0]:"").length}i&&(e[o=o.substring(0,o.length-1).trim()]=a),t=t.substring(n).trim(),r=iY.exec(t)}return e},e._addToStack=function(t){var e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)e[i]||(e[i]=n[i]);this._stack.push(e)}},e._processResult=function(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))},e._escapeSpecialSymbol=function(t){for(var e,n=st(this._specialSymbolArray);!(e=n()).done;){var i=e.value,r=i[0],o=i[1];t=t.replace(r,o)}return t},t}()),aY=function(e){return t({LabelOutline:e,LabelOutlineComponent:e}),e}((Kq=dc("cc.LabelOutline"),Qq=Ic(),Zq=mc(110),Jq=Ac(),$q=_c(xj),tX=Lc(),eX=Lc(),Kq(nX=Qq(nX=Zq(nX=Jq(nX=$q(nX=Cc((aX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_color",rX,ot(e)),ct(e,"_width",oX,ot(e)),e}$(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(xj);t&&t.updateRenderData(!0)},Z(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._width=t,this._updateRenderData())}}]),e}($u),rX=lt((iX=aX).prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(0,0,0,255)}}),oX=lt(iX.prototype,"_width",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),lt(iX.prototype,"color",[tX],Object.getOwnPropertyDescriptor(iX.prototype,"color"),iX.prototype),lt(iX.prototype,"width",[eX],Object.getOwnPropertyDescriptor(iX.prototype,"width"),iX.prototype),nX=iX))||nX)||nX)||nX)||nX)||nX)||nX));u.LabelOutline=aY,function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}($X||($X={})),ce($X),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(tY||(tY={})),ce(tY),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(eY||(eY={})),ce(eY),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(nY||(nY={}));var sY,cY=function(e){return t({Sprite:e,SpriteComponent:e}),e}((sX=dc("cc.Sprite"),cX=Ic(),lX=mc(110),uX=Ac(),hX=Kc(uH),fX=Gc(),pX=Lc(),dX=Kc(cH),_X=Gc(),mX=Lc(),vX=Kc($X),gX=Gc(),yX=Lc(),xX=Kc(tY),SX=Gc(),TX=Lc(),EX=Gc(),bX=Lc(),CX=Bc(),AX=Gc(),wX=Lc(),RX=Bc(),PX=Gc(),IX=Lc(),MX=Dc(),DX=Gc(),OX=Lc(),NX=Gc(),LX=Lc(),BX=Kc(eY),FX=Gc(),zX=Lc(),sX(kX=cX(kX=lX(kX=uX((JX=ZX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_spriteFrame",GX,ot(e)),ct(e,"_type",HX,ot(e)),ct(e,"_fillType",VX,ot(e)),ct(e,"_sizeMode",WX,ot(e)),ct(e,"_fillCenter",jX,ot(e)),ct(e,"_fillStart",qX,ot(e)),ct(e,"_fillRange",XX,ot(e)),ct(e,"_isTrimmedMode",YX,ot(e)),ct(e,"_useGrayscale",KX,ot(e)),ct(e,"_atlas",QX,ot(e)),e}$(e,t);var n=e.prototype;return n.__preload=function(){this.changeMaterialForDefine(),t.prototype.__preload.call(this)},n.onEnable=function(){t.prototype.onEnable.call(this),this._activateMaterial();var e=this._spriteFrame;e&&(this._updateUVs(),this._type===$X.SLICED&&e.on(cH.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===$X.SLICED&&this._spriteFrame.off(cH.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){t.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(t){if(this._atlas){var e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var t,e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);var n=!1;if(t instanceof Jm){var i=t.getPixelFormat();n=i===Mm.RGBA_ETC1||i===Mm.RGB_A_PVRTC_4BPPV1||i===Mm.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=eW.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=eW.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=eW.GRAYSCALE:this._instanceMaterialType=eW.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var e=t.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof kS){var n=J({SAMPLE_FROM_RT:!0},e.passes[0].defines),i=new cg;i.initialize({effectAsset:e.effectAsset,defines:n}),e=i}return e},n._render=function(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!t.prototype._canRender.call(this))return!1;var e=this._spriteFrame;return!(!e||!e.texture)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===$X.SLICED?this._spriteFrame.on(cH.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(cH.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(eY.RAW===this._sizeMode){var t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(eY.TRIMMED===this._sizeMode){var e=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(t){var e=this._spriteFrame;t&&this._type===$X.SLICED&&t.off(cH.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;e&&(t&&t.texture===e.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===$X.SLICED&&e.on(cH.EVENT_UV_UPDATED,this._updateUVs,this))},Z(e,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(t){this._atlas!==t&&(this._atlas=t)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}}},{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(t){this._fillType!==t&&(t===tY.RADIAL||this._fillType===tY.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===$X.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(t){this._fillStart=sn(t,0,1),this._type===$X.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(t){this._fillRange=sn(t,-1,1),this._type===$X.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===$X.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(t){this._useGrayscale!==t&&(this._useGrayscale=t,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,t!==eY.CUSTOM&&this._applySpriteSize())}}]),e}(yj),ZX.FillType=tY,ZX.Type=$X,ZX.SizeMode=eY,ZX.EventType=nY,lt((UX=JX).prototype,"spriteAtlas",[hX,fX,pX],Object.getOwnPropertyDescriptor(UX.prototype,"spriteAtlas"),UX.prototype),lt(UX.prototype,"spriteFrame",[dX,_X,mX],Object.getOwnPropertyDescriptor(UX.prototype,"spriteFrame"),UX.prototype),lt(UX.prototype,"type",[vX,gX,yX],Object.getOwnPropertyDescriptor(UX.prototype,"type"),UX.prototype),lt(UX.prototype,"fillType",[xX,SX,TX],Object.getOwnPropertyDescriptor(UX.prototype,"fillType"),UX.prototype),lt(UX.prototype,"fillCenter",[EX,bX],Object.getOwnPropertyDescriptor(UX.prototype,"fillCenter"),UX.prototype),lt(UX.prototype,"fillStart",[CX,AX,wX],Object.getOwnPropertyDescriptor(UX.prototype,"fillStart"),UX.prototype),lt(UX.prototype,"fillRange",[RX,PX,IX],Object.getOwnPropertyDescriptor(UX.prototype,"fillRange"),UX.prototype),lt(UX.prototype,"trim",[MX,DX,OX],Object.getOwnPropertyDescriptor(UX.prototype,"trim"),UX.prototype),lt(UX.prototype,"grayscale",[Mc,NX,LX],Object.getOwnPropertyDescriptor(UX.prototype,"grayscale"),UX.prototype),lt(UX.prototype,"sizeMode",[BX,FX,zX],Object.getOwnPropertyDescriptor(UX.prototype,"sizeMode"),UX.prototype),GX=lt(UX.prototype,"_spriteFrame",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HX=lt(UX.prototype,"_type",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $X.SIMPLE}}),VX=lt(UX.prototype,"_fillType",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tY.HORIZONTAL}}),WX=lt(UX.prototype,"_sizeMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eY.TRIMMED}}),jX=lt(UX.prototype,"_fillCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(0,0)}}),qX=lt(UX.prototype,"_fillStart",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XX=lt(UX.prototype,"_fillRange",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YX=lt(UX.prototype,"_isTrimmedMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),KX=lt(UX.prototype,"_useGrayscale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QX=lt(UX.prototype,"_atlas",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kX=UX))||kX)||kX)||kX)||kX));u.Sprite=cY;var lY,uY,hY,fY,pY,dY,_Y,mY,vY,gY,yY,xY,SY,TY,EY,bY,CY,AY,wY,RY,PY,IY,MY,DY,OY,NY,LY,BY,FY,zY,kY,UY,GY,HY,VY,WY,jY,qY,XY,YY,KY,QY,ZY,JY,$Y,tK,eK,nK,iK,rK=t("RenderRoot2D",dc("cc.RenderRoot2D")(sY=mc(100)(sY=Ac()(sY=_c(LV)(sY=vc(sY=Cc(sY=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.onEnable=function(){u.director.root.batcher2D.addScreen(this)},n.onDisable=function(){u.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){u.director.root.batcher2D.removeScreen(this)},e}($u))||sY)||sY)||sY)||sY)||sY)||sY),oK=new Rn,aK=oe({OVERLAY:0,INTERSPERSE:1}),sK=function(e){return t({Canvas:e,CanvasComponent:e}),e}((lY=dc("cc.Canvas"),uY=Ic(),hY=mc(100),fY=Ac(),pY=Kc(iF),dY=Lc(),_Y=Lc(),mY=Kc(iF),lY(vY=uY(vY=hY(vY=fY(vY=Cc(vY=vc((lt((gY=function(t){function e(){var e;return ct(e=t.call(this)||this,"_cameraComponent",yY,ot(e)),ct(e,"_alignCanvasWithScreen",xY,ot(e)),e._thisOnCameraResized=void 0,e._fitDesignResolution=void 0,e._pos=new Rn,e._renderMode=aK.OVERLAY,e._thisOnCameraResized=e._onResizeCamera.bind(ot(e)),e}$(e,t);var n=e.prototype;return n.__preload=function(){var t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(iF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(HE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){t.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(iF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){t.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(iF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){t.prototype.onDestroy.call(this),this.node.off(HE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=qO.height/2;else{var t=ch.windowSize;this._cameraComponent.orthoHeight=t.height/$O.getScaleY()/2}this.node.getWorldPosition(oK),this._cameraComponent.node.setWorldPosition(oK.x,oK.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var t,e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return this._renderMode===aK.OVERLAY?e|1<<30:e&~(1<<30)}return 0},Z(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}}]),e}(rK)).prototype,"cameraComponent",[pY,dY],Object.getOwnPropertyDescriptor(gY.prototype,"cameraComponent"),gY.prototype),lt(gY.prototype,"alignCanvasWithScreen",[_Y],Object.getOwnPropertyDescriptor(gY.prototype,"alignCanvasWithScreen"),gY.prototype),yY=lt(gY.prototype,"_cameraComponent",[mY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xY=lt(gY.prototype,"_alignCanvasWithScreen",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),vY=gY))||vY)||vY)||vY)||vY)||vY)||vY));u.Canvas=sK,G(t("UIComponent",dc("cc.UIComponent")(SY=_c(LV)(SY=mc(110)(SY=vc(SY=Cc(SY=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastParent=null,e.stencilStage=xV.DISABLED,e}$(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},e}($u))||SY)||SY)||SY)||SY)||SY).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),U(sK.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearFlags=t)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:An.BLACK},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearColor=t)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.priority=t)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.targetTexture=t)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),H(yj.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),H(LV.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),u.UITransformComponent=LV,ie.setClassAlias(LV,"cc.UITransformComponent"),ie.setClassAlias(yj,"cc.RenderComponent"),u.CanvasComponent=sK,ie.setClassAlias(sK,"cc.CanvasComponent");var cK=new oY,lK="RICHTEXT_CHILD",uK="RICHTEXT_Image_CHILD",hK=new ee((function(t){if(!u.isValid(t.node))return!1;var e=t.node.getComponent(aY);return e&&(e.width=0),!0}),20),fK=new ee((function(t){return u.isValid(t.node)}),10);function pK(t){return{node:new WC(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function dK(t,e){var n;t===lK?n=hK._get():t===uK&&(n=fK._get());var i=(n=n||pK(t)).node;return i||(i=new WC(t)),i.hideFlags|=dl.Flags.DontSave|dl.Flags.HideInHierarchy,t===uK?(n.comp=i.getComponent(cY)||i.addComponent(cY),n.comp.spriteFrame=e,n.comp.type=cY.Type.SLICED,n.comp.sizeMode=cY.SizeMode.CUSTOM):(n.comp=i.getComponent(xj)||i.addComponent(xj),n.comp.string=e,n.comp.horizontalAlign=_j.LEFT,n.comp.verticalAlign=mj.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var _K,mK=function(e){return t({RichText:e,RichTextComponent:e}),e}((TY=dc("cc.RichText"),EY=Ic(),bY=mc(110),CY=Ac(),AY=Lc(),wY=Kc(_j),RY=Lc(),PY=Lc(),IY=Lc(),MY=Kc(_H),DY=Lc(),OY=Lc(),NY=Gc(),LY=Kc(gj),BY=Lc(),FY=Lc(),zY=Lc(),kY=Kc(uH),UY=Lc(),GY=Lc(),TY(HY=EY(HY=bY(HY=CY(HY=Cc((iK=nK=function(t){function e(){var e;return ct(e=t.call(this)||this,"_lineHeight",WY,ot(e)),ct(e,"_string",jY,ot(e)),ct(e,"_horizontalAlign",qY,ot(e)),ct(e,"_fontSize",XY,ot(e)),ct(e,"_maxWidth",YY,ot(e)),ct(e,"_fontFamily",KY,ot(e)),ct(e,"_font",QY,ot(e)),ct(e,"_isSystemFontUsed",ZY,ot(e)),ct(e,"_userDefinedFont",JY,ot(e)),ct(e,"_cacheMode",$Y,ot(e)),ct(e,"_imageAtlas",tK,ot(e)),ct(e,"_handleTouchEvent",eK,ot(e)),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}$(e,t);var n=e.prototype;return n.onLoad=function(){this.node.on(HE.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(HE.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var t,e=st(this._segments);!(t=e()).done;){var n=t.value;n.node.removeFromParent(),n.type===lK?hK.put(n):n.type===uK&&fK.put(n)}this.node.off(HE.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(HE.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(HE.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(HE.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var t=this;this._segments.forEach((function(e){t._applyTextAttribute(e)}))},n._createFontLabel=function(t){return dK(lK,t)},n._createImage=function(t){return dK(uK,t)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(t,e){var n=this,i=function(e){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(e),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(xj).string=e,i.styleIndex=t,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return e?i(e):i},n._onTouchEnded=function(t){for(var e,n=this,i=this.node.getComponents($u),r=function(){var r=e.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,t.touch.getUILocation())&&(i.forEach((function(e){var n=e[o];e.enabledInHierarchy&&n&&n.call(e,t,a)})),t.propagationStopped=!0)},o=st(this._segments);!(e=o()).done;)r()},n._containsTouchLocation=function(t,e){var n=t.node.getComponent(LV);return!!n&&n.getBoundingBoxToWorld().contains(e)},n._resetState=function(){for(var t=this.node.children,e=t.length-1;e>=0;e--){var n=t[e];if(n.name===lK||n.name===uK){n.parent===this.node?n.parent=null:t.splice(e,1);var i=pK(n.name);i.node=n,n.name===lK?(i.comp=n.getComponent(xj),hK.put(i)):(i.comp=n.getComponent(cY),fK.put(i))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(t){for(var e=this.node.children.length-1;e>=0;e--){var n=this.node.children[e];n.name!==lK&&n.name!==uK||(n.active=t)}},n._addLabelSegment=function(t,e){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(t);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(xj);i&&(i.string=t)}return n.styleIndex=e,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(t,e,n){var i=e;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(t,r,t.length),a=t.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=t.substr(0,r);this._addLabelSegment(c,n),t=t.substr(r,t.length),i=this._measureText(n,t)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=jH(t,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],f=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=f.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(t,n)},n._isLastComponentCR=function(t){return t.length-1===t.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(var e=0;e<this._textArray.length;e++){var n=this._textArray[e],i=t[e];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(t){if(t.style){var e=t.style,n=e.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,e.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.imageOffset&&(r.imageOffset=e.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=e.imageWidth||0,u=e.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=e.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else M(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var t=cK.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();for(var e,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(c,i),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+MH)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(t,e,n){var i=t.charAt(e);if(GH(i)||HH(i))return 1;for(var r=1,o=e+1;o<n&&!HH(i=t.charAt(o))&&!GH(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var t=0,e=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>e&&(t=0,e=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case _j.LEFT:break;case _j.CENTER:l-=this._linesWidth[c-1]/2;break;case _j.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(t+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===e&&(t+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(cY)){var h=s.node.position.clone(),f=this._lineHeight,p=this._lineHeight*(1+MH);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=f+(p-f)/2;break;case.5:h.y+=p/2;break;default:h.y+=(p-f)/2}if(s.imageOffset){var d=s.imageOffset.split(",");if(1===d.length&&d[0]){var _=parseFloat(d[0]);Number.isInteger(_)&&(h.y+=_)}else if(2===d.length){var m=parseFloat(d[0]),v=parseFloat(d[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(aY);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(t){var e=t.toUpperCase();return An[e]?An[e]:(new An).fromHEX(t)},n._applyTextAttribute=function(t){var e=t.node.getComponent(xj);if(e){this._resetLabelState(e);var n,i=t.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(e.color=this._convertLiteralColorValue(n.color||"white"),e.isBold=!!n.bold,e.isItalic=!!n.italic,e.isUnderline=!!n.underline,n.outline){var r=t.node.getComponent(aY);r||(r=t.node.addComponent(aY)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}e.fontSize=n.size||this._fontSize,t.clickHandler="",t.clickParam="";var o=n.event;o&&(t.clickHandler=o.click||"",t.clickParam=o.param||"")}e.cacheMode=this._cacheMode,this._font instanceof _H&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);var a=e._assembler;a&&a.updateRenderData(e)}},n._applyLayer=function(){for(var t,e=st(this._segments);!(t=e()).done;)t.value.node.layer=this.node.layer},n._resetLabelState=function(t){t.fontSize=this._fontSize,t.color=An.WHITE,t.isBold=!1,t.isItalic=!1,t.isUnderline=!1},Z(e,[{key:"string",get:function(){return this._string},set:function(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),e}($u),nK.HorizontalAlign=_j,nK.VerticalAlign=mj,lt((VY=iK).prototype,"string",[Vc,AY],Object.getOwnPropertyDescriptor(VY.prototype,"string"),VY.prototype),lt(VY.prototype,"horizontalAlign",[wY,RY],Object.getOwnPropertyDescriptor(VY.prototype,"horizontalAlign"),VY.prototype),lt(VY.prototype,"fontSize",[PY],Object.getOwnPropertyDescriptor(VY.prototype,"fontSize"),VY.prototype),lt(VY.prototype,"fontFamily",[IY],Object.getOwnPropertyDescriptor(VY.prototype,"fontFamily"),VY.prototype),lt(VY.prototype,"font",[MY,DY],Object.getOwnPropertyDescriptor(VY.prototype,"font"),VY.prototype),lt(VY.prototype,"useSystemFont",[OY,NY],Object.getOwnPropertyDescriptor(VY.prototype,"useSystemFont"),VY.prototype),lt(VY.prototype,"cacheMode",[LY,BY],Object.getOwnPropertyDescriptor(VY.prototype,"cacheMode"),VY.prototype),lt(VY.prototype,"maxWidth",[FY],Object.getOwnPropertyDescriptor(VY.prototype,"maxWidth"),VY.prototype),lt(VY.prototype,"lineHeight",[zY],Object.getOwnPropertyDescriptor(VY.prototype,"lineHeight"),VY.prototype),lt(VY.prototype,"imageAtlas",[kY,UY],Object.getOwnPropertyDescriptor(VY.prototype,"imageAtlas"),VY.prototype),lt(VY.prototype,"handleTouchEvent",[GY],Object.getOwnPropertyDescriptor(VY.prototype,"handleTouchEvent"),VY.prototype),WY=lt(VY.prototype,"_lineHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),jY=lt(VY.prototype,"_string",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),qY=lt(VY.prototype,"_horizontalAlign",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _j.LEFT}}),XY=lt(VY.prototype,"_fontSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),YY=lt(VY.prototype,"_maxWidth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KY=lt(VY.prototype,"_fontFamily",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),QY=lt(VY.prototype,"_font",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZY=lt(VY.prototype,"_isSystemFontUsed",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JY=lt(VY.prototype,"_userDefinedFont",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$Y=lt(VY.prototype,"_cacheMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gj.NONE}}),tK=lt(VY.prototype,"_imageAtlas",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eK=lt(VY.prototype,"_handleTouchEvent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HY=VY))||HY)||HY)||HY)||HY)||HY));u.RichText=mK;var vK=function(e){return t({UIMeshRenderer:e,UIModelComponent:e}),e}(dc("cc.UIMeshRenderer")(_K=Ic()(_K=mc(110)(_K=Ac()(_K=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._models=null,e._modelComponent=null,e.stencilStage=xV.DISABLED,e}$(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(t){if(this._models){this._modelComponent._detachFromScene();for(var e,n=st(this._models);!(e=n()).done;){var i=e.value;t.commitModel.call(t,this,i,this._modelComponent.material)}return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var t=this._modelComponent.sharedMaterials.length,e=0;e<t;e++){var n=this._modelComponent.getMaterialInstance(e);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=Fd.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},Z(e,[{key:"modelComponent",get:function(){return this._modelComponent}}]),e}($u))||_K)||_K)||_K)||_K);u.UIMeshRenderer=vK;var gK,yK,xK,SK,TK,EK,bK,CK,AK,wK,RK,PK,IK,MK,DK,OK,NK,LK,BK,FK,zK,kK,UK,GK,HK,VK,WK,jK,qK,XK=Ld.Enum.NONE|Ld.Enum.UI_3D,YK=t("UIDrawBatch",function(){function t(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=XK,this._inputAssembler=null,this._descriptorSet=null}var e=t.prototype;return e.destroy=function(){this._passes=[]},e.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=XK,this.renderScene=null},e.fillPasses=function(t,e,n,i,r,o){if(t){var a=t.passes;if(!a)return;var s=0;this._shaders.length=a.length;for(var c=0;c<a.length;c++){this._passes[c]||(this._passes[c]=new kv(u.director.root));var l=a[c],h=this._passes[c];l.update(),e||(e=l.depthStencilState,n=0),i||(i=l.blendState,r=0),-1===r&&(r=0),s=n<<16|r,h._initPassFromTarget(l,e,i,s),this._shaders[c]=h.getShaderVariant(o)}}},Z(t,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(t){this._inputAssembler=t}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(t){this._descriptorSet=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),t}()),KK=function(e){return t({UIStaticBatch:e,UIStaticBatchComponent:e}),e}((gK=dc("cc.UIStaticBatch"),yK=Ic(),xK=Ac(),SK=mc(110),TK=Dc(),gK(EK=yK(EK=xK(EK=SK((lt((bK=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._init=!1,e._bufferAccessor=null,e._dirty=!0,e._uiDrawBatchList=[],e}$(e,t);var n=e.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var t=new YK;return t.isStatic=!0,this._uiDrawBatchList.push(t),t},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var t=this._getBatcher(),e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return VO.root&&VO.root.batcher2D?VO.root.batcher2D:(M(9301),null)},Z(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),e}(yj)).prototype,"color",[ol,TK],Object.getOwnPropertyDescriptor(bK.prototype,"color"),bK.prototype),EK=bK))||EK)||EK)||EK)||EK)),QK=t("LabelShadow",(CK=dc("cc.LabelShadow"),AK=Ic(),wK=mc(110),RK=Ac(),PK=_c(xj),IK=Lc(),MK=Lc(),DK=Lc(),CK(OK=AK(OK=wK(OK=RK(OK=PK(OK=Cc((zK=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_color",LK,ot(e)),ct(e,"_offset",BK,ot(e)),ct(e,"_blur",FK,ot(e)),e}$(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(xj);t&&t.updateRenderData(!0)},Z(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(t){this._blur=t,this._updateRenderData()}}]),e}($u),LK=lt((NK=zK).prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(0,0,0,255)}}),BK=lt(NK.prototype,"_offset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(2,2)}}),FK=lt(NK.prototype,"_blur",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),lt(NK.prototype,"color",[IK],Object.getOwnPropertyDescriptor(NK.prototype,"color"),NK.prototype),lt(NK.prototype,"offset",[MK],Object.getOwnPropertyDescriptor(NK.prototype,"offset"),NK.prototype),lt(NK.prototype,"blur",[DK],Object.getOwnPropertyDescriptor(NK.prototype,"blur"),NK.prototype),OK=NK))||OK)||OK)||OK)||OK)||OK)||OK)),ZK=function(e){return t({UIOpacity:e,UIOpacityComponent:e}),e}((kK=dc("cc.UIOpacity"),UK=Ic(),GK=mc(110),HK=Ac(),VK=Lc(),kK(WK=UK(WK=GK(WK=HK(WK=Cc((lt((jK=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_opacity",qK,ot(e)),e}$(e,t);var n=e.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},Z(e,[{key:"opacity",get:function(){return this._opacity},set:function(t){this._opacity!==t&&(t=Te(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}}]),e}($u)).prototype,"opacity",[Mc,VK],Object.getOwnPropertyDescriptor(jK.prototype,"opacity"),jK.prototype),qK=lt(jK.prototype,"_opacity",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),WK=jK))||WK)||WK)||WK)||WK)||WK));u.MaskComponent=Yq,ie.setClassAlias(Yq,"cc.MaskComponent"),u.LabelComponent=xj,ie.setClassAlias(xj,"cc.LabelComponent"),u.LabelOutlineComponent=aY,ie.setClassAlias(aY,"cc.LabelOutlineComponent"),u.RichTextComponent=mK,ie.setClassAlias(mK,"cc.RichTextComponent"),u.SpriteComponent=cY,ie.setClassAlias(cY,"cc.SpriteComponent"),u.UIModelComponent=vK,ie.setClassAlias(vK,"cc.UIModelComponent"),u.GraphicsComponent=Hq,ie.setClassAlias(Hq,"cc.GraphicsComponent"),ie.setClassAlias(KK,"cc.UIStaticBatchComponent"),ie.setClassAlias(ZK,"cc.UIOpacityComponent");var JK=function(t,e,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=n};function $K(t,e,n,i,r){var o=0,a=null;if(r===function(t,e,n,i){for(var r=0,o=e,a=n-i;o<n;o+=i)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}(t,e,n,i)>0)for(o=e;o<n;o+=i)a=vQ(o,t[o],t[o+1],a);else for(o=n-i;o>=e;o-=i)a=vQ(o,t[o],t[o+1],a);return a&&pQ(a,a.next)&&(gQ(a),a=a.next),a}function tQ(t,e){if(void 0===e&&(e=null),!t)return t;e||(e=t);var n=t,i=!1;do{if(i=!1,n.steiner||!pQ(n,n.next)&&0!==fQ(n.prev,n,n.next))n=n.next;else{if(gQ(n),(n=e=n.prev)===n.next)return null;i=!0}}while(i||n!==e);return e}function eQ(t,e,n,i,r,o,a){if(void 0===a&&(a=0),t){!a&&o&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=cQ(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=t,t=null,o=null,a=0;n;){for(a++,i=n,s=0,e=0;e<l&&(s++,i=i.nextZ);e++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(t,i,r,o);for(var s=t,c=null,l=null;t.prev!==t.next;)if(c=t.prev,l=t.next,o?iQ(t,i,r,o):nQ(t))e.push(c.i/n),e.push(t.i/n),e.push(l.i/n),gQ(t),t=l.next,s=l.next;else if((t=l)===s){a?1===a?eQ(t=rQ(t,e,n),e,n,i,r,o,2):2===a&&oQ(t,e,n,i,r,o):eQ(tQ(t),e,n,i,r,o,1);break}}}function nQ(t){var e=t.prev,n=t,i=t.next;if(fQ(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(uQ(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&fQ(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function iQ(t,e,n,i){var r=t.prev,o=t,a=t.next;if(fQ(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=cQ(s,c,e,n,i),f=cQ(l,u,e,n,i),p=t.nextZ;p&&p.z<=f;){if(p!==t.prev&&p!==t.next&&uQ(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&fQ(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(p=t.prevZ;p&&p.z>=h;){if(p!==t.prev&&p!==t.next&&uQ(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&fQ(p.prev,p,p.next)>=0)return!1;p=p.prevZ}return!0}function rQ(t,e,n){var i=t;do{var r=i.prev,o=i.next.next;!pQ(r,o)&&dQ(r,i,i.next,o)&&_Q(r,o)&&_Q(o,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(o.i/n),gQ(i),gQ(i.next),i=t=o),i=i.next}while(i!==t);return i}function oQ(t,e,n,i,r,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&hQ(a,s)){var c=mQ(a,s);return a=tQ(a,a.next),c=tQ(c,c.next),eQ(a,e,n,i,r,o),void eQ(c,e,n,i,r,o)}s=s.next}a=a.next}while(a!==t)}function aQ(t,e){return t.x-e.x}function sQ(t,e){if(e=function(t,e){var n=e,i=t.x,r=t.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,f=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&uQ(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<f||c===f&&n.x>a.x)&&_Q(n,t)&&(a=n,f=c),n=n.next;return a}(t,e)){var n=mQ(e,t);tQ(n,n.next)}}function cQ(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function lQ(t){var e=t,n=t;do{e.x<n.x&&(n=e),e=e.next}while(e!==t);return n}function uQ(t,e,n,i,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(i-s)-(n-a)*(e-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function hQ(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&dQ(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&_Q(t,e)&&_Q(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)}function fQ(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function pQ(t,e){return t.x===e.x&&t.y===e.y}function dQ(t,e,n,i){return!!(pQ(t,e)&&pQ(n,i)||pQ(t,i)&&pQ(n,e))||fQ(t,e,n)>0!=fQ(t,e,i)>0&&fQ(n,i,t)>0!=fQ(n,i,e)>0}function _Q(t,e){return fQ(t.prev,t,t.next)<0?fQ(t,e,t.next)>=0&&fQ(t,t.prev,e)>=0:fQ(t,e,t.prev)<0||fQ(t,t.next,e)<0}function mQ(t,e){var n=new JK(t.i,t.x,t.y),i=new JK(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function vQ(t,e,n,i){var r=new JK(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function gQ(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function yQ(t,e,n){n=n||3;var i=e?e.length:0,r=i?e[0]*n:t.length,o=$K(t,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,f=0,p=0;if(i&&(o=function(t,e,n,i){var r,o=[],a=0,s=null;for(a=0,r=e.length;a<r;a++)(s=$K(t,e[a]*i,a<r-1?e[a+1]*i:t.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(lQ(s)));if(o.sort(aQ),!n)return n;for(a=0;a<o.length;a++)sQ(o[a],n),n=tQ(n,n.next);return n}(t,e,o,n)),t.length>80*n){s=l=t[0],c=u=t[1];for(var d=n;d<r;d+=n)(h=t[d])<s&&(s=h),(f=t[d+1])<c&&(c=f),h>l&&(l=h),f>u&&(u=f);p=Math.max(l-s,u-c)}return eQ(o,a,n,s,c,p),a}for(var xQ=Math.PI,SQ=Math.min,TQ=Math.max,EQ=Math.ceil,bQ=Math.acos,CQ=Math.cos,AQ=Math.sin,wQ=Math.atan2,RQ=null,PQ=null,IQ=new An,MQ=[],DQ=0;DQ<4;DQ++)MQ.push(new Rn);function OQ(t,e,n){return t<e?e:t>n?n:t}var NQ={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(t,e){if(!PQ)return null;var n=PQ.getRenderDataList(),i=n[PQ.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+e:0;return(o>65535||3*o>131070)&&(++PQ.dataOffset,PQ.dataOffset<n.length?i=n[PQ.dataOffset]:(i=PQ.requestRenderData(),n[PQ.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(e,3*e),i},stroke:function(t){An.copy(IQ,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill:function(t){An.copy(IQ,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end:function(t){t.markForUpdateRenderData()},_expandStroke:function(t){var e=.5*t.lineWidth,n=t.lineCap,i=t.lineJoin,r=t.miterLimit;if(PQ=t.impl){var o=function(t,e,n){var i=2*bQ(t/(t+n));return TQ(2,EQ(e/i))}(e,xQ,PQ.tessTol);this._calculateJoins(PQ,e,i,r);for(var a=PQ.paths,s=0,c=PQ.pathOffset,l=PQ.pathLength;c<l;c++){var u=a[c],h=u.points.length;i===Rj.ROUND?s+=2*(h+u.bevel*(o+2)+1):s+=2*(h+5*u.bevel+1),u.closed||(n===wj.ROUND?s+=2*(2*o+2):s+=12)}var f=RQ=this.getRenderData(t,s);if(f){for(var p=f.vData,d=f.iData,_=PQ.pathOffset,m=PQ.pathLength;_<m;_++){var v=a[_],g=v.points,y=g.length,x=f.vertexStart,S=void 0,T=void 0,E=0,b=0,C=v.closed;if(C?(S=g[y-1],T=g[0],E=0,b=y):(S=g[0],T=g[1],E=1,b=y-1),T=T||S,!C){var A=new Bq(T.x,T.y);A.subtract(S),A.normalize();var w=A.x,R=A.y;n===wj.BUTT?this._buttCapStart(S,w,R,e,0):n===wj.SQUARE?this._buttCapStart(S,w,R,e,e):n===wj.ROUND&&this._roundCapStart(S,w,R,e,o)}for(var P=E;P<b;++P)i===Rj.ROUND?this._roundJoin(S,T,e,e,o):0!=(T.flags&(Pj.PT_BEVEL|Pj.PT_INNERBEVEL))?this._bevelJoin(S,T,e,e):(this._vSet(T.x+T.dmx*e,T.y+T.dmy*e,1),this._vSet(T.x-T.dmx*e,T.y-T.dmy*e,-1)),S=T,T=g[P+1];if(C){var I=8*x;this._vSet(p[I],p[I+1],1),this._vSet(p[I+8],p[I+8+1],-1)}else{var M=new Bq(T.x,T.y);M.subtract(S),M.normalize();var D=M.x,O=M.y;n===wj.BUTT?this._buttCapEnd(T,D,O,e,0):n===wj.SQUARE?this._buttCapEnd(T,D,O,e,e):n===wj.ROUND&&this._roundCapEnd(T,D,O,e,o)}for(var N=f.indexStart,L=x+2,B=f.vertexStart;L<B;L++)d[N++]=L-2,d[N++]=L-1,d[N++]=L;f.indexStart=N}RQ=null,PQ=null}}},_expandFill:function(t){if(PQ=t.impl){for(var e=PQ.paths,n=0,i=PQ.pathOffset,r=PQ.pathLength;i<r;i++)n+=e[i].points.length;var o=RQ=this.getRenderData(t,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=PQ.pathOffset,u=PQ.pathLength;l<u;l++){var h=e[l],f=h.points,p=f.length;if(0!==p){for(var d=o.vertexStart,_=0;_<p;++_)this._vSet(f[_].x,f[_].y);var m=o.indexStart;if(h.complex){for(var v=[],g=d,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=yQ(v,null,3);if(!S||0===S.length)continue;for(var T=0,E=S.length;T<E;T++)c[m++]=S[T]+d}else for(var b=d,C=d+2,A=a.vertexStart;C<A;C++)c[m++]=b,c[m++]=C-1,c[m++]=C;a.indexStart=m}}RQ=null,PQ=null}}},_calculateJoins:function(t,e,n,i){var r=0;e>0&&(r=1/e);for(var o=t.paths,a=t.pathOffset,s=t.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],f=l[0];c.bevel=0;for(var p=0;p<u;p++){var d,_,m=h.dy,v=-h.dx,g=f.dy,y=-f.dx;if(f.dmx=.5*(m+g),f.dmy=.5*(v+y),(d=f.dmx*f.dmx+f.dmy*f.dmy)>1e-6){var x=1/d;x>600&&(x=600),f.dmx*=x,f.dmy*=x}f.dx*h.dy-h.dx*f.dy>0&&(f.flags|=Pj.PT_LEFT),d*(_=TQ(11,SQ(h.len,f.len)*r))*_<1&&(f.flags|=Pj.PT_INNERBEVEL),f.flags&Pj.PT_CORNER&&(d*i*i<1||n===Rj.BEVEL||n===Rj.ROUND)&&(f.flags|=Pj.PT_BEVEL),0!=(f.flags&(Pj.PT_BEVEL|Pj.PT_INNERBEVEL))&&c.bevel++,h=f,f=l[p+1]}}},_flattenPaths:function(t){for(var e=t.paths,n=t.pathOffset,i=t.pathLength;n<i;n++){var r=e[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new Bq(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(t,e,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==t?(a=r+e.dy*i,s=o-e.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(t,e,n,i,r){var o=t.x-e*r,a=t.y-n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(t,e,n,i,r){var o=t.x+e*r,a=t.y+n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(t,e,n,i,r){for(var o=t.x,a=t.y,s=n,c=-e,l=0;l<r;l++){var u=l/(r-1)*xQ,h=CQ(u)*i,f=AQ(u)*i;this._vSet(o-s*h-e*f,a-c*h-n*f,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(t,e,n,i,r){var o=t.x,a=t.y,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*xQ,h=CQ(u)*i,f=AQ(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+e*f,a-c*h+n*f,1)}},_roundJoin:function(t,e,n,i,r){var o=t.dy,a=-t.dx,s=e.dy,c=-e.dx,l=e.x,u=e.y;if(0!=(e.flags&Pj.PT_LEFT)){var h=this._chooseBevel(e.flags&Pj.PT_INNERBEVEL,t,e,n),f=h[0],p=h[1],d=h[2],_=h[3],m=wQ(-a,-o),v=wQ(-c,-s);v>m&&(v-=2*xQ),this._vSet(f,p,1),this._vSet(l-o*i,e.y-a*i,-1);for(var g=OQ(EQ((m-v)/xQ)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+CQ(x)*i,T=u+AQ(x)*i;this._vSet(l,u,0),this._vSet(S,T,-1)}this._vSet(d,_,1),this._vSet(l-s*i,u-c*i,-1)}else{var E=this._chooseBevel(e.flags&Pj.PT_INNERBEVEL,t,e,-i),b=E[0],C=E[1],A=E[2],w=E[3],R=wQ(a,o),P=wQ(c,s);P<R&&(P+=2*xQ),this._vSet(l+o*i,u+a*i,1),this._vSet(b,C,-1);for(var I=OQ(EQ((P-R)/xQ)*r,2,r),M=0;M<I;M++){var D=R+M/(I-1)*(P-R),O=l+CQ(D)*n,N=u+AQ(D)*n;this._vSet(O,N,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(A,w,-1)}},_bevelJoin:function(t,e,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,f=t.dy,p=-t.dx,d=e.dy,_=-e.dx;if(e.flags&Pj.PT_LEFT){var m=this._chooseBevel(e.flags&Pj.PT_INNERBEVEL,t,e,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(e.x-f*i,e.y-p*i,-1),this._vSet(u,h,1),this._vSet(e.x-d*i,e.y-_*i,-1)}else{var v=this._chooseBevel(e.flags&Pj.PT_INNERBEVEL,t,e,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(e.x+f*n,e.y+p*n,1),this._vSet(r,o,-1),this._vSet(e.x+d*n,e.y+_*n,1),this._vSet(a,s,-1)}},_vSet:function(t,e,n){if(void 0===n&&(n=0),RQ){var i=RQ,r=8*i.vertexStart,o=i.vData;o[r++]=t,o[r++]=e,o[r++]=0,An.toArray(o,IQ,r),r+=4,o[r++]=n,i.vertexStart++}}},LQ=t("graphicsAssembler",{getAssembler:function(){return NQ}});Hq.Assembler=LQ;var BQ=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},FQ=new ni,zQ=null,kQ=null,UQ=[],GQ=[],HQ=[],VQ=[],WQ=new ti,jQ=new ti,qQ=new Xn,XQ=null,YQ=0,KQ=0,QQ=0,ZQ=0,JQ=0,$Q=1,tZ=null,eZ="",nZ=0,iZ=0,rZ=0,oZ=0,aZ=0,sZ=0,cZ=0,lZ=!1,uZ=0,hZ=0,fZ=0,pZ={updateRenderData:function(t){t.renderData&&zQ!==t&&(t.renderData.vertDirty&&(kQ=(zQ=t).node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),zQ.actualFontSize=nZ,kQ.setContentSize(jQ),this.updateUVs(t),zQ.renderData.vertDirty=!1,zQ.markForUpdateRenderData(!1),zQ=null,this._resetProperties()),t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame))},updateUVs:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.vertexCount,r=e.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){$Q=nZ/iZ},_updateFontFamily:function(t){var e=t.font;tZ=e.spriteFrame,XQ=e.fntConfig,$H.fontAtlas=e.fontDefDictionary,nH.packToDynamicAtlas(t,tZ)},_updateLabelInfo:function(){$H.hash="",$H.margin=0},_updateProperties:function(t){eZ=t.string.toString(),nZ=t.fontSize,iZ=XQ?XQ.fontSize:t.fontSize,rZ=t.horizontalAlign,oZ=t.verticalAlign,aZ=t.spacingX,cZ=t.overflow,sZ=t._lineHeight;var e=kQ.contentSize;jQ.width=e.width,jQ.height=e.height,cZ===vj.NONE?(lZ=!1,jQ.width+=2*$H.margin,jQ.height+=2*$H.margin):cZ===vj.RESIZE_HEIGHT?(lZ=!0,jQ.height+=2*$H.margin):lZ=t.enableWrapText,$H.lineHeight=sZ,$H.fontSize=nZ,this._setupBMFontOverflowMetrics()},_resetProperties:function(){XQ=null,tZ=null,$H.hash="",$H.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var t=eZ,e=t.length,n=XQ.kerningDict,i=UQ,r=-1,o=0;o<e;++o){var a=t.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<e-1?s:0,r=a}},_multilineTextWrap:function(t){for(var e=eZ.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<e;){var h=eZ.charAt(u);if("\n"!==h){for(var f=t(eZ,u,e),p=s,d=c,_=a,m=i,v=!1,g=0;g<f;++g){var y=u+g;if("\r"!==(h=eZ.charAt(y)))if(l=$H.fontAtlas.getLetterDefinitionForChar(h,$H)){var x=m+l.offsetX*$Q-$H.margin;if(lZ&&fZ>0&&i>0&&x+l.w*$Q>fZ&&!HH(h)){HQ.push(a),a=0,n++,i=0,r-=sZ*this._getFontScale()+0,v=!0;break}qQ.x=x,qQ.y=r-l.offsetY*$Q,this._recordLetterInfo(qQ,h,y,n),y+1<UQ.length&&y<e-1&&(m+=UQ[y+1]),m+=l.xAdvance*$Q+aZ,_=qQ.x+l.w*$Q,p<qQ.y&&(p=qQ.y),d>qQ.y-l.h*$Q&&(d=qQ.y-l.h*$Q)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+XQ.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<p&&(s=p),c>d&&(c=d),o<(a=_)&&(o=a),u+=f)}else HQ.push(a),a=0,n++,i=0,r-=sZ*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return HQ.push(a),KQ=(YQ=n+1)*sZ*this._getFontScale(),YQ>1&&(KQ+=0*(YQ-1)),jQ.width=uZ,jQ.height=hZ,uZ<=0&&(jQ.width=parseFloat(o.toFixed(2))+2*$H.margin),hZ<=0&&(jQ.height=parseFloat(KQ.toFixed(2))+2*$H.margin),ZQ=jQ.height,JQ=0,s>0&&(ZQ=jQ.height+s),c<-KQ&&(JQ=KQ+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return cZ===vj.SHRINK?$Q:1},_getFirstWordLen:function(t,e,n){var i=t.charAt(e);if(GH(i)||"\n"===i||HH(i))return 1;var r=1,o=$H.fontAtlas.getLetterDefinitionForChar(i,$H);if(!o)return r;for(var a=o.xAdvance*$Q+aZ,s=e+1;s<n&&(i=t.charAt(s),o=$H.fontAtlas.getLetterDefinitionForChar(i,$H));++s){if(a+o.offsetX*$Q+o.w*$Q>fZ&&!HH(i)&&fZ>0)return r;if(a+=o.xAdvance*$Q+aZ,"\n"===i||HH(i)||GH(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(t,e){if(t>=GQ.length){var n=new BQ;GQ.push(n)}GQ[t].char=e,GQ[t].hash=""+e.charCodeAt(0)+$H.hash,GQ[t].valid=!1},_recordLetterInfo:function(t,e,n,i){if(n>=GQ.length){var r=new BQ;GQ.push(r)}var o=""+e.charCodeAt(0)+$H.hash;GQ[n].line=i,GQ[n].char=e,GQ[n].hash=o,GQ[n].valid=$H.fontAtlas.getLetter(o).valid,GQ[n].x=t.x,GQ[n].y=t.y},_alignText:function(){KQ=0,HQ.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),cZ===vj.SHRINK&&nZ>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||cZ===vj.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(t){var e=!0;t||(t=.1,e=!1),nZ=t,e&&this._updateContent()},_shrinkLabelToContentSize:function(t){for(var e=0,n=0|nZ,i=0;e<n;){var r=i=e+n+1>>1;if(r<=0)break;$Q=r/iZ,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?n=i-1:e=i}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:function(){return KQ>jQ.height},_isHorizontalClamp:function(){for(var t=!1,e=0,n=eZ.length;e<n;++e){var i=GQ[e];if(i.valid){var r=$H.fontAtlas.getLetterDefinitionForChar(i.char,$H);if(!r)continue;var o=i.x+r.w*$Q,a=i.line;if(uZ>0)if(lZ){if(HQ[a]>jQ.width&&(o>jQ.width||o<0)){t=!0;break}}else if(o>jQ.width){t=!0;break}}}return t},_isHorizontalClamped:function(t,e){var n=HQ[e],i=t>jQ.width||t<0;return lZ?n>jQ.width&&i:i},_updateQuads:function(){if(!zQ)return!1;var t=tZ?tZ.texture:$H.fontAtlas.getTexture(),e=zQ.renderData;e.dataLength=0,e.resize(0,0);for(var n=kQ.anchorPoint,i=jQ,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=eZ.length;s<c;++s){var l=GQ[s];if(l.valid){var u=$H.fontAtlas.getLetter(l.hash);if(u){FQ.height=u.h,FQ.width=u.w,FQ.x=u.u,FQ.y=u.v;var h=l.y+QQ;if(hZ>0){if(h>ZQ){var f=h-ZQ;FQ.y+=f,FQ.height-=f,h-=f}h-u.h*$Q<JQ&&cZ===vj.CLAMP&&(FQ.height=h<JQ?0:(h-JQ)/$Q)}var p=l.line,d=l.x+u.w/2*$Q+VQ[p];if(uZ>0&&this._isHorizontalClamped(d,p))if(cZ===vj.CLAMP)FQ.width=0;else if(cZ===vj.SHRINK){if(jQ.width>u.w){a=!1;break}FQ.width=0}if(FQ.height>0&&FQ.width>0){var _=this._determineRect(),m=l.x+VQ[l.line];this.appendQuad(zQ,t,FQ,_,m-r,h-o,$Q)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var t=tZ.isRotated(),e=tZ.getOriginalSize(),n=tZ.getRect(),i=tZ.getOffset(),r=i.x+(e.width-n.width)/2,o=i.y-(e.height-n.height)/2;if(t){var a=FQ.x;FQ.x=n.x+n.height-FQ.y-FQ.height-o,FQ.y=a+n.y-r,FQ.y<0&&(FQ.height+=o)}else FQ.x+=n.x-r,FQ.y+=n.y+o;return t},_computeAlignmentOffset:function(){switch(VQ.length=0,rZ){case _j.LEFT:for(var t=0;t<YQ;++t)VQ.push(0);break;case _j.CENTER:for(var e=0,n=HQ.length;e<n;e++)VQ.push((jQ.width-HQ[e])/2);break;case _j.RIGHT:for(var i=0,r=HQ.length;i<r;i++)VQ.push(jQ.width-HQ[i])}if(QQ=jQ.height,oZ!==mj.TOP){var o=jQ.height-KQ+sZ*this._getFontScale()-iZ*$Q;oZ===mj.BOTTOM?QQ-=o:QQ-=o/2}},_setupBMFontOverflowMetrics:function(){var t=jQ.width,e=jQ.height;cZ===vj.RESIZE_HEIGHT&&(e=0),cZ===vj.NONE&&(t=0,e=0),uZ=t,hZ=e,WQ.width=t,WQ.height=e,fZ=t}},dZ=new An(255,255,255,255),_Z={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){var e=t.node;dZ.set(t.color),dZ.a=255*e._uiProps.opacity,KG(e,0,t.renderData,dZ)},appendQuad:function(t,e,n,i,r,o,a){var s=t.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=e.width,h=e.height,f=n.width,p=n.height,d=0,_=0,m=0,v=0;i?(d=n.x/u,v=(n.x+p)/u,_=(n.y+f)/h,m=n.y/h,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=_,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=_):(d=n.x/u,v=(n.x+f)/u,_=(n.y+p)/h,m=n.y/h,l[c].u=d,l[c].v=_,l[c+1].u=v,l[c+1].v=_,l[c+2].u=d,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-p*a,l[c+1].x=r+f*a,l[c+1].y=o-p*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+f*a,l[c+3].y=o}},updateColor:function(){}};zt(_Z,pZ);var mZ=null,vZ=kt(pZ,{getAssemblerData:function(){return mZ||(mZ=new JH(1024,1024)),mZ.getTexture()},_updateFontFamily:function(t){$H.fontAtlas=mZ,$H.fontFamily=this._getFontFamily(t);var e=t.getComponent(aY);e&&e.enabled?($H.isOutlined=!0,$H.margin=e.width,$H.out=e.color.clone(),$H.out.a=e.color.a*t.color.a/255):($H.isOutlined=!1,$H.margin=0)},_getFontFamily:function(t){var e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo:function(t){$H.fontDesc=this._getFontDesc(),$H.color=t.color,$H.hash=function(t){var e=t.color.toHEX(),n="";return t.isOutlined&&t.margin>0&&(n=n+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+n}($H)},_getFontDesc:function(){return $H.fontSize.toString()+"px "+$H.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),gZ=new An(255,255,255,255),yZ={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){if(t.renderData){var e=t.node;gZ.a=255*e._uiProps.opacity,KG(e,0,t.renderData,gZ)}},updateColor:function(){},appendQuad:_Z.appendQuad};zt(yZ,vZ);var xZ=xj.Overflow,SZ=(1/255).toFixed(3),TZ=null,EZ=null,bZ=null,CZ="",AZ="",wZ=0,RZ=0,PZ=[],IZ=new ti,MZ=0,DZ=0,OZ=0,NZ=new An,LZ="",BZ=xZ.NONE,FZ=!1,zZ=null,kZ=An.BLACK.clone(),UZ=null,GZ=An.BLACK.clone(),HZ=new ni,VZ=ti.ZERO.clone(),WZ=ti.ZERO.clone(),jZ=Xn.ZERO.clone(),qZ=Xn.ZERO.clone(),XZ=0,YZ=0,KZ=!1,QZ=!1,ZZ=!1,JZ=["left","center","right"],$Z={getAssemblerData:function(){return xj._canvasPool.get()},resetAssemblerData:function(t){t&&xj._canvasPool.put(t)},updateRenderData:function(t){if(t.renderData){if(t.renderData.vertDirty){var e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(t),this._calDynamicAtlas(t),t.actualFontSize=wZ,e.setContentSize(IZ),this.updateVertexData(t),this.updateUVs(t),t.markForUpdateRenderData(!1),TZ=null,EZ=null,bZ=null}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(t){LZ=t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial"},_updateProperties:function(t,e){var n=t.assemblerData;n&&(TZ=n.context,EZ=n.canvas,bZ=t.spriteFrame,AZ=t.string.toString(),wZ=t.fontSize,RZ=wZ,BZ=t.overflow,WZ.width=IZ.width=e.width,WZ.height=IZ.height=e.height,YZ=t.underlineHeight,MZ=t.lineHeight,DZ=t.horizontalAlign,OZ=t.verticalAlign,NZ=t.color,t.node._uiProps.opacity,KZ=t.isBold,QZ=t.isItalic,ZZ=t.isUnderline,FZ=BZ!==xZ.NONE&&(BZ===xZ.RESIZE_HEIGHT||t.enableWrapText),(zZ=(zZ=aY&&t.getComponent(aY))&&zZ.enabled&&zZ.width>0?zZ:null)&&kZ.set(zZ.color),(UZ=(UZ=QK&&t.getComponent(QK))&&UZ.enabled?UZ:null)&&GZ.set(UZ.color),this._updatePaddingRect())},_updatePaddingRect:function(){var t=0,e=0,n=0,i=0,r=0;if(VZ.width=VZ.height=0,zZ&&(t=e=n=i=r=zZ.width,VZ.width=VZ.height=2*r),UZ){var o=UZ.blur+r,a=UZ.offset.x,s=UZ.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),t=Math.max(t,s+o),e=Math.max(e,-s+o)}if(QZ){var c=RZ*Math.tan(.20943951);i+=c,VZ.width+=c}HZ.x=n,HZ.y=t,HZ.width=n+i,HZ.height=t+e},_calculateFillTextStartPosition:function(){var t=0;DZ===_j.RIGHT?t=IZ.width-HZ.width:DZ===_j.CENTER&&(t=(IZ.width-HZ.width)/2);var e=this._getLineHeight()*(PZ.length-1),n=wZ*(1-MH/2);if(OZ!==mj.TOP){var i=e+HZ.height+wZ-IZ.height;OZ===mj.BOTTOM?n-=i+=MH/2*wZ:n-=i/2}n+=0*wZ,jZ.set(t+HZ.x,n+HZ.y)},_updateTexture:function(t){if(TZ&&EZ){TZ.clearRect(0,0,EZ.width,EZ.height),TZ.font=CZ,this._calculateFillTextStartPosition();var e=this._getLineHeight();TZ.lineJoin="round",zZ?(TZ.fillStyle="rgba("+kZ.r+", "+kZ.g+", "+kZ.b+", "+SZ+")",TZ.fillRect(0,0,EZ.width,EZ.height)):t._srcBlendFactor===Ri.SRC_ALPHA&&(TZ.fillStyle="rgba("+NZ.r+", "+NZ.g+", "+NZ.b+", "+SZ+")",TZ.fillRect(0,0,EZ.width,EZ.height)),TZ.fillStyle="rgb("+NZ.r+", "+NZ.g+", "+NZ.b+")";var n=jZ.x,i=0;this._drawTextEffect(jZ,e);for(var r=0;r<PZ.length;++r)i=jZ.y+r*e,zZ&&TZ.strokeText(PZ[r],n,i),TZ.fillText(PZ[r],n,i);UZ&&(TZ.shadowColor="transparent"),this._uploadTexture(t)}},_uploadTexture:function(t){if(t.cacheMode===xj.CacheMode.BITMAP){var e=t.ttfSpriteFrame;nH.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()}var n;bZ&&EZ&&(n=bZ instanceof cH?bZ.texture:bZ,0!==EZ.width&&0!==EZ.height&&(n.reset({width:EZ.width,height:EZ.height,mipmapLevel:1}),n.uploadData(EZ),bZ instanceof cH&&(bZ.rect=new ni(0,0,EZ.width,EZ.height),bZ._calculateUV()),t.renderData&&(t.renderData.textureDirty=!0),u.director.root&&u.director.root.batcher2D&&u.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(t){if(!(t.cacheMode!==xj.CacheMode.BITMAP||!EZ||EZ.width<=0||EZ.height<=0)){var e=t.ttfSpriteFrame;nH.packToDynamicAtlas(t,e)}},_setupOutline:function(){TZ.strokeStyle="rgba("+kZ.r+", "+kZ.g+", "+kZ.b+", "+kZ.a/255+")",TZ.lineWidth=2*zZ.width},_setupShadow:function(){TZ.shadowColor="rgba("+GZ.r+", "+GZ.g+", "+GZ.b+", "+GZ.a/255+")",TZ.shadowBlur=UZ.blur,TZ.shadowOffsetX=UZ.offset.x,TZ.shadowOffsetY=-UZ.offset.y},_drawTextEffect:function(t,e){if(UZ||zZ||ZZ){var n=PZ.length>1&&UZ,i=this._measureText(TZ,CZ),r=0,o=0;UZ&&this._setupShadow(),zZ&&this._setupOutline();for(var a=0;a<PZ.length;++a)r=t.x,o=t.y+a*e,n&&(zZ&&TZ.strokeText(PZ[a],r,o),TZ.fillText(PZ[a],r,o)),ZZ&&(XZ=i(PZ[a]),DZ===_j.RIGHT?qZ.x=t.x-XZ:DZ===_j.CENTER?qZ.x=t.x-XZ/2:qZ.x=t.x,qZ.y=o+RZ/8,TZ.fillRect(qZ.x,qZ.y,XZ,YZ));n&&(TZ.shadowColor="transparent")}},_updateLabelDimensions:function(){IZ.width=Math.min(IZ.width,2048),IZ.height=Math.min(IZ.height,2048);var t=!1;EZ.width!==IZ.width&&(EZ.width=IZ.width,t=!0),EZ.height!==IZ.height&&(EZ.height=IZ.height,t=!0),t&&(TZ.font=CZ),TZ.textAlign=JZ[DZ],TZ.textBaseline="alphabetic"},_getFontDesc:function(){var t=wZ.toString()+"px ";return t+=LZ,KZ&&(t="bold "+t),QZ&&(t="italic "+t),t},_getLineHeight:function(){return 0|(0===MZ?wZ:MZ*wZ/RZ)},_calculateParagraphLength:function(t,e){for(var n,i=[],r=st(t);!(n=r()).done;){var o=VH(e,n.value,CZ);i.push(o)}return i},_measureText:function(t,e){return function(n){return VH(t,n,e)}},_calculateShrinkFont:function(t){if(TZ){var e=this._calculateParagraphLength(t,TZ),n=0,i=0,r=0;if(FZ){var o=WZ.width,a=WZ.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|wZ+1,l=0;s<c;){if((l=s+c+1>>1)<=0){P(4003);break}wZ=l,CZ=this._getFontDesc(),TZ.font=CZ;var u=this._getLineHeight();for(i=0,n=0;n<t.length;++n){var h=VH(TZ,t[n],CZ);i+=jH(t[n],h,o,this._measureText(TZ,CZ)).length*u}i>a?c=l-1:s=l}0===s?P(4003):(wZ=s,CZ=this._getFontDesc(),TZ.font=CZ)}else{for(i=t.length*this._getLineHeight(),n=0;n<t.length;++n)r<e[n]&&(r=e[n]);var f=(IZ.width-HZ.width)/r,p=IZ.height/i;wZ=RZ*Math.min(1,f,p)|0,CZ=this._getFontDesc(),TZ.font=CZ}}},_calculateWrapText:function(t){if(FZ&&TZ){PZ=[];for(var e=WZ.width,n=0;n<t.length;++n){var i=VH(TZ,t[n],CZ),r=jH(t[n],i,e,this._measureText(TZ,CZ));PZ=PZ.concat(r)}}},_calculateLabelFont:function(){if(TZ){var t=AZ.split("\n");switch(PZ=t,CZ=this._getFontDesc(),TZ.font=CZ,BZ){case xZ.NONE:for(var e=0,n=0,i=0;i<t.length;++i){var r=VH(TZ,t[i],CZ);e=e>r?e:r}n=(PZ.length+MH)*this._getLineHeight();var o=parseFloat(e.toFixed(2)),a=parseFloat(n.toFixed(2));IZ.width=o+HZ.width,IZ.height=a+HZ.height,WZ.width=o+VZ.width,WZ.height=a+VZ.height;break;case xZ.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case xZ.CLAMP:this._calculateWrapText(t);break;case xZ.RESIZE_HEIGHT:this._calculateWrapText(t);var s=(PZ.length+MH)*this._getLineHeight();IZ.height=s+HZ.height,WZ.height=s+VZ.height}}}},tJ=An.WHITE.clone(),eJ={createData:function(t){var e=t.requestRenderData();e.dataLength=2,e.resize(4,6);var n=e.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)An.toArray(n,tJ,i),i+=9;return e},fillBuffers:function(t){var e=t.renderData.chunk,n=t.renderData.data,i=t.node,r=e.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,f=o.y*l.y,p=a.y*l.y,d=c.x,_=c.y,m=c.z,v=c.w,g=d*_,y=m*v,x=d*d-_*_,S=v*v-m*m,T=S+x,E=2*(g-y),b=S-x,C=2*(g+y),A=s.x,w=s.y;r[0]=T*u+E*f+A,r[1]=b*f+C*u+w,r[9]=T*h+E*f+A,r[10]=b*f+C*h+w,r[18]=T*u+E*p+A,r[19]=b*p+C*u+w,r[27]=T*h+E*p+A,r[28]=b*p+C*h+w;var R=e.bufferId,P=e.vertexOffset,I=e.vertexAccessor.getMeshBuffer(e.bufferId),M=e.vertexAccessor.getIndexBuffer(R),D=I.indexOffset;M[D++]=P,M[D++]=P+1,M[D++]=P+2,M[D++]=P+2,M[D++]=P+1,M[D++]=P+3,I.indexOffset+=6},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(t){var e=t.renderData;if(e&&t.ttfSpriteFrame){var n=e.chunk.vb,i=t.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};zt(eJ,$Z);var nJ=t("labelAssembler",{getAssembler:function(t){var e=eJ;return t.font instanceof PH?e=_Z:t.cacheMode===xj.CacheMode.CHAR&&(e=yZ),e}});xj.Assembler=nJ;var iJ=cY.FillType,rJ=new Vn,oJ=new Rn,aJ={updateRenderData:function(t){var e=t.spriteFrame;nH.packToDynamicAtlas(t,e);var n=t.renderData;if(n&&e){if(n.updateRenderData(t,e),!n.vertDirty)return;var i=t.fillStart,r=t.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(t,i,o),this.updateVertexData(t,i,o)}},updateUVs:function(t,e,n){var i=t.spriteFrame,r=t.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,f=0,p=0,d=0,_=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=f=c,d=m=(s.x+s.height)/o,p=v=l,h=_=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=d=c,f=m=(s.x+s.width)/o,h=p=l,_=v=s.y/a),t.fillType){case iJ.HORIZONTAL:r[3]=u+(f-u)*e,r[4]=h+(p-h)*e,r[12]=u+(f-u)*n,r[13]=h+(p-h)*n,r[21]=d+(m-d)*e,r[22]=_+(v-_)*e,r[30]=d+(m-d)*n,r[31]=_+(v-_)*n;break;case iJ.VERTICAL:r[3]=u+(d-u)*e,r[4]=h+(_-h)*e,r[12]=f+(m-f)*e,r[13]=p+(v-p)*e,r[21]=u+(d-u)*n,r[22]=h+(_-h)*n,r[30]=f+(m-f)*n,r[31]=p+(v-p)*n;break;default:O(2626)}},updateVertexData:function(t,e,n){var i=t.renderData.data,r=t.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,f=a-c,p=0;switch(t.fillType){case iJ.HORIZONTAL:p=l+(h-l)*n,l+=(h-l)*e,h=p;break;case iJ.VERTICAL:p=u+(f-u)*n,u+=(f-u)*e,f=p;break;default:O(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=f,i[3].x=h,i[3].y=f},createData:function(t){var e=t.requestRenderData();e.dataLength=4,e.resize(4,6);for(var n,i=st(e.data);!(n=i()).done;)n.value.z=0;return e},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(rJ);for(var n=t.renderData.floatStride,i=t.renderData.data,r=e.vb,o=0,a=0;a<4;a++){var s=i[a];Rn.transformMat4(oJ,s,rJ),r[o=a*n]=oJ.x,r[o+1]=oJ.y,r[o+2]=oJ.z}},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},sJ=2*Math.PI,cJ=1e-6,lJ=new Vn,uJ=new Rn,hJ=[new Xn,new Xn,new Xn,new Xn],fJ=new Array(4),pJ=new Array(8),dJ=[new Xn,new Xn,new Xn,new Xn],_J=[new Xn,new Xn,new Xn,new Xn],mJ=new Xn,vJ=[new Xn,new Xn,new Xn,new Xn];function gJ(t,e,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>cJ?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>cJ?c:0)){if(l=s/c,(t-r.x)*c>0){var h=r.y+l*(t-r.x);a[0].x=t,a[0].y=h}if((e-r.x)*c>0){var f=r.y+l*(e-r.x);a[2].x=e,a[2].y=f}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var p=r.x+u*(i-r.y);a[3].x=p,a[3].y=i}if((n-r.y)*s>0){var d=r.x+u*(n-r.y);a[1].x=d,a[1].y=n}}}function yJ(t,e){var n=e.x-t.x,i=e.y-t.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function xJ(t,e,n,i,r){var o=fJ,a=o[0],s=o[1],c=o[2],l=o[3];t[e].x=n.x,t[e].y=n.y,t[e+1].x=i.x,t[e+1].y=i.y,t[e+2].x=r.x,t[e+2].y=r.y,SJ((n.x-a)/(c-a),(n.y-s)/(l-s),t,e),SJ((i.x-a)/(c-a),(i.y-s)/(l-s),t,e+1),SJ((r.x-a)/(c-a),(r.y-s)/(l-s),t,e+2)}function SJ(t,e,n,i){var r=pJ,o=r[0]+(r[2]-r[0])*t,a=r[4]+(r[6]-r[4])*t,s=r[1]+(r[3]-r[1])*t,c=r[5]+(r[7]-r[5])*t,l=n[i];l.u=o+(a-o)*e,l.v=s+(c-s)*e}for(var TJ={useModel:!1,createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.spriteFrame;nH.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;if(n&&e){if(!n.vertDirty)return;var i=n.data,r=t.fillStart,o=t.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=sJ)+(o*=sJ);!function(t){var e=t.node._uiProps.uiTransformComp,n=e.width,i=e.height,r=e.anchorX*n,o=e.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=fJ;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=t.fillCenter,f=mJ.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,p=mJ.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;hJ[0].x=hJ[3].x=a,hJ[1].x=hJ[2].x=c,hJ[0].y=hJ[1].y=s,hJ[2].y=hJ[3].y=l;for(var d,_=st(vJ);!(d=_()).done;){var m=d.value;Xn.set(m,0,0)}f!==u[0]&&Xn.set(vJ[0],3,0),f!==u[2]&&Xn.set(vJ[2],1,2),p!==u[1]&&Xn.set(vJ[1],0,1),p!==u[3]&&Xn.set(vJ[3],2,3)}(t),function(t){var e=t.width,n=t.height,i=t.getRect(),r=0,o=0,a=0,s=0,c=pJ;t.isRotated()?(r=i.x/e,o=(i.x+i.height)/e,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/e,o=(i.x+i.width)/e,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(e),gJ(fJ[0],fJ[2],fJ[1],fJ[3],mJ,r,dJ),gJ(fJ[0],fJ[2],fJ[1],fJ[3],mJ,r+o,_J);for(var s=0,c=0;c<4;++c){var l=vJ[c];if(l)if(o>=sJ)n.dataLength=s+3,xJ(i,s,mJ,hJ[l.x],hJ[l.y]),s+=3;else{var u=yJ(mJ,hJ[l.x]),h=yJ(mJ,hJ[l.y]);h<u&&(h+=sJ),u-=sJ,h-=sJ;for(var f=0;f<3;++f)u>=a||(u>=r?(n.dataLength=s+3,xJ(i,s,mJ,hJ[l.x],h>=a?_J[c]:hJ[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,xJ(i,s,mJ,dJ[c],hJ[l.y]),s+=3):(n.dataLength=s+3,xJ(i,s,mJ,dJ[c],_J[c]),s+=3))),u+=sJ,h+=sJ}}n.resize(s,s),n.updateRenderData(t,e)}},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(t,e){t.node.getWorldMatrix(lJ);for(var n=t.renderData,i=n.floatStride,r=t.renderData.data,o=e.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];Rn.set(uJ,l.x,l.y,0),Rn.transformMat4(uJ,uJ,lJ),o[s+0]=uJ.x,o[s+1]=uJ.y,o[s+2]=uJ.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},EJ=[],bJ=0;bJ<4;bJ++)EJ.push(new Rn);for(var CJ={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){var e=t.spriteFrame;nH.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateWorldVerts:function(t,e){var n=t.renderData,i=e.vb,r=n.data,o=t.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,f=c.m05,p=1===l&&0===u&&0===h&&1===f,d=c.m12,_=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(p){var x=m+d,S=v+d,T=g+_,E=y+_;i[0]=x,i[1]=T,i[9]=S,i[10]=T,i[18]=x,i[19]=E,i[27]=S,i[28]=E}else{var b=l*m,C=l*v,A=u*m,w=u*v,R=h*g+d,P=h*y+d,I=f*g+_,M=f*y+_;i[0]=b+R,i[1]=A+I,i[9]=C+R,i[10]=w+I,i[18]=b+P,i[19]=A+M,i[27]=C+P,i[28]=w+M}},fillBuffers:function(t){if(null!==t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVerts(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(i),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=e.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(t.trim)c=-a,l=-s,u=r-a,h=o-s;else{var f=t.spriteFrame,p=f.getOriginalSize(),d=f.getRect(),_=p.width,m=p.height,v=d.width,g=d.height,y=f.getOffset(),x=r/_,S=o/m,T=y.x+(_-v)/2,E=y.x-(_-v)/2;c=T*x-a,l=(y.y+(m-g)/2)*S-s,u=r+E*x-a,h=o+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,e.vertDirty=!0}},updateUVs:function(t){if(t.spriteFrame){var e=t.renderData.chunk.vb,n=t.spriteFrame.uv;e[3]=n[0],e[4]=n[1],e[12]=n[2],e[13]=n[3],e[21]=n[4],e[22]=n[5],e[30]=n[6],e[31]=n[7]}},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=5,r=t.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=e.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},AJ=new Rn,wJ=new Vn,RJ={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(16,54),e},updateRenderData:function(t){var e=t.spriteFrame;nH.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateVertexData:function(t){var e=t.renderData.data,n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,f=i-c-l,p=r-u-h,d=i/(c+l),_=r/(u+h);d=Number.isNaN(d)||d>1?1:d,_=Number.isNaN(_)||_>1?1:_,f=f<0?0:f,p=p<0?0:p,e[0].x=-o,e[0].y=-a,e[1].x=c*d-o,e[1].y=h*_-a,e[2].x=e[1].x+f,e[2].y=e[1].y+p,e[3].x=i-o,e[3].y=r-a},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(wJ);for(var n=t.renderData,i=n.floatStride,r=n.data,o=e.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];Rn.set(AJ,u.x,c.y,0),Rn.transformMat4(AJ,AJ,wJ),a=(4*s+l)*i,o[a++]=AJ.x,o[a++]=AJ.y,o[a++]=AJ.z}},updateUVs:function(t){if(t.spriteFrame)for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=t.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},PJ=[],IJ=0;IJ<4;IJ++)PJ.push(new Rn);var MJ=new Vn,DJ={createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.renderData,n=t.spriteFrame;if(n&&e&&(e.updateRenderData(t,n),e.vertDirty)){var i=t.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,f=a.height-u-h,p=r-s-c,d=o-u-h;p=p>0?p:0,d=d>0?d:0;var _=0===l?p:p/l,m=0===f?d:d/f,v=Math.ceil(m+2),g=Math.ceil(_+2);e.dataLength=Math.max(8,v+1,g+1),this.updateVerts(t,p,d,v,g),e.resize(v*g*4,v*g*6)}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(t,e){var n=t.node;n.getWorldMatrix(MJ);var i=t.renderData,r=i.floatStride,o=i.data,a=e.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=t.spriteFrame,h=u.rotated,f=u.uv,p=u.uvSliced,d=u.rect,_=u.insetLeft,m=u.insetRight,v=d.width-_-m,g=u.insetTop,y=u.insetBottom,x=d.height-g-y,S=c-_-m,T=l-g-y;S=S>0?S:0,T=T>0?T:0;for(var E=0===v?S:S/v,b=0===x?T:T/x,C=Math.ceil(b+2),A=Math.ceil(E+2),w=0,R=0,P=0,I=0,M=0,D=0,O=C;D<O;++D){I=o[D].y,M=o[D+1].y;for(var N=0,L=A;N<L;++N){R=o[N].x,P=o[N+1].x,Rn.set(PJ[0],R,I,0),Rn.set(PJ[1],P,I,0),Rn.set(PJ[2],R,M,0),Rn.set(PJ[3],P,M,0);for(var B=0;B<4;B++){var F=PJ[B];Rn.transformMat4(F,F,MJ);var z=B*r;a[w+z]=F.x,a[w+z+1]=F.y,a[w+z+2]=F.z}w+=4*r}}w=0;for(var k=r,U=2*r,G=3*r,H=4*r,V=0,W=0,j=[],q=[],X=0,Y=C;X<Y;++X){W=T>x?T>=X*x?1:b%1:b;for(var K=0,Q=A;K<Q;++K){V=S>v?S>=K*v?1:E%1:E;var Z=w+3,J=Z+1;h?(0===X?(j[0]=p[0].u,j[1]=p[0].u,j[2]=p[4].u+(p[8].u-p[4].u)*W):X<C-1?(j[0]=p[4].u,j[1]=p[4].u,j[2]=p[4].u+(p[8].u-p[4].u)*W):X===C-1&&(j[0]=p[8].u,j[1]=p[8].u,j[2]=p[12].u),0===K?(q[0]=p[0].v,q[1]=p[1].v+(p[2].v-p[1].v)*V,q[2]=p[0].v):K<A-1?(q[0]=p[1].v,q[1]=p[1].v+(p[2].v-p[1].v)*V,q[2]=p[1].v):K===A-1&&(q[0]=p[2].v,q[1]=p[3].v,q[2]=p[2].v),j[3]=j[2],q[3]=q[1]):(0===K?(j[0]=p[0].u,j[1]=p[1].u+(p[2].u-p[1].u)*V,j[2]=f[0]):K<A-1?(j[0]=p[1].u,j[1]=p[1].u+(p[2].u-p[1].u)*V,j[2]=p[1].u):K===A-1&&(j[0]=p[2].u,j[1]=p[3].u,j[2]=p[2].u),0===X?(q[0]=p[0].v,q[1]=p[0].v,q[2]=p[4].v+(p[8].v-p[4].v)*W):X<C-1?(q[0]=p[4].v,q[1]=p[4].v,q[2]=p[4].v+(p[8].v-p[4].v)*W):X===C-1&&(q[0]=p[8].v,q[1]=p[8].v,q[2]=p[12].v),j[3]=j[1],q[3]=q[2]),a[Z]=j[0],a[J]=q[0],a[Z+k]=j[1],a[J+k]=q[1],a[Z+U]=j[2],a[J+U]=q[2],a[Z+G]=j[3],a[J+G]=q[3],w+=H}}},updateVerts:function(t,e,n,i,r){var o,a,s=t.node._uiProps.uiTransformComp,c=t.renderData.data,l=t.spriteFrame,u=l.rect,h=Math.abs(s.width),f=Math.abs(s.height),p=s.anchorX*h,d=s.anchorY*f,_=l.insetLeft,m=l.insetRight,v=u.width-_-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(_+m)>1?1:s.width/(_+m),T=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*e)/1e3%v==0?v:e%v:e,a=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var E=0;E<=r;E++)0===E?c[E].x=-p:E>0&&E<r?c[E].x=1===E?_*S+Math.min(v,e)-p:v>0?E===r-1?_+o+v*(E-2)-p:_+Math.min(v,e)+v*(E-2)-p:_+e-p:E===r&&(c[E].x=Math.min(_+e+m,h)-p);for(var b=0;b<=i;b++)0===b?c[b].y=-d:b>0&&b<i?c[b].y=1===b?y*T+Math.min(x,n)-d:x>0?b===i-1?y+a+(b-2)*x-d:y+Math.min(x,n)+(b-2)*x-d:y+n-d:b===i&&(c[b].y=Math.min(y+n+g,f)-d)},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},OJ=cY.Type,NJ=cY.FillType,LJ=t("spriteAssembler",{getAssembler:function(t){var e=CJ,n=t;switch(n.type){case OJ.SLICED:e=RJ;break;case OJ.TILED:e=DJ;break;case OJ.FILLED:e=n.fillType===NJ.RADIAL?TJ:aJ}return e}});cY.Assembler=LJ;var BJ=nW.sharedManager,FJ={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){t.type===Vq.IMAGE_STENCIL&&(CJ.updateRenderData(t),CJ.updateColor(t))},fillBuffers:function(t,e){(t.type!==Vq.IMAGE_STENCIL||t.spriteFrame)&&(BJ.pushMask(t),e.finishMergeBatches(),function(t,e){BJ.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(BJ.enterLevel(t),t.type===Vq.IMAGE_STENCIL){CJ.fillBuffers(t,e);var n=t.graphics.getMaterialInstance(0);e.forceMergeBatches(n,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),BJ.enableMask())}},zJ={fillBuffers:function(){BJ.exitMask()}},kJ={getAssembler:function(){return FJ}},UJ={getAssembler:function(){return zJ}};Yq.Assembler=kJ,Yq.PostAssembler=UJ;var GJ=t("MeshBuffer",function(){function t(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var e=t.prototype;return e.initialize=function(t,e,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=e,this._floatsPerVertex=rV(e),this._initVDataCount,this._floatsPerVertex,F(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(t))},e.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},e.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var t=0;t<this._iaPool.length;++t){var e=this._iaPool[t];e.vertexBuffers[0]&&e.vertexBuffers[0].destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.ia.destroy()}this._iaPool.length=0},e.setDirty=function(){this._dirty=!0},e.request=function(){return M(9002),!1},e.requireFreeIA=function(t){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(t)),this._iaPool[this._nextFreeIAHandle++].ia},e.recycleIA=function(t){for(var e=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(t===e[n].ia){var i=e[n];return e[n]=e[--this._nextFreeIAHandle],void(e[this._nextFreeIAHandle]=i)}},e.checkCapacity=function(t,e){var n=this.vertexOffset+t,i=this.indexOffset+e;return!(n>this._initVDataCount||i>this._initIDataCount)},e.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var t=lh.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,e=this.byteOffset,n=this.indexOffset,i=0;i<t;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,e>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];e>s.size&&s.resize(e),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},e.createNewIA=function(t){var e,n,i;if(lh.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=t.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,r,r));i=t.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,o,o)),n=[a],this._iaInfo=new Ir(this._attributes,n,i),e=t.createInputAssembler(this._iaInfo)}else e=t.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:e,vertexBuffers:n,indexBuffer:i}},Z(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),t}()),HJ=[lM.EventType.MOUSE_DOWN,lM.EventType.MOUSE_MOVE,lM.EventType.MOUSE_UP,lM.EventType.MOUSE_WHEEL],VJ=[lM.EventType.TOUCH_START,lM.EventType.TOUCH_MOVE,lM.EventType.TOUCH_END,lM.EventType.TOUCH_CANCEL],WJ=(new(function(){function t(){this.priority=$I.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],uM._registerEventDispatcher(this),wI.callbacksInvoker.on(HA.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),wI.callbacksInvoker.on(HA.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),wI.callbacksInvoker.on(HA.MARK_LIST_DIRTY,this._markListDirty,this)}var e=t.prototype;return e.dispatchEvent=function(t){var e=t.type;return VJ.includes(e)?this.dispatchEventTouch(t):!HJ.includes(e)||this.dispatchEventMouse(t)},e.addPointerEventProcessor=function(t){0===this._inDispatchCount?this._pointerEventProcessorList.includes(t)||(this._pointerEventProcessorList.push(t),this._isListDirty=!0):this._processorListToAdd.includes(t)||this._processorListToAdd.push(t),ie.array.remove(this._processorListToRemove,t)},e.removePointerEventProcessor=function(t){0===this._inDispatchCount?(ie.array.remove(this._pointerEventProcessorList,t),this._isListDirty=!0):this._processorListToRemove.includes(t)||this._processorListToRemove.push(t),ie.array.remove(this._processorListToAdd,t)},e.dispatchEventMouse=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=!0,r=0;r<n;++r){var o=e[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(t)){if(i=!1,!t.preventSwallow)break;t.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},e.dispatchEventTouch=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=t.touch,r=!0,o=0;o<n;++o){var a=e[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(t.type===UA.TOUCH_START){if(a._handleEventTouch(t)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(t),t.type!==UA.TOUCH_END&&t.type!==UA.TOUCH_CANCEL||ie.array.removeAt(a.claimedTouchIdList,s),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},e._updatePointerEventProcessorList=function(){for(var t=this._processorListToAdd,e=t.length,n=0;n<e;++n)this.addPointerEventProcessor(t[n]);t.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},e._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var t=this._pointerEventProcessorList,e=t.length,n=0;n<e;++n){var i=t[n],r=i.node;if(r._uiProps){var o=r._uiProps.uiTransformComp;i.cachedCameraPriority=o.cameraPriority}}t.sort(this._sortByPriority),this._isListDirty=!1}},e._sortByPriority=function(t,e){var n=t.node,i=e.node;if(!(e&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(t&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(t.cachedCameraPriority!==e.cachedCameraPriority)return e.cachedCameraPriority-t.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,f;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(f=h.parent)||void 0===f?void 0:f.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var p=r?r.getSiblingIndex():0,d=o?o.getSiblingIndex():0;return a?p-d:d-p},e._markListDirty=function(){this._isListDirty=!0},t}()),function(){function t(t,e){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=t,this._attributes=e,this._floatsPerVertex=rV(e),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var e=t.prototype;return e.initialize=function(){},e.reset=function(){},e.request=function(){},e.appendBuffers=function(){},e.uploadBuffers=function(){},e.destroy=function(){this._attributes.length=0},Z(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),t}()),jJ=new Wl((function(){return{offset:0,length:0}}),32),qJ=function(t,e,n,i){this.vertexAccessor=t,this.bufferId=e,this.vertexOffset=n,this.vb=i},XJ=function(t){function e(n,i,r,o){var a;return(a=t.call(this,n,i)||this)._freeLists=[],a._vCount=0,a._iCount=0,a._vCount=r||Math.floor(1024*ue.BATCHER2D_MEM_INCREMENT/a._vertexFormatBytes),a._iCount=o||a._vCount*e.IB_SCALE,a._allocateBuffer(),a}$(e,t);var n=e.prototype;return n.destroy=function(){for(var e=0;e<this._buffers.length;++e){this._buffers[e].destroy();for(var n=this._freeLists[e],i=0;i<n.length;++i)jJ.free(n[i])}this._buffers.length=0,this._freeLists.length=0,t.prototype.destroy.call(this)},n.reset=function(){for(var t=0;t<this._buffers.length;++t){var e=this._buffers[t];e.indexOffset=0,e.reset()}},n.getVertexBuffer=function(t){return this._buffers[t].vData},n.getIndexBuffer=function(t){return this._buffers[t].iData},n.getMeshBuffer=function(t){return this._buffers[t]},n.uploadBuffers=function(){for(var t=0;t<this._buffers.length;++t){var e=this._freeLists[t][0],n=this._buffers[t];(!e||e.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(t,e){var n=this._buffers[t];e.length&&(n.iData.set(e,n.indexOffset),n.indexOffset+=e.length)},n.allocateChunk=function(t,e){for(var n,i=t*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(t,e)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new qJ(this,o,u,h,e)}return M(9004,i),null},n.recycleChunk=function(t){var e=this._freeLists[t.bufferId],n=this._buffers[t.bufferId],i=t.vertexOffset*this.vertexFormatBytes,r=t.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=e[a];c&&c.offset<i;)s=c,c=e[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,e.splice(a,1),jJ.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=jJ.alloc();l.offset=i,l.length=r,e.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=jJ.alloc();u.offset=i,u.length=r,e.push(u)}}},n._allocateChunkFromEntry=function(t,e,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[t];a.byteOffset<o&&(a.byteOffset=o),B(r>=0,9004,t,n.offset,n.length),0===r?(this._freeLists[t].splice(e,1),jJ.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){B(this._buffers.length===this._freeLists.length,9003);var t=new GJ,e=this._vCount*this._floatsPerVertex;t.initialize(this._device,this._attributes,e,this._iCount),this._buffers.push(t);var n=jJ.alloc();n.offset=0,n.length=t.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},e}(WJ);XJ.IB_SCALE=4;var YJ=new Gr(null),KJ=new Vn,QJ=t("UI",function(){function t(t){var e=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new cg,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new JJ,this._meshDataArray=[],this._root=t,this.device=t.device,this._batches=new ql(64),this._drawBatchPool=new Wl((function(){return new YK}),128,(function(t){return t.destroy(e)}))}var e=t.prototype;return e.initialize=function(){return!0},e.destroy=function(){for(var t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(t){t.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),nW.sharedManager.destroy()},e.addScreen=function(t){this._screens.push(t),this._screens.sort(this._screenSort)},e.removeScreen=function(t){var e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(t){if(t.scene&&t.scene.renderScene)for(var e=t.scene.renderScene.cameras,n=0;n<e.length;n++){var i=e[n];if(i.visibility&t.layer)return i}return null},e.update=function(){for(var t=this._screens,e=0,n=0;n<t.length;++n){var i=t[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var o=0;if(this._batches.length>e)for(;e<this._batches.length;++e){var a=this._batches.array[e];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},e.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(t){t.uploadBuffers()})),this._bufferAccessors.forEach((function(t){t.uploadBuffers(),t.reset()})),this._descriptorSetCache.update())},e.reset=function(){for(var t=0;t<this._batches.length;++t){var e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._bufferAccessors.forEach((function(t){t.reset()})),this._meshDataArray.forEach((function(t){t.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),nW.sharedManager.reset()},e.switchBufferAccessor=function(t){void 0===t&&(t=nV);var e=t===nV?36:oV(t);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==e){var n=this._bufferAccessors.get(e);n||(n=new XJ(this.device,t),this._bufferAccessors.set(e,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},e.registerBufferAccessor=function(t,e){this._bufferAccessors.set(t,e)},e.updateBuffer=function(t,e){var n=this.switchBufferAccessor(t);this._currBID!==e&&(this._currBID=e,this._indexStart=n.getMeshBuffer(e).indexOffset)},e.commitComp=function(t,e,n,i,r){var o,a=0,s=-1;if(e&&e.chunk){if(!e.isValid())return;a=e.dataHash,o=e.material,s=e.chunk.bufferId}t.stencilStage=nW.sharedManager.stage;var c=t.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),e&&!e.isMeshBuffer&&this.updateBuffer(e.vertexFormat,s),this._currRenderData=e,this._currHash=e?e.dataHash:0,this._currComponent=t,this._currTransform=r,this._currMaterial=t.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=t.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(t,this)},e.commitIA=function(t,e,n,i,r){var o,a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;t&&(o=-1===t.blendHash?null:t.getBlendState(),c=t.blendHash,t.stencilStage=nW.sharedManager.stage,a=null!==t.customMaterial?nW.sharedManager.getStencilStage(t.stencilStage,i):nW.sharedManager.getStencilStage(t.stencilStage),s=nW.sharedManager.getStencilHash(t.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=t.node.layer,l.inputAssembler=e,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,a,s,o,c,null,this),this._batches.push(l)},e.commitModel=function(t,e,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(t.stencilStage!==xV.ENABLED&&t.stencilStage!==xV.DISABLED||(t.stencilStage=nW.sharedManager.stage),i=nW.sharedManager.getStencilStage(t.stencilStage,n),r=nW.sharedManager.getStencilHash(t.stencilStage));var o=u.director.getTotalFrames();e&&(e.updateTransform(o),e.updateUBOs(o));for(var a=0;a<e.subModels.length;a++){var s=this._drawBatchPool.alloc(),c=e.subModels[a];s.visFlags=t.node.layer,s.model=e,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,c.patches,this),s.inputAssembler=c.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=c.descriptorSet,this._batches.push(s)}},e.setupStaticBatch=function(t,e){this.finishMergeBatches(),this._staticVBBuffer=e,this.currStaticRoot=t},e.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},e.commitStaticBatch=function(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(t){var e=this._currMaterial;if(e){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;t&&(c=-1===t.blendHash?null:t.getBlendState(),h=t.blendHash,l=null!==t.customMaterial?nW.sharedManager.getStencilStage(t.stencilStage,e):nW.sharedManager.getStencilStage(t.stencilStage),u=nW.sharedManager.getStencilHash(t.stencilStage));var f=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();f.visFlags=this._currLayer,f.texture=this._currTexture,f.sampler=this._currSampler,f.inputAssembler=n,f.useLocalData=this._currTransform,f.textureHash=this._currTextureHash,f.samplerHash=this._currSamplerHash,f.fillPasses(e,l,u,c,h,null,this),this._batches.push(f)}}},e.forceMergeBatches=function(t,e,n){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},e.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},e.flushMaterial=function(t){this._currMaterial=t},e.walk=function(t,e){if(void 0===e&&(e=0),t.activeInHierarchy){var n=t.children,i=t._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0){!function(t,e){for(var n,i,r,o=t.vertexFormat,a=t.chunk.vb,s=0,c=0;c<o.length;++c){if(n=o[c],(i=Jr[n.format]).hasAlpha)if(r=t.floatStride,i.size/i.count==1)for(var l=~~sn(Math.round(255*e),0,255),u=s;u<a.length;u+=r)a[u]=(4294967040&a[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<a.length;h+=r)a[h]=e;s+=i.size>>2}}(r.renderData,a);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!t._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,e)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),e+=1}},e._screenSort=function(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(t){this._descriptorSetCache.releaseDescriptorSetCache(t)},Z(t,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(t){this._currStaticRoot=t}},{key:"currIsStatic",set:function(t){this._currIsStatic=t}}]),t}()),ZJ=function(){function t(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var t=u.director.root.device;this._localData=new Float32Array(f_.COUNT),this._localBuffer=t.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,f_.SIZE,f_.SIZE))}var e=t.prototype;return e.initialize=function(t){var e=u.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,YJ.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet(YJ),this._descriptorSet.bindBuffer(f_.BINDING,this._localBuffer);var n=Wd.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,t.texture),this._descriptorSet.bindSampler(n,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0},e.updateTransform=function(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())},e.equals=function(t,e,n){return this._transform===t&&this._textureHash===e&&this._samplerHash===n},e.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},e.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},e.isValid=function(){return this._transform&&this._transform.isValid},e.uploadLocalData=function(){var t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var e=t.worldMatrix;Vn.toArray(this._localData,e,f_.MAT_WORLD_OFFSET),Vn.inverseTranspose(KJ,e);var n=Vn.determinant(KJ),i=1/Math.sqrt(n);Vn.multiplyScalar(KJ,KJ,i),Vn.toArray(this._localData,KJ,f_.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},Z(t,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),t}(),JJ=function(){function t(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Wl((function(){return new ZJ}),16,(function(t){return t.destroy()}))}var e=t.prototype;return e.getDescriptorSet=function(t){var e,n=u.director.root;if(t.useLocalData){for(var i=this._localDescriptorSetCache,r=0,o=i.length;r<o;r++){var a=i[r];if(a.equals(t.useLocalData,t.textureHash,t.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(t),this._localDescriptorSetCache.push(s),s.descriptorSet}if(e=t.textureHash^t.samplerHash,this._descriptorSetCache.has(e))return this._descriptorSetCache.get(e);YJ.layout=t.passes[0].localSetLayout;var c=n.device.createDescriptorSet(YJ),l=Wd.SAMPLER_SPRITE;return c.bindTexture(l,t.texture),c.bindSampler(l,t.sampler),c.update(),this._descriptorSetCache.set(e,c),this._dsCacheHashByTexture.set(t.textureHash,e),c},e.update=function(){var t=this._localDescriptorSetCache,e=[];t.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=t.indexOf(n);e.push(i)}}));for(var n=e.length-1;n>=0;n--)t.splice(e[n],1)},e.reset=function(){var t=this;this._localDescriptorSetCache.forEach((function(e){t._localCachePool.free(e)})),this._localDescriptorSetCache.length=0},e.releaseDescriptorSetCache=function(t){var e=this._dsCacheHashByTexture.get(t);e&&this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).destroy(),this._descriptorSetCache.delete(e),this._dsCacheHashByTexture.delete(t))},e.destroy=function(){this._descriptorSetCache.forEach((function(t){t.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},t}();u.internal.Batcher2D=QJ,H(GJ.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(t){return{name:t,suggest:"please use meshBuffer.accessor."+t+" instead"}}))),U(GJ.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),G(GJ.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),U(QJ.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),G(AV.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),U(AV.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),t("QuadRenderData",function(t){function e(e){var n;return n=t.call(this,e)||this,M(9006),n}return $(e,t),e}(AV));var $J,t$,e$=null,n$=-1,i$="BES bswy:->@123丁ぁᄁ",r$=Object.create(null),o$=[],a$=3e3;function s$(){for(var t=!0,e=Date.now(),n=o$.length-1;n>=0;n--){var i=o$[n],r=i.fontFamilyName;if(e-i.startTime>a$)M(4933,r),i.onComplete(null,r),o$.splice(n,1);else{var o=i.refWidth,a="40px "+r;e$.font=a,o!==VH(e$,i$,a)?(o$.splice(n,1),i.onComplete(null,r)):t=!1}}t&&(clearInterval(n$),n$=-1)}function c$(t,e,n){var i=function(t){var e=t.lastIndexOf(".ttf");if(-1===e)return t;var n,i=t.lastIndexOf("/");return-1!==(n=-1===i?t.substring(0,e)+"_LABEL":t.substring(i+1,e)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(t);if(r$[i])n(null,i);else{if(!e$){var r=document.createElement("canvas");r.width=100,r.height=100,e$=r.getContext("2d")}var o=VH(e$,i$,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+t+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===$J)if("FontFace"in window){var t=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),e=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);$J=t?parseInt(t[1],10)>42:!e}else $J=!1;return $J}())!function(t,e,n){var i=new Promise((function(n,i){!function r(){Date.now()-t>=a$?i():document.fonts.load("40px "+e).then((function(t){t.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(t,e){r=setTimeout(e,a$)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,e)}),(function(){M(4933,e),n(null,e)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};o$.push(u),-1===n$&&(n$=setInterval(s$,100))}r$[i]=a}}function l$(t,e,n,i){var r=new CH;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}ON.register({".font":c$,".eot":c$,".ttf":c$,".woff":c$,".svg":c$,".ttc":c$}),UN.register({".font":l$,".eot":l$,".ttf":l$,".woff":l$,".svg":l$,".ttc":l$}),u.UI={MeshBuffer:GJ,spriteAssembler:LJ,graphicsAssembler:LQ,labelAssembler:nJ,RenderData:CV,MeshRenderData:AV},function(t){t[t.positions=Ki.ATTR_POSITION]="positions",t[t.normals=Ki.ATTR_NORMAL]="normals",t[t.uvs=Ki.ATTR_TEX_COORD]="uvs",t[t.colors=Ki.ATTR_COLOR]="colors"}(t$||(t$={}));var u$,h$,f$,p$,d$,_$=function(){function t(){this._arrayBufferOrPaddings=[],this._length=0}var e=t.prototype;return e.setNextAlignment=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;this._arrayBufferOrPaddings.push(n),this._length+=n}}},e.addBuffer=function(t){var e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e},e.getLength=function(){return this._length},e.getCombined=function(){var t=new Uint8Array(this._length),e=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n),e),e+=n.byteLength)})),t.buffer},t}(),m$=function(){function t(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>T_.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new g$(this._mesh,i,this._mesh.struct.morph,e):this._subMeshRenderings[i]=new v$(this._mesh,i,this._mesh.struct.morph,e))}}}return t.prototype.createInstance=function(){for(var t=this,e=this._mesh.struct.primitives.length,n=new Array(e),i=0;i<e;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(t,e){var i;null===(i=n[t])||void 0===i||i.setWeights(e)},requiredPatches:function(e){t._mesh.struct.morph;var i=t._mesh.struct.morph.subMeshMorphs[e],r=n[e];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(Ki.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(Ki.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(Ki.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(t,e){var i;null===(i=n[t])||void 0===i||i.adaptPipelineState(e)},destroy:function(){for(var t,e=st(n);!(t=e()).done;){var i=t.value;null==i||i.destroy()}}}},t}(),v$=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[e];this._subMeshMorph=r,T$(t,e,i);var o=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=S$(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(e,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(e,i){for(var r=e.displacements[n],s=new Float32Array(t.data.buffer,t.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:e,morphTexture:i}}))}var e=t.prototype;return e.destroy=function(){for(var t,e=st(this._attributes);!(t=e()).done;)t.value.morphTexture.destroy()},e.createInstance=function(){var t=this,e=new x$(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:function(t){e.setWeights(t),e.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=st(t._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case Ki.ATTR_POSITION:a=w_;break;case Ki.ATTR_NORMAL:a=I_;break;case Ki.ATTR_TANGENT:a=O_;break;default:S("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(T_.BINDING,e.buffer),n.update()},destroy:function(){}}},t}(),g$=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[e];T$(t,e,i),this._attributes=r.attributes.map((function(e,n){return{name:e,targets:r.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[n].offset,e.displacements[n].count)}}))}}))}return t.prototype.createInstance=function(){return new y$(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},Z(t,[{key:"data",get:function(){return this._attributes}}]),t}(),y$=function(){function t(t,e,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new x$(n,0);var i=S$(n,e);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(t){var e=i.create();return{attributeName:t.name,morphTexture:e}}))}var e=t.prototype;return e.setWeights=function(t){for(var e=0;e<this._attributes.length;++e){var n=this._attributes[e],i=n.morphTexture.valueView,r=this._owner.data[e];t.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=t[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},e.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},e.adaptPipelineState=function(t){for(var e,n=st(this._attributes);!(e=n()).done;){var i=e.value,r=void 0;switch(i.attributeName){case Ki.ATTR_POSITION:r=w_;break;case Ki.ATTR_NORMAL:r=I_;break;case Ki.ATTR_TANGENT:r=O_;break;default:S("Unexpected attribute!")}void 0!==r&&(t.bindSampler(r,i.morphTexture.sampler),t.bindTexture(r,i.morphTexture.texture))}t.bindBuffer(T_.BINDING,this._morphUniforms.buffer),t.update()},e.destroy=function(){this._morphUniforms.destroy();for(var t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()},t}(),x$=function(){function t(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(T_.SIZE)),this._remoteBuffer=t.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,T_.SIZE,T_.SIZE))}var e=t.prototype;return e.destroy=function(){this._remoteBuffer.destroy()},e.setWeights=function(t){t.length,this._targetCount;for(var e=0;e<t.length;++e)this._localBuffer.setFloat32(T_.OFFSET_OF_WEIGHTS+4*e,t[e],u.sys.isLittleEndian)},e.setMorphTextureInfo=function(t,e){this._localBuffer.setFloat32(T_.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,u.sys.isLittleEndian),this._localBuffer.setFloat32(T_.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,u.sys.isLittleEndian)},e.setVerticesCount=function(t){this._localBuffer.setFloat32(T_.OFFSET_OF_VERTICES_COUNT,t,u.sys.isLittleEndian)},e.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},Z(t,[{key:"buffer",get:function(){return this._remoteBuffer}}]),t}();function S$(t,e){var n,i,o,s;t.hasFeature(hi.TEXTURE_FLOAT)?(n=e,o=16,i=Ev.PixelFormat.RGBA32F,s=Float32Array):(n=4*e,o=4,i=Ev.PixelFormat.RGBA8888,s=Uint8Array);var c=function(t){t<5&&(t=5);var e=r(a(t)),n=e>>1;return{width:1<<(1&e?n+1:n),height:1<<n}}(n),l=c.width,u=c.height;return{width:l,height:u,create:function(){var e=new ArrayBuffer(l*u*o),n=new Float32Array(e),r=s===Float32Array?n:new s(e),a=new tv({width:l,height:u,_data:r,_compressed:!1,format:i}),c=new Ev;c.setFilters(Ev.Filter.NEAREST,Ev.Filter.NEAREST),c.setMipFilter(Ev.Filter.NONE),c.setWrapMode(Ev.WrapMode.CLAMP_TO_EDGE,Ev.WrapMode.CLAMP_TO_EDGE,Ev.WrapMode.CLAMP_TO_EDGE),c.image=a,c.getGFXTexture()||S("Unexpected: failed to create morph texture?");var h=t.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(r)}}}}}function T$(t,e,n){t.renderingSubMeshes[e].enableVertexIdChannel(n)}function E$(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var b$=new Rn,C$=new Rn,A$=new Uint8Array,w$=t("Mesh",dc("cc.Mesh")((d$=function(t){function e(){var e;return(e=t.call(this)||this).morphRendering=null,ct(e,"_struct",f$,ot(e)),ct(e,"_hash",p$,ot(e)),e._data=A$,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}$(e,t);var n=e.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var t=this._data.buffer,e=u.director.root.device,n=this._createVertexBuffers(e,t),i=[],r=0;r<this._struct.primitives.length;r++){var o=this._struct.primitives[r];if(0!==o.vertexBundelIndices.length){var a=null,s=null;if(o.indexView){var c=o.indexView,l=c.stride,h=c.length;if(4===l&&!e.hasFeature(hi.ELEMENT_INDEX_UINT)){var f=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(f>=65536){M(10001,f,65536);continue}l>>=1,h>>=1}a=e.createBuffer(new hr(_i.INDEX,gi.DEVICE,h,l)),s=new(E$(c.stride))(t,c.offset,c.count),c.stride!==l&&(s=E$(l).from(s)),a.update(s)}var p=o.vertexBundelIndices.map((function(t){return n[t]})),d=[];if(o.vertexBundelIndices.length>0)for(var _=o.vertexBundelIndices[0],m=this._struct.vertexBundles[_].attributes,v=0;v<m.length;++v){var g=m[v];d[v]=new Rr(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new GA(p,d,o.primitiveMode,a);y.mesh=this,y.subMeshIdx=r,i.push(y)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(t,e){return new m$(t,e)}(this,e))}},n.destroy=function(){return this.destroyRenderingMesh(),t.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(t,e){this.reset({struct:t,data:e})},n.reset=function(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0},n.getBoneSpaceBounds=function(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);var e=[];this._boneSpaceBounds.set(t.hash,e);for(var n=[],i=t.bindposes,r=0;r<i.length;r++)e.push(new js(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,Ki.ATTR_JOINTS),c=this.readAttribute(a,Ki.ATTR_WEIGHTS),l=this.readAttribute(a,Ki.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){Rn.set(b$,l[3*h+0],l[3*h+1],l[3*h+2]);for(var f=0;f<4;++f){var p=4*h+f,d=s[p];if(!(0===c[p]||d>=i.length)){Rn.transformMat4(C$,b$,i[d]),n[d]=!0;var _=e[d];Rn.min(_.center,_.center,C$),Rn.max(_.halfExtents,_.halfExtents,C$)}}}}for(var m=0;m<i.length;m++){var v=e[m];n[m]?js.fromPoints(v,v.center,v.halfExtents):e[m]=null}return e},n.merge=function(t,e,n){if(n&&!this.validateMergingMesh(t))return!1;var i=new Rn,r=e&&new Ln,o=e&&new js;if(r&&e.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(t._struct)),s=t._data.slice();if(e){a.maxPosition&&a.minPosition&&(Rn.add(o.center,a.maxPosition,a.minPosition),Rn.multiplyScalar(o.center,o.center,.5),Rn.subtract(o.halfExtents,a.maxPosition,a.minPosition),Rn.multiplyScalar(o.halfExtents,o.halfExtents,.5),js.transform(o,o,e),Rn.add(a.maxPosition,o.center,o.halfExtents),Rn.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===Ki.ATTR_POSITION||l.attributes[u].name===Ki.ATTR_NORMAL){var h=l.attributes[u].format,f=new DataView(s.buffer,l.view.offset+R$(l.attributes,u)),p=M$(f,h),d=D$(f,h);if(!p||!d)continue;for(var _=l.view.count,m=l.view.stride,v=I$(h),g=0;g<_;g++){var y=g*m,x=y+v,S=x+v;switch(i.set(p(y),p(x),p(S)),l.attributes[u].name){case Ki.ATTR_POSITION:i.transformMat4(e);break;case Ki.ATTR_NORMAL:Rn.transformQuat(i,i,r)}d(y,i.x),d(x,i.y),d(S,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var T,E,b,C,A,w=new _$,R=0,P=0,I=0,M=0,D=0,O=0,N=0,L=0,B=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var k=this._struct.vertexBundles[z],U=t._struct.vertexBundles[z];I=k.view.offset,M=U.view.offset,P=k.view.stride,R=k.view.count+U.view.count,T=new ArrayBuffer(R*P),E=new Uint8Array(T),I+=(b=this._data.subarray(I,I+k.view.length)).length,M+=(C=t._data.subarray(M,M+U.view.length)).length,E.set(b),D=0;for(var G,H=st(k.attributes);!(G=H()).done;){var V=G.value;N=0,B=!1;for(var W,j=st(U.attributes);!(W=j()).done;){var q=W.value;if(V.name===q.name&&V.format===q.format){B=!0;break}N+=Jr[q.format].size}if(B){L=Jr[V.format].size,O=k.view.length+D;for(var X=0;X<U.view.count;++X){if(A=C.subarray(N,N+L),E.set(A,O),(V.name===Ki.ATTR_POSITION||V.name===Ki.ATTR_NORMAL)&&e){var Y=new Float32Array(E.buffer,O,3);switch(i.set(Y[0],Y[1],Y[2]),V.name){case Ki.ATTR_POSITION:i.transformMat4(e);break;case Ki.ATTR_NORMAL:Rn.transformQuat(i,i,r)}Y[0]=i.x,Y[1]=i.y,Y[2]=i.z}O+=k.view.stride,N+=U.view.stride}}D+=Jr[V.format].size}F[z]={attributes:k.attributes,view:{offset:w.getLength(),length:T.byteLength,count:R,stride:P}},w.addBuffer(T)}for(var K,Q,Z,J=0,$=2,tt=0,et=new Array(this._struct.primitives.length),nt=0;nt<this._struct.primitives.length;++nt){var it=this._struct.primitives[nt],rt=t._struct.primitives[nt];et[nt]={primitiveMode:it.primitiveMode,vertexBundelIndices:it.vertexBundelIndices};for(var ot,at=st(it.vertexBundelIndices);!(ot=at()).done;){var ct=ot.value;tt=Math.max(tt,this._struct.vertexBundles[ct].view.count)}if(it.indexView&&rt.indexView){J=it.indexView.count,J+=rt.indexView.count,I=it.indexView.offset,M=rt.indexView.offset,$=J<256?1:J<65536?2:4;var lt=new ArrayBuffer(J*$);if(K=2===$?new Uint16Array(lt):1===$?new Uint8Array(lt):new Uint32Array(lt),Q=2===it.indexView.stride?new Uint16Array(this._data.buffer,I,it.indexView.count):1===it.indexView.stride?new Uint8Array(this._data.buffer,I,it.indexView.count):new Uint32Array(this._data.buffer,I,it.indexView.count),$===it.indexView.stride)K.set(Q);else for(var ut=0;ut<it.indexView.count;++ut)K[ut]=Q[ut];I+=it.indexView.length,Z=2===rt.indexView.stride?new Uint16Array(t._data.buffer,M,rt.indexView.count):1===rt.indexView.stride?new Uint8Array(t._data.buffer,M,rt.indexView.count):new Uint32Array(t._data.buffer,M,rt.indexView.count);for(var ht=0;ht<rt.indexView.count;++ht)K[it.indexView.count+ht]=tt+Z[ht];M+=rt.indexView.length,et[nt].indexView={offset:w.getLength(),length:lt.byteLength,count:J,stride:$},w.setNextAlignment($),w.addBuffer(lt)}}var ft={vertexBundles:F,primitives:et,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return ft.minPosition&&t._struct.minPosition&&ft.maxPosition&&t._struct.maxPosition&&(e?(Rn.add(o.center,t._struct.maxPosition,t._struct.minPosition),Rn.multiplyScalar(o.center,o.center,.5),Rn.subtract(o.halfExtents,t._struct.maxPosition,t._struct.minPosition),Rn.multiplyScalar(o.halfExtents,o.halfExtents,.5),js.transform(o,o,e),Rn.add(i,o.center,o.halfExtents),Rn.max(ft.maxPosition,ft.maxPosition,i),Rn.subtract(i,o.center,o.halfExtents),Rn.min(ft.minPosition,ft.minPosition,i)):(Rn.min(ft.minPosition,ft.minPosition,t._struct.minPosition),Rn.max(ft.maxPosition,ft.maxPosition,t._struct.maxPosition))),this.reset({struct:ft,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(var e=0;e<this._struct.vertexBundles.length;++e){var n=this._struct.vertexBundles[e],i=t._struct.vertexBundles[e];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=t._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(t,e){var n=this,i=null;return this._accessAttribute(t,e,(function(t,e){var r=t.view.count,o=t.attributes[e].format,a=co(Jr[o]);if(0!==r){var s=new DataView(n._data.buffer,t.view.offset+R$(t.attributes,e)),c=Jr[o],l=M$(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),f=t.view.stride,p=0;p<r;++p)for(var d=0;d<u;++d)h[u*p+d]=l(f*p+h.BYTES_PER_ELEMENT*d);i=h}}})),i},n.copyAttribute=function(t,e,n,i,r){var o=this,a=!1;return this._accessAttribute(t,e,(function(t,e){var s=t.view.count;if(0!==s){var c=t.attributes[e].format,l=new DataView(o._data.buffer,t.view.offset+R$(t.attributes,e)),u=new DataView(n,r),h=Jr[c],f=M$(l,c),p=D$(u,c);if(f&&p){for(var d=h.count,_=t.view.stride,m=I$(c),v=i,g=m,y=0;y<s;++y)for(var x=0;x<d;++x)p(v*y+g*x,f(_*y+m*x));a=!0}}else a=!0})),a},n.readIndices=function(t){if(t>=this._struct.primitives.length)return null;var e=this._struct.primitives[t];if(!e.indexView)return null;var n=e.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},n.copyIndices=function(t,e){if(t>=this._struct.primitives.length)return!1;var n=this._struct.primitives[t];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?fi.R8UI:2===n.indexView.stride?fi.R16UI:fi.R32UI,o=M$(new DataView(this._data.buffer),r),a=0;a<i;++a)e[a]=o(n.indexView.offset+Jr[r].size*a);return!0},n._accessAttribute=function(t,e,n){if(!(t>=this._struct.primitives.length))for(var i,r=st(this._struct.primitives[t].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(t){return t.name===e}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(t,e){return this._struct.vertexBundles.map((function(n){var i=t.createBuffer(new hr(_i.VERTEX,gi.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(e,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:A$})},Z(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data=new Uint8Array(t)}},{key:"subMeshCount",get:function(){var t=this.renderingSubMeshes;return t?t.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=go(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(t){return t.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),e}(Du),f$=lt((h$=d$).prototype,"_struct",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),p$=lt(h$.prototype,"_hash",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),u$=h$))||u$);function R$(t,e){for(var n=0,i=0;i<e;++i){var r=t[i];n+=Jr[r.format].size}return n}u.Mesh=w$;var P$=lh.isLittleEndian;function I$(t){var e=Jr[t];return e.size/e.count}function M$(t,e){var n=Jr[e],i=n.size/n.count;switch(n.type){case pi.UNORM:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,P$)};case 4:return function(e){return t.getUint32(e,P$)}}break;case pi.SNORM:case pi.INT:switch(i){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,P$)};case 4:return function(e){return t.getInt32(e,P$)}}break;case pi.UINT:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,P$)};case 4:return function(e){return t.getUint32(e,P$)}}break;case pi.FLOAT:return function(e){return t.getFloat32(e,P$)}}return null}function D$(t,e){var n=Jr[e],i=n.size/n.count;switch(n.type){case pi.UNORM:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,P$)};case 4:return function(e,n){return t.setUint32(e,n,P$)}}break;case pi.SNORM:case pi.INT:switch(i){case 1:return function(e,n){return t.setInt8(e,n)};case 2:return function(e,n){return t.setInt16(e,n,P$)};case 4:return function(e,n){return t.setInt32(e,n,P$)}}break;case pi.UINT:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,P$)};case 4:return function(e,n){return t.setUint32(e,n,P$)}}break;case pi.FLOAT:return function(e,n){return t.setFloat32(e,n,P$)}}return null}var O$=[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_NORMAL,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD,fi.RG32F),new Rr(Ki.ATTR_TANGENT,fi.RGBA32F),new Rr(Ki.ATTR_COLOR,fi.RGBA32F)],N$=new Rn;function L$(t,e,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=t.positions.slice();if(c.length>0){if(i=null,t.attributes)for(var l,u=st(t.attributes);!(l=u()).done;){var h=l.value;if(h.name===Ki.ATTR_POSITION){i=h;break}}i||(i=O$[0]),r.push(i);var f=Jr[i.format];s=Math.max(s,Math.floor(c.length/f.count)),a.push({offset:o,data:c,attribute:i}),o+=f.size}if(t.normals&&t.normals.length>0){if(i=null,t.attributes)for(var p,d=st(t.attributes);!(p=d()).done;){var _=p.value;if(_.name===Ki.ATTR_NORMAL){i=_;break}}i||(i=O$[1]);var m=Jr[i.format];r.push(i),s=Math.max(s,Math.floor(t.normals.length/m.count)),a.push({offset:o,data:t.normals,attribute:i}),o+=m.size}if(t.uvs&&t.uvs.length>0){if(i=null,t.attributes)for(var v,g=st(t.attributes);!(v=g()).done;){var y=v.value;if(y.name===Ki.ATTR_TEX_COORD){i=y;break}}i||(i=O$[2]);var x=Jr[i.format];r.push(i),s=Math.max(s,Math.floor(t.uvs.length/x.count)),a.push({offset:o,data:t.uvs,attribute:i}),o+=x.size}if(t.tangents&&t.tangents.length>0){if(i=null,t.attributes)for(var S,T=st(t.attributes);!(S=T()).done;){var E=S.value;if(E.name===Ki.ATTR_TANGENT){i=E;break}}i||(i=O$[3]);var b=Jr[i.format];r.push(i),s=Math.max(s,Math.floor(t.tangents.length/b.count)),a.push({offset:o,data:t.tangents,attribute:i}),o+=b.size}if(t.colors&&t.colors.length>0){if(i=null,t.attributes)for(var C,A=st(t.attributes);!(C=A()).done;){var w=C.value;if(w.name===Ki.ATTR_COLOR){i=w;break}}i||(i=O$[4]);var R=Jr[i.format];r.push(i),s=Math.max(s,Math.floor(t.colors.length/R.count)),a.push({offset:o,data:t.colors,attribute:i}),o+=R.size}if(t.customAttributes)for(var P,I=st(t.customAttributes);!(P=I()).done;){var M=P.value,D=Jr[M.attr.format];r.push(M.attr),s=Math.max(s,Math.floor(M.values.length/D.count)),a.push({offset:o,data:M.values,attribute:M.attr}),o+=D.size}for(var O=new _$,N=new ArrayBuffer(s*o),L=new DataView(N),B=0,F=a;B<F.length;B++){var z=F[B];BA(L,z.data,z.attribute.format,z.offset,o)}O.setNextAlignment(0);var k={attributes:r,view:{offset:O.getLength(),length:N.byteLength,count:s,stride:o}};O.addBuffer(N);var U=null,G=0;if(t.indices){var H=t.indices;G=H.length,U=new ArrayBuffer(2*G),BA(new DataView(U),H,fi.R16UI)}var V={primitiveMode:t.primitiveMode||Fi.TRIANGLE_LIST,vertexBundelIndices:[0]};U&&(O.setNextAlignment(2),V.indexView={offset:O.getLength(),length:U.byteLength,count:G,stride:2},O.addBuffer(U));var W=t.minPos;if(!W&&n.calculateBounds){W=Rn.set(new Rn,1/0,1/0,1/0);for(var j=0;j<s;++j)Rn.set(N$,c[3*j+0],c[3*j+1],c[3*j+2]),Rn.min(W,W,N$)}var q=t.maxPos;if(!q&&n.calculateBounds){q=Rn.set(new Rn,-1/0,-1/0,-1/0);for(var X=0;X<s;++X)Rn.set(N$,c[3*X+0],c[3*X+1],c[3*X+2]),Rn.max(q,q,N$)}var Y={vertexBundles:[k],primitives:[V]};return W&&(Y.minPosition=new Rn(W.x,W.y,W.z)),q&&(Y.maxPosition=new Rn(q.x,q.y,q.z)),e||(e=new w$),e.reset({struct:Y,data:new Uint8Array(O.getCombined())}),e}var B$=Object.freeze({__proto__:null,find:TM,toPPM:function(t,e,n){return"P3 "+e+" "+n+" 255\n"+t.filter((function(t,e){return e%4<3})).toString()+"\n"},readMesh:function(t,e){void 0===e&&(e=0);for(var n,i={positions:[]},r=new DataView(t.data.buffer,t.data.byteOffset,t.data.byteLength),o=t.struct,a=o.primitives[e],s=st(a.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=o.vertexBundles[l],h=u.view.offset,f=u.view,p=f.length,d=f.stride,_=st(u.attributes);!(c=_()).done;){var m=c.value,v=t$[m.name];v&&(i[v]=(i[v]||[]).concat(FA(r,m.format,h,p,d))),h+=Jr[m.format].size}var g=a.indexView;return i.indices=FA(r,fi["R"+8*g.stride+"UI"],g.offset,g.length),i},createMesh:L$,readBuffer:FA,writeBuffer:BA,mapBuffer:zA});t("utils",B$);var F$,z$,k$,U$,G$,H$,V$,W$,j$,q$,X$,Y$,K$,Q$,Z$,J$,$$,t0,e0,n0,i0,r0,o0,a0,s0,c0,l0,u0,h0,f0,p0,d0,_0,m0,v0,g0,y0,x0,S0,T0,E0=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._morphRenderingInstance=null,e._usedMaterials=new Set,e}$(e,t);var n=e.prototype;return n.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):t.prototype.getMacroPatches.call(this,e)},n.initSubModel=function(e,n,i){return t.prototype.initSubModel.call(this,e,n,this._launderMaterial(i))},n.destroy=function(){t.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(e,n){return t.prototype.setSubModelMaterial.call(this,e,this._launderMaterial(n))},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,n)},n._launderMaterial=function(t){return t},n.setMorphRendering=function(t){this._morphRenderingInstance=t},e}(cT),b0=oe({OFF:0,ON:1}),C0=oe({OFF:0,ON:1}),A0=(F$=dc("cc.ModelLightmapSettings"),z$=Sc("_recieveShadow"),F$((X$=function(){function t(){ct(this,"texture",G$,this),ct(this,"uvParam",H$,this),ct(this,"_bakeable",V$,this),ct(this,"_castShadow",W$,this),ct(this,"_receiveShadow",j$,this),ct(this,"_lightmapSize",q$,this)}return Z(t,[{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(t){this._lightmapSize=t}}]),t}(),G$=lt((U$=X$).prototype,"texture",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H$=lt(U$.prototype,"uvParam",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn}}),V$=lt(U$.prototype,"_bakeable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),W$=lt(U$.prototype,"_castShadow",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),j$=lt(U$.prototype,"_receiveShadow",[z$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q$=lt(U$.prototype,"_lightmapSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),lt(U$.prototype,"bakeable",[Mc],Object.getOwnPropertyDescriptor(U$.prototype,"bakeable"),U$.prototype),lt(U$.prototype,"castShadow",[Mc],Object.getOwnPropertyDescriptor(U$.prototype,"castShadow"),U$.prototype),lt(U$.prototype,"receiveShadow",[Mc],Object.getOwnPropertyDescriptor(U$.prototype,"receiveShadow"),U$.prototype),lt(U$.prototype,"lightmapSize",[Mc],Object.getOwnPropertyDescriptor(U$.prototype,"lightmapSize"),U$.prototype),k$=U$))||k$),w0=function(e){return t({MeshRenderer:e,ModelComponent:e}),e}((Y$=dc("cc.MeshRenderer"),K$=Ic(),Q$=mc(100),Z$=Ac(),J$=Kc(b0),$$=Lc(),t0=Kc(C0),e0=Lc(),n0=Kc(w$),i0=Lc(),r0=Dc(),Y$(o0=K$(o0=Q$(o0=Z$(o0=Cc((p0=f0=function(t){function e(){var e;return ct(e=t.call(this)||this,"lightmapSettings",s0,ot(e)),ct(e,"_mesh",c0,ot(e)),ct(e,"_shadowCastingMode",l0,ot(e)),ct(e,"_shadowReceivingMode",u0,ot(e)),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,ct(e,"_enableMorph",h0,ot(e)),e._modelType=cT,e}$(e,t);var n=e.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(u.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(t,e){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[t];return n.length,n[e]},n.setWeights=function(t,e){var n=this._subMeshShapesWeights;e>=n.length||n[e].length===t.length&&(n[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))},n.setWeight=function(t,e,n){var i=this._subMeshShapesWeights;if(!(e>=i.length)){var r=i[e];n>=r.length||(r[n]=t,this._uploadSubMeshShapesWeights(e))}},n.setInstancedAttribute=function(t,e){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===t){r[o].set(e);break}},n._updateLightmap=function(t,e,n,i,r){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var t=this._morphInstance&&this._modelType===cT?E0:this._modelType,e=this._model=u.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof E0&&e.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=iy.POSITION,this._model.transform.hasChangedFlags|=iy.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(var n=0;n<t;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=e[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},n._onRebuildPSO=function(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var t=this._model.subModels,e=0;e<t.length;++e)this._onMaterialModified(e,null)},n._getBuiltinMaterial=function(){return Dv.get("missing-material")},n._onVisibilityChange=function(t){this._model&&(this._model.visFlags=t)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===b0.OFF?this._model.castShadow=!1:(this._shadowCastingMode,b0.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===C0.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var t=0;t<this._materials.length;++t){var e=this._materials[t];if(e)for(var n=0;n<e.passes.length;++n)if(e.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof E0&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var t=this._mesh;if(this._subMeshShapesWeights.length=0,t){var e=t.struct.morph;if(e){var n=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((function(t){return t?t.weights?t.weights.slice(0):n?(n.length,t.targets.length,n.slice(0)):new Array(t.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var t=this._mesh,e=this._subMeshShapesWeights;if(!t||!t.struct.morph)return 0===e.length;var n=t.struct.morph;return n.subMeshMorphs.length===e.length&&e.every((function(t,e){var i,r,o=t.length;return(null!==(i=null===(r=n.subMeshMorphs[e])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])},Z(e,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(t){this._shadowCastingMode=t,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(t){var e=this._mesh,n=this._mesh=t;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(t){this._enableMorph=t}}]),e}(pF),f0.ShadowCastingMode=b0,f0.ShadowReceivingMode=C0,s0=lt((a0=p0).prototype,"lightmapSettings",[xc,Mc,Wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new A0}}),c0=lt(a0.prototype,"_mesh",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l0=lt(a0.prototype,"_shadowCastingMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return b0.OFF}}),u0=lt(a0.prototype,"_shadowReceivingMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C0.ON}}),lt(a0.prototype,"shadowCastingMode",[J$,$$,Wc],Object.getOwnPropertyDescriptor(a0.prototype,"shadowCastingMode"),a0.prototype),lt(a0.prototype,"receiveShadow",[t0,e0,Wc],Object.getOwnPropertyDescriptor(a0.prototype,"receiveShadow"),a0.prototype),lt(a0.prototype,"mesh",[n0,i0],Object.getOwnPropertyDescriptor(a0.prototype,"mesh"),a0.prototype),lt(a0.prototype,"enableMorph",[r0,Wc],Object.getOwnPropertyDescriptor(a0.prototype,"enableMorph"),a0.prototype),h0=lt(a0.prototype,"_enableMorph",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),o0=a0))||o0)||o0)||o0)||o0)||o0));function R0(t,e){var n=t.sharedMaterials.length;if(n!==e.sharedMaterials.length)return!1;for(var i=0;i<n;i++)if(t.getRenderMaterial(i)!==e.getRenderMaterial(i))return!1;return!0}t("BatchingUtility",function(){function t(){}return t.batchStaticModel=function(t,e){var n=t.getComponentsInChildren(w0);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var i=1;i<n.length;i++){if(!n[0].mesh.validateMergingMesh(n[i].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1;if(!R0(n[0],n[i]))return console.error("the materials of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1}var r=new w$,o=new Vn,a=new Vn;t.getWorldMatrix(a),Vn.invert(a,a);for(var s=0;s<n.length;s++){var c=n[s];c.node.getWorldMatrix(o),Vn.multiply(o,a,o),r.merge(n[s].mesh,o),c.enabled=!1}var l=e.addComponent(w0);return l.mesh=r,l.sharedMaterials=n[0].sharedMaterials,!0},t.unbatchStaticModel=function(t,e){for(var n=t.getComponentsInChildren(w0),i=0;i<n.length;i++)n[i].enabled=!0;var r=e.getComponent(w0);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},t}()),U(w$.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),G(w$.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);var P0,I0,M0,D0,O0,N0,L0,B0,F0,z0,k0,U0,G0,H0,V0,W0,j0,q0,X0,Y0,K0,Q0,Z0=t("Skeleton",(d0=dc("cc.Skeleton"),_0=Kc([Le]),m0=Kc([Vn]),d0((T0=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_joints",y0,ot(e)),ct(e,"_bindposes",x0,ot(e)),ct(e,"_hash",S0,ot(e)),e._invBindposes=null,e}$(e,t);var n=e.prototype;return n.destroy=function(){var e,n;return null===(e=null===(n=u.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===e||e.releaseSkeleton(this),t.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},Z(e,[{key:"joints",get:function(){return this._joints},set:function(t){this._joints=t}},{key:"bindposes",get:function(){return this._bindposes},set:function(t){this._bindposes=t}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var t=0;t<this._bindposes.length;t++){var e=new Vn;Vn.invert(e,this._bindposes[t]),this._invBindposes.push(e)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var t="",e=0;e<this._bindposes.length;e++){var n=this._bindposes[e];t+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=go(t,666)}return this._hash}}]),e}(Du),y0=lt((g0=T0).prototype,"_joints",[_0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),x0=lt(g0.prototype,"_bindposes",[m0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),S0=lt(g0.prototype,"_hash",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v0=g0))||v0));u.Skeleton=Z0,G(w0.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),u.ModelComponent=w0,ie.setClassAlias(w0,"cc.ModelComponent");var J0,$0,t1,e1,n1,i1,r1,o1,a1,s1,c1,l1,u1,h1,f1,p1,d1,_1,m1,v1,g1,y1,x1,S1,T1,E1,b1,C1,A1,w1,R1,P1,I1,M1,D1,O1,N1,L1,B1,F1,z1,k1,U1,G1,H1,V1,W1,j1,q1,X1,Y1,K1,Q1,Z1,J1,$1=oe({LUMINOUS_FLUX:0,LUMINANCE:1}),t2=new Rn,e2=dc("cc.StaticLightSettings")((L0=function(){function t(){ct(this,"_baked",M0,this),ct(this,"_editorOnly",D0,this),ct(this,"_bakeable",O0,this),ct(this,"_castShadow",N0,this)}return Z(t,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(t){this._editorOnly=t}},{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}}]),t}(),M0=lt((I0=L0).prototype,"_baked",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),D0=lt(I0.prototype,"_editorOnly",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),O0=lt(I0.prototype,"_bakeable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),N0=lt(I0.prototype,"_castShadow",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(I0.prototype,"editorOnly",[Mc],Object.getOwnPropertyDescriptor(I0.prototype,"editorOnly"),I0.prototype),lt(I0.prototype,"bakeable",[Mc],Object.getOwnPropertyDescriptor(I0.prototype,"bakeable"),I0.prototype),lt(I0.prototype,"castShadow",[Mc],Object.getOwnPropertyDescriptor(I0.prototype,"castShadow"),I0.prototype),P0=I0))||P0,n2=function(e){return t({Light:e,LightComponent:e}),e}((B0=dc("cc.Light"),F0=Lc(),z0=Lc(),k0=Bc(),U0=Lc(),G0=Kc(e2),H0=Gc(),B0((Q0=K0=function(t){function e(){var e;return ct(e=t.call(this)||this,"_color",j0,ot(e)),ct(e,"_useColorTemperature",q0,ot(e)),ct(e,"_colorTemperature",X0,ot(e)),ct(e,"_staticSettings",Y0,ot(e)),e._type=ry.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=xy,e}$(e,t);var n=e.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=u.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(u.director.root.destroyLight(this),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var t=this._getRenderScene();switch(this._type){case ry.DIRECTIONAL:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case ry.SPHERE:t.addSphereLight(this._light);break;case ry.SPOT:t.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var t=this._light.scene;switch(this._type){case ry.DIRECTIONAL:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case ry.SPHERE:t.removeSphereLight(this._light);break;case ry.SPOT:t.removeSpotLight(this._light)}}},Z(e,[{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._light&&(t2.x=t.r/255,t2.y=t.g/255,t2.z=t.b/255,this._light.color=t2)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(t){this._staticSettings=t}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}}]),e}($u),K0.Type=ry,K0.PhotometricTerm=$1,j0=lt((W0=Q0).prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),q0=lt(W0.prototype,"_useColorTemperature",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X0=lt(W0.prototype,"_colorTemperature",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),Y0=lt(W0.prototype,"_staticSettings",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e2}}),lt(W0.prototype,"color",[F0],Object.getOwnPropertyDescriptor(W0.prototype,"color"),W0.prototype),lt(W0.prototype,"useColorTemperature",[z0],Object.getOwnPropertyDescriptor(W0.prototype,"useColorTemperature"),W0.prototype),lt(W0.prototype,"colorTemperature",[Uc,k0,U0],Object.getOwnPropertyDescriptor(W0.prototype,"colorTemperature"),W0.prototype),lt(W0.prototype,"staticSettings",[G0,H0],Object.getOwnPropertyDescriptor(W0.prototype,"staticSettings"),W0.prototype),V0=W0))||V0)),i2=function(e){return t({DirectionalLight:e,DirectionalLightComponent:e}),e}((J0=dc("cc.DirectionalLight"),$0=Ic(),t1=Ac(),e1=Sc("_illuminance"),n1=Lc(),J0(i1=$0(i1=t1(i1=Cc((s1=function(t){function e(){var e;return ct(e=t.call(this)||this,"_illuminanceHDR",o1,ot(e)),ct(e,"_illuminanceLDR",a1,ot(e)),e._type=ry.DIRECTIONAL,e._light=null,e._lightType=dT,e}return $(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*vg.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},Z(e,[{key:"illuminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=t,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=t,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),e}(n2),o1=lt((r1=s1).prototype,"_illuminanceHDR",[gc,e1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),a1=lt(r1.prototype,"_illuminanceLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt(r1.prototype,"illuminance",[n1],Object.getOwnPropertyDescriptor(r1.prototype,"illuminance"),r1.prototype),i1=r1))||i1)||i1)||i1)||i1)),r2=function(e){return t({SphereLight:e,SphereLightComponent:e}),e}((c1=dc("cc.SphereLight"),l1=Ic(),u1=Ac(),h1=Sc("_luminance"),f1=Gc(),p1=Lc(),d1=Gc(),_1=Lc(),m1=Kc($1),v1=Gc(),g1=Lc(),y1=Lc(),x1=Lc(),c1(S1=l1(S1=u1(S1=Cc((R1=function(t){function e(){var e;return ct(e=t.call(this)||this,"_size",E1,ot(e)),ct(e,"_luminanceHDR",b1,ot(e)),ct(e,"_luminanceLDR",C1,ot(e)),ct(e,"_term",A1,ot(e)),ct(e,"_range",w1,ot(e)),e._type=ry.SPHERE,e._light=null,e._lightType=xT,e}return $(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*vg.standardExposureValue*vg.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/vg.standardExposureValue/vg.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},Z(e,[{key:"luminousFlux",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*yy(this._size):this._luminanceLDR},set:function(t){var e=0;u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/yy(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}}]),e}(n2),E1=lt((T1=R1).prototype,"_size",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),b1=lt(T1.prototype,"_luminanceHDR",[xc,h1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/yy(.15)}}),C1=lt(T1.prototype,"_luminanceLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),A1=lt(T1.prototype,"_term",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $1.LUMINOUS_FLUX}}),w1=lt(T1.prototype,"_range",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt(T1.prototype,"luminousFlux",[f1,p1],Object.getOwnPropertyDescriptor(T1.prototype,"luminousFlux"),T1.prototype),lt(T1.prototype,"luminance",[d1,_1],Object.getOwnPropertyDescriptor(T1.prototype,"luminance"),T1.prototype),lt(T1.prototype,"term",[m1,v1,g1],Object.getOwnPropertyDescriptor(T1.prototype,"term"),T1.prototype),lt(T1.prototype,"size",[y1],Object.getOwnPropertyDescriptor(T1.prototype,"size"),T1.prototype),lt(T1.prototype,"range",[x1],Object.getOwnPropertyDescriptor(T1.prototype,"range"),T1.prototype),S1=T1))||S1)||S1)||S1)||S1)),o2=function(e){return t({SpotLight:e,SpotLightComponent:e}),e}((P1=dc("cc.SpotLight"),I1=Ic(),M1=Ac(),D1=Sc("_luminance"),O1=Lc(),N1=Gc(),L1=Lc(),B1=Gc(),F1=Kc($1),z1=Gc(),k1=Lc(),U1=Lc(),G1=Lc(),H1=Bc(),V1=Lc(),P1(W1=I1(W1=M1(W1=Cc((J1=function(t){function e(){var e;return ct(e=t.call(this)||this,"_size",q1,ot(e)),ct(e,"_luminanceHDR",X1,ot(e)),ct(e,"_luminanceLDR",Y1,ot(e)),ct(e,"_term",K1,ot(e)),ct(e,"_range",Q1,ot(e)),ct(e,"_spotAngle",Z1,ot(e)),e._type=ry.SPOT,e._light=null,e._lightType=wT,e}return $(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*vg.standardExposureValue*vg.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/vg.standardExposureValue/vg.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},Z(e,[{key:"luminousFlux",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*yy(this._size):this._luminanceLDR},set:function(t){var e=0;u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/yy(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._spotAngle=t,this._light&&(this._light.spotAngle=un(t))}}]),e}(n2),q1=lt((j1=J1).prototype,"_size",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),X1=lt(j1.prototype,"_luminanceHDR",[xc,D1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/yy(.15)}}),Y1=lt(j1.prototype,"_luminanceLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),K1=lt(j1.prototype,"_term",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $1.LUMINOUS_FLUX}}),Q1=lt(j1.prototype,"_range",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Z1=lt(j1.prototype,"_spotAngle",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),lt(j1.prototype,"luminousFlux",[O1,N1],Object.getOwnPropertyDescriptor(j1.prototype,"luminousFlux"),j1.prototype),lt(j1.prototype,"luminance",[L1,B1],Object.getOwnPropertyDescriptor(j1.prototype,"luminance"),j1.prototype),lt(j1.prototype,"term",[F1,z1,k1],Object.getOwnPropertyDescriptor(j1.prototype,"term"),j1.prototype),lt(j1.prototype,"size",[U1],Object.getOwnPropertyDescriptor(j1.prototype,"size"),j1.prototype),lt(j1.prototype,"range",[G1],Object.getOwnPropertyDescriptor(j1.prototype,"range"),j1.prototype),lt(j1.prototype,"spotAngle",[Uc,H1,V1],Object.getOwnPropertyDescriptor(j1.prototype,"spotAngle"),j1.prototype),W1=j1))||W1)||W1)||W1)||W1));u.LightComponent=n2,ie.setClassAlias(n2,"cc.LightComponent"),u.DirectionalLightComponent=i2,ie.setClassAlias(i2,"cc.DirectionalLightComponent"),u.SphereLightComponent=r2,ie.setClassAlias(r2,"cc.SphereLightComponent"),u.SpotLightComponent=o2,ie.setClassAlias(o2,"cc.SpotLightComponent"),U(o2.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),U(r2.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),U(n2.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var a2=function(t,e,n){t[e+0]=n.m00,t[e+1]=n.m01,t[e+2]=n.m02,t[e+3]=n.m12,t[e+4]=n.m04,t[e+5]=n.m05,t[e+6]=n.m06,t[e+7]=n.m13,t[e+8]=n.m08,t[e+9]=n.m09,t[e+10]=n.m10,t[e+11]=n.m14};function s2(t,e){var n=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*n,t)/12)}new Ln,new Ln,new Rn,new Ln,new Rn;var c2=new gr(bi.POINT,bi.POINT,bi.NONE,Ci.CLAMP,Ci.CLAMP,Ci.CLAMP),l2=new Rn,u2=new Rn,h2=new Rn,f2=new Rn,p2=new Vn,d2=new Vn,_2=new js,m2=Number.MAX_SAFE_INTEGER,v2=function(){function t(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var e=function(t){return t.hasFeature(hi.TEXTURE_FLOAT)?fi.RGBA32F:fi.RGBA8}(this._device);this._formatSize=Jr[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Ij(t),this._pool.initialize({format:e,roundUpFn:s2}),this._customPool=new Ij(t),this._customPool.initialize({format:e,roundUpFn:s2})}var e=t.prototype;return e.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},e.registerCustomTextureLayouts=function(t){for(var e=0;e<t.length;e++)for(var n=t[e],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}},e.getDefaultPoseTexture=function(t,e,n){var i=0^t.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(e.hash))return r.refCount++,r;var o=t.joints,a=t.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),f=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!f)return r;r={pixelOffset:f.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:f},s=new Float32Array(u),c=!0}Rn.set(h2,m2,m2,m2),Rn.set(f2,-m2,-m2,-m2);for(var p=e.getBoneSpaceBounds(t),d=0,_=0;d<l;d++,_+=12){var m=n.getChildByPath(o[d]),v=m?kG(m,n,p2):t.inverseBindposes[d],g=p[d];g&&(js.transform(_2,g,v),_2.getBoundary(l2,u2),Rn.min(h2,h2,l2),Rn.max(f2,f2,u2)),c&&(m&&Vn.multiply(v,v,a[d]),a2(s,_,m?v:Vn.IDENTITY))}var y=[new js];return r.bounds.set(e.hash,y),js.fromPoints(y[0],h2,f2),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},e.getSequencePoseTexture=function(t,e,n,i){var r=t.hash^e.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=t.joints,s=t.bindposes,c=ok.getOrExtract(e).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var f=12*h*c,p=this._chunkIdxMap.get(r),d=void 0!==p?this._customPool.alloc(f*Float32Array.BYTES_PER_ELEMENT,p):this._pool.alloc(f*Float32Array.BYTES_PER_ELEMENT);if(!d)return null;var _=this._createAnimInfos(t,e,i);o={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:d,animInfos:_},l=new Float32Array(f),u=!0}var m=n.getBoneSpaceBounds(t),v=[];o.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new js(m2,m2,m2,-m2,-m2,-m2));for(var y=0,x=0;y<c;y++){for(var S=v[y],T=0;T<h;T++,x+=12){var E=o.animInfos[T],b=E.curveData,C=E.downstream,A=E.bindposeIdx,w=E.bindposeCorrection,R=void 0,P=!0;b&&C?R=Vn.multiply(p2,b[y],C):b?R=b[y]:C?R=C:(R=t.inverseBindposes[A],P=!1);var I=m[T];if(I){var M=w?Vn.multiply(d2,R,w):R;js.transform(_2,I,M),_2.getBoundary(l2,u2),Rn.min(S.center,S.center,l2),Rn.max(S.halfExtents,S.halfExtents,u2)}u&&(P&&Vn.multiply(p2,R,s[A]),a2(l,x,P?p2:Vn.IDENTITY))}js.fromPoints(S,S.center,S.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},e.releaseHandle=function(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){var e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}},e.releaseSkeleton=function(t){for(var e=this._textureBuffers.values(),n=e.next();!n.done;){var i=n.value;i.skeletonHash===t.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=e.next()}},e.releaseAnimationClip=function(t){for(var e=this._textureBuffers.values(),n=e.next();!n.done;){var i=n.value;i.clipHash===t.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=e.next()}},e._createAnimInfos=function(t,e,n){for(var i=[],r=t.joints,o=t.bindposes,a=r.length,s=ok.getOrExtract(e),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),f=void 0,p=void 0;!u;){var d=l.lastIndexOf("/");if(l=l.substring(0,d),u=s.joints[l],h?(f||(f=new Vn),Vn.fromRTS(p2,h.rotation,h.position,h.scale),Vn.multiply(f,p2,f),h=h.parent):p=l,d<0)break}var _=c,m=void 0;if(void 0!==p&&u){_=c-1;for(var v=0;v<a;v++)if(r[v]===p){_=v,m=new Vn,Vn.multiply(m,o[v],t.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:f,bindposeIdx:_,bindposeCorrection:m})}return i},Z(t,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),t}(),g2=function(){function t(t){this._pool=new Map,this._device=void 0,this._device=t}var e=t.prototype;return e.getData=function(t){void 0===t&&(t="-1");var e=this._pool.get(t);if(e)return e;var n=this._device.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,y_.SIZE,y_.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1,currentClip:null};return this._setAnimInfoDirty(r,!1),this._pool.set(t,r),r},e.destroy=function(t){var e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))},e._setAnimInfoDirty=function(t,e){t.dirty=e},e.switchClip=function(t,e){return t.currentClip=e,t.data[0]=-1,t.buffer.update(t.data),this._setAnimInfoDirty(t,!1),t},e.clear=function(){for(var t,e=st(this._pool.values());!(t=e()).done;)t.value.buffer.destroy();this._pool.clear()},t}(),y2=function(){function t(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new v2(t),this.jointAnimationInfo=new g2(t)}var e=t.prototype;return e.releaseSkeleton=function(t){this.jointTexturePool.releaseSkeleton(t)},e.releaseAnimationClip=function(t){this.jointTexturePool.releaseAnimationClip(t)},e.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},t}();u.internal.DataPoolManager=y2;var x2=[{name:"CC_USE_SKINNING",value:!0}];function S2(t,e,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(e.push(r),t.push(a))}}var T2,E2,b2,C2,A2,w2,R2,P2,I2,M2,D2,O2,N2,L2,B2,F2,z2,k2,U2,G2,H2,V2,W2,j2,q2,X2,Y2,K2,Q2,Z2,J2,$2,t4,e4,n4,i4,r4,o4,a4,s4,c4,l4,u4,h4,f4,p4=new Rn,d4=new Rn,_4=new Rn,m4=new Rn,v4=new Vn,g4=new js,y4=function(t){function e(){var e;return(e=t.call(this)||this).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=tT.SKINNING,e}$(e,t);var n=e.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}t.prototype.destroy.call(this)},n.bindSkeleton=function(t,e,n){void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)DG(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,t&&e&&n){this.transform=e;var r=n.getBoneSpaceBounds(t),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<t.joints.length;a++){var s=r[a],c=e.getChildByPath(t.joints[a]);if(s&&c){var l=MG(c,e),u=t.bindposes[a],h=[],f=[];o?S2(h,f,o,a):(h.push(a),f.push(0)),this._joints.push({indices:h,buffers:f,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(t){var e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._localDataUpdated=!0),Rn.set(p4,1/0,1/0,1/0),Rn.set(d4,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=IG(i.transform,t);js.transform(g4,r,o),g4.getBoundary(_4,m4),Rn.min(p4,p4,_4),Rn.max(d4,d4,m4)}var a=this._worldBounds;this._modelBounds&&a&&(js.fromPoints(this._modelBounds,p4,d4),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;Vn.multiply(v4,a.world,s);for(var c=0;c<o.length;c++)a2(this._dataArray[o[c]],12*r[c],v4)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(e,n,i){var r=n.vertexBuffers,o=n.iaInfo;o.vertexBuffers=n.jointMappedBuffers,t.prototype.initSubModel.call(this,e,n,i),o.vertexBuffers=r},n.getMacroPatches=function(e){var n=t.prototype.getMacroPatches.call(this,e);return n?x2.concat(n):x2},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n);var i=this._buffers[this._bufferIndices[e]];i&&n.bindBuffer(S_.BINDING,i)},n._updateInstancedAttributes=function(e,n){n.batchingScheme!==Rv.NONE&&M(3936,this.node.name),t.prototype._updateInstancedAttributes.call(this,e,n)},n._ensureEnoughBuffers=function(t){for(var e=0;e<t;e++)this._buffers[e]||(this._buffers[e]=this._device.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,S_.SIZE,S_.SIZE))),this._dataArray[e]||(this._dataArray[e]=new Float32Array(S_.COUNT))},e}(E0),x4=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],S4=function(t){function e(){var e;(e=t.call(this)||this).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=tT.BAKED_SKINNING,e._dataPoolManager=u.director.root.dataPoolManager;var n=new Float32Array(4),i=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:i,texture:null,boundsInfo:null},e}$(e,t);var n=e.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),t.prototype.destroy.call(this)},n.bindSkeleton=function(t,e,n){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null),this._skeleton=t,this._mesh=n,t&&e&&n){this.transform=e;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new hr(_i.UNIFORM|_i.TRANSFER_DST,gi.DEVICE,g_.SIZE,g_.SIZE)))}},n.updateTransform=function(e){if(t.prototype.updateTransform.call(this,e),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},n.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(t){this._modelBounds=t},n.uploadAnimation=function(t){if(this._skeleton&&this._mesh&&this.uploadedAnim!==t){this.uploadedAnim=t;var e=this._dataPoolManager,n=null;t?(n=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyJointTexture=function(t){void 0===t&&(t=null);var e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,t){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=t.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=t.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var o=t.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(b_,o)}},n.getMacroPatches=function(e){var n=t.prototype.getMacroPatches.call(this,e);return n?n.concat(x4):x4},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n);var i=this._jointsMedium,r=i.buffer,o=i.texture,a=i.animInfo;if(n.bindBuffer(g_.BINDING,r),n.bindBuffer(y_.BINDING,a.buffer),o){var s=this._device.getSampler(c2);n.bindTexture(b_,o.handle.texture),n.bindSampler(b_,s)}},n._setInstAnimInfoIdx=function(t){this._instAnimInfoIdx=t},n._updateInstancedAttributes=function(e,n){t.prototype._updateInstancedAttributes.call(this,e,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(x_)),this.updateInstancedJointTextureInfo()},n.updateInstancedJointTextureInfo=function(){var t=this._jointsMedium,e=t.jointTextureInfo,n=t.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=e[1],r[2]=e[2]}},e}(E0),T4=function(e){return t({SkinnedMeshRenderer:e,SkinningModelComponent:e}),e}((T2=dc("cc.SkinnedMeshRenderer"),E2=Ic(),b2=mc(100),C2=Ac(),A2=Kc(Z0),w2=Kc(WC),R2=Kc(Z0),P2=Kc(WC),I2=Lc(),T2(M2=E2(M2=b2(M2=Cc(M2=C2((L2=function(t){function e(){var e;return ct(e=t.call(this)||this,"_skeleton",O2,ot(e)),ct(e,"_skinningRoot",N2,ot(e)),e._clip=null,e.associatedAnimation=null,e._modelType=S4,e}$(e,t);var n=e.prototype;return n.onLoad=function(){this._tryBindAnimation()},n.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),t.prototype.onDestroy.call(this)},n.uploadAnimation=function(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)},n.setUseBakedAnimation=function(t,e){void 0===t&&(t=!0),void 0===e&&(e=!1);var n=t?S4:y4;(e||this._modelType!==n)&&(this._modelType=n,this._model&&(u.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(e,n){t.prototype.setMaterial.call(this,e,n),this._modelType===y4&&this.getMaterialInstance(n)},n._updateModelParams=function(){this._update(),t.prototype._updateModelParams.call(this)},n._tryBindAnimation=function(){var t=this._skinningRoot;if(t){for(var e=!1,n=this.node;n;n=n.parent)if(n===t){e=!0;break}if(e){var i=t.getComponent("cc.SkeletalAnimation");i?i.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},Z(e,[{key:"skeleton",get:function(){return this._skeleton},set:function(t){t!==this._skeleton&&(this._skeleton=t,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(t){this._skinningRoot=t,this._tryBindAnimation(),t!==this._skinningRoot&&this._update()}},{key:"model",get:function(){return this._model}}]),e}(w0),O2=lt((D2=L2).prototype,"_skeleton",[A2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N2=lt(D2.prototype,"_skinningRoot",[w2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(D2.prototype,"skeleton",[R2],Object.getOwnPropertyDescriptor(D2.prototype,"skeleton"),D2.prototype),lt(D2.prototype,"skinningRoot",[P2,I2],Object.getOwnPropertyDescriptor(D2.prototype,"skinningRoot"),D2.prototype),M2=D2))||M2)||M2)||M2)||M2)||M2)),E4=new Rr(Ki.ATTR_BATCH_ID,fi.R32F),b4=new Rr(Ki.ATTR_BATCH_UV,fi.RG32F),C4=Jr[E4.format].size+Jr[b4.format].size,A4=function(e){return t({SkinnedMeshUnit:e,SkinningModelUnit:e}),e}((B2=dc("cc.SkinnedMeshUnit"),F2=Kc(w$),z2=Kc(Z0),k2=Kc(cg),U2=Kc(T4),B2((K2=function(){function t(){ct(this,"mesh",V2,this),ct(this,"skeleton",W2,this),ct(this,"material",j2,this),ct(this,"_localTransform",q2,this),ct(this,"_offset",X2,this),ct(this,"_size",Y2,this)}return Z(t,[{key:"offset",get:function(){return this._offset},set:function(t){Xn.copy(this._offset,t)}},{key:"size",get:function(){return this._size},set:function(t){Xn.copy(this._size,t)}},{key:"copyFrom",get:function(){return null},set:function(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&kG(t.node,t.skinningRoot,this._localTransform))}}]),t}(),V2=lt((H2=K2).prototype,"mesh",[F2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W2=lt(H2.prototype,"skeleton",[z2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j2=lt(H2.prototype,"material",[k2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),q2=lt(H2.prototype,"_localTransform",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vn}}),X2=lt(H2.prototype,"_offset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(0,0)}}),Y2=lt(H2.prototype,"_size",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(1,1)}}),lt(H2.prototype,"offset",[Mc],Object.getOwnPropertyDescriptor(H2.prototype,"offset"),H2.prototype),lt(H2.prototype,"size",[Mc],Object.getOwnPropertyDescriptor(H2.prototype,"size"),H2.prototype),lt(H2.prototype,"copyFrom",[U2],Object.getOwnPropertyDescriptor(H2.prototype,"copyFrom"),H2.prototype),G2=H2))||G2)),w4=new Vn,R4=(new Vn,new Rn),P4=function(e){return t({SkinnedMeshBatchRenderer:e,BatchedSkinningModelComponent:e}),e}((Q2=dc("cc.SkinnedMeshBatchRenderer"),Z2=Ic(),J2=mc(100),$2=Ac(),t4=Lc(),e4=Kc([Le]),n4=Lc(),i4=Kc([A4]),r4=Lc(),o4=Dc(),a4=Dc(),Q2(s4=Z2(s4=J2(s4=Cc(s4=$2((f4=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"atlasSize",l4,ot(e)),ct(e,"batchableTextureNames",u4,ot(e)),ct(e,"units",h4,ot(e)),e._textures={},e._batchMaterial=null,e}$(e,t);var n=e.prototype;return n.onLoad=function(){t.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),t.prototype.onDestroy.call(this)},n._onMaterialModified=function(e){this.cookMaterials(),t.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var t=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var e=this.getMaterialInstance(0);if(e&&this._batchMaterial&&this._batchMaterial.effectAsset){e.copy(this._batchMaterial),this.resizeAtlases();for(var n=e.effectAsset.techniques[e.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var o=function(n){if(r.properties[n].type>=di.SAMPLER1D){var o=null;t.batchableTextureNames.find((function(t){return t===n}))?((o=t._textures[n])||(o=t.createTexture(n)),t.cookTextures(o,n,i)):t.units.some((function(t){return o=t.material&&t.material.getProperty(n,i)})),o&&e.setProperty(n,o,i)}else{for(var a=[],s=0;s<t.units.length;s++){var c=t.units[s];c.material&&a.push(c.material.getProperty(n.slice(0,-3),i))}e.setProperty(n,a,i)}};for(var a in r.properties)o(a)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var t=[],e=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;Vn.invert(w4,i._localTransform);for(var o=function(n){var i=r.joints[n];if(t.findIndex((function(t){return t===i}))>=0)return"continue";t.push(i),e.push(Vn.multiply(new Vn,r.bindposes[n]||Vn.IDENTITY,w4))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(t.length).keys()).sort((function(e,n){return t[e]>t[n]?1:t[e]<t[n]?-1:0})),c=new Z0;c.joints=t.map((function(t,e,n){return n[s[e]]})),c.bindposes=e.map((function(t,e,n){return n[s[e]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var t=this,e=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){e=!0;break}if(e&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new w$;for(var i=0,r=fi.UNKNOWN,o=0,a=fi.UNKNOWN,s=0,c=fi.UNKNOWN,l=0,u=fi.UNKNOWN,h=0,f=fi.UNKNOWN,p=new Array(this.units.length),d=this.units.length,_=0;_<d;_++){var m=this.units[_];m&&m.skeleton&&(p[_]=m.skeleton.joints.map((function(e){return t._skeleton.joints.findIndex((function(t){return e===t}))})))}for(var v=function(e){var n=t.units[e];if(!n||!n.mesh||!n.mesh.data)return"continue";var d=t._createUnitMesh(e,n.mesh),_=new DataView(d.data.buffer);Vn.inverseTranspose(w4,n._localTransform);for(var m=n.offset,v=n.size,g=function(t){var g=d.struct.vertexBundles[t];i=g.view.offset,r=fi.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var x=g.attributes[y];if(x.name===Ki.ATTR_POSITION){r=x.format;break}i+=Jr[x.format].size}if(r){for(var S=FA(_,r,i,g.view.length,g.view.stride),T=0;T<S.length;T+=3)Rn.fromArray(R4,S,T),Rn.transformMat4(R4,R4,n._localTransform),Rn.toArray(S,R4,T);BA(_,S,r,i,g.view.stride)}o=g.view.offset,a=fi.UNKNOWN;for(var E=0;E<g.attributes.length;E++){var b=g.attributes[E];if(b.name===Ki.ATTR_NORMAL){a=b.format;break}o+=Jr[b.format].size}if(a){for(var C=FA(_,a,o,g.view.length,g.view.stride),A=0;A<C.length;A+=3)Rn.fromArray(R4,C,A),Rn.transformMat4Normal(R4,R4,w4),Rn.toArray(C,R4,A);BA(_,C,a,o,g.view.stride)}s=g.view.offset,c=fi.UNKNOWN;for(var w=0;w<g.attributes.length;w++){var R=g.attributes[w];if(R.name===Ki.ATTR_TANGENT){c=R.format;break}s+=Jr[R.format].size}if(c){for(var P=FA(_,c,s,g.view.length,g.view.stride),I=0;I<P.length;I+=3)Rn.fromArray(R4,P,I),Rn.transformMat4Normal(R4,R4,w4),Rn.toArray(P,R4,I);BA(_,P,c,s,g.view.stride)}l=g.view.offset,u=fi.UNKNOWN;for(var M=0;M<g.attributes.length;M++){var D=g.attributes[M];if(D.name===Ki.ATTR_BATCH_UV){u=D.format;break}l+=Jr[D.format].size}u&&zA(_,(function(t,e){var n,i=0===e?"x":"y";return(t=(n=t)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,_);var O=p[e];if(!O)return"continue";h=g.view.offset,f=fi.UNKNOWN;for(var N=0;N<g.attributes.length;N++){var L=g.attributes[N];if(L.name===Ki.ATTR_JOINTS){f=L.format;break}h+=Jr[L.format].size}f&&zA(_,(function(t){return O[t]}),f,h,g.view.length,g.view.stride,_)},y=0;y<d.struct.vertexBundles.length;y++)g(y);t._mesh.merge(d)},g=0;g<d;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(t,e,n){for(var i=[],r=[],o=[],a=[],s=0;s<this.units.length;s++){var c=this.units[s];if(c.material){var l=c.material.getProperty(e,n);if(l&&l.image&&l.image.data){var h=new or;h.texOffset.x=c.offset.x*this.atlasSize,h.texOffset.y=c.offset.y*this.atlasSize,h.texExtent.width=c.size.x*this.atlasSize,h.texExtent.height=c.size.y*this.atlasSize;var f=l.image.data;ArrayBuffer.isView(f)?(o.push(f),a.push(h)):(i.push(f),r.push(h))}}}var p=t.getGFXTexture(),d=u.director.root.device;o.length>0&&d.copyBuffersToTexture(o,p,a),i.length>0&&d.copyTexImagesToTexture(i,p,r)},n.createTexture=function(t){var e=new Ev;return e.setFilters(Om.LINEAR,Om.LINEAR),e.setMipFilter(Om.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:Mm.RGBA8888}),this._textures[t]=e,e},n.resizeAtlases=function(){for(var t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:Mm.RGBA8888})},n._createUnitMesh=function(t,e){for(var n=JSON.parse(JSON.stringify(e.struct)),i={},r=0;r<e.struct.primitives.length;r++){for(var o=e.struct.primitives[r],a=0,s=fi.UNKNOWN,c=0;c<o.vertexBundelIndices.length;c++){var l=e.struct.vertexBundles[o.vertexBundelIndices[c]];a=l.view.offset,s=fi.UNKNOWN;for(var h=0;h<l.attributes.length;h++){var f=l.attributes[h];if(f.name===Ki.ATTR_TEX_COORD){s=f.format;break}a+=Jr[f.format].size}if(s)break}if(void 0===i[c]){i[c]=[s,a];var p=n.vertexBundles[c];p.attributes.push(E4),p.attributes.push(b4),p.view.offset=0,p.view.length+=p.view.count*C4,p.view.stride+=C4}}for(var d=0,_=0;_<n.vertexBundles.length;_++)d+=n.vertexBundles[_].view.length;for(var m=0;m<n.primitives.length;m++){var v=n.primitives[m];v.indexView&&(v.indexView.offset=d,d+=v.indexView.length)}var g=new Uint8Array(d),y=e.data,x=new DataView(g.buffer),S=new DataView(y.buffer),T=u.sys.isLittleEndian;for(var E in i)for(var b=n.vertexBundles[E],C=e.struct.vertexBundles[E],A=i[E],w=FA(S,A[0],A[1],C.view.length,C.view.stride),R=C.view,P=b.view,I=R.stride,M=P.stride,D=R.offset,O=P.offset,N=0;N<P.count;N++){var L=y.subarray(D,D+I);g.set(L,O),x.setFloat32(O+I,t),x.setFloat32(O+I+4,w[2*N],T),x.setFloat32(O+I+8,w[2*N+1],T),O+=M,D+=I}for(var B=0;B<n.primitives.length;B++){var F=e.struct.primitives[B],z=n.primitives[B];if(F.indexView&&z.indexView)for(var k=F.indexView.stride,U=z.indexView.stride,G=F.indexView.offset,H=z.indexView.offset,V=0;V<z.indexView.count;V++){var W=y.subarray(G,G+k);g.set(W,H),H+=U,G+=k}}var j=new w$;return j.reset({struct:n,data:g}),j},Z(e,[{key:"mesh",get:function(){return t.prototype.mesh},set:function(t){this.mesh=t}},{key:"skeleton",get:function(){return t.prototype.skeleton},set:function(t){this.skeleton=t}}]),e}(T4),l4=lt((c4=f4).prototype,"atlasSize",[xc,t4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),u4=lt(c4.prototype,"batchableTextureNames",[e4,xc,n4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),h4=lt(c4.prototype,"units",[i4,xc,r4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lt(c4.prototype,"mesh",[ol,o4],Object.getOwnPropertyDescriptor(c4.prototype,"mesh"),c4.prototype),lt(c4.prototype,"skeleton",[ol,a4],Object.getOwnPropertyDescriptor(c4.prototype,"skeleton"),c4.prototype),s4=c4))||s4)||s4)||s4)||s4)||s4));u.SkinningModelComponent=T4,ie.setClassAlias(T4,"cc.SkinningModelComponent"),u.SkinningModelUnit=A4,ie.setClassAlias(A4,"cc.SkinningModelUnit"),u.BatchedSkinningModelComponent=P4,ie.setClassAlias(P4,"cc.BatchedSkinningModelComponent");var I4,M4,D4,O4,N4,L4,B4,F4,z4,k4,U4,G4,H4,V4,W4,j4,q4,X4,Y4,K4,Q4=new Vn,Z4=new Vn,J4=t("SkeletalAnimationState",function(t){function e(e,n){var i;return void 0===n&&(n=""),(i=t.call(this,e,n)||this)._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._parent=null,i._curvesInited=!1,i._animInfoMgr=u.director.root.dataPoolManager.jointAnimationInfo,i}$(e,t);var n=e.prototype;return n.initialize=function(e){if(!this._curveLoaded){this._parent=e.getComponent("cc.SkeletalAnimation");var n=this._parent.useBakedAnimation;this._doNotCreateEval=n,t.prototype.initialize.call(this,e),this._curvesInited=!n;var i=ok.getOrExtract(this.clip),r=i.frames,o=i.samples;this._frames=r-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/o,this.setUseBaked(n)}},n.setUseBaked=function(e){e?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=t.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,t.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},n.rebuildSocketCurves=function(t){if(this._sockets.length=0,this._targetNode)for(var e=this._targetNode,n=0;n<t.length;++n){var i=t[n],r=e.getChildByPath(i.path);if(i.target){for(var o=ok.getOrExtract(this.clip),a=i.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=Vn.identity(Z4)),Vn.fromRTS(Q4,c.rotation,c.position,c.scale),Vn.multiply(l,Q4,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,f=o.frames,p=[],d=0;d<f;d++){var _;_=h&&l?Vn.multiply(Q4,h[d],l):h?h[d]:l||new Vn;var m={pos:new Rn,rot:new Ln,scale:new Rn};Vn.toRTS(_,m.rot,m.pos,m.scale),p.push(m)}this._sockets.push({target:i.target,frames:p})}}},n._setAnimInfoDirty=function(t,e){t.dirty=e},n._sampleCurvesBaked=function(t){var e=t/this.duration,n=this._animInfo,i=this.clip;n.currentClip!==i&&(this._animInfoMgr.switchClip(this._animInfo,i),this._parent.getUsers().forEach((function(t){t.uploadAnimation(i)})));var r=e*this._frames+.5|0;if(r!==n.data[0]){n.data[0]=r,this._setAnimInfoDirty(n,!0);for(var o=0;o<this._sockets.length;++o){var a=this._sockets[o],s=a.target,c=a.frames[r],l=c.pos,u=c.rot,h=c.scale;s.setRTS(u,l,h)}}},e}(JU)),$4=t("Socket",(I4=dc("cc.SkeletalAnimation.Socket"),M4=Kc(WC),I4((N4=lt((O4=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),ct(this,"path",N4,this),ct(this,"target",L4,this),this.path=t,this.target=e}).prototype,"path",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),L4=lt(O4.prototype,"target",[M4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D4=O4))||D4));ie.setClassAlias($4,"cc.SkeletalAnimationComponent.Socket");var t3=new Vn,e3=new Vn;function n3(t,e,n){void 0===e&&(e=""),void 0===n&&(n=[]);for(var i=0;i<t.children.length;i++){var r=t.children[i];if(r){var o=e?e+"/"+r.name:r.name;n.push(o),n3(r,o,n)}}return n}var i3,r3,o3,a3=function(e){return t({SkeletalAnimation:e,SkeletalAnimationComponent:e}),e}((B4=dc("cc.SkeletalAnimation"),F4=Ic(),z4=mc(99),k4=Ac(),U4=Kc([$4]),G4=Lc(),H4=Lc(),V4=Kc([$4]),B4(W4=F4(W4=z4(W4=Cc(W4=k4((K4=Y4=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_useBakedAnimation",q4,ot(e)),ct(e,"_sockets",X4,ot(e)),e._users=new Set,e._currentBakedState=null,e}$(e,t);var n=e.prototype;return n.onLoad=function(){t.prototype.onLoad.call(this);for(var e=this.node.getComponentsInChildren(T4),n=0;n<e.length;++n){var i=e[n];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}},n.onDestroy=function(){t.prototype.onDestroy.call(this),u.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),u.director.getAnimationManager().removeSockets(this.node,this._sockets),this._removeAllUsers()},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,t.prototype.start.call(this)},n.pause=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.pause():t.prototype.pause.call(this)},n.resume=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.resume():t.prototype.resume.call(this)},n.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):t.prototype.stop.call(this)},n.querySockets=function(){var t=this._defaultClip&&Object.keys(ok.getOrExtract(this._defaultClip).joints).sort().reduce((function(t,e){return e.startsWith(t[t.length-1])||t.push(e),t}),[])||[];if(!t.length)return["please specify a valid default animation clip first"];for(var e=[],n=0;n<t.length;n++){var i=t[n],r=this.node.getChildByPath(i);r&&(e.push(i),n3(r,i,e))}return e},n.rebuildSocketAnimations=function(){for(var t,e=st(this._sockets);!(t=e()).done;){var n=t.value,i=this.node.getChildByPath(n.path),r=n.target;i&&r&&(r.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,kG(i,this.node,t3),Vn.fromRTS(e3,r.rotation,r.position,r.scale),Vn.equals(e3,t3)||(r.matrix=t3))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},n.createSocket=function(t){var e=this._sockets.find((function(e){return e.path===t}));if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var n=new WC;return n.parent=this.node,this._sockets.push(new $4(t,n)),this.rebuildSocketAnimations(),n},n.notifySkinnedMeshAdded=function(t){var e=this._useBakedAnimation,n=t.associatedAnimation;if(n&&n._users.delete(t),t.associatedAnimation=this,t.setUseBakedAnimation(e,!0),e){var i=this._currentBakedState;i&&t.uploadAnimation(i.clip)}this._users.add(t)},n.notifySkinnedMeshRemoved=function(t){t.associatedAnimation,t.setUseBakedAnimation(!1),t.associatedAnimation=null,this._users.delete(t)},n.getUsers=function(){return this._users},n._createState=function(t,e){return new J4(t,e)},n._doCreateState=function(e,n){var i=t.prototype._doCreateState.call(this,e,n);return i.rebuildSocketCurves(this._sockets),i},n.doPlayOrCrossFade=function(e,n){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();var i=e;this._currentBakedState=i,i.play()}else t.prototype.doPlayOrCrossFade.call(this,e,n)},n._removeAllUsers=function(){var t=this;Array.from(this._users).forEach((function(e){t.notifySkinnedMeshRemoved(e)}))},Z(e,[{key:"sockets",get:function(){return this._sockets},set:function(t){if(!this._useBakedAnimation){var e=u.director.getAnimationManager();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(t){for(var e in this._useBakedAnimation=t,this._nameToState)this._nameToState[e].setUseBaked(t);this._users.forEach((function(e){e.setUseBakedAnimation(t)})),this._useBakedAnimation?u.director.getAnimationManager().removeSockets(this.node,this._sockets):(u.director.getAnimationManager().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),e}(vG),Y4.Socket=$4,lt((j4=K4).prototype,"sockets",[U4,G4],Object.getOwnPropertyDescriptor(j4.prototype,"sockets"),j4.prototype),lt(j4.prototype,"useBakedAnimation",[H4],Object.getOwnPropertyDescriptor(j4.prototype,"useBakedAnimation"),j4.prototype),q4=lt(j4.prototype,"_useBakedAnimation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X4=lt(j4.prototype,"_sockets",[V4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),W4=j4))||W4)||W4)||W4)||W4)||W4));u.SkeletalAnimationComponent=a3,ie.setClassAlias(a3,"cc.SkeletalAnimationComponent"),u.utils=B$,function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(i3||(i3={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(r3||(r3={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(o3||(o3={}));var s3,c3=0;function l3(t,e){var n;e.invoking||(e.invoking=!0,(n=e.func).call.apply(n,[t].concat(e.args)).then((function(){e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());var n=t._operationQueue[0];n&&l3(t,n)})).catch((function(){})))}function u3(t,e,n){var i=n.value;n.value=function(){for(var t=this,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return new Promise((function(e){var r=c3++,o=t;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),e),l3(o,o._operationQueue[0])}))}}function h3(t){return new Promise((function(e){var n=t.play();return void 0===n?e():(n.then(e).catch((function(){var n=function(){t.play().catch((function(){})),e()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var f3,p3,d3=function(){function t(t,e){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=t,t.volume=e}var e=t.prototype;return e.play=function(){var t=this;h3(this._domAudio).then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t)})).catch((function(){}))},e.stop=function(){this._domAudio.pause()},Z(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=t,t&&this._domAudio.addEventListener("ended",t)}}]),t}(),_3=(lt((s3=function(){function t(t){var e=this;this._domAudio=void 0,this._state=o3.INIT,this._onEnded=void 0,this._eventTarget=new eu,this._operationQueue=[],this._domAudio=t,_u.on("hide",this._onHide,this),_u.on("show",this._onShow,this),this._onEnded=function(){e.seek(0).catch((function(){})),e._state=o3.INIT,e._eventTarget.emit(i3.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var e=t.prototype;return e.destroy=function(){_u.off("hide",this._onHide,this),_u.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(e){n(new t(e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=document.createElement("audio"),r="canplaythrough";_u.os===au.IOS?r="loadedmetadata":_u.browserType===iu.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),e(i)},c=function(){a(),n("load audio failure - "+t)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=t}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var e=new d3(t,n);i(e)})).catch(r)}))},e._onHide=function(){var t=this;this._state===o3.PLAYING&&this.pause().then((function(){t._state=o3.INTERRUPTED,t._eventTarget.emit(i3.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===o3.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(i3.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){return t=sn(t,0,this.duration),this._domAudio.currentTime=t,Promise.resolve()},e.play=function(){var t=this;return new Promise((function(e){h3(t._domAudio).then((function(){t._state=o3.PLAYING,e()})).catch((function(){}))}))},e.pause=function(){return this._domAudio.pause(),this._state=o3.PAUSED,Promise.resolve()},e.stop=function(){var t=this;return new Promise((function(e){t._domAudio.pause(),t._domAudio.currentTime=0,t._state=o3.STOPPED,e()}))},e.onInterruptionBegin=function(t){this._eventTarget.on(i3.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(i3.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(i3.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(i3.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(i3.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(i3.ENDED,t)},Z(t,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return r3.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(t){this._domAudio.loop=t}},{key:"volume",get:function(){return this._domAudio.volume},set:function(t){t=cn(t),this._domAudio.volume=t}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),t}()).prototype,"seek",[u3],Object.getOwnPropertyDescriptor(s3.prototype,"seek"),s3.prototype),lt(s3.prototype,"play",[u3],Object.getOwnPropertyDescriptor(s3.prototype,"play"),s3.prototype),lt(s3.prototype,"pause",[u3],Object.getOwnPropertyDescriptor(s3.prototype,"pause"),s3.prototype),lt(s3.prototype,"stop",[u3],Object.getOwnPropertyDescriptor(s3.prototype,"stop"),s3.prototype),s3),m3=function(){function t(t){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=t}var e=t.prototype;return e.destroy=function(){this._nativeAudio=void 0},e._now=function(){return performance.now()/1e3},e._calculateCurrentTime=function(){var t=this._now()-this._startTime,e=this._startOffset+t;return e>=this.duration&&(this._startTime=this._now(),this._startOffset=0),e%this.duration},e.start=function(){this._isPaused=!1,this._startTime=this._now()},e.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},e.stop=function(){this._isPaused=!0,this._startOffset=0},e.seek=function(t){this._startTime=this._now(),this._startOffset=sn(t,0,this.duration)},Z(t,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),t}(),v3=new(function(){function t(){this._audioBufferDataMap={}}var e=t.prototype;return e.addCache=function(t,e){this._audioBufferDataMap[t]?console.warn("Audio buffer "+t+" has been cached"):this._audioBufferDataMap[t]={usedCount:1,audioBuffer:e}},e.retainCache=function(t){var e=this._audioBufferDataMap[t];e?e.usedCount++:console.warn("Audio buffer cache "+t+" has not been added.")},e.getCache=function(t){var e=this._audioBufferDataMap[t];return null==e?void 0:e.audioBuffer},e.tryReleasingCache=function(t){var e=this._audioBufferDataMap[t];e?--e.usedCount<=0&&delete this._audioBufferDataMap[t]:console.warn("Audio buffer cache "+t+" has not been added.")},t}()),g3=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,y3=function(){function t(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var e=t.prototype;return e.decodeAudioData=function(t){var e=this;return new Promise((function(n){var i=e._context.decodeAudioData(t,(function(t){n(t)}),(function(t){console.error("failed to load Web Audio",t)}));null==i||i.catch((function(){}))}))},e.runContext=function(){var t=this;return new Promise((function(e){var n=t._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(e).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else e();else e()}))},e.createBufferSource=function(t,e){var n=this._context.createBufferSource();return void 0!==t&&(n.buffer=t),void 0!==e&&(n.loop=e),n},e.createGain=function(t){void 0===t&&(t=1);var e=this._context.createGain();return this.setGainValue(e,t),e},e.setGainValue=function(t,e){if(t.gain.setTargetAtTime)try{t.gain.setTargetAtTime(e,this._context.currentTime,0)}catch(n){t.gain.setTargetAtTime(e,this._context.currentTime,.01)}else t.gain.value=e},e.connectContext=function(t){this._context&&t.connect(this._context.destination)},Z(t,[{key:"currentTime",get:function(){return this._context.currentTime}}]),t}();y3.support=!!g3,y3.support&&(p3=new y3);var x3,S3,T3,E3,b3,C3=function(){function t(t,e,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=t.duration,this._url=n,this._bufferSourceNode=p3.createBufferSource(t,!1);var i=p3.createGain(e);this._bufferSourceNode.connect(i),p3.connectContext(i)}var e=t.prototype;return e.play=function(){var t=this;this._bufferSourceNode.start(),p3.runContext().then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t),t._currentTimer=window.setTimeout((function(){var e;v3.tryReleasingCache(t._url),null===(e=t.onEnd)||void 0===e||e.call(t)}),1e3*t._duration)})).catch((function(){}))},e.stop=function(){clearTimeout(this._currentTimer),v3.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},Z(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb=t}}]),t}(),A3=(lt((f3=function(){function t(t,e){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=o3.INIT,this._audioTimer=void 0,this._eventTarget=new eu,this._operationQueue=[],this._audioBuffer=t,this._audioTimer=new m3(t),this._gainNode=p3.createGain(),p3.connectContext(this._gainNode),this._src=e,_u.on("hide",this._onHide,this),_u.on("show",this._onShow,this)}var e=t.prototype;return e.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),v3.tryReleasingCache(this._src),_u.off("hide",this._onHide,this),_u.off("show",this._onShow,this)},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(i){n(new t(i,e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=v3.getCache(t);if(i)return v3.retainCache(t),void e(i);var r=new XMLHttpRequest,o="load audio failed: "+t+", status: ";r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?p3.decodeAudioData(r.response).then((function(n){v3.addCache(t,n),e(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var r=new C3(t,n,e);i(r)})).catch(r)}))},e._onHide=function(){var t=this;this._state===o3.PLAYING&&this.pause().then((function(){t._state=o3.INTERRUPTED,t._eventTarget.emit(i3.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===o3.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(i3.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){var e=this;return new Promise((function(n){e._audioTimer.seek(t),e._state===o3.PLAYING?e._doPlay().then(n).catch((function(){})):n()}))},e.play=function(){return this._doPlay()},e._doPlay=function(){var t=this;return new Promise((function(e){t._stopSourceNode(),t._sourceNode=p3.createBufferSource(t._audioBuffer,t.loop),t._sourceNode.connect(t._gainNode),t._sourceNode.start(0,t._audioTimer.currentTime),p3.runContext().then((function(){t._state=o3.PLAYING,t._audioTimer.start(),window.clearTimeout(t._currentTimer),t._currentTimer=window.setTimeout((function e(){t.loop?t._currentTimer=window.setTimeout(e,1e3*t._audioBuffer.duration):(t._audioTimer.stop(),t._eventTarget.emit(i3.ENDED),t._state=o3.INIT)}),1e3*(t._audioBuffer.duration-t._audioTimer.currentTime)),e()})).catch((function(){}))}))},e._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(t){}},e.pause=function(){return this._state===o3.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=o3.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=o3.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.onInterruptionBegin=function(t){this._eventTarget.on(i3.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(i3.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(i3.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(i3.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(i3.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(i3.ENDED,t)},Z(t,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return r3.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._sourceNode&&(this._sourceNode.loop=t)}},{key:"volume",get:function(){return this._volume},set:function(t){t=cn(t),this._volume=t,p3.setGainValue(this._gainNode,t)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),t}()).prototype,"seek",[u3],Object.getOwnPropertyDescriptor(f3.prototype,"seek"),f3.prototype),lt(f3.prototype,"play",[u3],Object.getOwnPropertyDescriptor(f3.prototype,"play"),f3.prototype),lt(f3.prototype,"pause",[u3],Object.getOwnPropertyDescriptor(f3.prototype,"pause"),f3.prototype),lt(f3.prototype,"stop",[u3],Object.getOwnPropertyDescriptor(f3.prototype,"stop"),f3.prototype),f3),w3=function(){function t(t){this._audio=void 0,this._audio=t}var e=t.prototype;return e.play=function(){this._audio.play()},e.stop=function(){this._audio.stop()},Z(t,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(t){this._audio.onPlay=t}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(t){this._audio.onEnd=t}}]),t}(),R3=function(){function t(t){this._player=void 0,this._player=t}t.load=function(e,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==r3.DOM_AUDIO&&y3.support?A3.load(e).then((function(e){i(new t(e))})).catch((function(){})):(y3.support||M(5201),_3.load(e).then((function(e){i(new t(e))})).catch((function(){})))}))};var e=t.prototype;return e.destroy=function(){this._player.destroy()},t.loadNative=function(t,e){return(null==e?void 0:e.audioLoadMode)!==r3.DOM_AUDIO&&y3.support?A3.loadNative(t):(y3.support||M(5201),_3.loadNative(t))},t.loadOneShotAudio=function(t,e,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==r3.DOM_AUDIO&&y3.support?A3.loadOneShotAudio(t,e).then((function(t){i(new w3(t))})).catch(r):(y3.support||M(5201),_3.loadOneShotAudio(t,e).then((function(t){i(new w3(t))})).catch(r))}))},e.seek=function(t){return this._player.seek(t)},e.play=function(){return this._player.play()},e.pause=function(){return this._player.pause()},e.stop=function(){return this._player.stop()},e.onInterruptionBegin=function(t){this._player.onInterruptionBegin(t)},e.offInterruptionBegin=function(t){this._player.offInterruptionBegin(t)},e.onInterruptionEnd=function(t){this._player.onInterruptionEnd(t)},e.offInterruptionEnd=function(t){this._player.offInterruptionEnd(t)},e.onEnded=function(t){this._player.onEnded(t)},e.offEnded=function(t){this._player.offEnded(t)},Z(t,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(t){this._player.loop=t}},{key:"volume",get:function(){return this._player.volume},set:function(t){this._player.volume=t}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),t}();R3.maxAudioChannel=24;var P3=t("AudioClip",dc("cc.AudioClip")((b3=E3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_duration",T3,ot(e)),e._loadMode=r3.UNKNOWN_AUDIO,e._meta=null,e._player=null,e}$(e,t);var n=e.prototype;return n.destroy=function(){var e,n=t.prototype.destroy.call(this);return null===(e=this._player)||void 0===e||e.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(t){var e;null===(e=this._player)||void 0===e||e.seek(t).catch((function(){}))},n.setVolume=function(t){this._player&&(this._player.volume=t)},n.setLoop=function(t){this._player&&(this._player.loop=t)},n.play=function(){var t;null===(t=this._player)||void 0===t||t.play().catch((function(){}))},n.pause=function(){var t;null===(t=this._player)||void 0===t||t.pause().catch((function(){}))},n.stop=function(){var t;null===(t=this._player)||void 0===t||t.stop().catch((function(){}))},n.playOneShot=function(t){void 0===t&&(t=1),this._nativeAsset&&R3.loadOneShotAudio(this._nativeAsset.url,t).then((function(t){t.play()})).catch((function(){}))},Z(e,[{key:"_nativeAsset",get:function(){return this._meta},set:function(t){this._meta=t,t?(this._loadMode=t.type,this._player=t.player):(this._meta=null,this._loadMode=r3.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:o3.INIT}}]),e}(Du),E3.AudioType=r3,T3=lt((S3=b3).prototype,"_duration",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(S3.prototype,"_nativeDep",[ol],Object.getOwnPropertyDescriptor(S3.prototype,"_nativeDep"),S3.prototype),x3=S3))||x3);function I3(t,e,n){R3.load(t,{audioLoadMode:e.audioLoadMode}).then((function(e){var i={player:e,url:t,duration:e.duration,type:e.type};n(null,i)})).catch((function(t){n(t)}))}function M3(t,e,n,i){var r=new P3;r._nativeUrl=t,r._nativeAsset=e,r._duration=e.duration,i(null,r)}u.AudioClip=P3,ON.register({".mp3":I3,".ogg":I3,".wav":I3,".m4a":I3}),UN.register({".mp3":M3,".ogg":M3,".wav":M3,".m4a":M3});var D3,O3,N3,L3,B3,F3,z3,k3,U3,G3,H3,V3,W3,j3,q3,X3,Y3,K3,Q3,Z3=new(function(){function t(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var e=t.prototype;return e._findIndex=function(t,e){return t.findIndex((function(t){return t.audio===e}))},e._tryAddPlaying=function(t,e){var n=this._findIndex(t,e);return n>-1?(t[n].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)},e.addPlaying=function(t){if(t instanceof R3){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)},e._tryRemovePlaying=function(t,e){var n=this._findIndex(t,e);return-1!==n&&(ft(t,n),!0)},e.removePlaying=function(t){if(t instanceof R3){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)},e.discardOnePlayingIfNeeded=function(){var t;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<R3.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio)))},t}());!function(t){t.STARTED="started",t.ENDED="ended"}(Q3||(Q3={}));var J3=function(e){return t({AudioSource:e,AudioSourceComponent:e}),e}((D3=dc("cc.AudioSource"),O3=Ic(),N3=Ac(),L3=Kc(P3),B3=Kc(P3),F3=Lc(),z3=Lc(),k3=Lc(),U3=Bc(),G3=Lc(),D3(H3=O3(H3=N3((K3=Y3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_clip",W3,ot(e)),e._player=null,ct(e,"_loop",j3,ot(e)),ct(e,"_playOnAwake",q3,ot(e)),ct(e,"_volume",X3,ot(e)),e._cachedCurrentTime=0,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}$(e,t);var n=e.prototype;return n._syncPlayer=function(){var t=this,e=this._clip;this._isLoaded=!1,this._lastSetClip!==e&&(e?e._nativeAsset?(this._lastSetClip=e,R3.load(e._nativeAsset.url,{audioLoadMode:e.loadMode}).then((function(n){t._lastSetClip===e?(t._isLoaded=!0,t._player&&(t._player.offEnded(),t._player.offInterruptionBegin(),t._player.offInterruptionEnd(),t._player.destroy()),t._player=n,n.onEnded((function(){Z3.removePlaying(n),t.node.emit(Q3.ENDED,t)})),n.onInterruptionBegin((function(){Z3.removePlaying(n)})),n.onInterruptionEnd((function(){Z3.addPlaying(n)})),t._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var t=this._getRootNode();(null==t?void 0:t._persistNode)||this.pause()},n.onDestroy=function(){var t;this.stop(),null===(t=this._player)||void 0===t||t.destroy(),this._player=null},n._getRootNode=function(){for(var t,e,n=this.node,i=null===(t=n)||void 0===t||null===(e=t.parent)||void 0===e?void 0:e.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var t,e,n=this;this._isLoaded?(Z3.discardOnePlayingIfNeeded(),this.state===o3.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((function(){}))),null===(t=this._player)||void 0===t||t.play().then((function(){Z3.addPlaying(n._player),n.node.emit(Q3.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((function(){Z3.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((function(){Z3.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(t,e){void 0===e&&(e=1),t._nativeAsset?R3.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((function(t){Z3.discardOnePlayingIfNeeded(),t.onPlay=function(){Z3.addPlaying(t)},t.onEnd=function(){Z3.removePlaying(t)},t.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var t=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){t._player&&(t._player.loop=t._loop,t._player.volume=t._volume,t._operationsBeforeLoading.forEach((function(e){var n;null===(n=t[e])||void 0===n||n.call(t)})),t._operationsBeforeLoading.length=0)})).catch((function(){}))},Z(e,[{key:"clip",get:function(){return this._clip},set:function(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._player&&(this._player.loop=t)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(t){this._playOnAwake=t}},{key:"volume",get:function(){return this._volume},set:function(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=sn(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=sn(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:o3.INIT}},{key:"playing",get:function(){return this.state===e.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return R3.maxAudioChannel}}]),e}($u),Y3.AudioState=o3,Y3.EventType=Q3,W3=lt((V3=K3).prototype,"_clip",[L3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j3=lt(V3.prototype,"_loop",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q3=lt(V3.prototype,"_playOnAwake",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X3=lt(V3.prototype,"_volume",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt(V3.prototype,"clip",[B3,F3],Object.getOwnPropertyDescriptor(V3.prototype,"clip"),V3.prototype),lt(V3.prototype,"loop",[z3],Object.getOwnPropertyDescriptor(V3.prototype,"loop"),V3.prototype),lt(V3.prototype,"playOnAwake",[k3],Object.getOwnPropertyDescriptor(V3.prototype,"playOnAwake"),V3.prototype),lt(V3.prototype,"volume",[U3,G3],Object.getOwnPropertyDescriptor(V3.prototype,"volume"),V3.prototype),H3=V3))||H3)||H3)||H3));U(P3,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:J3,targetName:"AudioSource"}]),H(P3.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(t){return{name:t,suggest:"please use AudioSource.prototype."+t+" instead"}}))),u.AudioSourceComponent=J3,ie.setClassAlias(J3,"cc.AudioSourceComponent"),u.log=x,u.warn=S,u.error=T,u.assert=E,u._throw=A,u.logID=P,u.warnID=M,u.errorID=O,u.assertID=B,u.debug=q,u.path={join:yu,extname:xu,mainFileName:Su,basename:Tu,dirname:Eu,changeExtname:bu,changeBasename:Cu,_normalize:Au,stripSep:wu,get sep(){return Ru()}};var $3=t("NodePool",function(){function t(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}var e=t.prototype;return e.size=function(){return this._pool.length},e.clear=function(){for(var t=this._pool.length,e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0},e.put=function(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();var e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}},e.get=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},t}());u.NodePool=$3,u.renderer=Dj;var t5,e5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSet=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,n=e.bindings,i=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)if(t[e].type&$r){var n=this._buffers[e];n&&(t[e].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else t[e].type&to&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},Z(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(xo);!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.SRGB_EXT=35904]="SRGB_EXT",t[t.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",t[t.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(t5||(t5={}));var n5=function(){function t(){}return t.setInstance=function(e){t._instance=e},Z(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();function i5(t,e){switch(t){case fi.R8:return e.UNSIGNED_BYTE;case fi.R8SN:return e.BYTE;case fi.R8UI:return e.UNSIGNED_BYTE;case fi.R8I:return e.BYTE;case fi.R16F:return t5.HALF_FLOAT_OES;case fi.R16UI:return e.UNSIGNED_SHORT;case fi.R16I:return e.SHORT;case fi.R32F:return e.FLOAT;case fi.R32UI:return e.UNSIGNED_INT;case fi.R32I:return e.INT;case fi.RG8:return e.UNSIGNED_BYTE;case fi.RG8SN:return e.BYTE;case fi.RG8UI:return e.UNSIGNED_BYTE;case fi.RG8I:return e.BYTE;case fi.RG16F:return t5.HALF_FLOAT_OES;case fi.RG16UI:return e.UNSIGNED_SHORT;case fi.RG16I:return e.SHORT;case fi.RG32F:return e.FLOAT;case fi.RG32UI:return e.UNSIGNED_INT;case fi.RG32I:return e.INT;case fi.RGB8:case fi.SRGB8:return e.UNSIGNED_BYTE;case fi.RGB8SN:return e.BYTE;case fi.RGB8UI:return e.UNSIGNED_BYTE;case fi.RGB8I:return e.BYTE;case fi.RGB16F:return t5.HALF_FLOAT_OES;case fi.RGB16UI:return e.UNSIGNED_SHORT;case fi.RGB16I:return e.SHORT;case fi.RGB32F:return e.FLOAT;case fi.RGB32UI:return e.UNSIGNED_INT;case fi.RGB32I:return e.INT;case fi.BGRA8:case fi.RGBA8:case fi.SRGB8_A8:return e.UNSIGNED_BYTE;case fi.RGBA8SN:return e.BYTE;case fi.RGBA8UI:return e.UNSIGNED_BYTE;case fi.RGBA8I:return e.BYTE;case fi.RGBA16F:return t5.HALF_FLOAT_OES;case fi.RGBA16UI:return e.UNSIGNED_SHORT;case fi.RGBA16I:return e.SHORT;case fi.RGBA32F:return e.FLOAT;case fi.RGBA32UI:return e.UNSIGNED_INT;case fi.RGBA32I:return e.INT;case fi.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case fi.R11G11B10F:return e.FLOAT;case fi.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case fi.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case fi.RGB10A2:return e.UNSIGNED_BYTE;case fi.RGB10A2UI:return e.UNSIGNED_INT;case fi.RGB9E5:return e.UNSIGNED_BYTE;case fi.DEPTH:return e.UNSIGNED_INT;case fi.DEPTH_STENCIL:return t5.UNSIGNED_INT_24_8_WEBGL;case fi.BC1:case fi.BC1_SRGB:case fi.BC2:case fi.BC2_SRGB:case fi.BC3:case fi.BC3_SRGB:case fi.BC4:return e.UNSIGNED_BYTE;case fi.BC4_SNORM:return e.BYTE;case fi.BC5:return e.UNSIGNED_BYTE;case fi.BC5_SNORM:return e.BYTE;case fi.BC6H_SF16:case fi.BC6H_UF16:return e.FLOAT;case fi.BC7:case fi.BC7_SRGB:case fi.ETC_RGB8:case fi.ETC2_RGB8:case fi.ETC2_SRGB8:case fi.ETC2_RGB8_A1:case fi.ETC2_SRGB8_A1:case fi.EAC_R11:return e.UNSIGNED_BYTE;case fi.EAC_R11SN:return e.BYTE;case fi.EAC_RG11:return e.UNSIGNED_BYTE;case fi.EAC_RG11SN:return e.BYTE;case fi.PVRTC_RGB2:case fi.PVRTC_RGBA2:case fi.PVRTC_RGB4:case fi.PVRTC_RGBA4:case fi.PVRTC2_2BPP:case fi.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case fi.ASTC_RGBA_4X4:case fi.ASTC_RGBA_5X4:case fi.ASTC_RGBA_5X5:case fi.ASTC_RGBA_6X5:case fi.ASTC_RGBA_6X6:case fi.ASTC_RGBA_8X5:case fi.ASTC_RGBA_8X6:case fi.ASTC_RGBA_8X8:case fi.ASTC_RGBA_10X5:case fi.ASTC_RGBA_10X6:case fi.ASTC_RGBA_10X8:case fi.ASTC_RGBA_10X10:case fi.ASTC_RGBA_12X10:case fi.ASTC_RGBA_12X12:case fi.ASTC_SRGBA_4X4:case fi.ASTC_SRGBA_5X4:case fi.ASTC_SRGBA_5X5:case fi.ASTC_SRGBA_6X5:case fi.ASTC_SRGBA_6X6:case fi.ASTC_SRGBA_8X5:case fi.ASTC_SRGBA_8X6:case fi.ASTC_SRGBA_8X8:case fi.ASTC_SRGBA_10X5:case fi.ASTC_SRGBA_10X6:case fi.ASTC_SRGBA_10X8:case fi.ASTC_SRGBA_10X10:case fi.ASTC_SRGBA_12X10:case fi.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function r5(t,e){switch(t){case di.BOOL:return e.BOOL;case di.BOOL2:return e.BOOL_VEC2;case di.BOOL3:return e.BOOL_VEC3;case di.BOOL4:return e.BOOL_VEC4;case di.INT:return e.INT;case di.INT2:return e.INT_VEC2;case di.INT3:return e.INT_VEC3;case di.INT4:return e.INT_VEC4;case di.UINT:return e.UNSIGNED_INT;case di.FLOAT:return e.FLOAT;case di.FLOAT2:return e.FLOAT_VEC2;case di.FLOAT3:return e.FLOAT_VEC3;case di.FLOAT4:return e.FLOAT_VEC4;case di.MAT2:return e.FLOAT_MAT2;case di.MAT3:return e.FLOAT_MAT3;case di.MAT4:return e.FLOAT_MAT4;case di.SAMPLER2D:return e.SAMPLER_2D;case di.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),di.UNKNOWN}}function o5(t){switch(t){case di.BOOL:case di.BOOL2:case di.BOOL3:case di.BOOL4:case di.INT:case di.INT2:case di.INT3:case di.INT4:case di.UINT:return Int32Array;case di.FLOAT:case di.FLOAT2:case di.FLOAT3:case di.FLOAT4:case di.MAT2:case di.MAT3:case di.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function a5(t,e){switch(t){case e.BOOL:return di.BOOL;case e.BOOL_VEC2:return di.BOOL2;case e.BOOL_VEC3:return di.BOOL3;case e.BOOL_VEC4:return di.BOOL4;case e.INT:return di.INT;case e.INT_VEC2:return di.INT2;case e.INT_VEC3:return di.INT3;case e.INT_VEC4:return di.INT4;case e.UNSIGNED_INT:return di.UINT;case e.FLOAT:return di.FLOAT;case e.FLOAT_VEC2:return di.FLOAT2;case e.FLOAT_VEC3:return di.FLOAT3;case e.FLOAT_VEC4:return di.FLOAT4;case e.FLOAT_MAT2:return di.MAT2;case e.FLOAT_MAT3:return di.MAT3;case e.FLOAT_MAT4:return di.MAT4;case e.SAMPLER_2D:return di.SAMPLER2D;case e.SAMPLER_CUBE:return di.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),di.UNKNOWN}}function s5(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function c5(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}n5._instance=null;var l5,u5=[512,513,514,515,516,517,518,519],h5=[0,7680,7681,7682,7683,5386,34055,34056],f5=[32774,32778,32779,32775,32776],p5=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(l5||(l5={}));var d5=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},_5=function(t){function e(){var e;return(e=t.call(this,l5.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new $i,e.clearFlag=Xi.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return $(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(d5),m5=function(t){function e(){var e;return(e=t.call(this,l5.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new Qr,e}return $(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},e}(d5),v5=function(t){function e(){var e;return(e=t.call(this,l5.DRAW)||this).drawInfo=new pr,e}return $(e,t),e.prototype.clear=function(){},e}(d5),g5=function(t){function e(){var e;return(e=t.call(this,l5.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return $(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(d5),y5=function(t){function e(){var e;return(e=t.call(this,l5.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return $(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(d5),x5=function(){function t(){this.cmds=new ql(1),this.beginRenderPassCmds=new ql(1),this.bindStatesCmds=new ql(1),this.drawCmds=new ql(1),this.updateBufferCmds=new ql(1),this.copyBufferToTextureCmds=new ql(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function S5(t,e,n,i,r){if(e.usage&_i.UNIFORM)ArrayBuffer.isView(n)?e.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&_i.INDIRECT){e.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),T5.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),T5.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r))}}var T5={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function E5(t,e,n,i,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;t.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var f=e.colorAttachments[h];if(f.format!==fi.UNKNOWN)switch(f.loadOp){case Di.LOAD:break;case Di.CLEAR:c.bs.targets[0].blendColorMask!==Ii.ALL&&s.colorMask(!0,!0,!0,!0);var p=r[0];s.clearColor(p.x,p.y,p.z,p.w),l|=s.COLOR_BUFFER_BIT;break;case Di.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==fi.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Di.LOAD:break;case Di.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Di.DISCARD:}if(Jr[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Di.LOAD:break;case Di.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Di.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var d=c.bs.targets[0].blendColorMask;if(d!==Ii.ALL){var _=(d&Ii.R)!==Ii.NONE,m=(d&Ii.G)!==Ii.NONE,v=(d&Ii.B)!==Ii.NONE,g=(d&Ii.A)!==Ii.NONE;s.colorMask(_,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function b5(t,e,n,i,r,o){var a,s,c,l=t.gl,u=t.stateCache,h=e&&e.gpuShader,f=!1;if(e&&T5.gpuPipelineState!==e){if(T5.gpuPipelineState=e,T5.glPrimitive=e.glPrimitive,e.gpuShader){var p=e.gpuShader.glProgram;u.glProgram!==p&&(l.useProgram(p),u.glProgram=p,f=!0)}var d=e.rs;if(d){if(u.rs.cullMode!==d.cullMode){switch(d.cullMode){case Ui.NONE:l.disable(l.CULL_FACE);break;case Ui.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Ui.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=d.cullMode}var _=d.isFrontFaceCCW;u.rs.isFrontFaceCCW!==_&&(l.frontFace(_?l.CCW:l.CW),u.rs.isFrontFaceCCW=_),u.rs.depthBias===d.depthBias&&u.rs.depthBiasSlop===d.depthBiasSlop||(l.polygonOffset(d.depthBias,d.depthBiasSlop),u.rs.depthBias=d.depthBias,u.rs.depthBiasSlop=d.depthBiasSlop),u.rs.lineWidth!==d.lineWidth&&(l.lineWidth(d.lineWidth),u.rs.lineWidth=d.lineWidth)}var m=e.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(u5[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,u5[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,h5[m.stencilFailOpFront],h5[m.stencilZFailOpFront],h5[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,u5[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,h5[m.stencilFailOpBack],h5[m.stencilZFailOpBack],h5[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=e.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(f5[g.blendEq],f5[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(p5[g.blendSrc],p5[g.blendDst],p5[g.blendSrcAlpha],p5[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&Ii.R)!==Ii.NONE,(g.blendColorMask&Ii.G)!==Ii.NONE,(g.blendColorMask&Ii.B)!==Ii.NONE,(g.blendColorMask&Ii.A)!==Ii.NONE),y.blendColorMask=g.blendColorMask)}}if(e&&e.gpuPipelineLayout&&h){for(var x=h.glBlocks.length,S=e.gpuPipelineLayout.dynamicOffsetIndices,E=0;E<x;E++){var b=h.glBlocks[E],C=i[b.set],A=C&&C.descriptorIndices[b.binding],w=A>=0&&C.gpuDescriptors[A],R=null,P=0;if(w&&w.gpuBuffer){var I=w.gpuBuffer,M=S[b.set],D=M&&M[b.binding];D>=0&&(P=r[D]),"vf32"in I?R=I.vf32:(P+=I.offset,R=I.gpuBuffer.vf32),P>>=2}if(R)for(var O=b.glActiveUniforms.length,N=0;N<O;N++){var L=b.glActiveUniforms[N];switch(L.glType){case l.BOOL:case l.INT:for(var B=0;B<L.array.length;++B){var F=L.offset+P+B;if(R[F]!==L.array[B]){for(var z=B,k=F;z<L.array.length;++z,++k)L.array[z]=R[k];l.uniform1iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var U=0;U<L.array.length;++U){var G=L.offset+P+U;if(R[G]!==L.array[U]){for(var H=U,V=G;H<L.array.length;++H,++V)L.array[H]=R[V];l.uniform2iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var W=0;W<L.array.length;++W){var j=L.offset+P+W;if(R[j]!==L.array[W]){for(var q=W,X=j;q<L.array.length;++q,++X)L.array[q]=R[X];l.uniform3iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<L.array.length;++Y){var K=L.offset+P+Y;if(R[K]!==L.array[Y]){for(var Q=Y,Z=K;Q<L.array.length;++Q,++Z)L.array[Q]=R[Z];l.uniform4iv(L.glLoc,L.array);break}}break;case l.FLOAT:for(var J=0;J<L.array.length;++J){var $=L.offset+P+J;if(R[$]!==L.array[J]){for(var tt=J,et=$;tt<L.array.length;++tt,++et)L.array[tt]=R[et];l.uniform1fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC2:for(var nt=0;nt<L.array.length;++nt){var it=L.offset+P+nt;if(R[it]!==L.array[nt]){for(var rt=nt,ot=it;rt<L.array.length;++rt,++ot)L.array[rt]=R[ot];l.uniform2fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC3:for(var at=0;at<L.array.length;++at){var st=L.offset+P+at;if(R[st]!==L.array[at]){for(var ct=at,lt=st;ct<L.array.length;++ct,++lt)L.array[ct]=R[lt];l.uniform3fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC4:for(var ut=0;ut<L.array.length;++ut){var ht=L.offset+P+ut;if(R[ht]!==L.array[ut]){for(var ft=ut,pt=ht;ft<L.array.length;++ft,++pt)L.array[ft]=R[pt];l.uniform4fv(L.glLoc,L.array);break}}break;case l.FLOAT_MAT2:for(var dt=0;dt<L.array.length;++dt){var _t=L.offset+P+dt;if(R[_t]!==L.array[dt]){for(var mt=dt,vt=_t;mt<L.array.length;++mt,++vt)L.array[mt]=R[vt];l.uniformMatrix2fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT3:for(var gt=0;gt<L.array.length;++gt){var yt=L.offset+P+gt;if(R[yt]!==L.array[gt]){for(var xt=gt,St=yt;xt<L.array.length;++xt,++St)L.array[xt]=R[St];l.uniformMatrix3fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT4:for(var Tt=0;Tt<L.array.length;++Tt){var Et=L.offset+P+Tt;if(R[Et]!==L.array[Tt]){for(var bt=Tt,Ct=Et;bt<L.array.length;++bt,++Ct)L.array[bt]=R[Ct];l.uniformMatrix4fv(L.glLoc,!1,L.array);break}}}}else T("Buffer binding '"+b.name+"' at set "+b.set+" binding "+b.binding+" is not bounded")}for(var At=h.glSamplerTextures.length,wt=0;wt<At;wt++)for(var Rt=h.glSamplerTextures[wt],Pt=i[Rt.set],It=Pt&&Pt.descriptorIndices[Rt.binding],Mt=It>=0&&Pt.gpuDescriptors[It],Dt=Rt.units.length,Ot=0;Ot<Dt;Ot++){var Nt=Rt.units[Ot];if(Mt&&Mt.gpuSampler){if(Mt.gpuTexture&&Mt.gpuTexture.size>0){var Lt=Mt.gpuTexture,Bt=u.glTexUnits[Nt];Bt.glTexture!==Lt.glTexture&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),Lt.glTexture?l.bindTexture(Lt.glTarget,Lt.glTexture):l.bindTexture(Lt.glTarget,t.nullTex2D.gpuTexture.glTexture),Bt.glTexture=Lt.glTexture);var Ft=Mt.gpuSampler;Lt.isPowerOf2?(a=Ft.glWrapS,s=Ft.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Lt.isPowerOf2?Lt.mipLevel<=1&&(Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Ft.glMinFilter:Ft.glMinFilter===l.LINEAR||Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Lt.glWrapS!==a&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),l.texParameteri(Lt.glTarget,l.TEXTURE_WRAP_S,a),Lt.glWrapS=a),Lt.glWrapT!==s&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),l.texParameteri(Lt.glTarget,l.TEXTURE_WRAP_T,s),Lt.glWrapT=s),Lt.glMinFilter!==c&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),l.texParameteri(Lt.glTarget,l.TEXTURE_MIN_FILTER,c),Lt.glMinFilter=c),Lt.glMagFilter!==Ft.glMagFilter&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),l.texParameteri(Lt.glTarget,l.TEXTURE_MAG_FILTER,Ft.glMagFilter),Lt.glMagFilter=Ft.glMagFilter)}Mt=Pt.gpuDescriptors[++It]}else T("Sampler binding '"+Rt.name+"' at set "+Rt.set+" binding "+Rt.binding+" index "+Ot+" is not bounded")}}if(n&&h&&(f||T5.gpuInputAssembler!==n)){T5.gpuInputAssembler=n;var zt=t.extensions.ANGLE_instanced_arrays;if(t.extensions.useVAO){var kt=t.extensions.OES_vertex_array_object,Ut=n.glVAOs.get(h.glProgram);if(!Ut){var Gt;Ut=kt.createVertexArrayOES(),n.glVAOs.set(h.glProgram,Ut),kt.bindVertexArrayOES(Ut),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var Ht=h.glInputs.length,Vt=0;Vt<Ht;Vt++){var Wt=h.glInputs[Vt];Gt=null;for(var jt=n.glAttribs.length,qt=0;qt<jt;qt++){var Xt=n.glAttribs[qt];if(Xt.name===Wt.name){Gt=Xt;break}}if(Gt){u.glArrayBuffer!==Gt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Gt.glBuffer),u.glArrayBuffer=Gt.glBuffer);for(var Yt=0;Yt<Gt.componentCount;++Yt){var Kt=Wt.glLoc+Yt,Qt=Gt.offset+Gt.size*Yt;l.enableVertexAttribArray(Kt),u.glCurrentAttribLocs[Kt]=!0,l.vertexAttribPointer(Kt,Gt.count,Gt.glType,Gt.isNormalized,Gt.stride,Qt),zt&&zt.vertexAttribDivisorANGLE(Kt,Gt.isInstanced?1:0)}}}var Zt=n.gpuIndexBuffer;Zt&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Zt.glBuffer),kt.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==Ut&&(kt.bindVertexArrayOES(Ut),u.glVAO=Ut)}else{for(var Jt=0;Jt<t.capabilities.maxVertexAttributes;++Jt)u.glCurrentAttribLocs[Jt]=!1;for(var $t=h.glInputs.length,te=0;te<$t;te++){for(var ee=h.glInputs[te],ne=null,ie=n.glAttribs.length,re=0;re<ie;re++){var oe=n.glAttribs[re];if(oe.name===ee.name){ne=oe;break}}if(ne){u.glArrayBuffer!==ne.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,ne.glBuffer),u.glArrayBuffer=ne.glBuffer);for(var ae=0;ae<ne.componentCount;++ae){var se=ee.glLoc+ae,ce=ne.offset+ne.size*ae;!u.glEnabledAttribLocs[se]&&se>=0&&(l.enableVertexAttribArray(se),u.glEnabledAttribLocs[se]=!0),u.glCurrentAttribLocs[se]=!0,l.vertexAttribPointer(se,ne.count,ne.glType,ne.isNormalized,ne.stride,ce),zt&&zt.vertexAttribDivisorANGLE(se,ne.isInstanced?1:0)}}}var le=n.gpuIndexBuffer;le&&u.glElementArrayBuffer!==le.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,le.glBuffer),u.glElementArrayBuffer=le.glBuffer);for(var ue=0;ue<t.capabilities.maxVertexAttributes;++ue)u.glEnabledAttribLocs[ue]!==u.glCurrentAttribLocs[ue]&&(l.disableVertexAttribArray(ue),u.glEnabledAttribLocs[ue]=!1)}}if(e&&e.dynamicStates.length)for(var he=e.dynamicStates.length,fe=0;fe<he;fe++)switch(e.dynamicStates[fe]){case Gi.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Gi.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Gi.BLEND_CONSTANTS:var pe=o.blendConstant;u.bs.blendColor.x===pe.x&&u.bs.blendColor.y===pe.y&&u.bs.blendColor.z===pe.z&&u.bs.blendColor.w===pe.w||(l.blendColor(pe.x,pe.y,pe.z,pe.w),u.bs.blendColor.copy(pe));break;case Gi.STENCIL_WRITE_MASK:var de=o.stencilStatesFront,_e=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==de.writeMask&&(l.stencilMaskSeparate(l.FRONT,de.writeMask),u.dss.stencilWriteMaskFront=de.writeMask),u.dss.stencilWriteMaskBack!==_e.writeMask&&(l.stencilMaskSeparate(l.BACK,_e.writeMask),u.dss.stencilWriteMaskBack=_e.writeMask);break;case Gi.STENCIL_COMPARE_MASK:var me=o.stencilStatesFront,ve=o.stencilStatesBack;u.dss.stencilRefFront===me.reference&&u.dss.stencilReadMaskFront===me.compareMask||(l.stencilFuncSeparate(l.FRONT,u5[u.dss.stencilFuncFront],me.reference,me.compareMask),u.dss.stencilRefFront=me.reference,u.dss.stencilReadMaskFront=me.compareMask),u.dss.stencilRefBack===ve.reference&&u.dss.stencilReadMaskBack===ve.compareMask||(l.stencilFuncSeparate(l.BACK,u5[u.dss.stencilFuncBack],ve.reference,ve.compareMask),u.dss.stencilRefBack=ve.reference,u.dss.stencilReadMaskBack=ve.compareMask)}}function C5(t,e){var n=t.gl,i=t.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=T5.gpuInputAssembler,s=T5.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var f=0;f<l.drawCount;f++)l.instances[f]&&r?r.drawArraysInstancedANGLE(s,l.offsets[f],l.counts[f],l.instances[f]):n.drawArrays(s,l.offsets[f],l.counts[f])}else if(e.instanceCount&&r)if(c){if(e.indexCount>0){var p=e.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,e.indexCount,a.glIndexType,p,e.instanceCount)}}else e.vertexCount>0&&r.drawArraysInstancedANGLE(s,e.firstVertex,e.vertexCount,e.instanceCount);else if(c){if(e.indexCount>0){var d=e.firstIndex*c.stride;n.drawElements(s,e.indexCount,a.glIndexType,d)}}else e.vertexCount>0&&n.drawArrays(s,e.firstVertex,e.vertexCount)}}var A5=new Array(l5.COUNT);function w5(t,e){A5.fill(0);for(var n=0;n<e.cmds.length;++n){var i=e.cmds.array[n],r=A5[i]++;switch(i){case l5.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];E5(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case l5.BIND_STATES:var a=e.bindStatesCmds.array[r];b5(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case l5.DRAW:C5(t,e.drawCmds.array[r].drawInfo);break;case l5.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];S5(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case l5.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];R5(t,c.buffers,c.gpuTexture,c.regions)}}}function R5(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=Jr[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];s=f.texExtent.width,c=f.texExtent.height;var p=e[a++];u?n.glInternalFmt===t5.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,n.glInternalFmt,s,c,0,p):r.compressedTexSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,p):r.texSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,n.glType,p)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var _=i[d],m=_.texSubres.baseArrayLayer+_.texSubres.layerCount;for(l=_.texSubres.baseArrayLayer;l<m;++l){s=_.texExtent.width,c=_.texExtent.height;var v=e[a++];u?n.glInternalFmt===t5.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Si.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var P5=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=a(t);var e=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=n,this.instances=i}},t}(),I5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&_i.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new P5,glTarget:0,glBuffer:null},this._usage&_i.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&gi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&_i.VERTEX){e.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),T5.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&_i.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),T5.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&_i.UNIFORM?(e.glTarget=n.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&_i.INDIRECT||e.usage&_i.TRANSFER_DST||e.usage&_i.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(n5.instance,this._gpuBuffer),n5.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(t,e){var n=t.gl,i=t.stateCache;if(e.glBuffer){switch(e.glTarget){case n.ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),T5.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),T5.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null}n.deleteBuffer(e.glBuffer),e.glBuffer=null}}(n5.instance,this._gpuBuffer),n5.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&gi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&_i.VERTEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),T5.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&_i.INDEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),T5.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&_i.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&_i.INDIRECT||e.usage&_i.TRANSFER_DST||e.usage&_i.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(n5.instance,this._gpuBuffer),n5.instance.memoryStatus.bufferSize-=e,n5.instance.memoryStatus.bufferSize+=t)))}},n.update=function(t,e){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==e?e:this._usage&_i.INDIRECT?0:t.byteLength,S5(n5.instance,this._gpuBuffer,t,0,n))},Z(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),e}(uo),M5=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new ql(e);for(var n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,n=this._frees;this._frees=new Array(e);for(var i=e-n.length,r=0;r<i;++r)this._frees[r]=new t;for(var o=i,a=0;o<e;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),D5=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new M5(_5,1),this.bindStatesCmdPool=new M5(m5,1),this.drawCmdPool=new M5(v5,1),this.updateBufferCmdPool=new M5(g5,1),this.copyBufferToTextureCmdPool=new M5(y5,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),O5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).cmdPackage=new x5,e._cmdAllocator=new D5,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new Qr,e._isStateInvalied=!1,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=n5.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<e;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(t,e,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(_5);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(l5.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},n.bindDescriptorSet=function(t,e,n){var i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},n.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},n.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},n.setDepthBias=function(t,e,n){var i=this._curDynamicStates;i.depthBiasConstant===t&&i.depthBiasClamp===e&&i.depthBiasSlope===n||(i.depthBiasConstant=t,i.depthBiasClamp=e,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},n.setDepthBound=function(t,e){var n=this._curDynamicStates;n.depthMinBounds===t&&n.depthMaxBounds===e||(n.depthMinBounds=t,n.depthMaxBounds=e,this._isStateInvalied=!0)},n.setStencilWriteMask=function(t,e){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;t&Hi.FRONT&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0),t&Hi.BACK&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0)},n.setStencilCompareMask=function(t,e,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Hi.FRONT&&(i.compareMask===n&&i.reference===e||(i.reference=e,i.compareMask=n,this._isStateInvalied=!0)),t&Hi.BACK&&(r.compareMask===n&&r.reference===e||(r.reference=e,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(t){if(this._type===qi.PRIMARY&&this._isInRenderPass||this._type===qi.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,n=this._cmdAllocator.drawCmdPool.alloc(v5);n.drawInfo.copy(e),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(l5.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(t,e,n){if(this._type===qi.PRIMARY&&!this._isInRenderPass||this._type===qi.SECONDARY){var i=t.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(g5),a=0;t.usage&_i.INDIRECT||(a=void 0!==n?n:e.byteLength),r=e,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(l5.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(t,e,n){if(this._type===qi.PRIMARY&&!this._isInRenderPass||this._type===qi.SECONDARY){var i=e.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(y5);r&&(r.gpuTexture=i,r.regions=n,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(l5.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(t,e){for(var n=0;n<e;++n){for(var i=t[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<i.cmdPackage.copyBufferToTextureCmds.length;++f){var p=i.cmdPackage.copyBufferToTextureCmds.array[f];++p.refCount,this.cmdPackage.copyBufferToTextureCmds.push(p)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(m5);t&&(t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(l5.BIND_STATES),this._isStateInvalied=!1)},e}(ho),N5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuFramebuffer=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],n=0;n<t.colorTextures.length;++n){var i=t.colorTextures[n];i&&e.push(i.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var n=0;n<e.gpuColorTextures.length;++n)if(e.gpuColorTextures[n].isSwapchainTexture)return void(e.isOffscreen=!1);var i=t.gl,r=[],o=i.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=Jr[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}t.extensions.WEBGL_draw_buffers&&t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(n5.instance,this._gpuFramebuffer)},n.destroy=function(){var t,e;this._gpuFramebuffer&&(t=n5.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},Z(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(_o),L5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuInputAssembler=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var n=new Array(t.vertexBuffers.length),i=0;i<t.vertexBuffers.length;++i){var r=t.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var n=t.gl;e.glAttribs=new Array(e.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=i5(o.format,n),l=Jr[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Jr[o.format].count,stride:s.stride,componentCount:c5(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(n5.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var t=n5.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var n=e.glVAOs.values(),i=n.next(),r=t.extensions.OES_vertex_array_object,o=t.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},Z(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(yo),B5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(e),e+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&eo)for(var f=0;f<h.count;f++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},n.destroy=function(){this._bindings.length=0},Z(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(So),F5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineLayout=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),e.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},Z(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(To),z5=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],k5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineState=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var n=t.blendState,i=n.targets;i&&i.forEach((function(t,n){e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:z5[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},Z(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(Ro),U5=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.beginRenderPass=function(t,e,n,i,r,o){E5(n5.instance,t.gpuRenderPass,e.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;C5(n5.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(t){var e=n5.instance,n=e.stateCache,i=e.gl;n.viewport.left===t.left&&n.viewport.top===t.top&&n.viewport.width===t.width&&n.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),n.viewport.left=t.left,n.viewport.top=t.top,n.viewport.width=t.width,n.viewport.height=t.height)},n.setScissor=function(t){var e=n5.instance,n=e.stateCache,i=e.gl;n.scissorRect.x===t.x&&n.scissorRect.y===t.y&&n.scissorRect.width===t.width&&n.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),n.scissorRect.x=t.x,n.scissorRect.y=t.y,n.scissorRect.width=t.width,n.scissorRect.height=t.height)},n.updateBuffer=function(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=t.gpuBuffer;r&&(i=void 0!==n?n:t.usage&_i.INDIRECT?0:e.byteLength,S5(n5.instance,r,e,0,i))}},n.copyBuffersToTexture=function(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=e.gpuTexture;i&&R5(n5.instance,t,i,n)}},n.execute=function(t,e){for(var n=0;n<e;++n){var i=t[n];w5(n5.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){b5(n5.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(O5),G5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type},n.destroy=function(){},n.submit=function(t){for(var e=t.length,n=0;n<e;n++){var i=t[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Po),H5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuRenderPass=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},Z(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(Io),V5=[10497,33648,33071,33071],W5=function(t){function e(e,n){var i;(i=t.call(this,e,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===bi.LINEAR||a===bi.ANISOTROPIC?c===bi.LINEAR||c===bi.ANISOTROPIC?9987:c===bi.POINT?9985:9729:c===bi.LINEAR||c===bi.ANISOTROPIC?9986:c===bi.POINT?9984:9728,o=s===bi.LINEAR||s===bi.ANISOTROPIC?9729:9728;var l=V5[i._info.addressU],u=V5[i._info.addressV],h=V5[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return $(e,t),Z(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Mo),j5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuShader=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}!function(t,e){for(var n=t.gl,i=function(t){var i=e.gpuStages[t],r=0,o="",a=1;switch(i.type){case Mi.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Mi.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];n.attachShader(e.glProgram,c.glShader)}if(n.linkProgram(e.glProgram),t.extensions.destroyShadersImmediately)for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(n.detachShader(e.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(n.getProgramInfoLog(e.glProgram));b("Shader '"+e.name+"' compilation succeeded.");var h=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var f=0;f<h;++f){var p=n.getActiveAttrib(e.glProgram,f);if(p){var d,_=p.name.indexOf("[");d=-1!==_?p.name.substr(0,_):p.name;var m=n.getAttribLocation(e.glProgram,d),v=a5(p.type,n),g=s5(p.type,n);e.glInputs[f]={binding:m,name:d,type:v,stride:g,count:p.size,size:g*p.size,glType:p.type,glLoc:m}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(var y=0;y<e.blocks.length;++y){var x=e.blocks[y],S={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};e.glBlocks[y]=S;for(var T=0;T<x.members.length;++T){var E=x.members[T],C=r5(E.type,n),A=s5(C,n),w=A*E.count;S.glUniforms[T]={binding:-1,name:E.name,type:E.type,stride:A,count:E.count,size:w,offset:0,glType:C,glLoc:null,array:null}}}}for(var R=0;R<e.subpassInputs.length;++R){var P=e.subpassInputs[R];e.samplerTextures.push(new Sr(P.set,P.binding,P.name,di.SAMPLER2D,P.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var I=0;I<e.samplerTextures.length;++I){var M=e.samplerTextures[I];e.glSamplerTextures[I]={set:M.set,binding:M.binding,name:M.name,type:M.type,count:M.count,units:[],glUnits:null,glType:r5(M.type,n),glLoc:null}}}for(var D=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORMS),O=0;O<D;++O){var N=n.getActiveUniform(e.glProgram,O);if(N&&N.type!==n.SAMPLER_2D&&N.type!==n.SAMPLER_CUBE){var L=n.getUniformLocation(e.glProgram,N.name);if(t.extensions.isLocationActive(L)){var B,F=N.name.indexOf("[");B=-1!==F?N.name.substr(0,F):N.name;for(var z=0;z<e.glBlocks.length;z++)for(var k=e.glBlocks[z],U=0;U<k.glUniforms.length;U++){var G=k.glUniforms[U];if(G.name===B){G.glLoc=L,G.count=N.size,G.size=G.stride*G.count,G.array=new(o5(G.type))(G.size/4),k.glActiveUniforms.push(G);break}}}}}for(var H=0;H<e.glBlocks.length;H++)for(var V=e.glBlocks[H],W=0;W<V.glUniforms.length;W++){var j=V.glUniforms[W];j.offset=V.size/4,V.size+=j.size}for(var q=[],X=[],Y=t.bindingMappingInfo,K=t.stateCache.texUnitCacheMap,Q=0,Z=0;Z<e.blocks.length;++Z)e.blocks[Z].set===Y.flexibleSet&&Q++;for(var J=0,$=0;$<e.samplerTextures.length;++$){var tt=e.samplerTextures[$],et=n.getUniformLocation(e.glProgram,tt.name);if(t.extensions.isLocationActive(et)&&(q.push(e.glSamplerTextures[$]),X.push(et)),void 0===K[tt.name]){var nt=tt.binding+Y.samplerOffsets[tt.set]+J;tt.set===Y.flexibleSet&&(nt-=Q),K[tt.name]=nt%t.capabilities.maxTextureUnits,J+=tt.count-1}}if(q.length){for(var it=[],rt=0;rt<q.length;++rt){var ot=q[rt],at=K[ot.name];if(void 0!==at){ot.glLoc=X[rt];for(var st=0;st<ot.count;++st){for(;it[at];)at=(at+1)%t.capabilities.maxTextureUnits;ot.units.push(at),it[at]=!0}}}for(var ct=0,lt=0;lt<q.length;++lt){var ut=q[lt];if(!t.extensions.isLocationActive(ut.glLoc)){ut.glLoc=X[lt];for(var ht=0;ht<ut.count;++ht){for(;it[ct];)ct=(ct+1)%t.capabilities.maxTextureUnits;void 0===K[ut.name]&&(K[ut.name]=ct),ut.units.push(ct),it[ct]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(var ft=0;ft<q.length;ft++){var pt=q[ft];pt.glUnits=new Int32Array(pt.units),n.uniform1iv(pt.glLoc,pt.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}for(var dt=0;dt<e.glBlocks.length;)e.glBlocks[dt].glActiveUniforms.length?dt++:(e.glBlocks[dt]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=q}}(n5.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(t,e){if(e.glProgram){var n=t.gl;if(!t.extensions.destroyShadersImmediately)for(var i=0;i<e.gpuStages.length;i++){var r=e.gpuStages[i];r.glShader&&(n.detachShader(e.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null}}(n5.instance,this._gpuShader),this._gpuShader=null)},Z(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Do),q5=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new ar,this.scissorRect=new $i(0,0,0,0),this.rs=new Eo,this.dss=new bo,this.bs=new Ao,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e){for(var n=0;n<t;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)},t}(),X5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuTexture=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t,e){"texture"in t?console.log("WebGL does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=io(this._width)&&io(this._height),this._size=oo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},function(t,e){var n=t.gl;e.glFormat=e.glInternalFmt=function(t,e){switch(t){case fi.A8:return e.ALPHA;case fi.L8:return e.LUMINANCE;case fi.LA8:return e.LUMINANCE_ALPHA;case fi.RGB8:case fi.RGB16F:case fi.RGB32F:return e.RGB;case fi.BGRA8:case fi.RGBA8:case fi.SRGB8_A8:case fi.RGBA16F:case fi.RGBA32F:return e.RGBA;case fi.R5G6B5:return e.RGB;case fi.RGB5A1:case fi.RGBA4:return e.RGBA;case fi.DEPTH:return e.DEPTH_COMPONENT;case fi.DEPTH_STENCIL:return e.DEPTH_STENCIL;case fi.BC1:return t5.COMPRESSED_RGB_S3TC_DXT1_EXT;case fi.BC1_ALPHA:return t5.COMPRESSED_RGBA_S3TC_DXT1_EXT;case fi.BC1_SRGB:return t5.COMPRESSED_SRGB_S3TC_DXT1_EXT;case fi.BC1_SRGB_ALPHA:return t5.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case fi.BC2:return t5.COMPRESSED_RGBA_S3TC_DXT3_EXT;case fi.BC2_SRGB:return t5.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case fi.BC3:return t5.COMPRESSED_RGBA_S3TC_DXT5_EXT;case fi.BC3_SRGB:return t5.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case fi.ETC_RGB8:return t5.COMPRESSED_RGB_ETC1_WEBGL;case fi.ETC2_RGB8:return t5.COMPRESSED_RGB8_ETC2;case fi.ETC2_SRGB8:return t5.COMPRESSED_SRGB8_ETC2;case fi.ETC2_RGB8_A1:return t5.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fi.ETC2_SRGB8_A1:return t5.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fi.ETC2_RGBA8:return t5.COMPRESSED_RGBA8_ETC2_EAC;case fi.ETC2_SRGB8_A8:return t5.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case fi.EAC_R11:return t5.COMPRESSED_R11_EAC;case fi.EAC_R11SN:return t5.COMPRESSED_SIGNED_R11_EAC;case fi.EAC_RG11:return t5.COMPRESSED_RG11_EAC;case fi.EAC_RG11SN:return t5.COMPRESSED_SIGNED_RG11_EAC;case fi.PVRTC_RGB2:return t5.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case fi.PVRTC_RGBA2:return t5.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case fi.PVRTC_RGB4:return t5.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case fi.PVRTC_RGBA4:return t5.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case fi.ASTC_RGBA_4X4:return t5.COMPRESSED_RGBA_ASTC_4x4_KHR;case fi.ASTC_RGBA_5X4:return t5.COMPRESSED_RGBA_ASTC_5x4_KHR;case fi.ASTC_RGBA_5X5:return t5.COMPRESSED_RGBA_ASTC_5x5_KHR;case fi.ASTC_RGBA_6X5:return t5.COMPRESSED_RGBA_ASTC_6x5_KHR;case fi.ASTC_RGBA_6X6:return t5.COMPRESSED_RGBA_ASTC_6x6_KHR;case fi.ASTC_RGBA_8X5:return t5.COMPRESSED_RGBA_ASTC_8x5_KHR;case fi.ASTC_RGBA_8X6:return t5.COMPRESSED_RGBA_ASTC_8x6_KHR;case fi.ASTC_RGBA_8X8:return t5.COMPRESSED_RGBA_ASTC_8x8_KHR;case fi.ASTC_RGBA_10X5:return t5.COMPRESSED_RGBA_ASTC_10x5_KHR;case fi.ASTC_RGBA_10X6:return t5.COMPRESSED_RGBA_ASTC_10x6_KHR;case fi.ASTC_RGBA_10X8:return t5.COMPRESSED_RGBA_ASTC_10x8_KHR;case fi.ASTC_RGBA_10X10:return t5.COMPRESSED_RGBA_ASTC_10x10_KHR;case fi.ASTC_RGBA_12X10:return t5.COMPRESSED_RGBA_ASTC_12x10_KHR;case fi.ASTC_RGBA_12X12:return t5.COMPRESSED_RGBA_ASTC_12x12_KHR;case fi.ASTC_SRGBA_4X4:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case fi.ASTC_SRGBA_5X4:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case fi.ASTC_SRGBA_5X5:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case fi.ASTC_SRGBA_6X5:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case fi.ASTC_SRGBA_6X6:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case fi.ASTC_SRGBA_8X5:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case fi.ASTC_SRGBA_8X6:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case fi.ASTC_SRGBA_8X8:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case fi.ASTC_SRGBA_10X5:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case fi.ASTC_SRGBA_10X6:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case fi.ASTC_SRGBA_10X8:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case fi.ASTC_SRGBA_10X10:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case fi.ASTC_SRGBA_12X10:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case fi.ASTC_SRGBA_12X12:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,n),e.glType=i5(e.format,n);var i=e.width,r=e.height;switch(e.type){case yi.TEX2D:if(e.glTarget=n.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&O(9100,o,t.capabilities.maxTextureSize),!t.extensions.WEBGL_depth_texture&&Jr[e.format].hasDepth)e.glInternalFmt=function(t,e){switch(t){case fi.R5G6B5:return e.RGB565;case fi.RGB5A1:return e.RGB5_A1;case fi.RGBA4:return e.RGBA4;case fi.RGBA16F:return t5.RGBA16F_EXT;case fi.RGBA32F:return t5.RGBA32F_EXT;case fi.SRGB8_A8:return t5.SRGB8_ALPHA8_EXT;case fi.DEPTH:return e.DEPTH_COMPONENT16;case fi.DEPTH_STENCIL:return e.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,n),e.glRenderbuffer=n.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r));else if(e.glTexture=n.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=ro(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;case yi.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>t.capabilities.maxCubeMapTextureSize&&O(9100,h,t.capabilities.maxTextureSize),e.glTexture=n.createTexture(),e.size>0){var f=t.stateCache.glTexUnits[t.stateCache.texUnit];if(f.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),f.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var p=0;p<6;++p){i=e.width,r=e.height;for(var d=0;d<e.mipLevel;++d){var _=ro(e.format,i,r,1),m=new Uint8Array(_);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+p,d,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yi.TEX2D,e.glTarget=n.TEXTURE_2D}}(n5.instance,this._gpuTexture),n5.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(function(t,e){var n=t.gl;if(e.glTexture){var i=t.stateCache.glTexUnits,r=t.stateCache.texUnit;n.deleteTexture(e.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===e.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(e.glTarget,null),i[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;n.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}(n5.instance,this._gpuTexture),n5.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(t,e){var n=this._size;this._width=t,this._height=e,this._size=oo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var n=t.gl,i=e.width,r=e.height;switch(e.type){case yi.TEX2D:e.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&O(9100,o,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r);else if(e.glTexture){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=ro(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case yi.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>t.capabilities.maxCubeMapTextureSize&&O(9100,h,t.capabilities.maxTextureSize);var f=t.stateCache.glTexUnits[t.stateCache.texUnit];if(f.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),f.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var p=0;p<6;++p){i=e.width,r=e.height;for(var d=0;d<e.mipLevel;++d){var _=ro(e.format,i,r,1),m=new Uint8Array(_);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+p,d,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yi.TEX2D,e.glTarget=n.TEXTURE_2D}}}(n5.instance,this._gpuTexture),n5.instance.memoryStatus.textureSize-=n,n5.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(t){var e=new mr;e.format=t.format,e.usage=Jr[t.format].hasDepth?xi.DEPTH_STENCIL_ATTACHMENT:xi.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},Z(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(Oo),Y5="webglcontextlost";function K5(t,e){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=t.getExtension(n[i]+e);if(r)return r}return null}function Q5(t){var e={EXT_texture_filter_anisotropic:K5(t,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:K5(t,"EXT_blend_minmax"),EXT_frag_depth:K5(t,"EXT_frag_depth"),EXT_shader_texture_lod:K5(t,"EXT_shader_texture_lod"),EXT_sRGB:K5(t,"EXT_sRGB"),OES_vertex_array_object:K5(t,"OES_vertex_array_object"),EXT_color_buffer_half_float:K5(t,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:K5(t,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:K5(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:K5(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:K5(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:K5(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:K5(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:K5(t,"WEBGL_debug_shaders"),WEBGL_draw_buffers:K5(t,"WEBGL_draw_buffers"),WEBGL_lose_context:K5(t,"WEBGL_lose_context"),WEBGL_depth_texture:K5(t,"WEBGL_depth_texture"),OES_texture_half_float:K5(t,"OES_texture_half_float"),OES_texture_half_float_linear:K5(t,"OES_texture_half_float_linear"),OES_texture_float:K5(t,"OES_texture_float"),OES_texture_float_linear:K5(t,"OES_texture_float_linear"),OES_standard_derivatives:K5(t,"OES_standard_derivatives"),OES_element_index_uint:K5(t,"OES_element_index_uint"),ANGLE_instanced_arrays:K5(t,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:K5(t,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(t){return!!t},useVAO:!1};return _u.os===au.IOS&&14===_u.osMainVersion&&_u.isBrowser||(e.WEBGL_compressed_texture_astc=K5(t,"WEBGL_compressed_texture_astc")),_u.os!==au.ANDROID&&_u.os!==au.IOS&&(e.WEBGL_multi_draw=K5(t,"WEBGL_multi_draw")),_u.browserType===iu.UC&&(e.ANGLE_instanced_arrays=null),_u.os===au.IOS&&_u.osMainVersion<=10&&(e.destroyShadersImmediately=!1),e.OES_vertex_array_object&&(e.useVAO=!0),e}var Z5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).stateCache=new q5,e.cmdAllocator=new D5,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._canvas=t.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(Y5,this._onWebGLContextLost);var e=n5.instance.gl;this.stateCache.initialize(n5.instance.capabilities.maxTextureUnits,n5.instance.capabilities.maxVertexAttributes),this._extensions=Q5(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var n=fi.RGBA8,i=fi.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?i=fi.DEPTH_STENCIL:r&&(i=fi.DEPTH),this._colorTexture=new X5,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this._depthStencilTexture=new X5,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=n5.instance.createTexture(new mr(yi.TEX2D,xi.SAMPLED,fi.RGBA8,2,2,Si.GEN_MIPMAP)),this.nullTexCube=n5.instance.createTexture(new mr(yi.CUBE,xi.SAMPLED,fi.RGBA8,2,2,Si.GEN_MIPMAP,6));var a=new or;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),n5.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,n5.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(Y5,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(b("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},n._onWebGLContextLost=function(t){M(11e3),S(t)},Z(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(po),J5=t("WebGLDevice",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._swapchain=null,e._context=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){n5.setInstance(this),this._gfxAPI=li.WEBGL,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var n={alpha:ue.ENABLE_TRANSPARENT_CANVAS,antialias:ue.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl",n)}catch(t){return null}return e}(fo.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new jr(Wi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Wr(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var n=e.getSupportedExtensions(),i="";if(n)for(var r,o=st(n);!(r=o()).done;)i+=r.value+" ";var a=Q5(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[hi.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[hi.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[hi.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[hi.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[hi.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[hi.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[hi.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[hi.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[hi.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[hi.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[hi.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[hi.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[hi.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[hi.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[hi.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[hi.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[hi.FORMAT_ASTC]=!0,c+="astc "),b("WebGL device initialized."),b("RENDERER: "+this._renderer),b("VENDOR: "+this._vendor),b("VERSION: "+s),b("COMPRESSED_FORMAT: "+c),b("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},n.createCommandBuffer=function(t){var e=new(t.type===qi.PRIMARY?U5:O5);return e.initialize(t),e},n.createSwapchain=function(t){var e=new Z5;return this._swapchain=e,e.initialize(t),e},n.createBuffer=function(t){var e=new I5;return e.initialize(t),e},n.createTexture=function(t){var e=new X5;return e.initialize(t),e},n.createDescriptorSet=function(t){var e=new e5;return e.initialize(t),e},n.createShader=function(t){var e=new j5;return e.initialize(t),e},n.createInputAssembler=function(t){var e=new L5;return e.initialize(t),e},n.createRenderPass=function(t){var e=new H5;return e.initialize(t),e},n.createFramebuffer=function(t){var e=new N5;return e.initialize(t),e},n.createDescriptorSetLayout=function(t){var e=new B5;return e.initialize(t),e},n.createPipelineLayout=function(t){var e=new F5;return e.initialize(t),e},n.createPipelineState=function(t){var e=new k5;return e.initialize(t),e},n.createQueue=function(t){var e=new G5;return e.initialize(t),e},n.getSampler=function(t){var e=Mo.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new W5(t,e)),this._samplers.get(e)},n.getGlobalBarrier=function(t){var e=No.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new No(t,e)),this._globalBarriers.get(e)},n.getTextureBarrier=function(t){var e=Lo.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Lo(t,e)),this._textureBarriers.get(e)},n.copyBuffersToTexture=function(t,e,n){R5(this,t,e.gpuTexture,n)},n.copyTextureToBuffers=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,f.texSubres.mipLevel),s=f.texOffset.x,c=f.texOffset.y,l=f.texExtent.width,u=f.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,n)},n.copyTexImagesToTexture=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],f=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<f;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Si.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)},Z(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(fo));u.WebGLDevice=J5;var $5,t8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSet=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,n=e.bindings,i=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)t[e].type&$r?this._buffers[e]&&(t[e].gpuBuffer=this._buffers[e].gpuBuffer):t[e].type&to&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},Z(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(xo);!function(t){t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}($5||($5={}));var e8=function(){function t(){}return t.setInstance=function(e){t._instance=e},Z(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();e8._instance=null;var n8=[10497,33648,33071,33071],i8=new Float32Array(4);function r8(t,e){switch(t){case fi.R8:return e.UNSIGNED_BYTE;case fi.R8SN:return e.BYTE;case fi.R8UI:return e.UNSIGNED_BYTE;case fi.R8I:return e.BYTE;case fi.R16F:return e.HALF_FLOAT;case fi.R16UI:return e.UNSIGNED_SHORT;case fi.R16I:return e.SHORT;case fi.R32F:return e.FLOAT;case fi.R32UI:return e.UNSIGNED_INT;case fi.R32I:return e.INT;case fi.RG8:return e.UNSIGNED_BYTE;case fi.RG8SN:return e.BYTE;case fi.RG8UI:return e.UNSIGNED_BYTE;case fi.RG8I:return e.BYTE;case fi.RG16F:return e.HALF_FLOAT;case fi.RG16UI:return e.UNSIGNED_SHORT;case fi.RG16I:return e.SHORT;case fi.RG32F:return e.FLOAT;case fi.RG32UI:return e.UNSIGNED_INT;case fi.RG32I:return e.INT;case fi.RGB8:case fi.SRGB8:return e.UNSIGNED_BYTE;case fi.RGB8SN:return e.BYTE;case fi.RGB8UI:return e.UNSIGNED_BYTE;case fi.RGB8I:return e.BYTE;case fi.RGB16F:return e.HALF_FLOAT;case fi.RGB16UI:return e.UNSIGNED_SHORT;case fi.RGB16I:return e.SHORT;case fi.RGB32F:return e.FLOAT;case fi.RGB32UI:return e.UNSIGNED_INT;case fi.RGB32I:return e.INT;case fi.BGRA8:case fi.RGBA8:case fi.SRGB8_A8:return e.UNSIGNED_BYTE;case fi.RGBA8SN:return e.BYTE;case fi.RGBA8UI:return e.UNSIGNED_BYTE;case fi.RGBA8I:return e.BYTE;case fi.RGBA16F:return e.HALF_FLOAT;case fi.RGBA16UI:return e.UNSIGNED_SHORT;case fi.RGBA16I:return e.SHORT;case fi.RGBA32F:return e.FLOAT;case fi.RGBA32UI:return e.UNSIGNED_INT;case fi.RGBA32I:return e.INT;case fi.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case fi.R11G11B10F:return e.UNSIGNED_INT_10F_11F_11F_REV;case fi.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case fi.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case fi.RGB10A2:case fi.RGB10A2UI:return e.UNSIGNED_INT_2_10_10_10_REV;case fi.RGB9E5:case fi.DEPTH:return e.FLOAT;case fi.DEPTH_STENCIL:return e.UNSIGNED_INT_24_8;case fi.BC1:case fi.BC1_SRGB:case fi.BC2:case fi.BC2_SRGB:case fi.BC3:case fi.BC3_SRGB:case fi.BC4:return e.UNSIGNED_BYTE;case fi.BC4_SNORM:return e.BYTE;case fi.BC5:return e.UNSIGNED_BYTE;case fi.BC5_SNORM:return e.BYTE;case fi.BC6H_SF16:case fi.BC6H_UF16:return e.FLOAT;case fi.BC7:case fi.BC7_SRGB:case fi.ETC_RGB8:case fi.ETC2_RGB8:case fi.ETC2_SRGB8:case fi.ETC2_RGB8_A1:case fi.ETC2_SRGB8_A1:case fi.EAC_R11:return e.UNSIGNED_BYTE;case fi.EAC_R11SN:return e.BYTE;case fi.EAC_RG11:return e.UNSIGNED_BYTE;case fi.EAC_RG11SN:return e.BYTE;case fi.PVRTC_RGB2:case fi.PVRTC_RGBA2:case fi.PVRTC_RGB4:case fi.PVRTC_RGBA4:case fi.PVRTC2_2BPP:case fi.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case fi.ASTC_RGBA_4X4:case fi.ASTC_RGBA_5X4:case fi.ASTC_RGBA_5X5:case fi.ASTC_RGBA_6X5:case fi.ASTC_RGBA_6X6:case fi.ASTC_RGBA_8X5:case fi.ASTC_RGBA_8X6:case fi.ASTC_RGBA_8X8:case fi.ASTC_RGBA_10X5:case fi.ASTC_RGBA_10X6:case fi.ASTC_RGBA_10X8:case fi.ASTC_RGBA_10X10:case fi.ASTC_RGBA_12X10:case fi.ASTC_RGBA_12X12:case fi.ASTC_SRGBA_4X4:case fi.ASTC_SRGBA_5X4:case fi.ASTC_SRGBA_5X5:case fi.ASTC_SRGBA_6X5:case fi.ASTC_SRGBA_6X6:case fi.ASTC_SRGBA_8X5:case fi.ASTC_SRGBA_8X6:case fi.ASTC_SRGBA_8X8:case fi.ASTC_SRGBA_10X5:case fi.ASTC_SRGBA_10X6:case fi.ASTC_SRGBA_10X8:case fi.ASTC_SRGBA_10X10:case fi.ASTC_SRGBA_12X10:case fi.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function o8(t,e){switch(t){case di.BOOL:return e.BOOL;case di.BOOL2:return e.BOOL_VEC2;case di.BOOL3:return e.BOOL_VEC3;case di.BOOL4:return e.BOOL_VEC4;case di.INT:return e.INT;case di.INT2:return e.INT_VEC2;case di.INT3:return e.INT_VEC3;case di.INT4:return e.INT_VEC4;case di.UINT:return e.UNSIGNED_INT;case di.FLOAT:return e.FLOAT;case di.FLOAT2:return e.FLOAT_VEC2;case di.FLOAT3:return e.FLOAT_VEC3;case di.FLOAT4:return e.FLOAT_VEC4;case di.MAT2:return e.FLOAT_MAT2;case di.MAT2X3:return e.FLOAT_MAT2x3;case di.MAT2X4:return e.FLOAT_MAT2x4;case di.MAT3X2:return e.FLOAT_MAT3x2;case di.MAT3:return e.FLOAT_MAT3;case di.MAT3X4:return e.FLOAT_MAT3x4;case di.MAT4X2:return e.FLOAT_MAT4x2;case di.MAT4X3:return e.FLOAT_MAT4x3;case di.MAT4:return e.FLOAT_MAT4;case di.SAMPLER2D:return e.SAMPLER_2D;case di.SAMPLER2D_ARRAY:return e.SAMPLER_2D_ARRAY;case di.SAMPLER3D:return e.SAMPLER_3D;case di.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),di.UNKNOWN}}function a8(t,e){switch(t){case e.BOOL:return di.BOOL;case e.BOOL_VEC2:return di.BOOL2;case e.BOOL_VEC3:return di.BOOL3;case e.BOOL_VEC4:return di.BOOL4;case e.INT:return di.INT;case e.INT_VEC2:return di.INT2;case e.INT_VEC3:return di.INT3;case e.INT_VEC4:return di.INT4;case e.UNSIGNED_INT:return di.UINT;case e.UNSIGNED_INT_VEC2:return di.UINT2;case e.UNSIGNED_INT_VEC3:return di.UINT3;case e.UNSIGNED_INT_VEC4:return di.UINT4;case e.FLOAT:return di.FLOAT;case e.FLOAT_VEC2:return di.FLOAT2;case e.FLOAT_VEC3:return di.FLOAT3;case e.FLOAT_VEC4:return di.FLOAT4;case e.FLOAT_MAT2:return di.MAT2;case e.FLOAT_MAT2x3:return di.MAT2X3;case e.FLOAT_MAT2x4:return di.MAT2X4;case e.FLOAT_MAT3x2:return di.MAT3X2;case e.FLOAT_MAT3:return di.MAT3;case e.FLOAT_MAT3x4:return di.MAT3X4;case e.FLOAT_MAT4x2:return di.MAT4X2;case e.FLOAT_MAT4x3:return di.MAT4X3;case e.FLOAT_MAT4:return di.MAT4;case e.SAMPLER_2D:return di.SAMPLER2D;case e.SAMPLER_2D_ARRAY:return di.SAMPLER2D_ARRAY;case e.SAMPLER_3D:return di.SAMPLER3D;case e.SAMPLER_CUBE:return di.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),di.UNKNOWN}}function s8(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:return 4;case e.UNSIGNED_INT_VEC2:return 8;case e.UNSIGNED_INT_VEC3:return 12;case e.UNSIGNED_INT_VEC4:return 16;case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT2x3:return 24;case e.FLOAT_MAT2x4:return 32;case e.FLOAT_MAT3x2:return 24;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT3x4:return 48;case e.FLOAT_MAT4x2:return 32;case e.FLOAT_MAT4x3:return 48;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_ARRAY_SHADOW:case e.SAMPLER_3D:case e.SAMPLER_CUBE:case e.INT_SAMPLER_2D:case e.INT_SAMPLER_2D_ARRAY:case e.INT_SAMPLER_3D:case e.INT_SAMPLER_CUBE:case e.UNSIGNED_INT_SAMPLER_2D:case e.UNSIGNED_INT_SAMPLER_2D_ARRAY:case e.UNSIGNED_INT_SAMPLER_3D:case e.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function c8(t,e){switch(t){case e.FLOAT_MAT2:case e.FLOAT_MAT2x3:case e.FLOAT_MAT2x4:return 2;case e.FLOAT_MAT3x2:case e.FLOAT_MAT3:case e.FLOAT_MAT3x4:return 3;case e.FLOAT_MAT4x2:case e.FLOAT_MAT4x3:case e.FLOAT_MAT4:return 4;default:return 1}}var l8,u8=[512,513,514,515,516,517,518,519],h8=[0,7680,7681,7682,7683,5386,34055,34056],f8=[32774,32778,32779,32775,32776],p8=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(l8||(l8={}));var d8=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},_8=function(t){function e(){var e;return(e=t.call(this,l8.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new $i,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return $(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(d8),m8=function(t){function e(){var e;return(e=t.call(this,l8.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new Qr,e}return $(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},e}(d8),v8=function(t){function e(){var e;return(e=t.call(this,l8.DRAW)||this).drawInfo=new pr,e}return $(e,t),e.prototype.clear=function(){},e}(d8),g8=function(t){function e(){var e;return(e=t.call(this,l8.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return $(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(d8),y8=function(t){function e(){var e;return(e=t.call(this,l8.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return $(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(d8),x8=function(){function t(){this.cmds=new ql(1),this.beginRenderPassCmds=new ql(1),this.bindStatesCmds=new ql(1),this.drawCmds=new ql(1),this.updateBufferCmds=new ql(1),this.copyBufferToTextureCmds=new ql(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function S8(t,e,n,i,r){if(e.usage&_i.INDIRECT){e.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),b8.gpuInputAssembler=null,l.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),l.glArrayBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),b8.gpuInputAssembler=null,l.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),l.glElementArrayBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==e.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,e.glBuffer),l.glUniformBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function T8(t,e){var n=t.gl;e.glInternalFmt=function(t,e){switch(t){case fi.A8:return e.ALPHA;case fi.L8:return e.LUMINANCE;case fi.LA8:return e.LUMINANCE_ALPHA;case fi.R8:return e.R8;case fi.R8SN:return e.R8_SNORM;case fi.R8UI:return e.R8UI;case fi.R8I:return e.R8I;case fi.RG8:return e.RG8;case fi.RG8SN:return e.RG8_SNORM;case fi.RG8UI:return e.RG8UI;case fi.RG8I:return e.RG8I;case fi.RGB8:return e.RGB8;case fi.RGB8SN:return e.RGB8_SNORM;case fi.RGB8UI:return e.RGB8UI;case fi.RGB8I:return e.RGB8I;case fi.BGRA8:case fi.RGBA8:return e.RGBA8;case fi.RGBA8SN:return e.RGBA8_SNORM;case fi.RGBA8UI:return e.RGBA8UI;case fi.RGBA8I:return e.RGBA8I;case fi.R16I:return e.R16I;case fi.R16UI:return e.R16UI;case fi.R16F:return e.R16F;case fi.RG16I:return e.RG16I;case fi.RG16UI:return e.RG16UI;case fi.RG16F:return e.RG16F;case fi.RGB16I:return e.RGB16I;case fi.RGB16UI:return e.RGB16UI;case fi.RGB16F:return e.RGB16F;case fi.RGBA16I:return e.RGBA16I;case fi.RGBA16UI:return e.RGBA16UI;case fi.RGBA16F:return e.RGBA16F;case fi.R32I:return e.R32I;case fi.R32UI:return e.R32UI;case fi.R32F:return e.R32F;case fi.RG32I:return e.RG32I;case fi.RG32UI:return e.RG32UI;case fi.RG32F:return e.RG32F;case fi.RGB32I:return e.RGB32I;case fi.RGB32UI:return e.RGB32UI;case fi.RGB32F:return e.RGB32F;case fi.RGBA32I:return e.RGBA32I;case fi.RGBA32UI:return e.RGBA32UI;case fi.RGBA32F:return e.RGBA32F;case fi.R5G6B5:return e.RGB565;case fi.RGB5A1:return e.RGB5_A1;case fi.RGBA4:return e.RGBA4;case fi.SRGB8:return e.SRGB8;case fi.SRGB8_A8:return e.SRGB8_ALPHA8;case fi.RGB10A2:return e.RGB10_A2;case fi.RGB10A2UI:return e.RGB10_A2UI;case fi.R11G11B10F:return e.R11F_G11F_B10F;case fi.DEPTH:return e.DEPTH_COMPONENT32F;case fi.DEPTH_STENCIL:return e.DEPTH24_STENCIL8;case fi.BC1:return $5.COMPRESSED_RGB_S3TC_DXT1_EXT;case fi.BC1_ALPHA:return $5.COMPRESSED_RGBA_S3TC_DXT1_EXT;case fi.BC1_SRGB:return $5.COMPRESSED_SRGB_S3TC_DXT1_EXT;case fi.BC1_SRGB_ALPHA:return $5.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case fi.BC2:return $5.COMPRESSED_RGBA_S3TC_DXT3_EXT;case fi.BC2_SRGB:return $5.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case fi.BC3:return $5.COMPRESSED_RGBA_S3TC_DXT5_EXT;case fi.BC3_SRGB:return $5.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case fi.ETC_RGB8:return $5.COMPRESSED_RGB_ETC1_WEBGL;case fi.ETC2_RGB8:return $5.COMPRESSED_RGB8_ETC2;case fi.ETC2_SRGB8:return $5.COMPRESSED_SRGB8_ETC2;case fi.ETC2_RGB8_A1:return $5.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fi.ETC2_SRGB8_A1:return $5.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fi.ETC2_RGBA8:return $5.COMPRESSED_RGBA8_ETC2_EAC;case fi.ETC2_SRGB8_A8:return $5.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case fi.EAC_R11:return $5.COMPRESSED_R11_EAC;case fi.EAC_R11SN:return $5.COMPRESSED_SIGNED_R11_EAC;case fi.EAC_RG11:return $5.COMPRESSED_RG11_EAC;case fi.EAC_RG11SN:return $5.COMPRESSED_SIGNED_RG11_EAC;case fi.PVRTC_RGB2:return $5.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case fi.PVRTC_RGBA2:return $5.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case fi.PVRTC_RGB4:return $5.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case fi.PVRTC_RGBA4:return $5.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case fi.ASTC_RGBA_4X4:return $5.COMPRESSED_RGBA_ASTC_4x4_KHR;case fi.ASTC_RGBA_5X4:return $5.COMPRESSED_RGBA_ASTC_5x4_KHR;case fi.ASTC_RGBA_5X5:return $5.COMPRESSED_RGBA_ASTC_5x5_KHR;case fi.ASTC_RGBA_6X5:return $5.COMPRESSED_RGBA_ASTC_6x5_KHR;case fi.ASTC_RGBA_6X6:return $5.COMPRESSED_RGBA_ASTC_6x6_KHR;case fi.ASTC_RGBA_8X5:return $5.COMPRESSED_RGBA_ASTC_8x5_KHR;case fi.ASTC_RGBA_8X6:return $5.COMPRESSED_RGBA_ASTC_8x6_KHR;case fi.ASTC_RGBA_8X8:return $5.COMPRESSED_RGBA_ASTC_8x8_KHR;case fi.ASTC_RGBA_10X5:return $5.COMPRESSED_RGBA_ASTC_10x5_KHR;case fi.ASTC_RGBA_10X6:return $5.COMPRESSED_RGBA_ASTC_10x6_KHR;case fi.ASTC_RGBA_10X8:return $5.COMPRESSED_RGBA_ASTC_10x8_KHR;case fi.ASTC_RGBA_10X10:return $5.COMPRESSED_RGBA_ASTC_10x10_KHR;case fi.ASTC_RGBA_12X10:return $5.COMPRESSED_RGBA_ASTC_12x10_KHR;case fi.ASTC_RGBA_12X12:return $5.COMPRESSED_RGBA_ASTC_12x12_KHR;case fi.ASTC_SRGBA_4X4:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case fi.ASTC_SRGBA_5X4:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case fi.ASTC_SRGBA_5X5:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case fi.ASTC_SRGBA_6X5:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case fi.ASTC_SRGBA_6X6:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case fi.ASTC_SRGBA_8X5:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case fi.ASTC_SRGBA_8X6:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case fi.ASTC_SRGBA_8X8:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case fi.ASTC_SRGBA_10X5:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case fi.ASTC_SRGBA_10X6:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case fi.ASTC_SRGBA_10X8:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case fi.ASTC_SRGBA_10X10:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case fi.ASTC_SRGBA_12X10:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case fi.ASTC_SRGBA_12X12:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,n),e.glFormat=function(t,e){switch(t){case fi.A8:return e.ALPHA;case fi.L8:return e.LUMINANCE;case fi.LA8:return e.LUMINANCE_ALPHA;case fi.R8:case fi.R8SN:return e.RED;case fi.R8UI:case fi.R8I:return e.RED;case fi.RG8:case fi.RG8SN:case fi.RG8UI:case fi.RG8I:return e.RG;case fi.RGB8:case fi.RGB8SN:case fi.RGB8UI:case fi.RGB8I:return e.RGB;case fi.BGRA8:case fi.RGBA8:case fi.RGBA8SN:case fi.RGBA8UI:case fi.RGBA8I:return e.RGBA;case fi.R16UI:case fi.R16I:case fi.R16F:return e.RED;case fi.RG16UI:case fi.RG16I:case fi.RG16F:return e.RG;case fi.RGB16UI:case fi.RGB16I:case fi.RGB16F:return e.RGB;case fi.RGBA16UI:case fi.RGBA16I:case fi.RGBA16F:return e.RGBA;case fi.R32UI:case fi.R32I:case fi.R32F:return e.RED;case fi.RG32UI:case fi.RG32I:case fi.RG32F:return e.RG;case fi.RGB32UI:case fi.RGB32I:case fi.RGB32F:return e.RGB;case fi.RGBA32UI:case fi.RGBA32I:case fi.RGBA32F:case fi.RGB10A2:return e.RGBA;case fi.R11G11B10F:case fi.R5G6B5:return e.RGB;case fi.RGB5A1:case fi.RGBA4:return e.RGBA;case fi.SRGB8:return e.RGB;case fi.SRGB8_A8:return e.RGBA;case fi.DEPTH:return e.DEPTH_COMPONENT;case fi.DEPTH_STENCIL:return e.DEPTH_STENCIL;case fi.BC1:return $5.COMPRESSED_RGB_S3TC_DXT1_EXT;case fi.BC1_ALPHA:return $5.COMPRESSED_RGBA_S3TC_DXT1_EXT;case fi.BC1_SRGB:return $5.COMPRESSED_SRGB_S3TC_DXT1_EXT;case fi.BC1_SRGB_ALPHA:return $5.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case fi.BC2:return $5.COMPRESSED_RGBA_S3TC_DXT3_EXT;case fi.BC2_SRGB:return $5.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case fi.BC3:return $5.COMPRESSED_RGBA_S3TC_DXT5_EXT;case fi.BC3_SRGB:return $5.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case fi.ETC_RGB8:return $5.COMPRESSED_RGB_ETC1_WEBGL;case fi.ETC2_RGB8:return $5.COMPRESSED_RGB8_ETC2;case fi.ETC2_SRGB8:return $5.COMPRESSED_SRGB8_ETC2;case fi.ETC2_RGB8_A1:return $5.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fi.ETC2_SRGB8_A1:return $5.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fi.ETC2_RGBA8:return $5.COMPRESSED_RGBA8_ETC2_EAC;case fi.ETC2_SRGB8_A8:return $5.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case fi.EAC_R11:return $5.COMPRESSED_R11_EAC;case fi.EAC_R11SN:return $5.COMPRESSED_SIGNED_R11_EAC;case fi.EAC_RG11:return $5.COMPRESSED_RG11_EAC;case fi.EAC_RG11SN:return $5.COMPRESSED_SIGNED_RG11_EAC;case fi.PVRTC_RGB2:return $5.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case fi.PVRTC_RGBA2:return $5.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case fi.PVRTC_RGB4:return $5.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case fi.PVRTC_RGBA4:return $5.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case fi.ASTC_RGBA_4X4:return $5.COMPRESSED_RGBA_ASTC_4x4_KHR;case fi.ASTC_RGBA_5X4:return $5.COMPRESSED_RGBA_ASTC_5x4_KHR;case fi.ASTC_RGBA_5X5:return $5.COMPRESSED_RGBA_ASTC_5x5_KHR;case fi.ASTC_RGBA_6X5:return $5.COMPRESSED_RGBA_ASTC_6x5_KHR;case fi.ASTC_RGBA_6X6:return $5.COMPRESSED_RGBA_ASTC_6x6_KHR;case fi.ASTC_RGBA_8X5:return $5.COMPRESSED_RGBA_ASTC_8x5_KHR;case fi.ASTC_RGBA_8X6:return $5.COMPRESSED_RGBA_ASTC_8x6_KHR;case fi.ASTC_RGBA_8X8:return $5.COMPRESSED_RGBA_ASTC_8x8_KHR;case fi.ASTC_RGBA_10X5:return $5.COMPRESSED_RGBA_ASTC_10x5_KHR;case fi.ASTC_RGBA_10X6:return $5.COMPRESSED_RGBA_ASTC_10x6_KHR;case fi.ASTC_RGBA_10X8:return $5.COMPRESSED_RGBA_ASTC_10x8_KHR;case fi.ASTC_RGBA_10X10:return $5.COMPRESSED_RGBA_ASTC_10x10_KHR;case fi.ASTC_RGBA_12X10:return $5.COMPRESSED_RGBA_ASTC_12x10_KHR;case fi.ASTC_RGBA_12X12:return $5.COMPRESSED_RGBA_ASTC_12x12_KHR;case fi.ASTC_SRGBA_4X4:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case fi.ASTC_SRGBA_5X4:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case fi.ASTC_SRGBA_5X5:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case fi.ASTC_SRGBA_6X5:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case fi.ASTC_SRGBA_6X6:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case fi.ASTC_SRGBA_8X5:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case fi.ASTC_SRGBA_8X6:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case fi.ASTC_SRGBA_8X8:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case fi.ASTC_SRGBA_10X5:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case fi.ASTC_SRGBA_10X6:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case fi.ASTC_SRGBA_10X8:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case fi.ASTC_SRGBA_10X10:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case fi.ASTC_SRGBA_12X10:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case fi.ASTC_SRGBA_12X12:return $5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,n),e.glType=r8(e.format,n);var i=e.width,r=e.height;switch(e.type){case yi.TEX2D:if(e.glTarget=n.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&O(9100,o,t.capabilities.maxTextureSize),e.samples===Ti.ONE){if(e.glTexture=n.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=ro(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,e.mipLevel,e.glInternalFmt,i,r)}}else e.glRenderbuffer=n.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break;case yi.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>t.capabilities.maxCubeMapTextureSize&&O(9100,u,t.capabilities.maxTextureSize),e.glTexture=n.createTexture(),e.size>0){var h=t.stateCache.glTexUnits[t.stateCache.texUnit];if(h.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),h.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var f=0;f<e.mipLevel;++f){for(var p=ro(e.format,i,r,1),d=new Uint8Array(p),_=0;_<6;++_)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,e.glInternalFmt,i,r,0,d);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,e.mipLevel,e.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yi.TEX2D,e.glTarget=n.TEXTURE_2D}}function E8(t,e){var n=t.gl;if(e.glTexture){var i=t.stateCache.glTexUnits,r=t.stateCache.texUnit;n.deleteTexture(e.glTexture);for(var o=0;o<i.length;++o)i[o].glTexture===e.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(e.glTarget,null),i[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;n.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}var b8={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function C8(t,e,n,i,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),b8.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=e.colorAttachments[u];if(h.format!==fi.UNKNOWN)switch(h.loadOp){case Di.LOAD:break;case Di.CLEAR:if(c.bs.targets[0].blendColorMask!==Ii.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)i8[0]=r[u].x,i8[1]=r[u].y,i8[2]=r[u].z,i8[3]=r[u].w,s.clearBufferfv(s.COLOR,u,i8);else{var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT}break;case Di.DISCARD:b8.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==fi.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Di.LOAD:break;case Di.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Di.DISCARD:b8.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(Jr[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Di.LOAD:break;case Di.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Di.DISCARD:b8.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&b8.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,b8.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var p=c.bs.targets[0].blendColorMask;if(p!==Ii.ALL){var d=(p&Ii.R)!==Ii.NONE,_=(p&Ii.G)!==Ii.NONE,m=(p&Ii.B)!==Ii.NONE,v=(p&Ii.A)!==Ii.NONE;s.colorMask(d,_,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function A8(t,e,n,i,r,o){var a=t.gl,s=t.stateCache,c=e&&e.gpuShader,l=!1;if(e&&b8.gpuPipelineState!==e){if(b8.gpuPipelineState=e,b8.glPrimitive=e.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=e.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case Ui.NONE:a.disable(a.CULL_FACE);break;case Ui.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case Ui.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}t.stateCache.rs.cullMode=h.cullMode}var f=h.isFrontFaceCCW;t.stateCache.rs.isFrontFaceCCW!==f&&(a.frontFace(f?a.CCW:a.CW),t.stateCache.rs.isFrontFaceCCW=f),t.stateCache.rs.depthBias===h.depthBias&&t.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),t.stateCache.rs.depthBias=h.depthBias,t.stateCache.rs.depthBiasSlop=h.depthBiasSlop),t.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),t.stateCache.rs.lineWidth=h.lineWidth)}var p=e.dss;p&&(s.dss.depthTest!==p.depthTest&&(p.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=p.depthTest),s.dss.depthWrite!==p.depthWrite&&(a.depthMask(p.depthWrite),s.dss.depthWrite=p.depthWrite),s.dss.depthFunc!==p.depthFunc&&(a.depthFunc(u8[p.depthFunc]),s.dss.depthFunc=p.depthFunc),s.dss.stencilTestFront===p.stencilTestFront&&s.dss.stencilTestBack===p.stencilTestBack||(p.stencilTestFront||p.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=p.stencilTestFront,s.dss.stencilTestBack=p.stencilTestBack),s.dss.stencilFuncFront===p.stencilFuncFront&&s.dss.stencilRefFront===p.stencilRefFront&&s.dss.stencilReadMaskFront===p.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,u8[p.stencilFuncFront],p.stencilRefFront,p.stencilReadMaskFront),s.dss.stencilFuncFront=p.stencilFuncFront,s.dss.stencilRefFront=p.stencilRefFront,s.dss.stencilReadMaskFront=p.stencilReadMaskFront),s.dss.stencilFailOpFront===p.stencilFailOpFront&&s.dss.stencilZFailOpFront===p.stencilZFailOpFront&&s.dss.stencilPassOpFront===p.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,h8[p.stencilFailOpFront],h8[p.stencilZFailOpFront],h8[p.stencilPassOpFront]),s.dss.stencilFailOpFront=p.stencilFailOpFront,s.dss.stencilZFailOpFront=p.stencilZFailOpFront,s.dss.stencilPassOpFront=p.stencilPassOpFront),s.dss.stencilWriteMaskFront!==p.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,p.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=p.stencilWriteMaskFront),s.dss.stencilFuncBack===p.stencilFuncBack&&s.dss.stencilRefBack===p.stencilRefBack&&s.dss.stencilReadMaskBack===p.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,u8[p.stencilFuncBack],p.stencilRefBack,p.stencilReadMaskBack),s.dss.stencilFuncBack=p.stencilFuncBack,s.dss.stencilRefBack=p.stencilRefBack,s.dss.stencilReadMaskBack=p.stencilReadMaskBack),s.dss.stencilFailOpBack===p.stencilFailOpBack&&s.dss.stencilZFailOpBack===p.stencilZFailOpBack&&s.dss.stencilPassOpBack===p.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,h8[p.stencilFailOpBack],h8[p.stencilZFailOpBack],h8[p.stencilPassOpBack]),s.dss.stencilFailOpBack=p.stencilFailOpBack,s.dss.stencilZFailOpBack=p.stencilZFailOpBack,s.dss.stencilPassOpBack=p.stencilPassOpBack),s.dss.stencilWriteMaskBack!==p.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,p.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=p.stencilWriteMaskBack));var d=e.bs;if(d){s.bs.isA2C!==d.isA2C&&(d.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=d.isA2C),s.bs.blendColor.x===d.blendColor.x&&s.bs.blendColor.y===d.blendColor.y&&s.bs.blendColor.z===d.blendColor.z&&s.bs.blendColor.w===d.blendColor.w||(a.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),s.bs.blendColor.x=d.blendColor.x,s.bs.blendColor.y=d.blendColor.y,s.bs.blendColor.z=d.blendColor.z,s.bs.blendColor.w=d.blendColor.w);var _=d.targets[0],m=s.bs.targets[0];m.blend!==_.blend&&(_.blend?a.enable(a.BLEND):a.disable(a.BLEND),m.blend=_.blend),m.blendEq===_.blendEq&&m.blendAlphaEq===_.blendAlphaEq||(a.blendEquationSeparate(f8[_.blendEq],f8[_.blendAlphaEq]),m.blendEq=_.blendEq,m.blendAlphaEq=_.blendAlphaEq),m.blendSrc===_.blendSrc&&m.blendDst===_.blendDst&&m.blendSrcAlpha===_.blendSrcAlpha&&m.blendDstAlpha===_.blendDstAlpha||(a.blendFuncSeparate(p8[_.blendSrc],p8[_.blendDst],p8[_.blendSrcAlpha],p8[_.blendDstAlpha]),m.blendSrc=_.blendSrc,m.blendDst=_.blendDst,m.blendSrcAlpha=_.blendSrcAlpha,m.blendDstAlpha=_.blendDstAlpha),m.blendColorMask!==_.blendColorMask&&(a.colorMask((_.blendColorMask&Ii.R)!==Ii.NONE,(_.blendColorMask&Ii.G)!==Ii.NONE,(_.blendColorMask&Ii.B)!==Ii.NONE,(_.blendColorMask&Ii.A)!==Ii.NONE),m.blendColorMask=_.blendColorMask)}}if(e&&e.gpuPipelineLayout&&c){for(var v=c.glBlocks.length,g=e.gpuPipelineLayout.dynamicOffsetIndices,y=0;y<v;y++){var x=c.glBlocks[y],S=i[x.set],E=S&&S.descriptorIndices[x.binding],b=E>=0&&S.gpuDescriptors[E];if(b&&b.gpuBuffer){var C=g[x.set],A=C&&C[x.binding],w=b.gpuBuffer.glOffset;A>=0&&(w+=r[A]),s.glBindUBOs[x.glBinding]===b.gpuBuffer.glBuffer&&s.glBindUBOOffsets[x.glBinding]===w||(w?a.bindBufferRange(a.UNIFORM_BUFFER,x.glBinding,b.gpuBuffer.glBuffer,w,b.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,x.glBinding,b.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[x.glBinding]=b.gpuBuffer.glBuffer,s.glBindUBOOffsets[x.glBinding]=w)}else T("Buffer binding '"+x.name+"' at set "+x.set+" binding "+x.binding+" is not bounded")}for(var R=c.glSamplerTextures.length,P=0;P<R;P++)for(var I=c.glSamplerTextures[P],M=i[I.set],D=M&&M.descriptorIndices[I.binding],O=D>=0&&M.gpuDescriptors[D],N=0;N<I.units.length;N++){var L=I.units[N],B=s.glTexUnits[L];if(O&&O.gpuTexture&&O.gpuSampler){if(O.gpuTexture&&O.gpuTexture.size>0){var F=O.gpuTexture;B.glTexture!==F.glTexture&&(s.texUnit!==L&&(a.activeTexture(a.TEXTURE0+L),s.texUnit=L),F.glTexture?a.bindTexture(F.glTarget,F.glTexture):a.bindTexture(F.glTarget,t.nullTex2D.gpuTexture.glTexture),B.glTexture=F.glTexture);var z=O.gpuSampler;s.glSamplerUnits[L]!==z.glSampler&&(a.bindSampler(L,z.glSampler),s.glSamplerUnits[L]=z.glSampler)}O=M.gpuDescriptors[++D]}else T("Sampler binding '"+I.name+"' at set "+I.set+" binding "+I.binding+" index "+N+" is not bounded")}}if(n&&c&&(l||b8.gpuInputAssembler!==n))if(b8.gpuInputAssembler=n,t.extensions.useVAO){var k=n.glVAOs.get(c.glProgram);if(!k){var U;k=a.createVertexArray(),n.glVAOs.set(c.glProgram,k),a.bindVertexArray(k),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var G=0;G<c.glInputs.length;G++){var H=c.glInputs[G];U=null;for(var V=0;V<n.glAttribs.length;V++){var W=n.glAttribs[V];if(W.name===H.name){U=W;break}}if(U){s.glArrayBuffer!==U.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,U.glBuffer),s.glArrayBuffer=U.glBuffer);for(var j=0;j<U.componentCount;++j){var q=H.glLoc+j,X=U.offset+U.size*j;a.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,a.vertexAttribPointer(q,U.count,U.glType,U.isNormalized,U.stride,X),a.vertexAttribDivisor(q,U.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Y.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==k&&(a.bindVertexArray(k),s.glVAO=k)}else{for(var K=0;K<t.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var Q=0;Q<c.glInputs.length;Q++){for(var Z=c.glInputs[Q],J=null,$=0;$<n.glAttribs.length;$++){var tt=n.glAttribs[$];if(tt.name===Z.name){J=tt;break}}if(J){s.glArrayBuffer!==J.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,J.glBuffer),s.glArrayBuffer=J.glBuffer);for(var et=0;et<J.componentCount;++et){var nt=Z.glLoc+et,it=J.offset+J.size*et;!s.glEnabledAttribLocs[nt]&&nt>=0&&(a.enableVertexAttribArray(nt),s.glEnabledAttribLocs[nt]=!0),s.glCurrentAttribLocs[nt]=!0,a.vertexAttribPointer(nt,J.count,J.glType,J.isNormalized,J.stride,it),a.vertexAttribDivisor(nt,J.isInstanced?1:0)}}}var rt=n.gpuIndexBuffer;rt&&s.glElementArrayBuffer!==rt.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,rt.glBuffer),s.glElementArrayBuffer=rt.glBuffer);for(var ot=0;ot<t.capabilities.maxVertexAttributes;++ot)s.glEnabledAttribLocs[ot]!==s.glCurrentAttribLocs[ot]&&(a.disableVertexAttribArray(ot),s.glEnabledAttribLocs[ot]=!1)}if(e&&e.dynamicStates.length)for(var at=e.dynamicStates.length,st=0;st<at;st++)switch(e.dynamicStates[st]){case Gi.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case Gi.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case Gi.BLEND_CONSTANTS:var ct=o.blendConstant;s.bs.blendColor.x===ct.x&&s.bs.blendColor.y===ct.y&&s.bs.blendColor.z===ct.z&&s.bs.blendColor.w===ct.w||(a.blendColor(ct.x,ct.y,ct.z,ct.w),s.bs.blendColor.copy(ct));break;case Gi.STENCIL_WRITE_MASK:var lt=o.stencilStatesFront,ut=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==lt.writeMask&&(a.stencilMaskSeparate(a.FRONT,lt.writeMask),s.dss.stencilWriteMaskFront=lt.writeMask),s.dss.stencilWriteMaskBack!==ut.writeMask&&(a.stencilMaskSeparate(a.BACK,ut.writeMask),s.dss.stencilWriteMaskBack=ut.writeMask);break;case Gi.STENCIL_COMPARE_MASK:var ht=o.stencilStatesFront,ft=o.stencilStatesBack;s.dss.stencilRefFront===ht.reference&&s.dss.stencilReadMaskFront===ht.compareMask||(a.stencilFuncSeparate(a.FRONT,u8[s.dss.stencilFuncFront],ht.reference,ht.compareMask),s.dss.stencilRefFront=ht.reference,s.dss.stencilReadMaskFront=ht.compareMask),s.dss.stencilRefBack===ft.reference&&s.dss.stencilReadMaskBack===ft.compareMask||(a.stencilFuncSeparate(a.BACK,u8[s.dss.stencilFuncBack],ft.reference,ft.compareMask),s.dss.stencilRefBack=ft.reference,s.dss.stencilReadMaskBack=ft.compareMask)}}function w8(t,e){var n=t.gl,i=b8.gpuInputAssembler,r=b8.glPrimitive,o=t.extensions.WEBGL_multi_draw;if(i){var a=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(o)s.instancedDraw?o.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):o.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(o)s.instancedDraw?o.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):o.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(e.instanceCount)if(a){if(e.indexCount>0){var h=e.firstIndex*a.stride;n.drawElementsInstanced(r,e.indexCount,i.glIndexType,h,e.instanceCount)}}else e.vertexCount>0&&n.drawArraysInstanced(r,e.firstVertex,e.vertexCount,e.instanceCount);else if(a){if(e.indexCount>0){var f=e.firstIndex*a.stride;n.drawElements(r,e.indexCount,i.glIndexType,f)}}else e.vertexCount>0&&n.drawArrays(r,e.firstVertex,e.vertexCount)}}var R8=new Array(l8.COUNT);function P8(t,e){R8.fill(0);for(var n=0;n<e.cmds.length;++n){var i=e.cmds.array[n],r=R8[i]++;switch(i){case l8.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];C8(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case l8.BIND_STATES:var a=e.bindStatesCmds.array[r];A8(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case l8.DRAW:w8(t,e.drawCmds.array[r].drawInfo);break;case l8.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];S8(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case l8.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];I8(t,c.buffers,c.gpuTexture,c.regions)}}}function I8(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=Jr[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];s=f.texExtent.width,c=f.texExtent.height;var p=e[a++];u?n.glInternalFmt!==$5.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,p):r.compressedTexImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,n.glInternalFmt,s,c,0,p):r.texSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,n.glType,p)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var _=i[d],m=_.texSubres.baseArrayLayer+_.texSubres.layerCount;for(l=_.texSubres.baseArrayLayer;l<m;++l){s=_.texExtent.width,c=_.texExtent.height;var v=e[a++];u?n.glInternalFmt!==$5.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Si.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var M8=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=a(t);var e=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=n,this.instances=i}},t}(),D8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuBuffer=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:e.gpuBuffer.indirects,glTarget:e.gpuBuffer.glTarget,glBuffer:e.gpuBuffer.glBuffer,glOffset:t.offset}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new M8,glTarget:0,glBuffer:null,glOffset:0},function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&gi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&_i.VERTEX){e.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),b8.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&_i.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),b8.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else if(e.usage&_i.UNIFORM){e.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&e.size>0&&(e.glBuffer=s,t.stateCache.glUniformBuffer!==e.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,e.glBuffer),t.stateCache.glUniformBuffer=e.glBuffer),n.bufferData(n.UNIFORM_BUFFER,e.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null)}else e.usage&_i.INDIRECT||e.usage&_i.TRANSFER_DST||e.usage&_i.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE}(e8.instance,this._gpuBuffer),e8.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(t,e){var n=t.gl,i=t.stateCache;if(e.glBuffer){switch(e.glTarget){case n.ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),t.stateCache.glVAO=null),b8.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),t.stateCache.glVAO=null),b8.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null}n.deleteBuffer(e.glBuffer),e.glBuffer=null}}(e8.instance,this._gpuBuffer),e8.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=t,t>0&&(function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&gi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&_i.VERTEX?(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),b8.gpuInputAssembler=null,i.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):e.usage&_i.INDEX?(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),b8.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&_i.UNIFORM?(t.stateCache.glUniformBuffer!==e.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,e.glBuffer),n.bufferData(n.UNIFORM_BUFFER,e.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(e.usage&_i.INDIRECT||e.usage&_i.TRANSFER_DST||e.usage&_i.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(e8.instance,this._gpuBuffer),e8.instance.memoryStatus.bufferSize-=e,e8.instance.memoryStatus.bufferSize+=t)))}},n.update=function(t,e){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==e?e:this._usage&_i.INDIRECT?0:t.byteLength,S8(e8.instance,this._gpuBuffer,t,0,n))},Z(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),e}(uo),O8=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new ql(e);for(var n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,n=this._frees;this._frees=new Array(e);for(var i=e-n.length,r=0;r<i;++r)this._frees[r]=new t;for(var o=i,a=0;o<e;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),N8=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new O8(_8,1),this.bindStatesCmdPool=new O8(m8,1),this.drawCmdPool=new O8(v8,1),this.updateBufferCmdPool=new O8(g8,1),this.copyBufferToTextureCmdPool=new O8(y8,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),L8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).cmdPackage=new x8,e._cmdAllocator=new N8,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUDescriptorSets=[],e._curGPUInputAssembler=null,e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new Qr,e._isStateInvalied=!1,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=e8.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<e;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(t,e,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(_8);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=n;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(l8.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},n.bindDescriptorSet=function(t,e,n){var i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},n.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},n.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},n.setDepthBias=function(t,e,n){var i=this._curDynamicStates;i.depthBiasConstant===t&&i.depthBiasClamp===e&&i.depthBiasSlope===n||(i.depthBiasConstant=t,i.depthBiasClamp=e,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},n.setDepthBound=function(t,e){var n=this._curDynamicStates;n.depthMinBounds===t&&n.depthMaxBounds===e||(n.depthMinBounds=t,n.depthMaxBounds=e,this._isStateInvalied=!0)},n.setStencilWriteMask=function(t,e){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;t&Hi.FRONT&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0),t&Hi.BACK&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0)},n.setStencilCompareMask=function(t,e,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Hi.FRONT&&(i.compareMask===n&&i.reference===e||(i.reference=e,i.compareMask=n,this._isStateInvalied=!0)),t&Hi.BACK&&(r.compareMask===n&&r.reference===e||(r.reference=e,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(t){if(this._type===qi.PRIMARY&&this._isInRenderPass||this._type===qi.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,n=this._cmdAllocator.drawCmdPool.alloc(v8);n.drawInfo.copy(e),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(l8.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(t,e,n){if(this._type===qi.PRIMARY&&!this._isInRenderPass||this._type===qi.SECONDARY){var i=t.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(g8),a=0;t.usage&_i.INDIRECT||(a=void 0!==n?n:e.byteLength),r=e,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(l8.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(t,e,n){if(this._type===qi.PRIMARY&&!this._isInRenderPass||this._type===qi.SECONDARY){var i=e.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(y8);r.gpuTexture=i,r.regions=n,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(l8.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(t,e){for(var n=0;n<e;++n){for(var i=t[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<i.cmdPackage.copyBufferToTextureCmds.length;++f){var p=i.cmdPackage.copyBufferToTextureCmds.array[f];++p.refCount,this.cmdPackage.copyBufferToTextureCmds.push(p)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(m8);t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(l8.BIND_STATES),this._isStateInvalied=!1},e}(ho),B8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuFramebuffer=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],n=0;n<t.colorTextures.length;n++){var i=t.colorTextures[n];i&&e.push(i.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var n=0;n<e.gpuColorTextures.length;++n)if(e.gpuColorTextures[n].isSwapchainTexture)return void(e.isOffscreen=!1);var i=t.gl,r=[],o=i.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=Jr[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(e8.instance,this._gpuFramebuffer)},n.destroy=function(){var t,e;this._gpuFramebuffer&&(t=e8.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},Z(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(_o),F8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuInputAssembler=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var n=new Array(t.vertexBuffers.length),i=0;i<t.vertexBuffers.length;++i){var r=t.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var n=t.gl;e.glAttribs=new Array(e.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=r8(o.format,n),l=Jr[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Jr[o.format].count,stride:s.stride,componentCount:c8(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(e8.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var t=e8.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var n=e.glVAOs.values(),i=n.next(),r=t.gl,o=t.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),o===i.value&&(r.bindVertexArray(null),o=null),i=n.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},Z(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(yo),z8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(e),e+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&eo)for(var f=0;f<h.count;f++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},n.destroy=function(){this._bindings.length=0},Z(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(So),k8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineLayout=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),e.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},Z(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(To),U8=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],G8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineState=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var n=t.blendState,i=n.targets;i&&i.forEach((function(t,n){e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:U8[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},Z(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(Ro),H8=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.beginRenderPass=function(t,e,n,i,r,o){C8(e8.instance,t.gpuRenderPass,e.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;w8(e8.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(t){var e=e8.instance,n=e.stateCache,i=e.gl;n.viewport.left===t.left&&n.viewport.top===t.top&&n.viewport.width===t.width&&n.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),n.viewport.left=t.left,n.viewport.top=t.top,n.viewport.width=t.width,n.viewport.height=t.height)},n.setScissor=function(t){var e=e8.instance,n=e.stateCache,i=e.gl;n.scissorRect.x===t.x&&n.scissorRect.y===t.y&&n.scissorRect.width===t.width&&n.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),n.scissorRect.x=t.x,n.scissorRect.y=t.y,n.scissorRect.width=t.width,n.scissorRect.height=t.height)},n.updateBuffer=function(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=t.gpuBuffer;r&&(i=void 0!==n?n:t.usage&_i.INDIRECT?0:e.byteLength,S8(e8.instance,r,e,0,i))}},n.copyBuffersToTexture=function(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=e.gpuTexture;i&&I8(e8.instance,t,i,n)}},n.execute=function(t,e){for(var n=0;n<e;++n){var i=t[n];P8(e8.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){A8(e8.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(L8),V8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type},n.destroy=function(){},n.submit=function(t){for(var e=0;e<t.length;e++){var n=t[e];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Po),W8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuRenderPass=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},Z(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(Io),j8=function(t){function e(e,n){var i,r,o,a,s;return(i=t.call(this,e,n)||this)._gpuSampler=null,i._gpuSampler={glSampler:null,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},r=e8.instance,o=i._gpuSampler,(s=(a=r.gl).createSampler())&&(o.minFilter===bi.LINEAR||o.minFilter===bi.ANISOTROPIC?o.mipFilter===bi.LINEAR||o.mipFilter===bi.ANISOTROPIC?o.glMinFilter=a.LINEAR_MIPMAP_LINEAR:o.mipFilter===bi.POINT?o.glMinFilter=a.LINEAR_MIPMAP_NEAREST:o.glMinFilter=a.LINEAR:o.mipFilter===bi.LINEAR||o.mipFilter===bi.ANISOTROPIC?o.glMinFilter=a.NEAREST_MIPMAP_LINEAR:o.mipFilter===bi.POINT?o.glMinFilter=a.NEAREST_MIPMAP_NEAREST:o.glMinFilter=a.NEAREST,o.magFilter===bi.LINEAR||o.magFilter===bi.ANISOTROPIC?o.glMagFilter=a.LINEAR:o.glMagFilter=a.NEAREST,o.glWrapS=n8[o.addressU],o.glWrapT=n8[o.addressV],o.glWrapR=n8[o.addressW],o.glSampler=s,a.samplerParameteri(s,a.TEXTURE_MIN_FILTER,o.glMinFilter),a.samplerParameteri(s,a.TEXTURE_MAG_FILTER,o.glMagFilter),a.samplerParameteri(s,a.TEXTURE_WRAP_S,o.glWrapS),a.samplerParameteri(s,a.TEXTURE_WRAP_T,o.glWrapT),a.samplerParameteri(s,a.TEXTURE_WRAP_R,o.glWrapR),a.samplerParameterf(s,a.TEXTURE_MIN_LOD,0),a.samplerParameterf(s,a.TEXTURE_MAX_LOD,1e3)),i}return $(e,t),e.prototype.destroy=function(){this._gpuSampler&&(function(t,e){var n=t.gl;if(e.glSampler){n.deleteSampler(e.glSampler);for(var i=t.stateCache.glSamplerUnits,r=0;r<i.length;++r)i[r]===e.glSampler&&(n.bindSampler(r,null),i[r]=null);e.glSampler=null}}(e8.instance,this._gpuSampler),this._gpuSampler=null)},Z(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Mo),q8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuShader=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}!function(t,e){for(var n=t.gl,i=function(t){var i=e.gpuStages[t],r=0,o="",a=1;switch(i.type){case Mi.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Mi.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];n.attachShader(e.glProgram,c.glShader)}n.linkProgram(e.glProgram);for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(n.detachShader(e.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(n.getProgramInfoLog(e.glProgram));b("Shader '"+e.name+"' compilation succeeded.");var h=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var f=0;f<h;++f){var p=n.getActiveAttrib(e.glProgram,f);if(p){var d,_=p.name.indexOf("[");d=-1!==_?p.name.substr(0,_):p.name;var m=n.getAttribLocation(e.glProgram,d),v=a8(p.type,n),g=s8(p.type,n);e.glInputs[f]={name:d,type:v,stride:g,count:p.size,size:g*p.size,glType:p.type,glLoc:m}}}var y,x,S,E,C=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(C){e.glBlocks=new Array(C);for(var A=0;A<C;++A){var w=(y=n.getActiveUniformBlockName(e.glProgram,A)).indexOf("[");-1!==w&&(y=y.substr(0,w)),E=null;for(var R=0;R<e.blocks.length;R++)if(e.blocks[R].name===y){E=e.blocks[R];break}if(E){x=A,S=n.getActiveUniformBlockParameter(e.glProgram,x,n.UNIFORM_BLOCK_DATA_SIZE);var P=E.binding+(t.bindingMappingInfo.bufferOffsets[E.set]||0);n.uniformBlockBinding(e.glProgram,x,P),e.glBlocks[A]={set:E.set,binding:E.binding,idx:x,name:y,size:S,glBinding:P}}else T("Block '"+y+"' does not bound")}}for(var I=0;I<e.subpassInputs.length;++I){var M=e.subpassInputs[I];e.samplerTextures.push(new Sr(M.set,M.binding,M.name,di.SAMPLER2D,M.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var D=0;D<e.samplerTextures.length;++D){var O=e.samplerTextures[D];e.glSamplerTextures[D]={set:O.set,binding:O.binding,name:O.name,type:O.type,count:O.count,units:[],glUnits:null,glType:o8(O.type,n),glLoc:null}}}for(var N=[],L=[],B=t.stateCache.texUnitCacheMap,F=0,z=0;z<e.blocks.length;++z)e.blocks[z].set===t.bindingMappingInfo.flexibleSet&&F++;for(var k=0,U=0;U<e.samplerTextures.length;++U){var G=e.samplerTextures[U],H=n.getUniformLocation(e.glProgram,G.name);if(H&&-1!==H.id&&(N.push(e.glSamplerTextures[U]),L.push(H)),void 0===B[G.name]){var V=G.binding+t.bindingMappingInfo.samplerOffsets[G.set]+k;G.set===t.bindingMappingInfo.flexibleSet&&(V-=F),B[G.name]=V%t.capabilities.maxTextureUnits,k+=G.count-1}}if(N.length){for(var W=[],j=0;j<N.length;++j){var q=N[j],X=B[q.name];if(void 0!==X){q.glLoc=L[j];for(var Y=0;Y<q.count;++Y){for(;W[X];)X=(X+1)%t.capabilities.maxTextureUnits;q.units.push(X),W[X]=!0}}}for(var K=0,Q=0;Q<N.length;++Q){var Z=N[Q];if(!Z.glLoc){for(Z.glLoc=L[Q];W[K];)K++;for(var J=0;J<Z.count;++J){for(;W[K];)K=(K+1)%t.capabilities.maxTextureUnits;void 0===B[Z.name]&&(B[Z.name]=K),Z.units.push(K),W[K]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(var $=0;$<N.length;$++){var tt=N[$];tt.glUnits=new Int32Array(tt.units),n.uniform1iv(tt.glLoc,tt.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}e.glSamplerTextures=N}}(e8.instance,this._gpuShader)},n.destroy=function(){var t,e;this._gpuShader&&(t=e8.instance,(e=this._gpuShader).glProgram&&(t.gl.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null),this._gpuShader=null)},Z(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Do),X8=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new ar,this.scissorRect=new $i(0,0,0,0),this.rs=new Eo,this.dss=new bo,this.bs=new Ao,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e,n){for(var i=0;i<t;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=t,this.glSamplerUnits.fill(null),this.glBindUBOs.length=e,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=e,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},t}(),Y8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuTexture=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t,e){"texture"in t?console.log("WebGL2 does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=io(this._width)&&io(this._height),this._size=oo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},T8(e8.instance,this._gpuTexture),e8.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(E8(e8.instance,this._gpuTexture),e8.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(t,e){var n=this._size;this._width=t,this._height=e,this._size=oo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var n=t.gl,i=e.width,r=e.height;switch(e.type){case yi.TEX2D:e.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&O(9100,o,t.capabilities.maxTextureSize),e.samples===Ti.ONE){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=ro(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else E8(t,e),T8(t,e)}else e.glRenderbuffer&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break;case yi.CUBE:e.type=yi.CUBE,e.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>t.capabilities.maxCubeMapTextureSize&&O(9100,u,t.capabilities.maxTextureSize);var h=t.stateCache.glTexUnits[t.stateCache.texUnit];if(h.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),h.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var f=0;f<6;++f){i=e.width,r=e.height;for(var p=0;p<e.mipLevel;++p){var d=ro(e.format,i,r,1),_=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,e.glInternalFmt,i,r,0,_),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else E8(t,e),T8(t,e);break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yi.TEX2D,e.glTarget=n.TEXTURE_2D}}}(e8.instance,this._gpuTexture),e8.instance.memoryStatus.textureSize-=n,e8.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(t){var e=new mr;e.format=t.format,e.usage=Jr[t.format].hasDepth?xi.DEPTH_STENCIL_ATTACHMENT:xi.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},Z(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(Oo),K8="webglcontextlost";function Q8(t,e){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=t.getExtension(n[i]+e);if(r)return r}return null}function Z8(t){var e={EXT_texture_filter_anisotropic:Q8(t,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:Q8(t,"EXT_color_buffer_half_float"),EXT_color_buffer_float:Q8(t,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:Q8(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:Q8(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:Q8(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:Q8(t,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:Q8(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:Q8(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:Q8(t,"WEBGL_debug_shaders"),WEBGL_lose_context:Q8(t,"WEBGL_lose_context"),WEBGL_debug_renderer_info:Q8(t,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:Q8(t,"OES_texture_half_float_linear"),OES_texture_float_linear:Q8(t,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return _u.os!==au.ANDROID&&_u.os!==au.IOS&&(e.WEBGL_multi_draw=Q8(t,"WEBGL_multi_draw")),e}var J8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).stateCache=new X8,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGL2ContextLostHandler=null,e._extensions=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){this._canvas=t.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(K8,this._onWebGLContextLost);var e=e8.instance.gl;this.stateCache.initialize(e8.instance.capabilities.maxTextureUnits,e8.instance.capabilities.maxUniformBufferBindings,e8.instance.capabilities.maxVertexAttributes),this._extensions=Z8(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var n=fi.RGBA8,i=fi.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?i=fi.DEPTH_STENCIL:r&&(i=fi.DEPTH),this._colorTexture=new Y8,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this._depthStencilTexture=new Y8,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=e8.instance.createTexture(new mr(yi.TEX2D,xi.SAMPLED,fi.RGBA8,2,2,Si.NONE)),this.nullTexCube=e8.instance.createTexture(new mr(yi.CUBE,xi.SAMPLED,fi.RGBA8,2,2,Si.NONE,6));var a=new or;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),e8.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,e8.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(K8,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(b("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},n._onWebGLContextLost=function(t){M(11e3),S(t)},Z(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(po),$8=t("WebGL2Device",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._swapchain=null,e._context=null,e}$(e,t);var n=e.prototype;return n.initialize=function(t){e8.setInstance(this),this._gfxAPI=li.WEBGL2,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var n={alpha:ue.ENABLE_TRANSPARENT_CANVAS,antialias:ue.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl2",n)}catch(t){return null}return e}(fo.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new jr(Wi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Wr(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=e.getSupportedExtensions(),i="";if(n)for(var r,o=st(n);!(r=o()).done;)i+=r.value+" ";var a=Z8(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),this._features[hi.TEXTURE_FLOAT]=!0,this._features[hi.TEXTURE_HALF_FLOAT]=!0,this._features[hi.FORMAT_R11G11B10F]=!0,this._features[hi.FORMAT_SRGB]=!0,this._features[hi.FORMAT_RGB8]=!0,this._features[hi.ELEMENT_INDEX_UINT]=!0,this._features[hi.INSTANCED_ARRAYS]=!0,this._features[hi.MULTIPLE_RENDER_TARGETS]=!0,this._features[hi.BLEND_MINMAX]=!0,a.EXT_color_buffer_float&&(this._features[hi.COLOR_FLOAT]=!0,this._features[hi.COLOR_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[hi.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[hi.TEXTURE_HALF_FLOAT_LINEAR]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[hi.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[hi.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[hi.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[hi.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[hi.FORMAT_ASTC]=!0,c+="astc "),b("WebGL2 device initialized."),b("RENDERER: "+this._renderer),b("VENDOR: "+this._vendor),b("VERSION: "+s),b("COMPRESSED_FORMAT: "+c),b("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var t=this._samplers.values(),e=t.next();!e.done;)e.value.destroy(),e=t.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},n.createCommandBuffer=function(t){var e=new(t.type===qi.PRIMARY?H8:L8);return e.initialize(t),e},n.createSwapchain=function(t){var e=new J8;return this._swapchain=e,e.initialize(t),e},n.createBuffer=function(t){var e=new D8;return e.initialize(t),e},n.createTexture=function(t){var e=new Y8;return e.initialize(t),e},n.createDescriptorSet=function(t){var e=new t8;return e.initialize(t),e},n.createShader=function(t){var e=new q8;return e.initialize(t),e},n.createInputAssembler=function(t){var e=new F8;return e.initialize(t),e},n.createRenderPass=function(t){var e=new W8;return e.initialize(t),e},n.createFramebuffer=function(t){var e=new B8;return e.initialize(t),e},n.createDescriptorSetLayout=function(t){var e=new z8;return e.initialize(t),e},n.createPipelineLayout=function(t){var e=new k8;return e.initialize(t),e},n.createPipelineState=function(t){var e=new G8;return e.initialize(t),e},n.createQueue=function(t){var e=new V8;return e.initialize(t),e},n.getSampler=function(t){var e=Mo.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new j8(t,e)),this._samplers.get(e)},n.getGlobalBarrier=function(t){var e=No.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new No(t,e)),this._globalBarriers.get(e)},n.getTextureBarrier=function(t){var e=Lo.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Lo(t,e)),this._textureBarriers.get(e)},n.copyBuffersToTexture=function(t,e,n){I8(this,t,e.gpuTexture,n)},n.copyTextureToBuffers=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,f.texSubres.mipLevel),s=f.texOffset.x,c=f.texOffset.y,l=f.texExtent.width,u=f.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,n)},n.copyTexImagesToTexture=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],f=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<f;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Si.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)},Z(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(fo));function t6(t,e,n,i){var r=(i.x-n.x)*(t.y-n.y)-(i.y-n.y)*(t.x-n.x),o=(e.x-t.x)*(t.y-n.y)-(e.y-t.y)*(t.x-n.x),a=(i.y-n.y)*(e.x-t.x)-(i.x-n.x)*(e.y-t.y);if(0!==a){var s=r/a,c=o/a;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}u.WebGL2Device=$8;var e6=new Xn,n6=new Xn,i6=new Xn,r6=new Xn;function o6(t,e,n){for(var i=n.length,r=0;r<i;++r)if(t6(t,e,n[r],n[(r+1)%i]))return!0;return!1}function a6(t,e){for(var n=!1,i=t.x,r=t.y,o=e.length,a=0,s=o-1;a<o;s=a++){var c=e[a].x,l=e[a].y,u=e[s].x,h=e[s].y;l>r!=h>r&&i<(u-c)*(r-l)/(h-l)+c&&(n=!n)}return n}function s6(t,e,n,i){var r,o=n.x-e.x,a=n.y-e.y,s=o*o+a*a,c=((t.x-e.x)*o+(t.y-e.y)*a)/s;return r=i?s?c<0?e:c>1?n:e6.set(e.x+c*o,e.y+c*a):e:e6.set(e.x+c*o,e.y+c*a),o=t.x-r.x,a=t.y-r.y,Math.sqrt(o*o+a*a)}var c6,l6,u6,h6,f6,p6,d6,_6,m6,v6,g6,y6,x6,S6,T6,E6,b6=t("Intersection2D",(function(){}));b6.lineLine=t6,b6.lineRect=function(t,e,n){var i=e6.set(n.x,n.y),r=n6.set(n.x,n.yMax),o=i6.set(n.xMax,n.yMax),a=r6.set(n.xMax,n.y);return!!(t6(t,e,i,r)||t6(t,e,r,o)||t6(t,e,o,a)||t6(t,e,a,i))},b6.linePolygon=o6,b6.rectRect=function(t,e){var n=t.x,i=t.y,r=t.x+t.width,o=t.y+t.height,a=e.x,s=e.y,c=e.x+e.width,l=e.y+e.height;return n<=c&&r>=a&&i<=l&&o>=s},b6.rectPolygon=function(t,e){var n=e6.set(t.x,t.y),i=n6.set(t.x,t.yMax),r=i6.set(t.xMax,t.yMax),o=r6.set(t.xMax,t.y);if(o6(n,i,e))return!0;if(o6(i,r,e))return!0;if(o6(r,o,e))return!0;if(o6(o,n,e))return!0;for(var a=0,s=e.length;a<s;++a)if(t.contains(e[a]))return!0;return!!(a6(n,e)||a6(i,e)||a6(r,e)||a6(o,e))},b6.rectCircle=function(t,e,n){var i=e.x,r=e.y,o=t.x,a=t.y,s=t.width,c=t.height,l=i,u=r;i<o?l=o:i>o+s&&(l=o+s),r<a?u=a:r>a+c&&(u=a+c);var h=i-l,f=r-u;return Math.sqrt(h*h+f*f)<=n},b6.polygonPolygon=function(t,e){var n,i;for(n=0,i=t.length;n<i;++n)if(o6(t[n],t[(n+1)%i],e))return!0;for(n=0,i=e.length;n<i;++n)if(a6(e[n],t))return!0;for(n=0,i=t.length;n<i;++n)if(a6(t[n],e))return!0;return!1},b6.circleCircle=function(t,e,n,i){return Xn.distance(t,n)<e+i},b6.polygonCircle=function(t,e,n){var i=e;if(a6(i,t))return!0;for(var r=0,o=t.length;r<o;r++)if(s6(i,0===r?t[t.length-1]:t[r-1],t[r],!0)<n)return!0;return!1},b6.pointInPolygon=a6,b6.pointLineDistance=s6;var C6,A6,w6,R6,P6,I6,M6,D6,O6,N6,L6,B6,F6,z6,k6,U6,G6,H6,V6,W6,j6,q6,X6,Y6,K6,Q6,Z6,J6,$6,t7,e7,n7,i7=function(e){return t({Billboard:e,BillboardComponent:e}),e}((c6=dc("cc.Billboard"),l6=Ic(),u6=Ac(),h6=Kc(Ev),f6=Kc(Ev),p6=Lc(),d6=Lc(),_6=Lc(),m6=Lc(),c6(v6=l6(v6=u6(v6=Cc((E6=function(t){function e(){var e;return ct(e=t.call(this)||this,"_texture",y6,ot(e)),ct(e,"_height",x6,ot(e)),ct(e,"_width",S6,ot(e)),ct(e,"_rotation",T6,ot(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new Zn(1,1,0,0),e}$(e,t);var n=e.prototype;return n.onLoad=function(){this.createModel()},n.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},n.onDisable=function(){this.detachFromScene()},n.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},n.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n.createModel=function(){this._mesh=L$({primitiveMode:Fi.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[An.WHITE.r,An.WHITE.g,An.WHITE.b,An.WHITE.a,An.WHITE.r,An.WHITE.g,An.WHITE.b,An.WHITE.a,An.WHITE.r,An.WHITE.g,An.WHITE.b,An.WHITE.a,An.WHITE.r,An.WHITE.g,An.WHITE.b,An.WHITE.a],attributes:[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD,fi.RG32F),new Rr(Ki.ATTR_COLOR,fi.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var t=this._model=u.director.root.createModel(cT,this.node);t.node=t.transform=this.node,null==this._material&&(this._material=new cg,this._material.copy(Dv.get("default-billboard-material"))),t.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},Z(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._material&&this._material.setProperty("mainTexture",t)}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._material&&(this._uniform.y=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._material&&(this._uniform.x=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*hn(this._rotation))/100},set:function(t){this._rotation=un(t),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),e}($u),y6=lt((g6=E6).prototype,"_texture",[h6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(g6.prototype,"texture",[f6,p6],Object.getOwnPropertyDescriptor(g6.prototype,"texture"),g6.prototype),x6=lt(g6.prototype,"_height",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(g6.prototype,"height",[d6],Object.getOwnPropertyDescriptor(g6.prototype,"height"),g6.prototype),S6=lt(g6.prototype,"_width",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(g6.prototype,"width",[_6],Object.getOwnPropertyDescriptor(g6.prototype,"width"),g6.prototype),T6=lt(g6.prototype,"_rotation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(g6.prototype,"rotation",[m6],Object.getOwnPropertyDescriptor(g6.prototype,"rotation"),g6.prototype),v6=g6))||v6)||v6)||v6)||v6)),r7=[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD,fi.RGBA32F),new Rr(Ki.ATTR_TEX_COORD1,fi.RGB32F),new Rr(Ki.ATTR_COLOR,fi.RGBA8,!0)],o7=new Rn,a7=new Rn,s7=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e.type=tT.LINE,e._capacity=100,e._iaInfo=new _r([new pr]),e._iaInfoBuffer=e._device.createBuffer(new hr(_i.INDIRECT,gi.DEVICE,no,no)),e}$(e,t);var n=e.prototype;return n.setCapacity=function(t){this._capacity=t,this.createBuffer()},n.createBuffer=function(){this._vertSize=0;for(var t,e=st(r7);!(t=e()).done;){var n=t.value;n.offset=this._vertSize,this._vertSize+=Jr[n.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.updateMaterial=function(e){this._material=e,t.prototype.setSubModelMaterial.call(this,0,e)},n.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var t=this._device.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);for(var n=new Uint16Array((this._capacity-1)*this._indexCount),i=0,r=0;r<this._capacity-1;++r){var o=2*r;n[i++]=o,n[i++]=o+1,n[i++]=o+2,n[i++]=o+3,n[i++]=o+2,n[i++]=o+1}var a=this._device.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(n),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new GA([t],r7,Fi.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},n.addLineVertexData=function(t,e,n){if(t.length>1){var i=0;Rn.subtract(o7,t[1],t[0]),this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,this._vdataF32[i++]=0,this._vdataF32[i++]=e.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=0,this._vdataF32[i++]=o7.x,this._vdataF32[i++]=o7.y,this._vdataF32[i++]=o7.z,this._vdataUint32[i++]=n.evaluate(0,1)._val,this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,this._vdataF32[i++]=1,this._vdataF32[i++]=e.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=1,this._vdataF32[i++]=o7.x,this._vdataF32[i++]=o7.y,this._vdataF32[i++]=o7.z,this._vdataUint32[i++]=n.evaluate(0,1)._val;for(var r=1;r<t.length-1;r++){Rn.subtract(o7,t[r-1],t[r]),Rn.subtract(a7,t[r+1],t[r]),Rn.subtract(a7,a7,o7);var o=r/t.length;this._vdataF32[i++]=t[r].x,this._vdataF32[i++]=t[r].y,this._vdataF32[i++]=t[r].z,this._vdataF32[i++]=0,this._vdataF32[i++]=e.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=0,this._vdataF32[i++]=a7.x,this._vdataF32[i++]=a7.y,this._vdataF32[i++]=a7.z,this._vdataUint32[i++]=n.evaluate(o,1)._val,this._vdataF32[i++]=t[r].x,this._vdataF32[i++]=t[r].y,this._vdataF32[i++]=t[r].z,this._vdataF32[i++]=1,this._vdataF32[i++]=e.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=1,this._vdataF32[i++]=a7.x,this._vdataF32[i++]=a7.y,this._vdataF32[i++]=a7.z,this._vdataUint32[i++]=n.evaluate(o,1)._val}Rn.subtract(o7,t[t.length-1],t[t.length-2]),this._vdataF32[i++]=t[t.length-1].x,this._vdataF32[i++]=t[t.length-1].y,this._vdataF32[i++]=t[t.length-1].z,this._vdataF32[i++]=0,this._vdataF32[i++]=e.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=0,this._vdataF32[i++]=o7.x,this._vdataF32[i++]=o7.y,this._vdataF32[i++]=o7.z,this._vdataUint32[i++]=n.evaluate(1,1)._val,this._vdataF32[i++]=t[t.length-1].x,this._vdataF32[i++]=t[t.length-1].y,this._vdataF32[i++]=t[t.length-1].z,this._vdataF32[i++]=1,this._vdataF32[i++]=e.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=1,this._vdataF32[i++]=o7.x,this._vdataF32[i++]=o7.y,this._vdataF32[i++]=o7.z,this._vdataUint32[i++]=n.evaluate(1,1)._val}this.updateIA(Math.max(0,t.length-1))},n.updateIA=function(t){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},e}(cT),c7=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],l7=oe({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),u7=t("CurveRange",(C6=dc("cc.CurveRange"),A6=Kc(l7),w6=Kc(_p),R6=Kc(_p),P6=Kc(_p),C6((G6=U6=function(){function t(){ct(this,"mode",D6,this),ct(this,"spline",O6,this),ct(this,"splineMin",N6,this),ct(this,"splineMax",L6,this),ct(this,"constant",B6,this),ct(this,"constantMin",F6,this),ct(this,"constantMax",z6,this),ct(this,"multiplier",k6,this),this._curve=new yd(this.spline),this._curveMin=new yd(this.splineMin),this._curveMax=new yd(this.splineMax)}var e=t.prototype;return e.evaluate=function(t,e){switch(this.mode){default:case l7.Constant:return this.constant;case l7.Curve:return this.spline.evaluate(t)*this.multiplier;case l7.TwoCurves:return ln(this.splineMin.evaluate(t),this.splineMax.evaluate(t),e)*this.multiplier;case l7.TwoConstants:return ln(this.constantMin,this.constantMax,e)}},e.getMax=function(){switch(this.mode){default:case l7.Constant:return this.constant;case l7.Curve:return this.multiplier;case l7.TwoConstants:return this.constantMax;case l7.TwoCurves:return this.multiplier}},e._onBeforeSerialize=function(){return c7[this.mode]},Z(t,[{key:"curve",get:function(){return this._curve},set:function(t){this._curve=t,this.spline=t._internalCurve}},{key:"curveMin",get:function(){return this._curveMin},set:function(t){this._curveMin=t,this.splineMin=t._internalCurve}},{key:"curveMax",get:function(){return this._curveMax},set:function(t){this._curveMax=t,this.splineMax=t._internalCurve}}]),t}(),U6.Mode=l7,D6=lt((M6=G6).prototype,"mode",[A6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return l7.Constant}}),O6=lt(M6.prototype,"spline",[w6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Td()}}),N6=lt(M6.prototype,"splineMin",[R6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Td()}}),L6=lt(M6.prototype,"splineMax",[P6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Td()}}),B6=lt(M6.prototype,"constant",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),F6=lt(M6.prototype,"constantMin",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),z6=lt(M6.prototype,"constantMax",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),k6=lt(M6.prototype,"multiplier",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),I6=M6))||I6));function h7(t,e,n){switch(t.mode){case l7.Constant:return t.constant;case l7.Curve:return t.spline.evaluate(e)*t.multiplier;case l7.TwoCurves:return 0===n?t.splineMin.evaluate(e)*t.multiplier:t.splineMax.evaluate(e)*t.multiplier;case l7.TwoConstants:return 0===n?t.constantMin:t.constantMax;default:return 0}}function f7(t){switch(t.mode){case l7.TwoConstants:case l7.TwoCurves:return 2;default:return 1}}function p7(t,e,n){var i=new tv({width:e,height:n,_data:t,_compressed:!1,format:Mm.RGBA32F}),r=new Ev;return r.setFilters(Om.NEAREST,Om.NEAREST),r.setMipFilter(Om.NONE),r.setWrapMode(Dm.CLAMP_TO_EDGE,Dm.CLAMP_TO_EDGE,Dm.CLAMP_TO_EDGE),r.image=i,r}function d7(t,e,n,i,r){for(var o=Math.max(f7(e),f7(n),f7(i)),a=new Float32Array(t*o*4),s=[e,n,i],c=1/(t-1),l=0;l<o;l++)for(var u=0;u<3;u++)for(var h=s[u],f=0,p=0,d=0;d<t;d++){var _=h7(h,c*d,l);p=r?_:(f+=_)/(d+1),a[4*d+u]=p}return p7(a,t,o)}var _7,m7,v7,g7,y7,x7,S7,T7,E7,b7,C7,A7,w7,R7,P7,I7,M7,D7,O7,N7,L7,B7,F7,z7,k7,U7,G7,H7,V7,W7,j7,q7,X7,Y7,K7,Q7,Z7,J7,$7,t9,e9,n9,i9,r9,o9,a9,s9,c9,l9,u9,h9,f9,p9,d9,_9,m9=oe({Blend:0,Fixed:1}),v9=(t("ColorKey",dc("cc.ColorKey")((W6=lt((V6=function(){ct(this,"color",W6,this),ct(this,"time",j6,this)}).prototype,"color",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),j6=lt(V6.prototype,"time",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),H6=V6))||H6),t("AlphaKey",dc("cc.AlphaKey")((Y6=lt((X6=function(){ct(this,"alpha",Y6,this),ct(this,"time",K6,this)}).prototype,"alpha",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),K6=lt(X6.prototype,"time",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),q6=X6))||q6),t("Gradient",dc("cc.Gradient")((n7=e7=function(){function t(){ct(this,"colorKeys",J6,this),ct(this,"alphaKeys",$6,this),ct(this,"mode",t7,this),this._color=void 0,this._color=An.WHITE.clone()}var e=t.prototype;return e.setKeys=function(t,e){this.colorKeys=t,this.alphaKeys=e},e.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(t,e){return t.time-e.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(t,e){return t.time-e.time}))},e.evaluate=function(t){return this.getRGB(t),this._color._set_a_unsafe(this.getAlpha(t)),this._color},e.randomColor=function(){var t=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],e=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(t.color),this._color._set_a_unsafe(e.alpha),this._color},e.getRGB=function(t){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(An.WHITE),this._color);t=yn(t,1);for(var e=1;e<this.colorKeys.length;++e){var n=this.colorKeys[e-1].time,i=this.colorKeys[e].time;if(t>=n&&t<i){if(this.mode===m9.Fixed)return this.colorKeys[e].color;var r=(t-n)/(i-n);return An.lerp(this._color,this.colorKeys[e-1].color,this.colorKeys[e].color,r),this._color}}var o=this.colorKeys.length-1;t<this.colorKeys[0].time?An.lerp(this._color,An.BLACK,this.colorKeys[0].color,t/this.colorKeys[0].time):t>this.colorKeys[o].time&&An.lerp(this._color,this.colorKeys[o].color,An.BLACK,(t-this.colorKeys[o].time)/(1-this.colorKeys[o].time))},e.getAlpha=function(t){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;t=yn(t,1);for(var e=1;e<this.alphaKeys.length;++e){var n=this.alphaKeys[e-1].time,i=this.alphaKeys[e].time;if(t>=n&&t<i){if(this.mode===m9.Fixed)return this.alphaKeys[e].alpha;var r=(t-n)/(i-n);return ln(this.alphaKeys[e-1].alpha,this.alphaKeys[e].alpha,r)}}var o=this.alphaKeys.length-1;return t<this.alphaKeys[0].time?ln(0,this.alphaKeys[0].alpha,t/this.alphaKeys[0].time):t>this.alphaKeys[o].time?ln(this.alphaKeys[o].alpha,0,(t-this.alphaKeys[o].time)/(1-this.alphaKeys[o].time)):void 0},t}(),e7.Mode=m9,J6=lt((Z6=n7).prototype,"colorKeys",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),$6=lt(Z6.prototype,"alphaKeys",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),t7=lt(Z6.prototype,"mode",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return m9.Blend}}),Q6=Z6))||Q6)),g9=oe({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),y9=t("GradientRange",(_7=dc("cc.GradientRange"),m7=Kc(g9),v7=Kc(v9),g7=Kc(v9),y7=Kc(v9),x7=Kc(g9),_7((M7=I7=function(){function t(){ct(this,"color",E7,this),ct(this,"colorMin",b7,this),ct(this,"colorMax",C7,this),ct(this,"gradient",A7,this),ct(this,"gradientMin",w7,this),ct(this,"gradientMax",R7,this),ct(this,"_mode",P7,this),this._color=An.WHITE.clone()}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){case g9.Color:return this.color;case g9.TwoColors:return An.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case g9.RandomColor:return this.gradient.randomColor();case g9.Gradient:return this.gradient.evaluate(t);case g9.TwoGradients:return An.lerp(this._color,this.gradientMin.evaluate(t),this.gradientMax.evaluate(t),e),this._color;default:return this.color}},e._onBeforeSerialize=function(){return(!1)[this._mode]},Z(t,[{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),t}(),I7.Mode=g9,lt((T7=M7).prototype,"mode",[m7],Object.getOwnPropertyDescriptor(T7.prototype,"mode"),T7.prototype),E7=lt(T7.prototype,"color",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),b7=lt(T7.prototype,"colorMin",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),C7=lt(T7.prototype,"colorMax",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),A7=lt(T7.prototype,"gradient",[v7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v9}}),w7=lt(T7.prototype,"gradientMin",[g7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v9}}),R7=lt(T7.prototype,"gradientMax",[y7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v9}}),P7=lt(T7.prototype,"_mode",[x7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return g9.Color}}),S7=T7))||S7));function x9(t,e,n){switch(t.mode){case g9.Color:return t.color;case g9.TwoColors:return 0===n?t.colorMin:t.colorMax;case g9.RandomColor:return t.gradient.randomColor();case g9.Gradient:return t.gradient.evaluate(e);case g9.TwoGradients:return 0===n?t.gradientMin.evaluate(e):t.gradientMax.evaluate(e);default:return t.color}}var S9={parent:null,owner:null,subModelIdx:0},T9={CC_USE_WORLD_SPACE:!1},E9=function(e){return t({Line:e,LineComponent:e}),e}((D7=dc("cc.Line"),O7=Ic(),N7=Ac(),L7=Kc(Ev),B7=Kc(Ev),F7=Gc(),z7=Lc(),k7=Gc(),U7=Lc(),G7=Kc([Rn]),H7=Kc([Rn]),V7=Gc(),W7=Lc(),j7=Kc(u7),q7=Kc(u7),X7=Bc(),Y7=Gc(),K7=Lc(),Q7=Kc(Xn),Z7=Gc(),J7=Lc(),$7=Kc(Xn),t9=Gc(),e9=Lc(),n9=Kc(y9),i9=Kc(y9),r9=Gc(),o9=Lc(),D7(a9=O7(a9=N7(a9=Cc((_9=function(t){function e(){var e;return ct(e=t.call(this)||this,"_texture",c9,ot(e)),e._material=null,e._materialInstance=null,ct(e,"_worldSpace",l9,ot(e)),ct(e,"_positions",u9,ot(e)),ct(e,"_width",h9,ot(e)),ct(e,"_tile",f9,ot(e)),ct(e,"_offset",p9,ot(e)),ct(e,"_color",d9,ot(e)),e._model=null,e._tile_offset=new Zn,e}$(e,t);var n=e.prototype;return n.onLoad=function(){var t=this._model=u.director.root.createModel(s7);t.node=t.transform=this.node,null===this._material&&(this._material=new cg,this._material.copy(Dv.get("default-trail-material")),T9.CC_USE_WORLD_SPACE=this.worldSpace,S9.parent=this._material,S9.subModelIdx=0,this._materialInstance=new mT(S9),S9.parent=null,S9.subModelIdx=0,this._materialInstance.recompileShaders(T9)),t.updateMaterial(this._materialInstance),t.setCapacity(100)},n.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},n.onDisable=function(){this._model&&this._detachFromScene()},n._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},Z(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._materialInstance&&this._materialInstance.setProperty("mainTexture",t)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(t){this._worldSpace=t,this._materialInstance&&(T9.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(T9),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(t){this._positions=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(t){this._tile.set(t),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),e}($u),c9=lt((s9=_9).prototype,"_texture",[L7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(s9.prototype,"texture",[B7,F7,z7],Object.getOwnPropertyDescriptor(s9.prototype,"texture"),s9.prototype),l9=lt(s9.prototype,"_worldSpace",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(s9.prototype,"worldSpace",[k7,U7],Object.getOwnPropertyDescriptor(s9.prototype,"worldSpace"),s9.prototype),u9=lt(s9.prototype,"_positions",[G7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lt(s9.prototype,"positions",[H7,V7,W7],Object.getOwnPropertyDescriptor(s9.prototype,"positions"),s9.prototype),h9=lt(s9.prototype,"_width",[j7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),lt(s9.prototype,"width",[q7,X7,Y7,K7],Object.getOwnPropertyDescriptor(s9.prototype,"width"),s9.prototype),f9=lt(s9.prototype,"_tile",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(1,1)}}),lt(s9.prototype,"tile",[Q7,Z7,J7],Object.getOwnPropertyDescriptor(s9.prototype,"tile"),s9.prototype),p9=lt(s9.prototype,"_offset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(0,0)}}),lt(s9.prototype,"offset",[$7,t9,e9],Object.getOwnPropertyDescriptor(s9.prototype,"offset"),s9.prototype),d9=lt(s9.prototype,"_color",[n9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new y9}}),lt(s9.prototype,"color",[i9,r9,o9],Object.getOwnPropertyDescriptor(s9.prototype,"color"),s9.prototype),a9=s9))||a9)||a9)||a9)||a9)),b9=function(){function t(t){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new Rn(0,0,0),this.velocity=new Rn(0,0,0),this.animatedVelocity=new Rn(0,0,0),this.ultimateVelocity=new Rn(0,0,0),this.angularVelocity=new Rn(0,0,0),this.axisOfRotation=new Rn(0,0,0),this.rotation=new Rn(0,0,0),this.startEuler=new Rn(0,0,0),this.startRotation=new Ln,this.startRotated=!1,this.deltaQuat=new Ln,this.deltaMat=new Vn,this.localMat=new Vn,this.startSize=new Rn(0,0,0),this.size=new Rn(0,0,0),this.startColor=An.WHITE.clone(),this.color=An.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return t.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},t}();b9.INDENTIFY_NEG_QUAT=10,b9.R2D=180/Math.PI;var C9,A9,w9,R9,P9,I9,M9,D9,O9,N9,L9,B9,F9,z9,k9,U9,G9,H9,V9,W9,j9,q9,X9,Y9,K9,Q9,Z9,J9,$9,ttt,ett,ntt,itt,rtt,ott="colorModule",att="rotationModule",stt="sizeModule",ctt="textureModule",ltt=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],utt=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],htt=function(){function t(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var e=t.prototype;return e.bindTarget=function(t){this.target=t},e.update=function(){},t}(),ftt=oe({World:0,Local:1,Custom:2}),ptt=oe({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),dtt=oe({World:0,Local:1,View:2}),_tt=oe({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),mtt=oe({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),vtt=oe({Base:0,Edge:1,Shell:2,Volume:3}),gtt=oe({Random:0,Loop:1,PingPong:2}),ytt=oe({Particles:0}),xtt=oe({Stretch:0}),Stt=(C9=dc("cc.ColorOvertimeModule"),A9=Gc(),w9=Kc(y9),R9=Gc(),C9((O9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_enable",M9,ot(e)),ct(e,"color",D9,ot(e)),e.name=ott,e}return $(e,t),e.prototype.animate=function(t){t.color.set(t.startColor),t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,_n(t.randomSeed+91041)))},Z(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(htt),M9=lt((I9=O9).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(I9.prototype,"enable",[A9],Object.getOwnPropertyDescriptor(I9.prototype,"enable"),I9.prototype),D9=lt(I9.prototype,"color",[w9,xc,R9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new y9}}),P9=I9))||P9),Ttt=new Rn(0,0,-1);function Ett(t,e,n,i){return e!==t?(t===ftt.World||Vn.invert(n,n),Vn.getRotation(i,n),!0):(Ln.set(i,0,0,0,1),!1)}function btt(t,e){Xn.set(t,Math.cos(e),Math.sin(e))}function Ctt(t){var e=pn(-1,1),n=pn(0,2*Math.PI),i=Math.sqrt(1-e*e),r=i*Math.cos(n),o=i*Math.sin(n);Rn.set(t,r,o,e)}function Att(t,e,n){Ctt(t),Rn.multiplyScalar(t,t,e+(n-e)*fn())}function wtt(t,e,n,i){btt(t,i),t.z=0,Rn.multiplyScalar(t,t,e+(n-e)*fn())}function Rtt(t){for(var e=0;e<t.length;e++){var n=e+dn(0,t.length-e),i=t[n];t[n]=t[e],t[e]=i}}function Ptt(){var t=pn(-1,1);return 0===t&&t++,i(t)}var Itt,Mtt,Dtt,Ott,Ntt,Ltt,Btt,Ftt,ztt,ktt,Utt,Gtt,Htt,Vtt,Wtt,jtt,qtt,Xtt,Ytt,Ktt,Qtt,Ztt,Jtt,$tt,tet,eet,net,iet,ret,oet,aet,set,cet,uet,het,fet,pet,det,_et,met,vet,get,yet,xet,Tet,Eet,bet,Cet,Aet,wet,Ret,Pet,Iet,Met,Det,Oet,Net,Let,Bet,Fet,zet=212165,ket=new Rn,Uet=(N9=dc("cc.ForceOvertimeModule"),L9=Gc(),B9=Kc(u7),F9=Bc(),z9=Gc(),k9=Lc(),U9=Kc(u7),G9=Bc(),H9=Gc(),V9=Lc(),W9=Kc(u7),j9=Bc(),q9=Gc(),X9=Lc(),Y9=Kc(ftt),K9=Gc(),Q9=Lc(),N9((rtt=function(t){function e(){var e;return ct(e=t.call(this)||this,"_enable",$9,ot(e)),ct(e,"x",ttt,ot(e)),ct(e,"y",ett,ot(e)),ct(e,"z",ntt,ot(e)),ct(e,"space",itt,ot(e)),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name="forceModule",e.rotation=new Ln,e.needTransform=!1,e.needUpdate=!0,e}$(e,t);var n=e.prototype;return n.update=function(t,e){this.needTransform=Ett(t,this.space,e,this.rotation)},n.animate=function(t,e){var n=1-t.remainingLifetime/t.startLifetime,i=Rn.set(ket,this.x.evaluate(n,_n(t.randomSeed+zet)),this.y.evaluate(n,_n(t.randomSeed+zet)),this.z.evaluate(n,_n(t.randomSeed+zet)));this.needTransform&&Rn.transformQuat(i,i,this.rotation),Rn.scaleAndAdd(t.velocity,t.velocity,i,e),Rn.copy(t.ultimateVelocity,t.velocity)},Z(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(htt),$9=lt((J9=rtt).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(J9.prototype,"enable",[L9],Object.getOwnPropertyDescriptor(J9.prototype,"enable"),J9.prototype),ttt=lt(J9.prototype,"x",[B9,xc,F9,z9,k9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),ett=lt(J9.prototype,"y",[U9,xc,G9,H9,V9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),ntt=lt(J9.prototype,"z",[W9,xc,j9,q9,X9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),itt=lt(J9.prototype,"space",[Y9,xc,K9,Q9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ftt.Local}}),Z9=J9))||Z9),Get=23541,Het=new Rn,Vet=new Rn,Wet=(Itt=dc("cc.LimitVelocityOvertimeModule"),Mtt=Gc(),Dtt=Kc(u7),Ott=Bc(),Ntt=Gc(),Ltt=Lc(),Btt=Kc(u7),Ftt=Bc(),ztt=Gc(),ktt=Lc(),Utt=Kc(u7),Gtt=Bc(),Htt=Gc(),Vtt=Lc(),Wtt=Kc(u7),jtt=Bc(),qtt=Gc(),Xtt=Lc(),Ytt=Gc(),Ktt=Lc(),Qtt=Gc(),Ztt=Lc(),Jtt=Kc(ftt),$tt=Gc(),tet=Lc(),Itt((fet=function(t){function e(){var e;return ct(e=t.call(this)||this,"_enable",iet,ot(e)),ct(e,"limitX",ret,ot(e)),ct(e,"limitY",oet,ot(e)),ct(e,"limitZ",aet,ot(e)),ct(e,"limit",set,ot(e)),ct(e,"dampen",cet,ot(e)),ct(e,"separateAxes",uet,ot(e)),ct(e,"space",het,ot(e)),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name="limitModule",e.rotation=void 0,e.needTransform=void 0,e.rotation=new Ln,e.needTransform=!1,e.needUpdate=!0,e}$(e,t);var n=e.prototype;return n.update=function(t,e){this.needTransform=Ett(t,this.space,e,this.rotation)},n.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,n=Het;this.separateAxes?(Rn.set(Vet,this.limitX.evaluate(e,_n(t.randomSeed+Get)),this.limitY.evaluate(e,_n(t.randomSeed+Get)),this.limitZ.evaluate(e,_n(t.randomSeed+Get))),this.needTransform&&Rn.transformQuat(Vet,Vet,this.rotation),Rn.set(n,jet(t.ultimateVelocity.x,Vet.x,this.dampen),jet(t.ultimateVelocity.y,Vet.y,this.dampen),jet(t.ultimateVelocity.z,Vet.z,this.dampen))):(Rn.normalize(n,t.ultimateVelocity),Rn.multiplyScalar(n,n,jet(t.ultimateVelocity.length(),this.limit.evaluate(e,_n(t.randomSeed+Get)),this.dampen))),Rn.copy(t.ultimateVelocity,n)},Z(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(htt),iet=lt((net=fet).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(net.prototype,"enable",[Mtt],Object.getOwnPropertyDescriptor(net.prototype,"enable"),net.prototype),ret=lt(net.prototype,"limitX",[Dtt,xc,Ott,Ntt,Ltt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),oet=lt(net.prototype,"limitY",[Btt,xc,Ftt,ztt,ktt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),aet=lt(net.prototype,"limitZ",[Utt,xc,Gtt,Htt,Vtt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),set=lt(net.prototype,"limit",[Wtt,xc,jtt,qtt,Xtt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),cet=lt(net.prototype,"dampen",[xc,Ytt,Ktt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),uet=lt(net.prototype,"separateAxes",[xc,Qtt,Ztt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),het=lt(net.prototype,"space",[Jtt,xc,$tt,tet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ftt.Local}}),eet=net))||eet);function jet(t,e,n){var i=Math.sign(t),r=Math.abs(t);return r>e&&(r=ln(r,e,n)),r*i}var qet,Xet,Yet,Ket,Qet,Zet,Jet,$et,tnt,ent,nnt,int,rnt,ont,ant,snt,cnt,lnt,unt,hnt,fnt,pnt,dnt,_nt,mnt,vnt,gnt,ynt,xnt,Snt,Tnt,Ent,bnt,Cnt,Ant,wnt,Rnt,Pnt,Int,Mnt,Dnt,Ont,Nnt,Lnt,Bnt,Fnt,znt,knt,Unt,Gnt,Hnt,Vnt,Wnt,jnt,qnt,Xnt,Ynt,Knt,Qnt,Znt,Jnt,$nt,tit,eit,nit,iit,rit,oit,ait,sit,cit,lit,uit,hit,fit,pit,dit,_it,mit,vit,git,yit,xit,Sit,Tit,Eit,bit,Cit,Ait,wit,Rit,Pit,Iit,Mit,Dit,Oit,Nit,Lit,Bit,Fit,zit,kit,Uit,Git,Hit,Vit,Wit,jit,qit,Xit,Yit,Kit,Qit,Zit,Jit,$it,trt,ert,nrt,irt,rrt,ort,art,srt,crt,lrt,urt,hrt,frt,prt,drt,_rt,mrt,vrt,grt,yrt,xrt,Srt,Trt,Ert,brt,Crt,Art,wrt,Rrt,Prt,Irt,Mrt,Drt,Ort,Nrt,Lrt,Brt,Frt,zrt,krt,Urt,Grt,Hrt,Vrt,Wrt,jrt,qrt,Xrt,Yrt,Krt,Qrt,Zrt,Jrt,$rt,tot,eot,not,iot,rot,oot,aot,sot,cot,lot,uot,hot,fot=(pet=dc("cc.RotationOvertimeModule"),det=Gc(),_et=Gc(),met=Lc(),vet=Kc(u7),get=Bc(),yet=Gc(),xet=Lc(),Tet=Kc(u7),Eet=Bc(),bet=Gc(),Cet=Lc(),Aet=Kc(u7),wet=Bc(),Ret=Gc(),Pet=Lc(),pet((Fet=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_enable",Det,ot(e)),ct(e,"_separateAxes",Oet,ot(e)),ct(e,"x",Net,ot(e)),ct(e,"y",Let,ot(e)),ct(e,"z",Bet,ot(e)),e.name=att,e._startMat=new Vn,e._matRot=new Vn,e._quatRot=new Ln,e._otherEuler=new Rn,e}$(e,t);var n=e.prototype;return n._processRotation=function(t){var e=t.particleSystem.processor.getInfo().renderMode;e!==_tt.Mesh&&e===_tt.StrecthedBillboard&&this._quatRot.set(0,0,0,1),Ln.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=b9.INDENTIFY_NEG_QUAT)},n.animate=function(t,e){var n=1-t.remainingLifetime/t.startLifetime,i=_n(t.randomSeed+125292),r=t.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==_tt.VerticalBillboard&&r!==_tt.HorizontalBillboard?Ln.fromEuler(t.deltaQuat,this.x.evaluate(n,i)*e*b9.R2D,this.y.evaluate(n,i)*e*b9.R2D,this.z.evaluate(n,i)*e*b9.R2D):Ln.fromEuler(t.deltaQuat,0,0,this.z.evaluate(n,i)*e*b9.R2D),t.deltaMat=Vn.fromQuat(t.deltaMat,t.deltaQuat),t.localMat=t.localMat.multiply(t.deltaMat),t.startRotated||(r!==_tt.Mesh&&(r===_tt.StrecthedBillboard?t.startEuler.set(0,0,0):r!==_tt.Billboard&&t.startEuler.set(0,0,t.startEuler.z)),Ln.fromEuler(t.startRotation,t.startEuler.x*b9.R2D,t.startEuler.y*b9.R2D,t.startEuler.z*b9.R2D),t.startRotated=!0),this._startMat=Vn.fromQuat(this._startMat,t.startRotation),this._matRot=this._startMat.multiply(t.localMat),Vn.getRotation(this._quatRot,this._matRot),this._processRotation(t,b9.R2D),t.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},Z(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(t){this._separateAxes=t}}]),e}(htt),Det=lt((Met=Fet).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(Met.prototype,"enable",[det],Object.getOwnPropertyDescriptor(Met.prototype,"enable"),Met.prototype),Oet=lt(Met.prototype,"_separateAxes",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(Met.prototype,"separateAxes",[_et,met],Object.getOwnPropertyDescriptor(Met.prototype,"separateAxes"),Met.prototype),Net=lt(Met.prototype,"x",[vet,xc,get,Hc,yet,xet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Let=lt(Met.prototype,"y",[Tet,xc,Eet,Hc,bet,Cet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Bet=lt(Met.prototype,"z",[Aet,xc,wet,Hc,Ret,Pet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Iet=Met))||Iet),pot=(qet=dc("cc.SizeOvertimeModule"),Xet=Gc(),Yet=Gc(),Ket=Lc(),Qet=Kc(u7),Zet=Bc(),Jet=Gc(),$et=Lc(),tnt=Kc(u7),ent=Bc(),nnt=Gc(),int=Lc(),rnt=Kc(u7),ont=Bc(),ant=Gc(),snt=Lc(),cnt=Kc(u7),lnt=Bc(),unt=Gc(),hnt=Lc(),qet((xnt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_enable",dnt,ot(e)),ct(e,"separateAxes",_nt,ot(e)),ct(e,"size",mnt,ot(e)),ct(e,"x",vnt,ot(e)),ct(e,"y",gnt,ot(e)),ct(e,"z",ynt,ot(e)),e.name=stt,e}return $(e,t),e.prototype.animate=function(t){if(this.separateAxes){var e=1-t.remainingLifetime/t.startLifetime,n=_n(t.randomSeed+39825);t.size.x=t.startSize.x*this.x.evaluate(e,n),t.size.y=t.startSize.y*this.y.evaluate(e,n),t.size.z=t.startSize.z*this.z.evaluate(e,n)}else Rn.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,_n(t.randomSeed+39825)))},Z(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(htt),dnt=lt((pnt=xnt).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(pnt.prototype,"enable",[Xet],Object.getOwnPropertyDescriptor(pnt.prototype,"enable"),pnt.prototype),_nt=lt(pnt.prototype,"separateAxes",[xc,Yet,Ket],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mnt=lt(pnt.prototype,"size",[Qet,xc,Zet,Jet,$et],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),vnt=lt(pnt.prototype,"x",[tnt,xc,ent,nnt,int],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),gnt=lt(pnt.prototype,"y",[rnt,xc,ont,ant,snt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),ynt=lt(pnt.prototype,"z",[cnt,xc,lnt,unt,hnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),fnt=pnt))||fnt),dot=90794,_ot=oe({Grid:0}),mot=oe({WholeSheet:0,SingleRow:1}),vot=(Snt=dc("cc.TextureAnimationModule"),Tnt=Sc("numTilesX"),Ent=Sc("numTilesY"),bnt=Gc(),Cnt=Kc(_ot),Ant=Kc(_ot),wnt=Gc(),Rnt=Lc(),Pnt=Gc(),Int=Lc(),Mnt=Gc(),Dnt=Lc(),Ont=Kc(mot),Nnt=Gc(),Lnt=Lc(),Bnt=Kc(u7),Fnt=Bc(),znt=Gc(),knt=Lc(),Unt=Kc(u7),Gnt=Bc(),Hnt=Gc(),Vnt=Lc(),Wnt=Gc(),jnt=Lc(),qnt=Gc(),Xnt=Lc(),Ynt=Gc(),Knt=Lc(),Snt((hit=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_enable",Jnt,ot(e)),ct(e,"_numTilesX",$nt,ot(e)),ct(e,"_numTilesY",tit,ot(e)),ct(e,"_mode",eit,ot(e)),ct(e,"animation",nit,ot(e)),ct(e,"frameOverTime",iit,ot(e)),ct(e,"startFrame",rit,ot(e)),ct(e,"cycleCount",oit,ot(e)),ct(e,"_flipU",ait,ot(e)),ct(e,"_flipV",sit,ot(e)),ct(e,"_uvChannelMask",cit,ot(e)),ct(e,"randomRow",lit,ot(e)),ct(e,"rowIndex",uit,ot(e)),e.name=ctt,e}$(e,t);var n=e.prototype;return n.init=function(t){t.startRow=Math.floor(Math.random()*this.numTilesY)},n.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,n=this.startFrame.evaluate(e,_n(t.randomSeed+dot))/(this.numTilesX*this.numTilesY);if(this.animation===mot.WholeSheet)t.frameIndex=yn(this.cycleCount*(this.frameOverTime.evaluate(e,_n(t.randomSeed+dot))+n),1);else if(this.animation===mot.SingleRow){var i=1/this.numTilesY;if(this.randomRow){var r=yn(this.cycleCount*(this.frameOverTime.evaluate(e,_n(t.randomSeed+dot))+n),1),o=t.startRow*i,a=o+i;t.frameIndex=ln(o,a,r)}else{var s=this.rowIndex*i,c=s+i;t.frameIndex=ln(s,c,yn(this.cycleCount*(this.frameOverTime.evaluate(e,_n(t.randomSeed+dot))+n),1))}}},Z(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}},{key:"mode",get:function(){return this._mode},set:function(t){t!==_ot.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}(htt),Jnt=lt((Znt=hit).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$nt=lt(Znt.prototype,"_numTilesX",[Tnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tit=lt(Znt.prototype,"_numTilesY",[Ent],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(Znt.prototype,"enable",[bnt],Object.getOwnPropertyDescriptor(Znt.prototype,"enable"),Znt.prototype),eit=lt(Znt.prototype,"_mode",[Cnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _ot.Grid}}),lt(Znt.prototype,"mode",[Ant,wnt,Rnt],Object.getOwnPropertyDescriptor(Znt.prototype,"mode"),Znt.prototype),lt(Znt.prototype,"numTilesX",[Pnt,Int],Object.getOwnPropertyDescriptor(Znt.prototype,"numTilesX"),Znt.prototype),lt(Znt.prototype,"numTilesY",[Mnt,Dnt],Object.getOwnPropertyDescriptor(Znt.prototype,"numTilesY"),Znt.prototype),nit=lt(Znt.prototype,"animation",[Ont,xc,Nnt,Lnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mot.WholeSheet}}),iit=lt(Znt.prototype,"frameOverTime",[Bnt,xc,Fnt,znt,knt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),rit=lt(Znt.prototype,"startFrame",[Unt,xc,Gnt,Hnt,Vnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),oit=lt(Znt.prototype,"cycleCount",[xc,Wnt,jnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ait=lt(Znt.prototype,"_flipU",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sit=lt(Znt.prototype,"_flipV",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cit=lt(Znt.prototype,"_uvChannelMask",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),lit=lt(Znt.prototype,"randomRow",[xc,qnt,Xnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uit=lt(Znt.prototype,"rowIndex",[xc,Ynt,Knt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qnt=Znt))||Qnt),got=197866,yot=new Rn,xot=(fit=dc("cc.VelocityOvertimeModule"),pit=Gc(),dit=Kc(u7),_it=Bc(),mit=Gc(),vit=Lc(),git=Kc(u7),yit=Bc(),xit=Gc(),Sit=Lc(),Tit=Kc(u7),Eit=Bc(),bit=Gc(),Cit=Lc(),Ait=Kc(u7),wit=Bc(),Rit=Gc(),Pit=Lc(),Iit=Kc(ftt),Mit=Gc(),Dit=Lc(),fit((Git=function(t){function e(){var e;return ct(e=t.call(this)||this,"_enable",Lit,ot(e)),ct(e,"x",Bit,ot(e)),ct(e,"y",Fit,ot(e)),ct(e,"z",zit,ot(e)),ct(e,"speedModifier",kit,ot(e)),ct(e,"space",Uit,ot(e)),e.rotation=void 0,e.needTransform=void 0,e.name="velocityModule",e.rotation=new Ln,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}$(e,t);var n=e.prototype;return n.update=function(t,e){this.needTransform=Ett(t,this.space,e,this.rotation)},n.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,n=Rn.set(yot,this.x.evaluate(e,_n(t.randomSeed^got)),this.y.evaluate(e,_n(156497^t.randomSeed)),this.z.evaluate(e,_n(984136^t.randomSeed)));this.needTransform&&Rn.transformQuat(n,n,this.rotation),Rn.add(t.animatedVelocity,t.animatedVelocity,n),Rn.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),Rn.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,this.speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,_n(t.randomSeed+got)))},Z(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(htt),Lit=lt((Nit=Git).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(Nit.prototype,"enable",[pit],Object.getOwnPropertyDescriptor(Nit.prototype,"enable"),Nit.prototype),Bit=lt(Nit.prototype,"x",[dit,xc,_it,mit,vit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Fit=lt(Nit.prototype,"y",[git,xc,yit,xit,Sit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),zit=lt(Nit.prototype,"z",[Tit,xc,Eit,bit,Cit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),kit=lt(Nit.prototype,"speedModifier",[Ait,xc,wit,Rit,Pit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Uit=lt(Nit.prototype,"space",[Iit,xc,Mit,Dit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ftt.Local}}),Oit=Nit))||Oit),Sot=t("Burst",(Hit=dc("cc.Burst"),Vit=Kc(u7),Wit=Bc(),Hit((Zit=function(){function t(){ct(this,"_time",Xit,this),ct(this,"_repeatCount",Yit,this),ct(this,"repeatInterval",Kit,this),ct(this,"count",Qit,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var e=t.prototype;return e.update=function(t,e){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var n=yn(t._time-t.startDelay.evaluate(0,1),t.duration)-e;n=n>0?n:0;var i=yn(t.time-t.startDelay.evaluate(0,1),t.duration);this._curTime>=n&&this._curTime<i&&(t.emit(this.count.evaluate(this._curTime/t.duration,1),e-(i-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},e.reset=function(){this._remainingCount=0,this._curTime=0},e.getMaxCount=function(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)},Z(t,[{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._curTime=t}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t,this._remainingCount=t}}]),t}(),Xit=lt((qit=Zit).prototype,"_time",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(qit.prototype,"time",[Mc],Object.getOwnPropertyDescriptor(qit.prototype,"time"),qit.prototype),Yit=lt(qit.prototype,"_repeatCount",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt(qit.prototype,"repeatCount",[Mc],Object.getOwnPropertyDescriptor(qit.prototype,"repeatCount"),qit.prototype),Kit=lt(qit.prototype,"repeatInterval",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Qit=lt(qit.prototype,"count",[Vit,xc,Wit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),jit=qit))||jit)),Tot=new Rn(0,0,0),Eot=[],bot=new Rn(.5,.5,.5),Cot=(Jit=dc("cc.ShapeModule"),$it=Gc(),trt=Lc(),ert=Gc(),nrt=Lc(),irt=Gc(),rrt=Lc(),ort=Gc(),art=Lc(),srt=Gc(),crt=Lc(),lrt=Gc(),urt=Kc(mtt),hrt=Sc("shapeType"),frt=Gc(),prt=Kc(mtt),drt=Lc(),_rt=Kc(vtt),mrt=Gc(),vrt=Lc(),grt=Gc(),yrt=Lc(),xrt=Gc(),Srt=Lc(),Trt=Gc(),Ert=Lc(),brt=Gc(),Crt=Lc(),Art=Gc(),wrt=Lc(),Rrt=Gc(),Prt=Lc(),Irt=Kc(gtt),Mrt=Gc(),Drt=Lc(),Ort=Dc(),Nrt=Gc(),Lrt=Lc(),Brt=Kc(u7),Frt=Dc(),zrt=Bc(),krt=Gc(),Urt=Lc(),Grt=Gc(),Hrt=Lc(),Vrt=Gc(),Wrt=Lc(),Jit((lt((qrt=function(){function t(){ct(this,"_enable",Xrt,this),ct(this,"_shapeType",Yrt,this),ct(this,"emitFrom",Krt,this),ct(this,"alignToDirection",Qrt,this),ct(this,"randomDirectionAmount",Zrt,this),ct(this,"sphericalDirectionAmount",Jrt,this),ct(this,"randomPositionAmount",$rt,this),ct(this,"radius",tot,this),ct(this,"radiusThickness",eot,this),ct(this,"arcMode",not,this),ct(this,"arcSpread",iot,this),ct(this,"arcSpeed",rot,this),ct(this,"length",oot,this),ct(this,"boxThickness",aot,this),ct(this,"_position",sot,this),ct(this,"_rotation",cot,this),ct(this,"_scale",lot,this),ct(this,"_arc",uot,this),ct(this,"_angle",hot,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Vn,this.quat=new Ln,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var e=t.prototype;return e.onInit=function(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem._time},e.emit=function(t){switch(this.shapeType){case mtt.Box:!function(t,e,n,i){switch(t){case vtt.Volume:r=n,o=bot,Rn.set(r,pn(-o.x,o.x),pn(-o.y,o.y),pn(-o.z,o.z));break;case vtt.Shell:Eot.splice(0,Eot.length),Eot.push(pn(-.5,.5)),Eot.push(pn(-.5,.5)),Eot.push(.5*Ptt()),Rtt(Eot),Aot(Eot,e),Rn.set(n,Eot[0],Eot[1],Eot[2]);break;case vtt.Edge:Eot.splice(0,Eot.length),Eot.push(pn(-.5,.5)),Eot.push(.5*Ptt()),Eot.push(.5*Ptt()),Rtt(Eot),Aot(Eot,e),Rn.set(n,Eot[0],Eot[1],Eot[2]);break;default:console.warn(t+" is not supported for box emitter.")}var r,o;Rn.copy(i,Ttt)}(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case mtt.Circle:!function(t,e,n,i,r){wtt(i,t*(1-e),t,n),Rn.normalize(r,i)}(this.radius,this.radiusThickness,this.generateArcAngle(),t.position,t.velocity);break;case mtt.Cone:!function(t,e,n,i,r,o,a,s){switch(t){case vtt.Base:wtt(a,e*(1-n),e,i),Xn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*e,Rn.normalize(s,s),a.z=0;break;case vtt.Shell:btt(a,i),Xn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r),Rn.normalize(s,s),Xn.multiplyScalar(a,a,e),a.z=0;break;case vtt.Volume:wtt(a,e*(1-n),e,i),Xn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*e,Rn.normalize(s,s),a.z=0,Rn.add(a,a,Rn.multiplyScalar(Tot,s,o*fn()/-s.z));break;default:console.warn(t+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case mtt.Sphere:!function(t,e,n,i,r){switch(t){case vtt.Volume:Att(i,e*(1-n),e),Rn.normalize(r,i);break;case vtt.Shell:Ctt(i),Rn.multiplyScalar(i,i,e),Rn.normalize(r,i);break;default:console.warn(t+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case mtt.Hemisphere:!function(t,e,n,i,r){switch(t){case vtt.Volume:Att(i,e*(1-n),e),i.z>0&&(i.z*=-1),Rn.normalize(r,i);break;case vtt.Shell:Ctt(i),Rn.multiplyScalar(i,i,e),i.z>0&&(i.z*=-1),Rn.normalize(r,i);break;default:console.warn(t+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(t.position.x+=pn(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=pn(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=pn(-this.randomPositionAmount,this.randomPositionAmount)),Rn.transformQuat(t.velocity,t.velocity,this.quat),Rn.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){var e=Rn.normalize(Tot,t.position);Rn.lerp(t.velocity,t.velocity,e,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},e.constructMat=function(){Ln.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Vn.fromRTS(this.mat,this.quat,this._position,this._scale)},e.generateArcAngle=function(){if(this.arcMode===gtt.Random)return pn(0,this._arc);var t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case gtt.Loop:return yn(t,this._arc);case gtt.PingPong:return xn(t,this._arc);default:return yn(t,this._arc)}},Z(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation=t,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(t){this._scale=t,this.constructMat()}},{key:"arc",get:function(){return hn(this._arc)},set:function(t){this._arc=un(t)}},{key:"angle",get:function(){return Math.round(100*hn(this._angle))/100},set:function(t){this._angle=un(t)}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"shapeType",get:function(){return this._shapeType},set:function(t){switch(this._shapeType=t,this._shapeType){case mtt.Box:this.emitFrom===vtt.Base&&(this.emitFrom=vtt.Volume);break;case mtt.Cone:this.emitFrom===vtt.Edge&&(this.emitFrom=vtt.Base);break;case mtt.Sphere:case mtt.Hemisphere:this.emitFrom!==vtt.Base&&this.emitFrom!==vtt.Edge||(this.emitFrom=vtt.Volume)}}}]),t}()).prototype,"position",[$it,trt],Object.getOwnPropertyDescriptor(qrt.prototype,"position"),qrt.prototype),lt(qrt.prototype,"rotation",[ert,nrt],Object.getOwnPropertyDescriptor(qrt.prototype,"rotation"),qrt.prototype),lt(qrt.prototype,"scale",[irt,rrt],Object.getOwnPropertyDescriptor(qrt.prototype,"scale"),qrt.prototype),lt(qrt.prototype,"arc",[ort,art],Object.getOwnPropertyDescriptor(qrt.prototype,"arc"),qrt.prototype),lt(qrt.prototype,"angle",[srt,crt],Object.getOwnPropertyDescriptor(qrt.prototype,"angle"),qrt.prototype),Xrt=lt(qrt.prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(qrt.prototype,"enable",[lrt],Object.getOwnPropertyDescriptor(qrt.prototype,"enable"),qrt.prototype),Yrt=lt(qrt.prototype,"_shapeType",[urt,hrt,frt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mtt.Cone}}),lt(qrt.prototype,"shapeType",[prt,drt],Object.getOwnPropertyDescriptor(qrt.prototype,"shapeType"),qrt.prototype),Krt=lt(qrt.prototype,"emitFrom",[_rt,xc,mrt,vrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vtt.Volume}}),Qrt=lt(qrt.prototype,"alignToDirection",[xc,grt,yrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zrt=lt(qrt.prototype,"randomDirectionAmount",[xc,xrt,Srt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jrt=lt(qrt.prototype,"sphericalDirectionAmount",[xc,Trt,Ert],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$rt=lt(qrt.prototype,"randomPositionAmount",[xc,brt,Crt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tot=lt(qrt.prototype,"radius",[xc,Art,wrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),eot=lt(qrt.prototype,"radiusThickness",[xc,Rrt,Prt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),not=lt(qrt.prototype,"arcMode",[Irt,xc,Mrt,Drt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gtt.Random}}),iot=lt(qrt.prototype,"arcSpread",[Ort,xc,Nrt,Lrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rot=lt(qrt.prototype,"arcSpeed",[Brt,Frt,zrt,xc,krt,Urt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),oot=lt(qrt.prototype,"length",[xc,Grt,Hrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),aot=lt(qrt.prototype,"boxThickness",[xc,Vrt,Wrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(0,0,0)}}),sot=lt(qrt.prototype,"_position",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(0,0,0)}}),cot=lt(qrt.prototype,"_rotation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(0,0,0)}}),lot=lt(qrt.prototype,"_scale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(1,1,1)}}),uot=lt(qrt.prototype,"_arc",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return un(360)}}),hot=lt(qrt.prototype,"_angle",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return un(25)}}),jrt=qrt))||jrt);function Aot(t,e){e.x>0&&(t[0]+=.5*pn(-e.x,e.x),t[0]=sn(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*pn(-e.y,e.y),t[1]=sn(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*pn(-e.z,e.z),t[2]=sn(t[2],-.5,.5))}var wot,Rot,Pot,Iot,Mot,Dot,Oot,Not,Lot,Bot,Fot,zot,kot,Uot,Got,Hot,Vot,Wot,jot,qot,Xot,Yot,Kot,Qot,Zot,Jot,$ot,tat,eat,nat,iat,rat,oat,aat,sat=[0,0,1,0,0,1,1,1],cat=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertAttrs=void 0,e._vertSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._material=null,e.type=tT.PARTICLE_BATCH,e._capacity=0,e._vertAttrs=null,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=new _r([new pr]),e._iaInfoBuffer=e._device.createBuffer(new hr(_i.INDIRECT,gi.HOST|gi.DEVICE,no,no)),e._subMeshData=null,e._mesh=null,e}$(e,t);var n=e.prototype;return n.setCapacity=function(t){var e=this._capacity!==t;this._capacity=t,this._subMeshData&&e&&this.rebuild()},n.setVertexAttributes=function(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertSize=0;for(var n,i=st(this._vertAttrs);!(n=i()).done;){var r=n.value;r.offset=this._vertSize,this._vertSize+=Jr[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},n.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh&&this._capacity>0){var n=this._vertAttrs[this._vertAttrs.findIndex((function(t){return t.name===Ki.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,Ki.ATTR_TEX_COORD,e,this._vertSize,n);var i=this._vertAttrs.findIndex((function(t){return t.name===Ki.ATTR_TEX_COORD3}));if(n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Ki.ATTR_POSITION,e,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Ki.ATTR_NORMAL,e,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,Ki.ATTR_COLOR,e,this._vertSize,n))for(var r=new Uint32Array(e),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+n/4]=An.WHITE._val;for(var a=new Float32Array(e),s=1;s<this._capacity;s++)a.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}t.update(e);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,f=0;f<this._capacity;++f){var p=4*f;c[h++]=p,c[h++]=p+1,c[h++]=p+2,c[h++]=p+3,c[h++]=p+2,c[h++]=p+1}var d=this._device.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return d.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new hr(_i.INDIRECT,gi.HOST|gi.DEVICE,no,no))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new GA([t],this._vertAttrs,Fi.TRIANGLE_LIST,d,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},n.updateMaterial=function(t){this._material=t,this.setSubModelMaterial(0,t)},n.addParticleVertexData=function(t,e){if(this._mesh)for(var n=0;n<this._vertCount;n++){var i=(t*this._vertCount+n)*this._vertAttrsFloatCount;this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,i+=2,this._vdataF32[i++]=e[1].z,this._vdataF32[i++]=e[2].x,this._vdataF32[i++]=e[2].y,this._vdataF32[i++]=e[2].z,this._vdataF32[i++]=e[3].x,this._vdataF32[i++]=e[3].y,this._vdataF32[i++]=e[3].z,this._vdataUint32[i++]=e[4]}else{var r=t*this._vertAttrsFloatCount;this._vdataF32[r++]=e[0].x,this._vdataF32[r++]=e[0].y,this._vdataF32[r++]=e[0].z,this._vdataF32[r++]=e[1].x,this._vdataF32[r++]=e[1].y,this._vdataF32[r++]=e[1].z,this._vdataF32[r++]=e[2].x,this._vdataF32[r++]=e[2].y,this._vdataF32[r++]=e[2].z,this._vdataF32[r++]=e[3].x,this._vdataF32[r++]=e[3].y,this._vdataF32[r++]=e[3].z,this._vdataUint32[r++]=e[4],e[5]&&(this._vdataF32[r++]=e[5].x,this._vdataF32[r++]=e[5].y,this._vdataF32[r++]=e[5].z)}},n.addGPUParticleVertexData=function(t,e,n){for(var i=e*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var o=i;this._vdataF32[o++]=t.position.x,this._vdataF32[o++]=t.position.y,this._vdataF32[o++]=t.position.z,this._vdataF32[o++]=n,this._vdataF32[o++]=t.startSize.x,this._vdataF32[o++]=t.startSize.y,this._vdataF32[o++]=t.startSize.z,this._vdataF32[o++]=sat[2*r],this._vdataF32[o++]=t.rotation.x,this._vdataF32[o++]=t.rotation.y,this._vdataF32[o++]=t.rotation.z,this._vdataF32[o++]=sat[2*r+1],this._vdataF32[o++]=t.startColor.r/255,this._vdataF32[o++]=t.startColor.g/255,this._vdataF32[o++]=t.startColor.b/255,this._vdataF32[o++]=t.startColor.a/255,this._vdataF32[o++]=t.velocity.x,this._vdataF32[o++]=t.velocity.y,this._vdataF32[o++]=t.velocity.z,this._vdataF32[o++]=t.startLifetime,this._vdataF32[o++]=t.randomSeed,i+=this._vertAttrsFloatCount}},n.updateGPUParticles=function(t,e,n){for(var i=this._vertAttrsFloatCount*this._vertCount,r=0,o=0,a=0,s=0;s<t;++s)r=s*i,o=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(e-o)<n&&(a=--t*i,this._vdataF32.copyWithin(r,a,a+i),s--);return t},n.constructAttributeIndex=function(){if(this._vertAttrs){var t=this._vertAttrs.findIndex((function(t){return"a_position_starttime"===t.name})),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((function(t){return"a_dir_life"===t.name})),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}},n.updateIA=function(t){t<=0||(this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo))},n.clear=function(){this._subModels[0].inputAssembler.indexCount=0},n.destroy=function(){t.prototype.destroy.call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},n.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},e}(cT),lat=function(){function t(t){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=t}var e=t.prototype;return e.getInfo=function(){return this._renderInfo},e.onInit=function(t){this._particleSystem=t},e.onEnable=function(){if(this._particleSystem){this.attachToScene();var t=this._model;t&&(t.node=t.transform=this._particleSystem.node)}},e.onDisable=function(){this.detachFromScene()},e.onDestroy=function(){this._model&&(u.director.root.destroyModel(this._model),this._model=null)},e.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},e.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===_tt.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},e.clear=function(){this._model&&(this._model.enabled=!1)},e.getModel=function(){return this._model},e._initModel=function(){this._model||(this._model=u.director.root.createModel(cat),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},e.updateTrailMaterial=function(){},e.getDefaultTrailMaterial=function(){return null},t}(),uat=new Rn,hat=new Vn,fat=new Ln,pat=(new Rn,["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"]),dat=[0,0,1,0,0,1,1,1],_at=[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD1,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD2,fi.RGB32F),new Rr(Ki.ATTR_COLOR,fi.RGBA8,!0)],mat=[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD1,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD2,fi.RGB32F),new Rr(Ki.ATTR_COLOR,fi.RGBA8,!0),new Rr(Ki.ATTR_COLOR1,fi.RGB32F)],vat=[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD1,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD2,fi.RGB32F),new Rr(Ki.ATTR_COLOR,fi.RGBA8,!0),new Rr(Ki.ATTR_TEX_COORD3,fi.RGB32F),new Rr(Ki.ATTR_NORMAL,fi.RGB32F),new Rr(Ki.ATTR_COLOR1,fi.RGBA8,!0)],gat={parent:null,owner:null,subModelIdx:0},yat=function(t){function e(e){var n;return(n=t.call(this,e)||this)._defines=void 0,n._trailDefines=void 0,n._frameTile_velLenScale=void 0,n._tmp_velLenScale=void 0,n._defaultMat=null,n._node_scale=void 0,n._attrs=void 0,n._particles=null,n._defaultTrailMat=null,n._updateList=new Map,n._animateList=new Map,n._runAnimateList=new Array,n._fillDataFunc=null,n._uScaleHandle=0,n._uLenHandle=0,n._uNodeRotHandle=0,n._alignSpace=dtt.View,n._inited=!1,n._localMat=new Vn,n._gravity=new Zn,n._model=null,n._frameTile_velLenScale=new Zn(1,1,0,0),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new Zn,n._attrs=new Array(5),n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},n._trailDefines={CC_USE_WORLD_SPACE:!0},n}$(e,t);var n=e.prototype;return n.onInit=function(e){var n=this;t.prototype.onInit.call(this,e),this._particles=new jl((function(){return new b9(n)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},n.clear=function(){t.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},n.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},n.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},n.getDefaultTrailMaterial=function(){return this._defaultTrailMat},n.setNewParticle=function(){},n._initModuleList=function(){var t=this;pat.forEach((function(e){var n=t._particleSystem[e];n&&n.enable&&(n.needUpdate&&(t._updateList[n.name]=n),n.needAnimate&&(t._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var e=0,n=ltt.length;e<n;e++){var i=this._animateList[ltt[e]];i&&this._runAnimateList.push(i)}},n.enableModule=function(t,e,n){e?(n.needUpdate&&(this._updateList[n.name]=n),n.needAnimate&&(this._animateList[n.name]=n)):(delete this._animateList[t],delete this._updateList[t]),this._runAnimateList.length=0;for(var i=0,r=ltt.length;i<r;i++){var o=this._animateList[ltt[i]];o&&this._runAnimateList.push(o)}this.updateMaterialParams()},n.updateAlignSpace=function(t){this._alignSpace=t},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(t){t&&this.doUpdateRotation(t)},n.doUpdateRotation=function(t){if(this._renderInfo.renderMode===_tt.Mesh||this._alignSpace!==dtt.View){if(this._alignSpace===dtt.Local)this._particleSystem.node.getRotation(fat);else if(this._alignSpace===dtt.World)this._particleSystem.node.getWorldRotation(fat);else if(this._alignSpace===dtt.View){var e;fat.set(0,0,0,1);var n=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Ln.fromViewUp(fat,r.forward);break}}}else fat.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,fat)}},n.updateScale=function(t){t&&this.doUpdateScale(t)},n.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case ftt.Local:this._particleSystem.node.getScale(this._node_scale);break;case ftt.World:this._particleSystem.node.getWorldScale(this._node_scale)}t.setUniform(this._uScaleHandle,this._node_scale)},n.updateParticles=function(t){var e=this,n=this._particleSystem;if(!n)return this._particles.length;n.node.getWorldMatrix(hat);var i=(n.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(i),this.doUpdateRotation(i),this._updateList.forEach((function(t){t.update(n._simulationSpace,hat)}));var r=n._trailModule,o=r&&r.enable;if(o&&r.update(),n.simulationSpace===ftt.Local){var a=n.node.getRotation();Vn.fromQuat(this._localMat,a),this._localMat.transpose()}for(var s=function(i){var a=e._particles.data[i];if(a.remainingLifetime-=t,Rn.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return o&&r.removeParticle(a),e._particles.removeAt(i),--i,c=i,"continue";if(n.simulationSpace===ftt.Local){var s=9.8*-n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,_n(a.randomSeed))*t;e._gravity.x=0,e._gravity.y=s,e._gravity.z=0,e._gravity.w=1,e._gravity=e._gravity.transformMat4(e._localMat),a.velocity.x+=e._gravity.x,a.velocity.y+=e._gravity.y,a.velocity.z+=e._gravity.z}else a.velocity.y-=9.8*n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,_n(a.randomSeed))*t;Rn.copy(a.ultimateVelocity,a.velocity),e._runAnimateList.forEach((function(e){e.animate(a,t)})),Rn.scaleAndAdd(a.position,a.position,a.ultimateVelocity,t),o&&r.animate(a,t),c=i},c=0;c<this._particles.length;++c)s(c);return this._model.enabled=this._particles.length>0,this._particles.length},n.updateRenderData=function(){for(var t=0,e=0;e<this._particles.length;++e){var n=this._particles.data[e],i=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(i=n.frameIndex),t=4*e,this._fillDataFunc(n,t,i)}},n.beforeRender=function(){this._model.updateIA(this._particles.length)},n.getParticleCount=function(){return this._particles.length},n.onMaterialModified=function(t){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())},n.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);var n=this._particleSystem._trailModule;n&&n._trailModel&&1===t&&n._trailModel.setSubModelMaterial(0,e)},n._setFillFunc=function(){this._renderInfo.renderMode===_tt.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===_tt.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},n._fillMeshData=function(t,e,n){var i=e/4;this._attrs[0]=t.position,uat.z=n,this._attrs[1]=uat,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._model.addParticleVertexData(i,this._attrs)},n._fillStrecthedData=function(t,e,n){for(var i=0;i<4;++i)this._attrs[0]=t.position,uat.x=dat[2*i],uat.y=dat[2*i+1],uat.z=n,this._attrs[1]=uat,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=t.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(e++,this._attrs)},n._fillNormalData=function(t,e,n){for(var i=0;i<4;++i)this._attrs[0]=t.position,uat.x=dat[2*i],uat.y=dat[2*i+1],uat.z=n,this._attrs[1]=uat,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=null,this._model.addParticleVertexData(e++,this._attrs)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case _tt.StrecthedBillboard:this._vertAttrs=mat.slice();break;case _tt.Mesh:this._vertAttrs=vat.slice();break;default:this._vertAttrs=_at.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!=e){var n=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1!==n.indexOf("particle")&&-1===n.indexOf("particle-gpu")||t.setMaterial(null,0)}null==t.sharedMaterial&&null==this._defaultMat&&(gat.parent=Dv.get("default-particle-material"),gat.owner=this._particleSystem,gat.subModelIdx=0,this._defaultMat=new mT(gat),gat.parent=null,gat.owner=null,gat.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t._simulationSpace===ftt.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=i.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=r.getHandle("nodeRotation");var o=this._renderInfo.renderMode,a=this._frameTile_velLenScale;o===_tt.Billboard?this._defines.CC_RENDER_MODE=0:o===_tt.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,a.z=this._renderInfo.velocityScale,a.w=this._renderInfo.lengthScale):o===_tt.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:o===_tt.VerticalBillboard?this._defines.CC_RENDER_MODE=3:o===_tt.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+o+" not support.");var s=t._textureAnimationModule;s&&s.enable?(Zn.copy(this._tmp_velLenScale,a),Xn.set(this._tmp_velLenScale,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,this._tmp_velLenScale)):r.setUniform(this._uLenHandle,a);var c,l=this._particleSystem._rotationOvertimeModule;c=l&&l.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=c,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},n.updateTrailMaterial=function(){if(this._particleSystem){var t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===ftt.World||e.space===ftt.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var n=t.getMaterialInstance(1);null===n&&null===this._defaultTrailMat&&(gat.parent=Dv.get("default-trail-material"),gat.owner=this._particleSystem,gat.subModelIdx=1,this._defaultTrailMat=new mT(gat),gat.parent=null,gat.owner=null,gat.subModelIdx=0),(n=n||this._defaultTrailMat).recompileShaders(this._trailDefines),e.updateMaterial()}}},e}(lat),xat=new Vn,Sat=new Zn,Tat=new Ln,Eat=new Ln,bat=(new Rn,32),Cat="a_position_starttime",Aat="a_size_uv",wat="a_rotation_uv",Rat="a_color",Pat="a_dir_life",Iat="a_rndSeed",Mat=[new Rr(Cat,fi.RGBA32F),new Rr(Aat,fi.RGBA32F),new Rr(wat,fi.RGBA32F),new Rr(Rat,fi.RGBA32F),new Rr(Pat,fi.RGBA32F),new Rr(Iat,fi.R32F)],Dat=[new Rr(Cat,fi.RGBA32F),new Rr(Aat,fi.RGBA32F),new Rr(wat,fi.RGBA32F),new Rr(Rat,fi.RGBA32F),new Rr(Pat,fi.RGBA32F),new Rr(Iat,fi.R32F),new Rr(Ki.ATTR_TEX_COORD,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD3,fi.RGB32F),new Rr(Ki.ATTR_NORMAL,fi.RGB32F),new Rr(Ki.ATTR_COLOR1,fi.RGBA8,!0)],Oat={parent:null,owner:null,subModelIdx:0},Nat=function(t){function e(e){var n;return(n=t.call(this,e)||this)._defines=void 0,n._frameTile_velLenScale=void 0,n._unifrom_velLenScale=void 0,n._tmp_velLenScale=void 0,n._node_scale=void 0,n._vertAttrs=[],n._defaultMat=null,n._particleNum=0,n._tempParticle=null,n._colorTexture=null,n._forceTexture=null,n._velocityTexture=null,n._rotationTexture=null,n._sizeTexture=null,n._animTexture=null,n._uTimeHandle=0,n._uRotHandle=0,n._uNodeRotHandle=0,n._alignSpace=dtt.View,n._inited=!1,n._frameTile_velLenScale=new Zn(1,1,0,0),n._unifrom_velLenScale=n._frameTile_velLenScale.clone(),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new Zn,n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},n._tempParticle=new b9(null),n._particleNum=0,n}$(e,t);var n=e.prototype;return n.onInit=function(e){t.prototype.onInit.call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},n.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},n.setVertexAttributes=function(){t.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},n.clear=function(){t.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},n.onDestroy=function(){t.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},n.enableModule=function(){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;t&&(this.initShaderUniform(t),t.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,t))},n.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},n.setNewParticle=function(t){this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem._time),this._particleNum++},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(t){t&&this.doUpdateRotation(t)},n.doUpdateRotation=function(t){if(this._renderInfo.renderMode===_tt.Mesh||this._alignSpace!==dtt.View){if(this._alignSpace===dtt.Local)this._particleSystem.node.getRotation(Eat);else if(this._alignSpace===dtt.World)this._particleSystem.node.getWorldRotation(Eat);else if(this._alignSpace===dtt.View){var e;Eat.set(0,0,0,1);var n=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Ln.fromViewUp(Eat,r.forward);break}}}else Eat.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,Eat)}},n.updateScale=function(t){t&&this.doUpdateScale(t)},n.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case ftt.Local:this._particleSystem.node.getScale(this._node_scale);break;case ftt.World:this._particleSystem.node.getWorldScale(this._node_scale)}t.setUniform(t.getHandle("scale"),this._node_scale)},n.updateParticles=function(t){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,t),this.updateShaderUniform(t),this._model.enabled=this._particleNum>0,this._particleNum},n.updateRenderData=function(){},n.beforeRender=function(){this._model.updateIA(this._particleNum)},n.updateAlignSpace=function(t){this._alignSpace=t},n.updateShaderUniform=function(t){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var n=e.passes[0];Sat.x=this._particleSystem._time,Sat.y=t,n.setUniform(this._uTimeHandle,Sat),this._particleSystem.node.getWorldRotation(Tat),n.setUniform(this._uRotHandle,Tat),this.doUpdateRotation(n)}},n.initShaderUniform=function(t){var e=t.passes[0];this._uTimeHandle=e.getHandle("u_timeDelta"),this._uRotHandle=e.getHandle("u_worldRot"),this._uNodeRotHandle=e.getHandle("nodeRotation"),this.doUpdateScale(e),e.setUniform(e.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),Sat.x=bat,Sat.y=.03125,e.setUniform(e.getHandle("u_sampleInfo"),Sat);var n=!1,i=this._particleSystem._forceOvertimeModule;if(n=i&&i.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=n,n){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=d7(bat,i.x,i.y,i.z);var r=e.getHandle("force_over_time_tex0"),o=kv.getBindingFromHandle(r);e.bindSampler(o,this._forceTexture.getGFXSampler()),e.bindTexture(o,this._forceTexture.getGFXTexture());var a=e.getHandle("u_force_space");e.setUniform(a,i.space);var s=e.getHandle("u_force_mode");e.setUniform(s,this._forceTexture.height)}var c=this._particleSystem._velocityOvertimeModule;if(n=c&&c.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=n,n){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(t,e,n,i,r){for(var o=Math.max(f7(e),f7(n),f7(i),f7(r)),a=new Float32Array(t*o*4),s=[e,n,i,r],c=1/(t-1),l=0;l<o;l++)for(var u=0;u<4;u++)for(var h=s[u],f=0,p=0,d=0;d<t;d++){var _=h7(h,c*d,l);p=(f+=_)/(d+1),a[4*d+u]=p}return p7(a,t,o)}(bat,c.x,c.y,c.z,c.speedModifier);var l=e.getHandle("velocity_over_time_tex0"),h=kv.getBindingFromHandle(l);e.bindSampler(h,this._velocityTexture.getGFXSampler()),e.bindTexture(h,this._velocityTexture.getGFXTexture());var f=e.getHandle("u_velocity_space");e.setUniform(f,c.space);var p=e.getHandle("u_velocity_mode");e.setUniform(p,this._velocityTexture.height)}var d=this._particleSystem._colorOverLifetimeModule;if(n=d&&d.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=n,n){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(t,e){for(var n=function(t){switch(t.mode){case g9.TwoColors:case g9.TwoGradients:return 2;default:return 1}}(e),i=new Uint8Array(t*n*4),r=1/(t-1),o=0,a=0;a<n;a++)for(var s=0;s<t;s++){var c=x9(e,r*s,a);i[o]=c.r,i[o+1]=c.g,i[o+2]=c.b,i[o+3]=c.a,o+=4}var l=new Ev;return l.create(t,n,Mm.RGBA8888),l.setFilters(Om.LINEAR,Om.LINEAR),l.setWrapMode(Dm.CLAMP_TO_EDGE,Dm.CLAMP_TO_EDGE),l.uploadData(i),l}(bat,d.color);var _=e.getHandle("color_over_time_tex0"),m=kv.getBindingFromHandle(_);e.bindSampler(m,this._colorTexture.getGFXSampler()),e.bindTexture(m,this._colorTexture.getGFXTexture());var v=e.getHandle("u_color_mode");e.setUniform(v,this._colorTexture.height)}var g=this._particleSystem._rotationOvertimeModule;if(n=g&&g.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=n,n){this._rotationTexture&&this._rotationTexture.destroy(),g.separateAxes?this._rotationTexture=d7(bat,g.x,g.y,g.z):this._rotationTexture=function(t,e){for(var n=f7(e),i=new Float32Array(t*n*4),r=1/(t-1),o=0,a=0;a<n;a++)for(var s=0;s<t;s++){var c=h7(e,r*s,a);i[o+2]=c,o+=4}return p7(i,t,n)}(bat,g.z);var y=e.getHandle("rotation_over_time_tex0"),x=kv.getBindingFromHandle(y);e.bindSampler(x,this._rotationTexture.getGFXSampler()),e.bindTexture(x,this._rotationTexture.getGFXTexture());var S=e.getHandle("u_rotation_mode");e.setUniform(S,this._rotationTexture.height)}var T=this._particleSystem._sizeOvertimeModule;if(n=T&&T.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=n,n){this._sizeTexture&&this._sizeTexture.destroy(),T.separateAxes?this._sizeTexture=d7(bat,T.x,T.y,T.z,!0):this._sizeTexture=function(t,e){for(var n=f7(e),i=new Float32Array(t*n*4),r=1/(t-1),o=0,a=0,s=0;s<n;s++){0;for(var c=0;c<t;c++){var l=h7(e,r*c,s);o=l,i[a]=o,i[a+1]=o,i[a+2]=o,a+=4}}return p7(i,t,n)}(bat,T.size);var E=e.getHandle("size_over_time_tex0"),b=kv.getBindingFromHandle(E);e.bindSampler(b,this._sizeTexture.getGFXSampler()),e.bindTexture(b,this._sizeTexture.getGFXTexture());var C=e.getHandle("u_size_mode");e.setUniform(C,this._sizeTexture.height)}var A=this._particleSystem._textureAnimationModule;if(n=A&&A.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=n,n){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(t,e,n){for(var i=Math.max(f7(e),f7(n)),r=new Float32Array(t*i*4),o=[e,n],a=1/(t-1),s=0;s<i;s++)for(var c=0;c<2;c++)for(var l=o[c],u=0,h=0,f=0;f<t;f++){var p=h7(l,a*f,s);h=(u+=p)/(f+1),r[4*f+c]=h}return p7(r,t,i)}(bat,A.startFrame,A.frameOverTime);var w=e.getHandle("texture_animation_tex0"),R=kv.getBindingFromHandle(w);e.bindSampler(R,this._animTexture.getGFXSampler()),e.bindTexture(R,this._animTexture.getGFXTexture());var P=e.getHandle("u_anim_info");Sat.x=this._animTexture.height,Sat.y=A.numTilesX*A.numTilesY,Sat.z=A.cycleCount,e.setUniform(P,Sat)}this._defines.USE_VK_SHADER=u.game._gfxDevice.gfxAPI===li.VULKAN},n.getParticleCount=function(){return this._particleNum},n.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},n.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case _tt.StrecthedBillboard:this._vertAttrs=Mat.slice();break;case _tt.Mesh:this._vertAttrs=Dat.slice();break;default:this._vertAttrs=Mat.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!==e){var n=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1===n.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==t.sharedMaterial&&null==this._defaultMat&&(Oat.parent=Dv.get("default-particle-gpu-material"),Oat.owner=t,Oat.subModelIdx=0,this._defaultMat=new mT(Oat),Oat.parent=null,Oat.owner=null,Oat.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t.node.getWorldMatrix(xat),t._simulationSpace===ftt.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===_tt.Billboard?this._defines.CC_RENDER_MODE=0:r===_tt.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===_tt.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===_tt.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===_tt.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+r+" not support.");var o=t._textureAnimationModule;o&&o.enable?(Xn.set(this._frameTile_velLenScale,o.numTilesX,o.numTilesY),Zn.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,Zn.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},e}(lat);function Lat(){var t=VO.root.device;return!!(t.capabilities.maxVertexTextureUnits>=8&&t.hasFeature(hi.TEXTURE_FLOAT))||(u.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var Bat,Fat,zat,kat,Uat,Gat,Hat,Vat,Wat,jat,qat,Xat,Yat,Kat,Qat,Zat,Jat,$at,tst,est,nst,ist,rst,ost,ast,sst,cst,lst,ust,hst,fst,pst,dst,_st,mst,vst,gst,yst,xst,Sst,Tst,Est,bst,Cst,Ast,wst,Rst,Pst,Ist,Mst,Dst,Ost,Nst,Lst,Bst,Fst,zst,kst,Ust,Gst,Hst,Vst,Wst,jst,qst,Xst,Yst,Kst,Qst,Zst,Jst,$st,tct,ect,nct,ict,rct,oct,act,sct,cct,lct,uct,hct,fct,pct,dct,_ct,mct,vct,gct,yct,xct,Sct,Tct,Ect,bct,Cct,Act,wct,Rct,Pct,Ict,Mct,Dct,Oct,Nct,Lct,Bct,Fct,zct,kct,Uct,Gct,Hct,Vct,Wct,jct,qct,Xct,Yct,Kct,Qct,Zct,Jct,$ct,tlt,elt,nlt,ilt,rlt,olt,alt,slt,clt,llt,ult,hlt,flt,plt,dlt,_lt,mlt,vlt,glt,ylt,xlt,Slt,Tlt,Elt,blt,Clt,Alt,wlt,Rlt,Plt,Ilt,Mlt,Dlt,Olt,Nlt,Llt,Blt,Flt,zlt,klt,Ult,Glt,Hlt,Vlt,Wlt,jlt,qlt,Xlt,Ylt,Klt,Qlt,Zlt,Jlt,$lt,tut,eut,nut,iut,rut,out,aut,sut,cut,lut,uut,hut,fut,put,dut,_ut,mut,vut,gut,yut,xut,Sut,Tut,Eut,but,Cut,Aut,wut,Rut,Put,Iut,Mut,Dut,Out,Nut,Lut,But,Fut,zut,kut,Uut,Gut,Hut,Vut,Wut,jut,qut,Xut,Yut,Kut,Qut,Zut,Jut,$ut,tht=(wot=dc("cc.ParticleSystemRenderer"),Rot=Kc(_tt),Pot=Gc(),Iot=Lc(),Mot=Gc(),Dot=Lc(),Oot=Gc(),Not=Lc(),Lot=Kc(_tt),Bot=Kc(w$),Fot=Gc(),zot=Lc(),kot=Kc(cg),Uot=Gc(),Got=Lc(),Hot=Kc(cg),Vot=Gc(),Wot=Lc(),jot=Gc(),qot=Lc(),Xot=Kc(dtt),Yot=Gc(),Kot=Lc(),wot((aat=oat=function(){function t(){ct(this,"_renderMode",Jot,this),ct(this,"_velocityScale",$ot,this),ct(this,"_lengthScale",tat,this),ct(this,"_mesh",eat,this),ct(this,"_mainTexture",nat,this),ct(this,"_useGPU",iat,this),ct(this,"_alignSpace",rat,this),this._particleSystem=null}var e=t.prototype;return e.create=function(t){null===this._particleSystem?this._particleSystem=t:this._particleSystem!==t&&O(6033)},e.onInit=function(t){if(this.create(t),this._particleSystem.processor)O(6034);else{var e=this._useGPU&&Lat();this._particleSystem.processor=e?new Nat(this):new yat(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(t)}},e._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new Nat(this):new yat(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},Z(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(t){this._velocityScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(t){this._lengthScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh=t,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(t){this._mainTexture=t}},{key:"useGPU",get:function(){return this._useGPU},set:function(t){this._useGPU!==t&&(Lat()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(t){this._alignSpace=t,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),t}(),oat.AlignmentSpace=dtt,lt((Zot=aat).prototype,"renderMode",[Rot,Pot,Iot],Object.getOwnPropertyDescriptor(Zot.prototype,"renderMode"),Zot.prototype),lt(Zot.prototype,"velocityScale",[Mot,Dot],Object.getOwnPropertyDescriptor(Zot.prototype,"velocityScale"),Zot.prototype),lt(Zot.prototype,"lengthScale",[Oot,Not],Object.getOwnPropertyDescriptor(Zot.prototype,"lengthScale"),Zot.prototype),Jot=lt(Zot.prototype,"_renderMode",[Lot,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _tt.Billboard}}),$ot=lt(Zot.prototype,"_velocityScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tat=lt(Zot.prototype,"_lengthScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),eat=lt(Zot.prototype,"_mesh",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(Zot.prototype,"mesh",[Bot,Fot,zot],Object.getOwnPropertyDescriptor(Zot.prototype,"mesh"),Zot.prototype),lt(Zot.prototype,"particleMaterial",[kot,Uot,Got],Object.getOwnPropertyDescriptor(Zot.prototype,"particleMaterial"),Zot.prototype),lt(Zot.prototype,"trailMaterial",[Hot,Vot,Wot],Object.getOwnPropertyDescriptor(Zot.prototype,"trailMaterial"),Zot.prototype),nat=lt(Zot.prototype,"_mainTexture",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iat=lt(Zot.prototype,"_useGPU",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(Zot.prototype,"useGPU",[jot,qot],Object.getOwnPropertyDescriptor(Zot.prototype,"useGPU"),Zot.prototype),lt(Zot.prototype,"alignSpace",[Xot,Yot,Kot],Object.getOwnPropertyDescriptor(Zot.prototype,"alignSpace"),Zot.prototype),rat=lt(Zot.prototype,"_alignSpace",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dtt.View}}),Qot=Zot))||Qot),eht=Math.cos(un(100)),nht={position:new Rn,velocity:new Rn},iht=new Ln,rht=new Vn,oht=new Rn,aht=new Rn,sht=new An,cht=function(){function t(t){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new Rn,lifetime:0,width:0,velocity:new Rn,direction:0,color:new An})}var e=t.prototype;return e.getElement=function(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])},e.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new Rn,lifetime:0,width:0,velocity:new Rn,direction:0,color:new An}),this.start++,this.start%=this.trailElements.length);var t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]},e.iterateElement=function(t,e,n,i){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,o=this.start;o<r;o++)e(t,this.trailElements[o%this.trailElements.length],n,i)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},e.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},e.clear=function(){this.start=-1,this.end=-1},t}(),lht=(Bat=dc("cc.TrailModule"),Fat=Gc(),zat=Kc(ytt),kat=Gc(),Uat=Lc(),Gat=Kc(u7),Hat=Bc(),Vat=Gc(),Wat=Lc(),jat=Gc(),qat=Lc(),Xat=Kc(ftt),Yat=Gc(),Kat=Lc(),Qat=Kc(xtt),Zat=Gc(),Jat=Lc(),$at=Gc(),tst=Lc(),est=Kc(u7),nst=Bc(),ist=Gc(),rst=Lc(),ost=Gc(),ast=Lc(),sst=Kc(y9),cst=Gc(),lst=Lc(),ust=Kc(y9),hst=Gc(),fst=Lc(),pst=Kc(ftt),Bat((lt((_st=function(){function t(){ct(this,"_enable",mst,this),ct(this,"mode",vst,this),ct(this,"lifeTime",gst,this),ct(this,"_minParticleDistance",yst,this),ct(this,"existWithParticles",xst,this),ct(this,"textureMode",Sst,this),ct(this,"widthFromParticle",Tst,this),ct(this,"widthRatio",Est,this),ct(this,"colorFromParticle",bst,this),ct(this,"colorOverTrail",Cst,this),ct(this,"colorOvertime",Ast,this),ct(this,"_space",wst,this),ct(this,"_particleSystem",Rst,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new _r([new pr]),this._vertAttrs=[new Rr(Ki.ATTR_POSITION,fi.RGB32F),new Rr(Ki.ATTR_TEX_COORD,fi.RGBA32F),new Rr(Ki.ATTR_TEX_COORD1,fi.RGB32F),new Rr(Ki.ATTR_COLOR,fi.RGBA8,!0)],this._vertSize=0;for(var t,e=st(this._vertAttrs);!(t=e()).done;){var n=t.value;this._vertSize+=Jr[n.format].size}this._particleTrail=new Map}var e=t.prototype;return e.onInit=function(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;for(var e=0,n=t.startLifetime.getMax(),i=t.rateOverTime.getMax(),r=t.duration,o=0,a=t.bursts.length;o<a;o++)e+=t.bursts[o].getMaxCount(t)*Math.ceil(n/r);this._trailNum=Math.ceil(n*this.lifeTime.getMax()*60*(i*r+e)),this._trailSegments=new Wl((function(){return new cht(10)}),Math.ceil(i*r),(function(t){return t.trailElements.length=0})),this._enable&&(this.enable=this._enable)},e.onEnable=function(){this._attachToScene()},e.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},e._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},e._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},e.destroy=function(){this.destroySubMeshData(),this._trailModel&&(VO.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},e.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},e.clear=function(){if(this.enable){for(var t=this._particleTrail.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},e.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},e.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===ftt.World&&this._particleSystem._simulationSpace===ftt.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(rht),this._particleSystem.node.getWorldRotation(iht)):this._needTransform=!1},e.animate=function(t,e){if(this._trailSegments)if(t.loopCount>t.lastLoop)t.trailDelay>1?(t.lastLoop=t.loopCount,t.trailDelay=0):t.trailDelay++;else{var n=this._particleTrail.get(t);if(!n)return n=this._trailSegments.alloc(),void this._particleTrail.set(t,n);var i=n.getElement(n.end-1);if(this._needTransform?Rn.transformMat4(oht,t.position,rht):Rn.copy(oht,t.position),!(i&&(n.iterateElement(this,this._updateTrailElement,t,e),Rn.squaredDistance(i.position,oht)<this._minSquaredDistance))&&(i=n.addElement())){Rn.copy(i.position,oht),i.lifetime=0,this.widthFromParticle?i.width=t.size.x*this.widthRatio.evaluate(0,1):i.width=this.widthRatio.evaluate(0,1);var r=n.count();if(2===r){var o=n.getElement(n.end-2);Rn.subtract(o.velocity,i.position,o.position)}else if(r>2){var a=n.getElement(n.end-2),s=n.getElement(n.end-3);Rn.subtract(oht,s.position,a.position),Rn.subtract(aht,i.position,a.position),Rn.subtract(a.velocity,aht,oht),Rn.equals(Rn.ZERO,a.velocity)&&Rn.copy(a.velocity,oht),Rn.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,s)}this.colorFromParticle?i.color.set(t.color):i.color.set(this.colorOvertime.evaluate(0,1))}}},e.removeParticle=function(t){var e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))},e.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var t,e=st(this._particleTrail.keys());!(t=e()).done;){var n=t.value,i=this._particleTrail.get(n);if(-1!==i.start){var r=4*this.vbOffset/this._vertSize,o=i.start>=i.end?i.end+i.trailElements.length:i.end,a=o-i.start,s=1/a,c=i.trailElements[i.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var l=i.start+1;l<o;l++){var u=i.trailElements[l%i.trailElements.length],h=l-i.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-h/a,1),r,1-h*s,h,5)}this._needTransform?Rn.transformMat4(nht.position,n.position,rht):Rn.copy(nht.position,n.position);var f=this._trailModel;if(f&&f.node.invalidateChildren(iy.POSITION),1===a||2===a){var p=i.getElement(i.end-1);Rn.subtract(p.velocity,nht.position,p.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,Rn.subtract(nht.velocity,nht.position,p.position),this._checkDirectionReverse(nht,p)}else if(a>2){var d=i.getElement(i.end-1),_=i.getElement(i.end-2);Rn.subtract(oht,_.position,d.position),Rn.subtract(aht,nht.position,d.position),Rn.normalize(oht,oht),Rn.normalize(aht,aht),Rn.subtract(d.velocity,aht,oht),Rn.normalize(d.velocity,d.velocity),this._checkDirectionReverse(d,_),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(d,this.colorOverTrail.evaluate(s,1),r,s,a-1,5),Rn.subtract(nht.velocity,nht.position,d.position),Rn.normalize(nht.velocity,nht.velocity),this._checkDirectionReverse(nht,d)}this.widthFromParticle?nht.width=n.size.x*this.widthRatio.evaluate(0,1):nht.width=this.widthRatio.evaluate(0,1),nht.color=n.color,Rn.equals(nht.velocity,Rn.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(nht,this.colorOverTrail.evaluate(0,1),r,0,a,1)}}this._trailModel.enabled=this.ibOffset>0},e.updateIA=function(t){var e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){var n=e[0];n.inputAssembler.vertexBuffers[0].update(this._vbF32),n.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=t,this._iaInfoBuffer.update(this._iaInfo)}},e.beforeRender=function(){this.updateIA(this.ibOffset)},e._createModel=function(){this._trailModel||(this._trailModel=u.director.root.createModel(cT))},e.rebuild=function(){var t=VO.root.device,e=t.createBuffer(new hr(_i.VERTEX|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),n=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(n),this._vbUint32=new Uint32Array(n),e.update(n);var i=t.createBuffer(new hr(_i.INDEX|_i.TRANSFER_DST,gi.HOST|gi.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),i.update(this._iBuffer),this._iaInfoBuffer=t.createBuffer(new hr(_i.INDIRECT,gi.HOST|gi.DEVICE,no,no)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new GA([e],this._vertAttrs,Fi.TRIANGLE_LIST,i,this._iaInfoBuffer);var r=this._trailModel;r&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},e._updateTrailElement=function(t,e,n,i){return e.lifetime+=i,t.colorFromParticle?(e.color.set(n.color),e.color.multiply(t.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1)),t.widthFromParticle?e.width=n.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime},e._fillVertexBuffer=function(t,e,n,i,r,o){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,sht.set(t.color),sht.multiply(e),this._vbUint32[this.vbOffset++]=sht._val,this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=sht._val,1&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r-1,this._iBuffer[this.ibOffset++]=n+2*r+1),4&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r+1,this._iBuffer[this.ibOffset++]=n+2*r+2)},e._checkDirectionReverse=function(t,e){Rn.dot(t.velocity,e.velocity)<eht?t.direction=1-e.direction:t.direction=e.direction},e.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},Z(t,[{key:"enable",get:function(){return this._enable},set:function(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}},{key:"space",get:function(){return this._space},set:function(t){this._space=t;var e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}}]),t}()).prototype,"enable",[Fat],Object.getOwnPropertyDescriptor(_st.prototype,"enable"),_st.prototype),mst=lt(_st.prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vst=lt(_st.prototype,"mode",[zat,xc,kat,Uat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ytt.Particles}}),gst=lt(_st.prototype,"lifeTime",[Gat,xc,Hat,Vat,Wat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),yst=lt(_st.prototype,"_minParticleDistance",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),lt(_st.prototype,"minParticleDistance",[jat,qat],Object.getOwnPropertyDescriptor(_st.prototype,"minParticleDistance"),_st.prototype),lt(_st.prototype,"space",[Xat,Yat,Kat],Object.getOwnPropertyDescriptor(_st.prototype,"space"),_st.prototype),xst=lt(_st.prototype,"existWithParticles",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Sst=lt(_st.prototype,"textureMode",[Qat,xc,Zat,Jat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xtt.Stretch}}),Tst=lt(_st.prototype,"widthFromParticle",[xc,$at,tst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Est=lt(_st.prototype,"widthRatio",[est,xc,nst,ist,rst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),bst=lt(_st.prototype,"colorFromParticle",[xc,ost,ast],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cst=lt(_st.prototype,"colorOverTrail",[sst,xc,cst,lst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new y9}}),Ast=lt(_st.prototype,"colorOvertime",[ust,xc,hst,fst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new y9}}),wst=lt(_st.prototype,"_space",[pst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ftt.World}}),Rst=lt(_st.prototype,"_particleSystem",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dst=_st))||dst),uht=new Vn,hht=new Ln,fht=new Rn,pht=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],dht=function(){function t(t){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new Vn,this._gravity=new Zn,this.minPos=new Rn,this.maxPos=new Rn,this._nodePos=new Rn,this._nodeSize=new Rn,this._particleSystem=t,this._processor=this._particleSystem.processor,this._node=t.node,this._particlesAll=[],this._initModuleList()}var e=t.prototype;return e._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},e.setBoundingBoxSize=function(t){this.maxPos.x=this._nodePos.x+t.x,this.maxPos.y=this._nodePos.y+t.y,this.maxPos.z=this._nodePos.z+t.z,this.minPos.x=this._nodePos.x-t.x,this.minPos.y=this._nodePos.y-t.y,this.minPos.z=this._nodePos.z-t.z,this._updateBoundingNode()},e.setBoundingBoxCenter=function(t,e,n){this.maxPos.x=t+.5*this._nodeSize.x,this.maxPos.y=e+.5*this._nodeSize.y,this.maxPos.z=n+.5*this._nodeSize.z,this.minPos.x=t-.5*this._nodeSize.x,this.minPos.y=e-.5*this._nodeSize.y,this.minPos.z=n-.5*this._nodeSize.z,this._updateBoundingNode()},e._initModuleList=function(){var t=this;pht.forEach((function(e){var n=t._particleSystem[e];n&&n.enable&&(n.needUpdate&&(t._updateList[n.name]=n),n.needAnimate&&(t._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var e=0,n=ltt.length;e<n;e++){var i=this._animateList[ltt[e]];i&&this._runAnimateList.push(i)}},e._emit=function(t,e,i){var r=this._particleSystem,o=this._node,a=r.time%r.duration/r.duration;o.invalidateChildren(iy.POSITION),r.simulationSpace===ftt.World&&(o.getWorldMatrix(uht),o.getWorldRotation(hht));for(var s=0;s<t;++s){var c=new b9(r);c.particleSystem=r,c.reset();var l=_n(dn(0,n));r._shapeModule&&r._shapeModule.enable?r._shapeModule.emit(c):(Rn.set(c.position,0,0,0),Rn.copy(c.velocity,Ttt)),r._textureAnimationModule&&r._textureAnimationModule.enable&&r._textureAnimationModule.init(c);var u=r.startSpeed.evaluate(a,l);Rn.multiplyScalar(c.velocity,c.velocity,u),r.simulationSpace===ftt.World&&(Rn.transformMat4(c.position,c.position,uht),Rn.transformQuat(c.velocity,c.velocity,hht)),Rn.copy(c.ultimateVelocity,c.velocity),Rn.set(c.rotation,0,0,0),r.startSize3D?Rn.set(c.startSize,r.startSizeX.evaluate(a,l),r.startSizeY.evaluate(a,l),r.startSizeZ.evaluate(a,l)):(Rn.set(c.startSize,r.startSizeX.evaluate(a,l),1,1),c.startSize.y=c.startSize.x),Rn.copy(c.size,c.startSize),c.startLifetime=r.startLifetime.evaluate(a,l)+e,c.remainingLifetime=c.startLifetime,i.push(c)}},e._updateParticles=function(t,e){var n=this,i=this._particleSystem;switch(i.node.getWorldMatrix(uht),i.scaleSpace){case ftt.Local:i.node.getScale(fht);break;case ftt.World:i.node.getWorldScale(fht)}if(this._updateList.forEach((function(t){t.update(i.simulationSpace,uht)})),i.simulationSpace===ftt.Local){var r=i.node.getRotation();Vn.fromQuat(this._localMat,r),this._localMat.transpose()}for(var o=function(r){var o=e[r];if(o.remainingLifetime-=t,Rn.set(o.animatedVelocity,0,0,0),i.simulationSpace===ftt.Local){var a=9.8*-i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,_n(o.randomSeed))*t;n._gravity.x=0,n._gravity.y=a,n._gravity.z=0,n._gravity.w=1,n._gravity=n._gravity.transformMat4(n._localMat),o.velocity.x+=n._gravity.x,o.velocity.y+=n._gravity.y,o.velocity.z+=n._gravity.z}else o.velocity.y-=9.8*i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,_n(o.randomSeed))*t;Rn.copy(o.ultimateVelocity,o.velocity),n._runAnimateList.forEach((function(e){e.animate(o,t)})),Rn.scaleAndAdd(o.position,o.position,o.ultimateVelocity,t)},a=0;a<e.length;++a)o(a)},e._calculateBounding=function(t){var e=new Rn,n=new Rn,i=new Rn,r=new Rn,o=new Rn(1,1,1);if(this._processor.getInfo().renderMode===_tt.Mesh){var a=this._processor.getInfo().mesh;if(a&&a.struct.minPosition&&a.struct.maxPosition){var s=new js;js.fromPoints(s,a.struct.minPosition,a.struct.maxPosition);var c=Math.max(s.halfExtents.x,s.halfExtents.y,s.halfExtents.z);o.set(c,c,c)}}for(var l=0;l<this._particlesAll.length;++l){var u=this._particlesAll[l];Rn.multiply(e,fht,u.size),Rn.multiply(e,e,o),n.set(u.position),this._particleSystem.simulationSpace!==ftt.World&&Rn.transformMat4(n,n,this._particleSystem.node._mat),t&&0===l?(Rn.subtract(this.minPos,n,e),Rn.add(this.maxPos,n,e)):(Rn.subtract(i,n,e),Rn.add(r,n,e),Rn.min(this.minPos,this.minPos,i),Rn.max(this.maxPos,this.maxPos,r))}},e.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var t=_n(dn(0,n));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,t),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},e.clear=function(){this._particlesAll.length=0},e.destroy=function(){},t}(),_ht=new Vn,mht=new Ln,vht=Object.getOwnPropertyDescriptor(pF.prototype,"sharedMaterials"),ght=function(e){return t({ParticleSystem:e,ParticleSystemComponent:e}),e}((Pst=dc("cc.ParticleSystem"),Ist=Ic(),Mst=Ac(),Dst=mc(99),Ost=Bc(),Nst=Gc(),Lst=Lc(),Bst=Kc(y9),Fst=Gc(),zst=Lc(),kst=Kc(ftt),Ust=Gc(),Gst=Lc(),Hst=Gc(),Vst=Lc(),Wst=Sc("startSize"),jst=Bc(),qst=Kc(u7),Xst=Gc(),Yst=Lc(),Kst=Kc(u7),Qst=Bc(),Zst=Gc(),Jst=Lc(),$st=Kc(u7),tct=Bc(),ect=Gc(),nct=Lc(),ict=Kc(u7),rct=Bc(),oct=Gc(),act=Lc(),sct=Gc(),cct=Lc(),lct=Kc(u7),uct=Bc(),hct=Gc(),fct=Lc(),pct=Kc(u7),dct=Bc(),_ct=Gc(),mct=Lc(),vct=Kc(u7),gct=Sc("startRotation"),yct=Bc(),xct=Gc(),Sct=Lc(),Tct=Kc(u7),Ect=Bc(),bct=Gc(),Cct=Lc(),Act=Kc(u7),wct=Bc(),Rct=Gc(),Pct=Lc(),Ict=Gc(),Mct=Lc(),Dct=Gc(),Oct=Lc(),Nct=Gc(),Lct=Lc(),Bct=Kc(ftt),Fct=Gc(),zct=Lc(),kct=Gc(),Uct=Lc(),Gct=Gc(),Hct=Lc(),Vct=Kc(u7),Wct=Bc(),jct=Gc(),qct=Lc(),Xct=Kc(u7),Yct=Bc(),Kct=Gc(),Qct=Lc(),Zct=Kc(u7),Jct=Bc(),$ct=Gc(),tlt=Lc(),elt=Kc([Sot]),nlt=Gc(),ilt=Lc(),rlt=Kc(Boolean),olt=Gc(),alt=Lc(),slt=Kc(ptt),clt=Gc(),llt=Lc(),ult=Kc(Number),hlt=Gc(),flt=Lc(),plt=Kc(Number),dlt=Gc(),_lt=Lc(),mlt=Kc(Number),vlt=Gc(),glt=Lc(),ylt=Gc(),xlt=Lc(),Slt=Sc("enableCulling"),Tlt=Dc(),Elt=Kc(cg),blt=Nc(),Clt=Kc(Stt),Alt=Kc(Stt),wlt=Gc(),Rlt=Lc(),Plt=Kc(Cot),Ilt=Kc(Cot),Mlt=Gc(),Dlt=Lc(),Olt=Kc(pot),Nlt=Kc(pot),Llt=Gc(),Blt=Lc(),Flt=Kc(xot),zlt=Kc(xot),klt=Gc(),Ult=Lc(),Glt=Kc(Uet),Hlt=Kc(Uet),Vlt=Gc(),Wlt=Lc(),jlt=Kc(Wet),qlt=Kc(Wet),Xlt=Gc(),Ylt=Lc(),Klt=Kc(fot),Qlt=Kc(fot),Zlt=Gc(),Jlt=Lc(),$lt=Kc(vot),tut=Kc(vot),eut=Gc(),nut=Lc(),iut=Kc(lht),rut=Kc(lht),out=Gc(),aut=Lc(),sut=Kc(tht),cut=Gc(),lut=Lc(),Pst(uut=Ist(uut=Mst(uut=Dst(uut=Cc(($ut=Jut=function(t){function e(){var e;return ct(e=t.call(this)||this,"startColor",fut,ot(e)),ct(e,"scaleSpace",put,ot(e)),ct(e,"startSize3D",dut,ot(e)),ct(e,"startSizeX",_ut,ot(e)),ct(e,"startSizeY",mut,ot(e)),ct(e,"startSizeZ",vut,ot(e)),ct(e,"startSpeed",gut,ot(e)),ct(e,"startRotation3D",yut,ot(e)),ct(e,"startRotationX",xut,ot(e)),ct(e,"startRotationY",Sut,ot(e)),ct(e,"startRotationZ",Tut,ot(e)),ct(e,"startDelay",Eut,ot(e)),ct(e,"startLifetime",but,ot(e)),ct(e,"duration",Cut,ot(e)),ct(e,"loop",Aut,ot(e)),ct(e,"simulationSpeed",wut,ot(e)),ct(e,"playOnAwake",Rut,ot(e)),ct(e,"gravityModifier",Put,ot(e)),ct(e,"rateOverTime",Iut,ot(e)),ct(e,"rateOverDistance",Mut,ot(e)),ct(e,"bursts",Dut,ot(e)),ct(e,"_renderCulling",Out,ot(e)),ct(e,"_cullingMode",Nut,ot(e)),ct(e,"_aabbHalfX",Lut,ot(e)),ct(e,"_aabbHalfY",But,ot(e)),ct(e,"_aabbHalfZ",Fut,ot(e)),ct(e,"_dataCulling",zut,ot(e)),ct(e,"_colorOverLifetimeModule",kut,ot(e)),ct(e,"_shapeModule",Uut,ot(e)),ct(e,"_sizeOvertimeModule",Gut,ot(e)),ct(e,"_velocityOvertimeModule",Hut,ot(e)),ct(e,"_forceOvertimeModule",Vut,ot(e)),ct(e,"_limitVelocityOvertimeModule",Wut,ot(e)),ct(e,"_rotationOvertimeModule",jut,ot(e)),ct(e,"_textureAnimationModule",qut,ot(e)),ct(e,"_trailModule",Xut,ot(e)),ct(e,"renderer",Yut,ot(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._needRefresh=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._boundingBox=void 0,e._culler=void 0,e._oldPos=void 0,e._curPos=void 0,e._isCulled=void 0,e._isSimulating=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,ct(e,"_prewarm",Kut,ot(e)),ct(e,"_capacity",Qut,ot(e)),ct(e,"_simulationSpace",Zut,ot(e)),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._needRefresh=!0,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new Rn,e._curWPos=new Rn,e._boundingBox=null,e._culler=null,e._oldPos=null,e._curPos=null,e._isCulled=!1,e._isSimulating=!0,e._customData1=new Xn,e._customData2=new Xn,e._subEmitters=[],e}$(e,t);var i=e.prototype;return i.onFocusInEditor=function(){this.renderer.create(this)},i.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},i._onMaterialModified=function(t,e){null!==this.processor&&this.processor.onMaterialModified(t,e)},i._onRebuildPSO=function(t,e){this.processor.onRebuildPSO(t,e)},i._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},i._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},i._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},i.play=function(){if(this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var t=this.processor.getModel();t&&(t.enabled=this.enabledInHierarchy)}},i.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},i.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0;for(var t,e=st(this.bursts);!(t=e()).done;)t.value.reset()},i.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},i.getParticleCount=function(){return this.processor.getParticleCount()},i.setCustomData1=function(t,e){Xn.set(this._customData1,t,e)},i.setCustomData2=function(t,e){Xn.set(this._customData2,t,e)},i.onDestroy=function(){u.director.off(u.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.onEnable=function(){u.director.on(u.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},i.onDisable=function(){u.director.off(u.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i._calculateBounding=function(t){this._boundingBox&&(this._culler||(this._culler=new dht(this)),this._culler.calculatePositions(),js.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),t?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},i.update=function(t){var e=t*this.simulationSpeed;if(this.renderCulling){var n;if(this._boundingBox||(this._boundingBox=new js,this._calculateBounding(!1)),this._curPos||(this._curPos=new Rn),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new Rn,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var i=this._curPos.x-this._oldPos.x,r=this._curPos.y-this._oldPos.y,o=this._curPos.z-this._oldPos.z,a=this._boundingBox.center;a.x+=i,a.y+=r,a.z+=o,this._culler.setBoundingBoxCenter(a.x,a.y,a.z),this._oldPos.set(this._curPos)}var s=null===(n=this.node.scene.renderScene)||void 0===n?void 0:n.cameras,c=!0;if(void 0!==s&&this._boundingBox)for(var l=0;l<s.length;++l){var u=s[l];if((u.visibility&this.node.layer)===this.node.layer&&hs.aabbFrustum(this._boundingBox,u.frustum)){c=!1;break}}if(c){if(this._cullingMode!==ptt.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===ptt.PauseAndCatchup&&(this._time+=e),this._cullingMode!==ptt.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=e,this._emit(e),0!==this.processor.updateParticles(e)||this._isEmitting||this.stop();else{var h=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0];this.processor.updateRotation(h),this.processor.updateScale(h)}this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData()},i.beforeRender=function(){this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())},i._onVisibilityChange=function(t){this.processor._model&&(this.processor._model.visFlags=t)},i.emit=function(t,e){var i=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(iy.POSITION),this._needRefresh=!1),this._simulationSpace===ftt.World&&(this.node.getWorldMatrix(_ht),this.node.getWorldRotation(mht));for(var r=0;r<t;++r){var o=this.processor.getFreeParticle();if(null===o)return;o.particleSystem=this,o.reset();var a=_n(dn(0,n));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(o):(Rn.set(o.position,0,0,0),Rn.copy(o.velocity,Ttt)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(o);var s=this.startSpeed.evaluate(i,a);Rn.multiplyScalar(o.velocity,o.velocity,s),this._simulationSpace===ftt.World&&(Rn.transformMat4(o.position,o.position,_ht),Rn.transformQuat(o.velocity,o.velocity,mht)),Rn.copy(o.ultimateVelocity,o.velocity),this.startRotation3D?o.startEuler.set(this.startRotationX.evaluate(i,a),this.startRotationY.evaluate(i,a),this.startRotationZ.evaluate(i,a)):o.startEuler.set(0,0,this.startRotationZ.evaluate(i,a)),o.rotation.set(o.startEuler),this.startSize3D?Rn.set(o.startSize,this.startSizeX.evaluate(i,a),this.startSizeY.evaluate(i,a),this.startSizeZ.evaluate(i,a)):(Rn.set(o.startSize,this.startSizeX.evaluate(i,a),1,1),o.startSize.y=o.startSize.x),Rn.copy(o.size,o.startSize),o.startColor.set(this.startColor.evaluate(i,a)),o.color.set(o.startColor),o.startLifetime=this.startLifetime.evaluate(i,a)+e,o.remainingLifetime=o.startLifetime,o.randomSeed=dn(0,233280),o.loopCount++,this.processor.setNewParticle(o)}},i._prewarmSystem=function(){this.startDelay.mode=l7.Constant,this.startDelay.constant=0;for(var t=this.duration/1,e=0;e<t;++e)this._time+=1,this._emit(1),this.processor.updateParticles(1)},i._emit=function(t){var e=this.startDelay.evaluate(0,1);if(this._time>e){if(this._time>this.duration+e&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*t,this._emitRateTimeCounter>1&&this._isEmitting){var n=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=n,this.emit(n,t)}this.node.getWorldPosition(this._curWPos);var i=Rn.distance(this._curWPos,this._oldWPos);if(Rn.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=i*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,t)}for(var o,a=st(this.bursts);!(o=a()).done;)o.value.update(this,t)}},i._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),Rn.copy(this._curWPos,this._oldWPos)},i.addSubEmitter=function(t){this._subEmitters.push(t)},i.removeSubEmitter=function(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)},i.addBurst=function(t){this.bursts.push(t)},i.removeBurst=function(t){this.bursts.splice(this.bursts.indexOf(t),1)},i.getBoundingX=function(){return this._aabbHalfX},i.getBoundingY=function(){return this._aabbHalfY},i.getBoundingZ=function(){return this._aabbHalfZ},i.setBoundingX=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=t)},i.setBoundingY=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=t)},i.setBoundingZ=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=t)},i._onBeforeSerialize=function(t){var e=this;return this.dataCulling?t.filter((function(t){return!utt.includes(t)||e[t]&&e[t].enable})):t},Z(e,[{key:"capacity",get:function(){return this._capacity},set:function(t){this._capacity=Math.floor(t>0?t:0),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(t){!0===t&&this.loop,this._prewarm=t}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(t){this._renderCulling=t,t&&(this._boundingBox||(this._boundingBox=new js,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(t){this._cullingMode=t}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(t){this.setBoundingX(t)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(t){this.setBoundingY(t)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(t){this.setBoundingZ(t)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(t){this._dataCulling=t}},{key:"sharedMaterials",get:function(){return vht.get.call(this)},set:function(t){vht.set.call(this,t)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(t){t&&(this._colorOverLifetimeModule=t)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(t){t&&(this._shapeModule=t)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(t){t&&(this._sizeOvertimeModule=t)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(t){t&&(this._velocityOvertimeModule=t)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(t){t&&(this._forceOvertimeModule=t)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(t){t&&(this._limitVelocityOvertimeModule=t)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(t){t&&(this._rotationOvertimeModule=t)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(t){t&&(this._textureAnimationModule=t)}},{key:"trailModule",get:function(){return this._trailModule},set:function(t){t&&(this._trailModule=t)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),e}(pF),Jut.CullingMode=ptt,lt((hut=$ut).prototype,"capacity",[Ost,Nst,Lst],Object.getOwnPropertyDescriptor(hut.prototype,"capacity"),hut.prototype),fut=lt(hut.prototype,"startColor",[Bst,xc,Fst,zst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new y9}}),put=lt(hut.prototype,"scaleSpace",[kst,xc,Ust,Gst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ftt.Local}}),dut=lt(hut.prototype,"startSize3D",[xc,Hst,Vst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_ut=lt(hut.prototype,"startSizeX",[Wst,jst,qst,Xst,Yst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),mut=lt(hut.prototype,"startSizeY",[Kst,xc,Qst,Zst,Jst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),vut=lt(hut.prototype,"startSizeZ",[$st,xc,tct,ect,nct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),gut=lt(hut.prototype,"startSpeed",[ict,xc,rct,oct,act],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),yut=lt(hut.prototype,"startRotation3D",[xc,sct,cct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xut=lt(hut.prototype,"startRotationX",[lct,xc,uct,Hc,hct,fct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Sut=lt(hut.prototype,"startRotationY",[pct,xc,dct,Hc,_ct,mct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Tut=lt(hut.prototype,"startRotationZ",[vct,gct,yct,Hc,xct,Sct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Eut=lt(hut.prototype,"startDelay",[Tct,xc,Ect,bct,Cct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),but=lt(hut.prototype,"startLifetime",[Act,xc,wct,Rct,Pct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Cut=lt(hut.prototype,"duration",[xc,Ict,Mct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Aut=lt(hut.prototype,"loop",[xc,Dct,Oct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(hut.prototype,"prewarm",[Nct,Lct],Object.getOwnPropertyDescriptor(hut.prototype,"prewarm"),hut.prototype),lt(hut.prototype,"simulationSpace",[Bct,xc,Fct,zct],Object.getOwnPropertyDescriptor(hut.prototype,"simulationSpace"),hut.prototype),wut=lt(hut.prototype,"simulationSpeed",[xc,kct,Uct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Rut=lt(hut.prototype,"playOnAwake",[xc,Gct,Hct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Put=lt(hut.prototype,"gravityModifier",[Vct,xc,Wct,jct,qct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Iut=lt(hut.prototype,"rateOverTime",[Xct,xc,Yct,Kct,Qct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Mut=lt(hut.prototype,"rateOverDistance",[Zct,xc,Jct,$ct,tlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u7}}),Dut=lt(hut.prototype,"bursts",[elt,xc,nlt,ilt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lt(hut.prototype,"renderCulling",[rlt,olt,alt],Object.getOwnPropertyDescriptor(hut.prototype,"renderCulling"),hut.prototype),Out=lt(hut.prototype,"_renderCulling",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(hut.prototype,"cullingMode",[slt,clt,llt],Object.getOwnPropertyDescriptor(hut.prototype,"cullingMode"),hut.prototype),Nut=lt(hut.prototype,"_cullingMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ptt.Pause}}),lt(hut.prototype,"aabbHalfX",[ult,hlt,flt],Object.getOwnPropertyDescriptor(hut.prototype,"aabbHalfX"),hut.prototype),Lut=lt(hut.prototype,"_aabbHalfX",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(hut.prototype,"aabbHalfY",[plt,dlt,_lt],Object.getOwnPropertyDescriptor(hut.prototype,"aabbHalfY"),hut.prototype),But=lt(hut.prototype,"_aabbHalfY",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(hut.prototype,"aabbHalfZ",[mlt,vlt,glt],Object.getOwnPropertyDescriptor(hut.prototype,"aabbHalfZ"),hut.prototype),Fut=lt(hut.prototype,"_aabbHalfZ",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(hut.prototype,"dataCulling",[ylt,xlt],Object.getOwnPropertyDescriptor(hut.prototype,"dataCulling"),hut.prototype),zut=lt(hut.prototype,"_dataCulling",[xc,Slt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(hut.prototype,"sharedMaterials",[ol,Tlt,Elt,xc,blt],Object.getOwnPropertyDescriptor(hut.prototype,"sharedMaterials"),hut.prototype),kut=lt(hut.prototype,"_colorOverLifetimeModule",[Clt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(hut.prototype,"colorOverLifetimeModule",[Alt,wlt,Rlt],Object.getOwnPropertyDescriptor(hut.prototype,"colorOverLifetimeModule"),hut.prototype),Uut=lt(hut.prototype,"_shapeModule",[Plt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(hut.prototype,"shapeModule",[Ilt,Mlt,Dlt],Object.getOwnPropertyDescriptor(hut.prototype,"shapeModule"),hut.prototype),Gut=lt(hut.prototype,"_sizeOvertimeModule",[Olt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(hut.prototype,"sizeOvertimeModule",[Nlt,Llt,Blt],Object.getOwnPropertyDescriptor(hut.prototype,"sizeOvertimeModule"),hut.prototype),Hut=lt(hut.prototype,"_velocityOvertimeModule",[Flt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(hut.prototype,"velocityOvertimeModule",[zlt,klt,Ult],Object.getOwnPropertyDescriptor(hut.prototype,"velocityOvertimeModule"),hut.prototype),Vut=lt(hut.prototype,"_forceOvertimeModule",[Glt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(hut.prototype,"forceOvertimeModule",[Hlt,Vlt,Wlt],Object.getOwnPropertyDescriptor(hut.prototype,"forceOvertimeModule"),hut.prototype),Wut=lt(hut.prototype,"_limitVelocityOvertimeModule",[jlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(hut.prototype,"limitVelocityOvertimeModule",[qlt,Xlt,Ylt],Object.getOwnPropertyDescriptor(hut.prototype,"limitVelocityOvertimeModule"),hut.prototype),jut=lt(hut.prototype,"_rotationOvertimeModule",[Klt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(hut.prototype,"rotationOvertimeModule",[Qlt,Zlt,Jlt],Object.getOwnPropertyDescriptor(hut.prototype,"rotationOvertimeModule"),hut.prototype),qut=lt(hut.prototype,"_textureAnimationModule",[$lt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(hut.prototype,"textureAnimationModule",[tut,eut,nut],Object.getOwnPropertyDescriptor(hut.prototype,"textureAnimationModule"),hut.prototype),Xut=lt(hut.prototype,"_trailModule",[iut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(hut.prototype,"trailModule",[rut,out,aut],Object.getOwnPropertyDescriptor(hut.prototype,"trailModule"),hut.prototype),Yut=lt(hut.prototype,"renderer",[sut,xc,cut,lut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tht}}),Kut=lt(hut.prototype,"_prewarm",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qut=lt(hut.prototype,"_capacity",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Zut=lt(hut.prototype,"_simulationSpace",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ftt.Local}}),uut=hut))||uut)||uut)||uut)||uut)||uut)),yht=t("ParticleUtils",function(){function t(){}return t.instantiate=function(t){return this.registeredSceneEvent||(VO.on(HO.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(t._uuid)||this.particleSystemPool.set(t._uuid,new Wl((function(){return $h(t)||new WC}),1,(function(t){return t.destroy()}))),this.particleSystemPool.get(t._uuid).alloc()},t.destroy=function(t){this.particleSystemPool.has(t._prefab.asset._uuid)&&(this.stop(t),this.particleSystemPool.get(t._prefab.asset._uuid).free(t))},t.play=function(t){for(var e,n=st(t.getComponentsInChildren(ght));!(e=n()).done;)e.value.play()},t.stop=function(t){for(var e,n=st(t.getComponentsInChildren(ght));!(e=n()).done;)e.value.stop()},t.onSceneUnload=function(){this.particleSystemPool.forEach((function(t){return t.destroy()})),this.particleSystemPool.clear()},t}());function xht(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}yht.particleSystemPool=new Map,yht.registeredSceneEvent=!1,G(Sot.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),U(ght.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),u.ParticleSystemComponent=ght,ie.setClassAlias(ght,"cc.ParticleSystemComponent"),u.BillboardComponent=i7,ie.setClassAlias(i7,"cc.BillboardComponent"),u.LineComponent=E9,ie.setClassAlias(E9,"cc.LineComponent"),u.ParticleUtils=yht;var Sht,Tht,Eht,bht,Cht,Aht,wht,Rht=function(t,e){return function(t){t.exports=function t(e,n,i){function r(a,s){if(!n[a]){if(!e[a]){if(!s&&xht)return xht();if(o)return o(a,!0);throw new Error("Cannot find module '"+a+"'")}var c=n[a]={exports:{}};e[a][0].call(c.exports,(function(t){return r(e[a][1][t]||t)}),c,c.exports,t,e,n,i)}return n[a].exports}for(var o=xht,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(t,e){e.exports={name:"@cocos/cannon",version:"1.2.8",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se), JayceLai",keywords:["cannon.js","cocos","creator","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -c -m",postpublish:"cnpm sync @cocos/cannon"},main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,e){e.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Transform:t("./math/Transform"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World"),Octree:t("./utils/Octree")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Octree":51,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(t,e){var n=t("../math/Vec3");function i(t){t=t||{},this.lowerBound=new n,t.lowerBound&&this.lowerBound.copy(t.lowerBound),this.upperBound=new n,t.upperBound&&this.upperBound.copy(t.upperBound)}t("../utils/Utils"),e.exports=i;var r=new n;i.prototype.setFromPoints=function(t,e,n,i){var o=this.lowerBound,a=this.upperBound,s=n;o.copy(t[0]),s&&s.vmult(o,o),a.copy(o);for(var c=1;c<t.length;c++){var l=t[c];s&&(s.vmult(l,r),l=r),l.x>a.x&&(a.x=l.x),l.x<o.x&&(o.x=l.x),l.y>a.y&&(a.y=l.y),l.y<o.y&&(o.y=l.y),l.z>a.z&&(a.z=l.z),l.z<o.z&&(o.z=l.z)}return e&&(e.vadd(o,o),e.vadd(a,a)),i&&(o.x-=i,o.y-=i,o.z-=i,a.x+=i,a.y+=i,a.z+=i),this},i.prototype.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},i.prototype.clone=function(){return(new i).copy(this)},i.prototype.extend=function(t){this.lowerBound.x=Math.min(this.lowerBound.x,t.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,t.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,t.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,t.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,t.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,t.upperBound.z)},i.prototype.overlaps=function(t){var e=this.lowerBound,n=this.upperBound,i=t.lowerBound,r=t.upperBound,o=i.x<=n.x&&n.x<=r.x||e.x<=r.x&&r.x<=n.x,a=i.y<=n.y&&n.y<=r.y||e.y<=r.y&&r.y<=n.y,s=i.z<=n.z&&n.z<=r.z||e.z<=r.z&&r.z<=n.z;return o&&a&&s},i.prototype.volume=function(){var t=this.lowerBound,e=this.upperBound;return(e.x-t.x)*(e.y-t.y)*(e.z-t.z)},i.prototype.contains=function(t){var e=this.lowerBound,n=this.upperBound,i=t.lowerBound,r=t.upperBound;return e.x<=i.x&&n.x>=r.x&&e.y<=i.y&&n.y>=r.y&&e.z<=i.z&&n.z>=r.z},i.prototype.getCorners=function(t,e,n,i,r,o,a,s){var c=this.lowerBound,l=this.upperBound;t.copy(c),e.set(l.x,c.y,c.z),n.set(l.x,l.y,c.z),i.set(c.x,l.y,l.z),r.set(l.x,c.y,l.z),o.set(c.x,l.y,c.z),a.set(c.x,c.y,l.z),s.copy(l)};var o=[new n,new n,new n,new n,new n,new n,new n,new n];i.prototype.toLocalFrame=function(t,e){var n=o,i=n[0],r=n[1],a=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7];this.getCorners(i,r,a,s,c,l,u,h);for(var f=0;8!==f;f++){var p=n[f];t.pointToLocal(p,p)}return e.setFromPoints(n)},i.prototype.toWorldFrame=function(t,e){var n=o,i=n[0],r=n[1],a=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7];this.getCorners(i,r,a,s,c,l,u,h);for(var f=0;8!==f;f++){var p=n[f];t.pointToWorld(p,p)}return e.setFromPoints(n)},i.prototype.overlapsRay=function(t){var e=1/t._direction.x,n=1/t._direction.y,i=1/t._direction.z,r=(this.lowerBound.x-t.from.x)*e,o=(this.upperBound.x-t.from.x)*e,a=(this.lowerBound.y-t.from.y)*n,s=(this.upperBound.y-t.from.y)*n,c=(this.lowerBound.z-t.from.z)*i,l=(this.upperBound.z-t.from.z)*i,u=Math.max(Math.max(Math.min(r,o),Math.min(a,s)),Math.min(c,l)),h=Math.min(Math.min(Math.max(r,o),Math.max(a,s)),Math.max(c,l));return!(h<0||u>h)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(t,e){function n(){this.matrix=[]}e.exports=n,n.prototype.get=function(t,e){if(t=t.index,(e=e.index)>t){var n=e;e=t,t=n}return this.matrix[(t*(t+1)>>1)+e-1]},n.prototype.set=function(t,e,n){if(t=t.index,(e=e.index)>t){var i=e;e=t,t=i}this.matrix[(t*(t+1)>>1)+e-1]=n?1:0},n.prototype.reset=function(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0},n.prototype.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1}},{}],5:[function(t,e){var n=t("../objects/Body"),i=t("../math/Vec3"),r=t("../math/Quaternion");function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}t("../shapes/Shape"),t("../shapes/Plane"),e.exports=o,o.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")},o.prototype.needBroadphaseCollision=function(t,e){if(0==(t.collisionFilterGroup&e.collisionFilterMask)||0==(e.collisionFilterGroup&t.collisionFilterMask))return!1;var i=0!=(t.type&n.STATIC),r=0!=(e.type&n.STATIC);return!(i&&r||!t.hasTrigger&&!e.hasTrigger&&t.sleepState===n.SLEEPING&&e.sleepState===n.SLEEPING)},o.prototype.intersectionTest=function(t,e,n,i){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,n,i):this.doBoundingSphereBroadphase(t,e,n,i)};var a=new i;new i,new r,new i,o.prototype.doBoundingSphereBroadphase=function(t,e,n,i){var r=a;e.position.vsub(t.position,r);var o=Math.pow(t.boundingRadius+e.boundingRadius,2);r.norm2()<o&&(n.push(t),i.push(e))},o.prototype.doBoundingBoxBroadphase=function(t,e,n,i){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(n.push(t),i.push(e))};var s={keys:[]},c=[],l=[];o.prototype.makePairsUnique=function(t,e){for(var n=s,i=c,r=l,o=t.length,a=0;a!==o;a++)i[a]=t[a],r[a]=e[a];for(t.length=0,e.length=0,a=0;a!==o;a++){var u=i[a].id,h=r[a].id;n[f=u<h?u+","+h:h+","+u]=a,n.keys.push(f)}for(a=0;a!==n.keys.length;a++){var f=n.keys.pop(),p=n[f];t.push(i[p]),e.push(r[p]),delete n[f]}},o.prototype.setWorld=function(){};var u=new i;o.boundingSphereCheck=function(t,e){var n=u;return t.position.vsub(e.position,n),Math.pow(t.shape.boundingSphereRadius+e.shape.boundingSphereRadius,2)>n.norm2()},o.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(t,e){e.exports=o;var n=t("./Broadphase"),i=t("../math/Vec3"),r=t("../shapes/Shape");function o(t,e,r,o,a){n.apply(this),this.nx=r||10,this.ny=o||10,this.nz=a||10,this.aabbMin=t||new i(100,100,100),this.aabbMax=e||new i(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(s<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var c=0;c<s;c++)this.bins[c]=[],this.binLengths[c]=0}o.prototype=new n,o.prototype.constructor=o;var a=new i;new i,o.prototype.collisionPairs=function(t,e,n){for(var i=t.numObjects(),o=t.bodies,s=this.aabbMax,c=this.aabbMin,l=this.nx,u=this.ny,h=this.nz,f=u*h,p=h,d=1,_=s.x,m=s.y,v=s.z,g=c.x,y=c.y,x=c.z,S=l/(_-g),T=u/(m-y),E=h/(v-x),b=(_-g)/l,C=(m-y)/u,A=(v-x)/h,w=.5*Math.sqrt(b*b+C*C+A*A),R=r.types,P=R.SPHERE,I=R.PLANE,M=(R.BOX,R.COMPOUND,R.CONVEXPOLYHEDRON,this.bins),D=this.binLengths,O=this.bins.length,N=0;N!==O;N++)D[N]=0;var L=Math.ceil;function B(t,e,n,i,r,o,a){var s=(t-g)*S|0,c=(e-y)*T|0,_=(n-x)*E|0,m=L((i-g)*S),v=L((r-y)*T),b=L((o-x)*E);s<0?s=0:s>=l&&(s=l-1),c<0?c=0:c>=u&&(c=u-1),_<0?_=0:_>=h&&(_=h-1),m<0?m=0:m>=l&&(m=l-1),v<0?v=0:v>=u&&(v=u-1),b<0?b=0:b>=h&&(b=h-1),c*=p,_*=d,m*=f,v*=p,b*=d;for(var C=s*=f;C<=m;C+=f)for(var A=c;A<=v;A+=p)for(var w=_;w<=b;w+=d){var R=C+A+w;M[R][D[R]++]=a}}for(c=Math.min,s=Math.max,N=0;N!==i;N++){var F=(nt=o[N]).shape;switch(F.type){case P:var z=nt.position.x,k=nt.position.y,U=nt.position.z,G=F.radius;B(z-G,k-G,U-G,z+G,k+G,U+G,nt);break;case I:F.worldNormalNeedsUpdate&&F.computeWorldNormal(nt.quaternion);var H=F.worldNormal,V=g+.5*b-nt.position.x,W=y+.5*C-nt.position.y,j=x+.5*A-nt.position.z,q=a;q.set(V,W,j);for(var X=0,Y=0;X!==l;X++,Y+=f,q.y=W,q.x+=b)for(var K=0,Q=0;K!==u;K++,Q+=p,q.z=j,q.y+=C)for(var Z=0,J=0;Z!==h;Z++,J+=d,q.z+=A)if(q.dot(H)<w){var $=Y+Q+J;M[$][D[$]++]=nt}break;default:nt.aabbNeedsUpdate&&nt.computeAABB(),B(nt.aabb.lowerBound.x,nt.aabb.lowerBound.y,nt.aabb.lowerBound.z,nt.aabb.upperBound.x,nt.aabb.upperBound.y,nt.aabb.upperBound.z,nt)}}for(N=0;N!==O;N++){var tt=D[N];if(tt>1){var et=M[N];for(X=0;X!==tt;X++){var nt=et[X];for(K=0;K!==X;K++){var it=et[K];this.needBroadphaseCollision(nt,it)&&this.intersectionTest(nt,it,e,n)}}}}this.makePairsUnique(e,n)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(t,e){e.exports=r;var n=t("./Broadphase"),i=t("./AABB");function r(){n.apply(this)}r.prototype=new n,r.prototype.constructor=r,r.prototype.collisionPairs=function(t,e,n){var i,r,o,a,s=t.bodies,c=s.length;for(i=0;i!==c;i++)for(r=0;r!==i;r++)o=s[i],a=s[r],this.needBroadphaseCollision(o,a)&&this.intersectionTest(o,a,e,n)},new i,r.prototype.aabbQuery=function(t,e,n){n=n||[];for(var i=0;i<t.bodies.length;i++){var r=t.bodies[i];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(e)&&n.push(r)}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(t,e){function n(){this.matrix={}}e.exports=n,n.prototype.get=function(t,e){if(t=t.id,(e=e.id)>t){var n=e;e=t,t=n}return t+"-"+e in this.matrix},n.prototype.set=function(t,e,n){if(t=t.id,(e=e.id)>t){var i=e;e=t,t=i}n?this.matrix[t+"-"+e]=!0:delete this.matrix[t+"-"+e]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(){}},{}],9:[function(t,e){function n(){this.current=[],this.previous=[]}function i(t,e){t.push((4294901760&e)>>16,65535&e)}e.exports=n,n.prototype.getKey=function(t,e){if(e<t){var n=e;e=t,t=n}return t<<16|e},n.prototype.set=function(t,e){for(var n=this.getKey(t,e),i=this.current,r=0;n>i[r];)r++;if(n!==i[r]){for(e=i.length-1;e>=r;e--)i[e+1]=i[e];i[r]=n}},n.prototype.tick=function(){var t=this.current;this.current=this.previous,this.previous=t,this.current.length=0},n.prototype.getDiff=function(t,e){for(var n=this.current,r=this.previous,o=n.length,a=r.length,s=0,c=0;c<o;c++){for(var l=n[c];l>r[s];)s++;l===r[s]||i(t,l)}for(s=0,c=0;c<a;c++){for(var u=r[c];u>n[s];)s++;n[s]===u||i(e,u)}}},{}],10:[function(t,e){e.exports=c;var n=t("../math/Vec3"),i=t("../math/Quaternion"),r=t("../math/Transform"),o=(t("../shapes/ConvexPolyhedron"),t("../shapes/Box"),t("../collision/RaycastResult")),a=t("../shapes/Shape"),s=t("../collision/AABB");function c(t,e){this.from=t?t.clone():new n,this.to=e?e.clone():new n,this._direction=new n,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new o,this.hasHit=!1,this.callback=function(){}}c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var l=new s,u=[];c.prototype.intersectWorld=function(t,e){return this.mode=e.mode||c.ANY,this.result=e.result||new o,this.skipBackfaces=!!e.skipBackfaces,this.checkCollisionResponse=!!e.checkCollisionResponse,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:-1,e.from&&this.from.copy(e.from),e.to&&this.to.copy(e.to),this.callback=e.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(l),u.length=0,t.broadphase.aabbQuery(t,l,u),this.intersectBodies(u),this.hasHit};var h=new n,f=new n;function p(t,e,n,i){i.vsub(e,B),n.vsub(e,h),t.vsub(e,f);var r,o,a=B.dot(B),s=B.dot(h),c=B.dot(f),l=h.dot(h),u=h.dot(f);return(r=l*c-s*u)>=0&&(o=a*u-s*c)>=0&&r+o<a*l-s*s}c.pointInTriangle=p;var d=new n,_=new i;c.prototype.intersectBody=function(t,e){if(e&&(this.result=e,this._updateDirection()),(!this.checkCollisionResponse||t.collisionResponse)&&c.perBodyFilter(this,t))for(var n=d,i=_,r=0,o=t.shapes.length;r<o;r++){var a=t.shapes[r];if(c.perShapeFilter(this,a)&&(t.quaternion.mult(t.shapeOrientations[r],i),t.quaternion.vmult(t.shapeOffsets[r],n),n.vadd(t.position,n),this.intersectShape(a,i,n,t),this.result._shouldStop))break}},c.prototype.intersectBodies=function(t,e){e&&(this.result=e,this._updateDirection());for(var n=0,i=t.length;!this.result._shouldStop&&n<i;n++)this.intersectBody(t[n])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(t,e,n,i){if(!(z(this.from,this._direction,n)>t.boundingSphereRadius)){var r=this[t.type];r&&r.call(this,t,e,n,i,t)}},new n,new n;var m=new n,v=new n,g=new n,y=new n;new n,new o,c.prototype.intersectBox=function(t,e,n,i,r){return this.intersectConvex(t.convexPolyhedronRepresentation,e,n,i,r)},c.prototype[a.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(t,e,i,r,o){var a=this.from,s=this.to,c=this._direction,l=new n(0,0,1);e.vmult(l,l);var u=new n;a.vsub(i,u);var h=u.dot(l);if(s.vsub(i,u),!(h*u.dot(l)>0||a.distanceTo(s)<h)){var f=l.dot(c);if(!(Math.abs(f)<this.precision)){var p=new n,d=new n,_=new n;a.vsub(i,p);var m=-l.dot(p)/f;c.scale(m,d),a.vadd(d,_),this.reportIntersection(l,_,o,r,-1)}}},c.prototype[a.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(t){var e=this.to,n=this.from;t.lowerBound.x=Math.min(e.x,n.x),t.lowerBound.y=Math.min(e.y,n.y),t.lowerBound.z=Math.min(e.z,n.z),t.upperBound.x=Math.max(e.x,n.x),t.upperBound.y=Math.max(e.y,n.y),t.upperBound.z=Math.max(e.z,n.z)};var x={faceList:[0]},S=new n,T=new c,E=[];c.prototype.intersectHeightfield=function(t,e,n,i,o){t.data,t.elementSize;var a=T;a.from.copy(this.from),a.to.copy(this.to),r.pointToLocalFrame(n,e,a.from,a.from),r.pointToLocalFrame(n,e,a.to,a.to),a._updateDirection();var c,l,u,h,f=E;c=l=0,u=h=t.data.length-1;var p=new s;a.getAABB(p),t.getIndexOfPosition(p.lowerBound.x,p.lowerBound.y,f,!0),c=Math.max(c,f[0]),l=Math.max(l,f[1]),t.getIndexOfPosition(p.upperBound.x,p.upperBound.y,f,!0),u=Math.min(u,f[0]+1),h=Math.min(h,f[1]+1);for(var d=c;d<u;d++)for(var _=l;_<h;_++){if(this.result._shouldStop)return;if(t.getAabbAtIndex(d,_,p),p.overlapsRay(a)){if(t.getConvexTrianglePillar(d,_,!1),r.pointToWorldFrame(n,e,t.pillarOffset,S),this.intersectConvex(t.pillarConvex,e,S,i,o,x),this.result._shouldStop)return;t.getConvexTrianglePillar(d,_,!0),r.pointToWorldFrame(n,e,t.pillarOffset,S),this.intersectConvex(t.pillarConvex,e,S,i,o,x)}}},c.prototype[a.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var b=new n,C=new n;c.prototype.intersectSphere=function(t,e,n,i,r){var o=this.from,a=this.to,s=t.radius,c=Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2)+Math.pow(a.z-o.z,2),l=2*((a.x-o.x)*(o.x-n.x)+(a.y-o.y)*(o.y-n.y)+(a.z-o.z)*(o.z-n.z)),u=Math.pow(o.x-n.x,2)+Math.pow(o.y-n.y,2)+Math.pow(o.z-n.z,2)-Math.pow(s,2),h=Math.pow(l,2)-4*c*u,f=b,p=C;if(!(h<0))if(0===h)o.lerp(a,h,f),f.vsub(n,p),p.normalize(),this.reportIntersection(p,f,r,i,-1);else{var d=(-l-Math.sqrt(h))/(2*c),_=(-l+Math.sqrt(h))/(2*c);if(d>=0&&d<=1&&(o.lerp(a,d,f),f.vsub(n,p),p.normalize(),this.reportIntersection(p,f,r,i,-1)),this.result._shouldStop)return;_>=0&&_<=1&&(o.lerp(a,_,f),f.vsub(n,p),p.normalize(),this.reportIntersection(p,f,r,i,-1))}},c.prototype[a.types.SPHERE]=c.prototype.intersectSphere;var A=new n,w=(new n,new n,new n);c.prototype.intersectConvex=function(t,e,n,i,r,o){for(var a=A,s=w,c=o&&o.faceList||null,l=t.faces,u=t.vertices,h=t.faceNormals,f=this._direction,d=this.from,_=this.to,x=d.distanceTo(_),S=c?c.length:l.length,T=this.result,E=0;!T._shouldStop&&E<S;E++){var b=c?c[E]:E,C=l[b],R=h[b],P=e,I=n;s.copy(u[C[0]]),P.vmult(s,s),s.vadd(I,s),s.vsub(d,s),P.vmult(R,a);var M=f.dot(a);if(!(Math.abs(M)<this.precision)){var D=a.dot(s)/M;if(!(D<0)){f.mult(D,m),m.vadd(d,m),v.copy(u[C[0]]),P.vmult(v,v),I.vadd(v,v);for(var O=1;!T._shouldStop&&O<C.length-1;O++){g.copy(u[C[O]]),y.copy(u[C[O+1]]),P.vmult(g,g),P.vmult(y,y),I.vadd(g,g),I.vadd(y,y);var N=m.distanceTo(d);!p(m,v,g,y)&&!p(m,g,v,y)||N>x||this.reportIntersection(a,m,r,i,b)}}}}},c.prototype[a.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var R=new n,P=new n,I=new n,M=new n,D=new n,O=new n,N=(new s,[]),L=new r;c.prototype.intersectTrimesh=function(t,e,n,i,o,a){var s=R,c=N,l=L,u=w,h=P,f=I,d=M,_=O,x=D,S=(a&&a.faceList,t.indices),T=(t.vertices,t.faceNormals,this.from),E=this.to,b=this._direction;l.position.copy(n),l.quaternion.copy(e),r.vectorToLocalFrame(n,e,b,h),r.pointToLocalFrame(n,e,T,f),r.pointToLocalFrame(n,e,E,d),d.x*=t.scale.x,d.y*=t.scale.y,d.z*=t.scale.z,f.x*=t.scale.x,f.y*=t.scale.y,f.z*=t.scale.z,d.vsub(f,h),h.normalize();var C=f.distanceSquared(d);t.tree.rayQuery(this,l,c);for(var A=0,B=c.length;!this.result._shouldStop&&A!==B;A++){var F=c[A];t.getNormal(F,s),t.getVertex(S[3*F],v),v.vsub(f,u);var z=h.dot(s),k=s.dot(u)/z;if(!(k<0)){h.scale(k,m),m.vadd(f,m),t.getVertex(S[3*F+1],g),t.getVertex(S[3*F+2],y);var U=m.distanceSquared(f);!p(m,g,v,y)&&!p(m,v,g,y)||U>C||(r.vectorToWorldFrame(e,s,x),r.pointToWorldFrame(n,e,m,_),this.reportIntersection(x,_,o,i,F))}}c.length=0},c.prototype[a.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(t,e,n,i,r){var o=this.from,a=this.to,s=o.distanceTo(e),l=this.result;if(!(this.skipBackfaces&&t.dot(this._direction)>0))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(o,a,t,e,n,i,s),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(s<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(o,a,t,e,n,i,s));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(o,a,t,e,n,i,s),l._shouldStop=!0}};var B=new n,F=new n;function z(t,e,n){n.vsub(t,B);var i=B.dot(e);return e.mult(i,F),F.vadd(t,F),n.distanceTo(F)}c.perBodyFilter=function(t,e){return 0!=(t.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&t.collisionFilterMask)},c.perShapeFilter=function(t,e){return!(t.checkCollisionResponse&&!e.collisionResponse)}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(t,e){var n=t("../math/Vec3");function i(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.exports=i,i.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},i.prototype.abort=function(){this._shouldStop=!0},i.prototype.set=function(t,e,n,i,r,o,a){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(n),this.hitPointWorld.copy(i),this.shape=r,this.body=o,this.distance=a}},{"../math/Vec3":31}],12:[function(t,e){t("../shapes/Shape");var n=t("../collision/Broadphase");function i(t){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var e=this.axisList;this._addBodyHandler=function(t){e.push(t.body)},this._removeBodyHandler=function(t){var n=e.indexOf(t.body);-1!==n&&e.splice(n,1)},t&&this.setWorld(t)}e.exports=i,i.prototype=new n,i.prototype.setWorld=function(t){this.axisList.length=0;for(var e=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},i.insertionSortX=function(t){for(var e=1,n=t.length;e<n;e++){for(var i=t[e],r=e-1;r>=0&&!(t[r].aabb.lowerBound.x<=i.aabb.lowerBound.x);r--)t[r+1]=t[r];t[r+1]=i}return t},i.insertionSortY=function(t){for(var e=1,n=t.length;e<n;e++){for(var i=t[e],r=e-1;r>=0&&!(t[r].aabb.lowerBound.y<=i.aabb.lowerBound.y);r--)t[r+1]=t[r];t[r+1]=i}return t},i.insertionSortZ=function(t){for(var e=1,n=t.length;e<n;e++){for(var i=t[e],r=e-1;r>=0&&!(t[r].aabb.lowerBound.z<=i.aabb.lowerBound.z);r--)t[r+1]=t[r];t[r+1]=i}return t},i.prototype.collisionPairs=function(t,e,n){var r,o,a=this.axisList,s=a.length,c=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),r=0;r!==s;r++){var l=a[r];for(o=r+1;o<s;o++){var u=a[o];if(this.needBroadphaseCollision(l,u)){if(!i.checkBounds(l,u,c))break;this.intersectionTest(l,u,e,n)}}}},i.prototype.sortList=function(){for(var t=this.axisList,e=this.axisIndex,n=t.length,r=0;r!==n;r++){var o=t[r];o.aabbNeedsUpdate&&o.computeAABB()}0===e?i.insertionSortX(t):1===e?i.insertionSortY(t):2===e&&i.insertionSortZ(t)},i.checkBounds=function(t,e,n){var i,r;0===n?(i=t.position.x,r=e.position.x):1===n?(i=t.position.y,r=e.position.y):2===n&&(i=t.position.z,r=e.position.z);var o=t.boundingRadius;return r-e.boundingRadius<i+o},i.prototype.autoDetectAxis=function(){for(var t=0,e=0,n=0,i=0,r=0,o=0,a=this.axisList,s=a.length,c=1/s,l=0;l!==s;l++){var u=a[l],h=u.position.x;t+=h,e+=h*h;var f=u.position.y;n+=f,i+=f*f;var p=u.position.z;r+=p,o+=p*p}var d=e-t*t*c,_=i-n*n*c,m=o-r*r*c;this.axisIndex=d>_?d>m?0:2:_>m?1:2},i.prototype.aabbQuery=function(t,e,n){n=n||[],this.dirty&&(this.sortList(),this.dirty=!1);var i=this.axisIndex,r="x";1===i&&(r="y"),2===i&&(r="z");for(var o=this.axisList,a=(e.lowerBound[r],e.upperBound[r],0);a<o.length;a++){var s=o[a];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(e)&&n.push(s)}return n}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(t,e){e.exports=a,t("./Constraint");var n=t("./PointToPointConstraint"),i=t("../equations/ConeEquation"),r=t("../equations/RotationalEquation"),o=(t("../equations/ContactEquation"),t("../math/Vec3"));function a(t,e,a){var s=void 0!==(a=a||{}).maxForce?a.maxForce:1e6,c=a.pivotA?a.pivotA.clone():new o,l=a.pivotB?a.pivotB.clone():new o;this.axisA=a.axisA?a.axisA.clone():new o,this.axisB=a.axisB?a.axisB.clone():new o,n.call(this,t,c,e,l,s),this.collideConnected=!!a.collideConnected,this.angle=void 0!==a.angle?a.angle:0;var u=this.coneEquation=new i(t,e,a),h=this.twistEquation=new r(t,e,a);this.twistAngle=void 0!==a.twistAngle?a.twistAngle:0,u.maxForce=0,u.minForce=-s,h.maxForce=0,h.minForce=-s,this.equations.push(u,h)}a.prototype=new n,a.constructor=a,new o,new o,a.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.coneEquation,r=this.twistEquation;n.prototype.update.call(this),t.vectorToWorldFrame(this.axisA,i.axisA),e.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(r.axisA,r.axisA),t.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),e.vectorToWorldFrame(r.axisB,r.axisB),i.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(t,e){e.exports=i;var n=t("../utils/Utils");function i(t,e,r){r=n.defaults(r,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.id=i.idCounter++,this.collideConnected=r.collideConnected,r.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}i.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},i.prototype.enable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!0},i.prototype.disable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!1},i.idCounter=0},{"../utils/Utils":54}],15:[function(t,e){e.exports=r;var n=t("./Constraint"),i=t("../equations/ContactEquation");function r(t,e,r,o){n.call(this,t,e),void 0===r&&(r=t.position.distanceTo(e.position)),void 0===o&&(o=1e6),this.distance=r;var a=this.distanceEquation=new i(t,e);this.equations.push(a),a.minForce=-o,a.maxForce=o}r.prototype=new n,r.prototype.update=function(){var t=this.bodyA,e=this.bodyB,n=this.distanceEquation,i=.5*this.distance,r=n.ni;e.position.vsub(t.position,r),r.normalize(),r.mult(i,n.ri),r.mult(-i,n.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(t,e){e.exports=a,t("./Constraint");var n=t("./PointToPointConstraint"),i=t("../equations/RotationalEquation"),r=t("../equations/RotationalMotorEquation"),o=(t("../equations/ContactEquation"),t("../math/Vec3"));function a(t,e,a){var s=void 0!==(a=a||{}).maxForce?a.maxForce:1e6,c=a.pivotA?a.pivotA.clone():new o,l=a.pivotB?a.pivotB.clone():new o;n.call(this,t,c,e,l,s),(this.axisA=a.axisA?a.axisA.clone():new o(1,0,0)).normalize(),(this.axisB=a.axisB?a.axisB.clone():new o(1,0,0)).normalize();var u=this.rotationalEquation1=new i(t,e,a),h=this.rotationalEquation2=new i(t,e,a),f=this.motorEquation=new r(t,e,s);f.enabled=!1,this.equations.push(u,h,f)}a.prototype=new n,a.constructor=a,a.prototype.enableMotor=function(){this.motorEquation.enabled=!0},a.prototype.disableMotor=function(){this.motorEquation.enabled=!1},a.prototype.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},a.prototype.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t};var s=new o,c=new o;a.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.motorEquation,r=this.rotationalEquation1,o=this.rotationalEquation2,a=s,l=c,u=this.axisA,h=this.axisB;n.prototype.update.call(this),t.quaternion.vmult(u,a),e.quaternion.vmult(h,l),a.tangents(r.axisA,o.axisA),r.axisB.copy(l),o.axisB.copy(l),this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,i.axisA),e.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(t,e){e.exports=o,t("./Constraint");var n=t("./PointToPointConstraint"),i=t("../equations/RotationalEquation"),r=(t("../equations/RotationalMotorEquation"),t("../equations/ContactEquation"),t("../math/Vec3"));function o(t,e,o){var a=void 0!==(o=o||{}).maxForce?o.maxForce:1e6,s=new r,c=new r,l=new r;t.position.vadd(e.position,l),l.scale(.5,l),e.pointToLocalFrame(l,c),t.pointToLocalFrame(l,s),n.call(this,t,s,e,c,a),this.xA=t.vectorToLocalFrame(r.UNIT_X),this.xB=e.vectorToLocalFrame(r.UNIT_X),this.yA=t.vectorToLocalFrame(r.UNIT_Y),this.yB=e.vectorToLocalFrame(r.UNIT_Y),this.zA=t.vectorToLocalFrame(r.UNIT_Z),this.zB=e.vectorToLocalFrame(r.UNIT_Z);var u=this.rotationalEquation1=new i(t,e,o),h=this.rotationalEquation2=new i(t,e,o),f=this.rotationalEquation3=new i(t,e,o);this.equations.push(u,h,f)}o.prototype=new n,o.constructor=o,new r,new r,o.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,o=this.rotationalEquation3;n.prototype.update.call(this),t.vectorToWorldFrame(this.xA,i.axisA),e.vectorToWorldFrame(this.yB,i.axisB),t.vectorToWorldFrame(this.yA,r.axisA),e.vectorToWorldFrame(this.zB,r.axisB),t.vectorToWorldFrame(this.zA,o.axisA),e.vectorToWorldFrame(this.xB,o.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(t,e){e.exports=o;var n=t("./Constraint"),i=t("../equations/ContactEquation"),r=t("../math/Vec3");function o(t,e,o,a,s){n.call(this,t,o),s=void 0!==s?s:1e6,this.pivotA=e?e.clone():new r,this.pivotB=a?a.clone():new r;var c=this.equationX=new i(t,o),l=this.equationY=new i(t,o),u=this.equationZ=new i(t,o);this.equations.push(c,l,u),c.minForce=l.minForce=u.minForce=-s,c.maxForce=l.maxForce=u.maxForce=s,c.ni.set(1,0,0),l.ni.set(0,1,0),u.ni.set(0,0,1)}o.prototype=new n,o.prototype.update=function(){var t=this.bodyA,e=this.bodyB,n=this.equationX,i=this.equationY,r=this.equationZ;t.quaternion.vmult(this.pivotA,n.ri),e.quaternion.vmult(this.pivotB,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),r.ri.copy(n.ri),r.rj.copy(n.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(t,e){e.exports=r;var n=t("../math/Vec3"),i=(t("../math/Mat3"),t("./Equation"));function r(t,e,r){var o=void 0!==(r=r||{}).maxForce?r.maxForce:1e6;i.call(this,t,e,-o,o),this.axisA=r.axisA?r.axisA.clone():new n(1,0,0),this.axisB=r.axisB?r.axisB.clone():new n(0,1,0),this.angle=void 0!==r.angle?r.angle:0}r.prototype=new i,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(t){var e=this.a,n=this.b,i=this.axisA,r=this.axisB,s=o,c=a,l=this.jacobianElementA,u=this.jacobianElementB;return i.cross(r,s),r.cross(i,c),l.rotational.copy(c),u.rotational.copy(s),-(Math.cos(this.angle)-i.dot(r))*e-this.computeGW()*n-t*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(t,e){e.exports=r;var n=t("./Equation"),i=t("../math/Vec3");function r(t,e,r){r=void 0!==r?r:1e6,n.call(this,t,e,0,r),this.si=null,this.sj=null,this.restitution=0,this.ri=new i,this.rj=new i,this.ni=new i}t("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new i,a=new i,s=new i;r.prototype.computeB=function(t){var e=this.a,n=this.b,i=this.bi,r=this.bj,c=this.ri,l=this.rj,u=o,h=a,f=i.velocity,p=i.angularVelocity,d=(i.force,i.torque,r.velocity),_=r.angularVelocity,m=(r.force,r.torque,s),v=this.jacobianElementA,g=this.jacobianElementB,y=this.ni;c.cross(y,u),l.cross(y,h),y.negate(v.spatial),u.negate(v.rotational),g.spatial.copy(y),g.rotational.copy(h),m.copy(r.position),m.vadd(l,m),m.vsub(i.position,m),m.vsub(c,m);var x=y.dot(m),S=this.restitution+1;return-x*e-(S*d.dot(y)-S*f.dot(y)+_.dot(h)-p.dot(u))*n-t*this.computeGiMf()};var c=new i,l=new i,u=new i,h=new i,f=new i;r.prototype.getImpactVelocityAlongNormal=function(){var t=c,e=l,n=u,i=h,r=f;return this.bi.position.vadd(this.ri,n),this.bj.position.vadd(this.rj,i),this.bi.getVelocityAtWorldPoint(n,t),this.bj.getVelocityAtWorldPoint(i,e),t.vsub(e,r),this.ni.dot(r)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(t,e){e.exports=r;var n=t("../math/JacobianElement"),i=t("../math/Vec3");function r(t,e,i,o){this.id=r.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===o?1e6:o,this.bi=t,this.bj=e,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}r.prototype.constructor=r,r.id=0,r.prototype.setSpookParams=function(t,e,n){var i=e,r=t,o=n;this.a=4/(o*(1+4*i)),this.b=4*i/(1+4*i),this.eps=4/(o*o*r*(1+4*i))},r.prototype.computeB=function(t,e,n){var i=this.computeGW();return-this.computeGq()*t-i*e-this.computeGiMf()*n},r.prototype.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.position,o=i.position;return t.spatial.dot(r)+e.spatial.dot(o)},new i,r.prototype.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.velocity,o=i.velocity,a=n.angularVelocity,s=i.angularVelocity;return t.multiplyVectors(r,a)+e.multiplyVectors(o,s)},r.prototype.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.vlambda,o=i.vlambda,a=n.wlambda,s=i.wlambda;return t.multiplyVectors(r,a)+e.multiplyVectors(o,s)};var o=new i,a=new i,s=new i,c=new i;r.prototype.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.force,l=n.torque,u=i.force,h=i.torque,f=n.invMassSolve,p=i.invMassSolve;return r.scale(f,o),u.scale(p,a),n.invInertiaWorldSolve.vmult(l,s),i.invInertiaWorldSolve.vmult(h,c),t.multiplyVectors(o,s)+e.multiplyVectors(a,c)};var l=new i;r.prototype.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.invMassSolve,o=i.invMassSolve,a=n.invInertiaWorldSolve,s=i.invInertiaWorldSolve,c=r+o;return a.vmult(t.rotational,l),c+=l.dot(t.rotational),s.vmult(e.rotational,l),c+l.dot(e.rotational)};var u=new i;new i,new i,new i,new i,new i,r.prototype.addToWlambda=function(t){var e=this.jacobianElementA,n=this.jacobianElementB,i=this.bi,r=this.bj,o=u;i.vlambda.addScaledVector(i.invMassSolve*t,e.spatial,i.vlambda),r.vlambda.addScaledVector(r.invMassSolve*t,n.spatial,r.vlambda),i.invInertiaWorldSolve.vmult(e.rotational,o),i.wlambda.addScaledVector(t,o,i.wlambda),r.invInertiaWorldSolve.vmult(n.rotational,o),r.wlambda.addScaledVector(t,o,r.wlambda)},r.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(t,e){e.exports=r;var n=t("./Equation"),i=t("../math/Vec3");function r(t,e,r){n.call(this,t,e,-r,r),this.ri=new i,this.rj=new i,this.t=new i}t("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new i,a=new i;r.prototype.computeB=function(t){this.a;var e=this.b,n=(this.bi,this.bj,this.ri),i=this.rj,r=o,s=a,c=this.t;n.cross(c,r),i.cross(c,s);var l=this.jacobianElementA,u=this.jacobianElementB;return c.negate(l.spatial),r.negate(l.rotational),u.spatial.copy(c),u.rotational.copy(s),-this.computeGW()*e-t*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(t,e){e.exports=r;var n=t("../math/Vec3"),i=(t("../math/Mat3"),t("./Equation"));function r(t,e,r){var o=void 0!==(r=r||{}).maxForce?r.maxForce:1e6;i.call(this,t,e,-o,o),this.axisA=r.axisA?r.axisA.clone():new n(1,0,0),this.axisB=r.axisB?r.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}r.prototype=new i,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(t){var e=this.a,n=this.b,i=this.axisA,r=this.axisB,s=o,c=a,l=this.jacobianElementA,u=this.jacobianElementB;return i.cross(r,s),r.cross(i,c),l.rotational.copy(c),u.rotational.copy(s),-(Math.cos(this.maxAngle)-i.dot(r))*e-this.computeGW()*n-t*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(t,e){e.exports=r;var n=t("../math/Vec3"),i=(t("../math/Mat3"),t("./Equation"));function r(t,e,r){r=void 0!==r?r:1e6,i.call(this,t,e,-r,r),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}r.prototype=new i,r.prototype.constructor=r,r.prototype.computeB=function(t){this.a;var e=this.b,n=(this.bi,this.bj,this.axisA),i=this.axisB,r=this.jacobianElementA,o=this.jacobianElementB;return r.rotational.copy(n),i.negate(o.rotational),-(this.computeGW()-this.targetVelocity)*e-t*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(t,e){var n=t("../utils/Utils");function i(t,e,r){r=n.defaults(r,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=i.idCounter++,this.materials=[t,e],this.friction=r.friction,this.restitution=r.restitution,this.contactEquationStiffness=r.contactEquationStiffness,this.contactEquationRelaxation=r.contactEquationRelaxation,this.frictionEquationStiffness=r.frictionEquationStiffness,this.frictionEquationRelaxation=r.frictionEquationRelaxation}e.exports=i,i.idCounter=0},{"../utils/Utils":54}],26:[function(t,e){function n(t){var e="";"string"==typeof(t=t||{})?(e=t,t={}):"object"==typeof t&&(e=""),this.name=e,this.id=n.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1,this.correctInelastic=0}e.exports=n,n.idCounter=0},{}],27:[function(t,e){e.exports=i;var n=t("./Vec3");function i(){this.spatial=new n,this.rotational=new n}i.prototype.multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)},i.prototype.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)}},{"./Vec3":31}],28:[function(t,e){e.exports=i;var n=t("./Vec3");function i(t){this.elements=t||[0,0,0,0,0,0,0,0,0]}i.prototype.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},i.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},i.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},i.prototype.getTrace=function(t){t=t||new n;var e=this.elements;t.x=e[0],t.y=e[4],t.z=e[8]},i.prototype.vmult=function(t,e){e=e||new n;var i=this.elements,r=t.x,o=t.y,a=t.z;return e.x=i[0]*r+i[1]*o+i[2]*a,e.y=i[3]*r+i[4]*o+i[5]*a,e.z=i[6]*r+i[7]*o+i[8]*a,e},i.prototype.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t},i.prototype.mmult=function(t,e){for(var n=e||new i,r=0;r<3;r++)for(var o=0;o<3;o++){for(var a=0,s=0;s<3;s++)a+=t.elements[r+3*s]*this.elements[s+3*o];n.elements[r+3*o]=a}return n},i.prototype.scale=function(t,e){e=e||new i;for(var n=this.elements,r=e.elements,o=0;3!==o;o++)r[3*o+0]=t.x*n[3*o+0],r[3*o+1]=t.y*n[3*o+1],r[3*o+2]=t.z*n[3*o+2];return e},i.prototype.solve=function(t,e){e=e||new n;for(var i,r=3,o=4,a=[],s=0;s<r*o;s++)a.push(0);for(s=0;s<3;s++)for(i=0;i<3;i++)a[s+o*i]=this.elements[s+3*i];a[3]=t.x,a[7]=t.y,a[11]=t.z;var c,l,u=3,h=u,f=4;do{if(0===a[(s=h-u)+o*s])for(i=s+1;i<h;i++)if(0!==a[s+o*i]){c=f;do{a[(l=f-c)+o*s]+=a[l+o*i]}while(--c);break}if(0!==a[s+o*s])for(i=s+1;i<h;i++){var p=a[s+o*i]/a[s+o*s];c=f;do{a[(l=f-c)+o*i]=l<=s?0:a[l+o*i]-a[l+o*s]*p}while(--c)}}while(--u);if(e.z=a[2*o+3]/a[2*o+2],e.y=(a[1*o+3]-a[1*o+2]*e.z)/a[1*o+1],e.x=(a[0*o+3]-a[0*o+2]*e.z-a[0*o+1]*e.y)/a[0*o+0],isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||e.x===1/0||e.y===1/0||e.z===1/0)throw"Could not solve equation! Got x=["+e.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return e},i.prototype.e=function(t,e,n){if(void 0===n)return this.elements[e+3*t];this.elements[e+3*t]=n},i.prototype.copy=function(t){for(var e=0;e<t.elements.length;e++)this.elements[e]=t.elements[e];return this},i.prototype.toString=function(){for(var t="",e=",",n=0;n<9;n++)t+=this.elements[n]+e;return t},i.prototype.reverse=function(t){t=t||new i;for(var e,n=3,r=6,o=[],a=0;a<n*r;a++)o.push(0);for(a=0;a<3;a++)for(e=0;e<3;e++)o[a+r*e]=this.elements[a+3*e];o[3]=1,o[9]=0,o[15]=0,o[4]=0,o[10]=1,o[16]=0,o[5]=0,o[11]=0,o[17]=1;var s,c,l=3,u=l,h=r;do{if(0===o[(a=u-l)+r*a])for(e=a+1;e<u;e++)if(0!==o[a+r*e]){s=h;do{o[(c=h-s)+r*a]+=o[c+r*e]}while(--s);break}if(0!==o[a+r*a])for(e=a+1;e<u;e++){var f=o[a+r*e]/o[a+r*a];s=h;do{o[(c=h-s)+r*e]=c<=a?0:o[c+r*e]-o[c+r*a]*f}while(--s)}}while(--l);a=2;do{e=a-1;do{f=o[a+r*e]/o[a+r*a],s=r;do{o[(c=r-s)+r*e]=o[c+r*e]-o[c+r*a]*f}while(--s)}while(e--)}while(--a);a=2;do{f=1/o[a+r*a],s=r;do{o[(c=r-s)+r*a]=o[c+r*a]*f}while(--s)}while(a--);a=2;do{e=2;do{if(c=o[n+e+r*a],isNaN(c)||c===1/0)throw"Could not reverse! A=["+this.toString()+"]";t.e(a,e,c)}while(e--)}while(a--);return t},i.prototype.setRotationFromQuaternion=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=e*a,u=e*s,h=n*a,f=n*s,p=i*s,d=r*o,_=r*a,m=r*s,v=this.elements;return v[0]=1-(h+p),v[1]=l-m,v[2]=u+_,v[3]=l+m,v[4]=1-(c+p),v[5]=f-d,v[6]=u-_,v[7]=f+d,v[8]=1-(c+h),this},i.prototype.transpose=function(t){for(var e=(t=t||new i).elements,n=this.elements,r=0;3!==r;r++)for(var o=0;3!==o;o++)e[3*r+o]=n[3*o+r];return t}},{"./Vec3":31}],29:[function(t,e){e.exports=i;var n=t("./Vec3");function i(t,e,n,i){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==n?n:0,this.w=void 0!==i?i:1}i.prototype.set=function(t,e,n,i){return this.x=t,this.y=e,this.z=n,this.w=i,this},i.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},i.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},i.prototype.setFromAxisAngle=function(t,e){var n=Math.sin(.5*e);return this.x=t.x*n,this.y=t.y*n,this.z=t.z*n,this.w=Math.cos(.5*e),this},i.prototype.toAxisAngle=function(t){t=t||new n,this.normalize();var e=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i),[t,e]};var r=new n,o=new n;i.prototype.setFromVectors=function(t,e){if(t.isAntiparallelTo(e)){var n=r,i=o;t.tangents(n,i),this.setFromAxisAngle(n,Math.PI)}else{var a=t.cross(e);this.x=a.x,this.y=a.y,this.z=a.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()}return this},new n,new n,new n,i.prototype.mult=function(t,e){e=e||new i;var n=this.x,r=this.y,o=this.z,a=this.w,s=t.x,c=t.y,l=t.z,u=t.w;return e.x=n*u+a*s+r*l-o*c,e.y=r*u+a*c+o*s-n*l,e.z=o*u+a*l+n*c-r*s,e.w=a*u-n*s-r*c-o*l,e},i.prototype.inverse=function(t){var e=this.x,n=this.y,r=this.z,o=this.w;t=t||new i,this.conjugate(t);var a=1/(e*e+n*n+r*r+o*o);return t.x*=a,t.y*=a,t.z*=a,t.w*=a,t},i.prototype.conjugate=function(t){return(t=t||new i).x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t},i.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},i.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},i.prototype.vmult=function(t,e){e=e||new n;var i=t.x,r=t.y,o=t.z,a=this.x,s=this.y,c=this.z,l=this.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,f=l*o+a*r-s*i,p=-a*i-s*r-c*o;return e.x=u*l+p*-a+h*-c-f*-s,e.y=h*l+p*-s+f*-a-u*-c,e.z=f*l+p*-c+u*-s-h*-a,e},i.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},i.prototype.toEuler=function(t,e){var n,i,r;e=e||"YZX";var o=this.x,a=this.y,s=this.z,c=this.w;switch(e){case"YZX":var l=o*a+s*c;if(l>.499&&(n=2*Math.atan2(o,c),i=Math.PI/2,r=0),l<-.499&&(n=-2*Math.atan2(o,c),i=-Math.PI/2,r=0),isNaN(n)){var u=o*o,h=a*a,f=s*s;n=Math.atan2(2*a*c-2*o*s,1-2*h-2*f),i=Math.asin(2*l),r=Math.atan2(2*o*c-2*a*s,1-2*u-2*f)}break;default:throw new Error("Euler order "+e+" not supported yet.")}t.y=n,t.z=i,t.x=r},i.prototype.setFromEuler=function(t,e,n,i){i=i||"XYZ";var r=Math.cos(t/2),o=Math.cos(e/2),a=Math.cos(n/2),s=Math.sin(t/2),c=Math.sin(e/2),l=Math.sin(n/2);return"XYZ"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a-s*c*l):"YXZ"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a+s*c*l):"ZXY"===i?(this.x=s*o*a-r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a-s*c*l):"ZYX"===i?(this.x=s*o*a-r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a+s*c*l):"YZX"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a-s*c*l):"XZY"===i&&(this.x=s*o*a-r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a+s*c*l),this},i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)},i.prototype.slerp=function(t,e,n){n=n||new i;var r,o,a,s,c,l=this.x,u=this.y,h=this.z,f=this.w,p=t.x,d=t.y,_=t.z,m=t.w;return(o=l*p+u*d+h*_+f*m)<0&&(o=-o,p=-p,d=-d,_=-_,m=-m),1-o>1e-6?(r=Math.acos(o),a=Math.sin(r),s=Math.sin((1-e)*r)/a,c=Math.sin(e*r)/a):(s=1-e,c=e),n.x=s*l+c*p,n.y=s*u+c*d,n.z=s*h+c*_,n.w=s*f+c*m,n},i.prototype.integrate=function(t,e,n,r){r=r||new i;var o=t.x*n.x,a=t.y*n.y,s=t.z*n.z,c=this.x,l=this.y,u=this.z,h=this.w,f=.5*e;return r.x+=f*(o*h+a*u-s*l),r.y+=f*(a*h+s*c-o*u),r.z+=f*(s*h+o*l-a*c),r.w+=f*(-o*c-a*l-s*u),r},i.prototype.euqals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}},{"./Vec3":31}],30:[function(t,e){var n=t("./Vec3"),i=t("./Quaternion");function r(t){t=t||{},this.position=new n,t.position&&this.position.copy(t.position),this.quaternion=new i,t.quaternion&&this.quaternion.copy(t.quaternion)}e.exports=r;var o=new i;r.pointToLocalFrame=function(t,e,i,r){return r=r||new n,i.vsub(t,r),e.conjugate(o),o.vmult(r,r),r},r.prototype.pointToLocal=function(t,e){return r.pointToLocalFrame(this.position,this.quaternion,t,e)},r.pointToWorldFrame=function(t,e,i,r){return r=r||new n,e.vmult(i,r),r.vadd(t,r),r},r.prototype.pointToWorld=function(t,e){return r.pointToWorldFrame(this.position,this.quaternion,t,e)},r.prototype.vectorToWorldFrame=function(t,e){return e=e||new n,this.quaternion.vmult(t,e),e},r.vectorToWorldFrame=function(t,e,n){return t.vmult(e,n),n},r.vectorToLocalFrame=function(t,e,i,r){return r=r||new n,e.w*=-1,e.vmult(i,r),e.w*=-1,r}},{"./Quaternion":29,"./Vec3":31}],31:[function(t,e){e.exports=i;var n=t("./Mat3");function i(t,e,n){this.x=t||0,this.y=e||0,this.z=n||0}i.ZERO=new i(0,0,0),i.UNIT_X=new i(1,0,0),i.UNIT_Y=new i(0,1,0),i.UNIT_Z=new i(0,0,1),i.prototype.cross=function(t,e){var n=t.x,r=t.y,o=t.z,a=this.x,s=this.y,c=this.z;return(e=e||new i).x=s*o-c*r,e.y=c*n-a*o,e.z=a*r-s*n,e},i.prototype.set=function(t,e,n){return this.x=t,this.y=e,this.z=n,this},i.prototype.setZero=function(){this.x=this.y=this.z=0},i.prototype.vadd=function(t,e){if(!e)return new i(this.x+t.x,this.y+t.y,this.z+t.z);e.x=t.x+this.x,e.y=t.y+this.y,e.z=t.z+this.z},i.prototype.vsub=function(t,e){if(!e)return new i(this.x-t.x,this.y-t.y,this.z-t.z);e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z},i.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},i.prototype.normalize=function(){var t=this.x,e=this.y,n=this.z,i=Math.sqrt(t*t+e*e+n*n);if(i>0){var r=1/i;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return i},i.prototype.unit=function(t){t=t||new i;var e=this.x,n=this.y,r=this.z,o=Math.sqrt(e*e+n*n+r*r);return o>0?(o=1/o,t.x=e*o,t.y=n*o,t.z=r*o):(t.x=1,t.y=0,t.z=0),t},i.prototype.norm=function(){var t=this.x,e=this.y,n=this.z;return Math.sqrt(t*t+e*e+n*n)},i.prototype.length=i.prototype.norm,i.prototype.norm2=function(){return this.dot(this)},i.prototype.lengthSquared=i.prototype.norm2,i.prototype.distanceTo=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return Math.sqrt((r-e)*(r-e)+(o-n)*(o-n)+(a-i)*(a-i))},i.prototype.distanceSquared=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return(r-e)*(r-e)+(o-n)*(o-n)+(a-i)*(a-i)},i.prototype.mult=function(t,e){e=e||new i;var n=this.x,r=this.y,o=this.z;return e.x=t*n,e.y=t*r,e.z=t*o,e},i.prototype.vmul=function(t,e){return(e=e||new i).x=t.x*this.x,e.y=t.y*this.y,e.z=t.z*this.z,e},i.prototype.scale=i.prototype.mult,i.prototype.addScaledVector=function(t,e,n){return(n=n||new i).x=this.x+t*e.x,n.y=this.y+t*e.y,n.z=this.z+t*e.z,n},i.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},i.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},i.prototype.negate=function(t){return(t=t||new i).x=-this.x,t.y=-this.y,t.z=-this.z,t};var r=new i,o=new i;i.prototype.tangents=function(t,e){var n=this.norm();if(n>0){var i=r,a=1/n;i.set(this.x*a,this.y*a,this.z*a);var s=o;Math.abs(i.x)<.9?(s.set(1,0,0),i.cross(s,t)):(s.set(0,1,0),i.cross(s,t)),i.cross(t,e)}else t.set(1,0,0),e.set(0,1,0)},i.prototype.toString=function(){return this.x+","+this.y+","+this.z},i.prototype.toArray=function(){return[this.x,this.y,this.z]},i.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},i.prototype.lerp=function(t,e,n){var i=this.x,r=this.y,o=this.z;n.x=i+(t.x-i)*e,n.y=r+(t.y-r)*e,n.z=o+(t.z-o)*e},i.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},i.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)};var a=new i;i.prototype.isAntiparallelTo=function(t,e){return this.negate(a),a.almostEquals(t,e)},i.prototype.clone=function(){return new i(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(t,e){e.exports=h;var n=t("../utils/EventTarget"),i=t("../shapes/Shape"),r=t("../math/Vec3"),o=t("../math/Mat3"),a=t("../math/Quaternion"),s=(t("../material/Material"),t("../collision/AABB")),c=t("../shapes/Box"),l=t("../collision/RaycastResult"),u=t("../world/World");function h(t){t=t||{},n.apply(this),this.id=h.idCounter++,this.world=null,this.preStep=null,this.ccdSpeedThreshold=void 0!==t.ccdSpeedThreshold?t.ccdSpeedThreshold:-1,this.ccdIterations=void 0!==t.ccdIterations?t.ccdIterations:5,this.postStep=null,this.vlambda=new r,this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new r,this.previousPosition=new r,this.interpolatedPosition=new r,this.initPosition=new r,t.position&&(this.position.copy(t.position),this.previousPosition.copy(t.position),this.interpolatedPosition.copy(t.position),this.initPosition.copy(t.position)),this.velocity=new r,t.velocity&&this.velocity.copy(t.velocity),this.initVelocity=new r,this.force=new r;var e="number"==typeof t.mass?t.mass:0;this.mass=e,this.invMass=e>0?1/e:0,this.material=t.material||null,this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,this.type=e<=0?h.STATIC:h.DYNAMIC,typeof t.type==typeof h.STATIC&&(this.type=t.type),this.allowSleep=void 0===t.allowSleep||t.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==t.sleepSpeedLimit?t.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==t.sleepTimeLimit?t.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new r,this.quaternion=new a,this.initQuaternion=new a,this.previousQuaternion=new a,this.interpolatedQuaternion=new a,t.quaternion&&(this.quaternion.copy(t.quaternion),this.initQuaternion.copy(t.quaternion),this.previousQuaternion.copy(t.quaternion),this.interpolatedQuaternion.copy(t.quaternion)),this.angularVelocity=new r,t.angularVelocity&&this.angularVelocity.copy(t.angularVelocity),this.initAngularVelocity=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new r,this.invInertia=new r,this.invInertiaWorld=new o,this.invMassSolve=0,this.invInertiaSolve=new r,this.invInertiaWorldSolve=new o,this.fixedRotation=void 0!==t.fixedRotation&&t.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==t.angularDamping?t.angularDamping:.01,this.linearFactor=new r(1,1,1),t.linearFactor&&this.linearFactor.copy(t.linearFactor),this.angularFactor=new r(1,1,1),t.angularFactor&&this.angularFactor.copy(t.angularFactor),this.aabb=new s,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new r,t.shape&&this.addShape(t.shape),this.hasTrigger=!0,this.updateMassProperties()}h.prototype=new n,h.prototype.constructor=h,h.COLLIDE_EVENT_NAME="collide",h.DYNAMIC=1,h.STATIC=2,h.KINEMATIC=4,h.AWAKE=0,h.SLEEPY=1,h.SLEEPING=2,h.idCounter=0,h.wakeupEvent={type:"wakeup"},h.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,t===h.SLEEPING&&this.dispatchEvent(h.wakeupEvent)},h.prototype.sleep=function(){this.sleepState=h.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},h.sleepyEvent={type:"sleepy"},h.sleepEvent={type:"sleep"},h.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,n=this.velocity.norm2()+this.angularVelocity.norm2(),i=Math.pow(this.sleepSpeedLimit,2);e===h.AWAKE&&n<i?(this.sleepState=h.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(h.sleepyEvent)):e===h.SLEEPY&&n>i?this.wakeUp():e===h.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(h.sleepEvent))}},h.prototype.updateSolveMassProperties=function(){this.sleepState===h.SLEEPING||this.type===h.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},h.prototype.pointToLocalFrame=function(t,e){return e=e||new r,t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e},h.prototype.vectorToLocalFrame=function(t,e){return e=e||new r,this.quaternion.conjugate().vmult(t,e),e},h.prototype.pointToWorldFrame=function(t,e){return e=e||new r,this.quaternion.vmult(t,e),e.vadd(this.position,e),e},h.prototype.vectorToWorldFrame=function(t,e){return e=e||new r,this.quaternion.vmult(t,e),e};var f=new r,p=new a;h.prototype.addShape=function(t,e,n){var i=new r,o=new a;return e&&i.copy(e),n&&o.copy(n),this.shapes.push(t),this.shapeOffsets.push(i),this.shapeOrientations.push(o),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger(),u.idToShapeMap[t.id]=t,t.body=this,this},h.prototype.removeShape=function(t){var e=this.shapes.indexOf(t);-1!==e&&(this.shapes.splice(e,1),this.shapeOffsets.splice(e,1),this.shapeOrientations.splice(e,1),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger())},h.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,n=t.length,i=0,r=0;r!==n;r++){var o=t[r];o.updateBoundingSphereRadius();var a=e[r].norm(),s=o.boundingSphereRadius;a+s>i&&(i=a+s)}this.boundingRadius=i};var d=new s;h.prototype.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,n=this.shapeOrientations,i=t.length,r=f,o=p,a=this.quaternion,s=this.aabb,c=d,l=0;l!==i;l++){var u=t[l];a.vmult(e[l],r),r.vadd(this.position,r),n[l].mult(a,o),u.calculateWorldAABB(r,o,c.lowerBound,c.upperBound),0===l?s.copy(c):s.extend(c)}this.aabbNeedsUpdate=!1};var _=new o,m=new o;new o,h.prototype.updateInertiaWorld=function(t){var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var n=_,i=m;n.setRotationFromQuaternion(this.quaternion),n.transpose(i),n.scale(e,n),n.mmult(i,this.invInertiaWorld)}},new r;var v=new r;h.prototype.applyForce=function(t,e){if(this.type===h.DYNAMIC){var n=v;e.cross(t,n),this.force.vadd(t,this.force),this.torque.vadd(n,this.torque)}};var g=new r,y=new r;h.prototype.applyLocalForce=function(t,e){if(this.type===h.DYNAMIC){var n=g,i=y;this.vectorToWorldFrame(t,n),this.vectorToWorldFrame(e,i),this.applyForce(n,i)}},new r;var x=new r,S=new r;h.prototype.applyImpulse=function(t,e){if(this.type===h.DYNAMIC){var n=e,i=x;i.copy(t),i.mult(this.invMass,i),this.velocity.vadd(i,this.velocity);var r=S;n.cross(t,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var T=new r,E=new r;h.prototype.applyLocalImpulse=function(t,e){if(this.type===h.DYNAMIC){var n=T,i=E;this.vectorToWorldFrame(t,n),this.vectorToWorldFrame(e,i),this.applyImpulse(n,i)}};var b=new r;h.prototype.updateMassProperties=function(){var t=b;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,n=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),c.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!n?1/e.x:0,e.y>0&&!n?1/e.y:0,e.z>0&&!n?1/e.z:0),this.updateInertiaWorld(!0)},h.prototype.getVelocityAtWorldPoint=function(t,e){var n=new r;return t.vsub(this.position,n),this.angularVelocity.cross(n,e),this.velocity.vadd(e,e),e},new r,new r;var C=new r,A=(new a,new a);h.prototype.integrate=function(t,e,n){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===h.DYNAMIC||u.integrateKinematic&&this.type===h.KINEMATIC)&&this.sleepState!==h.SLEEPING){var i=this.velocity,r=this.angularVelocity,o=this.position,a=this.force,s=this.torque,c=this.quaternion,l=this.invMass,f=this.invInertiaWorld,p=this.linearFactor,d=l*t;i.x+=a.x*d*p.x,i.y+=a.y*d*p.y,i.z+=a.z*d*p.z;var _=f.elements,m=this.angularFactor,v=s.x*m.x,g=s.y*m.y,y=s.z*m.z;r.x+=t*(_[0]*v+_[1]*g+_[2]*y),r.y+=t*(_[3]*v+_[4]*g+_[5]*y),r.z+=t*(_[6]*v+_[7]*g+_[8]*y),c.integrate(this.angularVelocity,t,this.angularFactor,c),e&&(n?c.normalizeFast():c.normalize()),this.type===h.DYNAMIC&&this.ccdSpeedThreshold>0&&this.velocity.length()>=Math.pow(this.ccdSpeedThreshold,2)&&this.integrateToTimeOfImpact(t)||(i.mult(t,C),o.vadd(C,o)),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},h.prototype.updateKinematic=function(t){if(this.type===h.KINEMATIC&&0!==t){this.velocity.setZero(),this.angularVelocity.setZero();var e=1/t;this.previousPosition.almostEquals(this.position)||(this.position.vsub(this.previousPosition,this.velocity),this.velocity.mult(e,this.velocity),this.aabbNeedsUpdate=!0),this.previousQuaternion.euqals(this.quaternion)||(this.previousQuaternion.conjugate(A),A.mult(this.quaternion,A),A.toEuler(this.angularVelocity),this.angularVelocity.mult(e,this.angularVelocity),this.aabbNeedsUpdate=!0)}},h.prototype.applyGravity=function(t){if(this.type===h.DYNAMIC){if(1==this.linearDamping)this.force.setZero();else if(this.useGravity){var e=t.x,n=t.y,i=t.z,r=this.force,o=this.mass;r.x+=o*e,r.y+=o*n,r.z+=o*i}1==this.angularDamping&&this.torque.setZero()}};var w=new r,R=new r,P=new r,I=new r,M=new r,D=new r,O=new l,N=new l,L=new l,B=new r,F=new r,z=new r,k=new o;h.prototype.integrateToTimeOfImpact=function(t){w.copy(this.velocity),w.normalize(),this.velocity.mult(t,P),P.vadd(this.position,R),R.vsub(this.position,M);var e,n=M.length(),r=this.collisionFilterGroup;this.collisionFilterGroup=0;for(var o=1,a=0;a<this.shapes.length;a++){var s=this.shapes[a],c={collisionFilterMask:s.collisionFilterMask,collisionFilterGroup:s.collisionFilterGroup,skipBackfaces:!0};if(B.copy(this.position),B.vadd(M,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,O),e=O.body,s.type===i.types.SPHERE&&(o=s.radius,u.ccdSphereAdvance)){if(z.copy(this.velocity),z.y=0,z.normalize(),B.copy(z),k.identity(),k.elements[0]=B.x,k.elements[1]=-B.z,k.elements[3]=B.z,k.elements[4]=B.x,I.set(0,s.radius,0),k.vmult(I,I),I.z=I.y,I.y=0,I.vadd(this.position,B),P.vadd(B,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,N),I.negate(I),I.vadd(this.position,B),P.vadd(B,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,L),N.hasHit){N.hitPointWorld.vsub(this.position,B);var l=w.dot(B);(!O.hasHit||O.distance>l)&&(O.hasHit=!0,O.distance=l,e=N.body,w.mult(l,B),B.vadd(this.position,O.hitPointWorld))}L.hasHit&&(L.hitPointWorld.vsub(this.position,B),l=w.dot(B),(!O.hasHit||O.distance>l)&&(O.hasHit=!0,O.distance=l,e=L.body,w.mult(l,B),B.vadd(this.position,O.hitPointWorld)))}if(e)break}if(this.collisionFilterGroup=r,!e)return!1;O.hasHit&&h.DrawSphere(O.hitPointWorld,.05),N.hasHit&&h.DrawSphere(N.hitPointWorld,.05),L.hasHit&&h.DrawSphere(L.hitPointWorld,.05);var f=1;(R=O.hitPointWorld).vsub(this.position,M),f=O.distance/n,D.copy(this.position);for(var p=0,d=0,_=f,m=1;m>=d&&p<this.ccdIterations;){p++,_=(m+d)/2,M.mult(_,C),D.vadd(C,this.position),this.computeAABB(),h.DrawSphere(this.position,o);var v=this.aabb.overlaps(e.aabb);if(v){var g=[];this.world.narrowphase.getContacts([this],[e],this.world,g,[],[],[]),v=g.length>0}v?m=_:d=_}return f=m,this.position.copy(D),M.mult(f,C),this.position.vadd(C,this.position),!0},h.DrawSphere=h.DrawLine=function(){},h.prototype.isSleeping=function(){return this.sleepState===h.SLEEPING},h.prototype.isSleepy=function(){return this.sleepState===h.SLEEPY},h.prototype.isAwake=function(){return this.sleepState===h.AWAKE},h.prototype.updateHasTrigger=function(){for(var t=this.shapes.length;t--&&(this.hasTrigger=!this.shapes[t].collisionResponse,!this.hasTrigger););}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(t,e){t("./Body");var n=t("../math/Vec3"),i=t("../math/Quaternion"),r=(t("../collision/RaycastResult"),t("../collision/Ray")),o=t("../objects/WheelInfo");function a(t){this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:1,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:2}e.exports=a,new n,new n,new n;var s=new n,c=new n,l=new n;new r,a.prototype.addWheel=function(t){var e=new o(t=t||{}),n=this.wheelInfos.length;return this.wheelInfos.push(e),n},a.prototype.setSteeringValue=function(t,e){this.wheelInfos[e].steering=t},new n,a.prototype.applyEngineForce=function(t,e){this.wheelInfos[e].engineForce=t},a.prototype.setBrake=function(t,e){this.wheelInfos[e].brake=t},a.prototype.addToWorld=function(t){this.constraints,t.addBody(this.chassisBody);var e=this;this.preStepCallback=function(){e.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t},a.prototype.getVehicleAxisWorld=function(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(e,e)},a.prototype.updateVehicle=function(t){for(var e=this.wheelInfos,i=e.length,r=this.chassisBody,o=0;o<i;o++)this.updateWheelTransform(o);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var a=new n;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),o=0;o<i;o++)this.castRay(e[o]);this.updateSuspension(t);var s=new n,c=new n;for(o=0;o<i;o++){var l=(p=e[o]).suspensionForce;l>p.maxSuspensionForce&&(l=p.maxSuspensionForce),p.raycastResult.hitNormalWorld.scale(l*t,s),p.raycastResult.hitPointWorld.vsub(r.position,c),r.applyImpulse(s,c)}this.updateFriction(t);var u=new n,h=new n,f=new n;for(o=0;o<i;o++){var p=e[o];r.getVelocityAtWorldPoint(p.chassisConnectionPointWorld,f);var d=1;switch(this.indexUpAxis){case 1:d=-1}if(p.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,h);var _=h.dot(p.raycastResult.hitNormalWorld);p.raycastResult.hitNormalWorld.scale(_,u),h.vsub(u,h);var m=h.dot(f);p.deltaRotation=d*m*t/p.radius}!p.sliding&&p.isInContact||0===p.engineForce||!p.useCustomSlidingRotationalSpeed||(p.deltaRotation=(p.engineForce>0?1:-1)*p.customSlidingRotationalSpeed*t),Math.abs(p.brake)>Math.abs(p.engineForce)&&(p.deltaRotation=0),p.rotation+=p.deltaRotation,p.deltaRotation*=.99}},a.prototype.updateSuspension=function(){for(var t=this.chassisBody.mass,e=this.wheelInfos,n=e.length,i=0;i<n;i++){var r=e[i];if(r.isInContact){var o,a=r.suspensionRestLength-r.suspensionLength;o=r.suspensionStiffness*a*r.clippedInvContactDotSuspension;var s=r.suspensionRelativeVelocity;o-=(s<0?r.dampingCompression:r.dampingRelaxation)*s,r.suspensionForce=o*t,r.suspensionForce<0&&(r.suspensionForce=0)}else r.suspensionForce=0}},a.prototype.removeFromWorld=function(t){this.constraints,t.remove(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null};var u=new n,h=new n;a.prototype.castRay=function(t){var e=u,i=h;this.updateWheelTransformWorld(t);var r=this.chassisBody,o=-1,a=t.suspensionRestLength+t.radius;t.directionWorld.scale(a,e);var s=t.chassisConnectionPointWorld;s.vadd(e,i);var c=t.raycastResult;c.reset();var l=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(s,i,c),r.collisionResponse=l;var f=c.body;if(t.raycastResult.groundObject=0,f){o=c.distance,t.raycastResult.hitNormalWorld=c.hitNormalWorld,t.isInContact=!0;var p=c.distance;t.suspensionLength=p-t.radius;var d=t.suspensionRestLength-t.maxSuspensionTravel,_=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<d&&(t.suspensionLength=d),t.suspensionLength>_&&(t.suspensionLength=_,t.raycastResult.reset());var m=t.raycastResult.hitNormalWorld.dot(t.directionWorld),v=new n;r.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,v);var g=t.raycastResult.hitNormalWorld.dot(v);if(m>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{var y=-1/m;t.suspensionRelativeVelocity=g*y,t.clippedInvContactDotSuspension=y}}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return o},a.prototype.updateWheelTransformWorld=function(t){t.isInContact=!1;var e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),e.vectorToWorldFrame(t.directionLocal,t.directionWorld),e.vectorToWorldFrame(t.axleLocal,t.axleWorld)},a.prototype.updateWheelTransform=function(t){var e=s,n=c,r=l,o=this.wheelInfos[t];this.updateWheelTransformWorld(o),o.directionLocal.scale(-1,e),n.copy(o.axleLocal),e.cross(n,r),r.normalize(),n.normalize();var a=o.steering,u=new i;u.setFromAxisAngle(e,a);var h=new i;h.setFromAxisAngle(n,o.rotation);var f=o.worldTransform.quaternion;this.chassisBody.quaternion.mult(u,f),f.mult(h,f),f.normalize();var p=o.worldTransform.position;p.copy(o.directionWorld),p.scale(o.suspensionLength,p),p.vadd(o.chassisConnectionPointWorld,p)};var f=[new n(1,0,0),new n(0,1,0),new n(0,0,1)];a.prototype.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform};var p=new n,d=[],_=[],m=1;a.prototype.updateFriction=function(t){for(var e=p,i=this.wheelInfos,r=i.length,o=this.chassisBody,a=_,s=d,c=0;c<r;c++){var l=(M=i[c]).raycastResult.body;M.sideImpulse=0,M.forwardImpulse=0,a[c]||(a[c]=new n),s[c]||(s[c]=new n)}for(c=0;c<r;c++)if(l=(M=i[c]).raycastResult.body){var u=s[c];this.getWheelTransformWorld(c).vectorToWorldFrame(f[this.indexRightAxis],u);var h=M.raycastResult.hitNormalWorld,v=u.dot(h);h.scale(v,e),u.vsub(e,u),u.normalize(),h.cross(u,a[c]),a[c].normalize(),M.sideImpulse=P(o,M.raycastResult.hitPointWorld,l,M.raycastResult.hitPointWorld,u),M.sideImpulse*=m}var g=1,y=.5;for(this.sliding=!1,c=0;c<r;c++){l=(M=i[c]).raycastResult.body;var S=0;if(M.slipInfo=1,l){var T=0,E=M.brake?M.brake:T;S=x(o,l,M.raycastResult.hitPointWorld,a[c],E);var b=E/(S+=M.engineForce*t);M.slipInfo*=b}if(M.forwardImpulse=0,M.skidInfo=1,l){M.skidInfo=1;var C=M.suspensionForce*t*M.frictionSlip,A=C*C;M.forwardImpulse=S;var w=M.forwardImpulse*y,R=M.sideImpulse*g,I=w*w+R*R;M.sliding=!1,I>A&&(this.sliding=!0,M.sliding=!0,b=C/Math.sqrt(I),M.skidInfo*=b)}}if(this.sliding)for(c=0;c<r;c++)0!==(M=i[c]).sideImpulse&&M.skidInfo<1&&(M.forwardImpulse*=M.skidInfo,M.sideImpulse*=M.skidInfo);for(c=0;c<r;c++){var M=i[c],D=new n;if(M.raycastResult.hitPointWorld.vsub(o.position,D),0!==M.forwardImpulse){var O=new n;a[c].scale(M.forwardImpulse,O),o.applyImpulse(O,D)}if(0!==M.sideImpulse){l=M.raycastResult.body;var N=new n;M.raycastResult.hitPointWorld.vsub(l.position,N);var L=new n;s[c].scale(M.sideImpulse,L),o.vectorToLocalFrame(D,D),D["xyz"[this.indexUpAxis]]*=M.rollInfluence,o.vectorToWorldFrame(D,D),o.applyImpulse(L,D),L.scale(-1,L),l.applyImpulse(L,N)}}};var v=new n,g=new n,y=new n;function x(t,e,n,i,r){var o=0,a=n,s=v,c=g,l=y;return t.getVelocityAtWorldPoint(a,s),e.getVelocityAtWorldPoint(a,c),s.vsub(c,l),r<(o=-i.dot(l)*(1/(C(t,n,i)+C(e,n,i))))&&(o=r),o<-r&&(o=-r),o}var S=new n,T=new n,E=new n,b=new n;function C(t,e,n){var i=S,r=T,o=E,a=b;return e.vsub(t.position,i),i.cross(n,r),t.invInertiaWorld.vmult(r,a),a.cross(i,o),t.invMass+n.dot(o)}var A=new n,w=new n,R=new n;function P(t,e,n,i,r){if(r.norm2()>1.1)return 0;var o=A,a=w,s=R;return t.getVelocityAtWorldPoint(e,o),n.getVelocityAtWorldPoint(i,a),o.vsub(a,s),-.2*r.dot(s)*(1/(t.invMass+n.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(t,e){var n=t("./Body"),i=t("../shapes/Sphere"),r=t("../shapes/Box"),o=t("../math/Vec3"),a=t("../constraints/HingeConstraint");function s(t){if(this.wheelBodies=[],this.coordinateSystem=void 0===t.coordinateSystem?new o(1,2,3):t.coordinateSystem.clone(),this.chassisBody=t.chassisBody,!this.chassisBody){var e=new r(new o(5,2,.5));this.chassisBody=new n(1,e)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}e.exports=s,s.prototype.addWheel=function(t){var e=(t=t||{}).body;e||(e=new n(1,new i(1.2))),this.wheelBodies.push(e),this.wheelForces.push(0),new o;var r=void 0!==t.position?t.position.clone():new o,s=new o;this.chassisBody.pointToWorldFrame(r,s),e.position.set(s.x,s.y,s.z);var c=void 0!==t.axis?t.axis.clone():new o(0,1,0);this.wheelAxes.push(c);var l=new a(this.chassisBody,e,{pivotA:r,axisA:c,pivotB:o.ZERO,axisB:c,collideConnected:!1});return this.constraints.push(l),this.wheelBodies.length-1},s.prototype.setSteeringValue=function(t,e){var n=this.wheelAxes[e],i=Math.cos(t),r=Math.sin(t),o=n.x,a=n.y;this.constraints[e].axisA.set(i*o-r*a,r*o+i*a,0)},s.prototype.setMotorSpeed=function(t,e){var n=this.constraints[e];n.enableMotor(),n.motorTargetVelocity=t},s.prototype.disableMotor=function(t){this.constraints[t].disableMotor()};var c=new o;s.prototype.setWheelForce=function(t,e){this.wheelForces[e]=t},s.prototype.applyWheelForce=function(t,e){var n=this.wheelAxes[e],i=this.wheelBodies[e],r=i.torque;n.scale(t,c),i.vectorToWorldFrame(c,c),r.vadd(c,r)},s.prototype.addToWorld=function(t){for(var e=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)t.addBody(n[i]);for(i=0;i<e.length;i++)t.addConstraint(e[i]);t.addEventListener("preStep",this._update.bind(this))},s.prototype._update=function(){for(var t=this.wheelForces,e=0;e<t.length;e++)this.applyWheelForce(t[e],e)},s.prototype.removeFromWorld=function(t){for(var e=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)t.remove(n[i]);for(i=0;i<e.length;i++)t.removeConstraint(e[i])};var l=new o;s.prototype.getWheelSpeed=function(t){var e=this.wheelAxes[t],n=this.wheelBodies[t].angularVelocity;return this.chassisBody.vectorToWorldFrame(e,l),n.dot(l)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(t,e){e.exports=i,t("../shapes/Shape");var n=t("../math/Vec3");function i(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}t("../math/Quaternion"),t("../shapes/Particle"),t("../objects/Body"),t("../material/Material"),i.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},i.prototype.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var r=new n;i.prototype.getNeighbors=function(t,e){for(var n=this.particles.length,i=t.id,o=this.smoothingRadius*this.smoothingRadius,a=r,s=0;s!==n;s++){var c=this.particles[s];c.position.vsub(t.position,a),i!==c.id&&a.norm2()<o&&e.push(c)}};var o=new n,a=new n,s=new n,c=new n,l=new n,u=new n;i.prototype.update=function(){for(var t=this.particles.length,e=o,n=this.speedOfSound,i=this.eps,r=0;r!==t;r++){var h=this.particles[r];(b=this.neighbors[r]).length=0,this.getNeighbors(h,b),b.push(this.particles[r]);for(var f=b.length,p=0,d=0;d!==f;d++){h.position.vsub(b[d].position,e);var _=e.norm(),m=this.w(_);p+=b[d].mass*m}this.densities[r]=p,this.pressures[r]=n*n*(this.densities[r]-this.density)}var v=a,g=s,y=c,x=l,S=u;for(r=0;r!==t;r++){var T,E,b,C=this.particles[r];for(v.set(0,0,0),g.set(0,0,0),f=(b=this.neighbors[r]).length,d=0;d!==f;d++){var A=b[d];C.position.vsub(A.position,x);var w=x.norm();T=-A.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+i)+this.pressures[d]/(this.densities[d]*this.densities[d]+i)),this.gradw(x,y),y.mult(T,y),v.vadd(y,v),A.velocity.vsub(C.velocity,S),S.mult(1/(1e-4+this.densities[r]*this.densities[d])*this.viscosity*A.mass,S),E=this.nablaw(w),S.mult(E,S),g.vadd(S,g)}g.mult(C.mass,g),v.mult(C.mass,v),C.force.vadd(g,C.force),C.force.vadd(v,C.force)}},i.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},i.prototype.gradw=function(t,e){var n=t.norm(),i=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(i,9))*Math.pow(i*i-n*n,2),e)},i.prototype.nablaw=function(t){var e=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(t,e){var n=t("../math/Vec3");function i(t,e,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}e.exports=i,i.prototype.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},i.prototype.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},i.prototype.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},i.prototype.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)};var r=new n,o=new n,a=new n,s=new n,c=new n,l=new n,u=new n,h=new n,f=new n,p=new n,d=new n;i.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,n=this.restLength,i=this.bodyA,_=this.bodyB,m=r,v=o,g=a,y=s,x=d,S=c,T=l,E=u,b=h,C=f,A=p;this.getWorldAnchorA(S),this.getWorldAnchorB(T),S.vsub(i.position,E),T.vsub(_.position,b),T.vsub(S,m);var w=m.norm();v.copy(m),v.normalize(),_.velocity.vsub(i.velocity,g),_.angularVelocity.cross(b,x),g.vadd(x,g),i.angularVelocity.cross(E,x),g.vsub(x,g),v.mult(-t*(w-n)-e*g.dot(v),y),i.force.vsub(y,i.force),_.force.vadd(y,_.force),E.cross(y,C),b.cross(y,A),i.torque.vsub(C,i.torque),_.torque.vadd(A,_.torque)}},{"../math/Vec3":31}],37:[function(t,e){var n=t("../math/Vec3"),i=t("../math/Transform"),r=t("../collision/RaycastResult"),o=t("../utils/Utils");function a(t){t=o.defaults(t,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new r,this.worldTransform=new i,this.isInContact=!1}e.exports=a;var s=new n,c=new n;s=new n,a.prototype.updateWheel=function(t){var e=this.raycastResult;if(this.isInContact){var n=e.hitNormalWorld.dot(e.directionWorld);e.hitPointWorld.vsub(t.position,c),t.getVelocityAtWorldPoint(c,s);var i=e.hitNormalWorld.dot(s);if(n>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/n;this.suspensionRelativeVelocity=i*r,this.clippedInvContactDotSuspension=r}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(t,e){e.exports=o;var n=t("./Shape"),i=t("../math/Vec3"),r=t("./ConvexPolyhedron");function o(t){n.call(this,{type:n.types.BOX}),this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o,o.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,n=this.halfExtents.z,o=i,a=[new o(-t,-e,-n),new o(t,-e,-n),new o(t,e,-n),new o(-t,e,-n),new o(-t,-e,n),new o(t,-e,n),new o(t,e,n),new o(-t,e,n)],s=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],c=(new o(0,0,1),new o(0,1,0),new o(1,0,0),new r(a,s));this.convexPolyhedronRepresentation=c,c.material=this.material},o.prototype.calculateLocalInertia=function(t,e){return e=e||new i,o.calculateInertia(this.halfExtents,t,e),e},o.calculateInertia=function(t,e,n){var i=t;i.isZero()?(n.x=2/12*e,n.y=2/12*e,n.z=2/12*e):(n.x=1/12*e*(4*i.y*i.y+4*i.z*i.z),n.y=1/12*e*(4*i.x*i.x+4*i.z*i.z),n.z=1/12*e*(4*i.y*i.y+4*i.x*i.x))},o.prototype.getSideNormals=function(t,e){var n=t,i=this.halfExtents;if(n[0].set(i.x,0,0),n[1].set(0,i.y,0),n[2].set(0,0,i.z),n[3].set(-i.x,0,0),n[4].set(0,-i.y,0),n[5].set(0,0,-i.z),void 0!==e)for(var r=0;r!==n.length;r++)e.vmult(n[r],n[r]);return n},o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var a=new i;new i,o.prototype.forEachWorldCorner=function(t,e,n){for(var i=this.halfExtents,r=[[i.x,i.y,i.z],[-i.x,i.y,i.z],[-i.x,-i.y,i.z],[-i.x,-i.y,-i.z],[i.x,-i.y,-i.z],[i.x,i.y,-i.z],[-i.x,i.y,-i.z],[i.x,-i.y,i.z]],o=0;o<r.length;o++)a.set(r[o][0],r[o][1],r[o][2]),e.vmult(a,a),t.vadd(a,a),n(a.x,a.y,a.z)};var s=[new i,new i,new i,new i,new i,new i,new i,new i];o.prototype.calculateWorldAABB=function(t,e,n,i){var r=this.halfExtents;s[0].set(r.x,r.y,r.z),s[1].set(-r.x,r.y,r.z),s[2].set(-r.x,-r.y,r.z),s[3].set(-r.x,-r.y,-r.z),s[4].set(r.x,-r.y,-r.z),s[5].set(r.x,r.y,-r.z),s[6].set(-r.x,r.y,-r.z),s[7].set(r.x,-r.y,r.z);var o=s[0];e.vmult(o,o),t.vadd(o,o),i.copy(o),n.copy(o);for(var a=1;a<8;a++){o=s[a],e.vmult(o,o),t.vadd(o,o);var c=o.x,l=o.y,u=o.z;c>i.x&&(i.x=c),l>i.y&&(i.y=l),u>i.z&&(i.z=u),c<n.x&&(n.x=c),l<n.y&&(n.y=l),u<n.z&&(n.z=u)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(t,e){e.exports=o;var n=t("./Shape"),i=t("../math/Vec3"),r=(t("../math/Quaternion"),t("../math/Transform"));function o(t,e,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=t||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=e||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o;var a=new i;o.prototype.computeEdges=function(){var t=this.faces,e=this.vertices,n=(e.length,this.uniqueEdges);n.length=0;for(var i=a,r=0;r!==t.length;r++)for(var o=t[r],s=o.length,c=0;c!==s;c++){var l=(c+1)%s;e[o[c]].vsub(e[o[l]],i),i.normalize();for(var u=!1,h=0;h!==n.length;h++)if(n[h].almostEquals(i)||n[h].almostEquals(i)){u=!0;break}u||n.push(i.clone())}},o.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var e=0;e<this.faces[t].length;e++)if(!this.vertices[this.faces[t][e]])throw new Error("Vertex "+this.faces[t][e]+" not found!");var n=this.faceNormals[t]||new i;this.getFaceNormal(t,n),n.negate(n),this.faceNormals[t]=n}};var s=new i,c=new i;o.computeNormal=function(t,e,n,i){e.vsub(t,c),n.vsub(e,s),s.cross(c,i),i.isZero()||i.normalize()},o.prototype.getFaceNormal=function(t,e){var n=this.faces[t],i=this.vertices[n[0]],r=this.vertices[n[1]],a=this.vertices[n[2]];return o.computeNormal(i,r,a,e)};var l=new i;o.prototype.clipAgainstHull=function(t,e,n,r,o,a,s,c,u){for(var h=l,f=-1,p=-Number.MAX_VALUE,d=0;d<n.faces.length;d++){h.copy(n.faceNormals[d]),o.vmult(h,h);var _=h.dot(a);_>p&&(p=_,f=d)}for(var m=[],v=n.faces[f],g=v.length,y=0;y<g;y++){var x=n.vertices[v[y]],S=new i;S.copy(x),o.vmult(S,S),r.vadd(S,S),m.push(S)}f>=0&&this.clipFaceAgainstHull(a,t,e,m,s,c,u)};var u=new i,h=new i,f=new i,p=new i,d=new i,_=new i;o.prototype.findSeparatingAxis=function(t,e,n,i,r,o,a,s){var c=u,l=h,m=f,v=p,g=d,y=_,x=Number.MAX_VALUE,S=this;if(S.uniqueAxes)for(E=0;E!==S.uniqueAxes.length;E++){if(n.vmult(S.uniqueAxes[E],c),!1===(A=S.testSepAxis(c,t,e,n,i,r)))return!1;A<x&&(x=A,o.copy(c))}else for(var T=a?a.length:S.faces.length,E=0;E<T;E++){var b=a?a[E]:E;if(c.copy(S.faceNormals[b]),n.vmult(c,c),!1===(A=S.testSepAxis(c,t,e,n,i,r)))return!1;A<x&&(x=A,o.copy(c))}if(t.uniqueAxes)for(E=0;E!==t.uniqueAxes.length;E++){if(r.vmult(t.uniqueAxes[E],l),!1===(A=S.testSepAxis(l,t,e,n,i,r)))return!1;A<x&&(x=A,o.copy(l))}else{var C=s?s.length:t.faces.length;for(E=0;E<C;E++){var A;if(b=s?s[E]:E,l.copy(t.faceNormals[b]),r.vmult(l,l),!1===(A=S.testSepAxis(l,t,e,n,i,r)))return!1;A<x&&(x=A,o.copy(l))}}for(var w=0;w!==S.uniqueEdges.length;w++){n.vmult(S.uniqueEdges[w],v);for(var R=0;R!==t.uniqueEdges.length;R++)if(r.vmult(t.uniqueEdges[R],g),v.cross(g,y),!y.almostZero()){y.normalize();var P=S.testSepAxis(y,t,e,n,i,r);if(!1===P)return!1;P<x&&(x=P,o.copy(y))}}return i.vsub(e,m),m.dot(o)>0&&o.negate(o),!0};var m=[],v=[];o.prototype.testSepAxis=function(t,e,n,i,r,a){var s=this;o.project(s,t,n,i,m),o.project(e,t,r,a,v);var c=m[0],l=m[1],u=v[0],h=v[1];if(c<h||u<l)return!1;var f=c-h,p=u-l;return f<p?f:p};var g=new i,y=new i;o.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(g,y);var n=y.x-g.x,i=y.y-g.y,r=y.z-g.z;e.x=1/12*t*(4*i*i+4*r*r),e.y=1/12*t*(4*n*n+4*r*r),e.z=1/12*t*(4*i*i+4*n*n)},o.prototype.getPlaneConstantOfFace=function(t){var e=this.faces[t],n=this.faceNormals[t],i=this.vertices[e[0]];return-n.dot(i)};var x=new i,S=new i,T=new i,E=new i,b=new i,C=new i,A=new i,w=new i;o.prototype.clipFaceAgainstHull=function(t,e,n,i,r,o,a){for(var s=x,c=S,l=T,u=E,h=b,f=C,p=A,d=w,_=this,m=i,v=[],g=-1,y=Number.MAX_VALUE,R=0;R<_.faces.length;R++){s.copy(_.faceNormals[R]),n.vmult(s,s);var P=s.dot(t);P<y&&(y=P,g=R)}if(!(g<0)){var I=_.faces[g];I.connectedFaces=[];for(var M=0;M<_.faces.length;M++)for(var D=0;D<_.faces[M].length;D++)-1!==I.indexOf(_.faces[M][D])&&M!==g&&-1===I.connectedFaces.indexOf(M)&&I.connectedFaces.push(M);m.length;for(var O=I.length,N=0;N<O;N++){var L=_.vertices[I[N]],B=_.vertices[I[(N+1)%O]];L.vsub(B,c),l.copy(c),n.vmult(l,l),e.vadd(l,l),u.copy(this.faceNormals[g]),n.vmult(u,u),e.vadd(u,u),l.cross(u,h),h.negate(h),f.copy(L),n.vmult(f,f),e.vadd(f,f),f.dot(h);var F=I.connectedFaces[N];p.copy(this.faceNormals[F]);var z=this.getPlaneConstantOfFace(F);d.copy(p),n.vmult(d,d);var k=z-d.dot(e);for(this.clipFaceAgainstPlane(m,v,d,k);m.length;)m.shift();for(;v.length;)m.push(v.shift())}for(p.copy(this.faceNormals[g]),z=this.getPlaneConstantOfFace(g),d.copy(p),n.vmult(d,d),k=z-d.dot(e),M=0;M<m.length;M++){var U=d.dot(m[M])+k;if(U<=r&&(U=r),U<=o){var G=m[M];if(U<=0){var H={point:G,normal:d,depth:U};a.push(H)}}}}},o.prototype.clipFaceAgainstPlane=function(t,e,n,r){var o,a,s=t.length;if(s<2)return e;var c=t[t.length-1],l=t[0];o=n.dot(c)+r;for(var u=0;u<s;u++){if(l=t[u],a=n.dot(l)+r,o<0)if(a<0)(h=new i).copy(l),e.push(h);else{var h=new i;c.lerp(l,o/(o-a),h),e.push(h)}else a<0&&(h=new i,c.lerp(l,o/(o-a),h),e.push(h),e.push(l));c=l,o=a}return e},o.prototype.computeWorldVertices=function(t,e){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new i);for(var r=this.vertices,o=this.worldVertices,a=0;a!==n;a++)e.vmult(r[a],o[a]),t.vadd(o[a],o[a]);this.worldVerticesNeedsUpdate=!1},new i,o.prototype.computeLocalAABB=function(t,e){var n=this.vertices.length,i=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<n;r++){var o=i[r];o.x<t.x?t.x=o.x:o.x>e.x&&(e.x=o.x),o.y<t.y?t.y=o.y:o.y>e.y&&(e.y=o.y),o.z<t.z?t.z=o.z:o.z>e.z&&(e.z=o.z)}},o.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new i);for(var n=this.faceNormals,r=this.worldFaceNormals,o=0;o!==e;o++)t.vmult(n[o],r[o]);this.worldFaceNormalsNeedsUpdate=!1},o.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,n=0,i=e.length;n!==i;n++){var r=e[n].norm2();r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t)};var R=new i;o.prototype.calculateWorldAABB=function(t,e,n,i){for(var r,o,a,s,c,l,u=this.vertices.length,h=this.vertices,f=0;f<u;f++){R.copy(h[f]),e.vmult(R,R),t.vadd(R,R);var p=R;(p.x<r||void 0===r)&&(r=p.x),(p.x>s||void 0===s)&&(s=p.x),(p.y<o||void 0===o)&&(o=p.y),(p.y>c||void 0===c)&&(c=p.y),(p.z<a||void 0===a)&&(a=p.z),(p.z>l||void 0===l)&&(l=p.z)}n.set(r,o,a),i.set(s,c,l)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.prototype.getAveragePointLocal=function(t){t=t||new i;for(var e=this.vertices.length,n=this.vertices,r=0;r<e;r++)t.vadd(n[r],t);return t.mult(1/e,t),t},o.prototype.transformAllPoints=function(t,e){var n=this.vertices.length,i=this.vertices;if(e){for(var r=0;r<n;r++){var o=i[r];e.vmult(o,o)}for(r=0;r<this.faceNormals.length;r++)o=this.faceNormals[r],e.vmult(o,o)}if(t)for(r=0;r<n;r++)(o=i[r]).vadd(t,o)};var P=new i,I=new i,M=new i;o.prototype.pointIsInside=function(t){var e=this.vertices.length,n=this.vertices,i=this.faces,r=this.faceNormals,o=this.faces.length,a=P;this.getAveragePointLocal(a);for(var s=0;s<o;s++){this.faces[s].length,e=r[s];var c=n[i[s][0]],l=I;t.vsub(c,l);var u=e.dot(l),h=M;a.vsub(c,h);var f=e.dot(h);if(u<0&&f>0||u>0&&f<0)return!1}return-1},new i;var D=new i,O=new i;o.project=function(t,e,n,i,o){var a=t.vertices.length,s=D,c=0,l=0,u=O,h=t.vertices;u.setZero(),r.vectorToLocalFrame(n,i,e,s),r.pointToLocalFrame(n,i,u,u);var f=u.dot(s);l=c=h[0].dot(s);for(var p=1;p<a;p++){var d=h[p].dot(s);d>c&&(c=d),d<l&&(l=d)}if((l-=f)>(c-=f)){var _=l;l=c,c=_}o[0]=c,o[1]=l}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(t,e){e.exports=r,t("./Shape");var n=t("../math/Vec3"),i=(t("../math/Quaternion"),t("./ConvexPolyhedron"));function r(t,e,r,o,a){if(a){for(var s=o,c=Math.cos,l=Math.sin,u=r/2,h=[],f=[],p=[0],d=[1],_=[],m=2*Math.PI/s,v=0;v<s;v++)h.push(new n(t*c(m*v),u,t*l(m*v))),h.push(new n(t*c(m*v),-u,t*l(m*v))),v<s-1?(f.push([2*v+2,2*v+3,2*v+1,2*v]),p.push(2*v+2),d.push(2*v+3)):f.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&_.push(new n(c(m*(v+.5)),0,l(m*(v+.5))));f.push(d);var g=[];for(v=0;v<p.length;v++)g.push(p[p.length-v-1]);return f.push(g),_.push(new n(0,1,0)),void i.call(this,h,f,_)}s=o;var y=[],x=(_=[],[]),S=[],T=[];for(c=Math.cos,l=Math.sin,y.push(new n(e*c(0),e*l(0),.5*-r)),S.push(0),y.push(new n(t*c(0),t*l(0),.5*r)),T.push(1),v=0;v<s;v++){m=2*Math.PI/s*(v+1);var E=2*Math.PI/s*(v+.5);v<s-1?(y.push(new n(e*c(m),e*l(m),.5*-r)),S.push(2*v+2),y.push(new n(t*c(m),t*l(m),.5*r)),T.push(2*v+3),x.push([2*v+2,2*v+3,2*v+1,2*v])):x.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&_.push(new n(c(E),l(E),0))}for(x.push(T),_.push(new n(0,0,1)),g=[],v=0;v<S.length;v++)g.push(S[S.length-v-1]);x.push(g),i.call(this,y,x,_)}r.prototype=new i},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(t,e){var n=t("./Shape"),i=t("./ConvexPolyhedron"),r=t("../math/Vec3"),o=t("../utils/Utils");function a(t,e){e=o.defaults(e,{maxValue:null,minValue:null,elementSize:1}),this.data=t,this.maxValue=e.maxValue,this.minValue=e.minValue,this.elementSize=e.elementSize,null===e.minValue&&this.updateMinValue(),null===e.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this,{type:n.types.HEIGHTFIELD}),this.pillarConvex=new i,this.pillarOffset=new r,this.updateBoundingSphereRadius(),this._cachedPillars={}}e.exports=a,a.prototype=new n,a.prototype.update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var t=this.data,e=t[0][0],n=0;n!==t.length;n++)for(var i=0;i!==t[n].length;i++){var r=t[n][i];r<e&&(e=r)}this.minValue=e},a.prototype.updateMaxValue=function(){for(var t=this.data,e=t[0][0],n=0;n!==t.length;n++)for(var i=0;i!==t[n].length;i++){var r=t[n][i];r>e&&(e=r)}this.maxValue=e},a.prototype.setHeightValueAtIndex=function(t,e,n){this.data[t][e]=n,this.clearCachedConvexTrianglePillar(t,e,!1),t>0&&(this.clearCachedConvexTrianglePillar(t-1,e,!0),this.clearCachedConvexTrianglePillar(t-1,e,!1)),e>0&&(this.clearCachedConvexTrianglePillar(t,e-1,!0),this.clearCachedConvexTrianglePillar(t,e-1,!1)),e>0&&t>0&&this.clearCachedConvexTrianglePillar(t-1,e-1,!0)},a.prototype.getRectMinMax=function(t,e,n,i,r){r=r||[];for(var o=this.data,a=this.minValue,s=t;s<=n;s++)for(var c=e;c<=i;c++){var l=o[s][c];l>a&&(a=l)}r[0]=this.minValue,r[1]=a},a.prototype.getIndexOfPosition=function(t,e,n,i){var r=this.elementSize,o=this.data,a=Math.floor(t/r),s=Math.floor(e/r);return n[0]=a,n[1]=s,i&&(a<0&&(a=0),s<0&&(s=0),a>=o.length-1&&(a=o.length-1),s>=o[0].length-1&&(s=o[0].length-1)),!(a<0||s<0||a>=o.length-1||s>=o[0].length-1)};var s=[],c=new r,l=new r,u=new r,h=new r;a.prototype.getTriangleAt=function(t,e,n,i,r,o){var a=s;this.getIndexOfPosition(t,e,a,n);var c=a[0],l=a[1],u=this.data;n&&(c=Math.min(u.length-2,Math.max(0,c)),l=Math.min(u[0].length-2,Math.max(0,l)));var h=this.elementSize,f=Math.pow(t/h-c,2)+Math.pow(e/h-l,2)>Math.pow(t/h-(c+1),2)+Math.pow(e/h-(l+1),2);return this.getTriangle(c,l,f,i,r,o),f};var f=new r,p=new r,d=new r,_=new r,m=new r;function v(t,e,n,i,r,o,a,s,c){c.x=((o-s)*(t-a)+(a-r)*(e-s))/((o-s)*(n-a)+(a-r)*(i-s)),c.y=((s-i)*(t-a)+(n-a)*(e-s))/((o-s)*(n-a)+(a-r)*(i-s)),c.z=1-c.x-c.y}a.prototype.getNormalAt=function(t,e,n,i){var r=f,o=p,a=d,s=_,c=m;this.getTriangleAt(t,e,n,r,o,a),o.vsub(r,s),a.vsub(r,c),s.cross(c,i),i.normalize()},a.prototype.getAabbAtIndex=function(t,e,n){var i=this.data,r=this.elementSize;n.lowerBound.set(t*r,e*r,i[t][e]),n.upperBound.set((t+1)*r,(e+1)*r,i[t+1][e+1])},a.prototype.getHeightAt=function(t,e,n){var i=this.data,r=l,o=u,a=h,f=s;this.getIndexOfPosition(t,e,f,n);var p=f[0],d=f[1];n&&(p=Math.min(i.length-2,Math.max(0,p)),d=Math.min(i[0].length-2,Math.max(0,d)));var _=this.getTriangleAt(t,e,n,r,o,a);v(t,e,r.x,r.y,o.x,o.y,a.x,a.y,c);var m=c;return _?i[p+1][d+1]*m.x+i[p][d+1]*m.y+i[p+1][d]*m.z:i[p][d]*m.x+i[p+1][d]*m.y+i[p][d+1]*m.z},a.prototype.getCacheConvexTrianglePillarKey=function(t,e,n){return t+"_"+e+"_"+(n?1:0)},a.prototype.getCachedConvexTrianglePillar=function(t,e,n){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,n)]},a.prototype.setCachedConvexTrianglePillar=function(t,e,n,i,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,n)]={convex:i,offset:r}},a.prototype.clearCachedConvexTrianglePillar=function(t,e,n){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,n)]},a.prototype.getTriangle=function(t,e,n,i,r,o){var a=this.data,s=this.elementSize;n?(i.set((t+1)*s,(e+1)*s,a[t+1][e+1]),r.set(t*s,(e+1)*s,a[t][e+1]),o.set((t+1)*s,e*s,a[t+1][e])):(i.set(t*s,e*s,a[t][e]),r.set((t+1)*s,e*s,a[t+1][e]),o.set(t*s,(e+1)*s,a[t][e+1]))},a.prototype.getConvexTrianglePillar=function(t,e,n){var o=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){if(s=this.getCachedConvexTrianglePillar(t,e,n))return this.pillarConvex=s.convex,void(this.pillarOffset=s.offset);o=new i,a=new r,this.pillarConvex=o,this.pillarOffset=a}var s=this.data,c=this.elementSize,l=o.faces;o.vertices.length=6;for(var u=0;u<6;u++)o.vertices[u]||(o.vertices[u]=new r);for(l.length=5,u=0;u<5;u++)l[u]||(l[u]=[]);var h=o.vertices,f=(Math.min(s[t][e],s[t+1][e],s[t][e+1],s[t+1][e+1])-this.minValue)/2+this.minValue;n?(a.set((t+.75)*c,(e+.75)*c,f),h[0].set(.25*c,.25*c,s[t+1][e+1]-f),h[1].set(-.75*c,.25*c,s[t][e+1]-f),h[2].set(.25*c,-.75*c,s[t+1][e]-f),h[3].set(.25*c,.25*c,-f-1),h[4].set(-.75*c,.25*c,-f-1),h[5].set(.25*c,-.75*c,-f-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=2,l[2][1]=5,l[2][2]=3,l[2][3]=0,l[3][0]=3,l[3][1]=4,l[3][2]=1,l[3][3]=0,l[4][0]=1,l[4][1]=4,l[4][2]=5,l[4][3]=2):(a.set((t+.25)*c,(e+.25)*c,f),h[0].set(-.25*c,-.25*c,s[t][e]-f),h[1].set(.75*c,-.25*c,s[t+1][e]-f),h[2].set(-.25*c,.75*c,s[t][e+1]-f),h[3].set(-.25*c,-.25*c,-f-1),h[4].set(.75*c,-.25*c,-f-1),h[5].set(-.25*c,.75*c,-f-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=0,l[2][1]=2,l[2][2]=5,l[2][3]=3,l[3][0]=1,l[3][1]=0,l[3][2]=3,l[3][3]=4,l[4][0]=4,l[4][1]=5,l[4][2]=2,l[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(t,e,n,o,a)},a.prototype.calculateLocalInertia=function(t,e){return(e=e||new r).set(0,0,0),e},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(t,e,n,i){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var t=this.data,e=this.elementSize;this.boundingSphereRadius=new r(t.length*e,t[0].length*e,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},a.prototype.setHeightsFromImage=function(t,e){var n=document.createElement("canvas");n.width=t.width,n.height=t.height;var i=n.getContext("2d");i.drawImage(t,0,0);var r=i.getImageData(0,0,t.width,t.height),o=this.data;o.length=0,this.elementSize=Math.abs(e.x)/r.width;for(var a=0;a<r.height;a++){for(var s=[],c=0;c<r.width;c++){var l=(r.data[4*(a*r.height+c)]+r.data[4*(a*r.height+c)+1]+r.data[4*(a*r.height+c)+2])/4/255*e.z;e.x<0?s.push(l):s.unshift(l)}e.y<0?o.unshift(s):o.push(s)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(t,e){e.exports=r;var n=t("./Shape"),i=t("../math/Vec3");function r(){n.call(this,{type:n.types.PARTICLE})}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(t,e){return(e=e||new i).set(0,0,0),e},r.prototype.volume=function(){return 0},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},r.prototype.calculateWorldAABB=function(t,e,n,i){n.copy(t),i.copy(t)}},{"../math/Vec3":31,"./Shape":44}],43:[function(t,e){e.exports=r;var n=t("./Shape"),i=t("../math/Vec3");function r(){n.call(this,{type:n.types.PLANE}),this.worldNormal=new i,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}r.prototype=new n,r.prototype.constructor=r,r.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},r.prototype.calculateLocalInertia=function(t,e){return e||new i},r.prototype.volume=function(){return Number.MAX_VALUE};var o=new i;r.prototype.calculateWorldAABB=function(t,e,n,i){o.set(0,0,1),e.vmult(o,o);var r=Number.MAX_VALUE;n.set(-r,-r,-r),i.set(r,r,r),1===o.x&&(i.x=t.x),1===o.y&&(i.y=t.y),1===o.z&&(i.z=t.z),-1===o.x&&(n.x=t.x),-1===o.y&&(n.y=t.y),-1===o.z&&(n.z=t.z)},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(t,e){e.exports=i;var n=t("../utils/EventTarget"),i=t("./Shape");function i(t){t=t||{},n.apply(this),this.id=i.idCounter++,this.type=t.type||0,this.boundingSphereRadius=0,this.collisionResponse=!t.collisionResponse||t.collisionResponse,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.material=t.material?t.material:null,this.body=null}t("../math/Vec3"),t("../math/Quaternion"),t("../material/Material"),i.prototype=new n,i.prototype.constructor=i,i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},i.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},i.idCounter=0,i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(t,e){e.exports=r;var n=t("./Shape"),i=t("../math/Vec3");function r(t){if(n.call(this,{type:n.types.SPHERE}),this.radius=void 0!==t?t:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(t,e){e=e||new i;var n=2*t*this.radius*this.radius/5;return e.x=n,e.y=n,e.z=n,e},r.prototype.volume=function(){return 4*Math.PI*this.radius/3},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},r.prototype.calculateWorldAABB=function(t,e,n,i){for(var r=this.radius,o=["x","y","z"],a=0;a<o.length;a++){var s=o[a];n[s]=t[s]-r,i[s]=t[s]+r}}},{"../math/Vec3":31,"./Shape":44}],46:[function(t,e){e.exports=s;var n=t("./Shape"),i=t("../math/Vec3"),r=(t("../math/Quaternion"),t("../math/Transform")),o=t("../collision/AABB"),a=t("../utils/Octree");function s(t,e){n.call(this,{type:n.types.TRIMESH}),this.vertices=new Float32Array(t),this.indices=new Int16Array(e),this.normals=new Float32Array(e.length),this.aabb=new o,this.edges=null,this.scale=new i(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}s.prototype=new n,s.prototype.constructor=s;var c=new i;s.prototype.updateTree=function(){var t=this.tree;t.reset(),t.aabb.copy(this.aabb);var e=this.scale;t.aabb.lowerBound.x*=1/e.x,t.aabb.lowerBound.y*=1/e.y,t.aabb.lowerBound.z*=1/e.z,t.aabb.upperBound.x*=1/e.x,t.aabb.upperBound.y*=1/e.y,t.aabb.upperBound.z*=1/e.z;for(var n=new o,r=new i,a=new i,s=new i,c=[r,a,s],l=0;l<this.indices.length/3;l++){var u=3*l;this._getUnscaledVertex(this.indices[u],r),this._getUnscaledVertex(this.indices[u+1],a),this._getUnscaledVertex(this.indices[u+2],s),n.setFromPoints(c),t.insert(n,l)}t.removeEmptyNodes()};var l=new o;s.prototype.getTrianglesInAABB=function(t,e){l.copy(t);var n=this.scale,i=n.x,r=n.y,o=n.z,a=l.lowerBound,s=l.upperBound;return a.x/=i,a.y/=r,a.z/=o,s.x/=i,s.y/=r,s.z/=o,this.tree.aabbQuery(l,e)},s.prototype.setScale=function(t){var e=this.scale.x===this.scale.y===this.scale.z,n=t.x===t.y===t.z;e&&n||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()},s.prototype.updateNormals=function(){for(var t=c,e=this.normals,n=0;n<this.indices.length/3;n++){var i=3*n,r=this.indices[i],o=this.indices[i+1],a=this.indices[i+2];this.getVertex(r,d),this.getVertex(o,_),this.getVertex(a,m),s.computeNormal(_,d,m,t),e[i]=t.x,e[i+1]=t.y,e[i+2]=t.z}},s.prototype.updateEdges=function(){for(var t={},e=function(){t[r<o?r+"_"+o:o+"_"+r]=!0},n=0;n<this.indices.length/3;n++){var i=3*n,r=this.indices[i],o=this.indices[i+1];this.indices[i+2],e(),e(),e()}var a=Object.keys(t);for(this.edges=new Int16Array(2*a.length),n=0;n<a.length;n++){var s=a[n].split("_");this.edges[2*n]=parseInt(s[0],10),this.edges[2*n+1]=parseInt(s[1],10)}},s.prototype.getEdgeVertex=function(t,e,n){var i=this.edges[2*t+(e?1:0)];this.getVertex(i,n)};var u=new i,h=new i;s.prototype.getEdgeVector=function(t,e){var n=u,i=h;this.getEdgeVertex(t,0,n),this.getEdgeVertex(t,1,i),i.vsub(n,e)};var f=new i,p=new i;s.computeNormal=function(t,e,n,i){e.vsub(t,p),n.vsub(e,f),f.cross(p,i),i.isZero()||i.normalize()};var d=new i,_=new i,m=new i;s.prototype.getVertex=function(t,e){var n=this.scale;return this._getUnscaledVertex(t,e),e.x*=n.x,e.y*=n.y,e.z*=n.z,e},s.prototype._getUnscaledVertex=function(t,e){var n=3*t,i=this.vertices;return e.set(i[n],i[n+1],i[n+2])},s.prototype.getWorldVertex=function(t,e,n,i){return this.getVertex(t,i),r.pointToWorldFrame(e,n,i,i),i},s.prototype.getTriangleVertices=function(t,e,n,i){var r=3*t;this.getVertex(this.indices[r],e),this.getVertex(this.indices[r+1],n),this.getVertex(this.indices[r+2],i)},s.prototype.getNormal=function(t,e){var n=3*t;return e.set(this.normals[n],this.normals[n+1],this.normals[n+2])};var v=new o;s.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(v);var n=v.upperBound.x-v.lowerBound.x,i=v.upperBound.y-v.lowerBound.y,r=v.upperBound.z-v.lowerBound.z;return e.set(1/12*t*(4*i*i+4*r*r),1/12*t*(4*n*n+4*r*r),1/12*t*(4*i*i+4*n*n))};var g=new i;s.prototype.computeLocalAABB=function(t){var e=t.lowerBound,n=t.upperBound,i=this.vertices.length/3,r=g;if(0!==i){this.getVertex(0,r),e.copy(r),n.copy(r);for(var o=0;o!==i;o++)this.getVertex(o,r),r.x<e.x?e.x=r.x:r.x>n.x&&(n.x=r.x),r.y<e.y?e.y=r.y:r.y>n.y&&(n.y=r.y),r.z<e.z?e.z=r.z:r.z>n.z&&(n.z=r.z)}},s.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},s.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,n=new i,r=0,o=e.length/3;r!==o;r++){this.getVertex(r,n);var a=n.norm2();a>t&&(t=a)}this.boundingSphereRadius=Math.sqrt(t)},new i;var y=new r,x=new o;s.prototype.calculateWorldAABB=function(t,e,n,i){var r=y,o=x;r.position=t,r.quaternion=e,this.aabb.toWorldFrame(r,o),n.copy(o.lowerBound),i.copy(o.upperBound)},s.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},s.createTorus=function(t,e,n,i,r){t=t||1,e=e||.5,n=n||8,i=i||6,r=r||2*Math.PI;for(var o=[],a=[],c=0;c<=n;c++)for(var l=0;l<=i;l++){var u=l/i*r,h=c/n*Math.PI*2,f=(t+e*Math.cos(h))*Math.cos(u),p=(t+e*Math.cos(h))*Math.sin(u),d=e*Math.sin(h);o.push(f,p,d)}for(c=1;c<=n;c++)for(l=1;l<=i;l++){var _=(i+1)*c+l-1,m=(i+1)*(c-1)+l-1,v=(i+1)*(c-1)+l,g=(i+1)*c+l;a.push(_,m,g),a.push(m,v,g)}return new s(o,a)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(t,e){e.exports=i,t("../math/Vec3"),t("../math/Quaternion");var n=t("./Solver");function i(){n.call(this),this.iterations=10,this.tolerance=1e-7}i.prototype=new n;var r=[],o=[],a=[];i.prototype.solve=function(t,e){var n,i,s,c,l,u=0,h=this.iterations,f=this.tolerance*this.tolerance,p=this.equations,d=p.length,_=e.bodies,m=_.length,v=t;if(0!==d)for(var g=0;g!==m;g++)_[g].updateSolveMassProperties();var y=o,x=a,S=r;for(y.length=d,x.length=d,S.length=d,g=0;g!==d;g++){var T=p[g];S[g]=0,x[g]=T.computeB(v),y[g]=1/T.computeC()}if(0!==d){for(g=0;g!==m;g++){var E=(A=_[g]).vlambda,b=A.wlambda;E.set(0,0,0),b.set(0,0,0)}for(u=0;u!==h;u++){c=0;for(var C=0;C!==d;C++)T=p[C],n=x[C],i=y[C],(l=S[C])+(s=i*(n-T.computeGWlambda()-T.eps*l))<T.minForce?s=T.minForce-l:l+s>T.maxForce&&(s=T.maxForce-l),S[C]+=s,c+=s>0?s:-s,T.addToWlambda(s);if(c*c<f)break}for(g=0;g!==m;g++){var A,w=(A=_[g]).velocity,R=A.angularVelocity;A.vlambda.vmul(A.linearFactor,A.vlambda),w.vadd(A.vlambda,w),A.wlambda.vmul(A.angularFactor,A.wlambda),R.vadd(A.wlambda,R)}for(var P=p.length,I=1/v;P--;)p[P].multiplier=S[P]*I}return u}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(t,e){function n(){this.equations=[]}e.exports=n,n.prototype.solve=function(){return 0},n.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)},n.prototype.removeEquation=function(t){var e=this.equations,n=e.indexOf(t);-1!==n&&e.splice(n,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(t,e){e.exports=r,t("../math/Vec3"),t("../math/Quaternion");var n=t("./Solver"),i=t("../objects/Body");function r(t){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=t,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}r.prototype=new n;var o=[],a=[],s={bodies:[]},c=i.STATIC;function l(t){for(var e=t.length,n=0;n!==e;n++){var i=t[n];if(!(i.visited||i.body.type&c))return i}return!1}var u=[];function h(t,e,n,i){for(u.push(t),t.visited=!0,e(t,n,i);u.length;)for(var r,o=u.pop();r=l(o.children);)r.visited=!0,e(r,n,i),u.push(r)}function f(t,e,n){e.push(t.body);for(var i=t.eqs.length,r=0;r!==i;r++){var o=t.eqs[r];-1===n.indexOf(o)&&n.push(o)}}function p(t,e){return e.id-t.id}r.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},r.prototype.solve=function(t,e){for(var n=o,i=this.nodePool,r=e.bodies,c=this.equations,u=c.length,d=r.length,_=this.subsolver;i.length<d;)i.push(this.createNode());n.length=d;for(var m=0;m<d;m++)n[m]=i[m];for(m=0;m!==d;m++){var v=n[m];v.body=r[m],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var g=0;g!==u;g++){var y=c[g],x=(m=r.indexOf(y.bi),r.indexOf(y.bj)),S=n[m],T=n[x];S.children.push(T),S.eqs.push(y),T.children.push(S),T.eqs.push(y)}var E,b=0,C=a;_.tolerance=this.tolerance,_.iterations=this.iterations;for(var A=s;E=l(n);){C.length=0,A.bodies.length=0,h(E,f,A.bodies,C);var w=C.length;for(C=C.sort(p),m=0;m!==w;m++)_.addEquation(C[m]);_.solve(t,A),_.removeAllEquations(),b++}return b}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(t,e){var n=function(){};e.exports=n,n.prototype={constructor:n,addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[t]&&(n[t]=[]),-1===n[t].indexOf(e)&&n[t].push(e),this},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[t]&&-1!==n[t].indexOf(e)},hasAnyEventListener:function(t){return void 0!==this._listeners&&void 0!==this._listeners[t]},removeEventListener:function(t,e){if(void 0===this._listeners)return this;var n=this._listeners;if(void 0===n[t])return this;var i=n[t].indexOf(e);return-1!==i&&n[t].splice(i,1),this},dispatchEvent:function(t){if(void 0===this._listeners)return this;var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var n=0,i=e.length;n<i;n++)e[n].call(this,t)}return this}}},{}],51:[function(t,e){var n=t("../collision/AABB"),i=t("../math/Vec3");function r(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new n,this.data=[],this.children=[]}function o(t,e){(e=e||{}).root=null,e.aabb=t,r.call(this,e),this.maxDepth=void 0!==e.maxDepth?e.maxDepth:8}e.exports=o,o.prototype=new r,r.prototype.reset=function(){this.children.length=this.data.length=0},r.prototype.insert=function(t,e,n){var i=this.data;if(n=n||0,!this.aabb.contains(t))return!1;var r=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var o=!1;r.length||(this.subdivide(),o=!0);for(var a=0;8!==a;a++)if(r[a].insert(t,e,n+1))return!0;o&&(r.length=0)}return i.push(e),!0};var a=new i;r.prototype.subdivide=function(){var t=this.aabb,e=t.lowerBound,o=t.upperBound,s=this.children;s.push(new r({aabb:new n({lowerBound:new i(0,0,0)})}),new r({aabb:new n({lowerBound:new i(1,0,0)})}),new r({aabb:new n({lowerBound:new i(1,1,0)})}),new r({aabb:new n({lowerBound:new i(1,1,1)})}),new r({aabb:new n({lowerBound:new i(0,1,1)})}),new r({aabb:new n({lowerBound:new i(0,0,1)})}),new r({aabb:new n({lowerBound:new i(1,0,1)})}),new r({aabb:new n({lowerBound:new i(0,1,0)})})),o.vsub(e,a),a.scale(.5,a);for(var c=this.root||this,l=0;8!==l;l++){var u=s[l];u.root=c;var h=u.aabb.lowerBound;h.x*=a.x,h.y*=a.y,h.z*=a.z,h.vadd(e,h),h.vadd(a,u.aabb.upperBound)}},r.prototype.aabbQuery=function(t,e){this.data,this.children;for(var n=[this];n.length;){var i=n.pop();i.aabb.overlaps(t)&&Array.prototype.push.apply(e,i.data),Array.prototype.push.apply(n,i.children)}return e};var s=new n;r.prototype.rayQuery=function(t,e,n){return t.getAABB(s),s.toLocalFrame(e,s),this.aabbQuery(s,n),n},r.prototype.removeEmptyNodes=function(){for(var t=this.children.length-1;t>=0;t--)this.children[t].removeEmptyNodes(),this.children[t].children.length||this.children[t].data.length||this.children.splice(t,1)}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(t,e){function n(){this.objects=[],this.type=Object}e.exports=n,n.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e]);return this},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},n.prototype.resize=function(t){for(var e=this.objects;e.length>t;)e.pop();for(;e.length<t;)e.push(this.constructObject());return this}},{}],53:[function(t,e){function n(){this.data={keys:[]}}e.exports=n,n.prototype.get=function(t,e){if(t>e){var n=e;e=t,t=n}return this.data[t+"-"+e]},n.prototype.set=function(t,e,n){if(t>e){var i=e;e=t,t=i}var r=t+"-"+e;return this.get(t,e)||this.data.keys.push(r),this.data[r]=n,this.data[r]},n.prototype.del=function(t,e){if(t>e){var n=e;e=t,t=n}var i=t+"-"+e,r=this.data.keys.indexOf(i);return r>=0&&(this.data.keys.splice(r,1),delete this.data[i],!0)},n.prototype.reset=function(){this.data={keys:[]}},n.prototype.getLength=function(){return this.data.keys.length},n.prototype.getKeyByIndex=function(t){return this.data.keys[t]},n.prototype.getDataByKey=function(t){return this.data[t]}},{}],54:[function(t,e){function n(){}e.exports=n,n.defaults=function(t,e){for(var n in t=t||{},e)n in t||(t[n]=e[n]);return t}},{}],55:[function(t,e){e.exports=r;var n=t("../math/Vec3"),i=t("./Pool");function r(){i.call(this),this.type=n}r.prototype=new i,r.prototype.constructObject=function(){return new n}},{"../math/Vec3":31,"./Pool":52}],56:[function(t,e){e.exports=h;var n=t("../collision/AABB"),i=(t("../objects/Body"),t("../shapes/Shape")),r=t("../collision/Ray"),o=t("../math/Vec3"),a=t("../math/Transform"),s=(t("../shapes/ConvexPolyhedron"),t("../math/Quaternion")),c=(t("../solver/Solver"),t("../utils/Vec3Pool")),l=t("../equations/ContactEquation"),u=t("../equations/FrictionEquation");function h(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new c,this.world=t,this.currentContactMaterial=null,this.enableFrictionReduction=!1}h.prototype.createContactEquation=function(t,e,n,i,r,o){var a;this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=t,a.bj=e):a=new l(t,e),a.enabled=t.collisionResponse&&e.collisionResponse&&n.collisionResponse&&i.collisionResponse;var s=this.currentContactMaterial,c=s.contactEquationRelaxation;a.restitution=s.restitution;var u=n.material||t.material,h=i.material||e.material;if(u&&h){u.restitution>=0&&h.restitution>=0&&(a.restitution=u.restitution*h.restitution);var f=u.correctInelastic||h.correctInelastic;f&&(c*=f)}return a.setSpookParams(s.contactEquationStiffness,c,this.world.dt),a.si=r||n,a.sj=o||i,a},h.prototype.createFrictionEquationsFromContact=function(t,e){var n=t.bi,i=t.bj,r=t.si,o=t.sj,a=this.world,s=this.currentContactMaterial,c=s.friction,l=r.material||n.material,h=o.material||i.material;if(l&&h&&l.friction>=0&&h.friction>=0&&(c=l.friction*h.friction),c>0){var f=c*a.gravity.length(),p=n.invMass+i.invMass;p>0&&(p=1/p);var d=this.frictionEquationPool,_=d.length?d.pop():new u(n,i,f*p),m=d.length?d.pop():new u(n,i,f*p);return _.bi=m.bi=n,_.bj=m.bj=i,_.minForce=m.minForce=-f*p,_.maxForce=m.maxForce=f*p,_.ri.copy(t.ri),_.rj.copy(t.rj),m.ri.copy(t.ri),m.rj.copy(t.rj),t.ni.tangents(_.t,m.t),_.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),m.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),_.enabled=m.enabled=t.enabled,e.push(_,m),!0}return!1};var f=new o,p=new o,d=new o;h.prototype.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var n=this.frictionResult[this.frictionResult.length-2],i=this.frictionResult[this.frictionResult.length-1];f.setZero(),p.setZero(),d.setZero();for(var r=e.bi,o=(e.bj,0);o!==t;o++)(e=this.result[this.result.length-1-o]).bodyA!==r?(f.vadd(e.ni,f),p.vadd(e.ri,p),d.vadd(e.rj,d)):(f.vsub(e.ni,f),p.vadd(e.rj,p),d.vadd(e.ri,d));var a=1/t;p.scale(a,n.ri),d.scale(a,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),f.normalize(),f.tangents(n.t,i.t)}};var _=new o,m=new o,v=new s,g=new s;h.prototype.getContacts=function(t,e,n,i,r,o,a){this.contactPointPool=r,this.frictionEquationPool=a,this.result=i,this.frictionResult=o;for(var s=v,c=g,l=_,u=m,h=0,f=t.length;h!==f;h++){var p=t[h],d=e[h],y=null;p.material&&d.material&&(y=n.getContactMaterial(p.material,d.material)||null);for(var x=0==p.collisionResponse||0==d.collisionResponse,S=0;S<p.shapes.length;S++){p.quaternion.mult(p.shapeOrientations[S],s),p.quaternion.vmult(p.shapeOffsets[S],l),l.vadd(p.position,l);for(var T=p.shapes[S],E=0;E<d.shapes.length;E++){d.quaternion.mult(d.shapeOrientations[E],c),d.quaternion.vmult(d.shapeOffsets[E],u),u.vadd(d.position,u);var b=d.shapes[E];if(T.collisionFilterMask&b.collisionFilterGroup&&b.collisionFilterMask&T.collisionFilterGroup&&!(l.distanceTo(u)>T.boundingSphereRadius+b.boundingSphereRadius)){x|=0==T.collisionResponse||0==b.collisionResponse;var C=null;T.material&&b.material&&(C=n.getContactMaterial(T.material,b.material)||null),this.currentContactMaterial=C||y||n.defaultContactMaterial;var A=this[T.type|b.type];if(A&&(T.type<b.type?A.call(this,T,b,l,u,s,c,p,d,T,b,x):A.call(this,b,T,u,l,c,s,d,p,T,b,x))&&x){n.shapeOverlapKeeper.set(T.id,b.id),n.bodyOverlapKeeper.set(p.id,d.id);var w={si:T,sj:b};n.triggerDic.set(T.id,b.id,w),n.oldTriggerDic.set(T.id,b.id,w)}}}}}},h.prototype[i.types.BOX|i.types.BOX]=h.prototype.boxBox=function(t,e,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,n,i,r,o,a,s,t,e,u)},h.prototype[i.types.BOX|i.types.CONVEXPOLYHEDRON]=h.prototype.boxConvex=function(t,e,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,n,i,r,o,a,s,t,e,u)},h.prototype[i.types.BOX|i.types.PARTICLE]=h.prototype.boxParticle=function(t,e,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,n,i,r,o,a,s,t,e,u)},h.prototype[i.types.SPHERE]=h.prototype.sphereSphere=function(t,e,n,i,r,o,a,s,c,l,u){if(u)return n.distanceSquared(i)<Math.pow(t.radius+e.radius,2);var h=this.createContactEquation(a,s,t,e,c,l);i.vsub(n,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(t.radius,h.ri),h.rj.mult(-e.radius,h.rj),h.ri.vadd(n,h.ri),h.ri.vsub(a.position,h.ri),h.rj.vadd(i,h.rj),h.rj.vsub(s.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var y=new o,x=new o,S=new o;h.prototype[i.types.PLANE|i.types.TRIMESH]=h.prototype.planeTrimesh=function(t,e,n,i,r,s,c,l,u,h,f){var p=new o,d=y;d.set(0,0,1),r.vmult(d,d);for(var _=0;_<e.vertices.length/3;_++){e.getVertex(_,p);var m=new o;m.copy(p),a.pointToWorldFrame(i,s,m,p);var v=x;if(p.vsub(n,v),d.dot(v)<=0){if(f)return!0;var g=this.createContactEquation(c,l,t,e,u,h);g.ni.copy(d);var T=S;d.scale(v.dot(d),T),p.vsub(T,T),g.ri.copy(T),g.ri.vsub(c.position,g.ri),g.rj.copy(p),g.rj.vsub(l.position,g.rj),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}}};var T=new o,E=new o,b=(new o,new o),C=new o,A=new o,w=new o,R=new o,P=new o,I=new o,M=new o,D=new o,O=new o,N=new o,L=new n,B=[];h.prototype[i.types.SPHERE|i.types.TRIMESH]=h.prototype.sphereTrimesh=function(t,e,n,i,o,s,c,l,u,h,f){var p=A,d=w,_=R,m=P,v=I,g=M,y=L,x=C,S=E,F=B;a.pointToLocalFrame(i,s,n,v);var z=t.radius;y.lowerBound.set(v.x-z,v.y-z,v.z-z),y.upperBound.set(v.x+z,v.y+z,v.z+z),e.getTrianglesInAABB(y,F);for(var k=b,U=t.radius*t.radius,G=0;G<F.length;G++)for(var H=0;H<3;H++)if(e.getVertex(e.indices[3*F[G]+H],k),k.vsub(v,S),S.norm2()<=U){if(x.copy(k),a.pointToWorldFrame(i,s,x,k),k.vsub(n,S),f)return!0;(j=this.createContactEquation(c,l,t,e,u,h)).ni.copy(S),j.ni.normalize(),j.ri.copy(j.ni),j.ri.scale(t.radius,j.ri),j.ri.vadd(n,j.ri),j.ri.vsub(c.position,j.ri),j.rj.copy(k),j.rj.vsub(l.position,j.rj),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}for(G=0;G<F.length;G++)for(H=0;H<3;H++){e.getVertex(e.indices[3*F[G]+H],p),e.getVertex(e.indices[3*F[G]+(H+1)%3],d),d.vsub(p,_),v.vsub(d,g);var V=g.dot(_);v.vsub(p,g);var W=g.dot(_);if(W>0&&V<0&&(v.vsub(p,g),m.copy(_),m.normalize(),W=g.dot(m),m.scale(W,g),g.vadd(p,g),(Z=g.distanceTo(v))<t.radius)){if(f)return!0;var j=this.createContactEquation(c,l,t,e,u,h);g.vsub(v,j.ni),j.ni.normalize(),j.ni.scale(t.radius,j.ri),a.pointToWorldFrame(i,s,g,g),g.vsub(l.position,j.rj),a.vectorToWorldFrame(s,j.ni,j.ni),a.vectorToWorldFrame(s,j.ri,j.ri),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}}for(var q=D,X=O,Y=N,K=T,Q=(G=0,F.length);G!==Q;G++){e.getTriangleVertices(F[G],q,X,Y),e.getNormal(F[G],K),v.vsub(q,g);var Z=g.dot(K);if(K.scale(Z,g),v.vsub(g,g),Z=g.distanceTo(v),r.pointInTriangle(g,q,X,Y)&&Z<t.radius){if(f)return!0;j=this.createContactEquation(c,l,t,e,u,h),g.vsub(v,j.ni),j.ni.normalize(),j.ni.scale(t.radius,j.ri),a.pointToWorldFrame(i,s,g,g),g.vsub(l.position,j.rj),a.vectorToWorldFrame(s,j.ni,j.ni),a.vectorToWorldFrame(s,j.ri,j.ri),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}}F.length=0};var F=new o,z=new o,k=new o,U=new o,G=new o;h.prototype[i.types.SPHERE|i.types.PLANE]=h.prototype.spherePlane=function(t,e,n,i,r,o,a,s,c,l,u){if(k.set(0,0,1),o.vmult(k,k),k.negate(k),k.normalize(),k.mult(t.radius,U),n.vsub(i,F),k.mult(k.dot(F),z),F.vsub(z,G),-F.dot(k)<=t.radius){if(u)return!0;var h=this.createContactEquation(a,s,t,e,c,l);h.ni.copy(k),h.ri.copy(U),h.rj.copy(G);var f=h.ri,p=h.rj;f.vadd(n,f),f.vsub(a.position,f),p.vadd(i,p),p.vsub(s.position,p),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}return!1};var H=new o,V=new o,W=new o;function j(t,e,n){for(var i=null,r=t.length,o=0;o!==r;o++){var a=t[o],s=H;t[(o+1)%r].vsub(a,s);var c=V;s.cross(e,c);var l=W;n.vsub(a,l);var u=c.dot(l);if(!(null===i||u>0&&!0===i||u<=0&&!1===i))return!1;null===i&&(i=u>0)}return!0}var q=new o,X=new o,Y=new o,K=new o,Q=[new o,new o,new o,new o,new o,new o],Z=new o,J=new o,$=new o,tt=new o;h.prototype[i.types.SPHERE|i.types.BOX]=h.prototype.sphereBox=function(t,e,n,i,r,o,a,s,c,l,u){var h=this.v3pool,f=Q;n.vsub(i,q),e.getSideNormals(f,o);for(var p=t.radius,d=!1,_=J,m=$,v=tt,g=null,y=0,x=0,S=0,T=null,E=0,b=f.length;E!==b&&!1===d;E++){var C=X;C.copy(f[E]);var A=C.norm();C.normalize();var w=q.dot(C);if(w<A+p&&w>0){var R=Y,P=K;R.copy(f[(E+1)%3]),P.copy(f[(E+2)%3]);var I=R.norm(),M=P.norm();R.normalize(),P.normalize();var D=q.dot(R),O=q.dot(P);if(D<I&&D>-I&&O<M&&O>-M){var N=Math.abs(w-A-p);if((null===T||N<T)&&(T=N,x=D,S=O,g=A,_.copy(C),m.copy(R),v.copy(P),y++,u))return!0}}}if(y){d=!0;var L=this.createContactEquation(a,s,t,e,c,l);_.mult(-p,L.ri),L.ni.copy(_),L.ni.negate(L.ni),_.mult(g,_),m.mult(x,m),_.vadd(m,_),v.mult(S,v),_.vadd(v,L.rj),L.ri.vadd(n,L.ri),L.ri.vsub(a.position,L.ri),L.rj.vadd(i,L.rj),L.rj.vsub(s.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}for(var B=h.get(),F=Z,z=0;2!==z&&!d;z++)for(var k=0;2!==k&&!d;k++)for(var U=0;2!==U&&!d;U++)if(B.set(0,0,0),z?B.vadd(f[0],B):B.vsub(f[0],B),k?B.vadd(f[1],B):B.vsub(f[1],B),U?B.vadd(f[2],B):B.vsub(f[2],B),i.vadd(B,F),F.vsub(n,F),F.norm2()<p*p){if(u)return!0;d=!0,(L=this.createContactEquation(a,s,t,e,c,l)).ri.copy(F),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(p,L.ri),L.rj.copy(B),L.ri.vadd(n,L.ri),L.ri.vsub(a.position,L.ri),L.rj.vadd(i,L.rj),L.rj.vsub(s.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}h.release(B),B=null;var G=h.get(),H=h.get(),V=(L=h.get(),h.get()),W=(N=h.get(),f.length);for(z=0;z!==W&&!d;z++)for(k=0;k!==W&&!d;k++)if(z%3!=k%3){f[k].cross(f[z],G),G.normalize(),f[z].vadd(f[k],H),L.copy(n),L.vsub(H,L),L.vsub(i,L);var j=L.dot(G);for(G.mult(j,V),U=0;U===z%3||U===k%3;)U++;N.copy(n),N.vsub(V,N),N.vsub(H,N),N.vsub(i,N);var et=Math.abs(j),nt=N.norm();if(et<f[U].norm()&&nt<p){if(u)return!0;d=!0;var it=this.createContactEquation(a,s,t,e,c,l);H.vadd(V,it.rj),it.rj.copy(it.rj),N.negate(it.ni),it.ni.normalize(),it.ri.copy(it.rj),it.ri.vadd(i,it.ri),it.ri.vsub(n,it.ri),it.ri.normalize(),it.ri.mult(p,it.ri),it.ri.vadd(n,it.ri),it.ri.vsub(a.position,it.ri),it.rj.vadd(i,it.rj),it.rj.vsub(s.position,it.rj),this.result.push(it),this.createFrictionEquationsFromContact(it,this.frictionResult)}}h.release(G,H,L,V,N)};var et=new o,nt=new o,it=new o,rt=new o,ot=new o,at=new o,st=new o,ct=new o,lt=new o,ut=new o;h.prototype[i.types.SPHERE|i.types.CONVEXPOLYHEDRON]=h.prototype.sphereConvex=function(t,e,n,i,r,o,a,s,c,l,u){var h=this.v3pool;n.vsub(i,et);for(var f=e.faceNormals,p=e.faces,d=e.vertices,_=t.radius,m=0;m!==d.length;m++){var v=d[m],g=ot;o.vmult(v,g),i.vadd(g,g);var y=rt;if(g.vsub(n,y),y.norm2()<_*_)return!!u||(x=!0,(N=this.createContactEquation(a,s,t,e,c,l)).ri.copy(y),N.ri.normalize(),N.ni.copy(N.ri),N.ri.mult(_,N.ri),g.vsub(i,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),this.result.push(N),void this.createFrictionEquationsFromContact(N,this.frictionResult))}for(var x=!1,S=(m=0,p.length);m!==S&&!1===x;m++){var T=f[m],E=p[m],b=at;o.vmult(T,b);var C=st;o.vmult(d[E[0]],C),C.vadd(i,C);var A=ct;b.mult(-_,A),n.vadd(A,A);var w=lt;A.vsub(C,w);var R=w.dot(b),P=ut;if(n.vsub(C,P),R<0&&P.dot(b)>0){for(var I=[],M=0,D=E.length;M!==D;M++){var O=h.get();o.vmult(d[E[M]],O),i.vadd(O,O),I.push(O)}if(j(I,b,n)){if(u)return!0;x=!0;var N=this.createContactEquation(a,s,t,e,c,l);b.mult(-_,N.ri),b.negate(N.ni);var L=h.get();b.mult(-R,L);var B=h.get();b.mult(-_,B),n.vsub(i,N.rj),N.rj.vadd(B,N.rj),N.rj.vadd(L,N.rj),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),h.release(L),h.release(B),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),M=0;for(var F=I.length;M!==F;M++)h.release(I[M]);return}for(M=0;M!==E.length;M++){var z=h.get(),k=h.get();o.vmult(d[E[(M+1)%E.length]],z),o.vmult(d[E[(M+2)%E.length]],k),i.vadd(z,z),i.vadd(k,k);var U=nt;k.vsub(z,U);var G=it;U.unit(G);var H=h.get(),V=h.get();n.vsub(z,V);var W=V.dot(G);G.mult(W,H),H.vadd(z,H);var q=h.get();if(H.vsub(n,q),W>0&&W*W<U.norm2()&&q.norm2()<_*_){if(u)return!0;for(N=this.createContactEquation(a,s,t,e,c,l),H.vsub(i,N.rj),H.vsub(n,N.ni),N.ni.normalize(),N.ni.mult(_,N.ri),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),M=0,F=I.length;M!==F;M++)h.release(I[M]);return h.release(z),h.release(k),h.release(H),h.release(q),void h.release(V)}h.release(z),h.release(k),h.release(H),h.release(q),h.release(V)}for(M=0,F=I.length;M!==F;M++)h.release(I[M])}}},new o,new o,h.prototype[i.types.PLANE|i.types.BOX]=h.prototype.planeBox=function(t,e,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,e.convexPolyhedronRepresentation.id=e.id,this.planeConvex(t,e.convexPolyhedronRepresentation,n,i,r,o,a,s,t,e,u)};var ht=new o,ft=new o,pt=new o,dt=new o;h.prototype[i.types.PLANE|i.types.CONVEXPOLYHEDRON]=h.prototype.planeConvex=function(t,e,n,i,r,o,a,s,c,l,u){var h=ht,f=ft;f.set(0,0,1),r.vmult(f,f);for(var p=0,d=pt,_=0;_!==e.vertices.length;_++)if(h.copy(e.vertices[_]),o.vmult(h,h),i.vadd(h,h),h.vsub(n,d),f.dot(d)<=0){if(u)return!0;var m=this.createContactEquation(a,s,t,e,c,l),v=dt;f.mult(f.dot(d),v),h.vsub(v,v),v.vsub(n,m.ri),m.ni.copy(f),h.vsub(i,m.rj),m.ri.vadd(n,m.ri),m.ri.vsub(a.position,m.ri),m.rj.vadd(i,m.rj),m.rj.vsub(s.position,m.rj),this.result.push(m),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)};var _t=new o,mt=new o;h.prototype[i.types.CONVEXPOLYHEDRON]=h.prototype.convexConvex=function(t,e,n,i,r,o,a,s,c,l,u,h,f){var p=_t;if(!(n.distanceTo(i)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,n,r,i,o,p,h,f)){var d=[],_=mt;t.clipAgainstHull(n,r,e,i,o,p,-100,100,d);for(var m=0,v=0;v!==d.length;v++){if(u)return!0;var g=this.createContactEquation(a,s,t,e,c,l),y=g.ri,x=g.rj;p.negate(g.ni),d[v].normal.negate(_),_.mult(d[v].depth,_),d[v].point.vadd(_,y),x.copy(d[v].point),y.vsub(n,y),x.vsub(i,x),y.vadd(n,y),y.vsub(a.position,y),x.vadd(i,x),x.vsub(s.position,x),this.result.push(g),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(g,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}};var vt=new o,gt=new o,yt=new o;h.prototype[i.types.PLANE|i.types.PARTICLE]=h.prototype.planeParticle=function(t,e,n,i,r,o,a,s,c,l,u){var h=vt;h.set(0,0,1),a.quaternion.vmult(h,h);var f=gt;if(i.vsub(a.position,f),h.dot(f)<=0){if(u)return!0;var p=this.createContactEquation(s,a,e,t,c,l);p.ni.copy(h),p.ni.negate(p.ni),p.ri.set(0,0,0);var d=yt;h.mult(h.dot(i),d),i.vsub(d,d),p.rj.copy(d),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}};var xt=new o;h.prototype[i.types.PARTICLE|i.types.SPHERE]=h.prototype.sphereParticle=function(t,e,n,i,r,o,a,s,c,l,u){var h=xt;if(h.set(0,0,1),i.vsub(n,h),h.norm2()<=t.radius*t.radius){if(u)return!0;var f=this.createContactEquation(s,a,e,t,c,l);h.normalize(),f.rj.copy(h),f.rj.mult(t.radius,f.rj),f.ni.copy(h),f.ni.negate(f.ni),f.ri.set(0,0,0),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}};var St=new s,Tt=new o,Et=(new o,new o),bt=new o,Ct=new o;h.prototype[i.types.PARTICLE|i.types.CONVEXPOLYHEDRON]=h.prototype.convexParticle=function(t,e,n,i,r,o,a,s,c,l,u){var h=-1,f=Et,p=Ct,d=null,_=Tt;if(_.copy(i),_.vsub(n,_),r.conjugate(St),St.vmult(_,_),t.pointIsInside(_)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(n,r),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(r);for(var m=0,v=t.faces.length;m!==v;m++){var g=[t.worldVertices[t.faces[m][0]]],y=t.worldFaceNormals[m];i.vsub(g[0],bt);var x=-y.dot(bt);if(null===d||Math.abs(x)<Math.abs(d)){if(u)return!0;d=x,h=m,f.copy(y)}}if(-1!==h){var S=this.createContactEquation(s,a,e,t,c,l);f.mult(d,p),p.vadd(i,p),p.vsub(n,p),S.rj.copy(p),f.negate(S.ni),S.ri.set(0,0,0);var T=S.ri,E=S.rj;T.vadd(i,T),T.vsub(s.position,T),E.vadd(n,E),E.vsub(a.position,E),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},h.prototype[i.types.BOX|i.types.HEIGHTFIELD]=h.prototype.boxHeightfield=function(t,e,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,n,i,r,o,a,s,t,e,u)};var At=new o,wt=new o,Rt=[0];h.prototype[i.types.CONVEXPOLYHEDRON|i.types.HEIGHTFIELD]=h.prototype.convexHeightfield=function(t,e,n,i,r,o,s,c,l,u,h){var f=e.data,p=e.elementSize,d=t.boundingSphereRadius,_=wt,m=Rt,v=At;a.pointToLocalFrame(i,o,n,v);var g=Math.floor((v.x-d)/p)-1,y=Math.ceil((v.x+d)/p)+1,x=Math.floor((v.y-d)/p)-1,S=Math.ceil((v.y+d)/p)+1;if(!(y<0||S<0||g>f.length||x>f[0].length)){g<0&&(g=0),y<0&&(y=0),x<0&&(x=0),S<0&&(S=0),g>=f.length&&(g=f.length-1),y>=f.length&&(y=f.length-1),S>=f[0].length&&(S=f[0].length-1),x>=f[0].length&&(x=f[0].length-1);var T=[];e.getRectMinMax(g,x,y,S,T);var E=T[0],b=T[1];if(!(v.z-d>b||v.z+d<E))for(var C=g;C<y;C++)for(var A=x;A<S;A++){var w=!1;if(e.getConvexTrianglePillar(C,A,!1),a.pointToWorldFrame(i,o,e.pillarOffset,_),n.distanceTo(_)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(w=this.convexConvex(t,e.pillarConvex,n,_,r,o,s,c,l,u,h,m,null)),h&&w)return!0;if(e.getConvexTrianglePillar(C,A,!0),a.pointToWorldFrame(i,o,e.pillarOffset,_),n.distanceTo(_)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(w=this.convexConvex(t,e.pillarConvex,n,_,r,o,s,c,l,u,h,m,null)),h&&w)return!0}}};var Pt=new o,It=new o;h.prototype[i.types.SPHERE|i.types.HEIGHTFIELD]=h.prototype.sphereHeightfield=function(t,e,n,i,r,o,s,c,l,u,h){var f=e.data,p=t.radius,d=e.elementSize,_=It,m=Pt;a.pointToLocalFrame(i,o,n,m);var v=Math.floor((m.x-p)/d)-1,g=Math.ceil((m.x+p)/d)+1,y=Math.floor((m.y-p)/d)-1,x=Math.ceil((m.y+p)/d)+1;if(!(g<0||x<0||v>f.length||y>f[0].length)){v<0&&(v=0),g<0&&(g=0),y<0&&(y=0),x<0&&(x=0),v>=f.length&&(v=f.length-1),g>=f.length&&(g=f.length-1),x>=f[0].length&&(x=f[0].length-1),y>=f[0].length&&(y=f[0].length-1);var S=[];e.getRectMinMax(v,y,g,x,S);var T=S[0],E=S[1];if(!(m.z-p>E||m.z+p<T))for(var b=this.result,C=v;C<g;C++)for(var A=y;A<x;A++){var w=b.length,R=!1;if(e.getConvexTrianglePillar(C,A,!1),a.pointToWorldFrame(i,o,e.pillarOffset,_),n.distanceTo(_)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(R=this.sphereConvex(t,e.pillarConvex,n,_,r,o,s,c,t,e,h)),h&&R)return!0;if(e.getConvexTrianglePillar(C,A,!0),a.pointToWorldFrame(i,o,e.pillarOffset,_),n.distanceTo(_)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(R=this.sphereConvex(t,e.pillarConvex,n,_,r,o,s,c,t,e,h)),h&&R)return!0;if(b.length-w>2)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(t,e){e.exports=g,t("../shapes/Shape");var n=t("../math/Vec3"),i=t("../math/Quaternion"),r=t("../solver/GSSolver"),o=(t("../equations/ContactEquation"),t("../equations/FrictionEquation"),t("./Narrowphase")),a=t("../utils/EventTarget"),s=t("../collision/ArrayCollisionMatrix"),c=t("../collision/ObjectCollisionMatrix"),l=t("../collision/OverlapKeeper"),u=t("../material/Material"),h=t("../material/ContactMaterial"),f=t("../objects/Body"),p=t("../utils/TupleDictionary"),d=t("../collision/RaycastResult"),_=t("../collision/AABB"),m=t("../collision/Ray"),v=t("../collision/NaiveBroadphase");function g(t){t=t||{},a.apply(this),this.dt=-1,this.allowSleep=!!t.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==t.quatNormalizeSkip?t.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==t.quatNormalizeFast&&t.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new n,t.gravity&&this.gravity.copy(t.gravity),this.broadphase=void 0!==t.broadphase?t.broadphase:new v,this.bodies=[],this.solver=void 0!==t.solver?t.solver:new r,this.constraints=[],this.narrowphase=new o(this),this.collisionMatrix=new s,this.collisionMatrixPrevious=new s,this.bodyOverlapKeeper=new l,this.shapeOverlapKeeper=new l,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new p,this.defaultMaterial=new u("default"),this.defaultContactMaterial=new h(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this),this.substeps=0,this.cm=new c,this.tm=new c,this.triggerDic=new p,this.oldTriggerDic=new p,this.contactsDic=new p,this.oldContactsDic=new p}g.idToBodyMap={},g.idToShapeMap={},g.integrateKinematic=!1,g.ccdSphereAdvance=!1,g.prototype=new a,new _;var y=new m;if(g.prototype.getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)},g.prototype.numObjects=function(){return this.bodies.length},g.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},g.prototype.add=g.prototype.addBody=function(t){-1===this.bodies.indexOf(t)&&(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof f&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.cm.setNumObjects(this.bodies.length),g.idToBodyMap[t.id]=t,this.dispatchEvent(this.addBodyEvent))},g.prototype.addConstraint=function(t){this.constraints.push(t)},g.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},g.prototype.rayTest=function(t,e,n){n instanceof d?this.raycastClosest(t,e,{skipBackfaces:!0},n):this.raycastAll(t,e,{skipBackfaces:!0},n)},g.prototype.raycastAll=function(t,e,n,i){return n.mode=m.ALL,n.from=t,n.to=e,n.callback=i,y.intersectWorld(this,n)},g.prototype.raycastAny=function(t,e,n,i){return n.mode=m.ANY,n.from=t,n.to=e,n.result=i,y.intersectWorld(this,n)},g.prototype.raycastClosest=function(t,e,n,i){return n.mode=m.CLOSEST,n.from=t,n.to=e,n.result=i,y.intersectWorld(this,n)},g.prototype.remove=function(t){t.world=null;var e=this.bodies.length-1,n=this.bodies,i=n.indexOf(t);if(-1!==i){n.splice(i,1);for(var r=0;r!==n.length;r++)n[r].index=r;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,delete g.idToBodyMap[t.id],this.cm.setNumObjects(e),this.dispatchEvent(this.removeBodyEvent)}},g.prototype.removeBody=g.prototype.remove,g.prototype.getBodyById=function(t){return g.idToBodyMap[t]},g.prototype.getShapeById=function(t){return g.idToShapeMap[t]},g.prototype.addMaterial=function(t){this.materials.push(t)},g.prototype.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},"undefined"==typeof performance&&(performance={}),!performance.now){var x=Date.now();performance.timing&&performance.timing.navigationStart&&(x=performance.timing.navigationStart),performance.now=function(){return Date.now()-x}}g.prototype.saveKinematicAndApplyGravity=function(t){for(var e=this.bodies,n=this.bodies.length,i=0;i!==n;i++){var r=e[i];r.type===f.DYNAMIC?r.applyGravity(this.gravity):r.type===f.KINEMATIC&&r.updateKinematic(t)}},g.prototype.step=function(t,e,n){if(n=n||10,0===(e=e||0))this.saveKinematicAndApplyGravity(t),this.internalStep(t),this.time+=t,this.substeps=1;else{for(this.saveKinematicAndApplyGravity(e),this.accumulator+=e,this.substeps=0;this.accumulator>=t&&this.substeps<n;)this.internalStep(t),this.accumulator-=t,this.substeps++;for(var i=this.accumulator%t/t,r=0;r!==this.bodies.length;r++){var o=this.bodies[r];o.previousPosition.lerp(o.position,i,o.interpolatedPosition),o.previousQuaternion.slerp(o.quaternion,i,o.interpolatedQuaternion),o.previousQuaternion.normalize()}this.time+=e}this.clearForces()};var S,T,E,b,C,A,w={type:"postStep"},R={type:"preStep"},P={type:"collide",body:null,contact:null},I=[],M=[],D=[],O=[];new n,new n,new n,new n,new n,new n,new n,new n,new n,new i,new i,new i,new n,g.prototype.internalStep=function(t){this.dt=t;var e,n=this.contacts,i=D,r=O,o=this.numObjects(),a=this.bodies,s=this.solver,c=this.doProfiling,l=this.profile,u=f.DYNAMIC,h=this.constraints,p=M,d=0;c&&(e=performance.now()),d=0;for(var _=this.subsystems.length;d!==_;d++)this.subsystems[d].update();c&&(e=performance.now()),i.length=0,r.length=0,this.broadphase.collisionPairs(this,i,r),c&&(l.broadphase=performance.now()-e);var m=h.length;for(d=0;d!==m;d++)if(!(N=h[d]).collideConnected)for(var v=i.length-1;v>=0;v-=1)(N.bodyA===i[v]&&N.bodyB===r[v]||N.bodyB===i[v]&&N.bodyA===r[v])&&(i.splice(v,1),r.splice(v,1));this.collisionMatrixTick(),c&&(e=performance.now());var g=I,y=n.length;for(d=0;d!==y;d++)g.push(n[d]);n.length=0;var x=this.frictionEquations.length;for(d=0;d!==x;d++)p.push(this.frictionEquations[d]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,r,this,n,g,this.frictionEquations,p),c&&(l.narrowphase=performance.now()-e),c&&(e=performance.now()),d=0;d<this.frictionEquations.length;d++)s.addEquation(this.frictionEquations[d]);for(var S=n.length,T=0;T!==S;T++){var E=(N=n[T]).bi,b=N.bj,C=N.si,A=N.sj;C.material&&A.material?C.material.restitution>=0&&A.material.restitution>=0&&(N.restitution=C.material.restitution*A.material.restitution):E.material&&b.material&&E.material.restitution>=0&&b.material.restitution>=0&&(N.restitution=E.material.restitution*b.material.restitution),s.addEquation(N),E.allowSleep&&E.type===f.DYNAMIC&&E.sleepState===f.SLEEPING&&b.sleepState===f.AWAKE&&b.type!==f.STATIC&&b.velocity.norm2()+b.angularVelocity.norm2()>=2*Math.pow(b.sleepSpeedLimit,2)&&(E._wakeUpAfterNarrowphase=!0),b.allowSleep&&b.type===f.DYNAMIC&&b.sleepState===f.SLEEPING&&E.sleepState===f.AWAKE&&E.type!==f.STATIC&&E.velocity.norm2()+E.angularVelocity.norm2()>=2*Math.pow(E.sleepSpeedLimit,2)&&(b._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(E,b,!0),this.collisionMatrixPrevious.get(E,b)||(P.body=b,P.contact=N,E.dispatchEvent(P),P.body=E,b.dispatchEvent(P)),this.bodyOverlapKeeper.set(E.id,b.id),this.shapeOverlapKeeper.set(C.id,A.id)}for(this.emitContactEvents(),c&&(l.makeContactConstraints=performance.now()-e,e=performance.now()),d=0;d!==o;d++)(E=a[d])._wakeUpAfterNarrowphase&&(E.wakeUp(),E._wakeUpAfterNarrowphase=!1);for(m=h.length,d=0;d!==m;d++){var N;(N=h[d]).update(),v=0;for(var L=N.equations.length;v!==L;v++){var B=N.equations[v];s.addEquation(B)}}for(s.solve(t,this),c&&(l.solve=performance.now()-e),s.removeAllEquations(),this.dispatchEvent(R),d=0;d!==o;d++)(E=a[d]).preStep&&E.preStep.call(E);c&&(e=performance.now());var F=this.stepnumber%(this.quatNormalizeSkip+1)==0,z=this.quatNormalizeFast;for(d=0;d!==o;d++)a[d].integrate(t,F,z);var k=Math.pow;for(d=0;d!==o;d++)if((E=a[d]).type&u){var U=k(1-E.linearDamping,t),G=E.velocity;G.mult(U,G);var H=E.angularVelocity;if(H){var V=k(1-E.angularDamping,t);H.mult(V,H)}}for(this.broadphase.dirty=!0,c&&(l.integrate=performance.now()-e),this.time+=t,this.stepnumber+=1,this.dispatchEvent(w),d=0;d!==o;d++){var W=(E=a[d]).postStep;W&&W.call(E)}if(this.allowSleep)for(d=0;d!==o;d++)a[d].sleepTick(this.time)},g.prototype.emitContactEvents=(S=[],T=[],E={type:"beginContact",bodyA:null,bodyB:null},b={type:"endContact",bodyA:null,bodyB:null},C={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},A={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},function(){var t=this.hasAnyEventListener("beginContact"),e=this.hasAnyEventListener("endContact");if((t||e)&&this.bodyOverlapKeeper.getDiff(S,T),t){for(var n=0,i=S.length;n<i;n+=2)E.bodyA=this.getBodyById(S[n]),E.bodyB=this.getBodyById(S[n+1]),this.dispatchEvent(E);E.bodyA=E.bodyB=null}if(e){for(n=0,i=T.length;n<i;n+=2)b.bodyA=this.getBodyById(T[n]),b.bodyB=this.getBodyById(T[n+1]),this.dispatchEvent(b);b.bodyA=b.bodyB=null}S.length=T.length=0;var r=this.hasAnyEventListener("beginShapeContact"),o=this.hasAnyEventListener("endShapeContact");if((r||o)&&this.shapeOverlapKeeper.getDiff(S,T),r){for(n=0,i=S.length;n<i;n+=2){var a=this.getShapeById(S[n]),s=this.getShapeById(S[n+1]);C.shapeA=a,C.shapeB=s,C.bodyA=a.body,C.bodyB=s.body,this.dispatchEvent(C)}C.bodyA=C.bodyB=C.shapeA=C.shapeB=null}if(o){for(n=0,i=T.length;n<i;n+=2)a=this.getShapeById(T[n]),s=this.getShapeById(T[n+1]),A.shapeA=a,A.shapeB=s,A.bodyA=a.body,A.bodyB=s.body,this.dispatchEvent(A);A.bodyA=A.bodyB=A.shapeA=A.shapeB=null}}),g.prototype.clearForces=function(){for(var t=this.bodies,e=t.length,n=0;n!==e;n++){var i=t[n];i.force,i.torque,i.force.set(0,0,0),i.torque.set(0,0,0)}};var N={type:"cc-trigger",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null},L={type:"cc-collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},B=[];g.prototype.emitTriggeredEvents=function(){if(0!=this.substeps){for(var t,e,n=this.triggerDic.getLength();n--;)if(t=this.triggerDic.getKeyByIndex(n),null!=(e=this.triggerDic.getDataByKey(t))){var i=e.si,r=e.sj;this.tm.get(i,r)?N.event="onTriggerStay":(this.tm.set(i,r,!0),N.event="onTriggerEnter"),N.selfShape=i,N.otherShape=r,N.selfBody=i.body,N.otherBody=r.body,i.dispatchEvent(N),N.selfShape=r,N.otherShape=i,N.selfBody=r.body,N.otherBody=i.body,r.dispatchEvent(N)}for(n=this.oldTriggerDic.getLength();n>0;)n--,t=this.oldTriggerDic.getKeyByIndex(n),null==this.triggerDic.getDataByKey(t)&&null!=(e=this.oldTriggerDic.getDataByKey(t))&&(i=e.si,r=e.sj,this.tm.set(i,r,!1),this.oldTriggerDic.del(i.id,r.id)&&n--,N.event="onTriggerExit",N.selfShape=i,N.otherShape=r,N.selfBody=i.body,N.otherBody=r.body,i.dispatchEvent(N),N.selfShape=r,N.otherShape=i,N.selfBody=r.body,N.otherBody=i.body,r.dispatchEvent(N));this.triggerDic.reset()}},g.prototype.emitCollisionEvents=function(){if(0!=this.substeps){for(var t,e,n=this.contacts,i=this.contacts.length;i--;){var r=(u=n[i]).si,o=u.sj,a=this.contactsDic.get(r.id,o.id);null==a&&(a=this.contactsDic.set(r.id,o.id,[])),a.push(u)}for(i=this.contactsDic.getLength();i--;)if(t=this.contactsDic.getKeyByIndex(i),null!=(e=this.contactsDic.getDataByKey(t))){r=e[0].si,o=e[0].sj;var s=r.body,c=o.body;this.cm.get(s,c)?L.event="onCollisionStay":(this.cm.set(s,c,!0),L.event="onCollisionEnter"),L.bi=s,L.contact=e[0],L.contacts=e,L.body=c,L.selfShape=r,L.otherShape=o,s.dispatchEvent(L),L.body=s,L.selfShape=o,L.otherShape=r,c.dispatchEvent(L)}var l=B;for(i=l.length;i--;){var u;r=(u=l[i]).si,o=u.sj,null==this.oldContactsDic.get(r.id,o.id)&&this.oldContactsDic.set(r.id,o.id,u)}for(i=this.oldContactsDic.getLength();i--;)t=this.oldContactsDic.getKeyByIndex(i),null==this.contactsDic.getDataByKey(t)&&(r=(e=this.oldContactsDic.getDataByKey(t)).si,o=e.sj,s=r.body,c=o.body,this.cm.get(s,c)&&(s.isSleeping()&&c.isSleeping()||(this.cm.set(s,c,!1),L.bi=s,L.contact=e,L.event="onCollisionExit",L.body=c,L.selfShape=r,L.otherShape=o,L.contacts.length=0,L.contacts.push(e),s.dispatchEvent(L),L.body=s,L.selfShape=o,L.otherShape=r,c.dispatchEvent(L))));this.contactsDic.reset(),this.oldContactsDic.reset(),I=B,B=this.contacts.slice(),this.contacts.length=0}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)}(e={exports:{}}),e.exports}();function Pht(t){u._global.CC_PHYSICS_BUILTIN="builtin"===t,u._global.CC_PHYSICS_CANNON="cannon.js"===t,u._global.CC_PHYSICS_AMMO="ammo.js"===t}!function(t){t[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC"}(Sht||(Sht=t("ERigidBodyType",{}))),oe(Sht),function(t){t[t.X_AXIS=0]="X_AXIS",t[t.Y_AXIS=1]="Y_AXIS",t[t.Z_AXIS=2]="Z_AXIS"}(Tht||(Tht=t("EAxisDirection",{}))),oe(Tht),function(t){t[t.VERTEX=1]="VERTEX",t[t.LINE=2]="LINE",t[t.TRIANGLE=3]="TRIANGLE",t[t.TETRAHEDRON=4]="TETRAHEDRON"}(Eht||(Eht={})),oe(Eht),function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CAPSULE=2]="CAPSULE",t[t.CYLINDER=3]="CYLINDER",t[t.CONE=4]="CONE",t[t.MESH=5]="MESH",t[t.PLANE=6]="PLANE",t[t.SIMPLEX=7]="SIMPLEX",t[t.TERRAIN=8]="TERRAIN"}(bht||(bht={})),oe(bht),function(t){t[t.POINT_TO_POINT=0]="POINT_TO_POINT",t[t.HINGE=1]="HINGE",t[t.CONE_TWIST=2]="CONE_TWIST"}(Cht||(Cht={})),oe(Cht),function(t){t[t.DEFAULT=1]="DEFAULT"}(Aht||(Aht={})),oe(Aht);var Iht,Mht={id:"",switchTo:function(t){if(Mht.runInEditor){var e=Mht;if(Mht.physicsWorld&&t!==Mht.id&&null!=Mht.backend[t]?(Mht.physicsWorld.destroy(),console.info("[PHYSICS]: switch from "+Mht.id+" to "+t+"."),Pht(t),e.id=t,e.wrapper=Mht.backend[t],e.physicsWorld=Lht()):(console.info("[PHYSICS]: using "+t+"."),e.physicsWorld=Lht()),wht){var n=e.physicsWorld;n.setGravity(wht.gravity),n.setAllowSleep(wht.allowSleep),n.setDefaultMaterial(wht.defaultMaterial)}}},register:function(t,e){if(console.info("[PHYSICS]: register "+t+"."),Mht.backend[t]=e,!Mht.physicsWorld||Mht.id===t){Pht(t);var n=Mht;n.id=t,n.wrapper=e}},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0},Dht=function(){return 0},Oht={impl:null,setGravity:Dht,setAllowSleep:Dht,setDefaultMaterial:Dht,step:Dht,syncAfterEvents:Dht,syncSceneToPhysics:Dht,raycast:Dht,raycastClosest:Dht,emitEvents:Dht,destroy:Dht};function Nht(t,e){return null==t&&(Mht.id?S(Mht.id+" physics does not support "+Iht[e]):O(9600),!0)}function Lht(){return Nht(Mht.wrapper.PhysicsWorld,Iht.World)?Oht:new Mht.wrapper.PhysicsWorld}!function(t){t[t.World=0]="World",t[t.RigidBody=1]="RigidBody",t[t.BoxCollider=2]="BoxCollider",t[t.SphereCollider=3]="SphereCollider",t[t.CapsuleCollider=4]="CapsuleCollider",t[t.MeshCollider=5]="MeshCollider",t[t.CylinderCollider=6]="CylinderCollider",t[t.ConeCollider=7]="ConeCollider",t[t.TerrainCollider=8]="TerrainCollider",t[t.SimplexCollider=9]="SimplexCollider",t[t.PlaneCollider=10]="PlaneCollider",t[t.PointToPointConstraint=11]="PointToPointConstraint",t[t.HingeConstraint=12]="HingeConstraint",t[t.ConeTwistConstraint=13]="ConeTwistConstraint"}(Iht||(Iht={}));var Bht={impl:null,rigidBody:null,isAwake:!1,isSleepy:!1,isSleeping:!1,initialize:Dht,onEnable:Dht,onDisable:Dht,onDestroy:Dht,setType:Dht,setMass:Dht,setLinearDamping:Dht,setAngularDamping:Dht,useGravity:Dht,setLinearFactor:Dht,setAngularFactor:Dht,setAllowSleep:Dht,wakeUp:Dht,sleep:Dht,clearState:Dht,clearForces:Dht,clearVelocity:Dht,setSleepThreshold:Dht,getSleepThreshold:Dht,getLinearVelocity:Dht,setLinearVelocity:Dht,getAngularVelocity:Dht,setAngularVelocity:Dht,applyForce:Dht,applyLocalForce:Dht,applyImpulse:Dht,applyLocalImpulse:Dht,applyTorque:Dht,applyLocalTorque:Dht,setGroup:Dht,getGroup:Dht,addGroup:Dht,removeGroup:Dht,setMask:Dht,getMask:Dht,addMask:Dht,removeMask:Dht,isUsingCCD:Dht,useCCD:Dht},Fht={INITED:!1},zht={impl:null,collider:null,attachedRigidBody:null,initialize:Dht,onLoad:Dht,onEnable:Dht,onDisable:Dht,onDestroy:Dht,setGroup:Dht,getGroup:Dht,addGroup:Dht,removeGroup:Dht,setMask:Dht,getMask:Dht,addMask:Dht,removeMask:Dht,setMaterial:Dht,setAsTrigger:Dht,setCenter:Dht,getAABB:Dht,getBoundingSphere:Dht,updateSize:Dht,updateRadius:Dht,setRadius:Dht,setCylinderHeight:Dht,setDirection:Dht,setHeight:Dht,setShapeType:Dht,setVertices:Dht,setMesh:Dht,setTerrain:Dht,setNormal:Dht,setConstant:Dht,updateEventListener:Dht};var kht,Uht,Ght,Hht,Vht,Wht,jht,qht,Xht={INITED:!1},Yht={impl:null,initialize:Dht,onLoad:Dht,onEnable:Dht,onDisable:Dht,onDestroy:Dht,setEnableCollision:Dht,setConnectedBody:Dht,setPivotA:Dht,setPivotB:Dht,setAxis:Dht};var Kht=function(e){return t({PhysicsMaterial:e,PhysicMaterial:e}),e}(dc("cc.PhysicsMaterial")((qht=jht=function(t){function e(){var n;return(n=t.call(this)||this).id=void 0,ct(n,"_friction",Ght,ot(n)),ct(n,"_rollingFriction",Hht,ot(n)),ct(n,"_spinningFriction",Vht,ot(n)),ct(n,"_restitution",Wht,ot(n)),e.allMaterials.push(ot(n)),n.id=e._idCounter++,n._uuid||(n._uuid="pm_"+n.id),n}$(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return t._friction=this._friction,t._restitution=this._restitution,t._rollingFriction=this._rollingFriction,t._spinningFriction=this._spinningFriction,t},n.destroy=function(){if(t.prototype.destroy.call(this)){var n=e.allMaterials.indexOf(this);return n>=0&&e.allMaterials.splice(n,1),!0}return!1},n.setValues=function(t,n,i,r){var o=this._friction!==t||this._rollingFriction!==n||this._spinningFriction!==i||this._restitution!==r;this._friction=t,this._rollingFriction=n,this._spinningFriction=i,this._restitution=r,o&&this.emit(e.EVENT_UPDATE)},Z(e,[{key:"friction",get:function(){return this._friction},set:function(t){on(this._friction,t)||(this._friction=t,this.emit(e.EVENT_UPDATE))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(t){on(this._rollingFriction,t)||(this._rollingFriction=t,this.emit(e.EVENT_UPDATE))}},{key:"spinningFriction",get:function(){return this._spinningFriction},set:function(t){on(this._spinningFriction,t)||(this._spinningFriction=t,this.emit(e.EVENT_UPDATE))}},{key:"restitution",get:function(){return this._restitution},set:function(t){on(this._restitution,t)||(this._restitution=t,this.emit(e.EVENT_UPDATE))}}]),e}(Du),jht.allMaterials=[],jht.EVENT_UPDATE="event_update",jht._idCounter=0,lt((Uht=qht).prototype,"friction",[Mc],Object.getOwnPropertyDescriptor(Uht.prototype,"friction"),Uht.prototype),lt(Uht.prototype,"rollingFriction",[Mc],Object.getOwnPropertyDescriptor(Uht.prototype,"rollingFriction"),Uht.prototype),lt(Uht.prototype,"spinningFriction",[Mc],Object.getOwnPropertyDescriptor(Uht.prototype,"spinningFriction"),Uht.prototype),lt(Uht.prototype,"restitution",[Mc],Object.getOwnPropertyDescriptor(Uht.prototype,"restitution"),Uht.prototype),Ght=lt(Uht.prototype,"_friction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.6}}),Hht=lt(Uht.prototype,"_rollingFriction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vht=lt(Uht.prototype,"_spinningFriction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wht=lt(Uht.prototype,"_restitution",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kht=Uht))||kht),Qht=t("PhysicsRayResult",function(){function t(){this._hitPoint=new Rn,this._hitNormal=new Rn,this._distance=0,this._collider=null}var e=t.prototype;return e._assign=function(t,e,n,i){Rn.copy(this._hitPoint,t),Rn.copy(this._hitNormal,i),this._distance=e,this._collider=n},e.clone=function(){var e=new t;return Rn.copy(e._hitPoint,this._hitPoint),Rn.copy(e._hitNormal,this._hitNormal),e._distance=this._distance,e._collider=this._collider,e},Z(t,[{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collider}},{key:"hitNormal",get:function(){return this._hitNormal}}]),t}()),Zht=function(t){if(1===t){for(var e=this,n=function(t){var n="_"+(1<<t);e[n]=0,e.updateArray=[],Object.defineProperty(e,1<<t,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this[n]=e,this.updateArray.indexOf(t)<0&&this.updateArray.push(t))}})},i=0;i<32;i++)n(i);this._1=Aht.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=Aht.DEFAULT}};u.internal.PhysicsGroup=Aht;var Jht,$ht,tft,eft,nft,ift,rft,oft,aft,sft,cft,lft,uft,hft,fft,pft,dft,_ft,mft,vft,gft,yft,xft,Sft,Tft,Eft,bft,Cft,Aft,wft,Rft,Pft,Ift,Mft,Dft,Oft,Nft,Lft,Bft,Fft,zft,kft,Uft,Gft,Hft=t("PhysicsSystem",function(t){function e(){var e;return(e=t.call(this)||this).raycastClosestResult=new Qht,e.raycastResults=[],e.collisionMatrix=new Zht(1),e.minVolumeSize=1e-5,e.useNodeChains=!1,e._enable=!0,e._allowSleep=!0,e._maxSubSteps=1,e._subStepCount=0,e._fixedTimeStep=1/60,e._autoSimulation=!0,e._accumulator=0,e._sleepThreshold=.1,e._gravity=new Rn(0,-10,0),e._material=new Kht,e.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},e.raycastResultPool=new jl((function(){return new Qht}),1),e._material.on(Kht.EVENT_UPDATE,e._updateMaterial,ot(e)),e}$(e,t);var n=e.prototype;return n.postUpdate=function(t){if(this.physicsWorld)if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=t,VO.emit(HO.EVENT_BEFORE_PHYSICS);this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>=this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this.physicsWorld.emitEvents(),this.physicsWorld.syncAfterEvents(),this._accumulator-=this._fixedTimeStep,this._subStepCount++}VO.emit(HO.EVENT_AFTER_PHYSICS)}}else this.physicsWorld.syncSceneToPhysics()},n.resetConfiguration=function(t){var e=t||(GO.config?GO.config.physics:null);if(e){if("boolean"==typeof e.allowSleep&&(this._allowSleep=e.allowSleep),"number"==typeof e.fixedTimeStep&&(this._fixedTimeStep=e.fixedTimeStep),"number"==typeof e.maxSubSteps&&(this._maxSubSteps=e.maxSubSteps),"number"==typeof e.sleepThreshold&&(this._sleepThreshold=e.sleepThreshold),"boolean"==typeof e.autoSimulation&&(this.autoSimulation=e.autoSimulation),e.gravity&&Rn.copy(this._gravity,e.gravity),e.defaultMaterial&&this._material.setValues(e.defaultMaterial.friction,e.defaultMaterial.rollingFriction,e.defaultMaterial.spinningFriction,e.defaultMaterial.restitution),e.collisionMatrix)for(var n in e.collisionMatrix)this.collisionMatrix[""+(1<<parseInt(n))]=e.collisionMatrix[n];if(e.collisionGroups){var i=e.collisionGroups;i instanceof Array&&(i.forEach((function(t){Aht[t.name]=1<<t.index})),oe.update(Aht))}}this.physicsWorld&&(this.physicsWorld.setGravity(this._gravity),this.physicsWorld.setAllowSleep(this._allowSleep),this.physicsWorld.setDefaultMaterial(this._material))},n.resetAccumulator=function(t){void 0===t&&(t=0),this._accumulator=t},n.step=function(t,e,n){this.physicsWorld&&this.physicsWorld.step(t,e,n)},n.syncSceneToPhysics=function(){this.physicsWorld&&this.physicsWorld.syncSceneToPhysics()},n.emitEvents=function(){this.physicsWorld&&this.physicsWorld.emitEvents()},n.raycast=function(t,e,n,i){return void 0===e&&(e=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=e>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycast(t,this.raycastOptions,this.raycastResultPool,this.raycastResults))},n.raycastClosest=function(t,e,n,i){return void 0===e&&(e=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastOptions.mask=e>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycastClosest(t,this.raycastOptions,this.raycastClosestResult))},n._updateMaterial=function(){this.physicsWorld&&this.physicsWorld.setDefaultMaterial(this._material)},e.constructAndRegister=function(){if(!e._instance){var t=new e;t.resetConfiguration(),function(t){if(wht||(wht=t),Mht.runInEditor&&!Mht.physicsWorld){console.info("[PHYSICS]: using "+Mht.id+".");var e=Mht.physicsWorld=Lht();e.setGravity(wht.gravity),e.setAllowSleep(wht.allowSleep),e.setDefaultMaterial(wht.defaultMaterial)}}(t),e._instance=t,VO.registerSystem(e.ID,t,t.priority)}},Z(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this.physicsWorld&&this.physicsWorld.setAllowSleep(t)}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(t){this._maxSubSteps=t}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=t}},{key:"gravity",get:function(){return this._gravity},set:function(t){this._gravity.set(t),this.physicsWorld&&this.physicsWorld.setGravity(t)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(t){this._sleepThreshold=t}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(t){this._autoSimulation=t}},{key:"defaultMaterial",get:function(){return this._material}},{key:"physicsWorld",get:function(){return Mht.physicsWorld}}],[{key:"PHYSICS_NONE",get:function(){return!Mht.id}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===Mht.id}},{key:"PHYSICS_CANNON",get:function(){return"cannon.js"===Mht.id}},{key:"PHYSICS_BULLET",get:function(){return"bullet"===Mht.id}},{key:"PHYSICS_PHYSX",get:function(){return"physx"===Mht.id}},{key:"PhysicsGroup",get:function(){return Aht}},{key:"instance",get:function(){return e._instance}}]),e}(PO));Hft.ID="PHYSICS",Hft._instance=null,VO.once(HO.EVENT_INIT,(function(){Hft.constructAndRegister()}));var Vft,Wft,jft,qft,Xft,Yft,Kft,Qft,Zft,Jft,$ft,tpt,ept,npt,ipt,rpt,opt,apt,spt,cpt,lpt,upt,hpt=function(e){return t({RigidBody:e,RigidBodyComponent:e}),e}((Jht=dc("cc.RigidBody"),$ht=Ic(),tft=Ac(),eft=mc(-1),nft=Kc(Hft.PhysicsGroup),ift=Gc(),rft=Lc(),oft=Kc(Sht),aft=Gc(),sft=Lc(),cft=Dc(),lft=Gc(),uft=Lc(),hft=Dc(),fft=Gc(),pft=Lc(),dft=Dc(),_ft=Gc(),mft=Lc(),vft=Dc(),gft=Gc(),yft=Lc(),xft=Dc(),Sft=Gc(),Tft=Lc(),Eft=Dc(),bft=Gc(),Cft=Lc(),Aft=Dc(),wft=Gc(),Rft=Lc(),Jht(Pft=$ht(Pft=tft(Pft=Cc(Pft=vc(Pft=eft((Gft=Uft=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._body=null,ct(e,"_group",Mft,ot(e)),ct(e,"_type",Dft,ot(e)),ct(e,"_mass",Oft,ot(e)),ct(e,"_allowSleep",Nft,ot(e)),ct(e,"_linearDamping",Lft,ot(e)),ct(e,"_angularDamping",Bft,ot(e)),ct(e,"_useGravity",Fft,ot(e)),ct(e,"_linearFactor",zft,ot(e)),ct(e,"_angularFactor",kft,ot(e)),e}$(e,t);var n=e.prototype;return n.onLoad=function(){Mht.runInEditor&&(this._body=Nht(Mht.wrapper.RigidBody,Iht.RigidBody)?Bht:new Mht.wrapper.RigidBody,this._body.initialize(this))},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},n.applyForce=function(t,e){this._isInitialized&&this._body.applyForce(t,e)},n.applyLocalForce=function(t,e){this._isInitialized&&this._body.applyLocalForce(t,e)},n.applyImpulse=function(t,e){this._isInitialized&&this._body.applyImpulse(t,e)},n.applyLocalImpulse=function(t,e){this._isInitialized&&this._body.applyLocalImpulse(t,e)},n.applyTorque=function(t){this._isInitialized&&this._body.applyTorque(t)},n.applyLocalTorque=function(t){this._isInitialized&&this._body.applyLocalTorque(t)},n.wakeUp=function(){this._isInitialized&&this._body.wakeUp()},n.sleep=function(){this._isInitialized&&this._body.sleep()},n.clearState=function(){this._isInitialized&&this._body.clearState()},n.clearForces=function(){this._isInitialized&&this._body.clearForces()},n.clearVelocity=function(){this._isInitialized&&this._body.clearVelocity()},n.getLinearVelocity=function(t){this._isInitialized&&this._body.getLinearVelocity(t)},n.setLinearVelocity=function(t){this._isInitialized&&this._body.setLinearVelocity(t)},n.getAngularVelocity=function(t){this._isInitialized&&this._body.getAngularVelocity(t)},n.setAngularVelocity=function(t){this._isInitialized&&this._body.setAngularVelocity(t)},n.getGroup=function(){return this._isInitialized?this._body.getGroup():0},n.setGroup=function(t){this._isInitialized&&this._body.setGroup(t)},n.addGroup=function(t){this._isInitialized&&this._body.addGroup(t)},n.removeGroup=function(t){this._isInitialized&&this._body.removeGroup(t)},n.getMask=function(){return this._isInitialized?this._body.getMask():0},n.setMask=function(t){this._isInitialized&&this._body.setMask(t)},n.addMask=function(t){this._isInitialized&&this._body.addMask(t)},n.removeMask=function(t){this._isInitialized&&this._body.removeMask(t)},Z(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t,this._body&&this._body.getGroup()!==t&&this._body.setGroup(t)}},{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this._body&&this._body.setType(t))}},{key:"mass",get:function(){return this._mass},set:function(t){this._mass!==t&&(t=t<=0?1e-4:t,this._mass=t,this._body&&this._body.setMass(t))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}},{key:"useGravity",get:function(){return this._useGravity},set:function(t){this._useGravity=t,this._body&&this._body.useGravity(t)}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(t){Rn.copy(this._linearFactor,t),this._body&&this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(t){Rn.copy(this._angularFactor,t),this._body&&this._body.setAngularFactor(this._angularFactor)}},{key:"sleepThreshold",get:function(){return this._isInitialized?this._body.getSleepThreshold():.1},set:function(t){this._isInitialized&&this._body.setSleepThreshold(t)}},{key:"useCCD",get:function(){return!!this._isInitialized&&this._body.isUsingCCD()},set:function(t){this._isInitialized&&this._body.useCCD(t)}},{key:"isAwake",get:function(){return!!this._isInitialized&&this._body.isAwake}},{key:"isSleepy",get:function(){return!!this._isInitialized&&this._body.isSleepy}},{key:"isSleeping",get:function(){return!!this._isInitialized&&this._body.isSleeping}},{key:"isStatic",get:function(){return this._type===Sht.STATIC},set:function(t){t&&this.isStatic||!t&&!this.isStatic||(this.type=t?Sht.STATIC:Sht.DYNAMIC)}},{key:"isDynamic",get:function(){return this._type===Sht.DYNAMIC},set:function(t){t&&this.isDynamic||!t&&!this.isDynamic||(this.type=t?Sht.DYNAMIC:Sht.KINEMATIC)}},{key:"isKinematic",get:function(){return this._type===Sht.KINEMATIC},set:function(t){t&&this.isKinematic||!t&&!this.isKinematic||(this.type=t?Sht.KINEMATIC:Sht.DYNAMIC)}},{key:"body",get:function(){return this._body}},{key:"_isInitialized",get:function(){var t=null===this._body;return t&&T("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!t}}]),e}($u),Uft.Type=Sht,lt((Ift=Gft).prototype,"group",[nft,ift,rft],Object.getOwnPropertyDescriptor(Ift.prototype,"group"),Ift.prototype),lt(Ift.prototype,"type",[oft,aft,sft],Object.getOwnPropertyDescriptor(Ift.prototype,"type"),Ift.prototype),lt(Ift.prototype,"mass",[cft,lft,uft],Object.getOwnPropertyDescriptor(Ift.prototype,"mass"),Ift.prototype),lt(Ift.prototype,"allowSleep",[hft,fft,pft],Object.getOwnPropertyDescriptor(Ift.prototype,"allowSleep"),Ift.prototype),lt(Ift.prototype,"linearDamping",[dft,_ft,mft],Object.getOwnPropertyDescriptor(Ift.prototype,"linearDamping"),Ift.prototype),lt(Ift.prototype,"angularDamping",[vft,gft,yft],Object.getOwnPropertyDescriptor(Ift.prototype,"angularDamping"),Ift.prototype),lt(Ift.prototype,"useGravity",[xft,Sft,Tft],Object.getOwnPropertyDescriptor(Ift.prototype,"useGravity"),Ift.prototype),lt(Ift.prototype,"linearFactor",[Eft,bft,Cft],Object.getOwnPropertyDescriptor(Ift.prototype,"linearFactor"),Ift.prototype),lt(Ift.prototype,"angularFactor",[Aft,wft,Rft],Object.getOwnPropertyDescriptor(Ift.prototype,"angularFactor"),Ift.prototype),Mft=lt(Ift.prototype,"_group",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hft.PhysicsGroup.DEFAULT}}),Dft=lt(Ift.prototype,"_type",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sht.DYNAMIC}}),Oft=lt(Ift.prototype,"_mass",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Nft=lt(Ift.prototype,"_allowSleep",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Lft=lt(Ift.prototype,"_linearDamping",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Bft=lt(Ift.prototype,"_angularDamping",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Fft=lt(Ift.prototype,"_useGravity",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zft=lt(Ift.prototype,"_linearFactor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(1,1,1)}}),kft=lt(Ift.prototype,"_angularFactor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(1,1,1)}}),Pft=Ift))||Pft)||Pft)||Pft)||Pft)||Pft)||Pft));hpt||(hpt=function(e){return t({RigidBody:e,RigidBodyComponent:e}),e}({}));var fpt=function(e){return t({Collider:e,ColliderComponent:e}),e}((Vft=dc("cc.Collider"),Wft=Kc(hpt),jft=Nc(),qft=Gc(),Xft=Lc(),Yft=Kc(Kht),Kft=Nc(),Qft=Gc(),Zft=Lc(),Jft=Gc(),$ft=Lc(),tpt=Kc(Rn),ept=Gc(),npt=Lc(),ipt=Kc(Kht),Vft((upt=lpt=function(t){function e(e){var n;return(n=t.call(this)||this).type=void 0,n._shape=null,n._aabb=null,n._boundingSphere=null,n._isSharedMaterial=!0,n._needTriggerEvent=!1,n._needCollisionEvent=!1,ct(n,"_material",apt,ot(n)),ct(n,"_isTrigger",spt,ot(n)),ct(n,"_center",cpt,ot(n)),n.type=e,n}$(e,t);var n=e.prototype;return n.on=function(e,n,i,r){var o=t.prototype.on.call(this,e,n,i,r);return this._updateNeedEvent(e),o},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i),this._updateNeedEvent()},n.once=function(e,n,i){var r=t.prototype.once.call(this,e,n,i);return this._updateNeedEvent(e),r},n.removeAll=function(e){t.prototype.removeAll.call(this,e),this._updateNeedEvent()},n.getGroup=function(){return this._isInitialized?this._shape.getGroup():0},n.setGroup=function(t){this._isInitialized&&this._shape.setGroup(t)},n.addGroup=function(t){this._isInitialized&&this._shape.addGroup(t)},n.removeGroup=function(t){this._isInitialized&&this._shape.removeGroup(t)},n.getMask=function(){return this._isInitialized?this._shape.getMask():0},n.setMask=function(t){this._isInitialized&&this._shape.setMask(t)},n.addMask=function(t){this._isInitialized&&this._shape.addMask(t)},n.removeMask=function(t){this._isInitialized&&this._shape.removeMask(t)},n.onLoad=function(){Mht.runInEditor&&(this.sharedMaterial=null==this._material?Hft.instance.defaultMaterial:this._material,this._shape=function(t){return Fht.INITED||(Fht.INITED=!0,Fht[bht.BOX]=function(){return Nht(Mht.wrapper.BoxShape,Iht.BoxCollider)?zht:new Mht.wrapper.BoxShape},Fht[bht.SPHERE]=function(){return Nht(Mht.wrapper.SphereShape,Iht.SphereCollider)?zht:new Mht.wrapper.SphereShape},Fht[bht.CAPSULE]=function(){return Nht(Mht.wrapper.CapsuleShape,Iht.CapsuleCollider)?zht:new Mht.wrapper.CapsuleShape},Fht[bht.CYLINDER]=function(){return Nht(Mht.wrapper.CylinderShape,Iht.CylinderCollider)?zht:new Mht.wrapper.CylinderShape},Fht[bht.CONE]=function(){return Nht(Mht.wrapper.ConeShape,Iht.ConeCollider)?zht:new Mht.wrapper.ConeShape},Fht[bht.MESH]=function(){return Nht(Mht.wrapper.TrimeshShape,Iht.MeshCollider)?zht:new Mht.wrapper.TrimeshShape},Fht[bht.TERRAIN]=function(){return Nht(Mht.wrapper.TerrainShape,Iht.TerrainCollider)?zht:new Mht.wrapper.TerrainShape},Fht[bht.SIMPLEX]=function(){return Nht(Mht.wrapper.SimplexShape,Iht.SimplexCollider)?zht:new Mht.wrapper.SimplexShape},Fht[bht.PLANE]=function(){return Nht(Mht.wrapper.PlaneShape,Iht.PlaneCollider)?zht:new Mht.wrapper.PlaneShape}),Fht[t]()}(this.type),this._shape.initialize(this),this._shape.onLoad())},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&(this._needTriggerEvent=!1,this._needCollisionEvent=!1,this._shape.updateEventListener(),this._material&&this._material.off(Kht.EVENT_UPDATE,this._updateMaterial,this),this._shape.onDestroy()),this._boundingSphere&&this._boundingSphere.destroy()},n._updateMaterial=function(){this._shape&&this._shape.setMaterial(this._material)},n._updateNeedEvent=function(t){this.isValid&&(void 0!==t?("onCollisionEnter"!==t&&"onCollisionStay"!==t&&"onCollisionExit"!==t||(this._needCollisionEvent=!0),"onTriggerEnter"!==t&&"onTriggerStay"!==t&&"onTriggerExit"!==t||(this._needTriggerEvent=!0)):(this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")||(this._needTriggerEvent=!1),this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1)),this._shape&&this._shape.updateEventListener())},Z(e,[{key:"attachedRigidBody",get:function(){return t=this.node,(e=t.getComponent(hpt))&&e.isValid?e:null;var t,e}},{key:"sharedMaterial",get:function(){return this._material},set:function(t){this.material=t}},{key:"material",get:function(){return this._isSharedMaterial&&this._material&&(this._material.off(Kht.EVENT_UPDATE,this._updateMaterial,this),this._material=this._material.clone(),this._material.on(Kht.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(t){this._shape?(t&&this._material?this._material.id!==t.id&&(this._material.off(Kht.EVENT_UPDATE,this._updateMaterial,this),t.on(Kht.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1,this._material=t):t&&!this._material?(t.on(Kht.EVENT_UPDATE,this._updateMaterial,this),this._material=t):!t&&this._material&&(this._material.off(Kht.EVENT_UPDATE,this._updateMaterial,this),this._material=t),this._updateMaterial()):this._material=t}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(t){this._isTrigger=t,this._shape&&this._shape.setAsTrigger(this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(t){Rn.copy(this._center,t),this._shape&&this._shape.setCenter(this._center)}},{key:"shape",get:function(){return this._shape}},{key:"worldBounds",get:function(){return null==this._aabb&&(this._aabb=new js),this._shape&&this._shape.getAABB(this._aabb),this._aabb}},{key:"boundingSphere",get:function(){return null==this._boundingSphere&&(this._boundingSphere=new sa),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}},{key:"needTriggerEvent",get:function(){return this._needTriggerEvent}},{key:"needCollisionEvent",get:function(){return this._needCollisionEvent}},{key:"_isInitialized",get:function(){var t=null===this._shape;return t&&T("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!t}}]),e}(tu($u)),lpt.Type=bht,lpt.Axis=Tht,lt((opt=upt).prototype,"attachedRigidBody",[Wft,Oc,jft,qft,Xft],Object.getOwnPropertyDescriptor(opt.prototype,"attachedRigidBody"),opt.prototype),lt(opt.prototype,"sharedMaterial",[Yft,Kft,Qft,Zft],Object.getOwnPropertyDescriptor(opt.prototype,"sharedMaterial"),opt.prototype),lt(opt.prototype,"isTrigger",[Jft,$ft],Object.getOwnPropertyDescriptor(opt.prototype,"isTrigger"),opt.prototype),lt(opt.prototype,"center",[tpt,ept,npt],Object.getOwnPropertyDescriptor(opt.prototype,"center"),opt.prototype),apt=lt(opt.prototype,"_material",[ipt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),spt=lt(opt.prototype,"_isTrigger",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cpt=lt(opt.prototype,"_center",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),rpt=opt))||rpt));function ppt(t){return void 0===(t=t||{}).includeNormal&&(t.includeNormal=!0),void 0===t.includeUV&&(t.includeUV=!0),t}fpt||(fpt=function(e){return t({Collider:e,ColliderComponent:e}),e}({}));var dpt=new Rn,_pt=new Rn,mpt=new Rn,vpt=new Rn,gpt=new Rn,ypt=new Rn,xpt=new Rn,Spt=new Rn,Tpt=new Rn,Ept=new Rn,bpt=new Rn,Cpt=new Rn,Apt=new Rn(0,0,0),wpt=new Rn(0,0,0);function Rpt(t,e,n,i){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,s=void 0===i.capped||i.capped,c=i.arc||2*Math.PI,l=0;s||(t>0&&l++,e>0&&l++);var u=(o+1)*(a+1);s&&(u+=(o+1)*l+o*l);var h=o*a*6;s&&(h+=o*l*3);var f=new Array(h),p=new Array(3*u),d=new Array(3*u),_=new Array(2*u),m=Math.max(t,e),v=new Rn(-m,-r,-m),g=new Rn(m,r,m),y=Math.sqrt(m*m+r*r),x=0,S=0;return function(){for(var i=[],s=t-e,l=s*s/n*Math.sign(s),u=0;u<=a;u++){for(var h=[],m=u/a,v=m*s+e,g=0;g<=o;++g){var y=g/o,T=y*c,E=Math.sin(T),b=Math.cos(T);p[3*x]=v*E,p[3*x+1]=m*n-r,p[3*x+2]=v*b,Rn.normalize(Apt,Rn.set(wpt,E,-l,b)),d[3*x]=Apt.x,d[3*x+1]=Apt.y,d[3*x+2]=Apt.z,_[2*x]=2*(1-y)%1,_[2*x+1]=m,h.push(x),++x}i.push(h)}for(var C=0;C<a;++C)for(var A=0;A<o;++A){var w=i[C][A],R=i[C+1][A],P=i[C+1][A+1],I=i[C][A+1];f[S]=w,++S,f[S]=I,++S,f[S]=R,++S,f[S]=I,++S,f[S]=P,++S,f[S]=R,++S}}(),s&&(e>0&&T(!1),t>0&&T(!0)),{positions:p,normals:d,uvs:_,indices:f,minPos:v,maxPos:g,boundingRadius:y};function T(n){for(var i=n?t:e,a=n?1:-1,s=x,l=1;l<=o;++l)p[3*x]=0,p[3*x+1]=r*a,p[3*x+2]=0,d[3*x]=0,d[3*x+1]=a,d[3*x+2]=0,_[2*x]=.5,_[2*x+1]=.5,++x;for(var u=x,h=0;h<=o;++h){var m=h/o*c,v=Math.cos(m),g=Math.sin(m);p[3*x]=i*g,p[3*x+1]=r*a,p[3*x+2]=i*v,d[3*x]=0,d[3*x+1]=a,d[3*x+2]=0,_[2*x]=.5-.5*g*a,_[2*x+1]=.5+.5*v,++x}for(var y=0;y<o;++y){var T=s+y,E=u+y;n?(f[S]=E+1,++S,f[S]=T,++S,f[S]=E,++S):(f[S]=T,++S,f[S]=E+1,++S,f[S]=E,++S)}}}var Ppt=new Rn(0,0,0),Ipt=new Rn(0,0,0),Mpt=new Rn(0,0,0),Dpt=new Rn(0,0,0),Opt=new Rn(0,0,0),Npt=new Rn(0,0,0),Lpt=new Rn(0,0,0),Bpt=new Rn(0,0,0),Fpt=new Rn(0,0,0),zpt=Object.freeze({__proto__:null,box:function(t){var e=(t=t||{}).widthSegments||1,n=t.heightSegments||1,i=t.lengthSegments||1,r=(t.width||1)/2,o=(t.height||1)/2,a=(t.length||1)/2,s=[Rn.set(gpt,-r,-o,a),Rn.set(ypt,r,-o,a),Rn.set(xpt,r,o,a),Rn.set(Spt,-r,o,a),Rn.set(Tpt,r,-o,-a),Rn.set(Ept,-r,-o,-a),Rn.set(bpt,-r,o,-a),Rn.set(Cpt,r,o,-a)],c=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],u=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],h=[],f=[],p=[],d=[],_=[],m=new Rn(-r,-o,-a),v=new Rn(r,o,a),g=Math.sqrt(r*r+o*o+a*a);function y(t,e,n){var i,r,o,a,m=h.length/3,v=c[t],g=l[t],y=u[t];for(a=0;a<=n;a++)for(o=0;o<=e;o++)if(i=o/e,r=a/n,Rn.lerp(dpt,s[v[0]],s[v[1]],i),Rn.lerp(_pt,s[v[0]],s[v[2]],r),Rn.subtract(mpt,_pt,s[v[0]]),Rn.add(vpt,dpt,mpt),h.push(vpt.x,vpt.y,vpt.z),f.push(g[0],g[1],g[2]),p.push(i,r),d.push(y[0],y[1],y[2],y[3]),o<e&&a<n){var x=e+1,S=o+a*x,T=o+(a+1)*x,E=o+1+(a+1)*x,b=o+1+a*x;_.push(m+S,m+b,m+T),_.push(m+T,m+b,m+E)}}return y(0,e,n),y(4,i,n),y(1,e,n),y(5,i,n),y(3,e,i),y(2,e,i),{positions:h,normals:f,uvs:p,tangents:d,indices:_,minPos:m,maxPos:v,boundingRadius:g}},cone:function(t,e,n){return void 0===t&&(t=.5),void 0===e&&(e=1),void 0===n&&(n={}),Rpt(0,t,e,n)},cylinder:Rpt,plane:function(t){var e=function(t){return(t=ppt(t)).width=t.width||10,t.length=t.length||10,t.widthSegments=t.widthSegments||10,t.lengthSegments=t.lengthSegments||10,t}(t),n=e.width,i=e.length,r=e.widthSegments,o=e.lengthSegments,a=.5*n,s=.5*i,c=[],l=[],u=[],h=new Rn(-a,0,-s),f=new Rn(a,0,s),p=Math.sqrt(n*n+i*i);Rn.set(Opt,-a,0,s),Rn.set(Npt,a,0,s),Rn.set(Lpt,-a,0,-s);for(var d=0;d<=o;d++)for(var _=0;_<=r;_++){var m=_/r,v=d/o;if(Rn.lerp(Ppt,Opt,Npt,m),Rn.lerp(Ipt,Opt,Lpt,v),Rn.subtract(Mpt,Ipt,Opt),Rn.add(Dpt,Ppt,Mpt),c.push(Dpt.x,Dpt.y,Dpt.z),e.includeUV&&l.push(m,v),_<r&&d<o){var g=r+1,y=_+d*g,x=_+(d+1)*g,S=_+1+(d+1)*g,T=_+1+d*g;u.push(y,T,x),u.push(T,S,x)}}var E={positions:c,indices:u,minPos:h,maxPos:f,boundingRadius:p};if(e.includeNormal){var b=(o+1)*(r+1),C=new Array(3*b);E.normals=C;for(var A=0;A<b;++A)C[3*A+0]=0,C[3*A+1]=1,C[3*A+2]=0}return e.includeUV&&(E.uvs=l),E},quad:function(t){var e=ppt(t),n={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==e.includeNormal&&(n.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==e.includeUV&&(n.uvs=[0,0,0,1,1,1,1,0]),n},sphere:function(t,e){void 0===t&&(t=.5),void 0===e&&(e={});for(var n=void 0!==e.segments?e.segments:32,i=[],r=[],o=[],a=[],s=new Rn(-t,-t,-t),c=new Rn(t,t,t),l=t,u=0;u<=n;++u)for(var h=u*Math.PI/n,f=Math.sin(h),p=-Math.cos(h),d=0;d<=n;++d){var _=2*d*Math.PI/n-Math.PI/2,m=Math.sin(_)*f,v=p,g=Math.cos(_)*f,y=d/n,x=u/n;if(i.push(m*t,v*t,g*t),r.push(m,v,g),o.push(y,x),u<n&&d<n){var S=n+1,T=S*u+d,E=S*(u+1)+d,b=S*(u+1)+d+1,C=S*u+d+1;a.push(T,C,E),a.push(C,b,E)}}return{positions:i,indices:a,normals:r,uvs:o,minPos:s,maxPos:c,boundingRadius:l}},torus:function(t,e,n){void 0===t&&(t=.4),void 0===e&&(e=.1),void 0===n&&(n={});for(var i=n.radialSegments||32,r=n.tubularSegments||32,o=n.arc||2*Math.PI,a=[],s=[],c=[],l=[],u=new Rn(-t-e,-e,-t-e),h=new Rn(t+e,e,t+e),f=t+e,p=0;p<=i;p++)for(var d=0;d<=r;d++){var _=d/r,m=p/i,v=_*o,g=m*Math.PI*2,y=(t+e*Math.cos(g))*Math.sin(v),x=e*Math.sin(g),S=(t+e*Math.cos(g))*Math.cos(v),T=Math.sin(v)*Math.cos(g),E=Math.sin(g),b=Math.cos(v)*Math.cos(g);if(a.push(y,x,S),s.push(T,E,b),c.push(_,m),d<r&&p<i){var C=r+1,A=C*p+d,w=C*(p+1)+d,R=C*(p+1)+d+1,P=C*p+d+1;l.push(A,P,w),l.push(P,R,w)}}return{positions:a,normals:s,uvs:c,indices:l,minPos:u,maxPos:h,boundingRadius:f}},capsule:function(t,e,n,i){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=n-t-e,o=i.sides||32,a=i.heightSegments||32,s=e/n,c=r/n,l=t/n,u=Math.floor(a*s),h=Math.floor(a*l),f=Math.floor(a*c),p=r+e-n/2,d=e-n/2,_=e-n/2,m=i.arc||2*Math.PI,v=[],g=[],y=[],x=[],S=Math.max(t,e),T=new Rn(-S,-n/2,-S),E=new Rn(S,n/2,S),b=n/2,C=0,A=[];return function(){for(var t=0;t<=u;++t)for(var n=t*Math.PI/u/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,h=r,f=Math.cos(c)*i,p=s/o,d=t/a;if(v.push(l*e,h*e+_,f*e),g.push(l,h,f),y.push(p,d),t<u&&s<o){var m=o+1,S=m*t+s,T=m*(t+1)+s,E=m*(t+1)+s+1,b=m*t+s+1;x.push(S,b,T),x.push(b,E,T)}++C}}(),function(){for(var n=(t-e)/r,i=0;i<=f;i++){for(var a=[],l=i/f,u=l*(t-e)+e,h=0;h<=o;++h){var p=h/o,_=l*c+s,S=p*m-m/4,T=Math.sin(S),E=Math.cos(S);v.push(u*T),v.push(l*r+d),v.push(u*E),Rn.normalize(Bpt,Rn.set(Fpt,T,-n,E)),g.push(Bpt.x),g.push(Bpt.y),g.push(Bpt.z),y.push(p,_),a.push(C),++C}A.push(a)}for(var b=0;b<f;++b)for(var w=0;w<o;++w){var R=A[b][w],P=A[b+1][w],I=A[b+1][w+1],M=A[b][w+1];x.push(R),x.push(M),x.push(P),x.push(M),x.push(I),x.push(P)}}(),function(){for(var e=0;e<=h;++e)for(var n=e*Math.PI/h/2+Math.PI/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,u=Math.sin(c)*i,d=r,_=Math.cos(c)*i,m=s/o,S=e/a+(1-l);if(v.push(u*t,d*t+p,_*t),g.push(u,d,_),y.push(m,S),e<h&&s<o){var T=o+1,E=T*e+s+A[f][o]+1,b=T*(e+1)+s+A[f][o]+1,C=T*(e+1)+s+1+A[f][o]+1,w=T*e+s+1+A[f][o]+1;x.push(E,w,b),x.push(w,C,b)}}}(),{positions:v,normals:g,uvs:y,indices:x,minPos:T,maxPos:E,boundingRadius:b}},circle:function(t){var e=function(t){return(t=ppt(t)).segments=64,t}(t).segments,n=new Array(3*(e+1));n[0]=0,n[1]=0,n[2]=0;var i=new Array(1+2*e);i[0]=0;for(var r=2*Math.PI/e,o=0;o<e;++o){var a=r*o,s=Math.cos(a),c=Math.sin(a),l=3*(o+1);n[l+0]=s,n[l+1]=c,n[l+2]=0;var u=2*o;i[1+u]=o+1,i[1+(u+1)]=o+2}return e>0&&(i[i.length-1]=1),{positions:n,indices:i,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Fi.TRIANGLE_FAN}},translate:function(t,e){for(var n=e.x||0,i=e.y||0,r=e.z||0,o=Math.floor(t.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;t.positions[s]+=n,t.positions[c]+=i,t.positions[l]+=r}return t.minPos&&(t.minPos.x+=n,t.minPos.y+=i,t.minPos.z+=r),t.maxPos&&(t.maxPos.x+=n,t.maxPos.y+=i,t.maxPos.z+=r),t},scale:function(t,e){for(var n=e.x||0,i=e.y||0,r=e.z||0,o=Math.floor(t.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;t.positions[s]*=n,t.positions[c]*=i,t.positions[l]*=r}return t.minPos&&(t.minPos.x*=n,t.minPos.y*=i,t.minPos.z*=r),t.maxPos&&(t.maxPos.x*=n,t.maxPos.y*=i,t.maxPos.z*=r),t.boundingRadius=Math.max(Math.max(n,i),r),t},wireframed:function(t){var e=t.indices;if(!e)return t;if(t.primitiveMode&&t.primitiveMode!==Fi.TRIANGLE_LIST)return t;for(var n=[[0,1],[1,2],[2,0]],i=[],r={},o=0;o<e.length;o+=3)for(var a=0;a<3;++a){var s=e[o+n[a][0]],c=e[o+n[a][1]],l=s>c?c<<16|s:s<<16|c;void 0===r[l]&&(r[l]=0,i.push(s,c))}return t.indices=i,t.primitiveMode=Fi.LINE_LIST,t},wireframe:function(t){for(var e=[[0,1],[1,2],[2,0]],n=[],i={},r=0;r<t.length;r+=3)for(var o=0;o<3;++o){var a=t[r+e[o][0]],s=t[r+e[o][1]],c=a>s?s<<16|a:a<<16|s;void 0===i[c]&&(i[c]=0,n.push(a,s))}return n},invWinding:function(t){for(var e=[],n=0;n<t.length;n+=3)e.push(t[n],t[n+2],t[n+1]);return e},toWavefrontOBJ:function(t,e){if(void 0===e&&(e=1),!t.indices||!t.uvs||!t.normals||void 0!==t.primitiveMode&&t.primitiveMode!==Fi.TRIANGLE_LIST)return"";for(var n=t.positions,i=t.uvs,r=t.normals,o=t.indices,a=function(t){return o[t]+1+"/"+(o[t]+1)+"/"+(o[t]+1)},s="",c=0;c<n.length;c+=3)s+="v "+n[c]*e+" "+n[c+1]*e+" "+n[c+2]*e+"\n";for(var l=0;l<i.length;l+=2)s+="vt "+i[l]+" "+i[l+1]+"\n";for(var u=0;u<r.length;u+=3)s+="vn "+r[u]+" "+r[u+1]+" "+r[u+2]+"\n";for(var h=0;h<o.length;h+=3)s+="f "+a(h)+" "+a(h+1)+" "+a(h+2)+"\n";return s},normals:function(t,e,n){void 0===n&&(n=1);for(var i=new Array(2*t.length),r=0;r<t.length/3;++r){var o=3*r,a=6*r;i[a+0]=t[o+0],i[a+1]=t[o+1],i[a+2]=t[o+2],i[a+3]=t[o+0]+e[o+0]*n,i[a+4]=t[o+1]+e[o+1]*n,i[a+5]=t[o+2]+e[o+2]*n}return i},applyDefaultGeometryOptions:ppt});function kpt(t,e){t.__cc_wrapper__=e}function Upt(t){return t.__cc_wrapper__}t("primitives",zpt);var Gpt=new Rn;function Hpt(t){return t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z),t}var Vpt,Wpt,jpt,qpt,Xpt,Ypt,Kpt,Qpt,Zpt,Jpt,$pt,tdt,edt,ndt,idt,rdt,odt,adt,sdt,cdt,ldt,udt,hdt,fdt,pdt,ddt,_dt,mdt,vdt,gdt,ydt,xdt,Sdt,Tdt,Edt,bdt,Cdt,Adt,wdt,Rdt,Pdt,Idt,Mdt,Ddt,Odt,Ndt,Ldt,Bdt,Fdt,zdt,kdt,Udt,Gdt,Hdt,Vdt,Wdt,jdt,qdt,Xdt,Ydt,Kdt,Qdt,Zdt,Jdt,$dt,t_t,e_t,n_t,i_t,r_t,o_t,a_t,s_t,c_t,l_t,u_t,h_t,f_t,p_t,d_t,__t,m_t,v_t,g_t,y_t,x_t,S_t,T_t,E_t,b_t,C_t,A_t,w_t,R_t,P_t,I_t,M_t,D_t,O_t,N_t,L_t,B_t,F_t,z_t,k_t,U_t,G_t,H_t,V_t,W_t,j_t,q_t,X_t,Y_t,K_t,Q_t,Z_t,J_t,$_t,tmt,emt,nmt,imt,rmt,omt,amt,smt,cmt,lmt=Object.freeze({__proto__:null,setWrap:kpt,getWrap:Upt,maxComponent:function(t){return Math.max(t.x,Math.max(t.y,t.z))},VEC3_0:Gpt,TriggerEventObject:{type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},CollisionEventObject:{type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},shrinkPositions:function(t){var e=[];if(t.length>=3){e[0]=t[0],e[1]=t[1],e[2]=t[2];for(var n=t.length,i=3;i<n;i+=3){for(var r=t[i],o=t[i+1],a=t[i+2],s=e.length,c=!0,l=0;l<s;l+=3)if(on(r,e[l])&&on(o,e[l+1])&&on(a,e[l+2])){c=!1;break}c&&(e.push(r),e.push(o),e.push(a))}}return e},absolute:Hpt,cylinder:Rpt}),umt=function(e){return t({BoxCollider:e,BoxColliderComponent:e}),e}((Vpt=dc("cc.BoxCollider"),Wpt=Ic(),jpt=Ac(),qpt=Kc(Rn),Xpt=Lc(),Vpt(Ypt=Wpt(Ypt=jpt(Ypt=Cc((lt((Kpt=function(t){function e(){var e;return ct(e=t.call(this,bht.BOX)||this,"_size",Qpt,ot(e)),e}return $(e,t),Z(e,[{key:"size",get:function(){return this._size},set:function(t){Rn.strictEquals(this._size,t)||(Rn.copy(this._size,t),Hpt(this._size),this._shape&&this.shape.updateSize())}},{key:"shape",get:function(){return this._shape}}]),e}(fpt)).prototype,"size",[qpt,Xpt],Object.getOwnPropertyDescriptor(Kpt.prototype,"size"),Kpt.prototype),Qpt=lt(Kpt.prototype,"_size",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(1,1,1)}}),Ypt=Kpt))||Ypt)||Ypt)||Ypt)||Ypt)),hmt=function(e){return t({SphereCollider:e,SphereColliderComponent:e}),e}((Zpt=dc("cc.SphereCollider"),Jpt=Ic(),$pt=Ac(),tdt=Lc(),Zpt(edt=Jpt(edt=$pt(edt=Cc((lt((ndt=function(t){function e(){var e;return ct(e=t.call(this,bht.SPHERE)||this,"_radius",idt,ot(e)),e}return $(e,t),Z(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.updateRadius())}},{key:"shape",get:function(){return this._shape}}]),e}(fpt)).prototype,"radius",[tdt],Object.getOwnPropertyDescriptor(ndt.prototype,"radius"),ndt.prototype),idt=lt(ndt.prototype,"_radius",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),edt=ndt))||edt)||edt)||edt)||edt)),fmt=function(e){return t({CapsuleCollider:e,CapsuleColliderComponent:e}),e}((rdt=dc("cc.CapsuleCollider"),odt=Ic(),adt=Ac(),sdt=Lc(),cdt=Lc(),ldt=Kc(Tht),udt=Lc(),rdt(hdt=odt(hdt=adt(hdt=Cc((lt((fdt=function(t){function e(){var e;return ct(e=t.call(this,bht.CAPSULE)||this,"_radius",pdt,ot(e)),ct(e,"_cylinderHeight",ddt,ot(e)),ct(e,"_direction",_dt,ot(e)),e}$(e,t);var n=e.prototype;return n._getRadiusScale=function(){if(null==this.node)return 1;var t=this.node.worldScale;return this._direction===Tht.Y_AXIS?Math.abs(En(t.x,t.z)):this._direction===Tht.X_AXIS?Math.abs(En(t.y,t.z)):Math.abs(En(t.x,t.y))},n._getHeightScale=function(){if(null==this.node)return 1;var t=this.node.worldScale;return this._direction===Tht.Y_AXIS?Math.abs(t.y):this._direction===Tht.X_AXIS?Math.abs(t.x):Math.abs(t.z)},Z(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.setRadius(t))}},{key:"cylinderHeight",get:function(){return this._cylinderHeight},set:function(t){this._cylinderHeight!==t&&(this._cylinderHeight=Math.abs(t),this._shape&&this.shape.setCylinderHeight(t))}},{key:"direction",get:function(){return this._direction},set:function(t){(t=Math.floor(t))<Tht.X_AXIS||t>Tht.Z_AXIS||this._direction!==t&&(this._direction=t,this._shape&&this.shape.setDirection(t))}},{key:"height",get:function(){return 2*this._radius+this._cylinderHeight},set:function(t){var e=t-2*this._radius;e<0&&(e=0),this.cylinderHeight=e}},{key:"worldHeight",get:function(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}},{key:"shape",get:function(){return this._shape}}]),e}(fpt)).prototype,"radius",[sdt],Object.getOwnPropertyDescriptor(fdt.prototype,"radius"),fdt.prototype),lt(fdt.prototype,"cylinderHeight",[cdt],Object.getOwnPropertyDescriptor(fdt.prototype,"cylinderHeight"),fdt.prototype),lt(fdt.prototype,"direction",[ldt,udt],Object.getOwnPropertyDescriptor(fdt.prototype,"direction"),fdt.prototype),pdt=lt(fdt.prototype,"_radius",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),ddt=lt(fdt.prototype,"_cylinderHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_dt=lt(fdt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tht.Y_AXIS}}),hdt=fdt))||hdt)||hdt)||hdt)||hdt)),pmt=function(e){return t({CylinderCollider:e,CylinderColliderComponent:e}),e}((mdt=dc("cc.CylinderCollider"),vdt=Ic(),gdt=Ac(),ydt=Lc(),xdt=Lc(),Sdt=Kc(Tht),Tdt=Lc(),mdt(Edt=vdt(Edt=gdt(Edt=Cc((lt((bdt=function(t){function e(){var e;return ct(e=t.call(this,bht.CYLINDER)||this,"_radius",Cdt,ot(e)),ct(e,"_height",Adt,ot(e)),ct(e,"_direction",wdt,ot(e)),e}return $(e,t),Z(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.setRadius(t))}},{key:"height",get:function(){return this._height},set:function(t){this._height!==t&&(this._height=Math.abs(t),this._shape&&this.shape.setHeight(t))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(t<Tht.X_AXIS||t>Tht.Z_AXIS||(this._direction=t,this._shape&&this.shape.setDirection(t)))}},{key:"shape",get:function(){return this._shape}}]),e}(fpt)).prototype,"radius",[ydt],Object.getOwnPropertyDescriptor(bdt.prototype,"radius"),bdt.prototype),lt(bdt.prototype,"height",[xdt],Object.getOwnPropertyDescriptor(bdt.prototype,"height"),bdt.prototype),lt(bdt.prototype,"direction",[Sdt,Tdt],Object.getOwnPropertyDescriptor(bdt.prototype,"direction"),bdt.prototype),Cdt=lt(bdt.prototype,"_radius",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Adt=lt(bdt.prototype,"_height",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),wdt=lt(bdt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tht.Y_AXIS}}),Edt=bdt))||Edt)||Edt)||Edt)||Edt)),dmt=t("ConeCollider",(Rdt=dc("cc.ConeCollider"),Pdt=Ic(),Idt=Ac(),Mdt=Lc(),Ddt=Lc(),Odt=Kc(Tht),Ndt=Lc(),Rdt(Ldt=Pdt(Ldt=Idt(Ldt=Cc((lt((Bdt=function(t){function e(){var e;return ct(e=t.call(this,bht.CONE)||this,"_radius",Fdt,ot(e)),ct(e,"_height",zdt,ot(e)),ct(e,"_direction",kdt,ot(e)),e}return $(e,t),Z(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.setRadius(t))}},{key:"height",get:function(){return this._height},set:function(t){this._height!==t&&(t<0&&(t=0),this._height=t,this._shape&&this.shape.setHeight(t))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(t<Tht.X_AXIS||t>Tht.Z_AXIS||(this._direction=t,this._shape&&this.shape.setDirection(t)))}},{key:"shape",get:function(){return this._shape}}]),e}(fpt)).prototype,"radius",[Mdt],Object.getOwnPropertyDescriptor(Bdt.prototype,"radius"),Bdt.prototype),lt(Bdt.prototype,"height",[Ddt],Object.getOwnPropertyDescriptor(Bdt.prototype,"height"),Bdt.prototype),lt(Bdt.prototype,"direction",[Odt,Ndt],Object.getOwnPropertyDescriptor(Bdt.prototype,"direction"),Bdt.prototype),Fdt=lt(Bdt.prototype,"_radius",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),zdt=lt(Bdt.prototype,"_height",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kdt=lt(Bdt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tht.Y_AXIS}}),Ldt=Bdt))||Ldt)||Ldt)||Ldt)||Ldt)),_mt=function(e){return t({MeshCollider:e,MeshColliderComponent:e}),e}((Udt=dc("cc.MeshCollider"),Gdt=Ic(),Hdt=Ac(),Vdt=Kc(w$),Wdt=Lc(),jdt=Lc(),Udt(qdt=Gdt(qdt=Hdt(qdt=Cc((lt((Xdt=function(t){function e(){var e;return ct(e=t.call(this,bht.MESH)||this,"_mesh",Ydt,ot(e)),ct(e,"_convex",Kdt,ot(e)),e}return $(e,t),Z(e,[{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh!==t&&(this._mesh=t,this._shape&&this.shape.setMesh(this._mesh))}},{key:"convex",get:function(){return this._convex},set:function(t){this._convex!==t&&(this._convex=t)}},{key:"shape",get:function(){return this._shape}}]),e}(fpt)).prototype,"mesh",[Vdt,Wdt],Object.getOwnPropertyDescriptor(Xdt.prototype,"mesh"),Xdt.prototype),lt(Xdt.prototype,"convex",[Mc,jdt],Object.getOwnPropertyDescriptor(Xdt.prototype,"convex"),Xdt.prototype),Ydt=lt(Xdt.prototype,"_mesh",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kdt=lt(Xdt.prototype,"_convex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qdt=Xdt))||qdt)||qdt)||qdt)||qdt)),mmt=t("ConstantForce",(Qdt=dc("cc.ConstantForce"),Zdt=Ic(),Jdt=_c(hpt),$dt=Ac(),t_t=Gc(),e_t=Lc(),n_t=Gc(),i_t=Lc(),r_t=Gc(),o_t=Lc(),a_t=Gc(),s_t=Lc(),Qdt(c_t=Zdt(c_t=Jdt(c_t=$dt(c_t=vc(c_t=Cc((d_t=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._rigidBody=null,ct(e,"_force",u_t,ot(e)),ct(e,"_localForce",h_t,ot(e)),ct(e,"_torque",f_t,ot(e)),ct(e,"_localTorque",p_t,ot(e)),e._mask=0,e}$(e,t);var n=e.prototype;return n.onLoad=function(){this._rigidBody=this.node.getComponent(hpt),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)},n.lateUpdate=function(){null!=this._rigidBody&&0!==this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))},n._maskUpdate=function(t,e){t.strictEquals(Rn.ZERO)?this._mask&=~e:this._mask|=e},Z(e,[{key:"force",get:function(){return this._force},set:function(t){Rn.copy(this._force,t),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(t){Rn.copy(this._localForce,t),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(t){Rn.copy(this._torque,t),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(t){Rn.copy(this._localTorque,t),this._maskUpdate(this._localTorque,8)}}]),e}($u),u_t=lt((l_t=d_t).prototype,"_force",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),h_t=lt(l_t.prototype,"_localForce",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),f_t=lt(l_t.prototype,"_torque",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),p_t=lt(l_t.prototype,"_localTorque",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),lt(l_t.prototype,"force",[t_t,e_t],Object.getOwnPropertyDescriptor(l_t.prototype,"force"),l_t.prototype),lt(l_t.prototype,"localForce",[n_t,i_t],Object.getOwnPropertyDescriptor(l_t.prototype,"localForce"),l_t.prototype),lt(l_t.prototype,"torque",[r_t,o_t],Object.getOwnPropertyDescriptor(l_t.prototype,"torque"),l_t.prototype),lt(l_t.prototype,"localTorque",[a_t,s_t],Object.getOwnPropertyDescriptor(l_t.prototype,"localTorque"),l_t.prototype),c_t=l_t))||c_t)||c_t)||c_t)||c_t)||c_t)||c_t)),vmt=16842754,gmt=16842755,ymt=16842756,xmt=16842757,Smt=16843025,Tmt=function(){function t(){this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}var e=t.prototype;return e.reserve=function(t){if(!(this.buffer.byteLength>t)){for(var e=this.buffer.byteLength;e<t;)e+=e;for(var n=new Uint8Array(e),i=0;i<this.length;++i)n[i]=this.buffer[i];this.buffer=n,this._buffView=new DataView(this.buffer.buffer)}},e.assign=function(t){this.buffer=t,this.length=t.length,this._seekPos=t.byteOffset,this._buffView=new DataView(t.buffer)},e.writeInt8=function(t){this.reserve(this.length+1),this._buffView.setInt8(this.length,t),this.length+=1},e.writeInt16=function(t){this.reserve(this.length+2),this._buffView.setInt16(this.length,t,!0),this.length+=2},e.writeInt32=function(t){this.reserve(this.length+4),this._buffView.setInt32(this.length,t,!0),this.length+=4},e.writeIntArray=function(t){this.reserve(this.length+4*t.length);for(var e=0;e<t.length;++e)this._buffView.setInt32(this.length+4*e,t[e],!0);this.length+=4*t.length},e.writeFloat=function(t){this.reserve(this.length+4),this._buffView.setFloat32(this.length,t,!0),this.length+=4},e.writeFloatArray=function(t){this.reserve(this.length+4*t.length);for(var e=0;e<t.length;++e)this._buffView.setFloat32(this.length+4*e,t[e],!0);this.length+=4*t.length},e.writeString=function(t){this.reserve(this.length+t.length+4),this._buffView.setInt32(this.length,t.length,!0);for(var e=0;e<t.length;++e)this._buffView.setInt8(this.length+4+e,t.charCodeAt(e));this.length+=t.length+4},e.readInt8=function(){var t=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,t},e.readInt16=function(){var t=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,t},e.readInt=function(){var t=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,t},e.readIntArray=function(t){for(var e=0;e<t.length;++e)t[e]=this._buffView.getInt32(this._seekPos+4*e,!0);return this._seekPos+=4*t.length,t},e.readFloat=function(){var t=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,t},e.readFloatArray=function(t){for(var e=0;e<t.length;++e)t[e]=this._buffView.getFloat32(this._seekPos+4*e,!0);return this._seekPos+=4*t.length,t},e.readString=function(){for(var t=this.readInt(),e="",n=0;n<t;++n)e+=String.fromCharCode(this.readInt8());return e},t}(),Emt=(dc("cc.TerrainLayerInfo")((m_t=lt((__t=function(){ct(this,"slot",m_t,this),ct(this,"tileSize",v_t,this),ct(this,"detailMap",g_t,this),ct(this,"normalMap",y_t,this),ct(this,"roughness",x_t,this),ct(this,"metallic",S_t,this)}).prototype,"slot",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v_t=lt(__t.prototype,"tileSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),g_t=lt(__t.prototype,"detailMap",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y_t=lt(__t.prototype,"normalMap",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x_t=lt(__t.prototype,"roughness",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),S_t=lt(__t.prototype,"metallic",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),__t)),dc("cc.TerrainLayerBinaryInfo")(T_t=function(){this.slot=0,this.tileSize=1,this.roughness=1,this.metallic=0,this.detailMapId="",this.normalMapId=""})||T_t),bmt=dc("cc.TerrainAsset")((A_t=function(t){function e(){var e;return(e=t.call(this)||this)._version=0,e._data=null,e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._layerBuffer=[-1,-1,-1,-1],e._layerBinaryInfos=[],ct(e,"_layerInfos",C_t,ot(e)),e}$(e,t);var n=e.prototype;return n.getLayer=function(t,e,n){var i=4*(e*this.blockCount[0]+t)+n;return t<this.blockCount[0]&&e<this.blockCount[1]&&i<this._layerBuffer.length?this._layerBuffer[i]:-1},n.getHeight=function(t,e){var n=32*this._blockCount[0]+1;return.001953125*(this._heights[e*n+t]-32768)},n.getVertexCountI=function(){return this._blockCount.length<1?0:32*this._blockCount[0]+1},n.getVertexCountJ=function(){return this._blockCount.length<2?0:32*this._blockCount[1]+1},n._setNativeData=function(t){this._data=t},n._loadNativeData=function(t){if(!t||0===t.length)return!1;var e=new Tmt;if(e.assign(t),this._version=e.readInt(),this._version===Smt)return!0;if(16842753!==this._version&&this._version!==vmt&&this._version!==gmt&&this._version!==ymt&&this._version!==xmt)return!1;this.tileSize=e.readFloat(),e.readIntArray(this._blockCount),this.weightMapSize=e.readInt16(),this.lightMapSize=e.readInt16();var n=e.readInt();this.heights=new Uint16Array(n);for(var i=0;i<this.heights.length;++i)this.heights[i]=e.readInt16();var r=e.readInt();this.weights=new Uint8Array(r);for(var o=0;o<this.weights.length;++o)this.weights[o]=e.readInt8();if(this._version>=vmt){var a=e.readInt();this.layerBuffer=new Array(a);for(var s=0;s<this.layerBuffer.length;++s)this.layerBuffer[s]=e.readInt16()}if(this._version>=gmt){var c=e.readInt();this._layerBinaryInfos=new Array(c);for(var l=0;l<this._layerBinaryInfos.length;++l)this._layerBinaryInfos[l]=new Emt,this._layerBinaryInfos[l].slot=e.readInt(),this._layerBinaryInfos[l].tileSize=e.readFloat(),this._layerBinaryInfos[l].detailMapId=e.readString(),this._version>=ymt&&(this._layerBinaryInfos[l].normalMapId=e.readString(),this._layerBinaryInfos[l].roughness=e.readFloat(),this._layerBinaryInfos[l].metallic=e.readFloat())}return!0},n._exportNativeData=function(){var t=new Tmt;t.writeInt32(xmt),t.writeFloat(this.tileSize),t.writeIntArray(this._blockCount),t.writeInt16(this.weightMapSize),t.writeInt16(this.lightMapSize),t.writeInt32(this.heights.length);for(var e=0;e<this.heights.length;++e)t.writeInt16(this.heights[e]);t.writeInt32(this.weights.length);for(var n=0;n<this.weights.length;++n)t.writeInt8(this.weights[n]);t.writeInt32(this.layerBuffer.length);for(var i=0;i<this.layerBuffer.length;++i)t.writeInt16(this.layerBuffer[i]);var r=[];r.length=this.layerInfos.length;for(var o=0;o<r.length;++o){var a=this.layerInfos[o],s=new Emt;s.slot=o,s.tileSize=a.tileSize,s.detailMapId=a.detailMap?a.detailMap._uuid:"",s.normalMapId=a.normalMap?a.normalMap._uuid:"",s.metallic=a.metallic,s.roughness=a.roughness,r[o]=s}t.writeInt32(r.length);for(var c=0;c<r.length;++c)t.writeInt32(r[c].slot),t.writeFloat(r[c].tileSize),t.writeString(r[c].detailMapId),t.writeString(r[c].normalMapId),t.writeFloat(r[c].roughness),t.writeFloat(r[c].metallic);return t.buffer},n._exportDefaultNativeData=function(){var t=new Tmt;return t.writeInt32(Smt),t.buffer},Z(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data&&this._data.byteLength===t.byteLength?this._data.set(new Uint8Array(t)):this._data=new Uint8Array(t),this._loadNativeData(this._data)}},{key:"version",get:function(){return this._version}},{key:"tileSize",get:function(){return this._tileSize},set:function(t){this._tileSize=t}},{key:"blockCount",get:function(){return this._blockCount},set:function(t){this._blockCount=t}},{key:"lightMapSize",get:function(){return this._lightMapSize},set:function(t){this._lightMapSize=t}},{key:"weightMapSize",get:function(){return this._weightMapSize},set:function(t){this._weightMapSize=t}},{key:"heights",get:function(){return this._heights},set:function(t){this._heights=t}},{key:"weights",get:function(){return this._weights},set:function(t){this._weights=t}},{key:"layerBuffer",get:function(){return this._layerBuffer},set:function(t){this._layerBuffer=t}},{key:"layerInfos",get:function(){return this._layerInfos},set:function(t){this._layerInfos=t}},{key:"layerBinaryInfos",get:function(){return this._layerBinaryInfos}}]),e}(Du),C_t=lt((b_t=A_t).prototype,"_layerInfos",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),E_t=b_t))||E_t,Cmt=t("TerrainCollider",(w_t=dc("cc.TerrainCollider"),R_t=Ic(),P_t=Ac(),I_t=Kc(bmt),M_t=Lc(),w_t(D_t=R_t(D_t=P_t(D_t=Cc((lt((O_t=function(t){function e(){var e;return ct(e=t.call(this,bht.TERRAIN)||this,"_terrain",N_t,ot(e)),e}return $(e,t),Z(e,[{key:"terrain",get:function(){return this._terrain},set:function(t){this._terrain=t,this._shape&&this.shape.setTerrain(this._terrain)}},{key:"shape",get:function(){return this._shape}}]),e}(fpt)).prototype,"terrain",[I_t,M_t],Object.getOwnPropertyDescriptor(O_t.prototype,"terrain"),O_t.prototype),N_t=lt(O_t.prototype,"_terrain",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D_t=O_t))||D_t)||D_t)||D_t)||D_t)),Amt=t("SimplexCollider",(L_t=dc("cc.SimplexCollider"),B_t=Ic(),F_t=Ac(),z_t=Kc(Eht),k_t=Lc(),U_t=Lc(),G_t=Dc(),H_t=Lc(),V_t=Dc(),W_t=Lc(),j_t=Dc(),q_t=Lc(),L_t(X_t=B_t(X_t=F_t(X_t=Cc((J_t=Z_t=function(t){function e(){var e;return ct(e=t.call(this,bht.SIMPLEX)||this,"_shapeType",K_t,ot(e)),ct(e,"_vertices",Q_t,ot(e)),e}return $(e,t),e.prototype.updateVertices=function(){this._shape&&this.shape.setVertices(this._vertices)},Z(e,[{key:"shapeType",get:function(){return this._shapeType},set:function(t){this._shapeType=t,this._shape&&this.shape.setShapeType(t)}},{key:"vertex0",get:function(){return this._vertices[0]},set:function(t){Rn.copy(this._vertices[0],t),this.updateVertices()}},{key:"vertex1",get:function(){return this._vertices[1]},set:function(t){Rn.copy(this._vertices[1],t),this.updateVertices()}},{key:"vertex2",get:function(){return this._vertices[2]},set:function(t){Rn.copy(this._vertices[2],t),this.updateVertices()}},{key:"vertex3",get:function(){return this._vertices[3]},set:function(t){Rn.copy(this._vertices[3],t),this.updateVertices()}},{key:"shape",get:function(){return this._shape}},{key:"vertices",get:function(){return this._vertices}}]),e}(fpt),Z_t.ESimplexType=Eht,lt((Y_t=J_t).prototype,"shapeType",[z_t,k_t],Object.getOwnPropertyDescriptor(Y_t.prototype,"shapeType"),Y_t.prototype),lt(Y_t.prototype,"vertex0",[Mc,U_t],Object.getOwnPropertyDescriptor(Y_t.prototype,"vertex0"),Y_t.prototype),lt(Y_t.prototype,"vertex1",[G_t,H_t],Object.getOwnPropertyDescriptor(Y_t.prototype,"vertex1"),Y_t.prototype),lt(Y_t.prototype,"vertex2",[V_t,W_t],Object.getOwnPropertyDescriptor(Y_t.prototype,"vertex2"),Y_t.prototype),lt(Y_t.prototype,"vertex3",[j_t,q_t],Object.getOwnPropertyDescriptor(Y_t.prototype,"vertex3"),Y_t.prototype),K_t=lt(Y_t.prototype,"_shapeType",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eht.TETRAHEDRON}}),Q_t=lt(Y_t.prototype,"_vertices",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new Rn(0,0,0),new Rn(0,0,1),new Rn(1,0,0),new Rn(0,1,0)]}}),X_t=Y_t))||X_t)||X_t)||X_t)||X_t));Amt||(Amt=t("SimplexCollider",{}));var wmt,Rmt,Pmt,Imt,Mmt,Dmt,Omt,Nmt,Lmt,Bmt,Fmt,zmt,kmt,Umt,Gmt,Hmt,Vmt,Wmt,jmt,qmt,Xmt,Ymt,Kmt,Qmt,Zmt,Jmt,$mt,tvt,evt=t("PlaneCollider",($_t=dc("cc.PlaneCollider"),tmt=Ic(),emt=Ac(),nmt=Kc(Rn),imt=Lc(),rmt=Lc(),$_t(omt=tmt(omt=emt(omt=Cc((lt((amt=function(t){function e(){var e;return ct(e=t.call(this,bht.PLANE)||this,"_normal",smt,ot(e)),ct(e,"_constant",cmt,ot(e)),e}return $(e,t),Z(e,[{key:"normal",get:function(){return this._normal},set:function(t){Rn.strictEquals(this._normal,t)||(Rn.copy(this._normal,t),this._shape&&this.shape.setNormal(this._normal))}},{key:"constant",get:function(){return this._constant},set:function(t){this._constant!==t&&(this._constant=t,this._shape&&this.shape.setConstant(this._constant))}},{key:"shape",get:function(){return this._shape}}]),e}(fpt)).prototype,"normal",[nmt,imt],Object.getOwnPropertyDescriptor(amt.prototype,"normal"),amt.prototype),lt(amt.prototype,"constant",[Mc,rmt],Object.getOwnPropertyDescriptor(amt.prototype,"constant"),amt.prototype),smt=lt(amt.prototype,"_normal",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn(0,1,0)}}),cmt=lt(amt.prototype,"_constant",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),omt=amt))||omt)||omt)||omt)||omt)),nvt=t("Constraint",(wmt=dc("cc.Constraint"),Rmt=_c(hpt),Pmt=Kc(hpt),Imt=Gc(),Mmt=Kc(hpt),Dmt=Gc(),Omt=Gc(),Nmt=Kc(hpt),wmt(Lmt=Rmt((Umt=kmt=function(t){function e(e){var n;return(n=t.call(this)||this).TYPE=void 0,ct(n,"_enableCollision",Fmt,ot(n)),ct(n,"_connectedBody",zmt,ot(n)),n._constraint=null,n.TYPE=e,n}$(e,t);var n=e.prototype;return n.onLoad=function(){Mht.runInEditor&&(this._constraint=function(t){return Xht.INITED||(Xht.INITED=!0,Xht[Cht.POINT_TO_POINT]=function(){return Nht(Mht.wrapper.PointToPointConstraint,Iht.PointToPointConstraint)?Yht:new Mht.wrapper.PointToPointConstraint},Xht[Cht.HINGE]=function(){return Nht(Mht.wrapper.HingeConstraint,Iht.HingeConstraint)?Yht:new Mht.wrapper.HingeConstraint},Xht[Cht.CONE_TWIST]=function(){return Nht(Mht.wrapper.ConeTwistConstraint,Iht.ConeTwistConstraint)?Yht:new Mht.wrapper.ConeTwistConstraint}),Xht[t]()}(this.TYPE),this._constraint.initialize(this))},n.onEnable=function(){this._constraint&&this._constraint.onEnable()},n.onDisable=function(){this._constraint&&this._constraint.onDisable()},n.onDestroy=function(){this._constraint&&this._constraint.onDestroy()},Z(e,[{key:"attachedBody",get:function(){return this.getComponent(hpt)}},{key:"connectedBody",get:function(){return this._connectedBody},set:function(t){this._connectedBody=t,this._constraint&&this._constraint.setConnectedBody(t)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(t){this._enableCollision=t,this._constraint&&this._constraint.setEnableCollision(t)}}]),e}(tu($u)),kmt.Type=Cht,lt((Bmt=Umt).prototype,"attachedBody",[Pmt,Oc,Imt],Object.getOwnPropertyDescriptor(Bmt.prototype,"attachedBody"),Bmt.prototype),lt(Bmt.prototype,"connectedBody",[Mmt,Dmt],Object.getOwnPropertyDescriptor(Bmt.prototype,"connectedBody"),Bmt.prototype),lt(Bmt.prototype,"enableCollision",[Omt],Object.getOwnPropertyDescriptor(Bmt.prototype,"enableCollision"),Bmt.prototype),Fmt=lt(Bmt.prototype,"_enableCollision",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zmt=lt(Bmt.prototype,"_connectedBody",[Nmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lmt=Bmt))||Lmt)||Lmt));nvt||(nvt=t("Constraint",{}));var ivt,rvt,ovt,avt,svt,cvt,lvt,uvt,hvt,fvt=t("HingeConstraint",(Gmt=dc("cc.HingeConstraint"),Hmt=Ic(),Vmt=Ac(),Wmt=Kc(Rn),jmt=Kc(Rn),qmt=Kc(Rn),Xmt=Sc("axisA"),Ymt=Sc("pivotA"),Kmt=Sc("pivotB"),Gmt(Qmt=Hmt(Qmt=Vmt((lt((Zmt=function(t){function e(){var e;return ct(e=t.call(this,Cht.HINGE)||this,"_axis",Jmt,ot(e)),ct(e,"_pivotA",$mt,ot(e)),ct(e,"_pivotB",tvt,ot(e)),e}return $(e,t),Z(e,[{key:"pivotA",get:function(){return this._pivotA},set:function(t){Rn.copy(this._pivotA,t),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(t){Rn.copy(this._pivotB,t),this.constraint.setPivotB(this._pivotB)}},{key:"axis",get:function(){return this._axis},set:function(t){Rn.copy(this._axis,t),this.constraint.setAxis(this._axis)}},{key:"constraint",get:function(){return this._constraint}}]),e}(nvt)).prototype,"pivotA",[Wmt],Object.getOwnPropertyDescriptor(Zmt.prototype,"pivotA"),Zmt.prototype),lt(Zmt.prototype,"pivotB",[jmt],Object.getOwnPropertyDescriptor(Zmt.prototype,"pivotB"),Zmt.prototype),lt(Zmt.prototype,"axis",[qmt],Object.getOwnPropertyDescriptor(Zmt.prototype,"axis"),Zmt.prototype),Jmt=lt(Zmt.prototype,"_axis",[xc,Xmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),$mt=lt(Zmt.prototype,"_pivotA",[xc,Ymt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),tvt=lt(Zmt.prototype,"_pivotB",[xc,Kmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),Qmt=Zmt))||Qmt)||Qmt)||Qmt)),pvt=t("PointToPointConstraint",(ivt=dc("cc.PointToPointConstraint"),rvt=Ic(),ovt=Ac(),avt=Kc(Rn),svt=Kc(Rn),ivt(cvt=rvt(cvt=ovt((lt((lvt=function(t){function e(){var e;return ct(e=t.call(this,Cht.POINT_TO_POINT)||this,"_pivotA",uvt,ot(e)),ct(e,"_pivotB",hvt,ot(e)),e}return $(e,t),Z(e,[{key:"pivotA",get:function(){return this._pivotA},set:function(t){Rn.copy(this._pivotA,t),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(t){Rn.copy(this._pivotB,t),this.constraint.setPivotB(this._pivotB)}},{key:"constraint",get:function(){return this._constraint}}]),e}(nvt)).prototype,"pivotA",[avt],Object.getOwnPropertyDescriptor(lvt.prototype,"pivotA"),lvt.prototype),lt(lvt.prototype,"pivotB",[svt],Object.getOwnPropertyDescriptor(lvt.prototype,"pivotB"),lvt.prototype),uvt=lt(lvt.prototype,"_pivotA",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),hvt=lt(lvt.prototype,"_pivotB",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rn}}),cvt=lvt))||cvt)||cvt)||cvt));u.PhysicsSystem=Hft,u.PhysicsMaterial=Kht,u.PhysicsRayResult=Qht,u.ConstantForce=mmt;var dvt=Object.freeze({__proto__:null,PhysicsSystem:Hft,PhysicsRayResult:Qht,get Collider(){return fpt},BoxCollider:umt,SphereCollider:hmt,CapsuleCollider:fmt,MeshCollider:_mt,CylinderCollider:pmt,ConeCollider:dmt,TerrainCollider:Cmt,get SimplexCollider(){return Amt},PlaneCollider:evt,get Constraint(){return nvt},HingeConstraint:fvt,PointToPointConstraint:pvt,get RigidBody(){return hpt},PhysicsMaterial:Kht,ConstantForce:mmt,selector:Mht,utils:lmt,get ERigidBodyType(){return Sht},get EAxisDirection(){return Tht},get ESimplexType(){return Eht},get EColliderType(){return bht},get EConstraintType(){return Cht},get PhysicsGroup(){return Aht}});t("physics",dvt);var _vt=new Rht.Vec3,mvt=new Rht.Vec3,vvt=function(){function t(){this._isEnabled=!1}var e=t.prototype;return e.setAllowSleep=function(t){this.impl.type===Rht.Body.DYNAMIC&&(this.impl.allowSleep=t,this._wakeUpIfSleep())},e.setMass=function(t){this.impl.type===Rht.Body.DYNAMIC&&(this.impl.mass=t,this.impl.updateMassProperties(),this._wakeUpIfSleep())},e.setType=function(t){switch(t){case Sht.DYNAMIC:this.impl.type=Rht.Body.DYNAMIC,this.impl.allowSleep=this._rigidBody.allowSleep,this.setMass(this._rigidBody.mass);break;case Sht.KINEMATIC:this.impl.type=Rht.Body.KINEMATIC,this.impl.mass=0,this.impl.allowSleep=!1,this.impl.sleepState=Rht.Body.AWAKE,this.impl.updateMassProperties();break;case Sht.STATIC:default:this.impl.type=Rht.Body.STATIC,this.impl.mass=0,this.impl.allowSleep=!0,this.impl.updateMassProperties(),this.clearState()}},e.setLinearDamping=function(t){this.impl.linearDamping=t},e.setAngularDamping=function(t){this.impl.angularDamping=t},e.useGravity=function(t){this.impl.useGravity=t,this._wakeUpIfSleep()},e.useCCD=function(t){this.impl.ccdSpeedThreshold=t?.01:-1},e.isUsingCCD=function(){return-1!==this.impl.ccdSpeedThreshold},e.setLinearFactor=function(t){Rn.copy(this.impl.linearFactor,t),this._wakeUpIfSleep()},e.setAngularFactor=function(t){Rn.copy(this.impl.angularFactor,t);var e=Rn.equals(this.impl.angularFactor,Rn.ZERO);e!==this.impl.fixedRotation&&(this.impl.fixedRotation=e,this.impl.updateMassProperties()),this._wakeUpIfSleep()},e.initialize=function(t){this._rigidBody=t,this._sharedBody=Hft.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0,this._sharedBody.wrappedBody=this},e.onLoad=function(){},e.onEnable=function(){this._isEnabled=!0,this.setType(this._rigidBody.type),this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.useGravity(this._rigidBody.useGravity),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this._sharedBody.enabled=!0},e.onDisable=function(){this._isEnabled=!1,this._sharedBody.enabled=!1},e.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},e.clearVelocity=function(){this.impl.velocity.setZero(),this.impl.angularVelocity.setZero()},e.clearForces=function(){this.impl.force.setZero(),this.impl.torque.setZero()},e.clearState=function(){this.clearVelocity(),this.clearForces()},e.wakeUp=function(){return this.impl.wakeUp()},e.sleep=function(){return this.impl.sleep()},e.setSleepThreshold=function(t){this.impl.sleepSpeedLimit=t,this._wakeUpIfSleep()},e.getSleepThreshold=function(){return this.impl.sleepSpeedLimit},e.getLinearVelocity=function(t){return Rn.copy(t,this.impl.velocity),t},e.setLinearVelocity=function(t){this._wakeUpIfSleep(),Rn.copy(this.impl.velocity,t)},e.getAngularVelocity=function(t){return Rn.copy(t,this.impl.angularVelocity),t},e.setAngularVelocity=function(t){this._wakeUpIfSleep(),Rn.copy(this.impl.angularVelocity,t)},e.applyForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==e&&(e=Rn.ZERO),this.impl.applyForce(Rn.copy(_vt,t),Rn.copy(mvt,e))},e.applyImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==e&&(e=Rn.ZERO),this.impl.applyImpulse(Rn.copy(_vt,t),Rn.copy(mvt,e))},e.applyLocalForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==e&&(e=Rn.ZERO),this.impl.applyLocalForce(Rn.copy(_vt,t),Rn.copy(mvt,e))},e.applyLocalImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==e&&(e=Rn.ZERO),this.impl.applyLocalImpulse(Rn.copy(_vt,t),Rn.copy(mvt,e))},e.applyTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),Rn.add(this.impl.torque,this.impl.torque,t)},e.applyLocalTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),Rn.copy(_vt,t),this.impl.vectorToWorldFrame(_vt,_vt),Rn.add(this.impl.torque,this.impl.torque,_vt)},e.getGroup=function(){return this.impl.collisionFilterGroup},e.setGroup=function(t){this.impl.collisionFilterGroup=t,this._wakeUpIfSleep()},e.addGroup=function(t){this.impl.collisionFilterGroup|=t,this._wakeUpIfSleep()},e.removeGroup=function(t){this.impl.collisionFilterGroup&=~t,this._wakeUpIfSleep()},e.getMask=function(){return this.impl.collisionFilterMask},e.setMask=function(t){this.impl.collisionFilterMask=t,this._wakeUpIfSleep()},e.addMask=function(t){this.impl.collisionFilterMask|=t,this._wakeUpIfSleep()},e.removeMask=function(t){this.impl.collisionFilterMask&=~t,this._wakeUpIfSleep()},e._wakeUpIfSleep=function(){this.impl.isAwake()||this.impl.wakeUp()},Z(t,[{key:"isAwake",get:function(){return this.impl.isAwake()}},{key:"isSleepy",get:function(){return this.impl.isSleepy()}},{key:"isSleeping",get:function(){return this.impl.isSleeping()}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),t}();function gvt(t,e){t.checkCollisionResponse=!e.queryTrigger,t.collisionFilterGroup=-1,t.collisionFilterMask=e.mask}function yvt(t,e){t._assign(e.hitPointWorld,e.distance,Upt(e.shape).collider,e.hitNormalWorld)}function xvt(t){t.aabbNeedsUpdate=!0,t.updateMassProperties(),t.updateBoundingRadius()}var Svt={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},Tvt=new Rht.Quaternion,Evt=new Rht.Vec3,bvt=new Rht.Vec3,Cvt=function(){function t(){this._offset=new Rht.Vec3,this._orient=new Rht.Quaternion,this._index=-1,this.onTriggerListener=this._onTrigger.bind(this),this._isBinding=!1}var e=t.prototype;return e.updateEventListener=function(){},e.setMaterial=function(e){if(null==e)this._shape.material=null;else{null==t.idToMaterial[e.id]&&(t.idToMaterial[e.id]=new Rht.Material(e.id)),this._shape.material=t.idToMaterial[e.id];var n=this._shape.material;n.friction=e.friction,n.restitution=e.restitution;var i=Rht.CC_CONFIG.correctInelastic;n.correctInelastic=0===n.restitution?i:0}},e.setAsTrigger=function(t){this._shape.collisionResponse=!t,this._index>=0&&this._body.updateHasTrigger()},e.setCenter=function(t){this._setCenter(t),this._index>=0&&xvt(this._body)},e.setAttachedBody=function(t){if(t){if(this._sharedBody){if(this._sharedBody.wrappedBody===t.body)return;this._sharedBody.reference=!1}this._sharedBody=Hft.instance.physicsWorld.getSharedBody(t.node),this._sharedBody.reference=!0}else this._sharedBody&&(this._sharedBody.reference=!1),this._sharedBody=Hft.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0},e.getAABB=function(t){Ln.copy(Tvt,this._collider.node.worldRotation),this._shape.calculateWorldAABB(Rht.Vec3.ZERO,Tvt,Evt,bvt),Rn.subtract(t.halfExtents,bvt,Evt),Rn.multiplyScalar(t.halfExtents,t.halfExtents,.5),Rn.add(t.center,this._collider.node.worldPosition,this._collider.center)},e.getBoundingSphere=function(t){t.radius=this._shape.boundingSphereRadius,Rn.add(t.center,this._collider.node.worldPosition,this._collider.center)},e.initialize=function(t){this._collider=t,this._isBinding=!0,this._sharedBody=Hft.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),kpt(this._shape,this),this._shape.addEventListener("cc-trigger",this.onTriggerListener)},e.onComponentSet=function(){},e.onLoad=function(){this.setMaterial(this._collider.sharedMaterial),this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},e.onEnable=function(){this._sharedBody.addShape(this),this._sharedBody.enabled=!0},e.onDisable=function(){this._sharedBody.removeShape(this),this._sharedBody.enabled=!1},e.onDestroy=function(){this._sharedBody.reference=!1,this._shape.removeEventListener("cc-trigger",this.onTriggerListener),delete Rht.World.idToShapeMap[this._shape.id],this._sharedBody=null,kpt(this._shape,null),this._offset=null,this._orient=null,this._shape=null,this._collider=null,this.onTriggerListener=null},e.getGroup=function(){return this._body.collisionFilterGroup},e.setGroup=function(t){this._body.collisionFilterGroup=t,this._body.isAwake()||this._body.wakeUp()},e.addGroup=function(t){this._body.collisionFilterGroup|=t,this._body.isAwake()||this._body.wakeUp()},e.removeGroup=function(t){this._body.collisionFilterGroup&=~t,this._body.isAwake()||this._body.wakeUp()},e.getMask=function(){return this._body.collisionFilterMask},e.setMask=function(t){this._body.collisionFilterMask=t,this._body.isAwake()||this._body.wakeUp()},e.addMask=function(t){this._body.collisionFilterMask|=t,this._body.isAwake()||this._body.wakeUp()},e.removeMask=function(t){this._body.collisionFilterMask&=~t,this._body.isAwake()||this._body.wakeUp()},e.setScale=function(){this._setCenter(this._collider.center)},e.setIndex=function(t){this._index=t},e.setOffsetAndOrient=function(t,e){Rn.copy(t,this._offset),Ln.copy(e,this._orient),this._offset=t,this._orient=e},e._setCenter=function(t){var e=this._offset;Rn.subtract(e,this._sharedBody.node.worldPosition,this._collider.node.worldPosition),Rn.add(e,e,t),Rn.multiply(e,e,this._collider.node.worldScale)},e._onTrigger=function(t){Svt.type=t.event;var e=Upt(t.selfShape),n=Upt(t.otherShape);e&&e.collider.needTriggerEvent&&(Svt.selfCollider=e.collider,Svt.otherCollider=n?n.collider:null,Svt.impl=t,this._collider.emit(Svt.type,Svt))},Z(t,[{key:"impl",get:function(){return this._shape}},{key:"collider",get:function(){return this._collider}},{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_body",get:function(){return this._sharedBody.body}}]),t}();Cvt.idToMaterial={},U(Hft,"PhysicsSystem",[{name:"ins",newName:"instance"},{name:"PHYSICS_AMMO",newName:"PHYSICS_BULLET"}]),U(Hft.prototype,"PhysicsSystem.prototype",[{name:"deltaTime",newName:"fixedTimeStep"},{name:"maxSubStep",newName:"maxSubSteps"}]),G(Hft.prototype,"PhysicsSystem.prototype",[{name:"useFixedTime"},{name:"useCollisionMatrix"},{name:"updateCollisionMatrix"},{name:"resetCollisionMatrix"},{name:"isCollisionGroup"},{name:"setCollisionGroup"}]),U(fpt.prototype,"Collider.prototype",[{name:"attachedRigidbody",newName:"attachedRigidBody"},{name:"TYPE",newName:"type"}]),U(fpt,"Collider",[{name:"EColliderType",newName:"Type"},{name:"EAxisDirection",newName:"Axis"}]),U(nvt,"Constraint",[{name:"EConstraintType",newName:"Type"}]),U(umt.prototype,"BoxCollider.prototype",[{name:"boxShape",newName:"shape"}]),U(hmt.prototype,"SphereCollider.prototype",[{name:"sphereShape",newName:"shape"}]),U(fmt.prototype,"CapsuleCollider.prototype",[{name:"capsuleShape",newName:"shape"}]),U(hpt.prototype,"RigidBody.prototype",[{name:"rigidBody",newName:"body"}]),U(hpt,"RigidBody",[{name:"ERigidBodyType",newName:"Type"}]),G(hpt.prototype,"RigidBody.prototype",[{name:"fixedRotation"}]),u.RigidBodyComponent=hpt,ie.setClassAlias(hpt,"cc.RigidBodyComponent"),u.ColliderComponent=fpt,ie.setClassAlias(fpt,"cc.ColliderComponent"),u.BoxColliderComponent=umt,ie.setClassAlias(umt,"cc.BoxColliderComponent"),u.SphereColliderComponent=hmt,ie.setClassAlias(hmt,"cc.SphereColliderComponent"),ie.setClassAlias(fmt,"cc.CapsuleColliderComponent"),ie.setClassAlias(_mt,"cc.MeshColliderComponent"),ie.setClassAlias(pmt,"cc.CylinderColliderComponent"),u.PhysicMaterial=Kht,ie.setClassAlias(Kht,"cc.PhysicMaterial"),u.physics=dvt;var Avt=new Ln,wvt=function(){function t(t){this.impl=null,this.event=void 0,this.event=t}var e=t.prototype;return e.getLocalPointOnA=function(t){this.impl&&Rn.copy(t,this.impl.rj)},e.getLocalPointOnB=function(t){this.impl&&Rn.copy(t,this.impl.ri)},e.getWorldPointOnA=function(t){this.impl&&Rn.add(t,this.impl.rj,this.impl.bj.position)},e.getWorldPointOnB=function(t){this.impl&&Rn.add(t,this.impl.ri,this.impl.bi.position)},e.getLocalNormalOnA=function(t){this.impl&&(this.getWorldNormalOnA(t),Ln.conjugate(Avt,this.impl.bi.quaternion),Rn.transformQuat(t,t,Avt))},e.getLocalNormalOnB=function(t){this.impl&&(Ln.conjugate(Avt,this.impl.bj.quaternion),Rn.transformQuat(t,this.impl.ni,Avt))},e.getWorldNormalOnA=function(t){this.impl&&(this.getWorldNormalOnB(t),this.isBodyA||Rn.negate(t,t))},e.getWorldNormalOnB=function(t){this.impl&&Rn.copy(t,this.impl.ni)},Z(t,[{key:"isBodyA",get:function(){if(this.impl){var t=this.event.selfCollider.shape.impl,e=this.impl.bj;return t.body.id===e.id}return!1}}]),t}(),Rvt=new Rn,Pvt=new Ln,Ivt=[],Mvt={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},Dvt=function(){function t(t,e){this.node=void 0,this.wrappedWorld=void 0,this.body=void 0,this.wrappedShapes=[],this.wrappedJoints0=[],this.wrappedJoints1=[],this.wrappedBody=null,this.index=-1,this.ref=0,this.onCollidedListener=this.onCollided.bind(this),this.wrappedWorld=e,this.node=t,this.body=new Rht.Body,kpt(this.body,this),this.body.collisionFilterGroup=Hft.PhysicsGroup.DEFAULT,this.body.sleepSpeedLimit=Hft.instance.sleepThreshold,this.body.material=this.wrappedWorld.impl.defaultMaterial,this.body.addEventListener("cc-collide",this.onCollidedListener)}t.getSharedBody=function(e,n,i){var r,o=e.uuid;if(t.sharedBodesMap.has(o))r=t.sharedBodesMap.get(o);else{r=new t(e,n);var a=Aht.DEFAULT,s=Hft.instance.collisionMatrix[a];r.body.collisionFilterGroup=a,r.body.collisionFilterMask=s,t.sharedBodesMap.set(e.uuid,r)}if(i){r.wrappedBody=i;var c=i.rigidBody.group,l=Hft.instance.collisionMatrix[c];r.body.collisionFilterGroup=c,r.body.collisionFilterMask=l}return r};var e=t.prototype;return e.addShape=function(t){if(this.wrappedShapes.indexOf(t)<0){var e=this.body.shapes.length;this.body.addShape(t.impl),this.wrappedShapes.push(t),t.setIndex(e);var n=this.body.shapeOffsets[e],i=this.body.shapeOrientations[e];t.setOffsetAndOrient(n,i),this.body.isSleeping()&&this.body.wakeUp()}},e.removeShape=function(t){var e=this.wrappedShapes.indexOf(t);e>=0&&(ft(this.wrappedShapes,e),this.body.removeShape(t.impl),t.setIndex(-1),this.body.isSleeping()&&this.body.wakeUp())},e.addJoint=function(t,e){e?this.wrappedJoints1.indexOf(t)<0&&this.wrappedJoints1.push(t):this.wrappedJoints0.indexOf(t)<0&&this.wrappedJoints0.push(t)},e.removeJoint=function(t,e){if(e){var n=this.wrappedJoints1.indexOf(t);n>=0&&ft(this.wrappedJoints1,n)}else{var i=this.wrappedJoints0.indexOf(t);i>=0&&ft(this.wrappedJoints0,i)}},e.syncSceneToPhysics=function(){var t=this.node,e=this.body;t.hasChangedFlags&&(e.isSleeping()&&e.wakeUp(),Rn.copy(e.position,t.worldPosition),Ln.copy(e.quaternion,t.worldRotation),e.aabbNeedsUpdate=!0,t.hasChangedFlags&iy.SCALE&&this.syncScale())},e.syncPhysicsToScene=function(){var t=this.node,e=this.body;e.type===Sht.DYNAMIC&&(e.isSleeping()||(Rn.copy(Rvt,e.position),Ln.copy(Pvt,e.quaternion),t.worldPosition=Rvt,t.worldRotation=Pvt))},e.syncInitial=function(){var t=this.node,e=this.body;Rn.copy(e.position,t.worldPosition),Ln.copy(e.quaternion,t.worldRotation),Rn.copy(e.previousPosition,t.worldPosition),Ln.copy(e.previousQuaternion,t.worldRotation),e.aabbNeedsUpdate=!0,this.syncScale(),e.isSleeping()&&e.wakeUp()},e.syncScale=function(){for(var t=0;t<this.wrappedShapes.length;t++)this.wrappedShapes[t].setScale(this.node.worldScale);for(var e=0;e<this.wrappedJoints0.length;e++)this.wrappedJoints0[e].updateScale0();for(var n=0;n<this.wrappedJoints1.length;n++)this.wrappedJoints1[n].updateScale1();xvt(this.body)},e.destroy=function(){kpt(this.body,null),this.body.removeEventListener("cc-collide",this.onCollidedListener),t.sharedBodesMap.delete(this.node.uuid),delete Rht.World.idToBodyMap[this.body.id],this.node=null,this.wrappedWorld=null,this.body=null,this.wrappedShapes=null,this.wrappedJoints0=null,this.wrappedJoints1=null,this.onCollidedListener=null},e.onCollided=function(t){Mvt.type=t.event;var e=Upt(t.selfShape),n=Upt(t.otherShape);if(e&&e.collider.needCollisionEvent){Ivt.push.apply(Ivt,Mvt.contacts),Mvt.contacts.length=0,Mvt.impl=t,Mvt.selfCollider=e.collider,Mvt.otherCollider=n?n.collider:null;var i=0;if("onCollisionExit"!==Mvt.type)for(i=0;i<t.contacts.length;i++){var r=t.contacts[i];if(Ivt.length>0){var o=Ivt.pop();o.impl=r,Mvt.contacts.push(o)}else{var a=new wvt(Mvt);a.impl=r,Mvt.contacts.push(a)}}for(i=0;i<this.wrappedShapes.length;i++)this.wrappedShapes[i].collider.emit(Mvt.type,Mvt)}},Z(t,[{key:"enabled",set:function(t){t?this.index<0&&(this.index=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitial()):this.index>=0&&(0===this.wrappedShapes.length&&null==this.wrappedBody||0===this.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled)&&(this.body.sleep(),this.index=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}();Dvt.sharedBodesMap=new Map;var Ovt=function(){var t=e.prototype;function e(){this.bodies=[],this.constraints=[],this._world=void 0,this._world=new Rht.World,this._world.broadphase=new Rht.NaiveBroadphase,this._world.solver.iterations=10,this._world.solver.tolerance=1e-4,this._world.defaultContactMaterial.contactEquationStiffness=1e6,this._world.defaultContactMaterial.frictionEquationStiffness=1e6,this._world.defaultContactMaterial.contactEquationRelaxation=3,this._world.defaultContactMaterial.frictionEquationRelaxation=3}return t.setDefaultMaterial=function(t){this._world.defaultMaterial.friction=t.friction,this._world.defaultMaterial.restitution=t.restitution,null!=Cvt.idToMaterial[t.id]&&(Cvt.idToMaterial[t.id]=this._world.defaultMaterial)},t.setAllowSleep=function(t){this._world.allowSleep=t},t.setGravity=function(t){Rn.copy(this._world.gravity,t)},t.destroy=function(){(this.constraints.length||this.bodies.length)&&T("You should destroy all physics component first."),this._world.broadphase=null,this._world=null},t.emitEvents=function(){this._world.emitTriggeredEvents(),this._world.emitCollisionEvents()},t.syncSceneToPhysics=function(){for(var t=0;t<this.bodies.length;t++)this.bodies[t].syncSceneToPhysics()},t.syncAfterEvents=function(){this.syncSceneToPhysics()},t.step=function(t,e,n){if(0!==this.bodies.length){this._world.step(t,e,n);for(var i=0;i<this.bodies.length;i++)this.bodies[i].syncPhysicsToScene()}},t.raycastClosest=function(t,n,i){Bvt(t,n.maxDistance),gvt(Fvt,n);var r=this._world.raycastClosest(Nvt,Lvt,Fvt,e.rayResult);return r&&yvt(i,e.rayResult),r},t.raycast=function(t,e,n,i){return Bvt(t,e.maxDistance),gvt(Fvt,e),this._world.raycastAll(Nvt,Lvt,Fvt,(function(t){var e=n.add();yvt(e,t),i.push(e)}))},t.getSharedBody=function(t,e){return Dvt.getSharedBody(t,this,e)},t.addSharedBody=function(t){this.bodies.indexOf(t)<0&&(this.bodies.push(t),this._world.addBody(t.body))},t.removeSharedBody=function(t){var e=this.bodies.indexOf(t);e>=0&&(ft(this.bodies,e),this._world.remove(t.body))},t.addConstraint=function(t){this.constraints.indexOf(t)<0&&(this.constraints.push(t),this._world.addConstraint(t.impl))},t.removeConstraint=function(t){var e=this.constraints.indexOf(t);e>=0&&(ft(this.constraints,e),this._world.removeConstraint(t.impl))},Z(e,[{key:"impl",get:function(){return this._world}}]),e}();Ovt.rayResult=new Rht.RaycastResult;var Nvt=new Rht.Vec3,Lvt=new Rht.Vec3;function Bvt(t,e){Rn.copy(Nvt,t.o),t.computeHit(Lvt,e)}var Fvt={checkCollisionResponse:!1,collisionFilterGroup:-1,collisionFilterMask:-1,skipBackfaces:!0},zvt=function(t){function e(){var e;return(e=t.call(this)||this).halfExtent=void 0,e.halfExtent=new Rht.Vec3(.5,.5,.5),e._shape=new Rht.Box(e.halfExtent.clone()),e}$(e,t);var n=e.prototype;return n.updateSize=function(){Rn.multiplyScalar(this.halfExtent,this.collider.size,.5);var t=Hpt(Gpt.set(this.collider.node.worldScale)),e=this.halfExtent.x*t.x,n=this.halfExtent.y*t.y,i=this.halfExtent.z*t.z,r=Hft.instance.minVolumeSize;this.impl.halfExtents.x=sn(e,r,Number.MAX_VALUE),this.impl.halfExtents.y=sn(n,r,Number.MAX_VALUE),this.impl.halfExtents.z=sn(i,r,Number.MAX_VALUE),this.impl.updateConvexPolyhedronRepresentation(),-1!==this._index&&xvt(this._body)},n.onLoad=function(){t.prototype.onLoad.call(this),this.updateSize()},n.setScale=function(e){t.prototype.setScale.call(this,e),this.updateSize()},Z(e,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),e}(Cvt),kvt=function(t){$(n,t);var e=n.prototype;function n(e){var n;return void 0===e&&(e=.5),(n=t.call(this)||this)._shape=new Rht.Sphere(e),n}return e.updateRadius=function(){var t=Math.abs(Tn(this.collider.node.worldScale));this.impl.radius=sn(this.collider.radius*Math.abs(t),Hft.instance.minVolumeSize,Number.MAX_VALUE),this.impl.updateBoundingSphereRadius(),-1!==this._index&&xvt(this._body)},e.onLoad=function(){t.prototype.onLoad.call(this),this.updateRadius()},e.setScale=function(e){t.prototype.setScale.call(this,e),this.updateRadius()},Z(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(Cvt),Uvt=new Rht.Vec3,Gvt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.setMesh=function(t){if(this._isBinding){var e=t;if(null!=this._shape)if(e&&e.renderingSubMeshes.length>0){var n=e.renderingSubMeshes[0].geometricInfo.positions,i=e.renderingSubMeshes[0].geometricInfo.indices;this.updateProperties(n,i)}else this.updateProperties(new Float32Array,new Uint16Array);else if(e&&e.renderingSubMeshes.length>0){var r=e.renderingSubMeshes[0].geometricInfo.positions,o=e.renderingSubMeshes[0].geometricInfo.indices;this._shape=new Rht.Trimesh(r,o)}else this._shape=new Rht.Trimesh(new Float32Array,new Uint16Array)}},n.onComponentSet=function(){this.setMesh(this.collider.mesh)},n.onLoad=function(){t.prototype.onLoad.call(this),this.setMesh(this.collider.mesh)},n.setScale=function(e){t.prototype.setScale.call(this,e),Rn.copy(Uvt,e),this.impl.setScale(Uvt)},n.updateProperties=function(t,e){this.impl.vertices=new Float32Array(t),this.impl.indices=new Int16Array(e),this.impl.normals=new Float32Array(e.length),this.impl.aabb=new Rht.AABB,this.impl.edges=[],this.impl.tree=new Rht.Octree(new Rht.AABB),this.impl.updateEdges(),this.impl.updateNormals(),this.impl.updateAABB(),this.impl.updateBoundingSphereRadius(),this.impl.updateTree(),this.impl.setScale(this.impl.scale),this._index>=0&&xvt(this._body)},Z(e,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),e}(Cvt),Hvt=function(t){$(n,t);var e=n.prototype;function n(e,n,i){var r;return void 0===e&&(e=.5),void 0===n&&(n=2),void 0===i&&(i=Tht.Y_AXIS),(r=t.call(this)||this)._shape=new Rht.Cylinder(e,e,n,Rht.CC_CONFIG.numSegmentsCylinder,i===Tht.Y_AXIS),r}return e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,Rht.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&xvt(this._body)},e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,Rht.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&xvt(this._body)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,Rht.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&xvt(this._body)},e.onLoad=function(){t.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},e.setScale=function(e){t.prototype.setScale.call(this,e),this.setRadius(this.collider.radius)},e.updateProperties=function(t,e,n,i,r){var o=e,a=t,s=Math.cos,c=Math.sin,l=Math.abs,u=Math.max;1===i?(o=l(r.y)*e,a=u(l(r.x),l(r.z))*t):2===i?(o=l(r.z)*e,a=u(l(r.x),l(r.y))*t):(o=l(r.x)*e,a=u(l(r.y),l(r.z))*t);var h=n,f=o/2,p=[],d=[],_=[],m=2*Math.PI/h;if(1===i){for(var v=[1],g=[0],y=0;y<h;y++){var x=a*s(m*y),S=a*c(m*y);p.push(new Rht.Vec3(x,f,S)),p.push(new Rht.Vec3(x,-f,S)),y<h-1?(d.push([2*y+2,2*y+3,2*y+1,2*y]),g.push(2*y+2),v.push(2*y+3)):d.push([0,1,2*y+1,2*y]),(h%2==1||y<h/2)&&_.push(new Rht.Vec3(s(m*(y+.5)),0,c(m*(y+.5))))}d.push(v);for(var T=[],E=0;E<g.length;E++)T.push(g[g.length-E-1]);d.push(T),_.push(new Rht.Vec3(0,1,0))}else if(2===i){for(var b=[0],C=[1],A=0;A<h;A++){var w=a*s(m*A),R=a*c(m*A);p.push(new Rht.Vec3(w,R,f)),p.push(new Rht.Vec3(w,R,-f)),A<h-1?(d.push([2*A,2*A+1,2*A+3,2*A+2]),b.push(2*A+2),C.push(2*A+3)):d.push([2*A,2*A+1,0,1]),(h%2==1||A<h/2)&&_.push(new Rht.Vec3(s(m*(A+.5)),c(m*(A+.5)),0))}d.push(b);for(var P=[],I=0;I<C.length;I++)P.push(C[C.length-I-1]);d.push(P),_.push(new Rht.Vec3(0,0,1))}else{for(var M=[0],D=[1],O=0;O<h;O++){var N=a*s(m*O),L=a*c(m*O);p.push(new Rht.Vec3(f,N,L)),p.push(new Rht.Vec3(-f,N,L)),O<h-1?(d.push([2*O,2*O+1,2*O+3,2*O+2]),M.push(2*O+2),D.push(2*O+3)):d.push([2*O,2*O+1,0,1]),(h%2==1||O<h/2)&&_.push(new Rht.Vec3(0,s(m*(O+.5)),c(m*(O+.5))))}d.push(M);for(var B=[],F=0;F<D.length;F++)B.push(D[D.length-F-1]);d.push(B),_.push(new Rht.Vec3(1,0,0))}this.impl.vertices=p,this.impl.faces=d,this.impl.uniqueAxes=_,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},Z(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(Cvt),Vvt=new Rn,Wvt=new Rn,jvt=function(t){$(n,t);var e=n.prototype;function n(e,n,i){var r;return void 0===e&&(e=.5),void 0===n&&(n=1),void 0===i&&(i=Tht.Y_AXIS),(r=t.call(this)||this)._shape=new Rht.Cylinder(0,e,n,Rht.CC_CONFIG.numSegmentsCone,i===Tht.Y_AXIS),r}return e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,Rht.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&xvt(this._body)},e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,Rht.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&xvt(this._body)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,Rht.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&xvt(this._body)},e.onLoad=function(){t.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},e.setScale=function(e){t.prototype.setScale.call(this,e),this.setRadius(this.collider.radius)},e.updateProperties=function(t,e,n,i,r){var o=e,a=t,s=Math.cos,c=Math.sin,l=Math.abs,u=Math.max;1===i?(o=l(r.y)*e,a=u(l(r.x),l(r.z))*t):2===i?(o=l(r.z)*e,a=u(l(r.x),l(r.y))*t):(o=l(r.x)*e,a=u(l(r.y),l(r.z))*t);var h=n,f=o/2,p=[],d=[],_=[],m=2*Math.PI/h;if(1===i){var v=[];d.push(v),p.push(new Rht.Vec3(0,f,0));for(var g=0;g<h;g++){var y=a*s(m*g),x=a*c(m*g);p.push(new Rht.Vec3(y,-f,x))}for(var S=0;S<h;S++){0!==S&&v.push(S);var T;T=S<h-1?[0,S+2,S+1]:[0,1,S+1],d.push(T),Rn.subtract(Vvt,p[0],p[T[1]]),Rn.subtract(Wvt,p[T[2]],p[T[1]]),Rn.cross(Vvt,Wvt,Vvt),Vvt.normalize(),_.push(new Rht.Vec3(Vvt.x,Vvt.y,Vvt.z))}_.push(new Rht.Vec3(0,-1,0))}else if(2===i){var E=[];d.push(E),p.push(new Rht.Vec3(0,0,f));for(var b=0;b<h;b++){var C=a*s(m*b),A=a*c(m*b);p.push(new Rht.Vec3(C,A,-f))}for(var w=0;w<h;w++){0!==w&&E.push(h-w);var R;R=w<h-1?[0,w+1,w+2]:[0,w+1,1],d.push(R),Rn.subtract(Vvt,p[0],p[R[1]]),Rn.subtract(Wvt,p[R[2]],p[R[1]]),Rn.cross(Vvt,Vvt,Wvt),Vvt.normalize(),_.push(new Rht.Vec3(Vvt.x,Vvt.y,Vvt.z))}_.push(new Rht.Vec3(0,0,-1))}else{var P=[];d.push(P),p.push(new Rht.Vec3(f,0,0));for(var I=0;I<h;I++){var M=a*s(m*I),D=a*c(m*I);p.push(new Rht.Vec3(-f,M,D))}for(var O=0;O<h;O++){0!==O&&P.push(h-O);var N;N=O<h-1?[0,O+1,O+2]:[0,O+1,1],d.push(N),Rn.subtract(Vvt,p[0],p[N[1]]),Rn.subtract(Wvt,p[N[2]],p[N[1]]),Rn.cross(Vvt,Vvt,Wvt),Vvt.normalize(),_.push(new Rht.Vec3(Vvt.x,Vvt.y,Vvt.z))}_.push(new Rht.Vec3(-1,0,0))}this.impl.vertices=p,this.impl.faces=d,this.impl.uniqueAxes=_,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},Z(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(Cvt),qvt=new Rht.AABB,Xvt=new Rht.AABB,Yvt=new Rht.Transform;Rht.Heightfield.prototype.calculateWorldAABB=function(t,e,n,i){var r=Yvt,o=Xvt;Rn.copy(r.position,t),Ln.copy(r.quaternion,e);var a=this.elementSize,s=this.data;qvt.lowerBound.set(0,0,this.minValue),qvt.upperBound.set((s.length-1)*a,(s[0].length-1)*a,this.maxValue),qvt.toWorldFrame(r,o),n.copy(o.lowerBound),i.copy(o.upperBound)};var Kvt,Qvt=function(t){$(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this).data=void 0,e.options=void 0,e._terrainID=void 0,e.data=[[]],e.options={elementSize:0},e._terrainID="",e}return e.setTerrain=function(t){if(t){if(this._terrainID!==t._uuid){var e=t,n=e.getVertexCountI(),i=e.getVertexCountJ();this._terrainID=e._uuid,this.data.length=n-1;for(var r=0;r<n;r++){null==this.data[r]&&(this.data[r]=[]),this.data[r].length=i-1;for(var o=0;o<i;o++)this.data[r][o]=e.getHeight(r,i-1-o)}this.options.elementSize=e.tileSize,this.updateProperties(this.data,this.options.elementSize)}}else""!==this._terrainID&&(this._terrainID="",this.data.length=1,this.data[0]=this.data[0]||[],this.data[0].length=0,this.options.elementSize=0,this.updateProperties(this.data,this.options.elementSize))},e.onComponentSet=function(){var t=this.collider.terrain;if(t){for(var e=t.getVertexCountI(),n=t.getVertexCountJ(),i=0;i<e;i++){null==this.data[i]&&(this.data[i]=[]);for(var r=0;r<n;r++)this.data[i][r]=t.getHeight(i,n-1-r)}this.options.elementSize=t.tileSize,this._terrainID=t._uuid}this._shape=new Rht.Heightfield(this.data,this.options)},e.onLoad=function(){t.prototype.onLoad.call(this),this.setTerrain(this.collider.terrain)},e.updateProperties=function(t,e){var n=this.impl;n.data=t,n.elementSize=e,n.updateMinValue(),n.updateMaxValue(),n.updateBoundingSphereRadius(),n.update(),this._index>=0&&xvt(this._body)},e._setCenter=function(t){var e=this.collider.terrain;if(e){Ln.fromEuler(this._orient,-90,0,0);var n=this._offset;Rn.set(n,0,0,(e.getVertexCountJ()-1)*e.tileSize),Rn.add(n,n,t)}},Z(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(Cvt),Zvt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).vertices=[],e}$(e,t);var n=e.prototype;return n.setShapeType=function(){this._isBinding},n.setVertices=function(t){var e=this.vertices.length;if(4===e){for(var n=this._collider.node.worldScale,i=0;i<e;i++)Rn.multiply(this.vertices[i],n,t[i]);var r=this.impl;r.computeNormals(),r.computeEdges(),r.updateBoundingSphereRadius()}-1!==this._index&&xvt(this._body)},n.onComponentSet=function(){if(this.collider.shapeType===Amt.ESimplexType.TETRAHEDRON){for(var t=0;t<4;t++)this.vertices[t]=new Rht.Vec3(0,0,0);this._shape=Jvt(this.vertices)}else Amt.ESimplexType.VERTEX,this._shape=new Rht.Particle},n.onLoad=function(){t.prototype.onLoad.call(this),this.collider.updateVertices()},n.setScale=function(e){t.prototype.setScale.call(this,e),this.collider.updateVertices()},Z(e,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),e}(Cvt),Jvt=(Kvt=[[0,3,2],[0,1,3],[0,2,1],[1,2,3]],function(t){return new Rht.ConvexPolyhedron(t,Kvt)}),$vt=function(t){function e(){var e;return(e=t.call(this)||this)._shape=new Rht.Plane,e}$(e,t);var n=e.prototype;return n.setNormal=function(t){Ln.rotationTo(this._orient,Rn.UNIT_Z,t),-1!==this._index&&xvt(this._body)},n.setConstant=function(t){Rn.scaleAndAdd(this._offset,this._collider.center,this.collider.normal,t)},n.onLoad=function(){t.prototype.onLoad.call(this),this.setConstant(this.collider.constant),this.setNormal(this.collider.normal)},n._setCenter=function(e){t.prototype._setCenter.call(this,e),this.setConstant(this.collider.constant)},Z(e,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),e}(Cvt);Rht.World.staticBody=new Rht.Body,Rht.World.idToConstraintMap={};var tgt,egt,ngt,igt,rgt,ogt,agt,sgt,cgt,lgt=function(){function t(){}var e=t.prototype;return e.setConnectedBody=function(t){var e=Upt(this.impl.bodyB);e&&e.removeJoint(this,1),t?(this._impl.bodyB=t.body.impl,t.body.sharedBody.addJoint(this,1)):this._impl.bodyB=Rht.World.staticBody;var n=this._impl.bodyB;this._impl.equations.forEach((function(t){t.bj=n}))},e.setEnableCollision=function(t){this._impl.collideConnected=t},e.initialize=function(t){this._com=t,this._rigidBody=t.attachedBody,this.onComponentSet(),this.setEnableCollision(t.enableCollision),Rht.World.idToConstraintMap[this._impl.id]=this._impl},e.onComponentSet=function(){},e.updateScale0=function(){},e.updateScale1=function(){},e.onEnable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.addConstraint(this),t.addJoint(this,0);var e=this.constraint.connectedBody;e&&e.body.sharedBody.addJoint(this,1)},e.onDisable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.removeJoint(this,0);var e=this.constraint.connectedBody;e&&e.body.sharedBody.removeJoint(this,1)},e.onDestroy=function(){delete Rht.World.idToConstraintMap[this._impl.id],this._com=null,this._rigidBody=null,this._impl=null},Z(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(),ugt=new Rn,hgt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.setPivotA=function(){var t=this.constraint;Rn.multiply(this.impl.pivotA,t.node.worldScale,t.pivotA),t.connectedBody||this.setPivotB(t.pivotB)},n.setPivotB=function(){var t=this.constraint,e=t.connectedBody;if(e)Rn.multiply(this.impl.pivotB,e.node.worldScale,t.pivotB);else{var n=t.node;Rn.multiply(ugt,n.worldScale,t.pivotA),Rn.add(ugt,ugt,n.worldPosition),Rn.add(ugt,ugt,t.pivotB),Rn.copy(this.impl.pivotB,ugt)}},n.onComponentSet=function(){var t=this._rigidBody.body.impl,e=this.constraint.connectedBody,n=Rht.World.staticBody;e&&(n=e.body.impl),this._impl=new Rht.PointToPointConstraint(t,null,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},Z(e,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),e}(lgt),fgt=new Rn,pgt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.setPivotA=function(){var t=this.constraint;Rn.multiply(this.impl.pivotA,this.constraint.node.worldScale,t.pivotA),t.connectedBody||this.setPivotB(t.pivotB)},n.setPivotB=function(){var t=this.constraint,e=t.connectedBody;if(e)Rn.multiply(this.impl.pivotB,e.node.worldScale,t.pivotB);else{var n=this.constraint.node;Rn.multiply(fgt,n.worldScale,t.pivotA),Rn.add(fgt,fgt,n.worldPosition),Rn.add(fgt,fgt,t.pivotB),Rn.copy(this.impl.pivotB,fgt)}},n.setAxis=function(t){Rn.copy(this.impl.axisA,t),Rn.copy(this.impl.equations[3].axisA,t),Rn.copy(this.impl.equations[4].axisA,t),Rn.copy(this.impl.equations[5].axisA,t),this.constraint.connectedBody?(Rn.copy(this.impl.axisB,t),Rn.copy(this.impl.equations[3].axisB,t),Rn.copy(this.impl.equations[4].axisB,t),Rn.copy(this.impl.equations[5].axisB,t)):(Rn.transformQuat(this.impl.axisB,t,this.constraint.node.worldRotation),Rn.copy(this.impl.equations[3].axisB,this.impl.axisB),Rn.copy(this.impl.equations[4].axisB,this.impl.axisB),Rn.copy(this.impl.equations[5].axisB,this.impl.axisB))},n.onComponentSet=function(){var t=this._rigidBody.body.impl,e=this.constraint.connectedBody,n=Rht.World.staticBody;e&&(n=e.body.impl),this._impl=new Rht.HingeConstraint(t,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.setAxis(this.constraint.axis)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},Z(e,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),e}(lgt);GO.once(UO.EVENT_ENGINE_INITED,(function(){Mht.register("cannon.js",{PhysicsWorld:Ovt,RigidBody:vvt,BoxShape:zvt,SphereShape:kvt,TrimeshShape:Gvt,CylinderShape:Hvt,ConeShape:jvt,TerrainShape:Qvt,SimplexShape:Zvt,PlaneShape:$vt,PointToPointConstraint:hgt,HingeConstraint:pgt})})),window&&(window.CANNON=Rht),Rht.CC_CONFIG={numSegmentsCone:12,numSegmentsCylinder:12,ignoreSelfBody:!0,correctInelastic:3},Rht.ArrayCollisionMatrix.prototype.reset=function(){for(var t in this.matrix)delete this.matrix[t]},Rht.Ray.perBodyFilter=function(t,e){return 0!=(t.collisionFilterMask&e.collisionFilterGroup)},function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CYLINDER=2]="CYLINDER",t[t.CONE=3]="CONE",t[t.CAPSULE=4]="CAPSULE",t[t.TORUS=5]="TORUS",t[t.PLANE=6]="PLANE",t[t.QUAD=7]="QUAD"}(cgt||(cgt={})),ce(cgt);var dgt=t("Primitive",(tgt=dc("cc.Primitive"),egt=Kc(cgt),tgt((sgt=agt=function(t){function e(e){var n;return void 0===e&&(e=cgt.BOX),ct(n=t.call(this)||this,"type",rgt,ot(n)),ct(n,"info",ogt,ot(n)),n.type=e,n}return $(e,t),e.prototype.onLoaded=function(){L$(zpt[cgt[this.type].toLowerCase()](this.info),this)},e}(w$),agt.PrimitiveType=cgt,rgt=lt((igt=sgt).prototype,"type",[egt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cgt.BOX}}),ogt=lt(igt.prototype,"info",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),ngt=igt))||ngt));u.Primitive=dgt,u.primitives=zpt;var _gt,mgt,vgt=(_gt=function(t,e){return(_gt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}_gt(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});!function(t){var e,n,i,r=function(){function t(t,e,n){if(null==t)throw new Error("name cannot be null.");if(null==e)throw new Error("timelines cannot be null.");this.name=t,this.timelines=e,this.timelineIds=[];for(var i=0;i<e.length;i++)this.timelineIds[e[i].getPropertyId()]=!0;this.duration=n}return t.prototype.hasTimeline=function(t){return 1==this.timelineIds[t]},t.prototype.apply=function(t,e,n,i,r,o,a,s){if(null==t)throw new Error("skeleton cannot be null.");i&&0!=this.duration&&(n%=this.duration,e>0&&(e%=this.duration));for(var c=this.timelines,l=0,u=c.length;l<u;l++)c[l].apply(t,e,n,r,o,a,s)},t.binarySearch=function(t,e,n){void 0===n&&(n=1);var i=0,r=t.length/n-2;if(0==r)return n;for(var o=r>>>1;;){if(t[(o+1)*n]<=e?i=o+1:r=o,i==r)return(i+1)*n;o=i+r>>>1}},t.linearSearch=function(t,e,n){for(var i=0,r=t.length-n;i<=r;i+=n)if(t[i]>e)return i;return-1},t}();t.Animation=r,function(t){t[t.setup=0]="setup",t[t.first=1]="first",t[t.replace=2]="replace",t[t.add=3]="add"}(e=t.MixBlend||(t.MixBlend={})),function(t){t[t.mixIn=0]="mixIn",t[t.mixOut=1]="mixOut"}(n=t.MixDirection||(t.MixDirection={})),function(t){t[t.rotate=0]="rotate",t[t.translate=1]="translate",t[t.scale=2]="scale",t[t.shear=3]="shear",t[t.attachment=4]="attachment",t[t.color=5]="color",t[t.deform=6]="deform",t[t.event=7]="event",t[t.drawOrder=8]="drawOrder",t[t.ikConstraint=9]="ikConstraint",t[t.transformConstraint=10]="transformConstraint",t[t.pathConstraintPosition=11]="pathConstraintPosition",t[t.pathConstraintSpacing=12]="pathConstraintSpacing",t[t.pathConstraintMix=13]="pathConstraintMix",t[t.twoColor=14]="twoColor"}(i=t.TimelineType||(t.TimelineType={}));var o=function(){function e(n){if(n<=0)throw new Error("frameCount must be > 0: "+n);this.curves=t.Utils.newFloatArray((n-1)*e.BEZIER_SIZE)}return e.prototype.getFrameCount=function(){return this.curves.length/e.BEZIER_SIZE+1},e.prototype.setLinear=function(t){this.curves[t*e.BEZIER_SIZE]=e.LINEAR},e.prototype.setStepped=function(t){this.curves[t*e.BEZIER_SIZE]=e.STEPPED},e.prototype.getCurveType=function(t){var n=t*e.BEZIER_SIZE;if(n==this.curves.length)return e.LINEAR;var i=this.curves[n];return i==e.LINEAR?e.LINEAR:i==e.STEPPED?e.STEPPED:e.BEZIER},e.prototype.setCurve=function(t,n,i,r,o){var a=.03*(2*-n+r),s=.03*(2*-i+o),c=.006*(3*(n-r)+1),l=.006*(3*(i-o)+1),u=2*a+c,h=2*s+l,f=.3*n+a+.16666667*c,p=.3*i+s+.16666667*l,d=t*e.BEZIER_SIZE,_=this.curves;_[d++]=e.BEZIER;for(var m=f,v=p,g=d+e.BEZIER_SIZE-1;d<g;d+=2)_[d]=m,_[d+1]=v,f+=u,p+=h,u+=c,h+=l,m+=f,v+=p},e.prototype.getCurvePercent=function(n,i){i=t.MathUtils.clamp(i,0,1);var r=this.curves,o=n*e.BEZIER_SIZE,a=r[o];if(a==e.LINEAR)return i;if(a==e.STEPPED)return 0;for(var s=0,c=++o,l=o+e.BEZIER_SIZE-1;o<l;o+=2)if((s=r[o])>=i){var u=void 0,h=void 0;return o==c?(u=0,h=0):(u=r[o-2],h=r[o-1]),h+(r[o+1]-h)*(i-u)/(s-u)}var f=r[o-1];return f+(1-f)*(i-s)/(1-s)},e.LINEAR=0,e.STEPPED=1,e.BEZIER=2,e.BEZIER_SIZE=19,e}();t.CurveTimeline=o;var a=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e<<1),i}return vgt(o,n),o.prototype.getPropertyId=function(){return(i.rotate<<24)+this.boneIndex},o.prototype.setFrame=function(t,e,n){t<<=1,this.frames[t]=e,this.frames[t+o.ROTATION]=n},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.bones[this.boneIndex];if(u.active)if(i<l[0])switch(c){case e.setup:return void(u.rotation=u.data.rotation);case e.first:var h=u.data.rotation-u.rotation;u.rotation+=(h-360*(16384-(16384.499999999996-h/360|0)))*s}else if(i>=l[l.length-o.ENTRIES]){var f=l[l.length+o.PREV_ROTATION];switch(c){case e.setup:u.rotation=u.data.rotation+f*s;break;case e.first:case e.replace:f+=u.data.rotation-u.rotation,f-=360*(16384-(16384.499999999996-f/360|0));case e.add:u.rotation+=f*s}}else{var p=r.binarySearch(l,i,o.ENTRIES),d=l[p+o.PREV_ROTATION],_=l[p],m=this.getCurvePercent((p>>1)-1,1-(i-_)/(l[p+o.PREV_TIME]-_)),v=l[p+o.ROTATION]-d;switch(v=d+(v-360*(16384-(16384.499999999996-v/360|0)))*m,c){case e.setup:u.rotation=u.data.rotation+(v-360*(16384-(16384.499999999996-v/360|0)))*s;break;case e.first:case e.replace:v+=u.data.rotation-u.rotation;case e.add:u.rotation+=(v-360*(16384-(16384.499999999996-v/360|0)))*s}}},o.ENTRIES=2,o.PREV_TIME=-2,o.PREV_ROTATION=-1,o.ROTATION=1,o}(o);t.RotateTimeline=a;var s=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return vgt(o,n),o.prototype.getPropertyId=function(){return(i.translate<<24)+this.boneIndex},o.prototype.setFrame=function(t,e,n,i){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.X]=n,this.frames[t+o.Y]=i},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.bones[this.boneIndex];if(u.active)if(i<l[0])switch(c){case e.setup:return u.x=u.data.x,void(u.y=u.data.y);case e.first:u.x+=(u.data.x-u.x)*s,u.y+=(u.data.y-u.y)*s}else{var h=0,f=0;if(i>=l[l.length-o.ENTRIES])h=l[l.length+o.PREV_X],f=l[l.length+o.PREV_Y];else{var p=r.binarySearch(l,i,o.ENTRIES);h=l[p+o.PREV_X],f=l[p+o.PREV_Y];var d=l[p],_=this.getCurvePercent(p/o.ENTRIES-1,1-(i-d)/(l[p+o.PREV_TIME]-d));h+=(l[p+o.X]-h)*_,f+=(l[p+o.Y]-f)*_}switch(c){case e.setup:u.x=u.data.x+h*s,u.y=u.data.y+f*s;break;case e.first:case e.replace:u.x+=(u.data.x+h-u.x)*s,u.y+=(u.data.y+f-u.y)*s;break;case e.add:u.x+=h*s,u.y+=f*s}}},o.ENTRIES=3,o.PREV_TIME=-3,o.PREV_X=-2,o.PREV_Y=-1,o.X=1,o.Y=2,o}(o);t.TranslateTimeline=s;var c=function(o){function a(t){return o.call(this,t)||this}return vgt(a,o),a.prototype.getPropertyId=function(){return(i.scale<<24)+this.boneIndex},a.prototype.apply=function(i,o,s,c,l,u,h){var f=this.frames,p=i.bones[this.boneIndex];if(p.active)if(s<f[0])switch(u){case e.setup:return p.scaleX=p.data.scaleX,void(p.scaleY=p.data.scaleY);case e.first:p.scaleX+=(p.data.scaleX-p.scaleX)*l,p.scaleY+=(p.data.scaleY-p.scaleY)*l}else{var d=0,_=0;if(s>=f[f.length-a.ENTRIES])d=f[f.length+a.PREV_X]*p.data.scaleX,_=f[f.length+a.PREV_Y]*p.data.scaleY;else{var m=r.binarySearch(f,s,a.ENTRIES);d=f[m+a.PREV_X],_=f[m+a.PREV_Y];var v=f[m],g=this.getCurvePercent(m/a.ENTRIES-1,1-(s-v)/(f[m+a.PREV_TIME]-v));d=(d+(f[m+a.X]-d)*g)*p.data.scaleX,_=(_+(f[m+a.Y]-_)*g)*p.data.scaleY}if(1==l)u==e.add?(p.scaleX+=d-p.data.scaleX,p.scaleY+=_-p.data.scaleY):(p.scaleX=d,p.scaleY=_);else{var y=0,x=0;if(h==n.mixOut)switch(u){case e.setup:y=p.data.scaleX,x=p.data.scaleY,p.scaleX=y+(Math.abs(d)*t.MathUtils.signum(y)-y)*l,p.scaleY=x+(Math.abs(_)*t.MathUtils.signum(x)-x)*l;break;case e.first:case e.replace:y=p.scaleX,x=p.scaleY,p.scaleX=y+(Math.abs(d)*t.MathUtils.signum(y)-y)*l,p.scaleY=x+(Math.abs(_)*t.MathUtils.signum(x)-x)*l;break;case e.add:y=p.scaleX,x=p.scaleY,p.scaleX=y+(Math.abs(d)*t.MathUtils.signum(y)-p.data.scaleX)*l,p.scaleY=x+(Math.abs(_)*t.MathUtils.signum(x)-p.data.scaleY)*l}else switch(u){case e.setup:y=Math.abs(p.data.scaleX)*t.MathUtils.signum(d),x=Math.abs(p.data.scaleY)*t.MathUtils.signum(_),p.scaleX=y+(d-y)*l,p.scaleY=x+(_-x)*l;break;case e.first:case e.replace:y=Math.abs(p.scaleX)*t.MathUtils.signum(d),x=Math.abs(p.scaleY)*t.MathUtils.signum(_),p.scaleX=y+(d-y)*l,p.scaleY=x+(_-x)*l;break;case e.add:y=t.MathUtils.signum(d),x=t.MathUtils.signum(_),p.scaleX=Math.abs(p.scaleX)*y+(d-Math.abs(p.data.scaleX)*y)*l,p.scaleY=Math.abs(p.scaleY)*x+(_-Math.abs(p.data.scaleY)*x)*l}}}},a}(s);t.ScaleTimeline=c;var l=function(t){function n(e){return t.call(this,e)||this}return vgt(n,t),n.prototype.getPropertyId=function(){return(i.shear<<24)+this.boneIndex},n.prototype.apply=function(t,i,o,a,s,c){var l=this.frames,u=t.bones[this.boneIndex];if(u.active)if(o<l[0])switch(c){case e.setup:return u.shearX=u.data.shearX,void(u.shearY=u.data.shearY);case e.first:u.shearX+=(u.data.shearX-u.shearX)*s,u.shearY+=(u.data.shearY-u.shearY)*s}else{var h=0,f=0;if(o>=l[l.length-n.ENTRIES])h=l[l.length+n.PREV_X],f=l[l.length+n.PREV_Y];else{var p=r.binarySearch(l,o,n.ENTRIES);h=l[p+n.PREV_X],f=l[p+n.PREV_Y];var d=l[p],_=this.getCurvePercent(p/n.ENTRIES-1,1-(o-d)/(l[p+n.PREV_TIME]-d));h+=(l[p+n.X]-h)*_,f+=(l[p+n.Y]-f)*_}switch(c){case e.setup:u.shearX=u.data.shearX+h*s,u.shearY=u.data.shearY+f*s;break;case e.first:case e.replace:u.shearX+=(u.data.shearX+h-u.shearX)*s,u.shearY+=(u.data.shearY+f-u.shearY)*s;break;case e.add:u.shearX+=h*s,u.shearY+=f*s}}},n}(s);t.ShearTimeline=l;var u=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return vgt(o,n),o.prototype.getPropertyId=function(){return(i.color<<24)+this.slotIndex},o.prototype.setFrame=function(t,e,n,i,r,a){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.R]=n,this.frames[t+o.G]=i,this.frames[t+o.B]=r,this.frames[t+o.A]=a},o.prototype.apply=function(t,n,i,a,s,c){var l=t.slots[this.slotIndex];if(l.bone.active){var u=this.frames;if(i<u[0])switch(c){case e.setup:return void l.color.setFromColor(l.data.color);case e.first:var h=l.color,f=l.data.color;h.add((f.r-h.r)*s,(f.g-h.g)*s,(f.b-h.b)*s,(f.a-h.a)*s)}else{var p=0,d=0,_=0,m=0;if(i>=u[u.length-o.ENTRIES]){var v=u.length;p=u[v+o.PREV_R],d=u[v+o.PREV_G],_=u[v+o.PREV_B],m=u[v+o.PREV_A]}else{var g=r.binarySearch(u,i,o.ENTRIES);p=u[g+o.PREV_R],d=u[g+o.PREV_G],_=u[g+o.PREV_B],m=u[g+o.PREV_A];var y=u[g],x=this.getCurvePercent(g/o.ENTRIES-1,1-(i-y)/(u[g+o.PREV_TIME]-y));p+=(u[g+o.R]-p)*x,d+=(u[g+o.G]-d)*x,_+=(u[g+o.B]-_)*x,m+=(u[g+o.A]-m)*x}1==s?l.color.set(p,d,_,m):(h=l.color,c==e.setup&&h.setFromColor(l.data.color),h.add((p-h.r)*s,(d-h.g)*s,(_-h.b)*s,(m-h.a)*s))}}},o.ENTRIES=5,o.PREV_TIME=-5,o.PREV_R=-4,o.PREV_G=-3,o.PREV_B=-2,o.PREV_A=-1,o.R=1,o.G=2,o.B=3,o.A=4,o}(o);t.ColorTimeline=u;var h=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return vgt(o,n),o.prototype.getPropertyId=function(){return(i.twoColor<<24)+this.slotIndex},o.prototype.setFrame=function(t,e,n,i,r,a,s,c,l){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.R]=n,this.frames[t+o.G]=i,this.frames[t+o.B]=r,this.frames[t+o.A]=a,this.frames[t+o.R2]=s,this.frames[t+o.G2]=c,this.frames[t+o.B2]=l},o.prototype.apply=function(t,n,i,a,s,c){var l=t.slots[this.slotIndex];if(l.bone.active){var u=this.frames;if(i<u[0])switch(c){case e.setup:return l.color.setFromColor(l.data.color),void l.darkColor.setFromColor(l.data.darkColor);case e.first:var h=l.color,f=l.darkColor,p=l.data.color,d=l.data.darkColor;h.add((p.r-h.r)*s,(p.g-h.g)*s,(p.b-h.b)*s,(p.a-h.a)*s),f.add((d.r-f.r)*s,(d.g-f.g)*s,(d.b-f.b)*s,0)}else{var _=0,m=0,v=0,g=0,y=0,x=0,S=0;if(i>=u[u.length-o.ENTRIES]){var T=u.length;_=u[T+o.PREV_R],m=u[T+o.PREV_G],v=u[T+o.PREV_B],g=u[T+o.PREV_A],y=u[T+o.PREV_R2],x=u[T+o.PREV_G2],S=u[T+o.PREV_B2]}else{var E=r.binarySearch(u,i,o.ENTRIES);_=u[E+o.PREV_R],m=u[E+o.PREV_G],v=u[E+o.PREV_B],g=u[E+o.PREV_A],y=u[E+o.PREV_R2],x=u[E+o.PREV_G2],S=u[E+o.PREV_B2];var b=u[E],C=this.getCurvePercent(E/o.ENTRIES-1,1-(i-b)/(u[E+o.PREV_TIME]-b));_+=(u[E+o.R]-_)*C,m+=(u[E+o.G]-m)*C,v+=(u[E+o.B]-v)*C,g+=(u[E+o.A]-g)*C,y+=(u[E+o.R2]-y)*C,x+=(u[E+o.G2]-x)*C,S+=(u[E+o.B2]-S)*C}1==s?(l.color.set(_,m,v,g),l.darkColor.set(y,x,S,1)):(h=l.color,f=l.darkColor,c==e.setup&&(h.setFromColor(l.data.color),f.setFromColor(l.data.darkColor)),h.add((_-h.r)*s,(m-h.g)*s,(v-h.b)*s,(g-h.a)*s),f.add((y-f.r)*s,(x-f.g)*s,(S-f.b)*s,0))}}},o.ENTRIES=8,o.PREV_TIME=-8,o.PREV_R=-7,o.PREV_G=-6,o.PREV_B=-5,o.PREV_A=-4,o.PREV_R2=-3,o.PREV_G2=-2,o.PREV_B2=-1,o.R=1,o.G=2,o.B=3,o.A=4,o.R2=5,o.G2=6,o.B2=7,o}(o);t.TwoColorTimeline=h;var f=function(){function o(e){this.frames=t.Utils.newFloatArray(e),this.attachmentNames=new Array(e)}return o.prototype.getPropertyId=function(){return(i.attachment<<24)+this.slotIndex},o.prototype.getFrameCount=function(){return this.frames.length},o.prototype.setFrame=function(t,e,n){this.frames[t]=e,this.attachmentNames[t]=n},o.prototype.apply=function(t,i,o,a,s,c,l){var u=t.slots[this.slotIndex];if(u.bone.active)if(l!=n.mixOut||c!=e.setup){var h=this.frames;if(o<h[0]){if(c==e.setup||c==e.first){var f=u.data.attachmentName;u.setAttachment(null==f?null:t.getAttachment(this.slotIndex,f))}}else{var p;p=o>=h[h.length-1]?h.length-1:r.binarySearch(h,o,1)-1;var d=this.attachmentNames[p];t.slots[this.slotIndex].setAttachment(null==d?null:t.getAttachment(this.slotIndex,d))}}else{var _=u.data.attachmentName;u.setAttachment(null==_?null:t.getAttachment(this.slotIndex,_))}},o}();t.AttachmentTimeline=f;var p=null,d=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e),i.frameVertices=new Array(e),null==p&&(p=t.Utils.newFloatArray(64)),i}return vgt(o,n),o.prototype.getPropertyId=function(){return(i.deform<<27)+ +this.attachment.id+this.slotIndex},o.prototype.setFrame=function(t,e,n){this.frames[t]=e,this.frameVertices[t]=n},o.prototype.apply=function(n,i,o,a,s,c){var l=n.slots[this.slotIndex];if(l.bone.active){var u=l.getAttachment();if(u instanceof t.VertexAttachment&&u.deformAttachment==this.attachment){var h=l.deform;0==h.length&&(c=e.setup);var f=this.frameVertices,p=f[0].length,d=this.frames;if(o<d[0]){var _=u;switch(c){case e.setup:return void(h.length=0);case e.first:if(1==s){h.length=0;break}var m=t.Utils.setArraySize(h,p);if(null==_.bones)for(var v=_.vertices,g=0;g<p;g++)m[g]+=(v[g]-m[g])*s;else for(s=1-s,g=0;g<p;g++)m[g]*=s}}else{var y=t.Utils.setArraySize(h,p);if(o>=d[d.length-1]){var x=f[d.length-1];if(1==s)if(c==e.add)if(null==(_=u).bones){v=_.vertices;for(var S=0;S<p;S++)y[S]+=x[S]-v[S]}else for(var T=0;T<p;T++)y[T]+=x[T];else t.Utils.arrayCopy(x,0,y,0,p);else switch(c){case e.setup:var E=u;if(null==E.bones){v=E.vertices;for(var b=0;b<p;b++){var C=v[b];y[b]=C+(x[b]-C)*s}}else for(var A=0;A<p;A++)y[A]=x[A]*s;break;case e.first:case e.replace:for(var w=0;w<p;w++)y[w]+=(x[w]-y[w])*s;case e.add:if(null==(_=u).bones){v=_.vertices;for(var R=0;R<p;R++)y[R]+=(x[R]-v[R])*s}else for(var P=0;P<p;P++)y[P]+=x[P]*s}}else{var I=r.binarySearch(d,o),M=f[I-1],D=f[I],O=d[I],N=this.getCurvePercent(I-1,1-(o-O)/(d[I-1]-O));if(1==s)if(c==e.add)if(null==(_=u).bones){v=_.vertices;for(var L=0;L<p;L++){var B=M[L];y[L]+=B+(D[L]-B)*N-v[L]}}else for(var F=0;F<p;F++)B=M[F],y[F]+=B+(D[F]-B)*N;else for(var z=0;z<p;z++)B=M[z],y[z]=B+(D[z]-B)*N;else switch(c){case e.setup:var k=u;if(null==k.bones){v=k.vertices;for(var U=0;U<p;U++)B=M[U],C=v[U],y[U]=C+(B+(D[U]-B)*N-C)*s}else for(var G=0;G<p;G++)B=M[G],y[G]=(B+(D[G]-B)*N)*s;break;case e.first:case e.replace:for(var H=0;H<p;H++)B=M[H],y[H]+=(B+(D[H]-B)*N-y[H])*s;break;case e.add:if(null==(_=u).bones){v=_.vertices;for(var V=0;V<p;V++)B=M[V],y[V]+=(B+(D[V]-B)*N-v[V])*s}else for(var W=0;W<p;W++)B=M[W],y[W]+=(B+(D[W]-B)*N)*s}}}}}},o}(o);t.DeformTimeline=d;var _=function(){function e(e){this.frames=t.Utils.newFloatArray(e),this.events=new Array(e)}return e.prototype.getPropertyId=function(){return i.event<<24},e.prototype.getFrameCount=function(){return this.frames.length},e.prototype.setFrame=function(t,e){this.frames[t]=e.time,this.events[t]=e},e.prototype.apply=function(t,e,n,i,o,a,s){if(null!=i){var c=this.frames,l=this.frames.length;if(e>n)this.apply(t,e,Number.MAX_VALUE,i,o,a,s),e=-1;else if(e>=c[l-1])return;if(!(n<c[0])){var u=0;if(e<c[0])u=0;else for(var h=c[u=r.binarySearch(c,e)];u>0&&c[u-1]==h;)u--;for(;u<l&&n>=c[u];u++)i.push(this.events[u])}}},e}();t.EventTimeline=_;var m=function(){function o(e){this.frames=t.Utils.newFloatArray(e),this.drawOrders=new Array(e)}return o.prototype.getPropertyId=function(){return i.drawOrder<<24},o.prototype.getFrameCount=function(){return this.frames.length},o.prototype.setFrame=function(t,e,n){this.frames[t]=e,this.drawOrders[t]=n},o.prototype.apply=function(i,o,a,s,c,l,u){var h=i.drawOrder,f=i.slots;if(u!=n.mixOut||l!=e.setup){var p=this.frames;if(a<p[0])l!=e.setup&&l!=e.first||t.Utils.arrayCopy(i.slots,0,i.drawOrder,0,i.slots.length);else{var d;d=a>=p[p.length-1]?p.length-1:r.binarySearch(p,a)-1;var _=this.drawOrders[d];if(null==_)t.Utils.arrayCopy(f,0,h,0,f.length);else for(var m=0,v=_.length;m<v;m++)h[m]=f[_[m]]}}else t.Utils.arrayCopy(i.slots,0,i.drawOrder,0,i.slots.length)},o}();t.DrawOrderTimeline=m;var v=function(o){function a(e){var n=o.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*a.ENTRIES),n}return vgt(a,o),a.prototype.getPropertyId=function(){return(i.ikConstraint<<24)+this.ikConstraintIndex},a.prototype.setFrame=function(t,e,n,i,r,o,s){t*=a.ENTRIES,this.frames[t]=e,this.frames[t+a.MIX]=n,this.frames[t+a.SOFTNESS]=i,this.frames[t+a.BEND_DIRECTION]=r,this.frames[t+a.COMPRESS]=o?1:0,this.frames[t+a.STRETCH]=s?1:0},a.prototype.apply=function(t,i,o,s,c,l,u){var h=this.frames,f=t.ikConstraints[this.ikConstraintIndex];if(f.active)if(o<h[0])switch(l){case e.setup:return f.mix=f.data.mix,f.softness=f.data.softness,f.bendDirection=f.data.bendDirection,f.compress=f.data.compress,void(f.stretch=f.data.stretch);case e.first:f.mix+=(f.data.mix-f.mix)*c,f.softness+=(f.data.softness-f.softness)*c,f.bendDirection=f.data.bendDirection,f.compress=f.data.compress,f.stretch=f.data.stretch}else if(o>=h[h.length-a.ENTRIES])l==e.setup?(f.mix=f.data.mix+(h[h.length+a.PREV_MIX]-f.data.mix)*c,f.softness=f.data.softness+(h[h.length+a.PREV_SOFTNESS]-f.data.softness)*c,u==n.mixOut?(f.bendDirection=f.data.bendDirection,f.compress=f.data.compress,f.stretch=f.data.stretch):(f.bendDirection=h[h.length+a.PREV_BEND_DIRECTION],f.compress=0!=h[h.length+a.PREV_COMPRESS],f.stretch=0!=h[h.length+a.PREV_STRETCH])):(f.mix+=(h[h.length+a.PREV_MIX]-f.mix)*c,f.softness+=(h[h.length+a.PREV_SOFTNESS]-f.softness)*c,u==n.mixIn&&(f.bendDirection=h[h.length+a.PREV_BEND_DIRECTION],f.compress=0!=h[h.length+a.PREV_COMPRESS],f.stretch=0!=h[h.length+a.PREV_STRETCH]));else{var p=r.binarySearch(h,o,a.ENTRIES),d=h[p+a.PREV_MIX],_=h[p+a.PREV_SOFTNESS],m=h[p],v=this.getCurvePercent(p/a.ENTRIES-1,1-(o-m)/(h[p+a.PREV_TIME]-m));l==e.setup?(f.mix=f.data.mix+(d+(h[p+a.MIX]-d)*v-f.data.mix)*c,f.softness=f.data.softness+(_+(h[p+a.SOFTNESS]-_)*v-f.data.softness)*c,u==n.mixOut?(f.bendDirection=f.data.bendDirection,f.compress=f.data.compress,f.stretch=f.data.stretch):(f.bendDirection=h[p+a.PREV_BEND_DIRECTION],f.compress=0!=h[p+a.PREV_COMPRESS],f.stretch=0!=h[p+a.PREV_STRETCH])):(f.mix+=(d+(h[p+a.MIX]-d)*v-f.mix)*c,f.softness+=(_+(h[p+a.SOFTNESS]-_)*v-f.softness)*c,u==n.mixIn&&(f.bendDirection=h[p+a.PREV_BEND_DIRECTION],f.compress=0!=h[p+a.PREV_COMPRESS],f.stretch=0!=h[p+a.PREV_STRETCH]))}},a.ENTRIES=6,a.PREV_TIME=-6,a.PREV_MIX=-5,a.PREV_SOFTNESS=-4,a.PREV_BEND_DIRECTION=-3,a.PREV_COMPRESS=-2,a.PREV_STRETCH=-1,a.MIX=1,a.SOFTNESS=2,a.BEND_DIRECTION=3,a.COMPRESS=4,a.STRETCH=5,a}(o);t.IkConstraintTimeline=v;var g=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return vgt(o,n),o.prototype.getPropertyId=function(){return(i.transformConstraint<<24)+this.transformConstraintIndex},o.prototype.setFrame=function(t,e,n,i,r,a){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.ROTATE]=n,this.frames[t+o.TRANSLATE]=i,this.frames[t+o.SCALE]=r,this.frames[t+o.SHEAR]=a},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.transformConstraints[this.transformConstraintIndex];if(u.active)if(i<l[0]){var h=u.data;switch(c){case e.setup:return u.rotateMix=h.rotateMix,u.translateMix=h.translateMix,u.scaleMix=h.scaleMix,void(u.shearMix=h.shearMix);case e.first:u.rotateMix+=(h.rotateMix-u.rotateMix)*s,u.translateMix+=(h.translateMix-u.translateMix)*s,u.scaleMix+=(h.scaleMix-u.scaleMix)*s,u.shearMix+=(h.shearMix-u.shearMix)*s}}else{var f=0,p=0,d=0,_=0;if(i>=l[l.length-o.ENTRIES]){var m=l.length;f=l[m+o.PREV_ROTATE],p=l[m+o.PREV_TRANSLATE],d=l[m+o.PREV_SCALE],_=l[m+o.PREV_SHEAR]}else{var v=r.binarySearch(l,i,o.ENTRIES);f=l[v+o.PREV_ROTATE],p=l[v+o.PREV_TRANSLATE],d=l[v+o.PREV_SCALE],_=l[v+o.PREV_SHEAR];var g=l[v],y=this.getCurvePercent(v/o.ENTRIES-1,1-(i-g)/(l[v+o.PREV_TIME]-g));f+=(l[v+o.ROTATE]-f)*y,p+=(l[v+o.TRANSLATE]-p)*y,d+=(l[v+o.SCALE]-d)*y,_+=(l[v+o.SHEAR]-_)*y}c==e.setup?(h=u.data,u.rotateMix=h.rotateMix+(f-h.rotateMix)*s,u.translateMix=h.translateMix+(p-h.translateMix)*s,u.scaleMix=h.scaleMix+(d-h.scaleMix)*s,u.shearMix=h.shearMix+(_-h.shearMix)*s):(u.rotateMix+=(f-u.rotateMix)*s,u.translateMix+=(p-u.translateMix)*s,u.scaleMix+=(d-u.scaleMix)*s,u.shearMix+=(_-u.shearMix)*s)}},o.ENTRIES=5,o.PREV_TIME=-5,o.PREV_ROTATE=-4,o.PREV_TRANSLATE=-3,o.PREV_SCALE=-2,o.PREV_SHEAR=-1,o.ROTATE=1,o.TRANSLATE=2,o.SCALE=3,o.SHEAR=4,o}(o);t.TransformConstraintTimeline=g;var y=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return vgt(o,n),o.prototype.getPropertyId=function(){return(i.pathConstraintPosition<<24)+this.pathConstraintIndex},o.prototype.setFrame=function(t,e,n){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.VALUE]=n},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.pathConstraints[this.pathConstraintIndex];if(u.active)if(i<l[0])switch(c){case e.setup:return void(u.position=u.data.position);case e.first:u.position+=(u.data.position-u.position)*s}else{var h=0;if(i>=l[l.length-o.ENTRIES])h=l[l.length+o.PREV_VALUE];else{var f=r.binarySearch(l,i,o.ENTRIES);h=l[f+o.PREV_VALUE];var p=l[f],d=this.getCurvePercent(f/o.ENTRIES-1,1-(i-p)/(l[f+o.PREV_TIME]-p));h+=(l[f+o.VALUE]-h)*d}c==e.setup?u.position=u.data.position+(h-u.data.position)*s:u.position+=(h-u.position)*s}},o.ENTRIES=2,o.PREV_TIME=-2,o.PREV_VALUE=-1,o.VALUE=1,o}(o);t.PathConstraintPositionTimeline=y;var x=function(t){function n(e){return t.call(this,e)||this}return vgt(n,t),n.prototype.getPropertyId=function(){return(i.pathConstraintSpacing<<24)+this.pathConstraintIndex},n.prototype.apply=function(t,i,o,a,s,c){var l=this.frames,u=t.pathConstraints[this.pathConstraintIndex];if(u.active)if(o<l[0])switch(c){case e.setup:return void(u.spacing=u.data.spacing);case e.first:u.spacing+=(u.data.spacing-u.spacing)*s}else{var h=0;if(o>=l[l.length-n.ENTRIES])h=l[l.length+n.PREV_VALUE];else{var f=r.binarySearch(l,o,n.ENTRIES);h=l[f+n.PREV_VALUE];var p=l[f],d=this.getCurvePercent(f/n.ENTRIES-1,1-(o-p)/(l[f+n.PREV_TIME]-p));h+=(l[f+n.VALUE]-h)*d}c==e.setup?u.spacing=u.data.spacing+(h-u.data.spacing)*s:u.spacing+=(h-u.spacing)*s}},n}(y);t.PathConstraintSpacingTimeline=x;var S=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return vgt(o,n),o.prototype.getPropertyId=function(){return(i.pathConstraintMix<<24)+this.pathConstraintIndex},o.prototype.setFrame=function(t,e,n,i){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.ROTATE]=n,this.frames[t+o.TRANSLATE]=i},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.pathConstraints[this.pathConstraintIndex];if(u.active)if(i<l[0])switch(c){case e.setup:return u.rotateMix=u.data.rotateMix,void(u.translateMix=u.data.translateMix);case e.first:u.rotateMix+=(u.data.rotateMix-u.rotateMix)*s,u.translateMix+=(u.data.translateMix-u.translateMix)*s}else{var h=0,f=0;if(i>=l[l.length-o.ENTRIES])h=l[l.length+o.PREV_ROTATE],f=l[l.length+o.PREV_TRANSLATE];else{var p=r.binarySearch(l,i,o.ENTRIES);h=l[p+o.PREV_ROTATE],f=l[p+o.PREV_TRANSLATE];var d=l[p],_=this.getCurvePercent(p/o.ENTRIES-1,1-(i-d)/(l[p+o.PREV_TIME]-d));h+=(l[p+o.ROTATE]-h)*_,f+=(l[p+o.TRANSLATE]-f)*_}c==e.setup?(u.rotateMix=u.data.rotateMix+(h-u.data.rotateMix)*s,u.translateMix=u.data.translateMix+(f-u.data.translateMix)*s):(u.rotateMix+=(h-u.rotateMix)*s,u.translateMix+=(f-u.translateMix)*s)}},o.ENTRIES=3,o.PREV_TIME=-3,o.PREV_ROTATE=-2,o.PREV_TRANSLATE=-1,o.ROTATE=1,o.TRANSLATE=2,o}(o);t.PathConstraintMixTimeline=S}(mgt||(mgt={})),function(t){var e=function(){function e(e){this.tracks=new Array,this.timeScale=1,this.events=new Array,this.listeners=new Array,this.queue=new r(this),this.propertyIDs=new t.IntSet,this.animationsChanged=!1,this.trackEntryPool=new t.Pool((function(){return new n})),this.data=e}return e.prototype.update=function(t){t*=this.timeScale;for(var e=this.tracks,n=0,i=e.length;n<i;n++){var r=e[n];if(null!=r){r.animationLast=r.nextAnimationLast,r.trackLast=r.nextTrackLast;var o=t*r.timeScale;if(r.delay>0){if(r.delay-=o,r.delay>0)continue;o=-r.delay,r.delay=0}var a=r.next;if(null!=a){var s=r.trackLast-a.delay;if(s>=0){for(a.delay=0,a.trackTime+=0==r.timeScale?0:(s/r.timeScale+t)*a.timeScale,r.trackTime+=o,this.setCurrent(n,a,!0);null!=a.mixingFrom;)a.mixTime+=t,a=a.mixingFrom;continue}}else if(r.trackLast>=r.trackEnd&&null==r.mixingFrom){e[n]=null,this.queue.end(r),this.disposeNext(r);continue}if(null!=r.mixingFrom&&this.updateMixingFrom(r,t)){var c=r.mixingFrom;for(r.mixingFrom=null,null!=c&&(c.mixingTo=null);null!=c;)this.queue.end(c),c=c.mixingFrom}r.trackTime+=o}}this.queue.drain()},e.prototype.updateMixingFrom=function(t,e){var n=t.mixingFrom;if(null==n)return!0;var i=this.updateMixingFrom(n,e);return n.animationLast=n.nextAnimationLast,n.trackLast=n.nextTrackLast,t.mixTime>0&&t.mixTime>=t.mixDuration?(0!=n.totalAlpha&&0!=t.mixDuration||(t.mixingFrom=n.mixingFrom,null!=n.mixingFrom&&(n.mixingFrom.mixingTo=t),t.interruptAlpha=n.interruptAlpha,this.queue.end(n)),i):(n.trackTime+=e*n.timeScale,t.mixTime+=e,!1)},e.prototype.apply=function(n){if(null==n)throw new Error("skeleton cannot be null.");this.animationsChanged&&this._animationsChanged();for(var i=this.events,r=this.tracks,o=!1,a=0,s=r.length;a<s;a++){var c=r[a];if(!(null==c||c.delay>0)){o=!0;var l=0==a?t.MixBlend.first:c.mixBlend,u=c.alpha;null!=c.mixingFrom?u*=this.applyMixingFrom(c,n,l):c.trackTime>=c.trackEnd&&null==c.next&&(u=0);var h=c.animationLast,f=c.getAnimationTime(),p=c.animation.timelines.length,d=c.animation.timelines;if(0==a&&1==u||l==t.MixBlend.add)for(var _=0;_<p;_++)t.Utils.webkit602BugfixHelper(u,l),d[_].apply(n,h,f,i,u,l,t.MixDirection.mixIn);else{var m=c.timelineMode,v=0==c.timelinesRotation.length;v&&t.Utils.setArraySize(c.timelinesRotation,p<<1,null);var g=c.timelinesRotation;for(_=0;_<p;_++){var y=d[_],x=(m[_]&e.NOT_LAST-1)==e.SUBSEQUENT?l:t.MixBlend.setup;y instanceof t.RotateTimeline?this.applyRotateTimeline(y,n,f,u,x,g,_<<1,v):(t.Utils.webkit602BugfixHelper(u,l),y.apply(n,h,f,i,u,x,t.MixDirection.mixIn))}}this.queueEvents(c,f),i.length=0,c.nextAnimationLast=f,c.nextTrackLast=c.trackTime}}return this.queue.drain(),o},e.prototype.applyMixingFrom=function(n,i,r){var o=n.mixingFrom;null!=o.mixingFrom&&this.applyMixingFrom(o,i,r);var a=0;0==n.mixDuration?(a=1,r==t.MixBlend.first&&(r=t.MixBlend.setup)):((a=n.mixTime/n.mixDuration)>1&&(a=1),r!=t.MixBlend.first&&(r=o.mixBlend));var s=a<o.eventThreshold?this.events:null,c=a<o.attachmentThreshold,l=a<o.drawOrderThreshold,u=o.animationLast,h=o.getAnimationTime(),f=o.animation.timelines.length,p=o.animation.timelines,d=o.alpha*n.interruptAlpha,_=d*(1-a);if(r==t.MixBlend.add)for(var m=0;m<f;m++)p[m].apply(i,u,h,s,_,r,t.MixDirection.mixOut);else{var v=o.timelineMode,g=o.timelineHoldMix,y=0==o.timelinesRotation.length;y&&t.Utils.setArraySize(o.timelinesRotation,f<<1,null);var x=o.timelinesRotation;for(o.totalAlpha=0,m=0;m<f;m++){var S=p[m],T=t.MixDirection.mixOut,E=void 0,b=0;switch(v[m]&e.NOT_LAST-1){case e.SUBSEQUENT:if(E=r,!c&&S instanceof t.AttachmentTimeline){if((v[m]&e.NOT_LAST)==e.NOT_LAST)continue;E=t.MixBlend.setup}if(!l&&S instanceof t.DrawOrderTimeline)continue;b=_;break;case e.FIRST:E=t.MixBlend.setup,b=_;break;case e.HOLD:E=t.MixBlend.setup,b=d;break;default:E=t.MixBlend.setup;var C=g[m];b=d*Math.max(0,1-C.mixTime/C.mixDuration)}o.totalAlpha+=b,S instanceof t.RotateTimeline?this.applyRotateTimeline(S,i,h,b,E,x,m<<1,y):(t.Utils.webkit602BugfixHelper(b,r),E==t.MixBlend.setup&&(S instanceof t.AttachmentTimeline?(c||(v[m]&e.NOT_LAST)==e.NOT_LAST)&&(T=t.MixDirection.mixIn):S instanceof t.DrawOrderTimeline&&l&&(T=t.MixDirection.mixIn)),S.apply(i,u,h,s,b,E,T))}}return n.mixDuration>0&&this.queueEvents(o,h),this.events.length=0,o.nextAnimationLast=h,o.nextTrackLast=o.trackTime,a},e.prototype.applyRotateTimeline=function(e,n,i,r,o,a,s,c){if(c&&(a[s]=0),1!=r){var l=e,u=l.frames,h=n.bones[l.boneIndex];if(h.active){var f=0,p=0;if(i<u[0])switch(o){case t.MixBlend.setup:h.rotation=h.data.rotation;default:return;case t.MixBlend.first:f=h.rotation,p=h.data.rotation}else if(f=o==t.MixBlend.setup?h.data.rotation:h.rotation,i>=u[u.length-t.RotateTimeline.ENTRIES])p=h.data.rotation+u[u.length+t.RotateTimeline.PREV_ROTATION];else{var d=t.Animation.binarySearch(u,i,t.RotateTimeline.ENTRIES),_=u[d+t.RotateTimeline.PREV_ROTATION],m=u[d],v=l.getCurvePercent((d>>1)-1,1-(i-m)/(u[d+t.RotateTimeline.PREV_TIME]-m));p=u[d+t.RotateTimeline.ROTATION]-_,p=_+(p-=360*(16384-(16384.499999999996-p/360|0)))*v+h.data.rotation,p-=360*(16384-(16384.499999999996-p/360|0))}var g=0,y=p-f;if(0==(y-=360*(16384-(16384.499999999996-y/360|0))))g=a[s];else{var x=0,S=0;c?(x=0,S=y):(x=a[s],S=a[s+1]);var T=y>0,E=x>=0;t.MathUtils.signum(S)!=t.MathUtils.signum(y)&&Math.abs(S)<=90&&(Math.abs(x)>180&&(x+=360*t.MathUtils.signum(x)),E=T),g=y+x-x%360,E!=T&&(g+=360*t.MathUtils.signum(x)),a[s]=g}a[s+1]=y,f+=g*r,h.rotation=f-360*(16384-(16384.499999999996-f/360|0))}}else e.apply(n,0,i,null,1,o,t.MixDirection.mixIn)},e.prototype.queueEvents=function(t,e){for(var n=t.animationStart,i=t.animationEnd,r=i-n,o=t.trackLast%r,a=this.events,s=0,c=a.length;s<c;s++){var l=a[s];if(l.time<o)break;l.time>i||this.queue.event(t,l)}for((t.loop?0==r||o>t.trackTime%r:e>=i&&t.animationLast<i)&&this.queue.complete(t);s<c;s++)a[s].time<n||this.queue.event(t,a[s])},e.prototype.clearTracks=function(){var t=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var e=0,n=this.tracks.length;e<n;e++)this.clearTrack(e);this.tracks.length=0,this.queue.drainDisabled=t,this.queue.drain()},e.prototype.clearTrack=function(t){if(!(t>=this.tracks.length)){var e=this.tracks[t];if(null!=e){this.queue.end(e),this.disposeNext(e);for(var n=e;;){var i=n.mixingFrom;if(null==i)break;this.queue.end(i),n.mixingFrom=null,n.mixingTo=null,n=i}this.tracks[e.trackIndex]=null,this.queue.drain()}}},e.prototype.setCurrent=function(t,e,n){var i=this.expandToIndex(t);this.tracks[t]=e,null!=i&&(n&&this.queue.interrupt(i),e.mixingFrom=i,i.mixingTo=e,e.mixTime=0,null!=i.mixingFrom&&i.mixDuration>0&&(e.interruptAlpha*=Math.min(1,i.mixTime/i.mixDuration)),i.timelinesRotation.length=0),this.queue.start(e)},e.prototype.setAnimation=function(t,e,n){var i=this.data.skeletonData.findAnimation(e);if(null==i)throw new Error("Animation not found: "+e);return this.setAnimationWith(t,i,n)},e.prototype.setAnimationWith=function(t,e,n){if(null==e)throw new Error("animation cannot be null.");var i=!0,r=this.expandToIndex(t);null!=r&&(-1==r.nextTrackLast?(this.tracks[t]=r.mixingFrom,this.queue.interrupt(r),this.queue.end(r),this.disposeNext(r),r=r.mixingFrom,i=!1):this.disposeNext(r));var o=this.trackEntry(t,e,n,r);return this.setCurrent(t,o,i),this.queue.drain(),o},e.prototype.addAnimation=function(t,e,n,i){var r=this.data.skeletonData.findAnimation(e);if(null==r)throw new Error("Animation not found: "+e);return this.addAnimationWith(t,r,n,i)},e.prototype.addAnimationWith=function(t,e,n,i){if(null==e)throw new Error("animation cannot be null.");var r=this.expandToIndex(t);if(null!=r)for(;null!=r.next;)r=r.next;var o=this.trackEntry(t,e,n,r);if(null==r)this.setCurrent(t,o,!0),this.queue.drain();else if(r.next=o,i<=0){var a=r.animationEnd-r.animationStart;0!=a?(r.loop?i+=a*(1+(r.trackTime/a|0)):i+=Math.max(a,r.trackTime),i-=this.data.getMix(r.animation,e)):i=r.trackTime}return o.delay=i,o},e.prototype.setEmptyAnimation=function(t,n){var i=this.setAnimationWith(t,e.emptyAnimation,!1);return i.mixDuration=n,i.trackEnd=n,i},e.prototype.addEmptyAnimation=function(t,n,i){i<=0&&(i-=n);var r=this.addAnimationWith(t,e.emptyAnimation,!1,i);return r.mixDuration=n,r.trackEnd=n,r},e.prototype.setEmptyAnimations=function(t){var e=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var n=0,i=this.tracks.length;n<i;n++){var r=this.tracks[n];null!=r&&this.setEmptyAnimation(r.trackIndex,t)}this.queue.drainDisabled=e,this.queue.drain()},e.prototype.expandToIndex=function(e){return e<this.tracks.length?this.tracks[e]:(t.Utils.ensureArrayCapacity(this.tracks,e+1,null),this.tracks.length=e+1,null)},e.prototype.trackEntry=function(t,e,n,i){var r=this.trackEntryPool.obtain();return r.trackIndex=t,r.animation=e,r.loop=n,r.holdPrevious=!1,r.eventThreshold=0,r.attachmentThreshold=0,r.drawOrderThreshold=0,r.animationStart=0,r.animationEnd=e.duration,r.animationLast=-1,r.nextAnimationLast=-1,r.delay=0,r.trackTime=0,r.trackLast=-1,r.nextTrackLast=-1,r.trackEnd=Number.MAX_VALUE,r.timeScale=1,r.alpha=1,r.interruptAlpha=1,r.mixTime=0,r.mixDuration=null==i?0:this.data.getMix(i.animation,e),r},e.prototype.disposeNext=function(t){for(var e=t.next;null!=e;)this.queue.dispose(e),e=e.next;t.next=null},e.prototype._animationsChanged=function(){this.animationsChanged=!1,this.propertyIDs.clear();for(var e=0,n=this.tracks.length;e<n;e++)if(null!=(i=this.tracks[e])){for(;null!=i.mixingFrom;)i=i.mixingFrom;do{null!=i.mixingFrom&&i.mixBlend==t.MixBlend.add||this.computeHold(i),i=i.mixingTo}while(null!=i)}for(this.propertyIDs.clear(),e=this.tracks.length-1;e>=0;e--)for(var i=this.tracks[e];null!=i;)this.computeNotLast(i),i=i.mixingFrom},e.prototype.computeHold=function(n){var i=n.mixingTo,r=n.animation.timelines,o=n.animation.timelines.length,a=t.Utils.setArraySize(n.timelineMode,o);n.timelineHoldMix.length=0;var s=t.Utils.setArraySize(n.timelineHoldMix,o),c=this.propertyIDs;if(null!=i&&i.holdPrevious)for(var l=0;l<o;l++)c.add(r[l].getPropertyId()),a[l]=e.HOLD;else t:for(l=0;l<o;l++){var u=r[l],h=u.getPropertyId();if(c.add(h))if(null==i||u instanceof t.AttachmentTimeline||u instanceof t.DrawOrderTimeline||u instanceof t.EventTimeline||!i.animation.hasTimeline(h))a[l]=e.FIRST;else{for(var f=i.mixingTo;null!=f;f=f.mixingTo)if(!f.animation.hasTimeline(h)){if(n.mixDuration>0){a[l]=e.HOLD_MIX,s[l]=f;continue t}break}a[l]=e.HOLD}else a[l]=e.SUBSEQUENT}},e.prototype.computeNotLast=function(n){for(var i=n.animation.timelines,r=n.animation.timelines.length,o=n.timelineMode,a=this.propertyIDs,s=0;s<r;s++)if(i[s]instanceof t.AttachmentTimeline){var c=i[s];a.add(c.slotIndex)||(o[s]|=e.NOT_LAST)}},e.prototype.getCurrent=function(t){return t>=this.tracks.length?null:this.tracks[t]},e.prototype.addListener=function(t){if(null==t)throw new Error("listener cannot be null.");this.listeners.push(t)},e.prototype.removeListener=function(t){var e=this.listeners.indexOf(t);e>=0&&this.listeners.splice(e,1)},e.prototype.clearListeners=function(){this.listeners.length=0},e.prototype.clearListenerNotifications=function(){this.queue.clear()},e.emptyAnimation=new t.Animation("<empty>",[],0),e.SUBSEQUENT=0,e.FIRST=1,e.HOLD=2,e.HOLD_MIX=3,e.NOT_LAST=4,e}();t.AnimationState=e;var n=function(){function e(){this.mixBlend=t.MixBlend.replace,this.timelineMode=new Array,this.timelineHoldMix=new Array,this.timelinesRotation=new Array}return e.prototype.reset=function(){this.next=null,this.mixingFrom=null,this.mixingTo=null,this.animation=null,this.listener=null,this.timelineMode.length=0,this.timelineHoldMix.length=0,this.timelinesRotation.length=0},e.prototype.getAnimationTime=function(){if(this.loop){var t=this.animationEnd-this.animationStart;return 0==t?this.animationStart:this.trackTime%t+this.animationStart}return Math.min(this.trackTime+this.animationStart,this.animationEnd)},e.prototype.setAnimationLast=function(t){this.animationLast=t,this.nextAnimationLast=t},e.prototype.isComplete=function(){return this.trackTime>=this.animationEnd-this.animationStart},e.prototype.resetRotationDirections=function(){this.timelinesRotation.length=0},e}();t.TrackEntry=n;var i,r=function(){function t(t){this.objects=[],this.drainDisabled=!1,this.animState=t}return t.prototype.start=function(t){this.objects.push(i.start),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.interrupt=function(t){this.objects.push(i.interrupt),this.objects.push(t)},t.prototype.end=function(t){this.objects.push(i.end),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.dispose=function(t){this.objects.push(i.dispose),this.objects.push(t)},t.prototype.complete=function(t){this.objects.push(i.complete),this.objects.push(t)},t.prototype.event=function(t,e){this.objects.push(i.event),this.objects.push(t),this.objects.push(e)},t.prototype.drain=function(){if(!this.drainDisabled){this.drainDisabled=!0;for(var t=this.objects,e=this.animState.listeners,n=0;n<t.length;n+=2){var r=t[n],o=t[n+1];switch(r){case i.start:null!=o.listener&&o.listener.start&&o.listener.start(o);for(var a=0;a<e.length;a++)e[a].start&&e[a].start(o);break;case i.interrupt:for(null!=o.listener&&o.listener.interrupt&&o.listener.interrupt(o),a=0;a<e.length;a++)e[a].interrupt&&e[a].interrupt(o);break;case i.end:for(null!=o.listener&&o.listener.end&&o.listener.end(o),a=0;a<e.length;a++)e[a].end&&e[a].end(o);case i.dispose:for(null!=o.listener&&o.listener.dispose&&o.listener.dispose(o),a=0;a<e.length;a++)e[a].dispose&&e[a].dispose(o);this.animState.trackEntryPool.free(o);break;case i.complete:for(null!=o.listener&&o.listener.complete&&o.listener.complete(o),a=0;a<e.length;a++)e[a].complete&&e[a].complete(o);break;case i.event:var s=t[2+n++];for(null!=o.listener&&o.listener.event&&o.listener.event(o,s),a=0;a<e.length;a++)e[a].event&&e[a].event(o,s)}}this.clear(),this.drainDisabled=!1}},t.prototype.clear=function(){this.objects.length=0},t}();t.EventQueue=r,function(t){t[t.start=0]="start",t[t.interrupt=1]="interrupt",t[t.end=2]="end",t[t.dispose=3]="dispose",t[t.complete=4]="complete",t[t.event=5]="event"}(i=t.EventType||(t.EventType={}));var o=function(){function t(){}return t.prototype.start=function(){},t.prototype.interrupt=function(){},t.prototype.end=function(){},t.prototype.dispose=function(){},t.prototype.complete=function(){},t.prototype.event=function(){},t}();t.AnimationStateAdapter=o}(mgt||(mgt={})),function(t){var e=function(){function t(t){if(this.animationToMixTime={},this.defaultMix=0,null==t)throw new Error("skeletonData cannot be null.");this.skeletonData=t}return t.prototype.setMix=function(t,e,n){var i=this.skeletonData.findAnimation(t);if(null==i)throw new Error("Animation not found: "+t);var r=this.skeletonData.findAnimation(e);if(null==r)throw new Error("Animation not found: "+e);this.setMixWith(i,r,n)},t.prototype.setMixWith=function(t,e,n){if(null==t)throw new Error("from cannot be null.");if(null==e)throw new Error("to cannot be null.");var i=t.name+"."+e.name;this.animationToMixTime[i]=n},t.prototype.getMix=function(t,e){var n=t.name+"."+e.name,i=this.animationToMixTime[n];return void 0===i?this.defaultMix:i},t}();t.AnimationStateData=e}(mgt||(mgt={})),function(t){var e=function(){function e(t,e){void 0===e&&(e=""),this.assets={},this.errors={},this.toLoad=0,this.loaded=0,this.textureLoader=t,this.pathPrefix=e}return e.downloadText=function(t,e,n){var i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){200==i.status?e(i.responseText):n(i.status,i.responseText)},i.onerror=function(){n(i.status,i.responseText)},i.send()},e.downloadBinary=function(t,e,n){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){200==i.status?e(new Uint8Array(i.response)):n(i.status,i.responseText)},i.onerror=function(){n(i.status,i.responseText)},i.send()},e.prototype.loadBinary=function(t,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=null),t=this.pathPrefix+t,this.toLoad++,e.downloadBinary(t,(function(e){r.assets[t]=e,n&&n(t,e),r.toLoad--,r.loaded++}),(function(e,n){r.errors[t]="Couldn't load binary "+t+": status "+status+", "+n,i&&i(t,"Couldn't load binary "+t+": status "+status+", "+n),r.toLoad--,r.loaded++}))},e.prototype.loadText=function(t,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=null),t=this.pathPrefix+t,this.toLoad++,e.downloadText(t,(function(e){r.assets[t]=e,n&&n(t,e),r.toLoad--,r.loaded++}),(function(e,n){r.errors[t]="Couldn't load text "+t+": status "+status+", "+n,i&&i(t,"Couldn't load text "+t+": status "+status+", "+n),r.toLoad--,r.loaded++}))},e.prototype.loadTexture=function(t,e,n){var i=this;void 0===e&&(e=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++;var r=new Image;r.crossOrigin="anonymous",r.onload=function(){var n=i.textureLoader(r);i.assets[t]=n,i.toLoad--,i.loaded++,e&&e(t,r)},r.onerror=function(){i.errors[t]="Couldn't load image "+t,i.toLoad--,i.loaded++,n&&n(t,"Couldn't load image "+t)},r.src=t},e.prototype.loadTextureData=function(t,e,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=null),t=this.pathPrefix+t,this.toLoad++;var o=new Image;o.onload=function(){var e=r.textureLoader(o);r.assets[t]=e,r.toLoad--,r.loaded++,n&&n(t,o)},o.onerror=function(){r.errors[t]="Couldn't load image "+t,r.toLoad--,r.loaded++,i&&i(t,"Couldn't load image "+t)},o.src=e},e.prototype.loadTextureAtlas=function(n,i,r){var o=this;void 0===i&&(i=null),void 0===r&&(r=null);var a=n.lastIndexOf("/")>=0?n.substring(0,n.lastIndexOf("/")):"";n=this.pathPrefix+n,this.toLoad++,e.downloadText(n,(function(e){var s={count:0},c=new Array;try{new t.TextureAtlas(e,(function(e){c.push(a+"/"+e);var n=document.createElement("img");return n.width=16,n.height=16,new t.FakeTexture(n)}))}catch(t){var l=t;return o.errors[n]="Couldn't load texture atlas "+n+": "+l.message,r&&r(n,"Couldn't load texture atlas "+n+": "+l.message),o.toLoad--,void o.loaded++}for(var u=function(l){var u=!1;o.loadTexture(l,(function(l){if(s.count++,s.count==c.length)if(u)o.errors[n]="Couldn't load texture atlas page "+l+"} of atlas "+n,r&&r(n,"Couldn't load texture atlas page "+l+" of atlas "+n),o.toLoad--,o.loaded++;else try{var h=new t.TextureAtlas(e,(function(t){return o.get(a+"/"+t)}));o.assets[n]=h,i&&i(n,h),o.toLoad--,o.loaded++}catch(t){var f=t;o.errors[n]="Couldn't load texture atlas "+n+": "+f.message,r&&r(n,"Couldn't load texture atlas "+n+": "+f.message),o.toLoad--,o.loaded++}}),(function(t){u=!0,s.count++,s.count==c.length&&(o.errors[n]="Couldn't load texture atlas page "+t+"} of atlas "+n,r&&r(n,"Couldn't load texture atlas page "+t+" of atlas "+n),o.toLoad--,o.loaded++)}))},h=0,f=c;h<f.length;h++)u(f[h])}),(function(t,e){o.errors[n]="Couldn't load texture atlas "+n+": status "+status+", "+e,r&&r(n,"Couldn't load texture atlas "+n+": status "+status+", "+e),o.toLoad--,o.loaded++}))},e.prototype.get=function(t){return t=this.pathPrefix+t,this.assets[t]},e.prototype.remove=function(t){t=this.pathPrefix+t;var e=this.assets[t];e.dispose&&e.dispose(),this.assets[t]=null},e.prototype.removeAll=function(){for(var t in this.assets){var e=this.assets[t];e.dispose&&e.dispose()}this.assets={}},e.prototype.isLoadingComplete=function(){return 0==this.toLoad},e.prototype.getToLoad=function(){return this.toLoad},e.prototype.getLoaded=function(){return this.loaded},e.prototype.dispose=function(){this.removeAll()},e.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},e.prototype.getErrors=function(){return this.errors},e}();t.AssetManager=e}(mgt||(mgt={})),function(t){var e=function(){function e(t){this.atlas=t}return e.prototype.newRegionAttachment=function(e,n,i){var r=this.atlas.findRegion(i);if(null==r)return null;r.renderObject=r;var o=new t.RegionAttachment(n);return o.setRegion(r),o},e.prototype.newMeshAttachment=function(e,n,i){var r=this.atlas.findRegion(i);if(null==r)return null;r.renderObject=r;var o=new t.MeshAttachment(n);return o.region=r,o},e.prototype.newBoundingBoxAttachment=function(e,n){return new t.BoundingBoxAttachment(n)},e.prototype.newPathAttachment=function(e,n){return new t.PathAttachment(n)},e.prototype.newPointAttachment=function(e,n){return new t.PointAttachment(n)},e.prototype.newClippingAttachment=function(e,n){return new t.ClippingAttachment(n)},e}();t.AtlasAttachmentLoader=e}(mgt||(mgt={})),function(t){var e;(e=t.BlendMode||(t.BlendMode={}))[e.Normal=0]="Normal",e[e.Additive=1]="Additive",e[e.Multiply=2]="Multiply",e[e.Screen=3]="Screen"}(mgt||(mgt={})),function(t){var e=function(){function e(t,e,n){if(this.children=new Array,this.x=0,this.y=0,this.rotation=0,this.scaleX=0,this.scaleY=0,this.shearX=0,this.shearY=0,this.ax=0,this.ay=0,this.arotation=0,this.ascaleX=0,this.ascaleY=0,this.ashearX=0,this.ashearY=0,this.appliedValid=!1,this.a=0,this.b=0,this.c=0,this.d=0,this.worldY=0,this.worldX=0,this.sorted=!1,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.skeleton=e,this.parent=n,this.setToSetupPose()}return e.prototype.isActive=function(){return this.active},e.prototype.update=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransform=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransformWith=function(e,n,i,r,o,a,s){this.ax=e,this.ay=n,this.arotation=i,this.ascaleX=r,this.ascaleY=o,this.ashearX=a,this.ashearY=s,this.appliedValid=!0;var c=this.parent;if(null==c){var l=this.skeleton,u=i+90+s,h=l.scaleX,f=l.scaleY;return this.a=t.MathUtils.cosDeg(i+a)*r*h,this.b=t.MathUtils.cosDeg(u)*o*h,this.c=t.MathUtils.sinDeg(i+a)*r*f,this.d=t.MathUtils.sinDeg(u)*o*f,this.worldX=e*h+l.x,void(this.worldY=n*f+l.y)}var p=c.a,d=c.b,_=c.c,m=c.d;switch(this.worldX=p*e+d*n+c.worldX,this.worldY=_*e+m*n+c.worldY,this.data.transformMode){case t.TransformMode.Normal:u=i+90+s;var v=t.MathUtils.cosDeg(i+a)*r,g=t.MathUtils.cosDeg(u)*o,y=t.MathUtils.sinDeg(i+a)*r,x=t.MathUtils.sinDeg(u)*o;return this.a=p*v+d*y,this.b=p*g+d*x,this.c=_*v+m*y,void(this.d=_*g+m*x);case t.TransformMode.OnlyTranslation:u=i+90+s,this.a=t.MathUtils.cosDeg(i+a)*r,this.b=t.MathUtils.cosDeg(u)*o,this.c=t.MathUtils.sinDeg(i+a)*r,this.d=t.MathUtils.sinDeg(u)*o;break;case t.TransformMode.NoRotationOrReflection:var S=0;(b=p*p+_*_)>1e-4?(d=_*(b=Math.abs(p*m-d*_)/b),m=p*b,S=Math.atan2(_,p)*t.MathUtils.radDeg):(p=0,_=0,S=90-Math.atan2(m,d)*t.MathUtils.radDeg);var T=i+a-S,E=i+s-S+90;v=t.MathUtils.cosDeg(T)*r,g=t.MathUtils.cosDeg(E)*o,y=t.MathUtils.sinDeg(T)*r,x=t.MathUtils.sinDeg(E)*o,this.a=p*v-d*y,this.b=p*g-d*x,this.c=_*v+m*y,this.d=_*g+m*x;break;case t.TransformMode.NoScale:case t.TransformMode.NoScaleOrReflection:var b,C=t.MathUtils.cosDeg(i),A=t.MathUtils.sinDeg(i),w=(p*C+d*A)/this.skeleton.scaleX,R=(_*C+m*A)/this.skeleton.scaleY;(b=Math.sqrt(w*w+R*R))>1e-5&&(b=1/b),w*=b,R*=b,b=Math.sqrt(w*w+R*R),this.data.transformMode==t.TransformMode.NoScale&&p*m-d*_<0!=(this.skeleton.scaleX<0!=this.skeleton.scaleY<0)&&(b=-b);var P=Math.PI/2+Math.atan2(R,w),I=Math.cos(P)*b,M=Math.sin(P)*b;v=t.MathUtils.cosDeg(a)*r,g=t.MathUtils.cosDeg(90+s)*o,y=t.MathUtils.sinDeg(a)*r,x=t.MathUtils.sinDeg(90+s)*o,this.a=w*v+I*y,this.b=w*g+I*x,this.c=R*v+M*y,this.d=R*g+M*x}this.a*=this.skeleton.scaleX,this.b*=this.skeleton.scaleX,this.c*=this.skeleton.scaleY,this.d*=this.skeleton.scaleY},e.prototype.setToSetupPose=function(){var t=this.data;this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.shearX=t.shearX,this.shearY=t.shearY},e.prototype.getWorldRotationX=function(){return Math.atan2(this.c,this.a)*t.MathUtils.radDeg},e.prototype.getWorldRotationY=function(){return Math.atan2(this.d,this.b)*t.MathUtils.radDeg},e.prototype.getWorldScaleX=function(){return Math.sqrt(this.a*this.a+this.c*this.c)},e.prototype.getWorldScaleY=function(){return Math.sqrt(this.b*this.b+this.d*this.d)},e.prototype.updateAppliedTransform=function(){this.appliedValid=!0;var e=this.parent;if(null==e)return this.ax=this.worldX,this.ay=this.worldY,this.arotation=Math.atan2(this.c,this.a)*t.MathUtils.radDeg,this.ascaleX=Math.sqrt(this.a*this.a+this.c*this.c),this.ascaleY=Math.sqrt(this.b*this.b+this.d*this.d),this.ashearX=0,void(this.ashearY=Math.atan2(this.a*this.b+this.c*this.d,this.a*this.d-this.b*this.c)*t.MathUtils.radDeg);var n=e.a,i=e.b,r=e.c,o=e.d,a=1/(n*o-i*r),s=this.worldX-e.worldX,c=this.worldY-e.worldY;this.ax=s*o*a-c*i*a,this.ay=c*n*a-s*r*a;var l=a*o,u=a*n,h=a*i,f=a*r,p=l*this.a-h*this.c,d=l*this.b-h*this.d,_=u*this.c-f*this.a,m=u*this.d-f*this.b;if(this.ashearX=0,this.ascaleX=Math.sqrt(p*p+_*_),this.ascaleX>1e-4){var v=p*m-d*_;this.ascaleY=v/this.ascaleX,this.ashearY=Math.atan2(p*d+_*m,v)*t.MathUtils.radDeg,this.arotation=Math.atan2(_,p)*t.MathUtils.radDeg}else this.ascaleX=0,this.ascaleY=Math.sqrt(d*d+m*m),this.ashearY=0,this.arotation=90-Math.atan2(m,d)*t.MathUtils.radDeg},e.prototype.worldToLocal=function(t){var e=this.a,n=this.b,i=this.c,r=this.d,o=1/(e*r-n*i),a=t.x-this.worldX,s=t.y-this.worldY;return t.x=a*r*o-s*n*o,t.y=s*e*o-a*i*o,t},e.prototype.localToWorld=function(t){var e=t.x,n=t.y;return t.x=e*this.a+n*this.b+this.worldX,t.y=e*this.c+n*this.d+this.worldY,t},e.prototype.worldToLocalRotation=function(e){var n=t.MathUtils.sinDeg(e),i=t.MathUtils.cosDeg(e);return Math.atan2(this.a*n-this.c*i,this.d*i-this.b*n)*t.MathUtils.radDeg+this.rotation-this.shearX},e.prototype.localToWorldRotation=function(e){e-=this.rotation-this.shearX;var n=t.MathUtils.sinDeg(e),i=t.MathUtils.cosDeg(e);return Math.atan2(i*this.c+n*this.d,i*this.a+n*this.b)*t.MathUtils.radDeg},e.prototype.rotateWorld=function(e){var n=this.a,i=this.b,r=this.c,o=this.d,a=t.MathUtils.cosDeg(e),s=t.MathUtils.sinDeg(e);this.a=a*n-s*r,this.b=a*i-s*o,this.c=s*n+a*r,this.d=s*i+a*o,this.appliedValid=!1},e}();t.Bone=e}(mgt||(mgt={})),function(t){var e;t.BoneData=function(n,i,r){if(this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.shearX=0,this.shearY=0,this.transformMode=e.Normal,this.skinRequired=!1,this.color=new t.Color,n<0)throw new Error("index must be >= 0.");if(null==i)throw new Error("name cannot be null.");this.index=n,this.name=i,this.parent=r},function(t){t[t.Normal=0]="Normal",t[t.OnlyTranslation=1]="OnlyTranslation",t[t.NoRotationOrReflection=2]="NoRotationOrReflection",t[t.NoScale=3]="NoScale",t[t.NoScaleOrReflection=4]="NoScaleOrReflection"}(e=t.TransformMode||(t.TransformMode={}))}(mgt||(mgt={})),function(t){t.ConstraintData=function(t,e,n){this.name=t,this.order=e,this.skinRequired=n}}(mgt||(mgt={})),function(t){t.Event=function(t,e){if(null==e)throw new Error("data cannot be null.");this.time=t,this.data=e}}(mgt||(mgt={})),function(t){t.EventData=function(t){this.name=t}}(mgt||(mgt={})),function(t){var e=function(){function e(t,e){if(this.bendDirection=0,this.compress=!1,this.stretch=!1,this.mix=1,this.softness=0,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.mix=t.mix,this.softness=t.softness,this.bendDirection=t.bendDirection,this.compress=t.compress,this.stretch=t.stretch,this.bones=new Array;for(var n=0;n<t.bones.length;n++)this.bones.push(e.findBone(t.bones[n].name));this.target=e.findBone(t.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var t=this.target,e=this.bones;switch(e.length){case 1:this.apply1(e[0],t.worldX,t.worldY,this.compress,this.stretch,this.data.uniform,this.mix);break;case 2:this.apply2(e[0],e[1],t.worldX,t.worldY,this.bendDirection,this.stretch,this.softness,this.mix)}},e.prototype.apply1=function(e,n,i,r,o,a,s){e.appliedValid||e.updateAppliedTransform();var c=e.parent,l=1/(c.a*c.d-c.b*c.c),u=n-c.worldX,h=i-c.worldY,f=(u*c.d-h*c.b)*l-e.ax,p=(h*c.a-u*c.c)*l-e.ay,d=Math.atan2(p,f)*t.MathUtils.radDeg-e.ashearX-e.arotation;e.ascaleX<0&&(d+=180),d>180?d-=360:d<-180&&(d+=360);var _=e.ascaleX,m=e.ascaleY;if(r||o){var v=e.data.length*_,g=Math.sqrt(f*f+p*p);if(r&&g<v||o&&g>v&&v>1e-4){var y=(g/v-1)*s+1;_*=y,a&&(m*=y)}}e.updateWorldTransformWith(e.ax,e.ay,e.arotation+d*s,_,m,e.ashearX,e.ashearY)},e.prototype.apply2=function(e,n,i,r,o,a,s,c){if(0!=c){e.appliedValid||e.updateAppliedTransform(),n.appliedValid||n.updateAppliedTransform();var l=e.ax,u=e.ay,h=e.ascaleX,f=h,p=e.ascaleY,d=n.ascaleX,_=0,m=0,v=0;h<0?(h=-h,_=180,v=-1):(_=0,v=1),p<0&&(p=-p,v=-v),d<0?(d=-d,m=180):m=0;var g=n.ax,y=0,x=0,S=0,T=e.a,E=e.b,b=e.c,C=e.d,A=Math.abs(h-p)<=1e-4;A?(x=T*g+E*(y=n.ay)+e.worldX,S=b*g+C*y+e.worldY):(y=0,x=T*g+e.worldX,S=b*g+e.worldY);var w=e.parent;T=w.a,E=w.b,b=w.c;var R,P,I=1/(T*(C=w.d)-E*b),M=x-w.worldX,D=S-w.worldY,O=(M*C-D*E)*I-l,N=(D*T-M*b)*I-u,L=Math.sqrt(O*O+N*N),B=n.data.length*d;if(L<1e-4)return this.apply1(e,i,r,!1,a,!1,c),void n.updateWorldTransformWith(g,y,0,n.ascaleX,n.ascaleY,n.ashearX,n.ashearY);var F=((M=i-w.worldX)*C-(D=r-w.worldY)*E)*I-l,z=(D*T-M*b)*I-u,k=F*F+z*z;if(0!=s){s*=h*(d+1)/2;var U=Math.sqrt(k),G=U-L-B*h+s;if(G>0){var H=Math.min(1,G/(2*s))-1;k=(F-=(H=(G-s*(1-H*H))/U)*F)*F+(z-=H*z)*z}}t:if(A){var V=(k-L*L-(B*=h)*B)/(2*L*B);V<-1?V=-1:V>1&&(V=1,a&&(f*=(Math.sqrt(k)/(L+B)-1)*c+1)),P=Math.acos(V)*o,T=L+B*V,E=B*Math.sin(P),R=Math.atan2(z*T-F*E,F*T+z*E)}else{var W=(T=h*B)*T,j=(E=p*B)*E,q=Math.atan2(z,F),X=-2*j*L,Y=j-W;if((C=X*X-4*Y*(b=j*L*L+W*k-W*j))>=0){var K=Math.sqrt(C);X<0&&(K=-K);var Q=(K=-(X+K)/2)/Y,Z=b/K,J=Math.abs(Q)<Math.abs(Z)?Q:Z;if(J*J<=k){D=Math.sqrt(k-J*J)*o,R=q-Math.atan2(D,J),P=Math.atan2(D/p,(J-L)/h);break t}}var $=t.MathUtils.PI,tt=L-T,et=tt*tt,nt=0,it=0,rt=L+T,ot=rt*rt,at=0;(b=-T*L/(W-j))>=-1&&b<=1&&(b=Math.acos(b),(C=(M=T*Math.cos(b)+L)*M+(D=E*Math.sin(b))*D)<et&&($=b,et=C,tt=M,nt=D),C>ot&&(it=b,ot=C,rt=M,at=D)),k<=(et+ot)/2?(R=q-Math.atan2(nt*o,tt),P=$*o):(R=q-Math.atan2(at*o,rt),P=it*o)}var st=Math.atan2(y,g)*v,ct=e.arotation;(R=(R-st)*t.MathUtils.radDeg+_-ct)>180?R-=360:R<-180&&(R+=360),e.updateWorldTransformWith(l,u,ct+R*c,f,e.ascaleY,0,0),ct=n.arotation,(P=((P+st)*t.MathUtils.radDeg-n.ashearX)*v+m-ct)>180?P-=360:P<-180&&(P+=360),n.updateWorldTransformWith(g,y,ct+P*c,n.ascaleX,n.ascaleY,n.ashearX,n.ashearY)}else n.updateWorldTransform()},e}();t.IkConstraint=e}(mgt||(mgt={})),function(t){var e=function(t){function e(e){var n=t.call(this,e,0,!1)||this;return n.bones=new Array,n.bendDirection=1,n.compress=!1,n.stretch=!1,n.uniform=!1,n.mix=1,n.softness=0,n}return vgt(e,t),e}(t.ConstraintData);t.IkConstraintData=e}(mgt||(mgt={})),function(t){var e=function(){function e(t,e){if(this.position=0,this.spacing=0,this.rotateMix=0,this.translateMix=0,this.spaces=new Array,this.positions=new Array,this.world=new Array,this.curves=new Array,this.lengths=new Array,this.segments=new Array,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.bones=new Array;for(var n=0,i=t.bones.length;n<i;n++)this.bones.push(e.findBone(t.bones[n].name));this.target=e.findSlot(t.target.name),this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var n=this.target.getAttachment();if(n instanceof t.PathAttachment){var i=this.rotateMix,r=this.translateMix,o=i>0;if(r>0||o){var a=this.data,s=a.spacingMode==t.SpacingMode.Percent,c=a.rotateMode,l=c==t.RotateMode.Tangent,u=c==t.RotateMode.ChainScale,h=this.bones.length,f=l?h:h+1,p=this.bones,d=t.Utils.setArraySize(this.spaces,f),_=null,m=this.spacing;if(u||!s){u&&(_=t.Utils.setArraySize(this.lengths,h));for(var v=a.spacingMode==t.SpacingMode.Length,g=0,y=f-1;g<y;){var x=(M=p[g]).data.length;if(x<e.epsilon)u&&(_[g]=0),d[++g]=0;else if(s){if(u){var S=x*M.a,T=x*M.c,E=Math.sqrt(S*S+T*T);_[g]=E}d[++g]=m}else{S=x*M.a,T=x*M.c;var b=Math.sqrt(S*S+T*T);u&&(_[g]=b),d[++g]=(v?x+m:m)*b/x}}}else for(g=1;g<f;g++)d[g]=m;var C=this.computeWorldPositions(n,f,l,a.positionMode==t.PositionMode.Percent,s),A=C[0],w=C[1],R=a.offsetRotation,P=!1;0==R?P=c==t.RotateMode.Chain:(P=!1,R*=(I=this.target.bone).a*I.d-I.b*I.c>0?t.MathUtils.degRad:-t.MathUtils.degRad),g=0;for(var I=3;g<h;g++,I+=3){var M;(M=p[g]).worldX+=(A-M.worldX)*r,M.worldY+=(w-M.worldY)*r;var D=(S=C[I])-A,O=(T=C[I+1])-w;if(u){var N=_[g];if(0!=N){var L=(Math.sqrt(D*D+O*O)/N-1)*i+1;M.a*=L,M.c*=L}}if(A=S,w=T,o){var B=M.a,F=M.b,z=M.c,k=M.d,U=0,G=0,H=0;if(U=l?C[I-1]:0==d[g+1]?C[I+2]:Math.atan2(O,D),U-=Math.atan2(z,B),P){G=Math.cos(U),H=Math.sin(U);var V=M.data.length;A+=(V*(G*B-H*z)-D)*i,w+=(V*(H*B+G*z)-O)*i}else U+=R;U>t.MathUtils.PI?U-=t.MathUtils.PI2:U<-t.MathUtils.PI&&(U+=t.MathUtils.PI2),U*=i,G=Math.cos(U),H=Math.sin(U),M.a=G*B-H*z,M.b=G*F-H*k,M.c=H*B+G*z,M.d=H*F+G*k}M.appliedValid=!1}}}},e.prototype.computeWorldPositions=function(n,i,r,o,a){var s=this.target,c=this.position,l=this.spaces,u=t.Utils.setArraySize(this.positions,3*i+2),h=null,f=n.closed,p=n.worldVerticesLength,d=p/6,_=e.NONE;if(!n.constantSpeed){var m=n.lengths,v=m[d-=f?1:2];if(o&&(c*=v),a)for(var g=1;g<i;g++)l[g]*=v;h=t.Utils.setArraySize(this.world,8),g=0;for(var y=0,x=0;g<i;g++,y+=3){var S=c+=j=l[g];if(f)(S%=v)<0&&(S+=v),x=0;else{if(S<0){_!=e.BEFORE&&(_=e.BEFORE,n.computeWorldVertices(s,2,4,h,0,2)),this.addBeforePosition(S,h,0,u,y);continue}if(S>v){_!=e.AFTER&&(_=e.AFTER,n.computeWorldVertices(s,p-6,4,h,0,2)),this.addAfterPosition(S-v,h,0,u,y);continue}}for(;;x++){var T=m[x];if(!(S>T)){0==x?S/=T:S=(S-(K=m[x-1]))/(T-K);break}}x!=_&&(_=x,f&&x==d?(n.computeWorldVertices(s,p-4,4,h,0,2),n.computeWorldVertices(s,0,4,h,4,2)):n.computeWorldVertices(s,6*x+2,8,h,0,2)),this.addCurvePosition(S,h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],u,y,r||g>0&&0==j)}return u}f?(p+=2,h=t.Utils.setArraySize(this.world,p),n.computeWorldVertices(s,2,p-4,h,0,2),n.computeWorldVertices(s,0,2,h,p-4,2),h[p-2]=h[0],h[p-1]=h[1]):(d--,p-=4,h=t.Utils.setArraySize(this.world,p),n.computeWorldVertices(s,2,p,h,0,2));for(var E=t.Utils.setArraySize(this.curves,d),b=0,C=h[0],A=h[1],w=0,R=0,P=0,I=0,M=0,D=0,O=0,N=0,L=0,B=0,F=0,z=0,k=0,U=0,G=(g=0,2);g<d;g++,G+=6)w=h[G],R=h[G+1],P=h[G+2],I=h[G+3],F=2*(O=.1875*(C-2*w+P))+(L=.09375*(3*(w-P)-C+(M=h[G+4]))),z=2*(N=.1875*(A-2*R+I))+(B=.09375*(3*(R-I)-A+(D=h[G+5]))),k=.75*(w-C)+O+.16666667*L,U=.75*(R-A)+N+.16666667*B,b+=Math.sqrt(k*k+U*U),k+=F,U+=z,F+=L,z+=B,b+=Math.sqrt(k*k+U*U),k+=F,U+=z,b+=Math.sqrt(k*k+U*U),k+=F+L,U+=z+B,b+=Math.sqrt(k*k+U*U),E[g]=b,C=M,A=D;if(c*=o?b:b/n.lengths[d-1],a)for(g=1;g<i;g++)l[g]*=b;for(var H=this.segments,V=0,W=(g=0,y=0,x=0,0);g<i;g++,y+=3){var j;if(S=c+=j=l[g],f)(S%=b)<0&&(S+=b),x=0;else{if(S<0){this.addBeforePosition(S,h,0,u,y);continue}if(S>b){this.addAfterPosition(S-b,h,p-4,u,y);continue}}for(;;x++){var q=E[x];if(!(S>q)){0==x?S/=q:S=(S-(K=E[x-1]))/(q-K);break}}if(x!=_){_=x;var X=6*x;for(C=h[X],A=h[X+1],w=h[X+2],R=h[X+3],P=h[X+4],I=h[X+5],F=2*(O=.03*(C-2*w+P))+(L=.006*(3*(w-P)-C+(M=h[X+6]))),z=2*(N=.03*(A-2*R+I))+(B=.006*(3*(R-I)-A+(D=h[X+7]))),k=.3*(w-C)+O+.16666667*L,U=.3*(R-A)+N+.16666667*B,V=Math.sqrt(k*k+U*U),H[0]=V,X=1;X<8;X++)k+=F,U+=z,F+=L,z+=B,V+=Math.sqrt(k*k+U*U),H[X]=V;k+=F,U+=z,V+=Math.sqrt(k*k+U*U),H[8]=V,k+=F+L,U+=z+B,V+=Math.sqrt(k*k+U*U),H[9]=V,W=0}for(S*=V;;W++){var Y=H[W];if(!(S>Y)){var K;0==W?S/=Y:S=W+(S-(K=H[W-1]))/(Y-K);break}}this.addCurvePosition(.1*S,C,A,w,R,P,I,M,D,u,y,r||g>0&&0==j)}return u},e.prototype.addBeforePosition=function(t,e,n,i,r){var o=e[n],a=e[n+1],s=e[n+2]-o,c=e[n+3]-a,l=Math.atan2(c,s);i[r]=o+t*Math.cos(l),i[r+1]=a+t*Math.sin(l),i[r+2]=l},e.prototype.addAfterPosition=function(t,e,n,i,r){var o=e[n+2],a=e[n+3],s=o-e[n],c=a-e[n+1],l=Math.atan2(c,s);i[r]=o+t*Math.cos(l),i[r+1]=a+t*Math.sin(l),i[r+2]=l},e.prototype.addCurvePosition=function(t,e,n,i,r,o,a,s,c,l,u,h){if(0==t||isNaN(t))return l[u]=e,l[u+1]=n,void(l[u+2]=Math.atan2(r-n,i-e));var f=t*t,p=f*t,d=1-t,_=d*d,m=_*d,v=d*t,g=3*v,y=d*g,x=g*t,S=e*m+i*y+o*x+s*p,T=n*m+r*y+a*x+c*p;l[u]=S,l[u+1]=T,h&&(l[u+2]=t<.001?Math.atan2(r-n,i-e):Math.atan2(T-(n*_+r*v*2+a*f),S-(e*_+i*v*2+o*f)))},e.NONE=-1,e.BEFORE=-2,e.AFTER=-3,e.epsilon=1e-5,e}();t.PathConstraint=e}(mgt||(mgt={})),function(t){var e,n,i,r=function(t){function e(e){var n=t.call(this,e,0,!1)||this;return n.bones=new Array,n}return vgt(e,t),e}(t.ConstraintData);t.PathConstraintData=r,(i=t.PositionMode||(t.PositionMode={}))[i.Fixed=0]="Fixed",i[i.Percent=1]="Percent",(n=t.SpacingMode||(t.SpacingMode={}))[n.Length=0]="Length",n[n.Fixed=1]="Fixed",n[n.Percent=2]="Percent",(e=t.RotateMode||(t.RotateMode={}))[e.Tangent=0]="Tangent",e[e.Chain=1]="Chain",e[e.ChainScale=2]="ChainScale"}(mgt||(mgt={})),function(t){var e=function(){function t(t){this.toLoad=new Array,this.assets={},this.clientId=t}return t.prototype.loaded=function(){var t=0;for(var e in this.assets)t++;return t},t}(),n=function(){function t(t){void 0===t&&(t=""),this.clientAssets={},this.queuedAssets={},this.rawAssets={},this.errors={},this.pathPrefix=t}return t.prototype.queueAsset=function(t,n,i){var r=this.clientAssets[t];return null==r&&(r=new e(t),this.clientAssets[t]=r),null!==n&&(r.textureLoader=n),r.toLoad.push(i),this.queuedAssets[i]!==i&&(this.queuedAssets[i]=i,!0)},t.prototype.loadText=function(t,e){var n=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState==XMLHttpRequest.DONE&&(i.status>=200&&i.status<300?n.rawAssets[e]=i.responseText:n.errors[e]="Couldn't load text "+e+": status "+i.status+", "+i.responseText)},i.open("GET",e,!0),i.send()}},t.prototype.loadJson=function(t,e){var n=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState==XMLHttpRequest.DONE&&(i.status>=200&&i.status<300?n.rawAssets[e]=JSON.parse(i.responseText):n.errors[e]="Couldn't load text "+e+": status "+i.status+", "+i.responseText)},i.open("GET",e,!0),i.send()}},t.prototype.loadTexture=function(t,e,n){var i=this;if(n=this.pathPrefix+n,this.queueAsset(t,e,n)){var r=new Image;r.src=n,r.crossOrigin="anonymous",r.onload=function(){i.rawAssets[n]=r},r.onerror=function(){i.errors[n]="Couldn't load image "+n}}},t.prototype.get=function(t,e){e=this.pathPrefix+e;var n=this.clientAssets[t];return null==n||n.assets[e]},t.prototype.updateClientAssets=function(t){for(var e=0;e<t.toLoad.length;e++){var n=t.toLoad[e];if(null==t.assets[n]){var i=this.rawAssets[n];if(null==i)continue;i instanceof HTMLImageElement?t.assets[n]=t.textureLoader(i):t.assets[n]=i}}},t.prototype.isLoadingComplete=function(t){var e=this.clientAssets[t];return null==e||(this.updateClientAssets(e),e.toLoad.length==e.loaded())},t.prototype.dispose=function(){},t.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},t.prototype.getErrors=function(){return this.errors},t}();t.SharedAssetManager=n}(mgt||(mgt={})),function(t){var e=function(){function e(e){if(this._updateCache=new Array,this.updateCacheReset=new Array,this.time=0,this.scaleX=1,this.scaleY=1,this.x=0,this.y=0,null==e)throw new Error("data cannot be null.");this.data=e,this.bones=new Array;for(var n=0;n<e.bones.length;n++){var i=e.bones[n],r=void 0;if(null==i.parent)r=new t.Bone(i,this,null);else{var o=this.bones[i.parent.index];r=new t.Bone(i,this,o),o.children.push(r)}this.bones.push(r)}for(this.slots=new Array,this.drawOrder=new Array,n=0;n<e.slots.length;n++){var a=e.slots[n],s=(r=this.bones[a.boneData.index],new t.Slot(a,r));this.slots.push(s),this.drawOrder.push(s)}for(this.ikConstraints=new Array,n=0;n<e.ikConstraints.length;n++){var c=e.ikConstraints[n];this.ikConstraints.push(new t.IkConstraint(c,this))}for(this.transformConstraints=new Array,n=0;n<e.transformConstraints.length;n++){var l=e.transformConstraints[n];this.transformConstraints.push(new t.TransformConstraint(l,this))}for(this.pathConstraints=new Array,n=0;n<e.pathConstraints.length;n++){var u=e.pathConstraints[n];this.pathConstraints.push(new t.PathConstraint(u,this))}this.color=new t.Color(1,1,1,1),this.updateCache()}return e.prototype.updateCache=function(){this._updateCache.length=0,this.updateCacheReset.length=0;for(var t=this.bones,e=0,n=t.length;e<n;e++)(r=t[e]).sorted=r.data.skinRequired,r.active=!r.sorted;if(null!=this.skin){var i=this.skin.bones;for(e=0,n=this.skin.bones.length;e<n;e++){var r=this.bones[i[e].index];do{r.sorted=!1,r.active=!0,r=r.parent}while(null!=r)}}var o=this.ikConstraints,a=this.transformConstraints,s=this.pathConstraints,c=o.length,l=a.length,u=s.length,h=c+l+u;t:for(e=0;e<h;e++){for(var f=0;f<c;f++)if((p=o[f]).data.order==e){this.sortIkConstraint(p);continue t}for(f=0;f<l;f++)if((p=a[f]).data.order==e){this.sortTransformConstraint(p);continue t}for(f=0;f<u;f++){var p;if((p=s[f]).data.order==e){this.sortPathConstraint(p);continue t}}}for(e=0,n=t.length;e<n;e++)this.sortBone(t[e])},e.prototype.sortIkConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var n=e.target;this.sortBone(n);var i=e.bones,r=i[0];if(this.sortBone(r),i.length>1){var o=i[i.length-1];this._updateCache.indexOf(o)>-1||this.updateCacheReset.push(o)}this._updateCache.push(e),this.sortReset(r.children),i[i.length-1].sorted=!0}},e.prototype.sortPathConstraint=function(e){if(e.active=e.target.bone.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var n=e.target,i=n.data.index,r=n.bone;null!=this.skin&&this.sortPathConstraintAttachment(this.skin,i,r),null!=this.data.defaultSkin&&this.data.defaultSkin!=this.skin&&this.sortPathConstraintAttachment(this.data.defaultSkin,i,r);for(var o=0,a=this.data.skins.length;o<a;o++)this.sortPathConstraintAttachment(this.data.skins[o],i,r);var s=n.getAttachment();s instanceof t.PathAttachment&&this.sortPathConstraintAttachmentWith(s,r);var c=e.bones,l=c.length;for(o=0;o<l;o++)this.sortBone(c[o]);for(this._updateCache.push(e),o=0;o<l;o++)this.sortReset(c[o].children);for(o=0;o<l;o++)c[o].sorted=!0}},e.prototype.sortTransformConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){this.sortBone(e.target);var n=e.bones,i=n.length;if(e.data.local)for(var r=0;r<i;r++){var o=n[r];this.sortBone(o.parent),this._updateCache.indexOf(o)>-1||this.updateCacheReset.push(o)}else for(r=0;r<i;r++)this.sortBone(n[r]);this._updateCache.push(e);for(var a=0;a<i;a++)this.sortReset(n[a].children);for(a=0;a<i;a++)n[a].sorted=!0}},e.prototype.sortPathConstraintAttachment=function(t,e,n){var i=t.attachments[e];if(i)for(var r in i)this.sortPathConstraintAttachmentWith(i[r],n)},e.prototype.sortPathConstraintAttachmentWith=function(e,n){if(e instanceof t.PathAttachment){var i=e.bones;if(null==i)this.sortBone(n);else for(var r=this.bones,o=0;o<i.length;)for(var a=i[o++],s=o+a;o<s;o++){var c=i[o];this.sortBone(r[c])}}},e.prototype.sortBone=function(t){if(!t.sorted){var e=t.parent;null!=e&&this.sortBone(e),t.sorted=!0,this._updateCache.push(t)}},e.prototype.sortReset=function(t){for(var e=0,n=t.length;e<n;e++){var i=t[e];i.active&&(i.sorted&&this.sortReset(i.children),i.sorted=!1)}},e.prototype.updateWorldTransform=function(){for(var t=this.updateCacheReset,e=0,n=t.length;e<n;e++){var i=t[e];i.ax=i.x,i.ay=i.y,i.arotation=i.rotation,i.ascaleX=i.scaleX,i.ascaleY=i.scaleY,i.ashearX=i.shearX,i.ashearY=i.shearY,i.appliedValid=!0}var r=this._updateCache;for(e=0,n=r.length;e<n;e++)r[e].update()},e.prototype.setToSetupPose=function(){this.setBonesToSetupPose(),this.setSlotsToSetupPose()},e.prototype.setBonesToSetupPose=function(){for(var t=this.bones,e=0,n=t.length;e<n;e++)t[e].setToSetupPose();var i=this.ikConstraints;for(e=0,n=i.length;e<n;e++)(s=i[e]).mix=s.data.mix,s.softness=s.data.softness,s.bendDirection=s.data.bendDirection,s.compress=s.data.compress,s.stretch=s.data.stretch;var r=this.transformConstraints;for(e=0,n=r.length;e<n;e++){var o=(s=r[e]).data;s.rotateMix=o.rotateMix,s.translateMix=o.translateMix,s.scaleMix=o.scaleMix,s.shearMix=o.shearMix}var a=this.pathConstraints;for(e=0,n=a.length;e<n;e++){var s;o=(s=a[e]).data,s.position=o.position,s.spacing=o.spacing,s.rotateMix=o.rotateMix,s.translateMix=o.translateMix}},e.prototype.setSlotsToSetupPose=function(){var e=this.slots;t.Utils.arrayCopy(e,0,this.drawOrder,0,e.length);for(var n=0,i=e.length;n<i;n++)e[n].setToSetupPose()},e.prototype.getRootBone=function(){return 0==this.bones.length?null:this.bones[0]},e.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,n=0,i=e.length;n<i;n++)if(e[n].data.name==t)return n;return-1},e.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,n=0,i=e.length;n<i;n++)if(e[n].data.name==t)return n;return-1},e.prototype.setSkinByName=function(t){var e=this.data.findSkin(t);if(null==e)throw new Error("Skin not found: "+t);this.setSkin(e)},e.prototype.setSkin=function(t){if(t!=this.skin){if(null!=t)if(null!=this.skin)t.attachAll(this,this.skin);else for(var e=this.slots,n=0,i=e.length;n<i;n++){var r=e[n],o=r.data.attachmentName;if(null!=o){var a=t.getAttachment(n,o);null!=a&&r.setAttachment(a)}}this.skin=t,this.updateCache()}},e.prototype.getAttachmentByName=function(t,e){return this.getAttachment(this.data.findSlotIndex(t),e)},e.prototype.getAttachment=function(t,e){if(null==e)throw new Error("attachmentName cannot be null.");if(null!=this.skin){var n=this.skin.getAttachment(t,e);if(null!=n)return n}return null!=this.data.defaultSkin?this.data.defaultSkin.getAttachment(t,e):null},e.prototype.setAttachment=function(t,e){if(null==t)throw new Error("slotName cannot be null.");for(var n=this.slots,i=0,r=n.length;i<r;i++){var o=n[i];if(o.data.name==t){var a=null;if(null!=e&&null==(a=this.getAttachment(i,e)))throw new Error("Attachment not found: "+e+", for slot: "+t);return void o.setAttachment(a)}}throw new Error("Slot not found: "+t)},e.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.getBounds=function(e,n,i){if(void 0===i&&(i=new Array(2)),null==e)throw new Error("offset cannot be null.");if(null==n)throw new Error("size cannot be null.");for(var r=this.drawOrder,o=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=0,u=r.length;l<u;l++){var h=r[l];if(h.bone.active){var f=0,p=null,d=h.getAttachment();if(d instanceof t.RegionAttachment)f=8,p=t.Utils.setArraySize(i,f,0),d.computeWorldVertices(h.bone,p,0,2);else if(d instanceof t.MeshAttachment){var _=d;f=_.worldVerticesLength,p=t.Utils.setArraySize(i,f,0),_.computeWorldVertices(h,0,f,p,0,2)}if(null!=p)for(var m=0,v=p.length;m<v;m+=2){var g=p[m],y=p[m+1];o=Math.min(o,g),a=Math.min(a,y),s=Math.max(s,g),c=Math.max(c,y)}}}e.set(o,a),n.set(s-o,c-a)},e.prototype.update=function(t){this.time+=t},e}();t.Skeleton=e}(mgt||(mgt={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(i){var r=this.scale,o=new t.SkeletonData;o.name="";var a=new n(i);o.hash=a.readString(),o.version=a.readString(),o.x=a.readFloat(),o.y=a.readFloat(),o.width=a.readFloat(),o.height=a.readFloat();var s=a.readBoolean();s&&(o.fps=a.readFloat(),o.imagesPath=a.readString(),o.audioPath=a.readString());var c=0;c=a.readInt(!0);for(var l=0;l<c;l++)a.strings.push(a.readString());for(c=a.readInt(!0),l=0;l<c;l++){var u=a.readString(),h=0==l?null:o.bones[a.readInt(!0)];(d=new t.BoneData(l,u,h)).rotation=a.readFloat(),d.x=a.readFloat()*r,d.y=a.readFloat()*r,d.scaleX=a.readFloat(),d.scaleY=a.readFloat(),d.shearX=a.readFloat(),d.shearY=a.readFloat(),d.length=a.readFloat()*r,d.transformMode=e.TransformModeValues[a.readInt(!0)],d.skinRequired=a.readBoolean(),s&&t.Color.rgba8888ToColor(d.color,a.readInt32()),o.bones.push(d)}for(c=a.readInt(!0),l=0;l<c;l++){var f=a.readString(),p=o.bones[a.readInt(!0)],d=new t.SlotData(l,f,p);t.Color.rgba8888ToColor(d.color,a.readInt32());var _=a.readInt32();-1!=_&&t.Color.rgb888ToColor(d.darkColor=new t.Color,_),d.attachmentName=a.readStringRef(),d.blendMode=e.BlendModeValues[a.readInt(!0)],o.slots.push(d)}c=a.readInt(!0),l=0;for(var m=void 0;l<c;l++){(d=new t.IkConstraintData(a.readString())).order=a.readInt(!0),d.skinRequired=a.readBoolean(),m=a.readInt(!0);for(var v=0;v<m;v++)d.bones.push(o.bones[a.readInt(!0)]);d.target=o.bones[a.readInt(!0)],d.mix=a.readFloat(),d.softness=a.readFloat()*r,d.bendDirection=a.readByte(),d.compress=a.readBoolean(),d.stretch=a.readBoolean(),d.uniform=a.readBoolean(),o.ikConstraints.push(d)}for(c=a.readInt(!0),l=0,m=void 0;l<c;l++){for((d=new t.TransformConstraintData(a.readString())).order=a.readInt(!0),d.skinRequired=a.readBoolean(),m=a.readInt(!0),v=0;v<m;v++)d.bones.push(o.bones[a.readInt(!0)]);d.target=o.bones[a.readInt(!0)],d.local=a.readBoolean(),d.relative=a.readBoolean(),d.offsetRotation=a.readFloat(),d.offsetX=a.readFloat()*r,d.offsetY=a.readFloat()*r,d.offsetScaleX=a.readFloat(),d.offsetScaleY=a.readFloat(),d.offsetShearY=a.readFloat(),d.rotateMix=a.readFloat(),d.translateMix=a.readFloat(),d.scaleMix=a.readFloat(),d.shearMix=a.readFloat(),o.transformConstraints.push(d)}for(c=a.readInt(!0),l=0,m=void 0;l<c;l++){for((d=new t.PathConstraintData(a.readString())).order=a.readInt(!0),d.skinRequired=a.readBoolean(),m=a.readInt(!0),v=0;v<m;v++)d.bones.push(o.bones[a.readInt(!0)]);d.target=o.slots[a.readInt(!0)],d.positionMode=e.PositionModeValues[a.readInt(!0)],d.spacingMode=e.SpacingModeValues[a.readInt(!0)],d.rotateMode=e.RotateModeValues[a.readInt(!0)],d.offsetRotation=a.readFloat(),d.position=a.readFloat(),d.positionMode==t.PositionMode.Fixed&&(d.position*=r),d.spacing=a.readFloat(),d.spacingMode!=t.SpacingMode.Length&&d.spacingMode!=t.SpacingMode.Fixed||(d.spacing*=r),d.rotateMix=a.readFloat(),d.translateMix=a.readFloat(),o.pathConstraints.push(d)}var g=this.readSkin(a,o,!0,s);for(null!=g&&(o.defaultSkin=g,o.skins.push(g)),l=o.skins.length,t.Utils.setArraySize(o.skins,c=l+a.readInt(!0));l<c;l++)o.skins[l]=this.readSkin(a,o,!1,s);for(c=this.linkedMeshes.length,l=0;l<c;l++){var y=this.linkedMeshes[l],x=null==y.skin?o.defaultSkin:o.findSkin(y.skin);if(null==x)throw new Error("Skin not found: "+y.skin);var S=x.getAttachment(y.slotIndex,y.parent);if(null==S)throw new Error("Parent mesh not found: "+y.parent);y.mesh.deformAttachment=y.inheritDeform?S:y.mesh,y.mesh.setParentMesh(S),y.mesh.updateUVs()}for(this.linkedMeshes.length=0,c=a.readInt(!0),l=0;l<c;l++)(d=new t.EventData(a.readStringRef())).intValue=a.readInt(!1),d.floatValue=a.readFloat(),d.stringValue=a.readString(),d.audioPath=a.readString(),null!=d.audioPath&&(d.volume=a.readFloat(),d.balance=a.readFloat()),o.events.push(d);for(c=a.readInt(!0),l=0;l<c;l++)o.animations.push(this.readAnimation(a,a.readString(),o));return o},e.prototype.readSkin=function(e,n,i,r){var o=null,a=0;if(i){if(0==(a=e.readInt(!0)))return null;o=new t.Skin("default")}else{(o=new t.Skin(e.readStringRef())).bones.length=e.readInt(!0);for(var s=0,c=o.bones.length;s<c;s++)o.bones[s]=n.bones[e.readInt(!0)];for(s=0,c=e.readInt(!0);s<c;s++)o.constraints.push(n.ikConstraints[e.readInt(!0)]);for(s=0,c=e.readInt(!0);s<c;s++)o.constraints.push(n.transformConstraints[e.readInt(!0)]);for(s=0,c=e.readInt(!0);s<c;s++)o.constraints.push(n.pathConstraints[e.readInt(!0)]);a=e.readInt(!0)}for(s=0;s<a;s++)for(var l=e.readInt(!0),u=0,h=e.readInt(!0);u<h;u++){var f=e.readStringRef(),p=this.readAttachment(e,n,o,l,f,r);null!=p&&o.setAttachment(l,f,p)}return o},e.prototype.readAttachment=function(n,r,o,a,s,c){var l=this.scale,u=n.readStringRef();null==u&&(u=s);var h=n.readByte();switch(e.AttachmentTypeValues[h]){case t.AttachmentType.Region:var f=n.readStringRef(),p=n.readFloat(),d=n.readFloat(),_=n.readFloat(),m=n.readFloat(),v=n.readFloat(),g=n.readFloat(),y=n.readFloat(),x=n.readInt32();null==f&&(f=u);var S=this.attachmentLoader.newRegionAttachment(o,u,f);return null==S?null:(S.path=f,S.x=d*l,S.y=_*l,S.scaleX=m,S.scaleY=v,S.rotation=p,S.width=g*l,S.height=y*l,t.Color.rgba8888ToColor(S.color,x),S.updateOffset(),S);case t.AttachmentType.BoundingBox:var T=n.readInt(!0),E=this.readVertices(n,T),b=(x=c?n.readInt32():0,this.attachmentLoader.newBoundingBoxAttachment(o,u));return null==b?null:(b.worldVerticesLength=T<<1,b.vertices=E.vertices,b.bones=E.bones,c&&t.Color.rgba8888ToColor(b.color,x),b);case t.AttachmentType.Mesh:f=n.readStringRef(),x=n.readInt32(),T=n.readInt(!0);var C=this.readFloatArray(n,T<<1,1),A=this.readShortArray(n),w=(E=this.readVertices(n,T),n.readInt(!0)),R=null;return g=0,y=0,c&&(R=this.readShortArray(n),g=n.readFloat(),y=n.readFloat()),null==f&&(f=u),null==(P=this.attachmentLoader.newMeshAttachment(o,u,f))?null:(P.path=f,t.Color.rgba8888ToColor(P.color,x),P.bones=E.bones,P.vertices=E.vertices,P.worldVerticesLength=T<<1,P.triangles=A,P.regionUVs=C,P.updateUVs(),P.hullLength=w<<1,c&&(P.edges=R,P.width=g*l,P.height=y*l),P);case t.AttachmentType.LinkedMesh:f=n.readStringRef(),x=n.readInt32();var P,I=n.readStringRef(),M=n.readStringRef(),D=n.readBoolean();return g=0,y=0,c&&(g=n.readFloat(),y=n.readFloat()),null==f&&(f=u),null==(P=this.attachmentLoader.newMeshAttachment(o,u,f))?null:(P.path=f,t.Color.rgba8888ToColor(P.color,x),c&&(P.width=g*l,P.height=y*l),this.linkedMeshes.push(new i(P,I,a,M,D)),P);case t.AttachmentType.Path:for(var O=n.readBoolean(),N=n.readBoolean(),L=(T=n.readInt(!0),E=this.readVertices(n,T),t.Utils.newArray(T/3,0)),B=0,F=L.length;B<F;B++)L[B]=n.readFloat()*l;return x=c?n.readInt32():0,null==(f=this.attachmentLoader.newPathAttachment(o,u))?null:(f.closed=O,f.constantSpeed=N,f.worldVerticesLength=T<<1,f.vertices=E.vertices,f.bones=E.bones,f.lengths=L,c&&t.Color.rgba8888ToColor(f.color,x),f);case t.AttachmentType.Point:p=n.readFloat(),d=n.readFloat(),_=n.readFloat(),x=c?n.readInt32():0;var z=this.attachmentLoader.newPointAttachment(o,u);return null==z?null:(z.x=d*l,z.y=_*l,z.rotation=p,c&&t.Color.rgba8888ToColor(z.color,x),z);case t.AttachmentType.Clipping:var k=n.readInt(!0),U=(T=n.readInt(!0),E=this.readVertices(n,T),x=c?n.readInt32():0,this.attachmentLoader.newClippingAttachment(o,u));return null==U?null:(U.endSlot=r.slots[k],U.worldVerticesLength=T<<1,U.vertices=E.vertices,U.bones=E.bones,c&&t.Color.rgba8888ToColor(U.color,x),U)}return null},e.prototype.readVertices=function(e,n){var i=n<<1,o=new r,a=this.scale;if(!e.readBoolean())return o.vertices=this.readFloatArray(e,i,a),o;for(var s=new Array,c=new Array,l=0;l<n;l++){var u=e.readInt(!0);c.push(u);for(var h=0;h<u;h++)c.push(e.readInt(!0)),s.push(e.readFloat()*a),s.push(e.readFloat()*a),s.push(e.readFloat())}return o.vertices=t.Utils.toFloatArray(s),o.bones=c,o},e.prototype.readFloatArray=function(t,e,n){var i=new Array(e);if(1==n)for(var r=0;r<e;r++)i[r]=t.readFloat();else for(r=0;r<e;r++)i[r]=t.readFloat()*n;return i},e.prototype.readShortArray=function(t){for(var e=t.readInt(!0),n=new Array(e),i=0;i<e;i++)n[i]=t.readShort();return n},e.prototype.readAnimation=function(n,i,r){for(var o=new Array,a=this.scale,s=0,c=new t.Color,l=new t.Color,u=0,h=n.readInt(!0);u<h;u++)for(var f=n.readInt(!0),p=0,d=n.readInt(!0);p<d;p++){var _=n.readByte(),m=n.readInt(!0);switch(_){case e.SLOT_ATTACHMENT:(x=new t.AttachmentTimeline(m)).slotIndex=f;for(var v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readStringRef());o.push(x),s=Math.max(s,x.frames[m-1]);break;case e.SLOT_COLOR:for((x=new t.ColorTimeline(m)).slotIndex=f,v=0;v<m;v++){var g=n.readFloat();t.Color.rgba8888ToColor(c,n.readInt32()),x.setFrame(v,g,c.r,c.g,c.b,c.a),v<m-1&&this.readCurve(n,v,x)}o.push(x),s=Math.max(s,x.frames[(m-1)*t.ColorTimeline.ENTRIES]);break;case e.SLOT_TWO_COLOR:for((x=new t.TwoColorTimeline(m)).slotIndex=f,v=0;v<m;v++)g=n.readFloat(),t.Color.rgba8888ToColor(c,n.readInt32()),t.Color.rgb888ToColor(l,n.readInt32()),x.setFrame(v,g,c.r,c.g,c.b,c.a,l.r,l.g,l.b),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.TwoColorTimeline.ENTRIES])}}for(u=0,h=n.readInt(!0);u<h;u++){var y=n.readInt(!0);for(p=0,d=n.readInt(!0);p<d;p++)switch(_=n.readByte(),m=n.readInt(!0),_){case e.BONE_ROTATE:for((x=new t.RotateTimeline(m)).boneIndex=y,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat()),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.RotateTimeline.ENTRIES]);break;case e.BONE_TRANSLATE:case e.BONE_SCALE:case e.BONE_SHEAR:var x=void 0,S=1;for(_==e.BONE_SCALE?x=new t.ScaleTimeline(m):_==e.BONE_SHEAR?x=new t.ShearTimeline(m):(x=new t.TranslateTimeline(m),S=a),x.boneIndex=y,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat()*S,n.readFloat()*S),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.TranslateTimeline.ENTRIES])}}for(u=0,h=n.readInt(!0);u<h;u++){var T=n.readInt(!0);for(m=n.readInt(!0),(x=new t.IkConstraintTimeline(m)).ikConstraintIndex=T,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat(),n.readFloat()*a,n.readByte(),n.readBoolean(),n.readBoolean()),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.IkConstraintTimeline.ENTRIES])}for(u=0,h=n.readInt(!0);u<h;u++){for(T=n.readInt(!0),m=n.readInt(!0),(x=new t.TransformConstraintTimeline(m)).transformConstraintIndex=T,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat(),n.readFloat(),n.readFloat(),n.readFloat()),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.TransformConstraintTimeline.ENTRIES])}for(u=0,h=n.readInt(!0);u<h;u++){T=n.readInt(!0);var E=r.pathConstraints[T];for(p=0,d=n.readInt(!0);p<d;p++)switch(_=n.readByte(),m=n.readInt(!0),_){case e.PATH_POSITION:case e.PATH_SPACING:for(x=void 0,S=1,_==e.PATH_SPACING?(x=new t.PathConstraintSpacingTimeline(m),E.spacingMode!=t.SpacingMode.Length&&E.spacingMode!=t.SpacingMode.Fixed||(S=a)):(x=new t.PathConstraintPositionTimeline(m),E.positionMode==t.PositionMode.Fixed&&(S=a)),x.pathConstraintIndex=T,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat()*S),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.PathConstraintPositionTimeline.ENTRIES]);break;case e.PATH_MIX:for((x=new t.PathConstraintMixTimeline(m)).pathConstraintIndex=T,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat(),n.readFloat()),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.PathConstraintMixTimeline.ENTRIES])}}for(u=0,h=n.readInt(!0);u<h;u++){var b=r.skins[n.readInt(!0)];for(p=0,d=n.readInt(!0);p<d;p++){f=n.readInt(!0);for(var C=0,A=n.readInt(!0);C<A;C++){var w=b.getAttachment(f,n.readStringRef()),R=null!=w.bones,P=w.vertices,I=R?P.length/3*2:P.length;for(m=n.readInt(!0),(x=new t.DeformTimeline(m)).slotIndex=f,x.attachment=w,v=0;v<m;v++){g=n.readFloat();var M=void 0,D=n.readInt(!0);if(0==D)M=R?t.Utils.newFloatArray(I):P;else{M=t.Utils.newFloatArray(I);var O=n.readInt(!0);if(D+=O,1==a)for(var N=O;N<D;N++)M[N]=n.readFloat();else for(N=O;N<D;N++)M[N]=n.readFloat()*a;if(!R){N=0;for(var L=M.length;N<L;N++)M[N]+=P[N]}}x.setFrame(v,g,M),v<m-1&&this.readCurve(n,v,x)}o.push(x),s=Math.max(s,x.frames[m-1])}}}var B=n.readInt(!0);if(B>0){x=new t.DrawOrderTimeline(B);var F=r.slots.length;for(u=0;u<B;u++){g=n.readFloat();var z=n.readInt(!0),k=t.Utils.newArray(F,0);for(p=F-1;p>=0;p--)k[p]=-1;var U=t.Utils.newArray(F-z,0),G=0,H=0;for(p=0;p<z;p++){for(f=n.readInt(!0);G!=f;)U[H++]=G++;k[G+n.readInt(!0)]=G++}for(;G<F;)U[H++]=G++;for(p=F-1;p>=0;p--)-1==k[p]&&(k[p]=U[--H]);x.setFrame(u,g,k)}o.push(x),s=Math.max(s,x.frames[B-1])}var V=n.readInt(!0);if(V>0){for(x=new t.EventTimeline(V),u=0;u<V;u++){g=n.readFloat();var W=r.events[n.readInt(!0)],j=new t.Event(g,W);j.intValue=n.readInt(!1),j.floatValue=n.readFloat(),j.stringValue=n.readBoolean()?n.readString():W.stringValue,null!=j.data.audioPath&&(j.volume=n.readFloat(),j.balance=n.readFloat()),x.setFrame(u,j)}o.push(x),s=Math.max(s,x.frames[V-1])}return new t.Animation(i,o,s)},e.prototype.readCurve=function(t,n,i){switch(t.readByte()){case e.CURVE_STEPPED:i.setStepped(n);break;case e.CURVE_BEZIER:this.setCurve(i,n,t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat())}},e.prototype.setCurve=function(t,e,n,i,r,o){t.setCurve(e,n,i,r,o)},e.AttachmentTypeValues=[0,1,2,3,4,5,6],e.TransformModeValues=[t.TransformMode.Normal,t.TransformMode.OnlyTranslation,t.TransformMode.NoRotationOrReflection,t.TransformMode.NoScale,t.TransformMode.NoScaleOrReflection],e.PositionModeValues=[t.PositionMode.Fixed,t.PositionMode.Percent],e.SpacingModeValues=[t.SpacingMode.Length,t.SpacingMode.Fixed,t.SpacingMode.Percent],e.RotateModeValues=[t.RotateMode.Tangent,t.RotateMode.Chain,t.RotateMode.ChainScale],e.BlendModeValues=[t.BlendMode.Normal,t.BlendMode.Additive,t.BlendMode.Multiply,t.BlendMode.Screen],e.BONE_ROTATE=0,e.BONE_TRANSLATE=1,e.BONE_SCALE=2,e.BONE_SHEAR=3,e.SLOT_ATTACHMENT=0,e.SLOT_COLOR=1,e.SLOT_TWO_COLOR=2,e.PATH_POSITION=0,e.PATH_SPACING=1,e.PATH_MIX=2,e.CURVE_LINEAR=0,e.CURVE_STEPPED=1,e.CURVE_BEZIER=2,e}();t.SkeletonBinary=e;var n=function(){function t(t,e,n,i){void 0===e&&(e=new Array),void 0===n&&(n=0),void 0===i&&(i=new DataView(t.buffer)),this.strings=e,this.index=n,this.buffer=i}return t.prototype.readByte=function(){return this.buffer.getInt8(this.index++)},t.prototype.readShort=function(){var t=this.buffer.getInt16(this.index);return this.index+=2,t},t.prototype.readInt32=function(){var t=this.buffer.getInt32(this.index);return this.index+=4,t},t.prototype.readInt=function(t){var e=this.readByte(),n=127&e;return 0!=(128&e)&&(n|=(127&(e=this.readByte()))<<7,0!=(128&e)&&(n|=(127&(e=this.readByte()))<<14,0!=(128&e)&&(n|=(127&(e=this.readByte()))<<21,0!=(128&e)&&(n|=(127&(e=this.readByte()))<<28)))),t?n:n>>>1^-(1&n)},t.prototype.readStringRef=function(){var t=this.readInt(!0);return 0==t?null:this.strings[t-1]},t.prototype.readString=function(){var t=this.readInt(!0);switch(t){case 0:return null;case 1:return""}t--;for(var e="",n=0;n<t;){var i=this.readByte();switch(i>>4){case 12:case 13:e+=String.fromCharCode((31&i)<<6|63&this.readByte()),n+=2;break;case 14:e+=String.fromCharCode((15&i)<<12|(63&this.readByte())<<6|63&this.readByte()),n+=3;break;default:e+=String.fromCharCode(i),n++}}return e},t.prototype.readFloat=function(){var t=this.buffer.getFloat32(this.index);return this.index+=4,t},t.prototype.readBoolean=function(){return 0!=this.readByte()},t}(),i=function(t,e,n,i,r){this.mesh=t,this.skin=e,this.slotIndex=n,this.parent=i,this.inheritDeform=r},r=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.bones=t,this.vertices=e}}(mgt||(mgt={})),function(t){var e=function(){function e(){this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.boundingBoxes=new Array,this.polygons=new Array,this.polygonPool=new t.Pool((function(){return t.Utils.newFloatArray(16)}))}return e.prototype.update=function(e,n){if(null==e)throw new Error("skeleton cannot be null.");var i=this.boundingBoxes,r=this.polygons,o=this.polygonPool,a=e.slots,s=a.length;i.length=0,o.freeAll(r),r.length=0;for(var c=0;c<s;c++){var l=a[c];if(l.bone.active){var u=l.getAttachment();if(u instanceof t.BoundingBoxAttachment){var h=u;i.push(h);var f=o.obtain();f.length!=h.worldVerticesLength&&(f=t.Utils.newFloatArray(h.worldVerticesLength)),r.push(f),h.computeWorldVertices(l,0,h.worldVerticesLength,f,0,2)}}}n?this.aabbCompute():(this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY)},e.prototype.aabbCompute=function(){for(var t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY,r=this.polygons,o=0,a=r.length;o<a;o++)for(var s=r[o],c=s,l=0,u=s.length;l<u;l+=2){var h=c[l],f=c[l+1];t=Math.min(t,h),e=Math.min(e,f),n=Math.max(n,h),i=Math.max(i,f)}this.minX=t,this.minY=e,this.maxX=n,this.maxY=i},e.prototype.aabbContainsPoint=function(t,e){return t>=this.minX&&t<=this.maxX&&e>=this.minY&&e<=this.maxY},e.prototype.aabbIntersectsSegment=function(t,e,n,i){var r=this.minX,o=this.minY,a=this.maxX,s=this.maxY;if(t<=r&&n<=r||e<=o&&i<=o||t>=a&&n>=a||e>=s&&i>=s)return!1;var c=(i-e)/(n-t),l=c*(r-t)+e;if(l>o&&l<s)return!0;if((l=c*(a-t)+e)>o&&l<s)return!0;var u=(o-e)/c+t;return u>r&&u<a||(u=(s-e)/c+t)>r&&u<a},e.prototype.aabbIntersectsSkeleton=function(t){return this.minX<t.maxX&&this.maxX>t.minX&&this.minY<t.maxY&&this.maxY>t.minY},e.prototype.containsPoint=function(t,e){for(var n=this.polygons,i=0,r=n.length;i<r;i++)if(this.containsPointPolygon(n[i],t,e))return this.boundingBoxes[i];return null},e.prototype.containsPointPolygon=function(t,e,n){for(var i=t,r=t.length,o=r-2,a=!1,s=0;s<r;s+=2){var c=i[s+1],l=i[o+1];if(c<n&&l>=n||l<n&&c>=n){var u=i[s];u+(n-c)/(l-c)*(i[o]-u)<e&&(a=!a)}o=s}return a},e.prototype.intersectsSegment=function(t,e,n,i){for(var r=this.polygons,o=0,a=r.length;o<a;o++)if(this.intersectsSegmentPolygon(r[o],t,e,n,i))return this.boundingBoxes[o];return null},e.prototype.intersectsSegmentPolygon=function(t,e,n,i,r){for(var o=t,a=t.length,s=e-i,c=n-r,l=e*r-n*i,u=o[a-2],h=o[a-1],f=0;f<a;f+=2){var p=o[f],d=o[f+1],_=u*d-h*p,m=u-p,v=h-d,g=s*v-c*m,y=(l*m-s*_)/g;if((y>=u&&y<=p||y>=p&&y<=u)&&(y>=e&&y<=i||y>=i&&y<=e)){var x=(l*v-c*_)/g;if((x>=h&&x<=d||x>=d&&x<=h)&&(x>=n&&x<=r||x>=r&&x<=n))return!0}u=p,h=d}return!1},e.prototype.getPolygon=function(t){if(null==t)throw new Error("boundingBox cannot be null.");var e=this.boundingBoxes.indexOf(t);return-1==e?null:this.polygons[e]},e.prototype.getWidth=function(){return this.maxX-this.minX},e.prototype.getHeight=function(){return this.maxY-this.minY},e}();t.SkeletonBounds=e}(mgt||(mgt={})),function(t){var e=function(){function e(){this.triangulator=new t.Triangulator,this.clippingPolygon=new Array,this.clipOutput=new Array,this.clippedVertices=new Array,this.clippedTriangles=new Array,this.scratch=new Array}return e.prototype.clipStart=function(n,i){if(null!=this.clipAttachment)return 0;this.clipAttachment=i;var r=i.worldVerticesLength,o=t.Utils.setArraySize(this.clippingPolygon,r);i.computeWorldVertices(n,0,r,o,0,2);var a=this.clippingPolygon;e.makeClockwise(a);for(var s=this.clippingPolygons=this.triangulator.decompose(a,this.triangulator.triangulate(a)),c=0,l=s.length;c<l;c++){var u=s[c];e.makeClockwise(u),u.push(u[0]),u.push(u[1])}return s.length},e.prototype.clipEndWithSlot=function(t){null!=this.clipAttachment&&this.clipAttachment.endSlot==t.data&&this.clipEnd()},e.prototype.clipEnd=function(){null!=this.clipAttachment&&(this.clipAttachment=null,this.clippingPolygons=null,this.clippedVertices.length=0,this.clippedTriangles.length=0,this.clippingPolygon.length=0)},e.prototype.isClipping=function(){return null!=this.clipAttachment},e.prototype.clipTriangles=function(e,n,i,r,o,a,s,c,l,u,h){void 0===l&&(l=2),void 0===u&&(u=0),void 0===h&&(h=0);var f=this.clipOutput,p=this.clippedVertices,d=this.clippedTriangles,_=this.clippingPolygons,m=this.clippingPolygons.length,v=c?12:8,g=0;p.length=0,d.length=0;t:for(var y=0;y<r;y+=3)for(var x=i[y]*l,S=e[x+u],T=e[x+u+1],E=o[x+h],b=o[x+h+1],C=e[(x=i[y+1]*l)+u],A=e[x+u+1],w=o[x+h],R=o[x+h+1],P=e[(x=i[y+2]*l)+u],I=e[x+u+1],M=o[x+h],D=o[x+h+1],O=0;O<m;O++){var N=p.length;if(!this.clip(S,T,C,A,P,I,_[O],f)){(V=t.Utils.setArraySize(p,N+3*v))[N]=S,V[N+1]=T,V[N+2]=a.r,V[N+3]=a.g,V[N+4]=a.b,V[N+5]=a.a,c?(V[N+6]=E,V[N+7]=b,V[N+8]=s.r,V[N+9]=s.g,V[N+10]=s.b,V[N+11]=s.a,V[N+12]=C,V[N+13]=A,V[N+14]=a.r,V[N+15]=a.g,V[N+16]=a.b,V[N+17]=a.a,V[N+18]=w,V[N+19]=R,V[N+20]=s.r,V[N+21]=s.g,V[N+22]=s.b,V[N+23]=s.a,V[N+24]=P,V[N+25]=I,V[N+26]=a.r,V[N+27]=a.g,V[N+28]=a.b,V[N+29]=a.a,V[N+30]=M,V[N+31]=D,V[N+32]=s.r,V[N+33]=s.g,V[N+34]=s.b,V[N+35]=s.a):(V[N+6]=E,V[N+7]=b,V[N+8]=C,V[N+9]=A,V[N+10]=a.r,V[N+11]=a.g,V[N+12]=a.b,V[N+13]=a.a,V[N+14]=w,V[N+15]=R,V[N+16]=P,V[N+17]=I,V[N+18]=a.r,V[N+19]=a.g,V[N+20]=a.b,V[N+21]=a.a,V[N+22]=M,V[N+23]=D),N=d.length,(J=t.Utils.setArraySize(d,N+3))[N]=g,J[N+1]=g+1,J[N+2]=g+2,g+=3;continue t}var L=f.length;if(0!=L){for(var B=A-I,F=P-C,z=S-P,k=I-T,U=1/(B*z+F*(T-I)),G=L>>1,H=this.clipOutput,V=t.Utils.setArraySize(p,N+G*v),W=0;W<L;W+=2){var j=H[W],q=H[W+1];V[N]=j,V[N+1]=q,V[N+2]=a.r,V[N+3]=a.g,V[N+4]=a.b,V[N+5]=a.a;var X=j-P,Y=q-I,K=(B*X+F*Y)*U,Q=(k*X+z*Y)*U,Z=1-K-Q;V[N+6]=E*K+w*Q+M*Z,V[N+7]=b*K+R*Q+D*Z,c&&(V[N+8]=s.r,V[N+9]=s.g,V[N+10]=s.b,V[N+11]=s.a),N+=v}N=d.length;var J=t.Utils.setArraySize(d,N+3*(G-2));for(G--,W=1;W<G;W++)J[N]=g,J[N+1]=g+W,J[N+2]=g+W+1,N+=3;g+=G+1}}},e.prototype.clip=function(t,e,n,i,r,o,a,s){var c=s,l=!1,u=null;a.length%4>=2?(u=s,s=this.scratch):u=this.scratch,u.length=0,u.push(t),u.push(e),u.push(n),u.push(i),u.push(r),u.push(o),u.push(t),u.push(e),s.length=0;for(var h=a,f=a.length-4,p=0;;p+=2){for(var d=h[p],_=h[p+1],m=h[p+2],v=h[p+3],g=d-m,y=_-v,x=u,S=u.length-2,T=s.length,E=0;E<S;E+=2){var b=x[E],C=x[E+1],A=x[E+2],w=x[E+3],R=g*(w-v)-y*(A-m)>0;if(g*(C-v)-y*(b-m)>0){if(R){s.push(A),s.push(w);continue}var P=(M=w-C)*(m-d)-(D=A-b)*(v-_);if(Math.abs(P)>1e-6){var I=(D*(_-C)-M*(d-b))/P;s.push(d+(m-d)*I),s.push(_+(v-_)*I)}else s.push(d),s.push(_)}else if(R){var M,D;P=(M=w-C)*(m-d)-(D=A-b)*(v-_),Math.abs(P)>1e-6?(I=(D*(_-C)-M*(d-b))/P,s.push(d+(m-d)*I),s.push(_+(v-_)*I)):(s.push(d),s.push(_)),s.push(A),s.push(w)}l=!0}if(T==s.length)return c.length=0,!0;if(s.push(s[0]),s.push(s[1]),p==f)break;var O=s;(s=u).length=0,u=O}if(c!=s){c.length=0,p=0;for(var N=s.length-2;p<N;p++)c[p]=s[p]}else c.length=c.length-2;return l},e.makeClockwise=function(t){for(var e=t,n=t.length,i=e[n-2]*e[1]-e[0]*e[n-1],r=0,o=0,a=0,s=0,c=n-3;s<c;s+=2)r=e[s],o=e[s+1],a=e[s+2],i+=r*e[s+3]-a*o;if(!(i<0)){s=0;var l=n-2;for(c=n>>1;s<c;s+=2){var u=e[s],h=e[s+1],f=l-s;e[s]=e[f],e[s+1]=e[f+1],e[f]=u,e[f+1]=h}}},e}();t.SkeletonClipping=e}(mgt||(mgt={})),function(t){var e=function(){function t(){this.bones=new Array,this.slots=new Array,this.skins=new Array,this.events=new Array,this.animations=new Array,this.ikConstraints=new Array,this.transformConstraints=new Array,this.pathConstraints=new Array,this.fps=0}return t.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,n=0,i=e.length;n<i;n++)if(e[n].name==t)return n;return-1},t.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,n=0,i=e.length;n<i;n++)if(e[n].name==t)return n;return-1},t.prototype.findSkin=function(t){if(null==t)throw new Error("skinName cannot be null.");for(var e=this.skins,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findEvent=function(t){if(null==t)throw new Error("eventDataName cannot be null.");for(var e=this.events,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findAnimation=function(t){if(null==t)throw new Error("animationName cannot be null.");for(var e=this.animations,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findPathConstraintIndex=function(t){if(null==t)throw new Error("pathConstraintName cannot be null.");for(var e=this.pathConstraints,n=0,i=e.length;n<i;n++)if(e[n].name==t)return n;return-1},t}();t.SkeletonData=e}(mgt||(mgt={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(n){var i=this.scale,r=new t.SkeletonData,o="string"==typeof n?JSON.parse(n):n,a=o.skeleton;if(null!=a&&(r.hash=a.hash,r.version=a.spine,r.x=a.x,r.y=a.y,r.width=a.width,r.height=a.height,r.fps=a.fps,r.imagesPath=a.images),o.bones)for(var s=0;s<o.bones.length;s++){var c=o.bones[s],l=null,u=this.getValue(c,"parent",null);if(null!=u&&null==(l=r.findBone(u)))throw new Error("Parent bone not found: "+u);(d=new t.BoneData(r.bones.length,c.name,l)).length=this.getValue(c,"length",0)*i,d.x=this.getValue(c,"x",0)*i,d.y=this.getValue(c,"y",0)*i,d.rotation=this.getValue(c,"rotation",0),d.scaleX=this.getValue(c,"scaleX",1),d.scaleY=this.getValue(c,"scaleY",1),d.shearX=this.getValue(c,"shearX",0),d.shearY=this.getValue(c,"shearY",0),d.transformMode=e.transformModeFromString(this.getValue(c,"transform","normal")),d.skinRequired=this.getValue(c,"skin",!1),r.bones.push(d)}if(o.slots)for(s=0;s<o.slots.length;s++){var h=(P=o.slots[s]).name,f=P.bone,p=r.findBone(f);if(null==p)throw new Error("Slot bone not found: "+f);var d=new t.SlotData(r.slots.length,h,p),_=this.getValue(P,"color",null);null!=_&&d.color.setFromString(_);var m=this.getValue(P,"dark",null);null!=m&&(d.darkColor=new t.Color(1,1,1,1),d.darkColor.setFromString(m)),d.attachmentName=this.getValue(P,"attachment",null),d.blendMode=e.blendModeFromString(this.getValue(P,"blend","normal")),r.slots.push(d)}if(o.ik)for(s=0;s<o.ik.length;s++){var v=o.ik[s];(d=new t.IkConstraintData(v.name)).order=this.getValue(v,"order",0),d.skinRequired=this.getValue(v,"skin",!1);for(var g=0;g<v.bones.length;g++){if(f=v.bones[g],null==(A=r.findBone(f)))throw new Error("IK bone not found: "+f);d.bones.push(A)}var y=v.target;if(d.target=r.findBone(y),null==d.target)throw new Error("IK target bone not found: "+y);d.mix=this.getValue(v,"mix",1),d.softness=this.getValue(v,"softness",0)*i,d.bendDirection=this.getValue(v,"bendPositive",!0)?1:-1,d.compress=this.getValue(v,"compress",!1),d.stretch=this.getValue(v,"stretch",!1),d.uniform=this.getValue(v,"uniform",!1),r.ikConstraints.push(d)}if(o.transform)for(s=0;s<o.transform.length;s++){for(v=o.transform[s],(d=new t.TransformConstraintData(v.name)).order=this.getValue(v,"order",0),d.skinRequired=this.getValue(v,"skin",!1),g=0;g<v.bones.length;g++){if(f=v.bones[g],null==(A=r.findBone(f)))throw new Error("Transform constraint bone not found: "+f);d.bones.push(A)}if(y=v.target,d.target=r.findBone(y),null==d.target)throw new Error("Transform constraint target bone not found: "+y);d.local=this.getValue(v,"local",!1),d.relative=this.getValue(v,"relative",!1),d.offsetRotation=this.getValue(v,"rotation",0),d.offsetX=this.getValue(v,"x",0)*i,d.offsetY=this.getValue(v,"y",0)*i,d.offsetScaleX=this.getValue(v,"scaleX",0),d.offsetScaleY=this.getValue(v,"scaleY",0),d.offsetShearY=this.getValue(v,"shearY",0),d.rotateMix=this.getValue(v,"rotateMix",1),d.translateMix=this.getValue(v,"translateMix",1),d.scaleMix=this.getValue(v,"scaleMix",1),d.shearMix=this.getValue(v,"shearMix",1),r.transformConstraints.push(d)}if(o.path)for(s=0;s<o.path.length;s++){for(v=o.path[s],(d=new t.PathConstraintData(v.name)).order=this.getValue(v,"order",0),d.skinRequired=this.getValue(v,"skin",!1),g=0;g<v.bones.length;g++){if(f=v.bones[g],null==(A=r.findBone(f)))throw new Error("Transform constraint bone not found: "+f);d.bones.push(A)}if(y=v.target,d.target=r.findSlot(y),null==d.target)throw new Error("Path target slot not found: "+y);d.positionMode=e.positionModeFromString(this.getValue(v,"positionMode","percent")),d.spacingMode=e.spacingModeFromString(this.getValue(v,"spacingMode","length")),d.rotateMode=e.rotateModeFromString(this.getValue(v,"rotateMode","tangent")),d.offsetRotation=this.getValue(v,"rotation",0),d.position=this.getValue(v,"position",0),d.positionMode==t.PositionMode.Fixed&&(d.position*=i),d.spacing=this.getValue(v,"spacing",0),d.spacingMode!=t.SpacingMode.Length&&d.spacingMode!=t.SpacingMode.Fixed||(d.spacing*=i),d.rotateMix=this.getValue(v,"rotateMix",1),d.translateMix=this.getValue(v,"translateMix",1),r.pathConstraints.push(d)}if(o.skins){var x=o.skins;if(!(x instanceof Array)){var S=[];for(var T in x)S.push({name:T,attachments:x[T]});x=S}for(s=0;s<x.length;s++){var E=x[s],b=new t.Skin(E.name);if(E.bones)for(var C=0;C<E.bones.length;C++){var A;if(null==(A=r.findBone(E.bones[C])))throw new Error("Skin bone not found: "+E.bones[s]);b.bones.push(A)}if(E.ik)for(C=0;C<E.ik.length;C++){if(null==(w=r.findIkConstraint(E.ik[C])))throw new Error("Skin IK constraint not found: "+E.ik[s]);b.constraints.push(w)}if(E.transform)for(C=0;C<E.transform.length;C++){if(null==(w=r.findTransformConstraint(E.transform[C])))throw new Error("Skin transform constraint not found: "+E.transform[s]);b.constraints.push(w)}if(E.path)for(C=0;C<E.path.length;C++){var w;if(null==(w=r.findPathConstraint(E.path[C])))throw new Error("Skin path constraint not found: "+E.path[s]);b.constraints.push(w)}for(var h in E.attachments){var R=r.findSlot(h);if(null==R)throw new Error("Slot not found: "+h);var P=E.attachments[h];for(var I in P){var M=this.readAttachment(P[I],b,R.index,I,r);null!=M&&b.setAttachment(R.index,I,M)}}r.skins.push(b),"default"==b.name&&(r.defaultSkin=b)}}s=0;for(var D=this.linkedMeshes.length;s<D;s++){var O=this.linkedMeshes[s];if(null==(b=null==O.skin?r.defaultSkin:r.findSkin(O.skin)))throw new Error("Skin not found: "+O.skin);var N=b.getAttachment(O.slotIndex,O.parent);if(null==N)throw new Error("Parent mesh not found: "+O.parent);O.mesh.deformAttachment=O.inheritDeform?N:O.mesh,O.mesh.setParentMesh(N),O.mesh.updateUVs()}if(this.linkedMeshes.length=0,o.events)for(var L in o.events){var B=o.events[L];(d=new t.EventData(L)).intValue=this.getValue(B,"int",0),d.floatValue=this.getValue(B,"float",0),d.stringValue=this.getValue(B,"string",""),d.audioPath=this.getValue(B,"audio",null),null!=d.audioPath&&(d.volume=this.getValue(B,"volume",1),d.balance=this.getValue(B,"balance",0)),r.events.push(d)}if(o.animations)for(var F in o.animations){var z=o.animations[F];this.readAnimation(z,F,r)}return r},e.prototype.readAttachment=function(e,i,r,o,a){var s=this.scale;switch(o=this.getValue(e,"name",o),this.getValue(e,"type","region")){case"region":var c=this.getValue(e,"path",o),l=this.attachmentLoader.newRegionAttachment(i,o,c);return null==l?null:(l.path=c,l.x=this.getValue(e,"x",0)*s,l.y=this.getValue(e,"y",0)*s,l.scaleX=this.getValue(e,"scaleX",1),l.scaleY=this.getValue(e,"scaleY",1),l.rotation=this.getValue(e,"rotation",0),l.width=e.width*s,l.height=e.height*s,null!=(y=this.getValue(e,"color",null))&&l.color.setFromString(y),l.updateOffset(),l);case"boundingbox":var u=this.attachmentLoader.newBoundingBoxAttachment(i,o);return null==u?null:(this.readVertices(e,u,e.vertexCount<<1),null!=(y=this.getValue(e,"color",null))&&u.color.setFromString(y),u);case"mesh":case"linkedmesh":c=this.getValue(e,"path",o);var h=this.attachmentLoader.newMeshAttachment(i,o,c);if(null==h)return null;h.path=c,null!=(y=this.getValue(e,"color",null))&&h.color.setFromString(y),h.width=this.getValue(e,"width",0)*s,h.height=this.getValue(e,"height",0)*s;var f=this.getValue(e,"parent",null);if(null!=f)return this.linkedMeshes.push(new n(h,this.getValue(e,"skin",null),r,f,this.getValue(e,"deform",!0))),h;var p=e.uvs;return this.readVertices(e,h,p.length),h.triangles=e.triangles,h.regionUVs=p,h.updateUVs(),h.edges=this.getValue(e,"edges",null),h.hullLength=2*this.getValue(e,"hull",0),h;case"path":if(null==(c=this.attachmentLoader.newPathAttachment(i,o)))return null;c.closed=this.getValue(e,"closed",!1),c.constantSpeed=this.getValue(e,"constantSpeed",!0);var d=e.vertexCount;this.readVertices(e,c,d<<1);for(var _=t.Utils.newArray(d/3,0),m=0;m<e.lengths.length;m++)_[m]=e.lengths[m]*s;return c.lengths=_,null!=(y=this.getValue(e,"color",null))&&c.color.setFromString(y),c;case"point":var v=this.attachmentLoader.newPointAttachment(i,o);return null==v?null:(v.x=this.getValue(e,"x",0)*s,v.y=this.getValue(e,"y",0)*s,v.rotation=this.getValue(e,"rotation",0),null!=(y=this.getValue(e,"color",null))&&v.color.setFromString(y),v);case"clipping":var g=this.attachmentLoader.newClippingAttachment(i,o);if(null==g)return null;var y,x=this.getValue(e,"end",null);if(null!=x){var S=a.findSlot(x);if(null==S)throw new Error("Clipping end slot not found: "+x);g.endSlot=S}return d=e.vertexCount,this.readVertices(e,g,d<<1),null!=(y=this.getValue(e,"color",null))&&g.color.setFromString(y),g}return null},e.prototype.readVertices=function(e,n,i){var r=this.scale;n.worldVerticesLength=i;var o=e.vertices;if(i!=o.length){var a=new Array,s=new Array;for(h=0,f=o.length;h<f;){var c=o[h++];s.push(c);for(var l=h+4*c;h<l;h+=4)s.push(o[h]),a.push(o[h+1]*r),a.push(o[h+2]*r),a.push(o[h+3])}n.bones=s,n.vertices=t.Utils.toFloatArray(a)}else{var u=t.Utils.toFloatArray(o);if(1!=r)for(var h=0,f=o.length;h<f;h++)u[h]*=r;n.vertices=u}},e.prototype.readAnimation=function(e,n,i){var r=this.scale,o=new Array,a=0;if(e.slots)for(var s in e.slots){var c=e.slots[s];if(-1==(Z=i.findSlotIndex(s)))throw new Error("Slot not found: "+s);for(var l in c){var u=c[l];if("attachment"==l){(x=new t.AttachmentTimeline(u.length)).slotIndex=Z;for(var h=0,f=0;f<u.length;f++){var p=u[f];x.setFrame(h++,this.getValue(p,"time",0),p.name)}o.push(x),a=Math.max(a,x.frames[x.getFrameCount()-1])}else if("color"==l){for((x=new t.ColorTimeline(u.length)).slotIndex=Z,h=0,f=0;f<u.length;f++){p=u[f];var d=new t.Color;d.setFromString(p.color),x.setFrame(h,this.getValue(p,"time",0),d.r,d.g,d.b,d.a),this.readCurve(p,x,h),h++}o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.ColorTimeline.ENTRIES])}else{if("twoColor"!=l)throw new Error("Invalid timeline type for a slot: "+l+" ("+s+")");for((x=new t.TwoColorTimeline(u.length)).slotIndex=Z,h=0,f=0;f<u.length;f++){p=u[f];var _=new t.Color,m=new t.Color;_.setFromString(p.light),m.setFromString(p.dark),x.setFrame(h,this.getValue(p,"time",0),_.r,_.g,_.b,_.a,m.r,m.g,m.b),this.readCurve(p,x,h),h++}o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.TwoColorTimeline.ENTRIES])}}}if(e.bones)for(var v in e.bones){var g=e.bones[v],y=i.findBoneIndex(v);if(-1==y)throw new Error("Bone not found: "+v);for(var l in g)if(u=g[l],"rotate"===l){for((x=new t.RotateTimeline(u.length)).boneIndex=y,h=0,f=0;f<u.length;f++)p=u[f],x.setFrame(h,this.getValue(p,"time",0),this.getValue(p,"angle",0)),this.readCurve(p,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.RotateTimeline.ENTRIES])}else{if("translate"!==l&&"scale"!==l&&"shear"!==l)throw new Error("Invalid timeline type for a bone: "+l+" ("+v+")");var x=null,S=1,T=0;for("scale"===l?(x=new t.ScaleTimeline(u.length),T=1):"shear"===l?x=new t.ShearTimeline(u.length):(x=new t.TranslateTimeline(u.length),S=r),x.boneIndex=y,h=0,f=0;f<u.length;f++){p=u[f];var E=this.getValue(p,"x",T),b=this.getValue(p,"y",T);x.setFrame(h,this.getValue(p,"time",0),E*S,b*S),this.readCurve(p,x,h),h++}o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.TranslateTimeline.ENTRIES])}}if(e.ik)for(var C in e.ik){var A=e.ik[C],w=i.findIkConstraint(C);for((x=new t.IkConstraintTimeline(A.length)).ikConstraintIndex=i.ikConstraints.indexOf(w),h=0,f=0;f<A.length;f++)p=A[f],x.setFrame(h,this.getValue(p,"time",0),this.getValue(p,"mix",1),this.getValue(p,"softness",0)*r,this.getValue(p,"bendPositive",!0)?1:-1,this.getValue(p,"compress",!1),this.getValue(p,"stretch",!1)),this.readCurve(p,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.IkConstraintTimeline.ENTRIES])}if(e.transform)for(var C in e.transform){for(A=e.transform[C],w=i.findTransformConstraint(C),(x=new t.TransformConstraintTimeline(A.length)).transformConstraintIndex=i.transformConstraints.indexOf(w),h=0,f=0;f<A.length;f++)p=A[f],x.setFrame(h,this.getValue(p,"time",0),this.getValue(p,"rotateMix",1),this.getValue(p,"translateMix",1),this.getValue(p,"scaleMix",1),this.getValue(p,"shearMix",1)),this.readCurve(p,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.TransformConstraintTimeline.ENTRIES])}var R=e.path||e.paths;if(R)for(var C in R){A=R[C];var P=i.findPathConstraintIndex(C);if(-1==P)throw new Error("Path constraint not found: "+C);var I=i.pathConstraints[P];for(var l in A)if(u=A[l],"position"===l||"spacing"===l){for(x=null,S=1,"spacing"===l?(x=new t.PathConstraintSpacingTimeline(u.length),I.spacingMode!=t.SpacingMode.Length&&I.spacingMode!=t.SpacingMode.Fixed||(S=r)):(x=new t.PathConstraintPositionTimeline(u.length),I.positionMode==t.PositionMode.Fixed&&(S=r)),x.pathConstraintIndex=P,h=0,f=0;f<u.length;f++)p=u[f],x.setFrame(h,this.getValue(p,"time",0),this.getValue(p,l,0)*S),this.readCurve(p,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.PathConstraintPositionTimeline.ENTRIES])}else if("mix"===l){for((x=new t.PathConstraintMixTimeline(u.length)).pathConstraintIndex=P,h=0,f=0;f<u.length;f++)p=u[f],x.setFrame(h,this.getValue(p,"time",0),this.getValue(p,"rotateMix",1),this.getValue(p,"translateMix",1)),this.readCurve(p,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.PathConstraintMixTimeline.ENTRIES])}}if(e.deform)for(var M in e.deform){var D=e.deform[M],O=i.findSkin(M);if(null==O)throw new Error("Skin not found: "+M);for(var s in D){if(c=D[s],-1==(Z=i.findSlotIndex(s)))throw new Error("Slot not found: "+c.name);for(var l in c){u=c[l];var N=O.getAttachment(Z,l);if(null!=N){var L=null!=N.bones,B=N.vertices,F=L?B.length/3*2:B.length;(x=new t.DeformTimeline(u.length)).slotIndex=Z,x.attachment=N,h=0;for(var z=0;z<u.length;z++){p=u[z];var k=void 0,U=this.getValue(p,"vertices",null);if(null==U)k=L?t.Utils.newFloatArray(F):B;else{k=t.Utils.newFloatArray(F);var G=this.getValue(p,"offset",0);if(t.Utils.arrayCopy(U,0,k,G,U.length),1!=r)for(var H=(f=G)+U.length;f<H;f++)k[f]*=r;if(!L)for(f=0;f<F;f++)k[f]+=B[f]}x.setFrame(h,this.getValue(p,"time",0),k),this.readCurve(p,x,h),h++}o.push(x),a=Math.max(a,x.frames[x.getFrameCount()-1])}}}}var V=e.drawOrder;if(null==V&&(V=e.draworder),null!=V){x=new t.DrawOrderTimeline(V.length);var W=i.slots.length;for(h=0,z=0;z<V.length;z++){var j=V[z],q=null,X=this.getValue(j,"offsets",null);if(null!=X){q=t.Utils.newArray(W,-1);var Y=t.Utils.newArray(W-X.length,0),K=0,Q=0;for(f=0;f<X.length;f++){var Z,J=X[f];if(-1==(Z=i.findSlotIndex(J.slot)))throw new Error("Slot not found: "+J.slot);for(;K!=Z;)Y[Q++]=K++;q[K+J.offset]=K++}for(;K<W;)Y[Q++]=K++;for(f=W-1;f>=0;f--)-1==q[f]&&(q[f]=Y[--Q])}x.setFrame(h++,this.getValue(j,"time",0),q)}o.push(x),a=Math.max(a,x.frames[x.getFrameCount()-1])}if(e.events){for(x=new t.EventTimeline(e.events.length),h=0,f=0;f<e.events.length;f++){var $=e.events[f],tt=i.findEvent($.name);if(null==tt)throw new Error("Event not found: "+$.name);var et=new t.Event(t.Utils.toSinglePrecision(this.getValue($,"time",0)),tt);et.intValue=this.getValue($,"int",tt.intValue),et.floatValue=this.getValue($,"float",tt.floatValue),et.stringValue=this.getValue($,"string",tt.stringValue),null!=et.data.audioPath&&(et.volume=this.getValue($,"volume",1),et.balance=this.getValue($,"balance",0)),x.setFrame(h++,et)}o.push(x),a=Math.max(a,x.frames[x.getFrameCount()-1])}if(isNaN(a))throw new Error("Error while parsing animation, duration is NaN");i.animations.push(new t.Animation(n,o,a))},e.prototype.readCurve=function(t,e,n){var i=t.curve;i&&("stepped"==i?e.setStepped(n):"[object Array]"===Object.prototype.toString.call(i)?e.setCurve(n,i[0],i[1],i[2],i[3]):e.setCurve(n,i,this.getValue(t,"c2",0),this.getValue(t,"c3",1),this.getValue(t,"c4",1)))},e.prototype.getValue=function(t,e,n){return void 0!==t[e]?t[e]:n},e.blendModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.BlendMode.Normal;if("additive"==e)return t.BlendMode.Additive;if("multiply"==e)return t.BlendMode.Multiply;if("screen"==e)return t.BlendMode.Screen;throw new Error("Unknown blend mode: "+e)},e.positionModeFromString=function(e){if("fixed"==(e=e.toLowerCase()))return t.PositionMode.Fixed;if("percent"==e)return t.PositionMode.Percent;throw new Error("Unknown position mode: "+e)},e.spacingModeFromString=function(e){if("length"==(e=e.toLowerCase()))return t.SpacingMode.Length;if("fixed"==e)return t.SpacingMode.Fixed;if("percent"==e)return t.SpacingMode.Percent;throw new Error("Unknown position mode: "+e)},e.rotateModeFromString=function(e){if("tangent"==(e=e.toLowerCase()))return t.RotateMode.Tangent;if("chain"==e)return t.RotateMode.Chain;if("chainscale"==e)return t.RotateMode.ChainScale;throw new Error("Unknown rotate mode: "+e)},e.transformModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.TransformMode.Normal;if("onlytranslation"==e)return t.TransformMode.OnlyTranslation;if("norotationorreflection"==e)return t.TransformMode.NoRotationOrReflection;if("noscale"==e)return t.TransformMode.NoScale;if("noscaleorreflection"==e)return t.TransformMode.NoScaleOrReflection;throw new Error("Unknown transform mode: "+e)},e}();t.SkeletonJson=e;var n=function(t,e,n,i,r){this.mesh=t,this.skin=e,this.slotIndex=n,this.parent=i,this.inheritDeform=r}}(mgt||(mgt={})),function(t){var e=function(t,e,n){this.slotIndex=t,this.name=e,this.attachment=n};t.SkinEntry=e;var n=function(){function n(t){if(this.attachments=new Array,this.bones=Array(),this.constraints=new Array,null==t)throw new Error("name cannot be null.");this.name=t}return n.prototype.setAttachment=function(t,e,n){if(null==n)throw new Error("attachment cannot be null.");var i=this.attachments;t>=i.length&&(i.length=t+1),i[t]||(i[t]={}),i[t][e]=n},n.prototype.addSkin=function(t){for(var e=0;e<t.bones.length;e++){for(var n=t.bones[e],i=!1,r=0;r<this.bones.length;r++)if(this.bones[r]==n){i=!0;break}i||this.bones.push(n)}for(e=0;e<t.constraints.length;e++){var o=t.constraints[e];for(i=!1,r=0;r<this.constraints.length;r++)if(this.constraints[r]==o){i=!0;break}i||this.constraints.push(o)}var a=t.getAttachments();for(e=0;e<a.length;e++){var s=a[e];this.setAttachment(s.slotIndex,s.name,s.attachment)}},n.prototype.copySkin=function(e){for(var n=0;n<e.bones.length;n++){for(var i=e.bones[n],r=!1,o=0;o<this.bones.length;o++)if(this.bones[o]==i){r=!0;break}r||this.bones.push(i)}for(n=0;n<e.constraints.length;n++){var a=e.constraints[n];for(r=!1,o=0;o<this.constraints.length;o++)if(this.constraints[o]==a){r=!0;break}r||this.constraints.push(a)}var s=e.getAttachments();for(n=0;n<s.length;n++){var c=s[n];null!=c.attachment&&(c.attachment instanceof t.MeshAttachment?(c.attachment=c.attachment.newLinkedMesh(),this.setAttachment(c.slotIndex,c.name,c.attachment)):(c.attachment=c.attachment.copy(),this.setAttachment(c.slotIndex,c.name,c.attachment)))}},n.prototype.getAttachment=function(t,e){var n=this.attachments[t];return n?n[e]:null},n.prototype.removeAttachment=function(t,e){var n=this.attachments[t];n&&(n[e]=null)},n.prototype.getAttachments=function(){for(var t=new Array,n=0;n<this.attachments.length;n++){var i=this.attachments[n];if(i)for(var r in i){var o=i[r];o&&t.push(new e(n,r,o))}}return t},n.prototype.getAttachmentsForSlot=function(t,n){var i=this.attachments[t];if(i)for(var r in i){var o=i[r];o&&n.push(new e(t,r,o))}},n.prototype.clear=function(){this.attachments.length=0,this.bones.length=0,this.constraints.length=0},n.prototype.attachAll=function(t,e){for(var n=0,i=0;i<t.slots.length;i++){var r=t.slots[i],o=r.getAttachment();if(o&&n<e.attachments.length){var a=e.attachments[n];for(var s in a)if(o==a[s]){var c=this.getAttachment(n,s);null!=c&&r.setAttachment(c);break}}n++}},n}();t.Skin=n}(mgt||(mgt={})),function(t){var e=function(){function e(e,n){if(this.deform=new Array,null==e)throw new Error("data cannot be null.");if(null==n)throw new Error("bone cannot be null.");this.data=e,this.bone=n,this.color=new t.Color,this.darkColor=null==e.darkColor?null:new t.Color,this.setToSetupPose()}return e.prototype.getSkeleton=function(){return this.bone.skeleton},e.prototype.getAttachment=function(){return this.attachment},e.prototype.setAttachment=function(t){this.attachment!=t&&(this.attachment=t,this.attachmentTime=this.bone.skeleton.time,this.deform.length=0)},e.prototype.setAttachmentTime=function(t){this.attachmentTime=this.bone.skeleton.time-t},e.prototype.getAttachmentTime=function(){return this.bone.skeleton.time-this.attachmentTime},e.prototype.setToSetupPose=function(){this.color.setFromColor(this.data.color),null!=this.darkColor&&this.darkColor.setFromColor(this.data.darkColor),null==this.data.attachmentName?this.attachment=null:(this.attachment=null,this.setAttachment(this.bone.skeleton.getAttachment(this.data.index,this.data.attachmentName)))},e}();t.Slot=e}(mgt||(mgt={})),function(t){t.SlotData=function(e,n,i){if(this.color=new t.Color(1,1,1,1),e<0)throw new Error("index must be >= 0.");if(null==n)throw new Error("name cannot be null.");if(null==i)throw new Error("boneData cannot be null.");this.index=e,this.name=n,this.boneData=i}}(mgt||(mgt={})),function(t){var e,n,i=function(){function t(t){this._image=t}return t.prototype.getImage=function(){return this._image},t.filterFromString=function(t){switch(t.toLowerCase()){case"nearest":return e.Nearest;case"linear":return e.Linear;case"mipmap":return e.MipMap;case"mipmapnearestnearest":return e.MipMapNearestNearest;case"mipmaplinearnearest":return e.MipMapLinearNearest;case"mipmapnearestlinear":return e.MipMapNearestLinear;case"mipmaplinearlinear":return e.MipMapLinearLinear;default:throw new Error("Unknown texture filter "+t)}},t.wrapFromString=function(t){switch(t.toLowerCase()){case"mirroredtepeat":return n.MirroredRepeat;case"clamptoedge":return n.ClampToEdge;case"repeat":return n.Repeat;default:throw new Error("Unknown texture wrap "+t)}},t}();t.Texture=i,function(t){t[t.Nearest=9728]="Nearest",t[t.Linear=9729]="Linear",t[t.MipMap=9987]="MipMap",t[t.MipMapNearestNearest=9984]="MipMapNearestNearest",t[t.MipMapLinearNearest=9985]="MipMapLinearNearest",t[t.MipMapNearestLinear=9986]="MipMapNearestLinear",t[t.MipMapLinearLinear=9987]="MipMapLinearLinear"}(e=t.TextureFilter||(t.TextureFilter={})),function(t){t[t.MirroredRepeat=33648]="MirroredRepeat",t[t.ClampToEdge=33071]="ClampToEdge",t[t.Repeat=10497]="Repeat"}(n=t.TextureWrap||(t.TextureWrap={}));t.TextureRegion=function(){this.u=0,this.v=0,this.u2=0,this.v2=0,this.width=0,this.height=0,this.rotate=!1,this.offsetX=0,this.offsetY=0,this.originalWidth=0,this.originalHeight=0};var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return vgt(e,t),e.prototype.setFilters=function(){},e.prototype.setWraps=function(){},e.prototype.dispose=function(){},e}(i);t.FakeTexture=r}(mgt||(mgt={})),function(t){var e=function(){function e(t,e){this.pages=new Array,this.regions=new Array,this.load(t,e)}return e.prototype.load=function(e,o){if(null==o)throw new Error("textureLoader cannot be null.");for(var a=new n(e),s=new Array(4),c=null;;){var l=a.readLine();if(null==l)break;if(0==(l=l.trim()).length)c=null;else if(c){var u=new r;u.name=l,u.page=c;var h=a.readValue();"true"==h.toLocaleLowerCase()?u.degrees=90:"false"==h.toLocaleLowerCase()?u.degrees=0:u.degrees=parseFloat(h),u.rotate=90==u.degrees,a.readTuple(s);var f=parseInt(s[0]),p=parseInt(s[1]);a.readTuple(s);var d=parseInt(s[0]),_=parseInt(s[1]);u.u=f/c.width,u.v=p/c.height,u.rotate?(u.u2=(f+_)/c.width,u.v2=(p+d)/c.height):(u.u2=(f+d)/c.width,u.v2=(p+_)/c.height),u.x=f,u.y=p,u.width=Math.abs(d),u.height=Math.abs(_),4==a.readTuple(s)&&4==a.readTuple(s)&&a.readTuple(s),u.originalWidth=parseInt(s[0]),u.originalHeight=parseInt(s[1]),a.readTuple(s),u.offsetX=parseInt(s[0]),u.offsetY=parseInt(s[1]),u.index=parseInt(a.readValue()),u.texture=c.texture,this.regions.push(u)}else{(c=new i).name=l,2==a.readTuple(s)&&(c.width=parseInt(s[0]),c.height=parseInt(s[1]),a.readTuple(s)),a.readTuple(s),c.minFilter=t.Texture.filterFromString(s[0]),c.magFilter=t.Texture.filterFromString(s[1]);var m=a.readValue();c.uWrap=t.TextureWrap.ClampToEdge,c.vWrap=t.TextureWrap.ClampToEdge,"x"==m?c.uWrap=t.TextureWrap.Repeat:"y"==m?c.vWrap=t.TextureWrap.Repeat:"xy"==m&&(c.uWrap=c.vWrap=t.TextureWrap.Repeat),c.texture=o(l),c.texture.setFilters(c.minFilter,c.magFilter),c.texture.setWraps(c.uWrap,c.vWrap),c.width=c.texture.getImage().width,c.height=c.texture.getImage().height,this.pages.push(c)}}},e.prototype.findRegion=function(t){for(var e=0;e<this.regions.length;e++)if(this.regions[e].name==t)return this.regions[e];return null},e.prototype.dispose=function(){for(var t=0;t<this.pages.length;t++)this.pages[t].texture.dispose()},e}();t.TextureAtlas=e;var n=function(){function t(t){this.index=0,this.lines=t.split(/\r\n|\r|\n/)}return t.prototype.readLine=function(){return this.index>=this.lines.length?null:this.lines[this.index++]},t.prototype.readValue=function(){var t=this.readLine(),e=t.indexOf(":");if(-1==e)throw new Error("Invalid line: "+t);return t.substring(e+1).trim()},t.prototype.readTuple=function(t){var e=this.readLine(),n=e.indexOf(":");if(-1==n)throw new Error("Invalid line: "+e);for(var i=0,r=n+1;i<3;i++){var o=e.indexOf(",",r);if(-1==o)break;t[i]=e.substr(r,o-r).trim(),r=o+1}return t[i]=e.substring(r).trim(),i+1},t}(),i=function(){};t.TextureAtlasPage=i;var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return vgt(e,t),e}(t.TextureRegion);t.TextureAtlasRegion=r}(mgt||(mgt={})),function(t){var e=function(){function e(e,n){if(this.rotateMix=0,this.translateMix=0,this.scaleMix=0,this.shearMix=0,this.temp=new t.Vector2,this.active=!1,null==e)throw new Error("data cannot be null.");if(null==n)throw new Error("skeleton cannot be null.");this.data=e,this.rotateMix=e.rotateMix,this.translateMix=e.translateMix,this.scaleMix=e.scaleMix,this.shearMix=e.shearMix,this.bones=new Array;for(var i=0;i<e.bones.length;i++)this.bones.push(n.findBone(e.bones[i].name));this.target=n.findBone(e.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){this.data.local?this.data.relative?this.applyRelativeLocal():this.applyAbsoluteLocal():this.data.relative?this.applyRelativeWorld():this.applyAbsoluteWorld()},e.prototype.applyAbsoluteWorld=function(){for(var e=this.rotateMix,n=this.translateMix,i=this.scaleMix,r=this.shearMix,o=this.target,a=o.a,s=o.b,c=o.c,l=o.d,u=a*l-s*c>0?t.MathUtils.degRad:-t.MathUtils.degRad,h=this.data.offsetRotation*u,f=this.data.offsetShearY*u,p=this.bones,d=0,_=p.length;d<_;d++){var m=p[d],v=!1;if(0!=e){var g=m.a,y=m.b,x=m.c,S=m.d;(w=Math.atan2(c,a)-Math.atan2(x,g)+h)>t.MathUtils.PI?w-=t.MathUtils.PI2:w<-t.MathUtils.PI&&(w+=t.MathUtils.PI2),w*=e;var T=Math.cos(w),E=Math.sin(w);m.a=T*g-E*x,m.b=T*y-E*S,m.c=E*g+T*x,m.d=E*y+T*S,v=!0}if(0!=n){var b=this.temp;o.localToWorld(b.set(this.data.offsetX,this.data.offsetY)),m.worldX+=(b.x-m.worldX)*n,m.worldY+=(b.y-m.worldY)*n,v=!0}if(i>0){var C=Math.sqrt(m.a*m.a+m.c*m.c),A=Math.sqrt(a*a+c*c);C>1e-5&&(C=(C+(A-C+this.data.offsetScaleX)*i)/C),m.a*=C,m.c*=C,C=Math.sqrt(m.b*m.b+m.d*m.d),A=Math.sqrt(s*s+l*l),C>1e-5&&(C=(C+(A-C+this.data.offsetScaleY)*i)/C),m.b*=C,m.d*=C,v=!0}if(r>0){y=m.b,S=m.d;var w,R=Math.atan2(S,y);(w=Math.atan2(l,s)-Math.atan2(c,a)-(R-Math.atan2(m.c,m.a)))>t.MathUtils.PI?w-=t.MathUtils.PI2:w<-t.MathUtils.PI&&(w+=t.MathUtils.PI2),w=R+(w+f)*r,C=Math.sqrt(y*y+S*S),m.b=Math.cos(w)*C,m.d=Math.sin(w)*C,v=!0}v&&(m.appliedValid=!1)}},e.prototype.applyRelativeWorld=function(){for(var e=this.rotateMix,n=this.translateMix,i=this.scaleMix,r=this.shearMix,o=this.target,a=o.a,s=o.b,c=o.c,l=o.d,u=a*l-s*c>0?t.MathUtils.degRad:-t.MathUtils.degRad,h=this.data.offsetRotation*u,f=this.data.offsetShearY*u,p=this.bones,d=0,_=p.length;d<_;d++){var m,v=p[d],g=!1;if(0!=e){var y=v.a,x=v.b,S=v.c,T=v.d;(m=Math.atan2(c,a)+h)>t.MathUtils.PI?m-=t.MathUtils.PI2:m<-t.MathUtils.PI&&(m+=t.MathUtils.PI2),m*=e;var E=Math.cos(m),b=Math.sin(m);v.a=E*y-b*S,v.b=E*x-b*T,v.c=b*y+E*S,v.d=b*x+E*T,g=!0}if(0!=n){var C=this.temp;o.localToWorld(C.set(this.data.offsetX,this.data.offsetY)),v.worldX+=C.x*n,v.worldY+=C.y*n,g=!0}if(i>0){var A=(Math.sqrt(a*a+c*c)-1+this.data.offsetScaleX)*i+1;v.a*=A,v.c*=A,A=(Math.sqrt(s*s+l*l)-1+this.data.offsetScaleY)*i+1,v.b*=A,v.d*=A,g=!0}if(r>0)(m=Math.atan2(l,s)-Math.atan2(c,a))>t.MathUtils.PI?m-=t.MathUtils.PI2:m<-t.MathUtils.PI&&(m+=t.MathUtils.PI2),x=v.b,T=v.d,m=Math.atan2(T,x)+(m-t.MathUtils.PI/2+f)*r,A=Math.sqrt(x*x+T*T),v.b=Math.cos(m)*A,v.d=Math.sin(m)*A,g=!0;g&&(v.appliedValid=!1)}},e.prototype.applyAbsoluteLocal=function(){var t=this.rotateMix,e=this.translateMix,n=this.scaleMix,i=this.shearMix,r=this.target;r.appliedValid||r.updateAppliedTransform();for(var o=this.bones,a=0,s=o.length;a<s;a++){var c=o[a];c.appliedValid||c.updateAppliedTransform();var l=c.arotation;if(0!=t){var u=r.arotation-l+this.data.offsetRotation;l+=(u-=360*(16384-(16384.499999999996-u/360|0)))*t}var h=c.ax,f=c.ay;0!=e&&(h+=(r.ax-h+this.data.offsetX)*e,f+=(r.ay-f+this.data.offsetY)*e);var p=c.ascaleX,d=c.ascaleY;0!=n&&(p>1e-5&&(p=(p+(r.ascaleX-p+this.data.offsetScaleX)*n)/p),d>1e-5&&(d=(d+(r.ascaleY-d+this.data.offsetScaleY)*n)/d));var _=c.ashearY;0!=i&&(u=r.ashearY-_+this.data.offsetShearY,u-=360*(16384-(16384.499999999996-u/360|0)),c.shearY+=u*i),c.updateWorldTransformWith(h,f,l,p,d,c.ashearX,_)}},e.prototype.applyRelativeLocal=function(){var t=this.rotateMix,e=this.translateMix,n=this.scaleMix,i=this.shearMix,r=this.target;r.appliedValid||r.updateAppliedTransform();for(var o=this.bones,a=0,s=o.length;a<s;a++){var c=o[a];c.appliedValid||c.updateAppliedTransform();var l=c.arotation;0!=t&&(l+=(r.arotation+this.data.offsetRotation)*t);var u=c.ax,h=c.ay;0!=e&&(u+=(r.ax+this.data.offsetX)*e,h+=(r.ay+this.data.offsetY)*e);var f=c.ascaleX,p=c.ascaleY;0!=n&&(f>1e-5&&(f*=(r.ascaleX-1+this.data.offsetScaleX)*n+1),p>1e-5&&(p*=(r.ascaleY-1+this.data.offsetScaleY)*n+1));var d=c.ashearY;0!=i&&(d+=(r.ashearY+this.data.offsetShearY)*i),c.updateWorldTransformWith(u,h,l,f,p,c.ashearX,d)}},e}();t.TransformConstraint=e}(mgt||(mgt={})),function(t){var e=function(t){function e(e){var n=t.call(this,e,0,!1)||this;return n.bones=new Array,n.rotateMix=0,n.translateMix=0,n.scaleMix=0,n.shearMix=0,n.offsetRotation=0,n.offsetX=0,n.offsetY=0,n.offsetScaleX=0,n.offsetScaleY=0,n.offsetShearY=0,n.relative=!1,n.local=!1,n}return vgt(e,t),e}(t.ConstraintData);t.TransformConstraintData=e}(mgt||(mgt={})),function(t){var e=function(){function e(){this.convexPolygons=new Array,this.convexPolygonsIndices=new Array,this.indicesArray=new Array,this.isConcaveArray=new Array,this.triangles=new Array,this.polygonPool=new t.Pool((function(){return new Array})),this.polygonIndicesPool=new t.Pool((function(){return new Array}))}return e.prototype.triangulate=function(t){var n=t,i=t.length>>1,r=this.indicesArray;r.length=0;for(var o=0;o<i;o++)r[o]=o;var a=this.isConcaveArray;a.length=0,o=0;for(var s=i;o<s;++o)a[o]=e.isConcave(o,i,n,r);var c=this.triangles;for(c.length=0;i>3;){for(var l=i-1,u=(o=0,1);;){t:if(!a[o]){for(var h=r[l]<<1,f=r[o]<<1,p=r[u]<<1,d=n[h],_=n[h+1],m=n[f],v=n[f+1],g=n[p],y=n[p+1],x=(u+1)%i;x!=l;x=(x+1)%i)if(a[x]){var S=r[x]<<1,T=n[S],E=n[S+1];if(e.positiveArea(g,y,d,_,T,E)&&e.positiveArea(d,_,m,v,T,E)&&e.positiveArea(m,v,g,y,T,E))break t}break}if(0==u){do{if(!a[o])break;o--}while(o>0);break}l=o,o=u,u=(u+1)%i}c.push(r[(i+o-1)%i]),c.push(r[o]),c.push(r[(o+1)%i]),r.splice(o,1),a.splice(o,1);var b=(--i+o-1)%i,C=o==i?0:o;a[b]=e.isConcave(b,i,n,r),a[C]=e.isConcave(C,i,n,r)}return 3==i&&(c.push(r[2]),c.push(r[0]),c.push(r[1])),c},e.prototype.decompose=function(t,n){var i=t,r=this.convexPolygons;this.polygonPool.freeAll(r),r.length=0;var o=this.convexPolygonsIndices;this.polygonIndicesPool.freeAll(o),o.length=0;var a=this.polygonIndicesPool.obtain();a.length=0;var s=this.polygonPool.obtain();s.length=0;for(var c=-1,l=0,u=0,h=n.length;u<h;u+=3){var f=n[u]<<1,p=n[u+1]<<1,d=n[u+2]<<1,_=i[f],m=i[f+1],v=i[p],g=i[p+1],y=i[d],x=i[d+1],S=!1;if(c==f){var T=s.length-4,E=e.winding(s[T],s[T+1],s[T+2],s[T+3],y,x),b=e.winding(y,x,s[0],s[1],s[2],s[3]);E==l&&b==l&&(s.push(y),s.push(x),a.push(d),S=!0)}S||(s.length>0?(r.push(s),o.push(a)):(this.polygonPool.free(s),this.polygonIndicesPool.free(a)),(s=this.polygonPool.obtain()).length=0,s.push(_),s.push(m),s.push(v),s.push(g),s.push(y),s.push(x),(a=this.polygonIndicesPool.obtain()).length=0,a.push(f),a.push(p),a.push(d),l=e.winding(_,m,v,g,y,x),c=f)}for(s.length>0&&(r.push(s),o.push(a)),u=0,h=r.length;u<h;u++)if(0!=(a=o[u]).length)for(var C=a[0],A=a[a.length-1],w=(s=r[u])[T=s.length-4],R=s[T+1],P=s[T+2],I=s[T+3],M=s[0],D=s[1],O=s[2],N=s[3],L=e.winding(w,R,P,I,M,D),B=0;B<h;B++)if(B!=u){var F=o[B];if(3==F.length){var z=F[0],k=F[1],U=F[2],G=r[B];y=G[G.length-2],x=G[G.length-1],z==C&&k==A&&(E=e.winding(w,R,P,I,y,x),b=e.winding(y,x,M,D,O,N),E==L&&b==L&&(G.length=0,F.length=0,s.push(y),s.push(x),a.push(U),w=P,R=I,P=y,I=x,B=0))}}for(u=r.length-1;u>=0;u--)0==(s=r[u]).length&&(r.splice(u,1),this.polygonPool.free(s),a=o[u],o.splice(u,1),this.polygonIndicesPool.free(a));return r},e.isConcave=function(t,e,n,i){var r=i[(e+t-1)%e]<<1,o=i[t]<<1,a=i[(t+1)%e]<<1;return!this.positiveArea(n[r],n[r+1],n[o],n[o+1],n[a],n[a+1])},e.positiveArea=function(t,e,n,i,r,o){return t*(o-i)+n*(e-o)+r*(i-e)>=0},e.winding=function(t,e,n,i,r,o){var a=n-t,s=i-e;return r*s-o*a+a*e-t*s>=0?1:-1},e}();t.Triangulator=e}(mgt||(mgt={})),function(t){var e=function(){function t(){this.array=new Array}return t.prototype.add=function(t){var e=this.contains(t);return this.array[0|t]=0|t,!e},t.prototype.contains=function(t){return null!=this.array[0|t]},t.prototype.remove=function(t){this.array[0|t]=void 0},t.prototype.clear=function(){this.array.length=0},t}();t.IntSet=e;var n=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.r=t,this.g=e,this.b=n,this.a=i}return t.prototype.set=function(t,e,n,i){return this.r=t,this.g=e,this.b=n,this.a=i,this.clamp(),this},t.prototype.setFromColor=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.setFromString=function(t){return t="#"==t.charAt(0)?t.substr(1):t,this.r=parseInt(t.substr(0,2),16)/255,this.g=parseInt(t.substr(2,2),16)/255,this.b=parseInt(t.substr(4,2),16)/255,this.a=(8!=t.length?255:parseInt(t.substr(6,2),16))/255,this},t.prototype.add=function(t,e,n,i){return this.r+=t,this.g+=e,this.b+=n,this.a+=i,this.clamp(),this},t.prototype.clamp=function(){return this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1),this},t.rgba8888ToColor=function(t,e){t.r=((4278190080&e)>>>24)/255,t.g=((16711680&e)>>>16)/255,t.b=((65280&e)>>>8)/255,t.a=(255&e)/255},t.rgb888ToColor=function(t,e){t.r=((16711680&e)>>>16)/255,t.g=((65280&e)>>>8)/255,t.b=(255&e)/255},t.WHITE=new t(1,1,1,1),t.RED=new t(1,0,0,1),t.GREEN=new t(0,1,0,1),t.BLUE=new t(0,0,1,1),t.MAGENTA=new t(1,0,1,1),t}();t.Color=n;var i=function(){function t(){}return t.clamp=function(t,e,n){return t<e?e:t>n?n:t},t.cosDeg=function(e){return Math.cos(e*t.degRad)},t.sinDeg=function(e){return Math.sin(e*t.degRad)},t.signum=function(t){return t>0?1:t<0?-1:0},t.toInt=function(t){return t>0?Math.floor(t):Math.ceil(t)},t.cbrt=function(t){var e=Math.pow(Math.abs(t),1/3);return t<0?-e:e},t.randomTriangular=function(e,n){return t.randomTriangularWith(e,n,.5*(e+n))},t.randomTriangularWith=function(t,e,n){var i=Math.random(),r=e-t;return i<=(n-t)/r?t+Math.sqrt(i*r*(n-t)):e-Math.sqrt((1-i)*r*(e-n))},t.PI=3.1415927,t.PI2=2*t.PI,t.radiansToDegrees=180/t.PI,t.radDeg=t.radiansToDegrees,t.degreesToRadians=t.PI/180,t.degRad=t.degreesToRadians,t}();t.MathUtils=i;var r=function(){function t(){}return t.prototype.apply=function(t,e,n){return t+(e-t)*this.applyInternal(n)},t}();t.Interpolation=r;var o=function(t){function e(e){var n=t.call(this)||this;return n.power=2,n.power=e,n}return vgt(e,t),e.prototype.applyInternal=function(t){return t<=.5?Math.pow(2*t,this.power)/2:Math.pow(2*(t-1),this.power)/(this.power%2==0?-2:2)+1},e}(r);t.Pow=o;var a=function(t){function e(e){return t.call(this,e)||this}return vgt(e,t),e.prototype.applyInternal=function(t){return Math.pow(t-1,this.power)*(this.power%2==0?-1:1)+1},e}(o);t.PowOut=a;var s=function(){function t(){}return t.arrayCopy=function(t,e,n,i,r){for(var o=e,a=i;o<e+r;o++,a++)n[a]=t[o]},t.setArraySize=function(t,e,n){void 0===n&&(n=0);var i=t.length;if(i==e)return t;if(t.length=e,i<e)for(var r=i;r<e;r++)t[r]=n;return t},t.ensureArrayCapacity=function(e,n,i){return void 0===i&&(i=0),e.length>=n?e:t.setArraySize(e,n,i)},t.newArray=function(t,e){for(var n=new Array(t),i=0;i<t;i++)n[i]=e;return n},t.newFloatArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Float32Array(e);for(var n=new Array(e),i=0;i<n.length;i++)n[i]=0;return n},t.newShortArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Int16Array(e);for(var n=new Array(e),i=0;i<n.length;i++)n[i]=0;return n},t.toFloatArray=function(e){return t.SUPPORTS_TYPED_ARRAYS?new Float32Array(e):e},t.toSinglePrecision=function(e){return t.SUPPORTS_TYPED_ARRAYS?Math.fround(e):e},t.webkit602BugfixHelper=function(){},t.contains=function(t,e){for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1},t.SUPPORTS_TYPED_ARRAYS="undefined"!=typeof Float32Array,t}();t.Utils=s;var c=function(){function t(){}return t.logBones=function(t){for(var e=0;e<t.bones.length;e++){var n=t.bones[e];console.log(n.data.name+", "+n.a+", "+n.b+", "+n.c+", "+n.d+", "+n.worldX+", "+n.worldY)}},t}();t.DebugUtils=c;var l=function(){function t(t){this.items=new Array,this.instantiator=t}return t.prototype.obtain=function(){return this.items.length>0?this.items.pop():this.instantiator()},t.prototype.free=function(t){t.reset&&t.reset(),this.items.push(t)},t.prototype.freeAll=function(t){for(var e=0;e<t.length;e++)t[e].reset&&t[e].reset(),this.items[e]=t[e]},t.prototype.clear=function(){this.items.length=0},t}();t.Pool=l;var u=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.set=function(t,e){return this.x=t,this.y=e,this},t.prototype.length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},t.prototype.normalize=function(){var t=this.length();return 0!=t&&(this.x/=t,this.y/=t),this},t}();t.Vector2=u;var h=function(){function t(){this.maxDelta=.064,this.framesPerSecond=0,this.delta=0,this.totalTime=0,this.lastTime=Date.now()/1e3,this.frameCount=0,this.frameTime=0}return t.prototype.update=function(){var t=Date.now()/1e3;this.delta=t-this.lastTime,this.frameTime+=this.delta,this.totalTime+=this.delta,this.delta>this.maxDelta&&(this.delta=this.maxDelta),this.lastTime=t,this.frameCount++,this.frameTime>1&&(this.framesPerSecond=this.frameCount/this.frameTime,this.frameTime=0,this.frameCount=0)},t}();t.TimeKeeper=h;var f=function(){function t(t){void 0===t&&(t=32),this.addedValues=0,this.lastValue=0,this.mean=0,this.dirty=!0,this.values=new Array(t)}return t.prototype.hasEnoughData=function(){return this.addedValues>=this.values.length},t.prototype.addValue=function(t){this.addedValues<this.values.length&&this.addedValues++,this.values[this.lastValue++]=t,this.lastValue>this.values.length-1&&(this.lastValue=0),this.dirty=!0},t.prototype.getMean=function(){if(this.hasEnoughData()){if(this.dirty){for(var t=0,e=0;e<this.values.length;e++)t+=this.values[e];this.mean=t/this.values.length,this.dirty=!1}return this.mean}return 0},t}();t.WindowedMean=f}(mgt||(mgt={})),Math.fround||(Math.fround=function(t){return function(e){return t[0]=e,t[0]}}(new Float32Array(1))),function(t){var e=function(t){if(null==t)throw new Error("name cannot be null.");this.name=t};t.Attachment=e;var n=function(e){function n(t){var i=e.call(this,t)||this;return i.id=(65535&n.nextID++)<<11,i.worldVerticesLength=0,i.deformAttachment=i,i}return vgt(n,e),n.prototype.computeWorldVertices=function(t,e,n,i,r,o){n=r+(n>>1)*o;var a=t.bone.skeleton,s=t.deform,c=this.vertices,l=this.bones;if(null!=l){for(var u=0,h=0,f=0;f<e;f+=2)u+=(m=l[u])+1,h+=m;var p=a.bones;if(0==s.length)for(R=r,b=3*h;R<n;R+=o){var d=0,_=0,m=l[u++];for(m+=u;u<m;u++,b+=3){x=p[l[u]],P=c[b],I=c[b+1];var v=c[b+2];d+=(P*x.a+I*x.b+x.worldX)*v,_+=(P*x.c+I*x.d+x.worldY)*v}i[R]=d,i[R+1]=_}else for(var g=s,y=(R=r,b=3*h,h<<1);R<n;R+=o){for(d=0,_=0,m=l[u++],m+=u;u<m;u++,b+=3,y+=2)x=p[l[u]],P=c[b]+g[y],I=c[b+1]+g[y+1],v=c[b+2],d+=(P*x.a+I*x.b+x.worldX)*v,_+=(P*x.c+I*x.d+x.worldY)*v;i[R]=d,i[R+1]=_}}else{s.length>0&&(c=s);for(var x,S=(x=t.bone).worldX,T=x.worldY,E=x.a,b=x.b,C=x.c,A=x.d,w=e,R=r;R<n;w+=2,R+=o){var P=c[w],I=c[w+1];i[R]=P*E+I*b+S,i[R+1]=P*C+I*A+T}}},n.prototype.copyTo=function(e){null!=this.bones?(e.bones=new Array(this.bones.length),t.Utils.arrayCopy(this.bones,0,e.bones,0,this.bones.length)):e.bones=null,null!=this.vertices?(e.vertices=t.Utils.newFloatArray(this.vertices.length),t.Utils.arrayCopy(this.vertices,0,e.vertices,0,this.vertices.length)):e.vertices=null,e.worldVerticesLength=this.worldVerticesLength,e.deformAttachment=this.deformAttachment},n.nextID=0,n}(e);t.VertexAttachment=n}(mgt||(mgt={})),function(t){var e;(e=t.AttachmentType||(t.AttachmentType={}))[e.Region=0]="Region",e[e.BoundingBox=1]="BoundingBox",e[e.Mesh=2]="Mesh",e[e.LinkedMesh=3]="LinkedMesh",e[e.Path=4]="Path",e[e.Point=5]="Point",e[e.Clipping=6]="Clipping"}(mgt||(mgt={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.color=new t.Color(1,1,1,1),i}return vgt(n,e),n.prototype.copy=function(){var t=new n(name);return this.copyTo(t),t.color.setFromColor(this.color),t},n}(t.VertexAttachment);t.BoundingBoxAttachment=e}(mgt||(mgt={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.color=new t.Color(.2275,.2275,.8078,1),i}return vgt(n,e),n.prototype.copy=function(){var t=new n(name);return this.copyTo(t),t.endSlot=this.endSlot,t.color.setFromColor(this.color),t},n}(t.VertexAttachment);t.ClippingAttachment=e}(mgt||(mgt={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.color=new t.Color(1,1,1,1),i.tempColor=new t.Color(0,0,0,0),i}return vgt(n,e),n.prototype.updateUVs=function(){var e=this.regionUVs;null!=this.uvs&&this.uvs.length==e.length||(this.uvs=t.Utils.newFloatArray(e.length));var n=this.uvs,i=this.uvs.length,r=this.region.u,o=this.region.v,a=0,s=0;if(this.region instanceof t.TextureAtlasRegion){var c=this.region,l=c.texture.getImage().width,u=c.texture.getImage().height;switch(c.degrees){case 90:r-=(c.originalHeight-c.offsetY-c.height)/l,o-=(c.originalWidth-c.offsetX-c.width)/u,a=c.originalHeight/l,s=c.originalWidth/u;for(var h=0;h<i;h+=2)n[h]=r+e[h+1]*a,n[h+1]=o+(1-e[h])*s;return;case 180:for(r-=(c.originalWidth-c.offsetX-c.width)/l,o-=c.offsetY/u,a=c.originalWidth/l,s=c.originalHeight/u,h=0;h<i;h+=2)n[h]=r+(1-e[h])*a,n[h+1]=o+(1-e[h+1])*s;return;case 270:for(r-=c.offsetY/l,o-=c.offsetX/u,a=c.originalHeight/l,s=c.originalWidth/u,h=0;h<i;h+=2)n[h]=r+(1-e[h+1])*a,n[h+1]=o+e[h]*s;return}r-=c.offsetX/l,o-=(c.originalHeight-c.offsetY-c.height)/u,a=c.originalWidth/l,s=c.originalHeight/u}else null==this.region?(r=o=0,a=s=1):(a=this.region.u2-r,s=this.region.v2-o);for(h=0;h<i;h+=2)n[h]=r+e[h]*a,n[h+1]=o+e[h+1]*s},n.prototype.getParentMesh=function(){return this.parentMesh},n.prototype.setParentMesh=function(t){this.parentMesh=t,null!=t&&(this.bones=t.bones,this.vertices=t.vertices,this.worldVerticesLength=t.worldVerticesLength,this.regionUVs=t.regionUVs,this.triangles=t.triangles,this.hullLength=t.hullLength,this.worldVerticesLength=t.worldVerticesLength)},n.prototype.copy=function(){if(null!=this.parentMesh)return this.newLinkedMesh();var e=new n(this.name);return e.region=this.region,e.path=this.path,e.color.setFromColor(this.color),this.copyTo(e),e.regionUVs=new Array(this.regionUVs.length),t.Utils.arrayCopy(this.regionUVs,0,e.regionUVs,0,this.regionUVs.length),e.uvs=new Array(this.uvs.length),t.Utils.arrayCopy(this.uvs,0,e.uvs,0,this.uvs.length),e.triangles=new Array(this.triangles.length),t.Utils.arrayCopy(this.triangles,0,e.triangles,0,this.triangles.length),e.hullLength=this.hullLength,null!=this.edges&&(e.edges=new Array(this.edges.length),t.Utils.arrayCopy(this.edges,0,e.edges,0,this.edges.length)),e.width=this.width,e.height=this.height,e},n.prototype.newLinkedMesh=function(){var t=new n(this.name);return t.region=this.region,t.path=this.path,t.color.setFromColor(this.color),t.deformAttachment=this.deformAttachment,t.setParentMesh(null!=this.parentMesh?this.parentMesh:this),t.updateUVs(),t},n}(t.VertexAttachment);t.MeshAttachment=e}(mgt||(mgt={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.closed=!1,i.constantSpeed=!1,i.color=new t.Color(1,1,1,1),i}return vgt(n,e),n.prototype.copy=function(){var e=new n(name);return this.copyTo(e),e.lengths=new Array(this.lengths.length),t.Utils.arrayCopy(this.lengths,0,e.lengths,0,this.lengths.length),e.closed=closed,e.constantSpeed=this.constantSpeed,e.color.setFromColor(this.color),e},n}(t.VertexAttachment);t.PathAttachment=e}(mgt||(mgt={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.color=new t.Color(.38,.94,0,1),i}return vgt(n,e),n.prototype.computeWorldPosition=function(t,e){return e.x=this.x*t.a+this.y*t.b+t.worldX,e.y=this.x*t.c+this.y*t.d+t.worldY,e},n.prototype.computeWorldRotation=function(e){var n=t.MathUtils.cosDeg(this.rotation),i=t.MathUtils.sinDeg(this.rotation),r=n*e.a+i*e.b,o=n*e.c+i*e.d;return Math.atan2(o,r)*t.MathUtils.radDeg},n.prototype.copy=function(){var t=new n(name);return t.x=this.x,t.y=this.y,t.rotation=this.rotation,t.color.setFromColor(this.color),t},n}(t.VertexAttachment);t.PointAttachment=e}(mgt||(mgt={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.x=0,i.y=0,i.scaleX=1,i.scaleY=1,i.rotation=0,i.width=0,i.height=0,i.color=new t.Color(1,1,1,1),i.offset=t.Utils.newFloatArray(8),i.uvs=t.Utils.newFloatArray(8),i.tempColor=new t.Color(1,1,1,1),i}return vgt(n,e),n.prototype.updateOffset=function(){var t=this.width/this.region.originalWidth*this.scaleX,e=this.height/this.region.originalHeight*this.scaleY,i=-this.width/2*this.scaleX+this.region.offsetX*t,r=-this.height/2*this.scaleY+this.region.offsetY*e,o=i+this.region.width*t,a=r+this.region.height*e,s=this.rotation*Math.PI/180,c=Math.cos(s),l=Math.sin(s),u=i*c+this.x,h=i*l,f=r*c+this.y,p=r*l,d=o*c+this.x,_=o*l,m=a*c+this.y,v=a*l,g=this.offset;g[n.OX1]=u-p,g[n.OY1]=f+h,g[n.OX2]=u-v,g[n.OY2]=m+h,g[n.OX3]=d-v,g[n.OY3]=m+_,g[n.OX4]=d-p,g[n.OY4]=f+_},n.prototype.setRegion=function(t){this.region=t;var e=this.uvs;t.rotate?(e[2]=t.u,e[3]=t.v2,e[4]=t.u,e[5]=t.v,e[6]=t.u2,e[7]=t.v,e[0]=t.u2,e[1]=t.v2):(e[0]=t.u,e[1]=t.v2,e[2]=t.u,e[3]=t.v,e[4]=t.u2,e[5]=t.v,e[6]=t.u2,e[7]=t.v2)},n.prototype.computeWorldVertices=function(t,e,i,r){var o=this.offset,a=t.worldX,s=t.worldY,c=t.a,l=t.b,u=t.c,h=t.d,f=0,p=0;f=o[n.OX1],p=o[n.OY1],e[i]=f*c+p*l+a,e[i+1]=f*u+p*h+s,i+=r,f=o[n.OX2],p=o[n.OY2],e[i]=f*c+p*l+a,e[i+1]=f*u+p*h+s,i+=r,f=o[n.OX3],p=o[n.OY3],e[i]=f*c+p*l+a,e[i+1]=f*u+p*h+s,i+=r,f=o[n.OX4],p=o[n.OY4],e[i]=f*c+p*l+a,e[i+1]=f*u+p*h+s},n.prototype.copy=function(){var e=new n(name);return e.region=this.region,e.rendererObject=this.rendererObject,e.path=this.path,e.x=this.x,e.y=this.y,e.scaleX=this.scaleX,e.scaleY=this.scaleY,e.rotation=this.rotation,e.width=this.width,e.height=this.height,t.Utils.arrayCopy(this.uvs,0,e.uvs,0,8),t.Utils.arrayCopy(this.offset,0,e.offset,0,8),e.color.setFromColor(this.color),e},n.OX1=0,n.OY1=1,n.OX2=2,n.OY2=3,n.OX3=4,n.OY3=5,n.OX4=6,n.OY4=7,n.X1=0,n.Y1=1,n.C1R=2,n.C1G=3,n.C1B=4,n.C1A=5,n.U1=6,n.V1=7,n.X2=8,n.Y2=9,n.C2R=10,n.C2G=11,n.C2B=12,n.C2A=13,n.U2=14,n.V2=15,n.X3=16,n.Y3=17,n.C3R=18,n.C3G=19,n.C3B=20,n.C3A=21,n.U3=22,n.V3=23,n.X4=24,n.Y4=25,n.C4R=26,n.C4G=27,n.C4B=28,n.C4A=29,n.U4=30,n.V4=31,n}(t.Attachment);t.RegionAttachment=e}(mgt||(mgt={})),function(t){var e=function(){function e(t,e){this.jitterX=0,this.jitterY=0,this.jitterX=t,this.jitterY=e}return e.prototype.begin=function(){},e.prototype.transform=function(e){e.x+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY),e.y+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY)},e.prototype.end=function(){},e}();t.JitterEffect=e}(mgt||(mgt={})),function(t){var e=function(){function e(t,e){this.centerX=0,this.centerY=0,this.radius=0,this.angle=0,this.worldX=0,this.worldY=0,this.radius=t,this.interpolation=e}return e.prototype.begin=function(t){this.worldX=t.x+this.centerX,this.worldY=t.y+this.centerY},e.prototype.transform=function(e){var n=this.angle*t.MathUtils.degreesToRadians,i=e.x-this.worldX,r=e.y-this.worldY,o=Math.sqrt(i*i+r*r);if(o<this.radius){var a=this.interpolation.apply(0,n,(this.radius-o)/this.radius),s=Math.cos(a),c=Math.sin(a);e.x=s*i-c*r+this.worldX,e.y=c*i+s*r+this.worldY}},e.prototype.end=function(){},e.interpolation=new t.PowOut(2),e}();t.SwirlEffect=e}(mgt||(mgt={}));var ggt,ygt,xgt,Sgt,Tgt,Egt,bgt=mgt,Cgt=function(){function t(){this.start=void 0,this.interrupt=void 0,this.end=void 0,this.dispose=void 0,this.complete=void 0,this.event=void 0}return t.getListeners=function(e){return e.listener||(e.listener=new t),e.listener},t}(),Agt=1/60,wgt=[],Rgt=[],Pgt=0,Igt=0,Mgt=0,Dgt=null,Ogt=null,Ngt=0,Lgt=0,Bgt=0,Fgt=0,zgt=null,kgt=null,Ugt=0,Ggt=0,Hgt=new bgt.Color(1,1,1,1),Vgt=new bgt.Color(1,1,1,1),Wgt=[0,1,2,2,3,0],jgt=function(){function t(){this.frames=[],this.totalTime=0,this.isCompleted=!1,this.maxVertexCount=0,this.maxIndexCount=0,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this._frameIdx=-1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this._frameIdx=-1,this.isCompleted=!1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}var e=t.prototype;return e.init=function(t,e){this._inited=!0,this._animationName=e,this._skeletonInfo=t},e.clear=function(){this._inited=!1;for(var t=0,e=this.frames.length;t<e;t++)this.frames[t].segments.length=0;this.invalidAllFrame()},e.bind=function(t){var e=this;t.complete=function(t){t&&t.animation.name===e._animationName&&(e.isCompleted=!0)}},e.unbind=function(t){t.complete=null},e.begin=function(){if(this._invalid){var t=this._skeletonInfo,e=null==t?void 0:t.curAnimationCache;e&&e!==this&&(this._privateMode?e.invalidAllFrame():e.updateToFrame());var n=null==t?void 0:t.skeleton,i=null==t?void 0:t.listener,r=null==t?void 0:t.state,o=null==n?void 0:n.data.findAnimation(this._animationName);null==r||r.setAnimationWith(0,o,!1),this.bind(i),t.curAnimationCache=this,this._frameIdx=-1,this.isCompleted=!1,this.totalTime=0,this._invalid=!1}},e.end=function(){this.needToUpdate()||(this._skeletonInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0,this.unbind(this._skeletonInfo.listener))},e.updateToFrame=function(t){if(this._inited&&(this.begin(),this.needToUpdate(t))){var e=this._skeletonInfo,n=null==e?void 0:e.skeleton,i=null==e?void 0:e.clipper,r=null==e?void 0:e.state;do{null==n||n.update(Agt),null==r||r.update(Agt),null==r||r.apply(n),null==n||n.updateWorldTransform(),this._frameIdx++,this.updateFrame(n,i,this._frameIdx),this.totalTime+=Agt}while(this.needToUpdate(t));this.end()}},e.isInited=function(){return this._inited},e.isInvalid=function(){return this._invalid},e.invalidAllFrame=function(){this.isCompleted=!1,this._invalid=!0},e.updateAllFrame=function(){this.invalidAllFrame(),this.updateToFrame()},e.enableCacheAttachedInfo=function(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())},e.fillVertices=function(t,e,n,i,r){if(Sgt=n.a*e.a*t.a*255,ggt=e.r*t.r*255,ygt=e.g*t.g*255,xgt=e.b*t.b*255,Hgt.r=ggt*n.r,Hgt.g=ygt*n.g,Hgt.b=xgt*n.b,Hgt.a=Sgt,null==r.darkColor?Vgt.set(0,0,0,1):(Vgt.r=r.darkColor.r*ggt,Vgt.g=r.darkColor.g*ygt,Vgt.b=r.darkColor.b*xgt),Vgt.a=0,Tgt=(Hgt.a<<24>>>0)+(Hgt.b<<16)+(Hgt.g<<8)+Hgt.r,Egt=(Vgt.a<<24>>>0)+(Vgt.b<<16)+(Vgt.g<<8)+Vgt.r,zgt!==Tgt||kgt!==Egt){var o=this._tempColors;zgt=Tgt,kgt=Egt,Fgt>0&&(o[Fgt-1].vfOffset=Mgt),o[Fgt++]={fr:Hgt.r,fg:Hgt.g,fb:Hgt.b,fa:Hgt.a,dr:Vgt.r,dg:Vgt.g,db:Vgt.b,da:Vgt.a,vfOffset:0}}if(i.isClipping()){i.clipTriangles(wgt,Ugt,Rgt,Ggt,wgt,Hgt,Vgt,!0,6,Mgt,Mgt+2);var a=i.clippedVertices,s=i.clippedTriangles;Ggt=s.length,Ugt=a.length/12*6;for(var c=0,l=Igt,u=s.length;c<u;)Rgt[l++]=s[c++];for(var h=0,f=a.length,p=Mgt;h<f;h+=12,p+=6)wgt[p]=a[h],wgt[p+1]=a[h+1],wgt[p+2]=a[h+6],wgt[p+3]=a[h+7],wgt[p+4]=Tgt,wgt[p+5]=Egt}else for(var d=Mgt,_=Mgt+Ugt;d<_;d+=6)wgt[d+4]=Tgt,wgt[d+5]=Egt},e.updateFrame=function(t,e,n){Mgt=0,Pgt=0,Igt=0,Dgt=null,Ogt=null,Ngt=0,Lgt=0,Bgt=0,Fgt=0,zgt=null,kgt=null,this.frames[n]=this.frames[n]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};var i=this.frames[n],r=this._tempSegments=i.segments,o=this._tempColors=i.colors,a=this._tempBoneInfos=i.boneInfos;this.traverseSkeleton(t,e),Fgt>0&&(o[Fgt-1].vfOffset=Mgt),o.length=Fgt,a.length=Pgt;var s=Bgt-1;if(s>=0)if(Lgt>0){var c=r[s];c.indexCount=Lgt,c.vfCount=13*Ngt,c.vertexCount=Ngt,r.length=Bgt}else r.length=Bgt-1;if(0!==r.length){var l=i.vertices,u=Mgt/6,h=13*u;(!l||l.length<h)&&(l=i.vertices=new Float32Array(h));for(var f=0,p=0;f<h;)l[f]=wgt[p++],l[f+1]=wgt[p++],l[f+3]=wgt[p++],l[f+4]=wgt[p++],this._setVerticeColor(wgt[p++],l,f+5),this._setVerticeColor(wgt[p++],l,f+9),f+=13;var d=i.indices;(!d||d.length<Igt)&&(d=i.indices=new Uint16Array(Igt));for(var _=0;_<Igt;_++)d[_]=Rgt[_];i.vertices=l,i.indices=d,this.maxVertexCount=u>this.maxVertexCount?u:this.maxVertexCount,this.maxIndexCount=d.length>this.maxIndexCount?d.length:this.maxIndexCount}},e.needToUpdate=function(t){return!this.isCompleted&&this.totalTime<30&&(void 0===t||this._frameIdx<t)},e.traverseSkeleton=function(t,e){var n,i,r,o,a,s,c,l,u,h,f,p,d=this._tempSegments,_=this._tempBoneInfos,m=t.color,v=t.bones;if(this._enableCacheAttachedInfo)for(var g=0,y=v.length;g<y;g++,Pgt++){var x=v[g],S=_[Pgt];S||(S=_[Pgt]={}),S.a=x.a,S.b=x.b,S.c=x.c,S.d=x.d,S.worldX=x.worldX,S.worldY=x.worldY}for(var T=0,E=t.drawOrder.length;T<E;T++)if(p=t.drawOrder[T],Ugt=0,Ggt=0,n=p.getAttachment())if(s=n instanceof bgt.RegionAttachment,c=n instanceof bgt.MeshAttachment,n instanceof bgt.ClippingAttachment)e.clipStart(p,n);else if(s||c)if(l=n.region.texture.getRealTexture()){if(f=p.data.blendMode,Dgt===l.getId()&&Ogt===f||(Dgt=l.getId(),Ogt=f,(u=Bgt-1)>=0&&(Lgt>0?((h=d[u]).indexCount=Lgt,h.vertexCount=Ngt,h.vfCount=13*Ngt):Bgt--),d[Bgt]={tex:l,blendMode:f,indexCount:0,vertexCount:0,vfCount:0},Bgt++,Lgt=0,Ngt=0),s)a=Wgt,Ugt=24,Ggt=6,n.computeWorldVertices(p.bone,wgt,Mgt,6);else if(c){var b=n;a=b.triangles,Ugt=6*(b.worldVerticesLength>>1),Ggt=a.length,b.computeWorldVertices(p,0,b.worldVerticesLength,wgt,Mgt,6)}if(0!==Ugt&&0!==Ggt){for(var C=0,A=Igt,w=a.length;C<w;)Rgt[A++]=a[C++];o=n.uvs;for(var R=Mgt,P=Mgt+Ugt,I=0;R<P;R+=6,I+=2)wgt[R+2]=o[I],wgt[R+3]=o[I+1];if(i=n.color,r=p.color,this.fillVertices(m,i,r,e,p),Ggt>0){for(var M=Igt,D=Igt+Ggt;M<D;M++)Rgt[M]+=Ngt;Igt+=Ggt,Mgt+=Ugt,Lgt+=Ggt,Ngt+=Ugt/6}e.clipEndWithSlot(p)}else e.clipEndWithSlot(p)}else e.clipEndWithSlot(p);else e.clipEndWithSlot(p);else e.clipEndWithSlot(p);e.clipEnd()},e._setVerticeColor=function(t,e,n){e[n]=(255&t)/255,e[n+1]=(t>>8&255)/255,e[n+2]=(t>>16&255)/255,e[n+3]=(t>>24&255)/255},t}(),qgt=function(){function t(){this._privateMode=void 0,this._skeletonCache=void 0,this._animationPool=void 0,this._privateMode=!1,this._animationPool={},this._skeletonCache={}}var e=t.prototype;return e.enablePrivateMode=function(){this._privateMode=!0},e.clear=function(){this._animationPool={},this._skeletonCache={}},e.removeSkeleton=function(t){var e=this._skeletonCache[t];if(e){var n=e.animationsCache;for(var i in n){var r=n[i];r&&(this._animationPool[t+"#"+i]=r,r.clear())}delete this._skeletonCache[t]}},e.getSkeletonCache=function(t,e){var n=this._skeletonCache[t];if(!n){var i=new bgt.Skeleton(e),r=new bgt.SkeletonClipping,o=new bgt.AnimationStateData(i.data),a=new bgt.AnimationState(o),s=new Cgt;a.addListener(s),this._skeletonCache[t]=n={skeleton:i,clipper:r,state:a,listener:s,animationsCache:{},curAnimationCache:null}}return n},e.getAnimationCache=function(t,e){var n=this._skeletonCache[t];return n?n.animationsCache[e]:null},e.invalidAnimationCache=function(t){var e=this._skeletonCache[t];if(e&&e.skeleton){var n=e.animationsCache;for(var i in n)n[i].invalidAllFrame()}},e.initAnimationCache=function(t,e){if(!e)return null;var n=this._skeletonCache[t],i=n&&n.skeleton;if(!i)return null;if(!i.data.findAnimation(e))return null;var r=n.animationsCache,o=r[e];if(!o){var a=t+"#"+e;(o=this._animationPool[a])?delete this._animationPool[a]:(o=new jgt)._privateMode=this._privateMode,o.init(n,e),r[e]=o}return o},e.updateAnimationCache=function(t,e){if(e){var n=this.initAnimationCache(t,e);if(!n)return;n.updateAllFrame()}else{var i=this._skeletonCache[t];if(!i||!i.skeleton)return;var r=i.animationsCache;for(var o in r)r[o].updateAllFrame()}},t}();qgt.FrameTime=Agt,qgt.sharedCache=new qgt;var Xgt,Ygt,Kgt,Qgt,Zgt,Jgt,$gt,tyt,eyt,nyt,iyt,ryt=new Vn,oyt=new Rn,ayt=function(){function t(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null,this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null}var e=t.prototype;return e.init=function(t){this._inited=!0,this._skeleton=t._skeleton,this._skeletonNode=t.node,this._skeletonComp=t},e.reset=function(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null},e._syncAttachedNode=function(){if(this._inited){var t=this._skeletonComp.socketNodes;if(0!==t.size){var e;if(e=this._skeletonComp.isAnimationCached()?this._skeletonComp._curFrame&&this._skeletonComp._curFrame.boneInfos:this._skeleton.bones)for(var n,i=function(t,e){oyt.set(t.scale);var n=ryt;n.m00=e.a,n.m01=e.c,n.m04=e.b,n.m05=e.d,n.m12=e.worldX,n.m13=e.worldY,t.matrix=ryt,t.scale=oyt},r=st(t.keys());!(n=r()).done;){var o=n.value,a=t.get(o);if(a&&a.isValid){var s=e[o];s?i(a,s):(a.removeFromParent(),a.destroy(),t.delete(o))}else t.delete(o)}}}},t}(),syt=function(t){function e(e){var n;return(n=t.call(this,e)||this).name="sp.SkeletonTexture",n._texture=null,n._material=null,n}$(e,t);var n=e.prototype;return n.setRealTexture=function(t){this._texture=t},n.getRealTexture=function(){return this._texture},n.setFilters=function(t,e){this._texture&&this.getRealTexture().setFilters(cyt(t),cyt(e))},n.setWraps=function(t,e){this._texture&&this.getRealTexture().setWrapMode(lyt(t),lyt(e))},n.dispose=function(){},e}(bgt.Texture);function cyt(t){switch(t){case bgt.TextureFilter.Nearest:case bgt.TextureFilter.MipMapNearestNearest:case bgt.TextureFilter.MipMapLinearNearest:return Om.NEAREST;case bgt.TextureFilter.MipMap:case bgt.TextureFilter.MipMapNearestLinear:case bgt.TextureFilter.MipMapLinearLinear:case bgt.TextureFilter.Linear:default:return Om.LINEAR}}function lyt(t){switch(t){case bgt.TextureWrap.MirroredRepeat:return Dm.MIRRORED_REPEAT;case bgt.TextureWrap.ClampToEdge:return Dm.CLAMP_TO_EDGE;case bgt.TextureWrap.Repeat:default:return Dm.REPEAT}}var uyt=(Xgt=dc("sp.SkeletonData"),Ygt=Kc([Ev]),Kgt=Kc([Le]),Xgt((iyt=function(t){function e(){var e;return ct(e=t.call(this)||this,"_skeletonJson",Jgt,ot(e)),ct(e,"textures",$gt,ot(e)),ct(e,"textureNames",tyt,ot(e)),ct(e,"scale",eyt,ot(e)),ct(e,"_atlasText",nyt,ot(e)),e._buffer=void 0,e._skeletonCache=null,e._atlasCache=null,e._skinsEnum=null,e._animsEnum=null,e.reset(),e}$(e,t);var n=e.prototype;return n.createNode=function(t){var e=new WC(this.name);return e.addComponent("cc.Skeleton").skeletonData=this,t(null,e)},n.reset=function(){this._skeletonCache=null,this._atlasCache=null},n.resetEnums=function(){},n.getRuntimeData=function(t){if(this._skeletonCache)return this._skeletonCache;if(!(this.textures&&this.textures.length>0)&&this.textureNames&&this.textureNames.length>0)return t||console.error(this.name+" no textures found!"),null;var e=this._getAtlas(t);if(!e)return null;var n=new bgt.AtlasAttachmentLoader(e),i=null,r=null;return this.skeletonJson?(r=new bgt.SkeletonJson(n),i=this.skeletonJson):(r=new bgt.SkeletonBinary(n),i=new Uint8Array(this._nativeAsset)),r.scale=this.scale,this._skeletonCache=r.readSkeletonData(i),e.dispose(),this._skeletonCache},n.getSkinsEnum=function(){if(this._skinsEnum)return this._skinsEnum;var t=this.getRuntimeData(!0);if(t){for(var e=t.skins,n={},i=0;i<e.length;i++)n[e[i].name]=i;return this._skinsEnum=oe(n)}return null},n.getAnimsEnum=function(){if(this._animsEnum&&Object.keys(this._animsEnum).length>1)return this._animsEnum;var t=this.getRuntimeData(!0);if(t){for(var e={"<None>":0},n=t.animations,i=0;i<n.length;i++)e[n[i].name]=i+1;return this._animsEnum=oe(e)}return null},n.destroy=function(){return qgt.sharedCache.removeSkeleton(this._uuid),t.prototype.destroy.call(this)},n._getTexture=function(t){for(var e=this.textureNames,n=0;n<e.length;n++)if(e[n]===t){var i=this.textures[n],r=new syt({width:i.width,height:i.height});return r.setRealTexture(i),r}return console.error(this.name+" no textures found!"),null},n._getAtlas=function(t){return this._atlasCache?this._atlasCache:this.atlasText?this._atlasCache=new bgt.TextureAtlas(this.atlasText,this._getTexture.bind(this)):(t||console.error(this.name+" no atlas found!"),null)},Z(e,[{key:"skeletonJsonStr",get:function(){return this._skeletonJson?JSON.stringify(this._skeletonJson):""}},{key:"skeletonJson",get:function(){return this._skeletonJson},set:function(t){this.reset(),this._skeletonJson="string"==typeof t?JSON.parse(t):t,!this._uuid&&t.skeleton&&(this._uuid=t.skeleton.hash)}},{key:"atlasText",get:function(){return this._atlasText},set:function(t){this._atlasText=t,this.reset()}},{key:"_nativeAsset",get:function(){return this._buffer},set:function(t){this._buffer=t,this.reset()}}]),e}(Du),Jgt=lt((Zgt=iyt).prototype,"_skeletonJson",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$gt=lt(Zgt.prototype,"textures",[xc,Ygt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tyt=lt(Zgt.prototype,"textureNames",[xc,Kgt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eyt=lt(Zgt.prototype,"scale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nyt=lt(Zgt.prototype,"_atlasText",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Qgt=Zgt))||Qgt);u.internal.SpineSkeletonData=uyt;var hyt,fyt,pyt,dyt,_yt,myt,vyt,gyt,yyt,xyt,Syt,Tyt,Eyt,byt,Cyt,Ayt,wyt,Ryt,Pyt,Iyt,Myt,Dyt,Oyt,Nyt,Lyt,Byt,Fyt,zyt,kyt,Uyt,Gyt,Hyt,Vyt,Wyt,jyt,qyt,Xyt,Yyt,Kyt,Qyt,Zyt,Jyt,$yt,txt,ext,nxt,ixt,rxt,oxt,axt,sxt,cxt,lxt,uxt,hxt,fxt=function(t){function e(){var e;return(e=t.call(this)||this)._skeletons=new Set,e}$(e,t),e.getInstance=function(){return e._instance||(e._instance=new e,VO.registerSystem(e.ID,e._instance,PO.Priority.HIGH)),e._instance};var n=e.prototype;return n.add=function(t){t&&(this._skeletons.has(t)||this._skeletons.add(t))},n.remove=function(t){t&&this._skeletons.has(t)&&this._skeletons.delete(t)},n.postUpdate=function(t){this._skeletons&&this._skeletons.forEach((function(e){e.updateAnimation(t)}))},e}(PO);function pxt(t,e,n){Je.Attr.setClassAttr(t,e,"type","Enum"),Je.Attr.setClassAttr(t,e,"enumList",oe.getList(n))}fxt.ID="SKELETON",fxt._instance=void 0,function(t){t[t.default=0]="default"}(cxt||(cxt={})),ce(cxt),function(t){t[t["<None>"]=0]="<None>"}(lxt||(lxt={})),ce(lxt),function(t){t[t.REALTIME=0]="REALTIME",t[t.SHARED_CACHE=1]="SHARED_CACHE",t[t.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(uxt||(uxt={})),ce(uxt),function(t){t[t.COLORED_TEXTURED=0]="COLORED_TEXTURED",t[t.TWO_COLORED=1]="TWO_COLORED"}(hxt||(hxt={}));var dxt=(hyt=dc("sp.Skeleton.SpineSocket"),fyt=Kc(WC),hyt((_yt=lt((dyt=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),ct(this,"path",_yt,this),ct(this,"target",myt,this),this.path=t,this.target=e}).prototype,"path",[xc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),myt=lt(dyt.prototype,"target",[fyt,Mc,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pyt=dyt))||pyt);ie.setClassAlias(dxt,"sp.Skeleton.SpineSocket");var _xt=(vyt=dc("sp.Skeleton"),gyt=Ic(),yyt=Ac(),xyt=Kc(cg),Syt=Gc(),Tyt=Nc(),Eyt=Kc(uyt),byt=Nc(),Cyt=Kc(cxt),Ayt=Lc(),wyt=Nc(),Ryt=Kc(lxt),Pyt=Lc(),Iyt=Nc(),Myt=Lc(),Dyt=Kc(uxt),Oyt=Lc(),Nyt=Lc(),Lyt=Lc(),Byt=Lc(),Fyt=Lc(),zyt=Lc(),kyt=Lc(),Uyt=Kc([dxt]),Gyt=Lc(),Hyt=Dc(),Vyt=Dc(),vyt(Wyt=gyt(Wyt=yyt(Wyt=Cc((sxt=axt=function(t){function e(){var e;return ct(e=t.call(this)||this,"loop",qyt,ot(e)),e.enableBatch=!1,e._frameCache=null,e._curFrame=null,e._effectDelegate=null,e._skeleton=void 0,e._clipper=void 0,e._debugRenderer=void 0,e._startSlotIndex=void 0,e._endSlotIndex=void 0,e._startEntry=void 0,e._endEntry=void 0,e.attachUtil=void 0,e.maxVertexCount=0,e.maxIndexCount=0,e._materialCache={},e._enumSkins=oe({}),e._enumAnimations=oe({}),e._playTimes=0,ct(e,"_timeScale",Xyt,ot(e)),e._paused=!1,e._accTime=0,e._playCount=0,e._skeletonCache=null,e._animationName="",e._animationQueue=[],e._headAniInfo=null,e._isAniComplete=!0,ct(e,"_useTint",Yyt,ot(e)),ct(e,"_preCacheMode",Kyt,ot(e)),ct(e,"_cacheMode",Qyt,ot(e)),ct(e,"_defaultCacheMode",Zyt,ot(e)),ct(e,"_debugBones",Jyt,ot(e)),ct(e,"_debugSlots",$yt,ot(e)),ct(e,"_skeletonData",txt,ot(e)),ct(e,"_premultipliedAlpha",ext,ot(e)),ct(e,"defaultSkin",nxt,ot(e)),ct(e,"defaultAnimation",ixt,ot(e)),ct(e,"_sockets",rxt,ot(e)),e._drawIdx=0,e._drawList=new jl((function(){return{material:null,texture:null,indexOffset:0,indexCount:0}}),1),ct(e,"_debugMesh",oxt,ot(e)),e._rootBone=void 0,e._state=void 0,e._listener=void 0,e._socketNodes=new Map,e._cachedSockets=new Map,e._effectDelegate=null,e._skeleton=null,e._rootBone=null,e._listener=null,e._debugRenderer=null,e._startSlotIndex=-1,e._endSlotIndex=-1,e._startEntry={animation:{name:""},trackIndex:0},e._endEntry={animation:{name:""},trackIndex:0},e.attachUtil=new ayt,pxt(ot(e),"_defaultSkinIndex",e._enumSkins),pxt(ot(e),"_animationIndex",e._enumAnimations),e}$(e,t);var n=e.prototype;return n.setSkeletonData=function(t){var e=this.node._uiProps.uiTransformComp;if(null!=t.width&&null!=t.height&&e.setContentSize(t.width,t.height),this._cacheMode===uxt.SHARED_CACHE?this._skeletonCache=qgt.sharedCache:this._cacheMode===uxt.PRIVATE_CACHE&&(this._skeletonCache=new qgt,this._skeletonCache.enablePrivateMode()),this.isAnimationCached()){(this.debugBones||this.debugSlots)&&S("Debug bones or slots is invalid in cached mode");var n=this._skeletonCache.getSkeletonCache(this.skeletonData._uuid,t);this._skeleton=n.skeleton,this._clipper=n.clipper,this._rootBone=this._skeleton.getRootBone()}else this._skeleton=new bgt.Skeleton(t),this._clipper=new bgt.SkeletonClipping,this._rootBone=this._skeleton.getRootBone();this._flushAssembler()},n.setSlotsRange=function(t,e){this.isAnimationCached()?S("Slots visible range can not be modified in cached mode."):(this._startSlotIndex=t,this._endSlotIndex=e)},n.setAnimationStateData=function(t){if(this.isAnimationCached())S("'setAnimationStateData' interface can not be invoked in cached mode.");else{var e=new bgt.AnimationState(t);this._listener&&(this._state&&this._state.removeListener(this._listener),e.addListener(this._listener)),this._state=e}},n.__preload=function(){t.prototype.__preload.call(this);for(var e=this.node.children,n=0,i=e.length;n<i;n++){var r=e[n];r&&"DEBUG_DRAW_NODE"===r.name&&r.destroy()}this._updateSkeletonData(),this._updateDebugDraw(),this._updateUseTint(),this._indexBoneSockets(),this._updateSocketBindings()},n.setAnimationCacheMode=function(t){this._preCacheMode!==t&&(this._cacheMode=t,this._updateSkeletonData(),this._updateUseTint(),this._updateSocketBindings(),this.markForUpdateRenderData())},n.isAnimationCached=function(){return this._cacheMode!==uxt.REALTIME},n.updateAnimation=function(t){if(!this.paused)if(t*=1*this._timeScale,this.isAnimationCached()){if(this._isAniComplete){if(0===this._animationQueue.length&&!this._headAniInfo){var e=this._frameCache;if(e&&e.isInvalid()){e.updateToFrame();var n=e.frames;this._curFrame=n[n.length-1]}return}if(this._headAniInfo||(this._headAniInfo=this._animationQueue.shift()),this._accTime+=t,this._accTime>this._headAniInfo.delay){var i=this._headAniInfo;this._headAniInfo=null,this.setAnimation(0,i.animationName,i.loop)}return}this._updateCache(t)}else this._updateRealtime(t)},n.setVertexEffectDelegate=function(t){this._effectDelegate=t},n.setToSetupPose=function(){this._skeleton&&this._skeleton.setToSetupPose()},n.setBonesToSetupPose=function(){this._skeleton&&this._skeleton.setBonesToSetupPose()},n.setSlotsToSetupPose=function(){this._skeleton&&this._skeleton.setSlotsToSetupPose()},n.updateAnimationCache=function(t){if(this.isAnimationCached()){var e=this._skeletonData._uuid;this._skeletonCache&&this._skeletonCache.updateAnimationCache(e,t)}},n.invalidAnimationCache=function(){this.isAnimationCached()&&this._skeletonCache&&this._skeletonCache.invalidAnimationCache(this._skeletonData._uuid)},n.findBone=function(t){return this._skeleton?this._skeleton.findBone(t):null},n.findSlot=function(t){return this._skeleton?this._skeleton.findSlot(t):null},n.setSkin=function(t){this._skeleton&&(this._skeleton.setSkinByName(t),this._skeleton.setSlotsToSetupPose()),this.invalidAnimationCache()},n.getAttachment=function(t,e){return this._skeleton?this._skeleton.getAttachmentByName(t,e):null},n.setAttachment=function(t,e){this._skeleton&&this._skeleton.setAttachment(t,e),this.invalidAnimationCache()},n.getTextureAtlas=function(t){return t.region},n.setMix=function(t,e,n){this._state&&this._state.data.setMix(t,e,n)},n.setAnimation=function(t,e,n){if(this._playTimes=n?0:1,this._animationName=e,this.isAnimationCached()){if(0!==t&&S("Track index can not greater than 0 in cached mode."),!this._skeletonCache)return null;var i=this._skeletonCache.getAnimationCache(this._skeletonData._uuid,e);i||(i=this._skeletonCache.initAnimationCache(this._skeletonData._uuid,e)),i&&(this._isAniComplete=!1,this._accTime=0,this._playCount=0,this._frameCache=i,this._socketNodes.size>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._curFrame=this._frameCache.frames[0])}else if(this._skeleton){var r=this._skeleton.data.findAnimation(e);if(!r)return P(7509,e),null;var o=this._state.setAnimationWith(t,r,n);return this._state.apply(this._skeleton),o}return null},n.addAnimation=function(t,e,n,i){if(i=i||0,this.isAnimationCached())0!==t&&S("Track index can not greater than 0 in cached mode."),this._animationQueue.push({animationName:e,loop:n,delay:i});else if(this._skeleton){var r,o=this._skeleton.data.findAnimation(e);return o?null===(r=this._state)||void 0===r?void 0:r.addAnimationWith(t,o,n,i):(P(7510,e),null)}return null},n.findAnimation=function(t){return this._skeleton?this._skeleton.data.findAnimation(t):null},n.getCurrent=function(t){if(this.isAnimationCached())S("'getCurrent' interface can not be invoked in cached mode.");else if(this._state)return this._state.getCurrent(t);return null},n.clearTracks=function(){this.isAnimationCached()?S("'clearTracks' interface can not be invoked in cached mode."):this._state&&(this._state.clearTracks(),this.setToSetupPose())},n.clearTrack=function(t){this.isAnimationCached()?S("'clearTrack' interface can not be invoked in cached mode."):this._state&&this._state.clearTrack(t)},n.setStartListener=function(t){this._ensureListener(),this._listener.start=t},n.setInterruptListener=function(t){this._ensureListener(),this._listener.interrupt=t},n.setEndListener=function(t){this._ensureListener(),this._listener.end=t},n.setDisposeListener=function(t){this._ensureListener(),this._listener.dispose=t},n.setCompleteListener=function(t){this._ensureListener(),this._listener.complete=t},n.setEventListener=function(t){this._ensureListener(),this._listener.event=t},n.setTrackStartListener=function(t,e){Cgt.getListeners(t).start=e},n.setTrackInterruptListener=function(t,e){Cgt.getListeners(t).interrupt=e},n.setTrackEndListener=function(t,e){Cgt.getListeners(t).end=e},n.setTrackDisposeListener=function(t,e){Cgt.getListeners(t).dispose=e},n.setTrackCompleteListener=function(t,e){Cgt.getListeners(t).complete=function(t){var n=Math.floor(t.trackTime/t.animationEnd);e(t,n)}},n.setTrackEventListener=function(t,e){Cgt.getListeners(t).event=e},n.getState=function(){return this._state},n.onEnable=function(){t.prototype.onEnable.call(this),this._flushAssembler(),fxt.getInstance().add(this)},n.onDisable=function(){t.prototype.onDisable.call(this),fxt.getInstance().remove(this)},n.onDestroy=function(){this._cleanMaterialCache(),this._drawList.destroy(),t.prototype.onDestroy.call(this)},n.destroyRenderData=function(){this._drawList.reset(),t.prototype.destroyRenderData.call(this)},n.getMaterialForBlendAndTint=function(t,e,n){var i=n+"/"+t+"/"+e,r=this._materialCache[i];if(r)return r;var o=this.customMaterial;null===o&&(o=Dv.get("default-spine-material"));var a=!1;switch(n){case hxt.TWO_COLORED:a=!0;break;case hxt.COLORED_TEXTURED:}return r=new mT({parent:o,subModelIdx:0,owner:this}),this._materialCache[i]=r,r.overridePipelineStates({blendState:{blendColor:An.WHITE,targets:[{blendEq:Pi.ADD,blendAlphaEq:Pi.ADD,blendSrc:t,blendDst:e,blendSrcAlpha:t,blendDstAlpha:e}]}}),r.recompileShaders({TWO_COLORED:a,USE_LOCAL:!0}),r},n.onRestore=function(){this.updateMaterial(),this._renderFlag=this._canRender(),this.markForUpdateRenderData()},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);var t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._updateBlendFunc(),this._blendHash=-1},n.querySockets=function(){return this._skeleton?(0===this._cachedSockets.size&&this._indexBoneSockets(),this._cachedSockets.size>0?Array.from(this._cachedSockets.keys()).sort():[]):[]},n._requestDrawData=function(t,e,n,i){var r=this._drawList.add();return r.material=t,r.texture=e,r.indexOffset=n,r.indexCount=i,r},n._render=function(t){if(this._renderData&&this._drawList){var e=this._renderData,n=e.chunk,i=n.vertexAccessor,r=e.getMeshBuffer(),o=r.indexOffset;i.appendIndices(n.bufferId,e.indices);for(var a=0;a<this._drawList.length;a++){this._drawIdx=a;var s=this._drawList.data[a];if(s.texture){var c=r.requireFreeIA(t.device);c.firstIndex=o+s.indexOffset,c.indexCount=s.indexCount,t.commitIA(this,c,s.texture,s.material,this.node)}}}},n.updateWorldTransform=function(){this.isAnimationCached()&&this._skeleton&&this._skeleton.updateWorldTransform()},n._emitCacheCompleteEvent=function(){this._listener&&(this._endEntry.animation.name=this._animationName,this._listener.complete&&this._listener.complete(this._endEntry),this._listener.end&&this._listener.end(this._endEntry))},n._updateCache=function(t){var e=this._frameCache;if(e.isInited()){var n=e.frames,i=qgt.FrameTime;0===this._accTime&&0===this._playCount&&(this._startEntry.animation.name=this._animationName,this._listener&&this._listener.start&&this._listener.start(this._startEntry)),this._accTime+=t;var r=Math.floor(this._accTime/i);if(e.isCompleted||(e.updateToFrame(r),this._renderData&&(this._renderData.vertexCount<e.maxVertexCount||this._renderData.indexCount<e.maxIndexCount)&&(this.maxVertexCount=e.maxVertexCount>this.maxVertexCount?e.maxVertexCount:this.maxVertexCount,this.maxIndexCount=e.maxIndexCount>this.maxIndexCount?e.maxIndexCount:this.maxIndexCount,this._renderData.resize(this.maxVertexCount,this.maxIndexCount),(!this._renderData.indices||this.maxIndexCount>this._renderData.indices.length)&&(this._renderData.indices=new Uint16Array(this.maxIndexCount)))),e.isCompleted&&r>=n.length){if(this._playCount++,this._playTimes>0&&this._playCount>=this._playTimes)return this._curFrame=n[n.length-1],this._accTime=0,this._playCount=0,this._isAniComplete=!0,this._emitCacheCompleteEvent(),void this.markForUpdateRenderData();this._accTime=0,r=0,this._emitCacheCompleteEvent()}this._curFrame=n[r],this.markForUpdateRenderData()}},n._updateRealtime=function(t){var e=this._skeleton,n=this._state;e&&(e.update(t),n&&(n.update(t),n.apply(e)),this.markForUpdateRenderData())},n._indexBoneSockets=function(){if(this._skeleton){this._cachedSockets.clear();for(var t=this._skeleton.bones,e=function e(n){return null==n.parent?n.data.name||"<Unamed>":e(t[n.parent.data.index])+"/"+n.data.name},n=0,i=t.length;n<i;n++){var r=t[n].data,o=e(t[n]);this._cachedSockets.set(o,r.index)}}},n._updateUseTint=function(){this._cleanMaterialCache(),this.destroyRenderData(),this._assembler&&this._skeleton&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},n._updateBatch=function(){this.markForUpdateRenderData()},n._updateAnimEnum=function(){var t;t=this.skeletonData?this.skeletonData.getAnimsEnum():lxt,this._enumAnimations=oe({}),Object.assign(this._enumAnimations,t),oe.update(this._enumAnimations),pxt(this,"_animationIndex",this._enumAnimations)},n._updateSkinEnum=function(){var t;t=this.skeletonData?this.skeletonData.getSkinsEnum():cxt,this._enumSkins=oe({}),Object.assign(this._enumSkins,t),oe.update(this._enumSkins),pxt(this,"_defaultSkinIndex",this._enumSkins)},n._ensureListener=function(){this._listener||(this._listener=new Cgt,this._state&&this._state.addListener(this._listener))},n._updateSkeletonData=function(){if(this.skeletonData){var t=this.skeletonData.getRuntimeData();if(t){try{this.setSkeletonData(t),this.isAnimationCached()||this.setAnimationStateData(new bgt.AnimationStateData(this._skeleton.data)),this.defaultSkin&&this.setSkin(this.defaultSkin)}catch(t){S(t)}this._indexBoneSockets(),this.attachUtil.init(this),this._preCacheMode=this._cacheMode,this.animation=this.defaultAnimation}}},n._refreshInspector=function(){this._updateAnimEnum(),this._updateSkinEnum()},n._updateDebugDraw=function(){if(this.debugBones||this.debugSlots||this.debugMesh){if(!this._debugRenderer){var t=new WC("DEBUG_DRAW_NODE");t.hideFlags|=dl.Flags.DontSave|dl.Flags.HideInHierarchy;var e=t.addComponent(Hq);e.lineWidth=1,e.strokeColor=new An(255,0,0,255),this._debugRenderer=e,t.parent=this.node}this.isAnimationCached()&&S("Debug bones or slots is invalid in cached mode")}else this._debugRenderer&&(this._debugRenderer.node.destroy(),this._debugRenderer=null)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t),this._skeleton&&this._assembler&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())},n._updateSocketBindings=function(){if(this._skeleton){this._socketNodes.clear();for(var t=0,e=this._sockets.length;t<e;t++){var n=this._sockets[t];if(n.path&&n.target){var i=this._cachedSockets.get(n.path);if(!i){console.error("Skeleton data does not contain path "+n.path);continue}this._socketNodes.set(i,n.target)}}}},n._verifySockets=function(t){for(var e=0,n=t.length;e<n;e++){var i=t[e].target;!i||i.parent&&i.parent===this.node||console.error("Target node "+i.name+" is expected to be a direct child of "+this.node.name)}var r=new Map;t.forEach((function(t){t.target&&(r.get(t.target)?console.error("Target node "+t.target.name+" has existed."):r.set(t.target,!0))}))},n._cleanMaterialCache=function(){for(var t in this._materialCache)this._materialCache[t].destroy();this._materialCache={}},Z(e,[{key:"drawList",get:function(){return this._drawList}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this._cleanMaterialCache()}},{key:"paused",get:function(){return this._paused},set:function(t){this._paused=t}},{key:"skeletonData",get:function(){return this._skeletonData},set:function(t){t&&t.resetEnums(),this._skeletonData!==t&&(this._skeletonData=t,this.defaultSkin="",this.defaultAnimation="",this._updateSkeletonData())}},{key:"animation",get:function(){if(this.isAnimationCached())return this._animationName;var t=this.getCurrent(0);return t&&t.animation.name||""},set:function(t){t?(this.setAnimation(0,t,this.loop),this.markForUpdateRenderData()):this.isAnimationCached()||(this.clearTrack(0),this.setToSetupPose())}},{key:"_defaultSkinIndex",get:function(){if(this.skeletonData){var t=this.skeletonData.getSkinsEnum();if(t)if(""===this.defaultSkin){if(t.hasOwnProperty(0))return this._defaultSkinIndex=0,0}else{var e=t[this.defaultSkin];if(void 0!==e)return e}}return 0},set:function(t){var e;if(this.skeletonData&&(e=this.skeletonData.getSkinsEnum()),e){var n=e[t];void 0!==n?(this.defaultSkin=n,this.setSkin(this.defaultSkin)):console.error(this.name+" skin enums are invalid")}else console.error(this.name+" skin enums are invalid")}},{key:"_animationIndex",get:function(){var t=this.animation;if(this.skeletonData)if(t){var e=this.skeletonData.getAnimsEnum();if(e){var n=e[t];if(void 0!==n)return n}}else this._refreshInspector();return 0},set:function(t){var e;if(this.skeletonData&&(e=this.skeletonData.getAnimsEnum()),e){var n=e[t];void 0!==n?(this.animation=n,this.animation=n):console.error(this.name+" animation enums are invalid")}else console.error(this.name+" animation enums are invalid")}},{key:"defaultCacheMode",get:function(){return this._defaultCacheMode},set:function(t){this._defaultCacheMode=t,this.setAnimationCacheMode(this._defaultCacheMode)}},{key:"premultipliedAlpha",get:function(){return this._premultipliedAlpha},set:function(t){t!==this._premultipliedAlpha&&(this._premultipliedAlpha=t,this.markForUpdateRenderData())}},{key:"timeScale",get:function(){return this._timeScale},set:function(t){t!==this._timeScale&&(this._timeScale=t)}},{key:"debugSlots",get:function(){return this._debugSlots},set:function(t){t!==this._debugSlots&&(this._debugSlots=t,this._updateDebugDraw(),this.markForUpdateRenderData())}},{key:"debugBones",get:function(){return this._debugBones},set:function(t){t!==this._debugBones&&(this._debugBones=t,this._updateDebugDraw(),this.markForUpdateRenderData())}},{key:"debugMesh",get:function(){return this._debugMesh},set:function(t){t!==this._debugMesh&&(this._debugMesh=t,this._updateDebugDraw(),this.markForUpdateRenderData())}},{key:"useTint",get:function(){return this._useTint},set:function(t){t!==this._useTint&&(this._useTint=t,this._updateUseTint())}},{key:"sockets",get:function(){return this._sockets},set:function(t){this._sockets=t,this._updateSocketBindings(),this.attachUtil._syncAttachedNode()}},{key:"socketNodes",get:function(){return this._socketNodes}}]),e}(yj),axt.SpineSocket=dxt,axt.AnimationCacheMode=uxt,lt((jyt=sxt).prototype,"customMaterial",[ol,xyt,Syt,Tyt],Object.getOwnPropertyDescriptor(jyt.prototype,"customMaterial"),jyt.prototype),lt(jyt.prototype,"skeletonData",[Mc,Eyt],Object.getOwnPropertyDescriptor(jyt.prototype,"skeletonData"),jyt.prototype),lt(jyt.prototype,"_defaultSkinIndex",[byt,Cyt,Ayt],Object.getOwnPropertyDescriptor(jyt.prototype,"_defaultSkinIndex"),jyt.prototype),lt(jyt.prototype,"_animationIndex",[wyt,Ryt,Pyt],Object.getOwnPropertyDescriptor(jyt.prototype,"_animationIndex"),jyt.prototype),lt(jyt.prototype,"defaultCacheMode",[Iyt,Myt,Mc,Dyt],Object.getOwnPropertyDescriptor(jyt.prototype,"defaultCacheMode"),jyt.prototype),qyt=lt(jyt.prototype,"loop",[xc,Oyt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(jyt.prototype,"premultipliedAlpha",[Mc,Nyt],Object.getOwnPropertyDescriptor(jyt.prototype,"premultipliedAlpha"),jyt.prototype),lt(jyt.prototype,"timeScale",[Lyt,Mc],Object.getOwnPropertyDescriptor(jyt.prototype,"timeScale"),jyt.prototype),lt(jyt.prototype,"debugSlots",[Mc,Byt],Object.getOwnPropertyDescriptor(jyt.prototype,"debugSlots"),jyt.prototype),lt(jyt.prototype,"debugBones",[Mc,Fyt],Object.getOwnPropertyDescriptor(jyt.prototype,"debugBones"),jyt.prototype),lt(jyt.prototype,"debugMesh",[Mc,zyt],Object.getOwnPropertyDescriptor(jyt.prototype,"debugMesh"),jyt.prototype),lt(jyt.prototype,"useTint",[Mc,kyt],Object.getOwnPropertyDescriptor(jyt.prototype,"useTint"),jyt.prototype),lt(jyt.prototype,"sockets",[Uyt,Gyt],Object.getOwnPropertyDescriptor(jyt.prototype,"sockets"),jyt.prototype),Xyt=lt(jyt.prototype,"_timeScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Yyt=lt(jyt.prototype,"_useTint",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Kyt=lt(jyt.prototype,"_preCacheMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Qyt=lt(jyt.prototype,"_cacheMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uxt.REALTIME}}),Zyt=lt(jyt.prototype,"_defaultCacheMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uxt.REALTIME}}),Jyt=lt(jyt.prototype,"_debugBones",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$yt=lt(jyt.prototype,"_debugSlots",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),txt=lt(jyt.prototype,"_skeletonData",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ext=lt(jyt.prototype,"_premultipliedAlpha",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nxt=lt(jyt.prototype,"defaultSkin",[xc,Hyt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ixt=lt(jyt.prototype,"defaultAnimation",[Vyt,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rxt=lt(jyt.prototype,"_sockets",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oxt=lt(jyt.prototype,"_debugMesh",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wyt=jyt))||Wyt)||Wyt)||Wyt)||Wyt);u.internal.SpineSkeleton=_xt;var mxt,vxt,gxt,yxt,xxt,Sxt,Txt,Ext,bxt,Cxt,Axt,wxt,Rxt,Pxt,Ixt,Mxt,Dxt,Oxt,Nxt,Lxt,Bxt,Fxt,zxt,kxt,Uxt,Gxt,Hxt,Vxt,Wxt,jxt,qxt,Xxt,Yxt,Kxt,Qxt,Zxt,Jxt,$xt,tSt,eSt,nSt,iSt,rSt,oSt,aSt=function(){function t(){this.name="sp.VertexEffectDelegate",this._vertexEffect=null,this._interpolation=null,this._effectType=void 0,this._vertexEffect=null,this._interpolation=null,this._effectType="none"}var e=t.prototype;return e.clear=function(){this._vertexEffect=null,this._interpolation=null,this._effectType="none"},e.initJitter=function(t,e){return this._effectType="jitter",this._vertexEffect=new bgt.JitterEffect(t,e),this._vertexEffect},e.initSwirlWithPow=function(t,e){return this._interpolation=new bgt.Pow(e),this._vertexEffect=new bgt.SwirlEffect(t,this._interpolation),this._vertexEffect},e.initSwirlWithPowOut=function(t,e){return this._interpolation=new bgt.PowOut(e),this._vertexEffect=new bgt.SwirlEffect(t,this._interpolation),this._vertexEffect},e.getJitterVertexEffect=function(){return this._vertexEffect},e.getSwirlVertexEffect=function(){return this._vertexEffect},e.getVertexEffect=function(){return this._vertexEffect},e.getEffectType=function(){return this._effectType},t}(),sSt=0,cSt=[0,1,2,2,3,0],lSt=new An(0,0,255,255),uSt=new An(255,0,0,255),hSt=new An(0,255,0,255),fSt=new An(255,255,0,255),pSt=new bgt.Color(1,1,1,1),dSt=new bgt.Color(1,1,1,1),_St=new bgt.Vector2,mSt=new bgt.Vector2,vSt=new Float32Array(4),gSt=new Float32Array(4),ySt=0,xSt=0,SSt=0,TSt=0,ESt=0,bSt=0,CSt=0,ASt=0,wSt=null,RSt=null,PSt=null;function ISt(t){var e,n;switch(t){case bgt.BlendMode.Additive:e=mxt?Ri.ONE:Ri.SRC_ALPHA,n=Ri.ONE;break;case bgt.BlendMode.Multiply:e=Ri.DST_COLOR,n=Ri.ONE_MINUS_SRC_ALPHA;break;case bgt.BlendMode.Screen:e=Ri.ONE,n=Ri.ONE_MINUS_SRC_COLOR;break;case bgt.BlendMode.Normal:default:e=mxt?Ri.ONE:Ri.SRC_ALPHA,n=Ri.ONE_MINUS_SRC_ALPHA}return tSt.getMaterialForBlendAndTint(e,n,xxt?hxt.TWO_COLORED:hxt.COLORED_TEXTURED)}function MSt(t){Kxt=t.fa*wxt,Vxt=bxt*(vxt=mxt?Kxt/255:1),Wxt=Cxt*vxt,jxt=Axt*vxt,qxt=t.fr*Vxt,Xxt=t.fg*Wxt,Yxt=t.fb*jxt,vSt[0]=qxt/255,vSt[1]=Xxt/255,vSt[2]=Yxt/255,vSt[3]=Kxt/255,Qxt=t.dr*Vxt,Zxt=t.dg*Wxt,Jxt=t.db*jxt,$xt=mxt?255:0,gSt[0]=Qxt/255,gSt[1]=Zxt/255,gSt[2]=Jxt/255,gSt[3]=$xt/255}var DSt=new Float32Array(4);function OSt(t){return DSt[0]=t.r/255,DSt[1]=t.g/255,DSt[2]=t.b/255,DSt[3]=t.a/255,DSt}var NSt=null,LSt=null,BSt={vCount:32767,ensureAccessor:function(t){var e=t?LSt:NSt;if(!e){var n=VO.root.device,i=VO.root.batcher2D,r=t?iV:nV;t?(e=LSt=new XJ(n,r,this.vCount),i.registerBufferAccessor(Number.parseInt("SPINETINT",36),LSt)):(e=NSt=new XJ(n,r,this.vCount),i.registerBufferAccessor(Number.parseInt("SPINE",36),NSt))}return e},createData:function(t){var e=t.renderData;if(!e){for(var n=t.useTint||t.isAnimationCached(),i=this.ensureAccessor(n),r=t._skeleton.data.skins,o=0,a=0,s=0;s<r.length;++s)for(var c=r[s].attachments,l=0;l<c.length;l++){var u=c[l];for(var h in u){var f=u[h];f instanceof bgt.RegionAttachment?(o+=4,a+=6):f instanceof bgt.MeshAttachment&&(o+=f.worldVerticesLength>>1,a+=f.triangles.length)}}(e=CV.add(n?iV:nV,i)).resize(o,a),e.indices&&a===e.indices.length||(e.indices=new Uint16Array(a)),t.maxVertexCount=o,t.maxIndexCount=a}return e},updateRenderData:function(t){tSt=t;var e=t._skeleton;!t.isAnimationCached()&&e&&e.updateWorldTransform(),e&&function(t){if(t._skeleton){var e,n=t.color;bxt=n.r/255,Cxt=n.g/255,Axt=n.b/255,wxt=n.a/255,xxt=t.useTint||t.isAnimationCached(),Rxt=xxt?13:9,t.drawList.reset(),tSt=t,eSt=t.node,nSt=t.renderData,RSt=null,Nxt=!0,mxt=t.premultipliedAlpha,vxt=1,sSt=0,oSt=!1,wSt=t._effectDelegate&&t._effectDelegate._vertexEffect,(4294967295!==n._val||mxt)&&(oSt=!0),xxt&&(sSt|=1),tSt.enableBatch&&(e=eSt.worldMatrix,Nxt=!1,sSt|=16),t.isAnimationCached()?function(t){var e=tSt._curFrame;if(e){var n=e.segments;if(0!==n.length){Pxt=12,TSt=0,ESt=0,SSt=0,bSt=0;var i=null,r=e.vertices,o=e.indices,a=0,s=0,c=0,l=0;t&&(Fxt=t.m00,Uxt=t.m01,zxt=t.m04,Gxt=t.m05,kxt=t.m12,Hxt=t.m13);var u=16&sSt,h=u&&(1===Fxt&&0===Uxt&&0===zxt&&1===Gxt),f=e.colors,p=0,d=f[p++],_=d.vfOffset;MSt(d);for(var m=0,v=nSt,g=v.chunk.vb,y=v.indices,x=0,S=n.length;x<S;x++){var T=n[x];if(i=ISt(T.blendMode)){if(RSt||(RSt=i),Nxt||i.hash!==RSt.hash||T.tex&&T.tex!==PSt){Nxt=!1;var E=bSt-m;E>0&&(tSt._requestDrawData(RSt,PSt,m,E),m=bSt),RSt=i,PSt=T.tex}xSt=T.vertexCount,ESt=T.indexCount,a=v.chunk.vertexOffset;for(var b=bSt,C=bSt+ESt;b<C;b++)y[b]=a+SSt+o[c++];if(l=T.vfCount,g.set(r.subarray(s,s+l),s),h)for(var A=s,w=s+l;A<w;A+=Rxt)g[A]+=kxt,g[A+1]+=Hxt;else if(u)for(var R=s,P=s+l;R<P;R+=Rxt)Lxt=g[R],Bxt=g[R+1],g[R]=Lxt*Fxt+Bxt*zxt+kxt,g[R+1]=Lxt*Uxt+Bxt*Gxt+Hxt;if(oSt)for(var I=s/13*6,M=s,D=s+l;M<D;M+=Rxt,I+=6)I>=_&&(MSt(d=f[p++]),_=d.vfOffset),g.set(vSt,M+5),g.set(gSt,M+9);s+=l,SSt+=xSt,bSt+=ESt,xSt=0,ESt=0}}var O=bSt-m;PSt&&O>0&&tSt._requestDrawData(RSt,PSt,m,O)}}}(e):(wSt&&wSt.begin(t._skeleton),function(t,e){var n=nSt;rSt=n.chunk.vb,iSt=n.indices,CSt=tSt.maxVertexCount,ASt=tSt.maxIndexCount;var i,r,o,a,s,c,l=tSt._skeleton,u=l.color,h=tSt._debugRenderer,f=tSt._clipper,p=null;gxt=tSt._startSlotIndex,yxt=tSt._endSlotIndex,Oxt=!1,-1===gxt&&(Oxt=!0),Sxt=tSt.debugSlots,Txt=tSt.debugBones,Ext=tSt.debugMesh,h&&(Txt||Sxt||Ext)&&(h.clear(),h.lineWidth=5),Pxt=12,ySt=0,SSt=0,TSt=0,ESt=0,bSt=0;for(var d=0,_=0,m=l.drawOrder.length;_<m;_++)if(void 0!==(c=l.drawOrder[_]))if(gxt>=0&&gxt===c.data.index&&(Oxt=!0),Oxt)if(yxt>=0&&yxt===c.data.index&&(Oxt=!1),ySt=0,ESt=0,i=c.getAttachment())if(a=i instanceof bgt.RegionAttachment,s=i instanceof bgt.MeshAttachment,i instanceof bgt.ClippingAttachment)f.clipStart(c,i);else if(a||s){var v=i.region.texture.getRealTexture();if(p=ISt(c.data.blendMode)){if(RSt||(RSt=p),Nxt||p.hash!==RSt.hash||v&&PSt!==v){Nxt=!1;var g=bSt-d;g>0&&(tSt._requestDrawData(RSt,PSt,d,g),d=bSt),PSt=v,RSt=p}if(a){if(o=cSt,ySt=(xSt=4)*Rxt,ESt=6,i.computeWorldVertices(c.bone,rSt,TSt,Rxt),h&&Sxt){h.strokeColor=lSt,h.moveTo(rSt[TSt],rSt[TSt+1]);for(var y=TSt+Rxt,x=TSt+ySt;y<x;y+=Rxt)h.lineTo(rSt[y],rSt[y+1]);h.close(),h.stroke()}}else if(s){var S=i;if(o=S.triangles,xSt=S.worldVerticesLength>>1,ySt=xSt*Rxt,ESt=o.length,S.computeWorldVertices(c,0,S.worldVerticesLength,rSt,TSt,Rxt),h&&Ext){h.strokeColor=fSt;for(var T=0,E=o.length;T<E;T+=3){var b=o[T]*Rxt+TSt,C=o[T+1]*Rxt+TSt,A=o[T+2]*Rxt+TSt;h.moveTo(rSt[b],rSt[b+1]),h.lineTo(rSt[C],rSt[C+1]),h.lineTo(rSt[A],rSt[A+1]),h.close(),h.stroke()}}}if(0!==ySt&&0!==ESt){var w=i;(iSt=n.indices).set(o,bSt),r=w.uvs;for(var R=TSt,P=TSt+ySt,I=0;R<P;R+=Rxt,I+=2)rSt[R+3]=r[I],rSt[R+4]=r[I+1];if(FSt(u,w.color,c.color,f,c),ESt>0){for(var M=n.chunk.vertexOffset,D=bSt,O=bSt+ESt;D<O;D++)iSt[D]+=SSt+M;if(e){Fxt=e.m00,zxt=e.m04,kxt=e.m12,Uxt=e.m01,Gxt=e.m05,Hxt=e.m13;for(var N=TSt,L=TSt+ySt;N<L;N+=Rxt)Lxt=rSt[N],Bxt=rSt[N+1],rSt[N]=Lxt*Fxt+Bxt*zxt+kxt,rSt[N+1]=Lxt*Uxt+Bxt*Gxt+Hxt}}TSt+=ySt,SSt+=xSt,bSt+=ESt,xSt=0,ESt=0,f.clipEndWithSlot(c)}else f.clipEndWithSlot(c)}else f.clipEndWithSlot(c)}else f.clipEndWithSlot(c);else f.clipEndWithSlot(c);else f.clipEndWithSlot(c);var B=bSt-d;if(PSt&&B>0&&tSt._requestDrawData(RSt,PSt,d,B),f.clipEnd(),h&&Txt){var F;h.strokeColor=uSt,h.fillColor=lSt;for(var z=0,k=l.bones.length;z<k;z++){var U=(F=l.bones[z]).data.length*F.a+F.worldX,G=F.data.length*F.c+F.worldY;h.moveTo(F.worldX,F.worldY),h.lineTo(U,G),h.stroke(),h.circle(F.worldX,F.worldY,1.5*Math.PI),h.fill(),0===z&&(h.fillColor=hSt)}}}(0,e),wSt&&wSt.end()),(xxt?LSt:NSt).getMeshBuffer(nSt.chunk.bufferId).setDirty(),t.attachUtil._syncAttachedNode(),eSt=void 0,tSt=void 0,wSt=null}}(t)},updateColor:function(t){t&&(tSt=t).markForUpdateRenderData()},fillBuffers:function(){}};function FSt(t,e,n,i,r){if(pSt.a=n.a*e.a*t.a*wxt*255,vxt=mxt?pSt.a:255,Ixt=bxt*e.r*t.r*vxt,Mxt=Cxt*e.g*t.g*vxt,Dxt=Axt*e.b*t.b*vxt,pSt.r=Ixt*n.r,pSt.g=Mxt*n.g,pSt.b=Dxt*n.b,null==r.darkColor?dSt.set(0,0,0,1):(dSt.r=r.darkColor.r*Ixt,dSt.g=r.darkColor.g*Mxt,dSt.b=r.darkColor.b*Dxt),dSt.a=mxt?255:0,i.isClipping()){Pxt=xxt?12:8;var o=rSt.subarray(TSt),a=rSt.subarray(TSt+3);i.clipTriangles(o,ySt,iSt.subarray(bSt),ESt,a,pSt,dSt,xxt,Rxt);var s=i.clippedVertices,c=i.clippedTriangles;if(function(t,e){var n=xSt,i=ESt,r=nSt;ESt=e.length,xSt=t.length/Pxt,ySt=xSt*Rxt,CSt+=xSt-n,ASt+=ESt-i;var o=iSt,a=r.chunk.vertexOffset,s=!1;if(CSt>r.vertexCount&&(r.resizeAndCopy(CSt,ASt>r.indexCount?ASt:r.indexCount),rSt=r.chunk.vb,s=!0),ASt>iSt.length&&(iSt=r.indices=new Uint16Array(ASt),s=!0),s)for(var c=r.chunk.vertexOffset-a,l=0;l<bSt;++l)iSt[l]=o[l]+c}(s,c),c.length>0&&iSt.set(c,bSt),wSt)for(var l=0,u=s.length,h=TSt;l<u;l+=Pxt,h+=Rxt)_St.x=s[l],_St.y=s[l+1],pSt.set(s[l+2],s[l+3],s[l+4],s[l+5]),mSt.x=s[l+6],mSt.y=s[l+7],xxt?dSt.set(s[l+8],s[l+9],s[l+10],s[l+11]):dSt.set(0,0,0,0),wSt.transform(_St,mSt,pSt,dSt),rSt[h]=_St.x,rSt[h+1]=_St.y,rSt[h+3]=mSt.x,rSt[h+4]=mSt.y,rSt.set(OSt(pSt),h+5),xxt&&rSt.set(OSt(dSt),h+9);else for(var f=0,p=s.length,d=TSt;f<p;f+=Pxt,d+=Rxt)rSt[d]=s[f],rSt[d+1]=s[f+1],rSt[d+3]=s[f+6],rSt[d+4]=s[f+7],rSt[d+5]=s[f+2]/255,rSt[d+6]=s[f+3]/255,rSt[d+7]=s[f+4]/255,rSt[d+8]=s[f+5]/255,xxt&&(rSt[d+9]=s[f+8]/255,rSt[d+10]=s[f+9]/255,rSt[d+11]=s[f+10]/255,rSt[d+12]=s[f+11]/255)}else if(wSt)for(var _=TSt,m=TSt+ySt;_<m;_+=Rxt)_St.x=rSt[_],_St.y=rSt[_+1],mSt.x=rSt[_+3],mSt.y=rSt[_+4],wSt.transform(_St,mSt,pSt,dSt),rSt[_]=_St.x,rSt[_+1]=_St.y,rSt[_+3]=mSt.x,rSt[_+4]=mSt.y,rSt.set(OSt(pSt),_+5),xxt&&rSt.set(OSt(dSt),_+9);else{vSt.set(OSt(pSt)),gSt.set(OSt(dSt));for(var v=TSt,g=TSt+ySt;v<g;v+=Rxt)rSt.set(vSt,v+5),xxt&&rSt.set(gSt,v+9)}}u.internal.SpineAssembler=BSt;var zSt,kSt,USt={getAssembler:function(){return BSt}};_xt.Assembler=USt,function(t){t[t.REGION=0]="REGION",t[t.BOUNDING_BOX=1]="BOUNDING_BOX",t[t.MESH=2]="MESH",t[t.SKINNED_MESH=3]="SKINNED_MESH"}(zSt||(zSt={})),ce(zSt),function(t){t[t.START=0]="START",t[t.INTERRUPT=1]="INTERRUPT",t[t.END=2]="END",t[t.DISPOSE=3]="DISPOSE",t[t.COMPLETE=4]="COMPLETE",t[t.EVENT=5]="EVENT"}(kSt||(kSt={})),ce(kSt),t("sp",Object.freeze({__proto__:null,spine:bgt,get ATTACHMENT_TYPE(){return zSt},get AnimationEventType(){return kSt},timeScale:1,get DefaultSkinsEnum(){return cxt},get DefaultAnimsEnum(){return lxt},get AnimationCacheMode(){return uxt},get SpineMaterialType(){return hxt},SpineSocket:dxt,Skeleton:_xt,SkeletonData:uyt,SkeletonTexture:syt,convertFilter:cyt,convertWraps:lyt,VertexEffectDelegate:aSt,simpleSpineAssembler:USt}));var GSt=function(){function t(){this.originalTarget=null,this.target=null,this.tag=t.TAG_INVALID}var e=t.prototype;return e.clone=function(){var e=new t;return e.originalTarget=null,e.target=null,e.tag=this.tag,e},e.isDone=function(){return!0},e.startWithTarget=function(t){this.originalTarget=t,this.target=t},e.stop=function(){this.target=null},e.step=function(){P(1006)},e.update=function(){P(1007)},e.getTarget=function(){return this.target},e.setTarget=function(t){this.target=t},e.getOriginalTarget=function(){return this.originalTarget},e.setOriginalTarget=function(t){this.originalTarget=t},e.getTag=function(){return this.tag},e.setTag=function(t){this.tag=t},e.reverse=function(){return P(1008),null},e.retain=function(){},e.release=function(){},t}();GSt.TAG_INVALID=-1;var HSt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._duration=0,e._timesForRepeat=1,e}$(e,t);var n=e.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(t){this._duration=t},n.clone=function(){return new e},e}(GSt),VSt=(function(t){function e(e,n){var i;return void 0===n&&(n=1),(i=t.call(this)||this)._speed=0,i._innerAction=null,e&&i.initWithAction(e,n),i}$(e,t);var n=e.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(t){this._speed=t},n.initWithAction=function(t,e){return t?(this._innerAction=t,this._speed=e,!0):(O(1021),!1)},n.clone=function(){var t=new e;return t.initWithAction(this._innerAction.clone(),this._speed),t},n.startWithTarget=function(t){GSt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.stop=function(){this._innerAction.stop(),GSt.prototype.stop.call(this)},n.step=function(t){this._innerAction.step(t*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new e(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction}}(GSt),0),WSt=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},jSt=function(){function t(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var e=t.prototype;return e._searchElementByTarget=function(t,e){for(var n=0;n<t.length;n++)if(e===t[n].target)return t[n];return null},e._getElement=function(t,e){var n=this._elementPool.pop();return n||(n=new WSt),n.target=t,n.paused=!!e,n},e._putElement=function(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)},e.addAction=function(t,e,n){if(t&&e){null==e.uuid&&(e.uuid="_TWEEN_UUID_"+VSt++);var i=this._hashTargets.get(e);i?i.actions||(i.actions=[]):(i=this._getElement(e,n),this._hashTargets.set(e,i),this._arrayTargets.push(i)),i.target=e,i.actions.push(t),t.startWithTarget(e)}else O(1e3)},e.removeAllActions=function(){for(var t=this._arrayTargets,e=0;e<t.length;e++){var n=t[e];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},e.removeAllActionsFromTarget=function(t){if(null!=t){var e=this._hashTargets.get(t);e&&(e.actions.length=0,this._deleteHashElement(e))}},e.removeAction=function(t){if(null!=t){var e=t.getOriginalTarget(),n=this._hashTargets.get(e);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===t){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},e._removeActionByTag=function(t,e,n){for(var i=0,r=e.actions.length;i<r;++i){var o=e.actions[i];if(o&&o.getTag()===t){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,e);break}}},e._removeAllActionsByTag=function(t,e,n){for(var i=e.actions.length-1;i>=0;--i){var r=e.actions[i];if(r&&r.getTag()===t){if(n&&r.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,e)}}},e.removeActionByTag=function(t,e){var n=this;t===GSt.TAG_INVALID&&P(1002);var i=this._hashTargets;if(e){var r=i.get(e);r&&this._removeActionByTag(t,r,e)}else i.forEach((function(e){n._removeActionByTag(t,e)}))},e.removeAllActionsByTag=function(t,e){var n=this;t===GSt.TAG_INVALID&&P(1002);var i=this._hashTargets;if(e){var r=i.get(e);r&&this._removeAllActionsByTag(t,r,e)}else i.forEach((function(e){n._removeAllActionsByTag(t,e)}))},e.getActionByTag=function(t,e){t===GSt.TAG_INVALID&&P(1004);var n=this._hashTargets.get(e);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===t)return r}P(1005,t)}return null},e.getNumberOfRunningActionsInTarget=function(t){var e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0},e.pauseTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!0)},e.resumeTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!1)},e.pauseAllRunningActions=function(){for(var t=[],e=this._arrayTargets,n=0;n<e.length;n++){var i=e[n];i&&!i.paused&&(i.paused=!0,t.push(i.target))}return t},e.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])},e.pauseTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])},e.purgeSharedManager=function(){u.director.getScheduler().unscheduleUpdate(this)},e._removeActionAtIndex=function(t,e){e.actions[t],e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&this._deleteHashElement(e)},e._deleteHashElement=function(t){var e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===t){n.splice(i,1);break}this._putElement(t),e=!0}return e},e.update=function(t){for(var e,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(e=this._currentTarget).target;if(r instanceof dl&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!e.paused&&e.actions){for(e.lock=!0,e.actionIndex=0;e.actionIndex<e.actions.length;e.actionIndex++)if(e.currentAction=e.actions[e.actionIndex],e.currentAction){if(e.currentAction.step(t*(e.currentAction._speedMethod?e.currentAction._speed:1)),e.currentAction&&e.currentAction.isDone()){e.currentAction.stop();var o=e.currentAction;e.currentAction=null,this.removeAction(o)}e.currentAction=null}e.lock=!1}0===e.actions.length&&this._deleteHashElement(e)&&i--}}},t}(),qSt=t("TweenSystem",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).actionMgr=new jSt,e}return $(e,t),e.prototype.update=function(t){this.actionMgr.update(t)},Z(e,[{key:"ActionManager",get:function(){return this.actionMgr}}]),e}(PO));qSt.ID="TWEEN",qSt.instance=void 0,VO.on(HO.EVENT_INIT,(function(){var t=new qSt;qSt.instance=t,VO.registerSystem(qSt.ID,t,PO.Priority.MEDIUM)}));var XSt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new e},e}(HSt),YSt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.update=function(){for(var t=this.target.getComponentsInChildren(pF),e=0;e<t.length;++e)t[e].enabled=!0},n.reverse=function(){return new KSt},n.clone=function(){return new e},e}(XSt),KSt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.update=function(){for(var t=this.target.getComponentsInChildren(pF),e=0;e<t.length;++e)t[e].enabled=!1},n.reverse=function(){return new YSt},n.clone=function(){return new e},e}(XSt);!function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;n.update=function(){for(var t=this.target.getComponentsInChildren(pF),e=0;e<t.length;++e){var n=t[e];n.enabled=!n.enabled}},n.reverse=function(){return new e},n.clone=function(){return new e}}(XSt);var QSt=function(t){function e(e){var n;return(n=t.call(this)||this)._isNeedCleanUp=!0,void 0!==e&&n.init(e),n}$(e,t);var n=e.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(t){return this._isNeedCleanUp=t,!0},n.reverse=function(){return new e(this._isNeedCleanUp)},n.clone=function(){return new e(this._isNeedCleanUp)},e}(XSt),ZSt=function(t){function e(e,n,i){var r;return(r=t.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(e,n,i),r}$(e,t);var n=e.prototype;return n.initWithFunction=function(t,e,n){return t&&(this._function=t),e&&(this._selectorTarget=e),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(t){t!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=t)},n.clone=function(){var t=new e;return t.initWithFunction(this._function,this._selectorTarget,this._data),t},e}(XSt),JSt=function(t){function e(e){var n;return(n=t.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===e||isNaN(e)||n.initWithDuration(e),n}$(e,t);var n=e.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(t){return this._duration=0===t?ue.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(t){t._repeatForever=this._repeatForever,t._speed=this._speed,t._timesForRepeat=this._timesForRepeat,t._easeList=this._easeList,t._speedMethod=this._speedMethod,t._repeatMethod=this._repeatMethod},n._reverseEaseList=function(t){if(this._easeList){t._easeList=[];for(var e=0;e<this._easeList.length;e++)t._easeList.push(this._easeList[e])}},n.clone=function(){var t=new e(this._duration);return this._cloneDecoration(t),t},n.easing=function(t){this._easeList?this._easeList.length=0:this._easeList=[];for(var e=0;e<arguments.length;e++)this._easeList.push(arguments[e]);return this},n._computeEaseTime=function(t){return t},n.step=function(t){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=t;var e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(t){GSt.prototype.startWithTarget.call(this,t),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return P(1010),this},n.setAmplitudeRate=function(){P(1011)},n.getAmplitudeRate=function(){return P(1012),0},n.speed=function(t){return t<=0?(P(1013),this):(this._speedMethod=!0,this._speed*=t,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(t){return this._speed=t,this},n.repeat=function(t){return t=Math.round(t),isNaN(t)||t<1?(P(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=t,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},e}(HSt),$St=function(t){function e(n){var i;(i=t.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return O(1019),ot(i);var o=r.length-1;if(o>=0&&null==r[o]&&P(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}$(e,t);var n=e.prototype;return n.initWithTwoActions=function(t,e){if(!t||!e)return O(1025),!1;var n=t._duration,i=e._duration,r=(n*=t._repeatMethod?t._timesForRepeat:1)+(i*=e._repeatMethod?e._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=t,this._actions[1]=e,!0},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t},n.startWithTarget=function(t){JSt.prototype.startWithTarget.call(this,t),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),GSt.prototype.stop.call(this)},n.update=function(t){var e,n,i=0,r=this._split,o=this._actions,a=this._last;(t=this._computeEaseTime(t))<r?(e=0!==r?t/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,e=1===r?1:(t-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),e*=n._timesForRepeat,n.update(e>1?e%1:e),this._last=i)},n.reverse=function(){var t=e._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t._reversed=!0,t},e}(JSt);function tTt(t){var e=t instanceof Array?t:arguments;if(1===e.length)return O(1019),null;var n=e.length-1;n>=0&&null==e[n]&&P(1015);var i=null;if(n>=0){i=e[0];for(var r=1;r<=n;r++)e[r]&&(i=$St._actionOneTwo(i,e[r]))}return i}$St._actionOneTwo=function(t,e){var n=new $St;return n.initWithTwoActions(t,e),n};var eTt=function(t){function e(e,n){var i;return(i=t.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(e,n),i}$(e,t);var n=e.prototype;return n.initWithAction=function(t,e){var n=t._duration*e;return!!this.initWithDuration(n)&&(this._times=e,this._innerAction=t,t instanceof XSt&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone(),this._times),t},n.startWithTarget=function(t){this._total=0,this._nextDt=this._innerAction._duration/this._duration,JSt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.stop=function(){this._innerAction.stop(),GSt.prototype.stop.call(this)},n.update=function(t){t=this._computeEaseTime(t);var e=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(t>=r){for(;t>r&&this._total<i;)e.update(1),this._total++,e.stop(),e.startWithTarget(this.target),r+=e._duration/n,this._nextDt=r>1?1:r;t>=1&&this._total<i&&(e.update(1),this._total++),this._actionInstant||(this._total===i?e.stop():e.update(t-(r-e._duration/n)))}else e.update(t*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var t=new e(this._innerAction.reverse(),this._times);return this._cloneDecoration(t),this._reverseEaseList(t),t},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction},e}(JSt),nTt=function(t){function e(e){var n;return(n=t.call(this)||this)._innerAction=null,e&&n.initWithAction(e),n}$(e,t);var n=e.prototype;return n.initWithAction=function(t){return t?(this._innerAction=t,!0):(O(1026),!1)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone()),t},n.startWithTarget=function(t){JSt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.step=function(t){var e=this._innerAction;e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e._duration))},n.isDone=function(){return!1},n.reverse=function(){var t=new e(this._innerAction.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction},e}(JSt),iTt=function(t){function e(n){var i;(i=t.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return O(1020),ot(i);var o=r.length-1;if(o>=0&&null==r[o]&&P(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}$(e,t);var n=e.prototype;return n.initWithTwoActions=function(t,e){if(!t||!e)return O(1027),!1;var n=!1,i=t._duration,r=e._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=t,this._two=e,i>r?this._two=$St._actionOneTwo(e,aTt(i-r)):i<r&&(this._one=$St._actionOneTwo(t,aTt(r-i))),n=!0),n},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._one.clone(),this._two.clone()),t},n.startWithTarget=function(t){JSt.prototype.startWithTarget.call(this,t),this._one.startWithTarget(t),this._two.startWithTarget(t)},n.stop=function(){this._one.stop(),this._two.stop(),GSt.prototype.stop.call(this)},n.update=function(t){t=this._computeEaseTime(t),this._one&&this._one.update(t),this._two&&this._two.update(t)},n.reverse=function(){var t=e._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},e}(JSt);function rTt(t){var e=t instanceof Array?t:arguments;if(1===e.length)return O(1020),null;e.length>0&&null==e[e.length-1]&&P(1015);for(var n=e[0],i=1;i<e.length;i++)null!=e[i]&&(n=iTt._actionOneTwo(n,e[i]));return n}iTt._actionOneTwo=function(t,e){var n=new iTt;return n.initWithTwoActions(t,e),n};var oTt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.update=function(){},n.reverse=function(){var t=new e(this._duration);return this._cloneDecoration(t),this._reverseEaseList(t),t},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithDuration(this._duration),t},e}(JSt);function aTt(t){return new oTt(t)}var sTt,cTt,lTt,uTt,hTt,fTt,pTt,dTt,_Tt,mTt,vTt,gTt,yTt,xTt,STt,TTt,ETt,bTt,CTt,ATt,wTt,RTt,PTt,ITt,MTt,DTt,OTt,NTt,LTt,BTt,FTt,zTt,kTt,UTt,GTt,HTt,VTt,WTt,jTt,qTt,XTt,YTt,KTt,QTt,ZTt,JTt,$Tt,tEt,eEt,nEt,iEt,rEt,oEt,aEt,sEt,cEt,lEt,uEt,hEt,fEt,pEt=function(t){function e(e){var n;return(n=t.call(this)||this)._other=null,e&&n.initWithAction(e),n}$(e,t);var n=e.prototype;return n.initWithAction=function(t){return t?t===this._other?(O(1029),!1):!!JSt.prototype.initWithDuration.call(this,t._duration)&&(this._other=t,!0):(O(1028),!1)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._other.clone()),t},n.startWithTarget=function(t){JSt.prototype.startWithTarget.call(this,t),this._other.startWithTarget(t)},n.update=function(t){t=this._computeEaseTime(t),this._other&&this._other.update(1-t)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),GSt.prototype.stop.call(this)},e}(JSt),dEt=t("TweenAction",function(t){function e(e,n,i){var r;if((r=t.call(this)||this)._opts=void 0,r._props=void 0,r._originProps=void 0,null==i)i=Object.create(null);else if(function(t){var e=" [Tween:] ",n=" option is not support in v + "+h,i=t;i.delay&&S(e+"delay"+n),i.repeat&&S(e+"repeat"+n),i.repeatDelay&&S(e+"repeatDelay"+n),i.interpolation&&S(e+"interpolation"+n),i.onStop&&S(e+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(t){var e=t.charAt(0);if(/[A-Z]/.test(e)){var n=(t=t.replace(e,e.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)t="linear";else{var r=n[1];switch(i){case"quadratic":t="quad"+r;break;case"quartic":t="quart"+r;break;case"quintic":t="quint"+r;break;case"sinusoidal":t="sine"+r;break;case"exponential":t="expo"+r;break;case"circular":t="circ"+r;break;default:t=i+r}}}}return t}(i.easing)),i.progress||(i.progress=r.progress),i.easing&&"string"==typeof i.easing){var o=i.easing;i.easing=ep[o],i.easing||M(1031,o)}for(var a in r._opts=i,r._props=Object.create(null),n)if(n.hasOwnProperty(a)){var s=n[a];if("function"==typeof s&&(s=s()),null!=s&&"string"!=typeof s){var c=void 0,l=void 0;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(c=ep[s.easing])||M(1031,s.easing):c=s.easing,l=s.progress,s=s.value);var u=Object.create(null);u.value=s,u.easing=c,u.progress=l,r._props[a]=u}}return r._originProps=n,r.initWithDuration(e),r}$(e,t);var n=e.prototype;return n.clone=function(){var t=new e(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t},n.startWithTarget=function(t){JSt.prototype.startWithTarget.call(this,t);var e=!!this._opts.relative,n=this._props;for(var i in n){var r=t[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=e?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=e?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(t){var e=this.target;if(e){var n=this._props,i=this._opts,r=t;i.easing&&(r=i.easing(t));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(t):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var f in u)s.current[f]=l(u[f],h[f],s.current[f],c);e[a]=s.current}i.onUpdate&&i.onUpdate(this.target,t),1===t&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(t,e,n,i){return t+(e-t)*i},e}(JSt)),_Et=function(t){function e(e){var n;return(n=t.call(this)||this)._props=void 0,n._props={},void 0!==e&&n.init(e),n}$(e,t);var n=e.prototype;return n.init=function(t){for(var e in t)this._props[e]=t[e];return!0},n.update=function(){var t=this._props,e=this.target;for(var n in t)e[n]=t[n]},n.clone=function(){var t=new e;return t.init(this._props),t},e}(XSt),mEt=t("Tween",function(){function t(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=GSt.TAG_INVALID,this._target=void 0===t?null:t}var e=t.prototype;return e.tag=function(t){return this._tag=t,this},e.then=function(t){return t instanceof GSt?this._actions.push(t.clone()):this._actions.push(t._union()),this},e.target=function(t){return this._target=t,this},e.start=function(){return this._target?(this._finalAction&&qSt.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),qSt.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(S("Please set target to tween first"),this)},e.stop=function(){return this._finalAction&&qSt.instance.ActionManager.removeAction(this._finalAction),this},e.clone=function(t){var e=this._union();return vEt(t).then(e.clone())},e.union=function(){var t=this._union();return this._actions.length=0,this._actions.push(t),this},e.to=function(t,e,n){(n=n||Object.create(null)).relative=!1;var i=new dEt(t,e,n);return this._actions.push(i),this},e.by=function(t,e,n){(n=n||Object.create(null)).relative=!0;var i=new dEt(t,e,n);return this._actions.push(i),this},e.set=function(t){var e=new _Et(t);return this._actions.push(e),this},e.delay=function(t){var e=aTt(t);return this._actions.push(e),this},e.call=function(t){var e=function(t){return new ZSt(t,void 0,void 0)}(t);return this._actions.push(e),this},e.sequence=function(){var e=t._wrappedSequence.apply(t,arguments);return this._actions.push(e),this},e.parallel=function(){var e=t._wrappedParallel.apply(t,arguments);return this._actions.push(e),this},e.repeat=function(e,n){if(e===1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof t?n._union():r.pop(),r.push(function(t,e){return new eTt(t,e)}(i,e)),this},e.repeatForever=function(e){var n,i=this._actions;return n=e instanceof t?e._union():i.pop(),i.push(function(t){return new nTt(t)}(n)),this},e.reverseTime=function(e){var n,i=this._actions;return n=e instanceof t?e._union():i.pop(),i.push(function(t){return new pEt(t)}(n)),this},e.hide=function(){var t=new KSt;return this._actions.push(t),this},e.show=function(){var t=new YSt;return this._actions.push(t),this},e.removeSelf=function(){var t=new QSt(!1);return this._actions.push(t),this},t.stopAll=function(){qSt.instance.ActionManager.removeAllActions()},t.stopAllByTag=function(t,e){qSt.instance.ActionManager.removeAllActionsByTag(t,e)},t.stopAllByTarget=function(t){qSt.instance.ActionManager.removeAllActionsFromTarget(t)},e._union=function(){var t=this._actions;return 1===t.length?t[0]:tTt(t)},e._destroy=function(){this.stop()},t._wrappedSequence=function(){var e=t._tmp_args;e.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=e[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof t&&(e[i]=r._union())}return tTt.apply(tTt,e)},t._wrappedParallel=function(){var e=t._tmp_args;e.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=e[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof t&&(e[i]=r._union())}return rTt.apply(rTt,e)},t}());function vEt(t){return new mEt(t)}function gEt(t){return S("tweenUtil' is deprecated, please use 'tween' instead "),new mEt(t)}mEt._tmp_args=[],u.Tween=mEt,u.tween=vEt,u.tweenUtil=gEt;var yEt,xEt,SEt,TEt=new An;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(yEt||(yEt={})),ce(yEt),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(xEt||(xEt={})),function(t){t.CLICK="click"}(SEt||(SEt={}));var EEt=function(e){return t({Button:e,ButtonComponent:e}),e}((sTt=dc("cc.Button"),cTt=Ic(),lTt=mc(110),uTt=Ac(),hTt=_c(LV),fTt=Kc(WC),pTt=Gc(),dTt=Lc(),_Tt=Gc(),mTt=Lc(),vTt=Kc(yEt),gTt=Gc(),yTt=Lc(),xTt=Gc(),STt=Lc(),TTt=Gc(),ETt=Lc(),bTt=Gc(),CTt=Lc(),ATt=Gc(),wTt=Lc(),RTt=Fc(),PTt=zc(),ITt=Gc(),MTt=Lc(),DTt=Gc(),OTt=Lc(),NTt=Kc(cH),LTt=Gc(),BTt=Lc(),FTt=Kc(cH),zTt=Gc(),kTt=Lc(),UTt=Kc(cH),GTt=Gc(),HTt=Lc(),VTt=Kc(cH),WTt=Gc(),jTt=Lc(),qTt=Kc([zB]),XTt=Gc(),YTt=Lc(),sTt(KTt=cTt(KTt=lTt(KTt=uTt(KTt=hTt(KTt=Cc((fEt=hEt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"clickEvents",ZTt,ot(e)),ct(e,"_interactable",JTt,ot(e)),ct(e,"_transition",$Tt,ot(e)),ct(e,"_normalColor",tEt,ot(e)),ct(e,"_hoverColor",eEt,ot(e)),ct(e,"_pressedColor",nEt,ot(e)),ct(e,"_disabledColor",iEt,ot(e)),ct(e,"_normalSprite",rEt,ot(e)),ct(e,"_hoverSprite",oEt,ot(e)),ct(e,"_pressedSprite",aEt,ot(e)),ct(e,"_disabledSprite",sEt,ot(e)),ct(e,"_duration",cEt,ot(e)),ct(e,"_zoomScale",lEt,ot(e)),ct(e,"_target",uEt,ot(e)),e._pressed=!1,e._hovered=!1,e._fromColor=new An,e._toColor=new An,e._time=0,e._transitionFinished=!0,e._fromScale=new Rn,e._toScale=new Rn,e._originalScale=null,e._sprite=null,e._targetScale=new Rn,e}$(e,t);var n=e.prototype;return n.__preload=function(){this.target||(this.target=this.node);var t=this.node.getComponent(cY);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(t){var e=this.target;if(!this._transitionFinished&&e&&(this._transition===yEt.COLOR||this._transition===yEt.SCALE)){this._time+=t;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===yEt.COLOR){var i=e._uiProps.uiComp;An.lerp(TEt,this._fromColor,this._toColor,n),i&&(i.color=TEt)}else this.transition===yEt.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=ln(this._fromScale.x,this._toScale.x,n),this._targetScale.y=ln(this._fromScale.y,this._toScale.y,n),e.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var t=this.target;if(t){var e=this._transition;if(e===yEt.COLOR&&this._interactable){var n=t.getComponent(yj);n&&(n.color=this._normalColor)}else e===yEt.SCALE&&this._originalScale&&t.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(HE.TOUCH_START,this._onTouchBegan,this),this.node.on(HE.TOUCH_MOVE,this._onTouchMove,this),this.node.on(HE.TOUCH_END,this._onTouchEnded,this),this.node.on(HE.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(HE.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(HE.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(t){t.on(HE.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(HE.TOUCH_START,this._onTouchBegan,this),this.node.off(HE.TOUCH_MOVE,this._onTouchMove,this),this.node.off(HE.TOUCH_END,this._onTouchEnded,this),this.node.off(HE.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(HE.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(HE.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(t){t.off(HE.TRANSFORM_CHANGED)},n._getTargetSprite=function(t){var e=null;return t&&(e=t.getComponent(cY)),e},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new Rn),Rn.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(t){this._transition===yEt.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)},n._setCurrentStateSpriteFrame=function(t){if(t)switch(this._getButtonState()){case xEt.NORMAL:this._normalSprite=t;break;case xEt.HOVER:this._hoverSprite=t;break;case xEt.PRESSED:this._pressedSprite=t;break;case xEt.DISABLED:this._disabledSprite=t}},n._onTargetColorChanged=function(t){this._transition===yEt.COLOR&&this._setCurrentStateColor(t)},n._setCurrentStateColor=function(t){switch(this._getButtonState()){case xEt.NORMAL:this._normalColor=t;break;case xEt.HOVER:this._hoverColor=t;break;case xEt.PRESSED:this._pressedColor=t;break;case xEt.DISABLED:this._disabledColor=t}},n._onTargetTransformChanged=function(t){t&iy.SCALE&&this._originalScale&&this._transition===yEt.SCALE&&this._transitionFinished&&Rn.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchMove=function(t){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&t){var e=t.touch;if(e){var n,i=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());this._transition===yEt.SCALE&&this.target&&this._originalScale?i?(Rn.copy(this._fromScale,this._originalScale),Rn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?xEt.PRESSED:xEt.NORMAL,this._applyTransition(n)),t&&(t.propagationStopped=!0)}}},n._onTouchEnded=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(zB.emitEvents(this.clickEvents,t),this.node.emit(SEt.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==yEt.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var t=this._getButtonState();this._applyTransition(t)},n._getButtonState=function(){var t=xEt.NORMAL;return this._interactable?this._pressed?t=xEt.PRESSED:this._hovered&&(t=xEt.HOVER):t=xEt.DISABLED,t.toString()},n._updateColorTransition=function(t){var e,n=this[t+"Color"],i=null===(e=this.target)||void 0===e?void 0:e.getComponent(yj);i&&(t===xEt.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(t){var e=this[t+"Sprite"];this._sprite&&e&&(this._sprite.spriteFrame=e)},n._updateScaleTransition=function(t){this._interactable&&(t===xEt.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(Rn.copy(this._fromScale,this._originalScale),Rn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(Rn.copy(this._fromScale,this.target.getScale()),Rn.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(t){var e=this._transition;e===yEt.COLOR?this._updateColorTransition(t):e===yEt.SPRITE?this._updateSpriteTransition(t):e===yEt.SCALE&&this._updateScaleTransition(t)},Z(e,[{key:"target",get:function(){return this._target||this.node},set:function(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(t){this._transition!==t&&(this._transition===yEt.COLOR?this._updateColorTransition(xEt.NORMAL):this._transition===yEt.SPRITE&&this._updateSpriteTransition(xEt.NORMAL),this._transition=t,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(t){this._pressedColor!==t&&this._pressedColor.set(t)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(t){this._hoverColor!==t&&this._hoverColor.set(t)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(t){this._duration!==t&&(this._duration=t)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(t){this._zoomScale!==t&&(this._zoomScale=t)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(t){if(this._normalSprite!==t){this._normalSprite=t;var e=this.node.getComponent(cY);e&&(e.spriteFrame=t),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}}]),e}($u),hEt.Transition=yEt,hEt.EventType=SEt,lt((QTt=fEt).prototype,"target",[fTt,pTt,dTt],Object.getOwnPropertyDescriptor(QTt.prototype,"target"),QTt.prototype),lt(QTt.prototype,"interactable",[_Tt,mTt],Object.getOwnPropertyDescriptor(QTt.prototype,"interactable"),QTt.prototype),lt(QTt.prototype,"transition",[vTt,gTt,yTt],Object.getOwnPropertyDescriptor(QTt.prototype,"transition"),QTt.prototype),lt(QTt.prototype,"normalColor",[xTt,STt],Object.getOwnPropertyDescriptor(QTt.prototype,"normalColor"),QTt.prototype),lt(QTt.prototype,"pressedColor",[TTt,ETt],Object.getOwnPropertyDescriptor(QTt.prototype,"pressedColor"),QTt.prototype),lt(QTt.prototype,"hoverColor",[bTt,CTt],Object.getOwnPropertyDescriptor(QTt.prototype,"hoverColor"),QTt.prototype),lt(QTt.prototype,"disabledColor",[ATt,wTt],Object.getOwnPropertyDescriptor(QTt.prototype,"disabledColor"),QTt.prototype),lt(QTt.prototype,"duration",[RTt,PTt,ITt,MTt],Object.getOwnPropertyDescriptor(QTt.prototype,"duration"),QTt.prototype),lt(QTt.prototype,"zoomScale",[DTt,OTt],Object.getOwnPropertyDescriptor(QTt.prototype,"zoomScale"),QTt.prototype),lt(QTt.prototype,"normalSprite",[NTt,LTt,BTt],Object.getOwnPropertyDescriptor(QTt.prototype,"normalSprite"),QTt.prototype),lt(QTt.prototype,"pressedSprite",[FTt,zTt,kTt],Object.getOwnPropertyDescriptor(QTt.prototype,"pressedSprite"),QTt.prototype),lt(QTt.prototype,"hoverSprite",[UTt,GTt,HTt],Object.getOwnPropertyDescriptor(QTt.prototype,"hoverSprite"),QTt.prototype),lt(QTt.prototype,"disabledSprite",[VTt,WTt,jTt],Object.getOwnPropertyDescriptor(QTt.prototype,"disabledSprite"),QTt.prototype),ZTt=lt(QTt.prototype,"clickEvents",[qTt,xc,XTt,YTt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JTt=lt(QTt.prototype,"_interactable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$Tt=lt(QTt.prototype,"_transition",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yEt.NONE}}),tEt=lt(QTt.prototype,"_normalColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),eEt=lt(QTt.prototype,"_hoverColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(211,211,211,255)}}),nEt=lt(QTt.prototype,"_pressedColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return An.WHITE.clone()}}),iEt=lt(QTt.prototype,"_disabledColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(124,124,124,255)}}),rEt=lt(QTt.prototype,"_normalSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oEt=lt(QTt.prototype,"_hoverSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aEt=lt(QTt.prototype,"_pressedSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sEt=lt(QTt.prototype,"_disabledSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cEt=lt(QTt.prototype,"_duration",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),lEt=lt(QTt.prototype,"_zoomScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),uEt=lt(QTt.prototype,"_target",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KTt=QTt))||KTt)||KTt)||KTt)||KTt)||KTt)||KTt));u.Button=EEt;var bEt,CEt,AEt,wEt=function(){function t(){}return t.add=function(t){var e=this._tabIndexList;-1===e.indexOf(t)&&e.push(t)},t.remove=function(t){var e=this._tabIndexList,n=e.indexOf(t);-1!==n&&e.splice(n,1)},t.resort=function(){this._tabIndexList.sort((function(t,e){return t._delegate.tabIndex-e._delegate.tabIndex}))},t.next=function(t){var e=this._tabIndexList,n=e.indexOf(t);if(t.setFocus(!1),-1!==n){var i=e[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},t}();wEt._tabIndexList=[],function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"}(bEt||(bEt={})),oe(bEt),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(CEt||(CEt={})),oe(CEt),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(AEt||(AEt={})),oe(AEt);var REt,PEt,IEt,MEt,DEt,OEt,NEt,LEt,BEt,FEt,zEt,kEt,UEt,GEt,HEt,VEt,WEt,jEt,qEt,XEt,YEt,KEt,QEt,ZEt,JEt,$Et,tbt,ebt,nbt,ibt,rbt,obt,abt,sbt,cbt,lbt,ubt,hbt,fbt,pbt,dbt,_bt,mbt,vbt,gbt,ybt,xbt,Sbt,Tbt,Ebt,bbt,Cbt,Abt,wbt,Rbt,Pbt,Ibt,Mbt,Dbt,Obt,Nbt,Lbt=function(){function t(){this._editing=!1,this._delegate=null}var e=t.prototype;return e.init=function(){},e.onEnable=function(){},e.update=function(){},e.onDisable=function(){this._editing&&this.endEditing()},e.clear=function(){this._delegate=null},e.setTabIndex=function(){},e.setSize=function(){},e.setFocus=function(t){t?this.beginEditing():this.endEditing()},e.isFocused=function(){return this._editing},e.beginEditing=function(){},e.endEditing=function(){},t}(),Bbt=new Vn,Fbt=new Vn,zbt=new Rn,kbt=null,Ubt=0,Gbt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._delegate=null,e._inputMode=-1,e._inputFlag=-1,e._returnType=-1,e.__eventListeners={},e.__autoResize=!1,e.__orientationChanged=void 0,e._edTxt=null,e._isTextArea=!1,e._textLabelFont=null,e._textLabelFontSize=null,e._textLabelFontColor=null,e._textLabelAlign=null,e._placeholderLabelFont=null,e._placeholderLabelFontSize=null,e._placeholderLabelFontColor=null,e._placeholderLabelAlign=null,e._placeholderLineHeight=null,e._placeholderStyleSheet=null,e._domId="EditBoxId_"+ ++Ubt,e}$(e,t);var n=e.prototype;return n.init=function(t){t&&(this._delegate=t,t.inputMode===CEt.ANY?this._createTextArea():this._createInput(),wEt.add(this),this.setTabIndex(t.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),wEt.remove(this),kbt===this&&(kbt=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(t){this._edTxt.tabIndex=t,wEt.resort()},n.setSize=function(t,e){var n=this._edTxt;n&&(n.style.width=t+"px",n.style.height=e+"px")},n.beginEditing=function(){kbt&&kbt!==this&&kbt.setFocus(!1),this._editing=!0,kbt=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){u.GAME_VIEW&&this._edTxt?(u.gameView.container.appendChild(this._edTxt),u.gameView.head.appendChild(this._placeholderStyleSheet)):GO.container&&this._edTxt&&(GO.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(u.GAME_VIEW?ge(u.gameView.container,this._edTxt):ge(GO.container,this._edTxt))&&this._edTxt&&(u.GAME_VIEW?u.gameView.container.removeChild(this._edTxt):GO.container.removeChild(this._edTxt)),(u.GAME_VIEW?ge(u.gameView.head,this._placeholderStyleSheet):ge(document.head,this._placeholderStyleSheet))&&(u.GAME_VIEW?u.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),lh.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var t=this._edTxt;t&&this._delegate&&(t.style.display="none",this._delegate._showLabels()),lh.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){lh.os!==au.ANDROID&&lh.os!==au.OHOS||(ah.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){lh.os!==au.ANDROID&&lh.os!==au.OHOS||(ah.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var t=this;setTimeout((function(){window.scrollY<40&&t._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){lh.browserType!==iu.WECHAT||lh.os!==au.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var t=this._delegate.node,e=$O.getScaleX(),n=$O.getScaleY(),i=1,r=1;u.GAME_VIEW&&(i=u.gameView.canvas.width/u.game.canvas.width,r=u.gameView.canvas.height/u.game.canvas.height),e*=i,n*=r;var o=$O.getViewportRect(),a=ah.devicePixelRatio;t.getWorldMatrix(Bbt);var s=t._uiProps.uiTransformComp;if(s&&Rn.set(zbt,-s.anchorX*s.width,-s.anchorY*s.height,zbt.z),Vn.transform(Bbt,Bbt,zbt),t._uiProps.uiTransformComp){var c=VO.root.batcher2D.getFirstRenderCamera(t);if(c){c.node.getWorldRT(Fbt);var l=Fbt.m12,h=Fbt.m13,f=qO.center;Fbt.m12=f.x-(Fbt.m00*l+Fbt.m04*h),Fbt.m13=f.y-(Fbt.m01*l+Fbt.m05*h),Vn.multiply(Fbt,Fbt,Bbt),e/=a,n/=a;var p=u.GAME_VIEW?u.gameView.container:GO.container,d=Fbt.m00*e,_=Bbt.m01,m=Bbt.m04,v=Fbt.m05*n,g=parseInt(p&&p.style.paddingLeft||"0");g+=o.x*i/a;var y=parseInt(p&&p.style.paddingBottom||"0");y+=o.y/a;var x="matrix("+d+","+-_+","+-m+","+v+","+(Fbt.m12*e+g)+","+-(Fbt.m13*n+y)+")";this._edTxt.style.transform=x,this._edTxt.style["-webkit-transform"]=x,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var t=this._delegate,e=t.inputMode,n=t.inputFlag,i=t.returnType,r=this._edTxt;if(this._inputMode!==e||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=e,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===AEt.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===AEt.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===AEt.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;e===CEt.EMAIL_ADDR?a="email":e===CEt.NUMERIC||e===CEt.DECIMAL?a="number":e===CEt.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):e===CEt.URL?a="url":(a="text",i===bEt.SEARCH&&(a="search")),r.type=a;var s="none";n===AEt.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===AEt.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var t=this._delegate.maxLength;t<0&&(t=65535),this._edTxt.maxLength=t},n._initStyleSheet=function(){if(this._edTxt){var t=this._edTxt;t.style.color="#000000",t.style.border="0px",t.style.background="transparent",t.style.width="100%",t.style.height="100%",t.style.outline="medium",t.style.padding="0",t.style.textTransform="none",t.style.display="none",t.style.position="absolute",t.style.bottom="0px",t.style.left="2px",t.className="cocosEditBox",t.style.fontFamily="Arial",t.id=this._domId,this._isTextArea?(t.style.resize="none",t.style.overflowY="scroll"):((t=t).type="text",t.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var t=this._delegate,e=this._edTxt;e&&t&&(e.value=t.string,e.placeholder=t.placeholder,this._updateTextLabel(t.textLabel),this._updatePlaceholderLabel(t.placeholderLabel))},n._updateTextLabel=function(t){if(t){var e=t.font;e=!e||e instanceof PH?t.fontFamily:e._fontFamily;var n=t.fontSize*t.node.scale.y;if((this._textLabelFont!==e||this._textLabelFontSize!==n||this._textLabelFontColor!==t.fontColor||this._textLabelAlign!==t.horizontalAlign)&&(this._textLabelFont=e,this._textLabelFontSize=n,this._textLabelFontColor=t.fontColor,this._textLabelAlign=t.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=t.color.toCSS(),i.style.fontFamily=e,t.horizontalAlign){case xj.HorizontalAlign.LEFT:i.style.textAlign="left";break;case xj.HorizontalAlign.CENTER:i.style.textAlign="center";break;case xj.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(t){if(t){var e=t.font;e=!e||e instanceof PH?t.fontFamily:t.font._fontFamily;var n=t.fontSize*t.node.scale.y;if(this._placeholderLabelFont!==e||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==t.fontColor||this._placeholderLabelAlign!==t.horizontalAlign||this._placeholderLineHeight!==t.fontSize){this._placeholderLabelFont=e,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=t.fontColor,this._placeholderLabelAlign=t.horizontalAlign,this._placeholderLineHeight=t.fontSize;var i=this._placeholderStyleSheet,r=t.color.toCSS(),o=t.fontSize,a="";switch(t.horizontalAlign){case xj.HorizontalAlign.LEFT:a="left";break;case xj.HorizontalAlign.CENTER:a="center";break;case xj.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",lh.browserType===iu.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var t=this;if(this._edTxt){var e=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,t._delegate._editBoxTextChanged(e.value)},i.onInput=function(){if(!n){var i=t._delegate,r=i.maxLength;r>=0&&(e.value=e.value.slice(0,r)),i._editBoxTextChanged(e.value)}},i.onClick=function(){t._editing&&lh.isMobile&&t._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===YI.ENTER?(n.propagationStopped=!0,t._delegate._editBoxEditingReturn(),t._isTextArea||e.blur()):n.keyCode===YI.TAB&&(n.propagationStopped=!0,n.preventDefault(),wEt.next(t))},i.onBlur=function(){lh.isMobile&&n&&i.compositionEnd(),t._editing=!1,kbt=null,t._hideDom(),t._delegate._editBoxEditingDidEnded()},e.addEventListener("compositionstart",i.compositionStart),e.addEventListener("compositionend",i.compositionEnd),e.addEventListener("input",i.onInput),e.addEventListener("keydown",i.onKeydown),e.addEventListener("blur",i.onBlur),e.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var t=this._edTxt,e=this.__eventListeners;t.removeEventListener("compositionstart",e.compositionStart),t.removeEventListener("compositionend",e.compositionEnd),t.removeEventListener("input",e.onInput),t.removeEventListener("keydown",e.onKeydown),t.removeEventListener("blur",e.onBlur),t.removeEventListener("touchstart",e.onClick),e.compositionStart=null,e.compositionEnd=null,e.onInput=null,e.onKeydown=null,e.onBlur=null,e.onClick=null}},e}(Lbt);!function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(Nbt||(Nbt={}));var Hbt,Vbt,Wbt,jbt,qbt,Xbt,Ybt,Kbt,Qbt,Zbt,Jbt,$bt,tCt,eCt,nCt,iCt,rCt,oCt,aCt,sCt,cCt,lCt,uCt,hCt,fCt,pCt,dCt,_Ct,mCt,vCt,gCt,yCt,xCt,SCt,TCt,ECt,bCt,CCt,ACt,wCt,RCt,PCt,ICt,MCt,DCt,OCt,NCt,LCt,BCt,FCt,zCt,kCt,UCt,GCt,HCt,VCt,WCt,jCt,qCt,XCt,YCt,KCt=function(e){return t({EditBox:e,EditBoxComponent:e}),e}((REt=dc("cc.EditBox"),PEt=Ic(),IEt=mc(110),MEt=Ac(),DEt=_c(LV),OEt=Gc(),NEt=Lc(),LEt=Gc(),BEt=Lc(),FEt=Kc(xj),zEt=Gc(),kEt=Lc(),UEt=Kc(xj),GEt=Gc(),HEt=Lc(),VEt=Kc(cH),WEt=Gc(),jEt=Lc(),qEt=Kc(AEt),XEt=Gc(),YEt=Lc(),KEt=Kc(CEt),QEt=Gc(),ZEt=Lc(),JEt=Kc(bEt),$Et=Gc(),tbt=Lc(),ebt=Gc(),nbt=Lc(),ibt=Gc(),rbt=Lc(),obt=Kc([zB]),abt=Gc(),sbt=Lc(),cbt=Kc([zB]),lbt=Gc(),ubt=Lc(),hbt=Kc([zB]),fbt=Gc(),pbt=Lc(),dbt=Kc([zB]),_bt=Gc(),mbt=Lc(),REt(vbt=PEt(vbt=IEt(vbt=MEt(vbt=DEt(vbt=Cc((Obt=Dbt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"editingDidBegan",ybt,ot(e)),ct(e,"textChanged",xbt,ot(e)),ct(e,"editingDidEnded",Sbt,ot(e)),ct(e,"editingReturn",Tbt,ot(e)),e._impl=null,e._background=null,ct(e,"_textLabel",Ebt,ot(e)),ct(e,"_placeholderLabel",bbt,ot(e)),ct(e,"_returnType",Cbt,ot(e)),ct(e,"_string",Abt,ot(e)),ct(e,"_tabIndex",wbt,ot(e)),ct(e,"_backgroundImage",Rbt,ot(e)),ct(e,"_inputFlag",Pbt,ot(e)),ct(e,"_inputMode",Ibt,ot(e)),ct(e,"_maxLength",Mbt,ot(e)),e._isLabelVisible=!1,e}$(e,t);var n=e.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){zB.emitEvents(this.editingDidBegan,this),this.node.emit(Nbt.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){zB.emitEvents(this.editingDidEnded,this),this.node.emit(Nbt.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(t){t=this._updateLabelStringStyle(t,!0),this.string=t,zB.emitEvents(this.textChanged,t,this),this.node.emit(Nbt.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){zB.emitEvents(this.editingReturn,this),this.node.emit(Nbt.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(t){t.propagationStopped=!0},n._onTouchCancel=function(t){t.propagationStopped=!0},n._onTouchEnded=function(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(HE.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new e._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var t=this.node.getComponent(cY);t||(t=this.node.addComponent(cY)),t!==this._background&&(t.type=cY.Type.SLICED,t.spriteFrame=this._backgroundImage,this._background=t,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var t=this._textLabel;if(!t){var e=this.node.getChildByName("TEXT_LABEL");e||((e=new WC("TEXT_LABEL")).layer=this.node.layer),(t=e.getComponent(xj))||(t=e.addComponent(xj)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=xj.Overflow.CLAMP,this._inputMode===CEt.ANY?(t.verticalAlign=mj.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var t=this._placeholderLabel;if(!t){var e=this.node.getChildByName("PLACEHOLDER_LABEL");e||((e=new WC("PLACEHOLDER_LABEL")).layer=this.node.layer),(t=e.getComponent(xj))||(t=e.addComponent(xj)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=xj.Overflow.CLAMP,this._inputMode===CEt.ANY?(t.verticalAlign=mj.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder},n._syncSize=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=t.anchorPoint,n.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)},n._updateLabels=function(){if(this._isLabelVisible){var t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}},n._updateString=function(t){var e=this._textLabel;if(e){var n=t;n&&(n=this._updateLabelStringStyle(n)),e.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(t,e){void 0===e&&(e=!1);var n,i=this._inputFlag;if(e||i!==AEt.PASSWORD)i===AEt.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():i===AEt.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(function(t){return t.toUpperCase()})):i===AEt.INITIAL_CAPS_SENTENCE&&(t=(n=t).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=t.length,a=0;a<o;++a)r+="●";t=r}return t},n._registerEvent=function(){this.node.on(HE.TOUCH_START,this._onTouchBegan,this),this.node.on(HE.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(HE.TOUCH_START,this._onTouchBegan,this),this.node.off(HE.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.on(cY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.off(cY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=-e.anchorX*e.width,i=-e.anchorY*e.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),o.node.setPosition(n+2,i+t.height,o.node.position.z),this._inputMode===CEt.ANY&&(o.verticalAlign=mj.TOP),o.enableWrapText=this._inputMode===CEt.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.lineHeight=t.height,r.node.setPosition(n+2,i+t.height,r.node.position.z),this._inputMode===CEt.ANY&&(r.verticalAlign=mj.TOP),r.enableWrapText=this._inputMode===CEt.ANY)},n._resizeChildNodes=function(){var t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-t.width/2,t.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(t.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(t.contentSize),this._syncSize()},Z(e,[{key:"string",get:function(){return this._string},set:function(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}},{key:"textLabel",get:function(){return this._textLabel},set:function(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._ensureBackgroundSprite(),this._background.spriteFrame=t)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(t){this._inputFlag=t,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(t){this._returnType=t}},{key:"maxLength",get:function(){return this._maxLength},set:function(t){this._maxLength=t}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}}]),e}($u),Dbt._EditBoxImpl=Lbt,Dbt.KeyboardReturnType=bEt,Dbt.InputFlag=AEt,Dbt.InputMode=CEt,Dbt.EventType=Nbt,lt((gbt=Obt).prototype,"string",[OEt,NEt],Object.getOwnPropertyDescriptor(gbt.prototype,"string"),gbt.prototype),lt(gbt.prototype,"placeholder",[LEt,BEt],Object.getOwnPropertyDescriptor(gbt.prototype,"placeholder"),gbt.prototype),lt(gbt.prototype,"textLabel",[FEt,zEt,kEt],Object.getOwnPropertyDescriptor(gbt.prototype,"textLabel"),gbt.prototype),lt(gbt.prototype,"placeholderLabel",[UEt,GEt,HEt],Object.getOwnPropertyDescriptor(gbt.prototype,"placeholderLabel"),gbt.prototype),lt(gbt.prototype,"backgroundImage",[VEt,WEt,jEt],Object.getOwnPropertyDescriptor(gbt.prototype,"backgroundImage"),gbt.prototype),lt(gbt.prototype,"inputFlag",[qEt,XEt,YEt],Object.getOwnPropertyDescriptor(gbt.prototype,"inputFlag"),gbt.prototype),lt(gbt.prototype,"inputMode",[KEt,QEt,ZEt],Object.getOwnPropertyDescriptor(gbt.prototype,"inputMode"),gbt.prototype),lt(gbt.prototype,"returnType",[JEt,$Et,tbt],Object.getOwnPropertyDescriptor(gbt.prototype,"returnType"),gbt.prototype),lt(gbt.prototype,"maxLength",[ebt,nbt],Object.getOwnPropertyDescriptor(gbt.prototype,"maxLength"),gbt.prototype),lt(gbt.prototype,"tabIndex",[ibt,rbt],Object.getOwnPropertyDescriptor(gbt.prototype,"tabIndex"),gbt.prototype),ybt=lt(gbt.prototype,"editingDidBegan",[obt,xc,abt,sbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xbt=lt(gbt.prototype,"textChanged",[cbt,xc,lbt,ubt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sbt=lt(gbt.prototype,"editingDidEnded",[hbt,xc,fbt,pbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tbt=lt(gbt.prototype,"editingReturn",[dbt,xc,_bt,mbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ebt=lt(gbt.prototype,"_textLabel",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bbt=lt(gbt.prototype,"_placeholderLabel",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cbt=lt(gbt.prototype,"_returnType",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bEt.DEFAULT}}),Abt=lt(gbt.prototype,"_string",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wbt=lt(gbt.prototype,"_tabIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rbt=lt(gbt.prototype,"_backgroundImage",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pbt=lt(gbt.prototype,"_inputFlag",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AEt.DEFAULT}}),Ibt=lt(gbt.prototype,"_inputMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CEt.ANY}}),Mbt=lt(gbt.prototype,"_maxLength",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),vbt=gbt))||vbt)||vbt)||vbt)||vbt)||vbt)||vbt));"object"==typeof window&&"object"==typeof document&&(KCt._EditBoxImpl=Gbt),u.internal.EditBox=KCt,function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(VCt||(VCt={})),ce(VCt),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(WCt||(WCt={})),ce(WCt),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(jCt||(jCt={})),ce(jCt),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(qCt||(qCt={})),ce(qCt),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(XCt||(XCt={})),ce(XCt),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(YCt||(YCt={})),ce(YCt);var QCt,ZCt,JCt,$Ct,tAt,eAt,nAt,iAt,rAt,oAt,aAt,sAt,cAt,lAt,uAt,hAt,fAt,pAt,dAt,_At,mAt,vAt,gAt,yAt=new Rn,xAt=function(e){return t({Layout:e,LayoutComponent:e}),e}((Hbt=dc("cc.Layout"),Vbt=Ic(),Wbt=mc(110),jbt=Ac(),qbt=_c(LV),Xbt=Dc(),Ybt=Lc(),Kbt=Dc(),Qbt=Lc(),Zbt=Kc(VCt),Jbt=Gc(),$bt=Lc(),tCt=Kc(WCt),eCt=Dc(),nCt=Lc(),iCt=Dc(),rCt=Lc(),oCt=Kc(jCt),aCt=Lc(),sCt=Lc(),cCt=Lc(),lCt=Lc(),uCt=Lc(),hCt=Lc(),fCt=Lc(),pCt=Kc(qCt),dCt=Lc(),_Ct=Kc(XCt),mCt=Lc(),vCt=Kc(YCt),gCt=Dc(),yCt=Lc(),xCt=Dc(),SCt=Lc(),TCt=Lc(),Hbt(ECt=Vbt(ECt=Wbt(ECt=jbt(ECt=qbt(ECt=Cc((HCt=GCt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_resizeMode",CCt,ot(e)),ct(e,"_layoutType",ACt,ot(e)),ct(e,"_cellSize",wCt,ot(e)),ct(e,"_startAxis",RCt,ot(e)),ct(e,"_paddingLeft",PCt,ot(e)),ct(e,"_paddingRight",ICt,ot(e)),ct(e,"_paddingTop",MCt,ot(e)),ct(e,"_paddingBottom",DCt,ot(e)),ct(e,"_spacingX",OCt,ot(e)),ct(e,"_spacingY",NCt,ot(e)),ct(e,"_verticalDirection",LCt,ot(e)),ct(e,"_horizontalDirection",BCt,ot(e)),ct(e,"_constraint",FCt,ot(e)),ct(e,"_constraintNum",zCt,ot(e)),ct(e,"_affectedByScale",kCt,ot(e)),ct(e,"_isAlign",UCt,ot(e)),e._layoutSize=new ti(300,200),e._layoutDirty=!0,e._childrenDirty=!1,e._usefulLayoutObj=[],e._init=!1,e}$(e,t);var n=e.prototype;return n.updateLayout=function(t){void 0===t&&(t=!1),(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var t=this.node._uiProps.uiTransformComp;t.contentSize.equals(ti.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){VO.on(HO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(HE.SIZE_CHANGED,this._resized,this),this.node.on(HE.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(HE.CHILD_ADDED,this._childAdded,this),this.node.on(HE.CHILD_REMOVED,this._childRemoved,this),this.node.on(HE.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){VO.off(HO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(HE.SIZE_CHANGED,this._resized,this),this.node.off(HE.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(HE.CHILD_ADDED,this._childAdded,this),this.node.off(HE.CHILD_REMOVED,this._childRemoved,this),this.node.off(HE.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.on(HE.SIZE_CHANGED,this._doLayoutDirty,this),n.on(HE.TRANSFORM_CHANGED,this._transformDirty,this),n.on(HE.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(HE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.off(HE.SIZE_CHANGED,this._doLayoutDirty,this),n.off(HE.TRANSFORM_CHANGED,this._transformDirty,this),n.off(HE.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(HE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(t){t.on(HE.SIZE_CHANGED,this._doLayoutDirty,this),t.on(HE.TRANSFORM_CHANGED,this._transformDirty,this),t.on(HE.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on(HE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(t){t.off(HE.SIZE_CHANGED,this._doLayoutDirty,this),t.off(HE.TRANSFORM_CHANGED,this._transformDirty,this),t.off(HE.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off(HE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===XCt.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*t+a*s,l=c-a*this._spacingX,u=0,h=0,f=0,p=0,d=!1,_=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==VCt.GRID&&this._resizeMode===WCt.CHILDREN&&(m=(t-v-(_-1)*this._spacingX)/_);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,T=S.scale,E=this._getUsedScaleValue(T.x),b=this._getUsedScaleValue(T.y);this._resizeMode===WCt.CHILDREN&&(x.width=m/E,this._layoutType===VCt.GRID&&(x.height=this._cellSize.height/b));var C=Math.abs(this._horizontalDirection-x.anchorX),A=x.width*E,w=x.height*b;w>f&&(p=Math.max(f,p),h=f||w,f=w),l+=a*(C*A+this._spacingX);var R=a*(1-C)*A;if(e){if(o>0)(d=y/o>0&&y%o==0)&&(h=f>w?f:h);else if(A>t-v)l>c+a*C*A&&(d=!0);else{var P=(1-this._horizontalDirection-r.x)*t,I=l+R+a*(a>0?this._paddingRight:this._paddingLeft);d=Math.abs(I)>Math.abs(P)}d&&(l=c+a*C*A,w!==f&&(h=f),u+=h+this._spacingY,h=f=w)}var M=n(S,x,u);i&&S.setPosition(l,M),l+=R}return h=Math.max(h,f),Math.max(p,u+h)+this._getPaddingV()},n._doLayoutVertically=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===qCt.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*t+a*s,l=c-a*this._spacingY,u=0,h=0,f=0,p=0,d=!1,_=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==VCt.GRID&&this._resizeMode===WCt.CHILDREN&&(m=(t-v-(_-1)*this._spacingY)/_);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,T=S.scale,E=this._getUsedScaleValue(T.x),b=this._getUsedScaleValue(T.y);this._resizeMode===WCt.CHILDREN&&(x.height=m/b,this._layoutType===VCt.GRID&&(x.width=this._cellSize.width/E));var C=Math.abs(this._verticalDirection-x.anchorY),A=x.width*E,w=x.height*b;A>u&&(h=Math.max(u,h),f=u||A,u=A),l+=a*(C*w+this._spacingY);var R=a*(1-C)*w;if(e){if(o>0)(d=y/o>0&&y%o==0)&&(f=u>w?u:f);else if(w>t-v)l>c+a*C*w&&(d=!0);else{var P=(1-this._verticalDirection-r.y)*t,I=l+R+a*(a>0?this._paddingTop:this._paddingBottom);d=Math.abs(I)>Math.abs(P)}d&&(l=c+a*C*w,A!==u&&(f=u),p+=f+this._spacingX,f=u=A)}var M=n(S,x,p);i&&(S.getPosition(yAt),S.setPosition(M,l,yAt.z)),l+=R}return f=Math.max(f,u),Math.max(h,p+f)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(t,e){var n=this,i=e.width,r=1,o=-t.y*e.height,a=this._paddingBottom;this._verticalDirection===qCt.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*e.height,a=this._paddingTop);var s=function(t,e,i){return o+r*(i+(1-e.anchorY)*e.height*n._getUsedScaleValue(t.scale.y)+a)},c=0;this._resizeMode===WCt.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-t.y*c,this._verticalDirection===qCt.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===WCt.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(t,e){var n=this,i=e.height,r=1,o=-t.x*e.width,a=this._paddingLeft;this._horizontalDirection===XCt.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*e.width,a=this._paddingRight);var s=function(t,e,i){return o+r*(i+(1-e.anchorX)*e.width*n._getUsedScaleValue(t.scale.x)+a)},c=0;this._resizeMode===WCt.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-t.x*c,this._horizontalDirection===XCt.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===WCt.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,n=t.contentSize;this.startAxis===jCt.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,n):this.startAxis===jCt.VERTICAL&&this._doLayoutGridAxisVertical(e,n)},n._getHorizontalBaseWidth=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===WCt.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.width*this._getUsedScaleValue(o.x)}e+=(n-1)*this._spacingX+this._getPaddingH()}else e=this.node._uiProps.uiTransformComp.width;return e},n._getVerticalBaseHeight=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===WCt.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.height*this._getUsedScaleValue(o.y)}e+=(n-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e},n._doLayout=function(){var t=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===VCt.HORIZONTAL){var e=this._getHorizontalBaseWidth();this._doLayoutHorizontally(e,!1,(function(e){return(t._isAlign?Rn.ZERO:e.position).y}),!0),this.node._uiProps.uiTransformComp.width=e}else if(this._layoutType===VCt.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(e){return(t._isAlign?Rn.ZERO:e.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===VCt.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(t){return this._affectedByScale?Math.abs(t):1},n._transformDirty=function(t){t&iy.SCALE&&t&iy.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==VCt.GRID||this._constraint===YCt.NONE||this._constraintNum<=0)return 0;var t=this._constraint===YCt.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===jCt.VERTICAL&&(t=this._constraint===YCt.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t},Z(e,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(t){this._layoutType===VCt.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(t){this._layoutType===VCt.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(t){this._layoutType=t,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(t){this._layoutType!==VCt.NONE&&(this._resizeMode=t,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(t){this._layoutType!==VCt.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(t){this._constraint!==YCt.NONE&&this._constraintNum!==t&&(t<=0&&S("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(t){this._affectedByScale=t,this._doLayoutDirty()}}]),e}($u),GCt.Type=VCt,GCt.VerticalDirection=qCt,GCt.HorizontalDirection=XCt,GCt.ResizeMode=WCt,GCt.AxisDirection=jCt,GCt.Constraint=YCt,lt((bCt=HCt).prototype,"alignHorizontal",[Xbt,Ybt],Object.getOwnPropertyDescriptor(bCt.prototype,"alignHorizontal"),bCt.prototype),lt(bCt.prototype,"alignVertical",[Kbt,Qbt],Object.getOwnPropertyDescriptor(bCt.prototype,"alignVertical"),bCt.prototype),lt(bCt.prototype,"type",[Zbt,Jbt,$bt],Object.getOwnPropertyDescriptor(bCt.prototype,"type"),bCt.prototype),lt(bCt.prototype,"resizeMode",[tCt,eCt,nCt],Object.getOwnPropertyDescriptor(bCt.prototype,"resizeMode"),bCt.prototype),lt(bCt.prototype,"cellSize",[iCt,rCt],Object.getOwnPropertyDescriptor(bCt.prototype,"cellSize"),bCt.prototype),lt(bCt.prototype,"startAxis",[oCt,aCt],Object.getOwnPropertyDescriptor(bCt.prototype,"startAxis"),bCt.prototype),lt(bCt.prototype,"paddingLeft",[sCt],Object.getOwnPropertyDescriptor(bCt.prototype,"paddingLeft"),bCt.prototype),lt(bCt.prototype,"paddingRight",[cCt],Object.getOwnPropertyDescriptor(bCt.prototype,"paddingRight"),bCt.prototype),lt(bCt.prototype,"paddingTop",[lCt],Object.getOwnPropertyDescriptor(bCt.prototype,"paddingTop"),bCt.prototype),lt(bCt.prototype,"paddingBottom",[uCt],Object.getOwnPropertyDescriptor(bCt.prototype,"paddingBottom"),bCt.prototype),lt(bCt.prototype,"spacingX",[hCt],Object.getOwnPropertyDescriptor(bCt.prototype,"spacingX"),bCt.prototype),lt(bCt.prototype,"spacingY",[fCt],Object.getOwnPropertyDescriptor(bCt.prototype,"spacingY"),bCt.prototype),lt(bCt.prototype,"verticalDirection",[pCt,dCt],Object.getOwnPropertyDescriptor(bCt.prototype,"verticalDirection"),bCt.prototype),lt(bCt.prototype,"horizontalDirection",[_Ct,mCt],Object.getOwnPropertyDescriptor(bCt.prototype,"horizontalDirection"),bCt.prototype),lt(bCt.prototype,"constraint",[vCt,gCt,yCt],Object.getOwnPropertyDescriptor(bCt.prototype,"constraint"),bCt.prototype),lt(bCt.prototype,"constraintNum",[xCt,SCt],Object.getOwnPropertyDescriptor(bCt.prototype,"constraintNum"),bCt.prototype),lt(bCt.prototype,"affectedByScale",[TCt],Object.getOwnPropertyDescriptor(bCt.prototype,"affectedByScale"),bCt.prototype),CCt=lt(bCt.prototype,"_resizeMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WCt.NONE}}),ACt=lt(bCt.prototype,"_layoutType",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VCt.NONE}}),wCt=lt(bCt.prototype,"_cellSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(40,40)}}),RCt=lt(bCt.prototype,"_startAxis",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jCt.HORIZONTAL}}),PCt=lt(bCt.prototype,"_paddingLeft",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ICt=lt(bCt.prototype,"_paddingRight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MCt=lt(bCt.prototype,"_paddingTop",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DCt=lt(bCt.prototype,"_paddingBottom",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OCt=lt(bCt.prototype,"_spacingX",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NCt=lt(bCt.prototype,"_spacingY",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LCt=lt(bCt.prototype,"_verticalDirection",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qCt.TOP_TO_BOTTOM}}),BCt=lt(bCt.prototype,"_horizontalDirection",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XCt.LEFT_TO_RIGHT}}),FCt=lt(bCt.prototype,"_constraint",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YCt.NONE}}),zCt=lt(bCt.prototype,"_constraintNum",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),kCt=lt(bCt.prototype,"_affectedByScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UCt=lt(bCt.prototype,"_isAlign",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ECt=bCt))||ECt)||ECt)||ECt)||ECt)||ECt)||ECt));u.Layout=xAt,function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(gAt||(gAt={})),oe(gAt);var SAt,TAt,EAt,bAt,CAt,AAt,wAt,RAt,PAt,IAt,MAt,DAt,OAt,NAt,LAt,BAt,FAt,zAt,kAt,UAt,GAt,HAt,VAt,WAt,jAt=function(e){return t({ProgressBar:e,ProgressBarComponent:e}),e}((QCt=dc("cc.ProgressBar"),ZCt=Ic(),JCt=mc(110),$Ct=Ac(),tAt=_c(LV),eAt=Kc(cY),nAt=Lc(),iAt=Kc(gAt),rAt=Lc(),oAt=Lc(),aAt=Bc(),sAt=Lc(),cAt=Lc(),QCt(lAt=ZCt(lAt=JCt(lAt=$Ct(lAt=tAt((vAt=mAt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_barSprite",hAt,ot(e)),ct(e,"_mode",fAt,ot(e)),ct(e,"_totalLength",pAt,ot(e)),ct(e,"_progress",dAt,ot(e)),ct(e,"_reverse",_At,ot(e)),e}$(e,t);var n=e.prototype;return n._initBarSprite=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===cY.FillType.RADIAL&&(this._mode=gAt.FILLED),this._mode===gAt.HORIZONTAL?this.totalLength=r.width:this._mode===gAt.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){var o=-n.width*i.x;t.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=t._uiProps.uiTransformComp,n=e.anchorPoint,i=e.contentSize,r=t.getPosition(),o=new Xn(0,.5),a=cn(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case gAt.HORIZONTAL:this._reverse&&(o=new Xn(1,.5)),c=new ti(s,i.height),l=this._totalLength,u=i.height;break;case gAt.VERTICAL:o=this._reverse?new Xn(.5,1):new Xn(.5,0),c=new ti(i.width,s),l=i.width,u=this._totalLength}if(this._mode===gAt.FILLED)this._barSprite.type!==cY.Type.FILLED?S("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==cY.Type.FILLED){var h=o.x-n.x,f=o.y-n.y,p=new Rn(l*h,u*f,0);t.setPosition(r.x+p.x,r.y+p.y,r.z),e.setAnchorPoint(o),e.setContentSize(c)}else S("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},Z(e,[{key:"barSprite",get:function(){return this._barSprite},set:function(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){var e=this._barSprite.node;if(!e)return;var n=e._uiProps.uiTransformComp.contentSize;this._mode===gAt.HORIZONTAL?this.totalLength=n.width:this._mode===gAt.VERTICAL?this.totalLength=n.height:this._mode===gAt.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(t){this._mode===gAt.FILLED&&(t=cn(t)),this._totalLength=t,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),e}($u),mAt.Mode=gAt,lt((uAt=vAt).prototype,"barSprite",[eAt,nAt],Object.getOwnPropertyDescriptor(uAt.prototype,"barSprite"),uAt.prototype),lt(uAt.prototype,"mode",[iAt,rAt],Object.getOwnPropertyDescriptor(uAt.prototype,"mode"),uAt.prototype),lt(uAt.prototype,"totalLength",[oAt],Object.getOwnPropertyDescriptor(uAt.prototype,"totalLength"),uAt.prototype),lt(uAt.prototype,"progress",[aAt,Uc,sAt],Object.getOwnPropertyDescriptor(uAt.prototype,"progress"),uAt.prototype),lt(uAt.prototype,"reverse",[cAt],Object.getOwnPropertyDescriptor(uAt.prototype,"reverse"),uAt.prototype),hAt=lt(uAt.prototype,"_barSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fAt=lt(uAt.prototype,"_mode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gAt.HORIZONTAL}}),pAt=lt(uAt.prototype,"_totalLength",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),dAt=lt(uAt.prototype,"_progress",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_At=lt(uAt.prototype,"_reverse",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lAt=uAt))||lAt)||lAt)||lAt)||lAt)||lAt));u.ProgressBar=jAt;var qAt,XAt=new Rn,YAt=new Rn,KAt=new Rn,QAt=new Xn,ZAt=new An,JAt=new Xn;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(qAt||(qAt={})),ce(qAt);var $At,twt=function(e){return t({ScrollBar:e,ScrollBarComponent:e}),e}((SAt=dc("cc.ScrollBar"),TAt=Ic(),EAt=mc(110),bAt=Ac(),CAt=_c(LV),AAt=Kc(cY),wAt=Gc(),RAt=Lc(),PAt=Kc(qAt),IAt=Gc(),MAt=Lc(),DAt=Gc(),OAt=Lc(),NAt=Gc(),LAt=Lc(),SAt(BAt=TAt(BAt=EAt(BAt=bAt(BAt=CAt((WAt=VAt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_scrollView",zAt,ot(e)),ct(e,"_handle",kAt,ot(e)),ct(e,"_direction",UAt,ot(e)),ct(e,"_enableAutoHide",GAt,ot(e)),ct(e,"_autoHideTime",HAt,ot(e)),e._touching=!1,e._opacity=255,e._autoHideRemainingTime=0,e}$(e,t);var n=e.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(t){if(this._scrollView){var e=this._scrollView.content;if(e){var n=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=JAt;u.set(0,0),this._direction===qAt.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=t.x,this._convertToScrollViewSpace(u,e),c=-u.x):this._direction===qAt.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=t.y,this._convertToScrollViewSpace(u,e),c=-u.y);var h=this._calculateLength(o,a,l,s),f=JAt;this._calculatePosition(f,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(f)}}}},n.setScrollView=function(t){this._scrollView=t},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var t=this._scrollView.content;if(t){var e=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var t=this.node.getComponent(cY);t&&(this._opacity=t.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(t){this._processAutoHide(t)},n._convertToScrollViewSpace=function(t,e){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(n&&i){XAt.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(XAt,YAt);var r=n.convertToNodeSpaceAR(YAt);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,t.set(r.x,r.y)}else t.set(Xn.ZERO)},n._setOpacity=function(t){if(this._handle){var e=this.node.getComponent(cY);e&&(ZAt.set(e.color),ZAt.a=t,e.color=ZAt),(e=this._handle.getComponent(cY))&&(ZAt.set(e.color),ZAt.a=t,e.color=ZAt)}},n._updateHandlerPosition=function(t){if(this._handle){var e=KAt;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}},n._fixupHandlerPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;Rn.set(XAt,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(XAt,YAt),s=t;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===qAt.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===qAt.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(t,e){return t.width<=e.width&&this._direction===qAt.HORIZONTAL||t.height<=e.height&&this._direction===qAt.VERTICAL},n._calculateLength=function(t,e,n,i){var r=t;return i&&(r+=20*(i>0?i:-i)),n*(e/r)},n._calculatePosition=function(t,e,n,i,r,o,a){var s=e-n;o&&(s+=Math.abs(o));var c=0;s&&(c=cn(c=r/s));var l=(i-a)*c;this._direction===qAt.VERTICAL?t.set(0,l):t.set(l,0)},n._updateLength=function(t){if(this._handle){var e=this._handle.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint;i.x===QAt.x&&i.y===QAt.y||e.setAnchorPoint(QAt),this._direction===qAt.HORIZONTAL?e.setContentSize(t,n.height):e.setContentSize(n.width,t)}},n._processAutoHide=function(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var e=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(e)}},Z(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t,this.onScroll(Xn.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this.onScroll(Xn.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(t){this._autoHideTime!==t&&(this._autoHideTime=t)}}]),e}($u),VAt.Direction=qAt,lt((FAt=WAt).prototype,"handle",[AAt,wAt,RAt],Object.getOwnPropertyDescriptor(FAt.prototype,"handle"),FAt.prototype),lt(FAt.prototype,"direction",[PAt,IAt,MAt],Object.getOwnPropertyDescriptor(FAt.prototype,"direction"),FAt.prototype),lt(FAt.prototype,"enableAutoHide",[DAt,OAt],Object.getOwnPropertyDescriptor(FAt.prototype,"enableAutoHide"),FAt.prototype),lt(FAt.prototype,"autoHideTime",[NAt,LAt],Object.getOwnPropertyDescriptor(FAt.prototype,"autoHideTime"),FAt.prototype),zAt=lt(FAt.prototype,"_scrollView",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kAt=lt(FAt.prototype,"_handle",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UAt=lt(FAt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qAt.HORIZONTAL}}),GAt=lt(FAt.prototype,"_enableAutoHide",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HAt=lt(FAt.prototype,"_autoHideTime",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),BAt=FAt))||BAt)||BAt)||BAt)||BAt)||BAt));u.ScrollBar=twt;var ewt,nwt,iwt,rwt,owt,awt,swt,cwt,lwt,uwt,hwt,fwt,pwt,dwt,_wt,mwt,vwt,gwt,ywt,xwt,Swt,Twt,Ewt,bwt,Cwt,Awt,wwt,Rwt,Pwt,Iwt,Mwt,Dwt,Owt,Nwt,Lwt,Bwt,Fwt,zwt,kwt,Uwt,Gwt,Hwt,Vwt,Wwt,jwt,qwt,Xwt,Ywt,Kwt=t("ViewGroup",dc("cc.ViewGroup")($At=mc(110)($At=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}($u))||$At)||$At);u.ViewGroup=Kwt;var Qwt,Zwt=1e-4,Jwt=new Rn,$wt=new Rn,tRt=new Xn,eRt=new Xn,nRt=function(){return(new Date).getMilliseconds()},iRt={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(Qwt||(Qwt={}));var rRt,oRt,aRt,sRt,cRt,lRt,uRt,hRt,fRt,pRt,dRt,_Rt,mRt,vRt,gRt,yRt,xRt,SRt,TRt,ERt,bRt,CRt=function(e){return t({ScrollView:e,ScrollViewComponent:e}),e}((ewt=dc("cc.ScrollView"),nwt=Ic(),iwt=mc(110),rwt=Ac(),owt=_c(LV),awt=Bc(),swt=Gc(),cwt=Lc(),lwt=Bc(),uwt=Gc(),hwt=Lc(),fwt=Gc(),pwt=Lc(),dwt=Gc(),_wt=Lc(),mwt=Kc(WC),vwt=Gc(),gwt=Lc(),ywt=Gc(),xwt=Lc(),Swt=Kc(twt),Twt=Gc(),Ewt=Lc(),bwt=Gc(),Cwt=Lc(),Awt=Kc(twt),wwt=Gc(),Rwt=Lc(),Pwt=Gc(),Iwt=Lc(),Mwt=Kc([zB]),Dwt=Gc(),Owt=Lc(),ewt(Nwt=nwt(Nwt=iwt(Nwt=rwt(Nwt=owt((Ywt=Xwt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"bounceDuration",Bwt,ot(e)),ct(e,"brake",Fwt,ot(e)),ct(e,"elastic",zwt,ot(e)),ct(e,"inertia",kwt,ot(e)),ct(e,"horizontal",Uwt,ot(e)),ct(e,"vertical",Gwt,ot(e)),ct(e,"cancelInnerEvents",Hwt,ot(e)),ct(e,"scrollEvents",Vwt,ot(e)),e._autoScrolling=!1,e._scrolling=!1,ct(e,"_content",Wwt,ot(e)),ct(e,"_horizontalScrollBar",jwt,ot(e)),ct(e,"_verticalScrollBar",qwt,ot(e)),e._topBoundary=0,e._bottomBoundary=0,e._leftBoundary=0,e._rightBoundary=0,e._touchMoveDisplacements=[],e._touchMoveTimeDeltas=[],e._touchMovePreviousTimestamp=0,e._touchMoved=!1,e._autoScrollAttenuate=!1,e._autoScrollStartPosition=new Rn,e._autoScrollTargetDelta=new Rn,e._autoScrollTotalTime=0,e._autoScrollAccumulatedTime=0,e._autoScrollCurrentlyOutOfBoundary=!1,e._autoScrollBraking=!1,e._autoScrollBrakingStartPosition=new Rn,e._outOfBoundaryAmount=new Rn,e._outOfBoundaryAmountDirty=!0,e._stopMouseWheel=!1,e._mouseWheelEventElapsedTime=0,e._isScrollEndedWithThresholdEventFired=!1,e._scrollEventEmitMask=0,e._isBouncing=!1,e._contentPos=new Rn,e._deltaPos=new Rn,e}$(e,t);var n=e.prototype;return n.scrollToBottom=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n,!0)},n.scrollToTop=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToOffset=function(t,e,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Xn(0,0);0===i.x?r.x=0:r.x=t.x/i.x,0===i.y?r.y=1:r.y=(i.y-t.y)/i.y,this.scrollTo(r,e,n)},n.getScrollOffset=function(){var t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new Xn(e,t)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Xn.ZERO;var t=this._content._uiProps.uiTransformComp.contentSize,e=t.width-this.view.width,n=t.height-this.view.height;return new Xn(e=e>=0?e:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Xn(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==n):this._moveContent(i)},n.scrollTo=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Xn(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.scrollToPercentVertical=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Xn(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(t){this._setContentPosition(t)},n._setContentPosition=function(t){if(this._content){var e=this._getContentPosition();Math.abs(t.x-e.x)<Zwt&&Math.abs(t.y-e.y)<Zwt||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Rn.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return Zwt},n.start=function(){this._calculateBoundary(),this._content&&VO.once(HO.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(HE.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(HE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(HE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(HE.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(t){this._autoScrolling&&this._processAutoScrolling(t)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(HE.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(HE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(HE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(HE.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(HE.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(HE.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(HE.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(HE.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(HE.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(HE.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(HE.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(HE.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(HE.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(HE.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(t,e){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(t,e)){var n=new Rn,i=t.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}},n._onTouchBegan=function(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))},n._onTouchMoved=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){var n=t.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(tRt);if(i.subtract(n.getUIStartLocation(eRt)),i.length()>7&&!this._touchMoved&&t.target!==this.node){var r=new XI(t.getTouches(),t.bubbles,kA.TOUCH_CANCEL);r.touch=t.touch,r.simulate=!0,t.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}}},n._onTouchEnded=function(t,e){if(this.enabledInHierarchy&&this._content&&t&&!this._hasNestedViewGroup(t,e)){this._dispatchEvent(Qwt.TOUCH_UP);var n=t.touch;this._handleReleaseLogic(n),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}},n._onTouchCancelled=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){var n=t.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(t)}},n._calculateBoundary=function(){if(this._content&&this.view){var t=this._content.getComponent(xAt);t&&t.enabledInHierarchy&&t.updateLayout();var e=this.view,n=e.width*e.anchorX,i=e.height*e.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}},n._hasNestedViewGroup=function(t,e){if(!t||t.eventPhase!==HI.CAPTURING_PHASE)return!1;if(e)for(var n,i=st(e);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!t.target||!t.target.getComponent(Kwt));if(r.getComponent(Kwt))return!0}return!1},n._startInertiaScroll=function(t){var e=new Rn(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)},n._calculateAttenuatedFactor=function(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))},n._startAttenuatingAutoScroll=function(t,e){var n=t.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=t.length(),u=n.length()/l;if(n.add(t),this.brake>0&&u>7){u=Math.sqrt(u);var h=t.clone();h.multiplyScalar(u),n.set(h),n.add(t)}var f=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&u>3&&(f*=u=3),0===this.brake&&u>1&&(f*=u),this._startAutoScroll(n,f,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(t){return Math.sqrt(Math.sqrt(t/5))},n._startAutoScroll=function(t,e,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,Rn.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(Rn.ZERO,Zwt)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var t=new Rn,e=0;if((e=this._touchMoveTimeDeltas.reduce((function(t,e){return t+e}),e))<=0||e>=.5)t.set(Rn.ZERO);else{var n=new Rn;n=this._touchMoveDisplacements.reduce((function(t,e){return t.add(e),t}),n),t.set(n.x*(1-this.brake)/e,n.y*(1-this.brake)/e,n.z)}return t},n._flattenVectorByDirection=function(t){var e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e},n._moveContent=function(t,e){var n=this._flattenVectorByDirection(t);Jwt.set(this._getContentPosition()),Jwt.add(n),Jwt.set(Math.round(1e4*Jwt.x)*Zwt,Math.round(1e4*Jwt.y)*Zwt,Jwt.z),this._setContentPosition(Jwt);var i=this._getHowMuchOutOfBoundary();tRt.set(i.x,i.y),this._updateScrollBar(tRt),this.elastic&&e&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height},n._getHowMuchOutOfBoundary=function(t){if((t=t||new Rn).equals(Rn.ZERO,Zwt)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var e=new Rn,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+t.x>this._leftBoundary?e.x=this._leftBoundary-(n+t.x):i+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(i+t.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+t.y<this._topBoundary?e.y=this._topBoundary-(r+t.y):o+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(o+t.y)),t.equals(Rn.ZERO,Zwt)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e},n._updateScrollBar=function(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(t){if(t===Qwt.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===Qwt.SCROLL_TO_TOP||t===Qwt.SCROLL_TO_BOTTOM||t===Qwt.SCROLL_TO_LEFT||t===Qwt.SCROLL_TO_RIGHT){var e=1<<iRt[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}zB.emitEvents(this.scrollEvents,this,iRt[t]),this.node.emit(t,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var t=this._getHowMuchOutOfBoundary();Jwt.set(this._getContentPosition()),Jwt.add(t),this._content.setPosition(Jwt),this._updateScrollBar(Xn.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(t){t.eventPhase===HI.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)},n._processDeltaMove=function(t){this._scrollChildren(t),this._gatherTouchMove(t)},n._handleMoveLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(Qwt.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(t,e){var n=this.node._uiProps.uiTransformComp,i=new Rn;n&&(e.getUILocation(tRt),e.getUIPreviousLocation(eRt),Jwt.set(tRt.x,tRt.y,0),$wt.set(eRt.x,eRt.y,0),n.convertToNodeSpaceAR(Jwt,Jwt),n.convertToNodeSpaceAR($wt,$wt),Rn.subtract(i,Jwt,$wt)),t.set(i)},n._scrollChildren=function(t){this._clampDelta(t);var e,n=t;this.elastic&&(e=this._getHowMuchOutOfBoundary(),n.x*=0===e.x?1:.5,n.y*=0===e.y?1:.5),this.elastic||(e=this._getHowMuchOutOfBoundary(n),n.add(e));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||Rn.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=Qwt.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=Qwt.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=Qwt.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=Qwt.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(Qwt.SCROLL_BEGAN)),this._dispatchEvent(Qwt.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(Qwt.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=nRt(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(t){if(this._content&&this.view){var e=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<e.width&&(t.x=0),n.height<e.height&&(t.y=0)}},n._gatherTouchMove=function(t){var e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var n=nRt();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals(Rn.ZERO,Zwt))return!1;var e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(Qwt.BOUNCE_TOP),t.y<0&&this._dispatchEvent(Qwt.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(Qwt.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(Qwt.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var t=this._calculateTouchMoveVelocity();!t.equals(Jwt,Zwt)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(Rn.ZERO,Zwt)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(t){var e=this._isNecessaryAutoScrollBrake(),n=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=Zwt;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(Qwt.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),e&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(Rn.ZERO,Zwt)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(Qwt.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(Qwt.SCROLL_ENDED))},n._checkMouseWheel=function(t){if(!this._getHowMuchOutOfBoundary().equals(Rn.ZERO,Zwt))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Qwt.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Qwt.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(t){var e=t.anchor,n=t.applyToHorizontal,i=t.applyToVertical;this._calculateBoundary(),e.clampf(Xn.ZERO,Xn.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new Rn;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*e.x),i&&(s=c.height-l.height,a.y=r-s*e.y)}return a},n._moveContentToTopLeft=function(t){var e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;var n=new Rn,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<t.height&&(i=o.height-t.height,n.y=e-i),o.width<t.width&&(i=o.width-t.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(t){t===iy.SCALE&&this._calculateBoundary()},Z(e,[{key:"content",get:function(){return this._content},set:function(t){if(this._content!==t){var e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):P(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Xn.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Xn.ZERO)))}},{key:"view",get:function(){var t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}}]),e}(Kwt),Xwt.EventType=Qwt,Bwt=lt((Lwt=Ywt).prototype,"bounceDuration",[xc,awt,swt,cwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Fwt=lt(Lwt.prototype,"brake",[xc,lwt,uwt,hwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),zwt=lt(Lwt.prototype,"elastic",[xc,fwt,pwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kwt=lt(Lwt.prototype,"inertia",[xc,dwt,_wt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(Lwt.prototype,"content",[mwt,vwt,gwt],Object.getOwnPropertyDescriptor(Lwt.prototype,"content"),Lwt.prototype),Uwt=lt(Lwt.prototype,"horizontal",[xc,ywt,xwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(Lwt.prototype,"horizontalScrollBar",[Swt,Twt,Ewt],Object.getOwnPropertyDescriptor(Lwt.prototype,"horizontalScrollBar"),Lwt.prototype),Gwt=lt(Lwt.prototype,"vertical",[xc,bwt,Cwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(Lwt.prototype,"verticalScrollBar",[Awt,wwt,Rwt],Object.getOwnPropertyDescriptor(Lwt.prototype,"verticalScrollBar"),Lwt.prototype),Hwt=lt(Lwt.prototype,"cancelInnerEvents",[xc,Pwt,Iwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Vwt=lt(Lwt.prototype,"scrollEvents",[Mwt,xc,Dwt,Owt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wwt=lt(Lwt.prototype,"_content",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jwt=lt(Lwt.prototype,"_horizontalScrollBar",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qwt=lt(Lwt.prototype,"_verticalScrollBar",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nwt=Lwt))||Nwt)||Nwt)||Nwt)||Nwt)||Nwt));u.ScrollView=CRt;var ARt,wRt=new Rn;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(ARt||(ARt={})),ce(ARt);var RRt,PRt,IRt,MRt,DRt,ORt,NRt,LRt,BRt,FRt,zRt,kRt,URt,GRt,HRt,VRt,WRt,jRt,qRt,XRt,YRt=function(e){return t({Slider:e,SliderComponent:e}),e}((rRt=dc("cc.Slider"),oRt=Ic(),aRt=mc(110),sRt=Ac(),cRt=_c(LV),lRt=Kc(cY),uRt=Lc(),hRt=Kc(ARt),fRt=Lc(),pRt=Bc(),dRt=Lc(),_Rt=Kc([zB]),mRt=Lc(),rRt(vRt=oRt(vRt=aRt(vRt=sRt(vRt=cRt((bRt=ERt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"slideEvents",yRt,ot(e)),ct(e,"_handle",xRt,ot(e)),ct(e,"_direction",SRt,ot(e)),ct(e,"_progress",TRt,ot(e)),e._offset=new Rn,e._dragging=!1,e._touchHandle=!1,e._handleLocalPos=new Rn,e._touchPos=new Rn,e}$(e,t);var n=e.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(HE.TOUCH_START,this._onTouchBegan,this),this.node.on(HE.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(HE.TOUCH_END,this._onTouchEnded,this),this.node.on(HE.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(HE.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(HE.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(HE.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(HE.TOUCH_START,this._onTouchBegan,this),this.node.off(HE.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(HE.TOUCH_END,this._onTouchEnded,this),this.node.off(HE.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(HE.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(HE.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(HE.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(t){if(t&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var e=t.touch.getUILocation();Rn.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}},n._onTouchBegan=function(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchMoved=function(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchEnded=function(t){this._dragging=!1,this._touchHandle=!1,this._offset=new Rn,t&&(t.propagationStopped=!0)},n._onTouchCancelled=function(t){this._dragging=!1,t&&(t.propagationStopped=!0)},n._handleSliderLogic=function(t){this._updateProgress(t),this._emitSlideEvent()},n._emitSlideEvent=function(){zB.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(t){if(this._handle&&t){var e=t.getUILocation();Rn.set(this._touchPos,e.x,e.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,wRt);this.direction===ARt.Horizontal?this.progress=cn(.5+(i.x-this._offset.x)/n.width):this.progress=cn(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var t=this.node._uiProps.uiTransformComp;this._direction===ARt.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){var n=this._handle.node.position;this._direction===ARt.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},Z(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}}]),e}($u),ERt.Direction=ARt,lt((gRt=bRt).prototype,"handle",[lRt,uRt],Object.getOwnPropertyDescriptor(gRt.prototype,"handle"),gRt.prototype),lt(gRt.prototype,"direction",[hRt,fRt],Object.getOwnPropertyDescriptor(gRt.prototype,"direction"),gRt.prototype),lt(gRt.prototype,"progress",[Uc,pRt,dRt],Object.getOwnPropertyDescriptor(gRt.prototype,"progress"),gRt.prototype),yRt=lt(gRt.prototype,"slideEvents",[_Rt,xc,mRt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xRt=lt(gRt.prototype,"_handle",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SRt=lt(gRt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ARt.Horizontal}}),TRt=lt(gRt.prototype,"_progress",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),vRt=gRt))||vRt)||vRt)||vRt)||vRt)||vRt));function KRt(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(e))}u.Slider=YRt,function(t){t.TOGGLE="toggle"}(XRt||(XRt={}));var QRt,ZRt,JRt,$Rt,tPt,ePt,nPt,iPt,rPt,oPt,aPt,sPt,cPt=function(e){return t({Toggle:e,ToggleComponent:e}),e}((RRt=dc("cc.Toggle"),PRt=Ic(),IRt=mc(110),MRt=Ac(),DRt=_c(LV),ORt=Gc(),NRt=Lc(),LRt=Kc(cY),BRt=Gc(),FRt=Lc(),zRt=Kc([zB]),kRt=Lc(),RRt(URt=PRt(URt=IRt(URt=MRt(URt=DRt((qRt=jRt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"checkEvents",HRt,ot(e)),ct(e,"_isChecked",VRt,ot(e)),ct(e,"_checkMark",WRt,ot(e)),e}$(e,t);var n=e.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(t,e){if(void 0===e&&(e=!0),this._isChecked!=t){this._isChecked=t;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(t||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(t){this._set(t,!1)},n.onEnable=function(){t.prototype.onEnable.call(this),this.playEffect(),this.node.on(e.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(e.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var t=this._toggleContainer;t&&t.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(e.EventType.TOGGLE,this),this.checkEvents&&zB.emitEvents(this.checkEvents,this)},Z(e,[{key:"isChecked",get:function(){return this._isChecked},set:function(t){this._set(t)}},{key:"checkMark",get:function(){return this._checkMark},set:function(t){this._checkMark!==t&&(this._checkMark=t)}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var t=this.node.parent;return u.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}}]),e}(EEt),jRt.EventType=KRt(XRt,SEt),lt((GRt=qRt).prototype,"isChecked",[ORt,NRt],Object.getOwnPropertyDescriptor(GRt.prototype,"isChecked"),GRt.prototype),lt(GRt.prototype,"checkMark",[LRt,BRt,FRt],Object.getOwnPropertyDescriptor(GRt.prototype,"checkMark"),GRt.prototype),HRt=lt(GRt.prototype,"checkEvents",[zRt,xc,kRt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VRt=lt(GRt.prototype,"_isChecked",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WRt=lt(GRt.prototype,"_checkMark",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),URt=GRt))||URt)||URt)||URt)||URt)||URt));u.Toggle=cPt;var lPt,uPt,hPt,fPt,pPt,dPt,_Pt,mPt,vPt,gPt,yPt,xPt,SPt,TPt,EPt,bPt,CPt,APt,wPt,RPt,PPt,IPt,MPt,DPt,OPt,NPt,LPt,BPt,FPt,zPt,kPt,UPt,GPt,HPt,VPt,WPt,jPt,qPt,XPt,YPt,KPt,QPt,ZPt,JPt,$Pt,tIt=function(e){return t({ToggleContainer:e,ToggleContainerComponent:e}),e}((QRt=dc("cc.ToggleContainer"),ZRt=Ic(),JRt=mc(110),$Rt=Ac(),tPt=Lc(),ePt=Kc([zB]),nPt=Lc(),QRt(iPt=ZRt(iPt=JRt(iPt=$Rt(iPt=Cc((sPt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"_allowSwitchOff",oPt,ot(e)),ct(e,"checkEvents",aPt,ot(e)),e}$(e,t);var n=e.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(HE.CHILD_ADDED,this.ensureValidState,this),this.node.on(HE.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(HE.CHILD_ADDED,this.ensureValidState,this),this.node.off(HE.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(t){return t.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(t){return t.isChecked}))},n.notifyToggleCheck=function(t,e){if(void 0===e&&(e=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==t&&(e?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&u.Component.EventHandler.emitEvents(this.checkEvents,t)}},n.ensureValidState=function(){var t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){var e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},Z(e,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(t){this._allowSwitchOff=t}},{key:"toggleItems",get:function(){return this.node.children.map((function(t){var e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}}]),e}($u),oPt=lt((rPt=sPt).prototype,"_allowSwitchOff",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(rPt.prototype,"allowSwitchOff",[tPt],Object.getOwnPropertyDescriptor(rPt.prototype,"allowSwitchOff"),rPt.prototype),aPt=lt(rPt.prototype,"checkEvents",[ePt,xc,nPt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iPt=rPt))||iPt)||iPt)||iPt)||iPt)||iPt));u.ToggleContainer=tIt;var eIt,nIt,iIt=new Xn;function rIt(t){return t instanceof SM?qO:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:ti.ZERO}function oIt(t,e,n,i){t.parent?iIt.set(t.parent.getScale().x,t.parent.getScale().y):iIt.set(0,0);for(var r=iIt.x,o=iIt.y,a=0,s=0,c=t.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===e)break;c?iIt.set(c.getScale().x,c.getScale().y):iIt.set(0,0);var u=iIt.x,h=iIt.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(eIt||(eIt={})),ce(eIt),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(nIt||(nIt={}));var aIt,sIt,cIt,lIt,uIt,hIt,fIt,pIt,dIt,_It,mIt,vIt,gIt,yIt,xIt,SIt,TIt,EIt,bIt,CIt=nIt.TOP|nIt.BOT,AIt=nIt.LEFT|nIt.RIGHT,wIt=function(e){return t({Widget:e,WidgetComponent:e}),e}((lPt=dc("cc.Widget"),uPt=Ic(),hPt=mc(110),fPt=Ac(),pPt=_c(LV),dPt=Kc(WC),_Pt=Lc(),mPt=Lc(),vPt=Lc(),gPt=Lc(),yPt=Lc(),xPt=Lc(),SPt=Lc(),TPt=Dc(),EPt=Dc(),bPt=Lc(),CPt=Lc(),APt=Lc(),wPt=Lc(),RPt=Lc(),PPt=Lc(),IPt=Kc(eIt),MPt=Lc(),lPt(DPt=uPt(DPt=hPt(DPt=fPt(DPt=pPt(DPt=Cc(($Pt=JPt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastPos=new Rn,e._lastSize=new ti,e._dirty=!0,e._hadAlignOnce=!1,ct(e,"_alignFlags",NPt,ot(e)),ct(e,"_target",LPt,ot(e)),ct(e,"_left",BPt,ot(e)),ct(e,"_right",FPt,ot(e)),ct(e,"_top",zPt,ot(e)),ct(e,"_bottom",kPt,ot(e)),ct(e,"_horizontalCenter",UPt,ot(e)),ct(e,"_verticalCenter",GPt,ot(e)),ct(e,"_isAbsLeft",HPt,ot(e)),ct(e,"_isAbsRight",VPt,ot(e)),ct(e,"_isAbsTop",WPt,ot(e)),ct(e,"_isAbsBottom",jPt,ot(e)),ct(e,"_isAbsHorizontalCenter",qPt,ot(e)),ct(e,"_isAbsVerticalCenter",XPt,ot(e)),ct(e,"_originalWidth",YPt,ot(e)),ct(e,"_originalHeight",KPt,ot(e)),ct(e,"_alignMode",QPt,ot(e)),ct(e,"_lockFlags",ZPt,ot(e)),e}$(e,t);var n=e.prototype;return n.updateAlignment=function(){u._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),u._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){u._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(HE.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(HE.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(HE.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(HE.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(HE.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(HE.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(HE.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(HE.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(t,e){if((this._alignFlags&t)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:qO;this.isAlignLeft&&t===nIt.LEFT?this._left=e?this._left*r.width:this._left/r.width:this.isAlignRight&&t===nIt.RIGHT?this._right=e?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&t===nIt.CENTER?this._horizontalCenter=e?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&t===nIt.TOP?this._top=e?this._top*r.height:this._top/r.height:this.isAlignBottom&&t===nIt.BOT?this._bottom=e?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&t===nIt.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var t=this._target||this.node.parent;t&&t.getComponent(LV)&&(t.on(HE.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(HE.SIZE_CHANGED,this._setDirtyByMode,this),t.on(HE.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var t=this._target||this.node.parent;t&&(t.off(HE.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(HE.SIZE_CHANGED,this._setDirtyByMode,this),t.off(HE.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(t){var e=this._target||t;e&&(e.off(HE.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(HE.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===eIt.ALWAYS&&this._recursiveDirty()},n._setAlign=function(t,e){if(e!==(this._alignFlags&t)>0){var n=(t&AIt)>0,i=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~t)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},Z(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&nIt.TOP)>0},set:function(t){this._setAlign(nIt.TOP,t),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&nIt.BOT)>0},set:function(t){this._setAlign(nIt.BOT,t),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&nIt.LEFT)>0},set:function(t){this._setAlign(nIt.LEFT,t),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&nIt.RIGHT)>0},set:function(t){this._setAlign(nIt.RIGHT,t),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&nIt.MID)>0},set:function(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=nIt.MID):this._alignFlags&=~nIt.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&nIt.CENTER)>0},set:function(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=nIt.CENTER):this._alignFlags&=~nIt.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&AIt)===AIt}},{key:"isStretchHeight",get:function(){return(this._alignFlags&CIt)===CIt}},{key:"top",get:function(){return this._top},set:function(t){this._top=t,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(t){this._bottom=t,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(t){this._left=t,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(t){this._right=t,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(t){this._horizontalCenter=t,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(t){this._verticalCenter=t,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(nIt.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(nIt.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(nIt.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(nIt.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(nIt.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(nIt.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(t){this._alignMode=t,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}}]),e}($u),JPt.AlignMode=eIt,lt((OPt=$Pt).prototype,"target",[dPt,_Pt],Object.getOwnPropertyDescriptor(OPt.prototype,"target"),OPt.prototype),lt(OPt.prototype,"isAlignTop",[mPt],Object.getOwnPropertyDescriptor(OPt.prototype,"isAlignTop"),OPt.prototype),lt(OPt.prototype,"isAlignBottom",[vPt],Object.getOwnPropertyDescriptor(OPt.prototype,"isAlignBottom"),OPt.prototype),lt(OPt.prototype,"isAlignLeft",[gPt],Object.getOwnPropertyDescriptor(OPt.prototype,"isAlignLeft"),OPt.prototype),lt(OPt.prototype,"isAlignRight",[yPt],Object.getOwnPropertyDescriptor(OPt.prototype,"isAlignRight"),OPt.prototype),lt(OPt.prototype,"isAlignVerticalCenter",[xPt],Object.getOwnPropertyDescriptor(OPt.prototype,"isAlignVerticalCenter"),OPt.prototype),lt(OPt.prototype,"isAlignHorizontalCenter",[SPt],Object.getOwnPropertyDescriptor(OPt.prototype,"isAlignHorizontalCenter"),OPt.prototype),lt(OPt.prototype,"isStretchWidth",[TPt],Object.getOwnPropertyDescriptor(OPt.prototype,"isStretchWidth"),OPt.prototype),lt(OPt.prototype,"isStretchHeight",[EPt],Object.getOwnPropertyDescriptor(OPt.prototype,"isStretchHeight"),OPt.prototype),lt(OPt.prototype,"top",[bPt],Object.getOwnPropertyDescriptor(OPt.prototype,"top"),OPt.prototype),lt(OPt.prototype,"editorTop",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"editorTop"),OPt.prototype),lt(OPt.prototype,"bottom",[CPt],Object.getOwnPropertyDescriptor(OPt.prototype,"bottom"),OPt.prototype),lt(OPt.prototype,"editorBottom",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"editorBottom"),OPt.prototype),lt(OPt.prototype,"left",[APt],Object.getOwnPropertyDescriptor(OPt.prototype,"left"),OPt.prototype),lt(OPt.prototype,"editorLeft",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"editorLeft"),OPt.prototype),lt(OPt.prototype,"right",[wPt],Object.getOwnPropertyDescriptor(OPt.prototype,"right"),OPt.prototype),lt(OPt.prototype,"editorRight",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"editorRight"),OPt.prototype),lt(OPt.prototype,"horizontalCenter",[RPt],Object.getOwnPropertyDescriptor(OPt.prototype,"horizontalCenter"),OPt.prototype),lt(OPt.prototype,"editorHorizontalCenter",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"editorHorizontalCenter"),OPt.prototype),lt(OPt.prototype,"verticalCenter",[PPt],Object.getOwnPropertyDescriptor(OPt.prototype,"verticalCenter"),OPt.prototype),lt(OPt.prototype,"editorVerticalCenter",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"editorVerticalCenter"),OPt.prototype),lt(OPt.prototype,"isAbsoluteTop",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"isAbsoluteTop"),OPt.prototype),lt(OPt.prototype,"isAbsoluteBottom",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"isAbsoluteBottom"),OPt.prototype),lt(OPt.prototype,"isAbsoluteLeft",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"isAbsoluteLeft"),OPt.prototype),lt(OPt.prototype,"isAbsoluteRight",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"isAbsoluteRight"),OPt.prototype),lt(OPt.prototype,"isAbsoluteHorizontalCenter",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"isAbsoluteHorizontalCenter"),OPt.prototype),lt(OPt.prototype,"isAbsoluteVerticalCenter",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"isAbsoluteVerticalCenter"),OPt.prototype),lt(OPt.prototype,"alignMode",[IPt,MPt],Object.getOwnPropertyDescriptor(OPt.prototype,"alignMode"),OPt.prototype),lt(OPt.prototype,"alignFlags",[Mc],Object.getOwnPropertyDescriptor(OPt.prototype,"alignFlags"),OPt.prototype),NPt=lt(OPt.prototype,"_alignFlags",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LPt=lt(OPt.prototype,"_target",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BPt=lt(OPt.prototype,"_left",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FPt=lt(OPt.prototype,"_right",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zPt=lt(OPt.prototype,"_top",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kPt=lt(OPt.prototype,"_bottom",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UPt=lt(OPt.prototype,"_horizontalCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GPt=lt(OPt.prototype,"_verticalCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HPt=lt(OPt.prototype,"_isAbsLeft",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),VPt=lt(OPt.prototype,"_isAbsRight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WPt=lt(OPt.prototype,"_isAbsTop",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jPt=lt(OPt.prototype,"_isAbsBottom",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qPt=lt(OPt.prototype,"_isAbsHorizontalCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XPt=lt(OPt.prototype,"_isAbsVerticalCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),YPt=lt(OPt.prototype,"_originalWidth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KPt=lt(OPt.prototype,"_originalHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QPt=lt(OPt.prototype,"_alignMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eIt.ON_WINDOW_RESIZE}}),ZPt=lt(OPt.prototype,"_lockFlags",[xc,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DPt=OPt))||DPt)||DPt)||DPt)||DPt)||DPt)||DPt));u.internal.computeInverseTransForTarget=oIt,u.internal.getReadonlyNodeSize=rIt,u.Widget=wIt;var RIt,PIt=new An;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(RIt||(RIt={})),ce(RIt);var IIt,MIt,DIt,OIt,NIt,LIt,BIt,FIt,zIt,kIt,UIt,GIt,HIt,VIt,WIt,jIt,qIt,XIt,YIt,KIt,QIt,ZIt,JIt,$It,tMt,eMt,nMt,iMt,rMt,oMt,aMt,sMt,cMt,lMt,uMt,hMt,fMt,pMt,dMt,_Mt,mMt,vMt,gMt,yMt=function(e){return t({PageViewIndicator:e,PageViewIndicatorComponent:e}),e}((aIt=dc("cc.PageViewIndicator"),sIt=Ic(),cIt=mc(110),lIt=Ac(),uIt=Kc(cH),hIt=Lc(),fIt=Kc(RIt),pIt=Lc(),dIt=Kc(ti),_It=Lc(),mIt=Lc(),aIt(vIt=sIt(vIt=cIt(vIt=lIt((bIt=EIt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"spacing",yIt,ot(e)),ct(e,"_spriteFrame",xIt,ot(e)),ct(e,"_direction",SIt,ot(e)),ct(e,"_cellSize",TIt,ot(e)),e._layout=null,e._pageView=null,e._indicators=[],e}$(e,t);var n=e.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(t){this._pageView=t,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(xAt),this._layout||(this._layout=this.addComponent(xAt));var t=this._layout;this.direction===RIt.HORIZONTAL?(t.type=xAt.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===RIt.VERTICAL&&(t.type=xAt.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=xAt.ResizeMode.CONTAINER},n._createIndicator=function(){var t=new WC;t.layer=this.node.layer;var e=t.addComponent(cY);return e.spriteFrame=this.spriteFrame,e.sizeMode=cY.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t},n._changedState=function(){var t=this._indicators;if(0!==t.length&&this._pageView){var e=this._pageView.curPageIdx;if(!(e>=t.length)){for(var n=0;n<t.length;++n){var i=t[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;PIt.set(r.color),PIt.a=127.5,r.color=PIt}}if(t[e]._uiProps.uiComp){var o=t[e]._uiProps.uiComp;PIt.set(o.color),PIt.a=255,o.color=PIt}}}},n._refresh=function(){if(this._pageView){var t=this._indicators,e=this._pageView.getPages();if(e.length!==t.length){var n=0;if(e.length>t.length)for(n=0;n<e.length;++n)t[n]||(t[n]=this._createIndicator());else for(n=t.length-e.length;n>0;--n){var i=t[n-1];this.node.removeChild(i),t.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},Z(e,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){this._spriteFrame!==t&&(this._spriteFrame=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t)}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize=t)}}]),e}($u),EIt.Direction=RIt,lt((gIt=bIt).prototype,"spriteFrame",[uIt,hIt],Object.getOwnPropertyDescriptor(gIt.prototype,"spriteFrame"),gIt.prototype),lt(gIt.prototype,"direction",[fIt,pIt],Object.getOwnPropertyDescriptor(gIt.prototype,"direction"),gIt.prototype),lt(gIt.prototype,"cellSize",[dIt,_It],Object.getOwnPropertyDescriptor(gIt.prototype,"cellSize"),gIt.prototype),yIt=lt(gIt.prototype,"spacing",[xc,mIt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xIt=lt(gIt.prototype,"_spriteFrame",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SIt=lt(gIt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RIt.HORIZONTAL}}),TIt=lt(gIt.prototype,"_cellSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(20,20)}}),vIt=gIt))||vIt)||vIt)||vIt)||vIt));u.PageViewIndicator=yMt;var xMt,SMt,TMt,EMt=new Xn;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(xMt||(xMt={})),ce(xMt),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(SMt||(SMt={})),ce(SMt),function(t){t.PAGE_TURNING="page-turning"}(TMt||(TMt={}));var bMt=function(e){return t({PageView:e,PageViewComponent:e}),e}((IIt=dc("cc.PageView"),MIt=Ic(),DIt=mc(110),OIt=Ac(),NIt=Kc(xMt),LIt=Lc(),BIt=Kc(SMt),FIt=Lc(),zIt=Bc(),kIt=Lc(),UIt=Bc(),GIt=Lc(),HIt=Kc(yMt),VIt=Lc(),WIt=Lc(),jIt=Kc(twt),qIt=Dc(),XIt=Kc(twt),YIt=Dc(),KIt=Dc(),QIt=Dc(),ZIt=Dc(),JIt=Kc([zB]),$It=Dc(),tMt=Lc(),eMt=Kc([zB]),nMt=Lc(),IIt(iMt=MIt(iMt=DIt(iMt=OIt((gMt=vMt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"autoPageTurningThreshold",oMt,ot(e)),ct(e,"horizontal",aMt,ot(e)),ct(e,"vertical",sMt,ot(e)),ct(e,"cancelInnerEvents",cMt,ot(e)),ct(e,"scrollEvents",lMt,ot(e)),ct(e,"pageTurningSpeed",uMt,ot(e)),ct(e,"pageEvents",hMt,ot(e)),ct(e,"_sizeMode",fMt,ot(e)),ct(e,"_direction",pMt,ot(e)),ct(e,"_scrollThreshold",dMt,ot(e)),ct(e,"_pageTurningEventTiming",_Mt,ot(e)),ct(e,"_indicator",mMt,ot(e)),e._curPageIdx=0,e._lastPageIdx=0,e._pages=[],e._initContentPos=new Rn,e._scrollCenterOffsetX=[],e._scrollCenterOffsetY=[],e._touchBeganPosition=new Xn,e._touchEndPosition=new Xn,e}$(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this.node.on(HE.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(HE.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(t){this.scrollToPage(t,1)},n.getPages=function(){return this._pages},n.addPage=function(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):P(4301))},n.insertPage=function(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void P(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}},n.removePage=function(t){if(t&&this.content){var e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):M(4300,t.name)}},n.removePageAtIndex=function(t){var e=this._pages;if(!(t<0||t>=e.length)){var n=e[t];n&&this.content&&(this.content.removeChild(n),e.splice(t,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var t=this._pages,e=0,n=t.length;e<n;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(t,e){void 0===e&&(e=.3),t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var t=this.content.getComponent(xAt);t&&t.enabled&&t.updateLayout();var e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<e;++i){var r=this._pages[i].position;this.direction===SMt.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var t=this.view;if(this.content&&t&&this._sizeMode===xMt.Unified)for(var e=this._pages,n=t.contentSize,i=0,r=e.length;i<r;i++)e[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(e.EventType.SCROLL_ENDED))},n._onTouchBegan=function(e,n){e.touch.getUILocation(EMt),Xn.set(this._touchBeganPosition,EMt.x,EMt.y),t.prototype._onTouchBegan.call(this,e,n)},n._onTouchMoved=function(e,n){t.prototype._onTouchMoved.call(this,e,n)},n._onTouchEnded=function(e,n){e.touch.getUILocation(EMt),Xn.set(this._touchEndPosition,EMt.x,EMt.y),t.prototype._onTouchEnded.call(this,e,n)},n._onTouchCancelled=function(e,n){e.touch.getUILocation(EMt),Xn.set(this._touchEndPosition,EMt.x,EMt.y),t.prototype._onTouchCancelled.call(this,e,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===SMt.Horizontal,this.vertical=this.direction===SMt.Vertical},n._syncSizeMode=function(){var t=this.view;if(this.content&&t){var e=this.content.getComponent(xAt);if(e){if(this._sizeMode===xMt.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===SMt.Horizontal?(e.paddingLeft=(t.width-n.width)/2,e.paddingRight=(t.width-i.width)/2):this.direction===SMt.Vertical&&(e.paddingTop=(t.height-n.height)/2,e.paddingBottom=(t.height-i.height)/2)}e.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var t=this.content.children,e=0;e<t.length;++e){var n=t[e];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,zB.emitEvents(this.pageEvents,this,TMt.PAGE_TURNING),this.node.emit(TMt.PAGE_TURNING,this))},n._isQuicklyScrollable=function(t){if(this.direction===SMt.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===SMt.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(t){var e=new Xn;if(this._sizeMode===xMt.Free)this.direction===SMt.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===SMt.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{var n=this.view;if(!n)return e;this.direction===SMt.Horizontal?e.x=t*n.width:this.direction===SMt.Vertical&&(e.y=t*n.height)}return e},n._getDragDirection=function(t){return this._direction===SMt.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1},n._isScrollable=function(t,e,n){if(this._sizeMode===xMt.Free){var i=0,r=0;if(this.direction===SMt.Horizontal)return i=this._scrollCenterOffsetX[e],r=this._scrollCenterOffsetX[n],Math.abs(t.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===SMt.Vertical)return i=this._scrollCenterOffsetY[e],r=this._scrollCenterOffsetY[n],Math.abs(t.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===SMt.Horizontal)return Math.abs(t.x)>=o.width*this.scrollThreshold;if(this.direction===SMt.Vertical)return Math.abs(t.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var e=new Xn;Xn.subtract(e,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(e),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(e,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},Z(e,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}},{key:"indicator",get:function(){return this._indicator},set:function(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return t.prototype.verticalScrollBar},set:function(t){this.verticalScrollBar=t}},{key:"horizontalScrollBar",get:function(){return t.prototype.horizontalScrollBar},set:function(t){this.horizontalScrollBar=t}}]),e}(CRt),vMt.SizeMode=xMt,vMt.Direction=SMt,vMt.EventType=KRt(TMt,Qwt),lt((rMt=gMt).prototype,"sizeMode",[NIt,LIt],Object.getOwnPropertyDescriptor(rMt.prototype,"sizeMode"),rMt.prototype),lt(rMt.prototype,"direction",[BIt,FIt],Object.getOwnPropertyDescriptor(rMt.prototype,"direction"),rMt.prototype),lt(rMt.prototype,"scrollThreshold",[Uc,zIt,kIt],Object.getOwnPropertyDescriptor(rMt.prototype,"scrollThreshold"),rMt.prototype),lt(rMt.prototype,"pageTurningEventTiming",[Uc,UIt,GIt],Object.getOwnPropertyDescriptor(rMt.prototype,"pageTurningEventTiming"),rMt.prototype),lt(rMt.prototype,"indicator",[HIt,VIt],Object.getOwnPropertyDescriptor(rMt.prototype,"indicator"),rMt.prototype),oMt=lt(rMt.prototype,"autoPageTurningThreshold",[xc,WIt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),lt(rMt.prototype,"verticalScrollBar",[jIt,ol,qIt],Object.getOwnPropertyDescriptor(rMt.prototype,"verticalScrollBar"),rMt.prototype),lt(rMt.prototype,"horizontalScrollBar",[XIt,ol,YIt],Object.getOwnPropertyDescriptor(rMt.prototype,"horizontalScrollBar"),rMt.prototype),aMt=lt(rMt.prototype,"horizontal",[ol,xc,KIt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sMt=lt(rMt.prototype,"vertical",[ol,xc,QIt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cMt=lt(rMt.prototype,"cancelInnerEvents",[ol,xc,ZIt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lMt=lt(rMt.prototype,"scrollEvents",[JIt,xc,ol,$It],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uMt=lt(rMt.prototype,"pageTurningSpeed",[xc,Mc,tMt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),hMt=lt(rMt.prototype,"pageEvents",[eMt,xc,nMt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fMt=lt(rMt.prototype,"_sizeMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xMt.Unified}}),pMt=lt(rMt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SMt.Horizontal}}),dMt=lt(rMt.prototype,"_scrollThreshold",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),_Mt=lt(rMt.prototype,"_pageTurningEventTiming",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),mMt=lt(rMt.prototype,"_indicator",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iMt=rMt))||iMt)||iMt)||iMt)||iMt));u.PageView=bMt;var CMt=new Rn,AMt=new Xn,wMt=new Xn,RMt=new Xn(1,1),PMt=new Xn,IMt=new Xn;function MMt(t,e){if(!e._hadAlignOnce){e.alignMode===eIt.ONCE&&(e._hadAlignOnce=!0);var n,i=e.target,r=wMt,o=RMt;i?oIt(t,n=i,r,o):n=t.parent;var a=rIt(n),s=n instanceof SM||!n.getComponent(LV),c=s?AMt:n.getComponent(LV).anchorPoint,l=s;t.getPosition(CMt);var u=t._uiProps.uiTransformComp,h=CMt.x,f=CMt.y,p=u.anchorPoint,d=t.getScale();if(e.alignFlags&nIt.HORIZONTAL){var _=0,m=0,v=a.width;l?(_=qO.left.x,m=qO.right.x):m=(_=-c.x*v)+v,_+=e.isAbsoluteLeft?e.left:e.left*v,m-=e.isAbsoluteRight?e.right:e.right*v,i&&(_+=r.x,_*=o.x,m+=r.x,m*=o.x);var g=0,y=p.x,x=d.x;if(x<0&&(y=1-y,x=-x),e.isStretchWidth)g=m-_,0!==x&&(u.width=g/x),h=_+y*g;else if(g=u.width*x,e.isAlignHorizontalCenter){var S=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*v,T=(.5-c.x)*a.width;i&&(S*=o.x,T+=r.x,T*=o.x),h=T+(y-.5)*g+S}else h=e.isAlignLeft?_+y*g:m+(y-1)*g;e._lastSize.width=g}if(e.alignFlags&nIt.VERTICAL){var E=0,b=0,C=a.height;l?(b=qO.bottom.y,E=qO.top.y):E=(b=-c.y*C)+C,b+=e.isAbsoluteBottom?e.bottom:e.bottom*C,E-=e.isAbsoluteTop?e.top:e.top*C,i&&(b+=r.y,b*=o.y,E+=r.y,E*=o.y);var A=0,w=p.y,R=d.y;if(R<0&&(w=1-w,R=-R),e.isStretchHeight)A=E-b,0!==R&&(u.height=A/R),f=b+w*A;else if(A=u.height*R,e.isAlignVerticalCenter){var P=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*C,I=(.5-c.y)*a.height;i&&(P*=o.y,I+=r.y,I*=o.y),f=I+(w-.5)*A+P}else f=e.isAlignBottom?b+w*A:E+(w-1)*A;e._lastSize.height=A}t.setPosition(h,f,CMt.z),Rn.set(e._lastPos,h,f,CMt.z)}}function DMt(t){var e=t.getComponent(wIt);if(e&&e.enabled){if(!u.isValid(t,!0))return;LMt.push(e)}for(var n,i=st(t.children);!(n=i()).done;){var r=n.value;r.active&&DMt(r)}}function OMt(){var t=VO.getScene();if(t){BMt.isAligning=!0,BMt._nodesOrderDirty&&(LMt.length=0,DMt(t),BMt._nodesOrderDirty=!1);var e=null,n=BMt._activeWidgetsIterator;for(n.i=0;n.i<LMt.length;++n.i)(e=LMt[n.i])._dirty&&(MMt(e.node,e),e._dirty=!1);BMt.isAligning=!1}}var NMt,LMt=[],BMt=t("widgetManager",u._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new ne.MutableForwardIterator(LMt),animationState:null,init:function(){VO.on(HO.EVENT_AFTER_SCENE_LAUNCH,OMt),VO.on(HO.EVENT_AFTER_UPDATE,OMt),KO.instance.on("design-resolution-changed",this.onResized,this);var t=this.onResized.bind(this);KO.instance.on("canvas-resize",t),ah.on("orientation-change",t)},add:function(){this._nodesOrderDirty=!0},remove:function(t){this._activeWidgetsIterator.remove(t)},onResized:function(){var t=VO.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized:function(t){var e=WC.isNode(t)&&t.getComponent(wIt);e&&e.enabled&&(e.alignMode===eIt.ON_WINDOW_RESIZE||e.alignMode===eIt.ALWAYS)&&e.setDirty();for(var n,i=st(t.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(t,e){function n(t,e){return Math.abs(t-e)>1e-10?e:t}var i=t.node,r=i.parent;if(r){var o=PMt;o.set(0,0);var a=IMt;if(a.set(1,1),t.target&&oIt(i,r=t.target,o,a),!e)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:AMt,l=i._uiProps.uiTransformComp,u=rIt(r),h=l.anchorPoint,f=i.getPosition(),p=nIt,d=i.getScale(),_=0;if(e&p.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,_=f.x-h.x*l.width*d.x-m,t.isAbsoluteLeft||(_/=u.width),_/=a.x,t.left=n(t.left,_)}if(e&p.RIGHT){var v=(1-c.x)*u.width;v+=o.x,_=(v*=a.x)-(f.x+(1-h.x)*l.width*d.x),t.isAbsoluteRight||(_/=u.width),_/=a.x,t.right=n(t.right,_)}if(e&p.TOP){var g=(1-c.y)*u.height;g+=o.y,_=(g*=a.y)-(f.y+(1-h.y)*l.height*d.y),t.isAbsoluteTop||(_/=u.height),_/=a.y,t.top=n(t.top,_)}if(e&p.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,_=f.y-h.y*l.height*d.y-y,t.isAbsoluteBottom||(_/=u.height),_/=a.y,t.bottom=n(t.bottom,_)}}},updateAlignment:function t(e){var n=e.parent;n&&WC.isNode(n)&&t(n);var i=e.getComponent(wIt);i&&n&&MMt(e,i)},AlignMode:eIt,AlignFlags:nIt});VO.on(HO.EVENT_INIT,(function(){BMt.init()}));var FMt,zMt,kMt,UMt,GMt,HMt,VMt,WMt,jMt,qMt,XMt,YMt,KMt,QMt,ZMt,JMt,$Mt,tDt,eDt,nDt=function(e){return t({SafeArea:e,SafeAreaComponent:e}),e}(dc("cc.SafeArea")(NMt=Ic()(NMt=mc(110)(NMt=Cc(NMt=Ac()(NMt=_c(wIt)(NMt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.onEnable=function(){this.updateArea(),ah.on("window-resize",this.updateArea,this),ah.on("orientation-change",this.updateArea,this)},n.onDisable=function(){ah.off("window-resize",this.updateArea,this),ah.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var t=this.node.getComponent(wIt),e=this.node.getComponent(LV);if(t&&e){t.updateAlignment();var n=this.node.position.clone(),i=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;var r=$O.getVisibleSize(),o=r.width,a=r.height,s=lh.getSafeAreaRect();t.top=a-s.y-s.height,t.bottom=s.y,t.left=s.x,t.right=o-s.x-s.width,t.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/e.width,u=i.y-(c.y-n.y)/e.height;e.setAnchorPoint(l,u),BMt.add(t)}},e}($u))||NMt)||NMt)||NMt)||NMt)||NMt)||NMt);u.SafeArea=nDt;var iDt,rDt=function(e){return t({UICoordinateTracker:e,UICoordinateTrackerComponent:e}),e}((FMt=dc("cc.UICoordinateTracker"),zMt=Ic(),kMt=Ac(),UMt=mc(110),GMt=Kc(WC),HMt=Lc(),VMt=Kc(iF),WMt=Lc(),jMt=Lc(),qMt=Lc(),XMt=Kc([zB]),YMt=Lc(),FMt(KMt=zMt(KMt=kMt(KMt=UMt((lt((QMt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(i))||this,"syncEvents",ZMt,ot(e)),ct(e,"_target",JMt,ot(e)),ct(e,"_camera",$Mt,ot(e)),ct(e,"_useScale",tDt,ot(e)),ct(e,"_distance",eDt,ot(e)),e._transformPos=new Rn,e._viewPos=new Rn,e._canMove=!0,e._lastWPos=new Rn,e._lastCameraPos=new Rn,e}$(e,t);var n=e.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&Rn.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);zB.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},Z(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._target=t,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(t){this._useScale!==t&&(this._useScale=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance!==t&&(this._distance=t)}}]),e}($u)).prototype,"target",[GMt,HMt],Object.getOwnPropertyDescriptor(QMt.prototype,"target"),QMt.prototype),lt(QMt.prototype,"camera",[VMt,WMt],Object.getOwnPropertyDescriptor(QMt.prototype,"camera"),QMt.prototype),lt(QMt.prototype,"useScale",[jMt],Object.getOwnPropertyDescriptor(QMt.prototype,"useScale"),QMt.prototype),lt(QMt.prototype,"distance",[qMt],Object.getOwnPropertyDescriptor(QMt.prototype,"distance"),QMt.prototype),ZMt=lt(QMt.prototype,"syncEvents",[XMt,xc,YMt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JMt=lt(QMt.prototype,"_target",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$Mt=lt(QMt.prototype,"_camera",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tDt=lt(QMt.prototype,"_useScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eDt=lt(QMt.prototype,"_distance",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),KMt=QMt))||KMt)||KMt)||KMt)||KMt)),oDt=[HE.TOUCH_START,HE.TOUCH_END,HE.TOUCH_MOVE,HE.MOUSE_DOWN,HE.MOUSE_MOVE,HE.MOUSE_UP,HE.MOUSE_ENTER,HE.MOUSE_LEAVE,HE.MOUSE_WHEEL];function aDt(t){t.propagationStopped=!0}var sDt,cDt,lDt,uDt,hDt,fDt,pDt,dDt,_Dt,mDt,vDt,gDt,yDt=function(e){return t({BlockInputEvents:e,BlockInputEventsComponent:e}),e}(dc("cc.BlockInputEvents")(iDt=Ic()(iDt=Ac()(iDt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var n=e.prototype;return n.onEnable=function(){for(var t=0;t<oDt.length;t++)this.node.on(oDt[t],aDt,this)},n.onDisable=function(){for(var t=0;t<oDt.length;t++)this.node.off(oDt[t],aDt,this)},e}($u))||iDt)||iDt)||iDt),xDt={},SDt=t("SubContextView",(sDt=dc("cc.SubContextView"),cDt=Ic(),lDt=mc(110),uDt=_c(LV),hDt=Ac(),fDt=Lc(),pDt=Lc(),sDt(dDt=cDt(dDt=lDt(dDt=uDt(dDt=hDt((lt((_Dt=function(t){function e(){var e;return ct(e=t.call(this)||this,"_fps",mDt,ot(e)),e._sprite=void 0,e._imageAsset=void 0,e._texture=void 0,e._updatedTime=0,e._updateInterval=0,e._openDataContext=void 0,e._content=void 0,ct(e,"_designResolutionSize",vDt,ot(e)),e._content=new WC("content"),e._content.hideFlags|=dl.Flags.DontSave|dl.Flags.HideInHierarchy,e._sprite=null,e._imageAsset=new tv,e._openDataContext=null,e._updatedTime=performance.now(),e._texture=new Ev,e}$(e,t);var n=e.prototype;return n.onLoad=function(){xDt.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=xDt.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),this._texture.image=e,this._texture.create(t.width,t.height),this._sprite=this._content.getComponent(cY),this._sprite||(this._sprite=this._content.addComponent(cY)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new cH;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var t=this.node.getComponent(LV),e=this._content.getComponent(LV),n=t.width/e.width,i=t.height/e.height,r=n>i?i:n;e.width*=r,e.height*=r;var o=$O.getViewportRect(),a=e.getBoundingBoxToWorld(),s=$O.getVisibleSize(),c=ah.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,f=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:f})}},n._updateSubContextTexture=function(){var t=this._imageAsset;if(t&&this._openDataContext&&!(t.width<=0||t.height<=0)){var e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e)}},n._registerNodeEvent=function(){this.node.on(HE.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(HE.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(HE.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(HE.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(HE.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(HE.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(t){void 0===t?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},Z(e,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}}]),e}($u)).prototype,"designResolutionSize",[fDt],Object.getOwnPropertyDescriptor(_Dt.prototype,"designResolutionSize"),_Dt.prototype),lt(_Dt.prototype,"fps",[pDt],Object.getOwnPropertyDescriptor(_Dt.prototype,"fps"),_Dt.prototype),mDt=lt(_Dt.prototype,"_fps",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),vDt=lt(_Dt.prototype,"_designResolutionSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(640,960)}}),dDt=_Dt))||dDt)||dDt)||dDt)||dDt)||dDt));u.SubContextView=SDt;var TDt=t("UIReorderComponent",dc("cc.UIReorderComponent")(gDt=function(){M(1408,"UIReorderComponent")})||gDt);u.UIReorderComponent=TDt,u.ButtonComponent=EEt,ie.setClassAlias(EEt,"cc.ButtonComponent"),u.EditBoxComponent=KCt,ie.setClassAlias(KCt,"cc.EditBoxComponent"),u.LayoutComponent=xAt,ie.setClassAlias(xAt,"cc.LayoutComponent"),u.ProgressBarComponent=jAt,ie.setClassAlias(jAt,"cc.ProgressBarComponent"),u.ScrollViewComponent=CRt,ie.setClassAlias(CRt,"cc.ScrollViewComponent"),u.ScrollBarComponent=twt,ie.setClassAlias(twt,"cc.ScrollBarComponent"),u.SliderComponent=YRt,ie.setClassAlias(YRt,"cc.SliderComponent"),u.ToggleComponent=cPt,ie.setClassAlias(cPt,"cc.ToggleComponent"),u.ToggleContainerComponent=tIt,ie.setClassAlias(tIt,"cc.ToggleContainerComponent"),u.WidgetComponent=wIt,ie.setClassAlias(wIt,"cc.WidgetComponent"),u.PageViewComponent=bMt,ie.setClassAlias(bMt,"cc.PageViewComponent"),u.PageViewIndicatorComponent=yMt,ie.setClassAlias(yMt,"cc.PageViewIndicatorComponent"),u.SafeAreaComponent=nDt,ie.setClassAlias(nDt,"cc.SafeAreaComponent"),ie.setClassAlias(rDt,"cc.UICoordinateTrackerComponent"),u.BlockInputEventsComponent=yDt,ie.setClassAlias(yDt,"cc.BlockInputEventsComponent")}}}));
