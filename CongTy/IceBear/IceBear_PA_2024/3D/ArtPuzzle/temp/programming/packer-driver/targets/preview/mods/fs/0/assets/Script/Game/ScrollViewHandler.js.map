{"version":3,"sources":["file:///D:/PA_2024/3D/ArtPuzzle/ArtPuzzle_Op1/assets/Script/Game/ScrollViewHandler.ts"],"names":["_decorator","Component","easing","instantiate","log","Node","ScrollView","Sprite","tween","UITransform","Vec3","UIController","Constants","GameCommon","GamePlay","GameController","AudioManager","ccclass","property","ScrollViewHandler","start","Items","forEach","item","on","EventType","TOUCH_START","onItemTouchStart","TOUCH_MOVE","onItemTouchMove","TOUCH_END","onItemTouchEnd","TOUCH_CANCEL","onItemClicked","event","customEventData","Tutorial","active","console","dissolvedItemNumber","installHandle","isCanClick","handleIronSourcePlaySound","playSound","SoundTrack","clickSound","isTouching","node","getComponent","enabled","target","subItem","pos","convertToNodeSpace","getUILocation","pickingItem","children","name","match","currentDragNode","prevPos","pickingStep","Number","filterSameArea","ImpactArea","addChild","setPosition","scaleUpNode","checkImpactArea","sameArea","currentStep","matchSound","isDissolveIn","targetNode","removeChild","removeFromParent","turnBack","WrongSound","screenPos","x","y","scaleNumber","to","scale","elasticOut","dragNode","position","call","area","nodeBdx","getBoundingBox","impactArea","intersects"],"mappings":"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","sourcesContent":["\nimport { _decorator, Button, Component, easing, EventHandler, EventTouch, instantiate, log, Node, ScrollBar, ScrollView, Sprite, tween, UITransform, Vec2, Vec3 } from 'cc';\nimport { UIController } from './UIController';\nimport { Constants } from '../Data/constants';\nimport { GameCommon } from '../Data/GameCommon';\nimport { GamePlay } from './GamePlay';\nimport { GameController } from './GameController';\nimport { AudioManager } from './AudioManager';\nconst { ccclass, property } = _decorator;\n\n\n@ccclass('ScrollViewHandler')\nexport class ScrollViewHandler extends Component {\n\n    @property(UIController)\n    UIController: UIController = null;\n    @property(AudioManager)\n    AudioManager: AudioManager = null;\n    @property(GameController)\n    GameController: GameController = null;\n    @property(GamePlay)\n    GamePlay: GamePlay = null;\n\n    // state\n    prevPos: Vec3 = null;\n    pickingStep: number = 0;\n\n\n    protected start(): void {\n        this.UIController.Items.forEach((item) => {\n\n            item.on(Node.EventType.TOUCH_START, this.onItemTouchStart, this);\n\n            item.on(Node.EventType.TOUCH_MOVE, this.onItemTouchMove, this);\n\n            item.on(Node.EventType.TOUCH_END, this.onItemTouchEnd, this);\n\n            item.on(Node.EventType.TOUCH_CANCEL, this.onItemTouchEnd, this);\n\n        })\n    }\n\n\n    onItemClicked(event: Event, customEventData: any) {\n        this.UIController.Tutorial.active = false;\n        console.log(\"Item clicked: \", customEventData);\n    }\n\n\n    onItemTouchStart(event: EventTouch): void {\n        if(Constants.dissolvedItemNumber >= 20) {\n            this.GameController.installHandle();\n            return;\n        }\n        \n        if (!Constants.isCanClick) return;\n\n        // ironsource\n        this.GamePlay.handleIronSourcePlaySound();\n\n        this.AudioManager.playSound(Constants.SoundTrack.clickSound);\n\n        Constants.isTouching = true;\n\n        this.node.getComponent(ScrollView).enabled = false;\n\n        let item: Node = event.target;  \n        let subItem = instantiate(item);\n        let pos = this.convertToNodeSpace(event.getUILocation());\n        let pickingItem = item.children[0].name;\n        let match = pickingItem.match(/Step(\\d+)_/);\n\n        Constants.currentDragNode = subItem;\n\n        this.prevPos = pos;\n\n        this.pickingStep = Number(match[1]);\n\n        this.GamePlay.filterSameArea(pickingItem);\n\n        this.UIController.ImpactArea.addChild(Constants.currentDragNode);\n\n        item.children[0].getComponent(Sprite).enabled = false;\n\n        Constants.currentDragNode.setPosition(pos);\n\n        this.scaleUpNode(Constants.currentDragNode);\n\n        this.UIController.Tutorial.active = false;\n\n        log(\"picking step: \" + this.pickingStep + \", item: \" + pickingItem);\n    }\n\n\n    onItemTouchMove(event: EventTouch): void {\n        if (!Constants.isCanClick) return;\n\n        let item: Node = event.target;\n        let pos = this.convertToNodeSpace(event.getUILocation());\n\n        if(Constants.currentDragNode) {\n            Constants.currentDragNode.setPosition(pos);\n        }\n\n        if(this.checkImpactArea(Constants.sameArea) && (this.pickingStep === GameCommon.currentStep)) {\n\n            this.AudioManager.playSound(Constants.SoundTrack.matchSound);\n\n            Constants.isCanClick = false;\n            Constants.isDissolveIn = true;\n            Constants.targetNode.active = true;\n            Constants.currentDragNode.active = false;\n\n            this.prevPos = null;\n\n            this.node.getComponent(ScrollView).enabled = true;\n\n            this.UIController.ImpactArea.removeChild(Constants.currentDragNode);\n\n            item.active = false;\n\n            item.removeFromParent();\n\n            log(\"Correct!! dissolving!!\");\n        }\n    }\n\n\n    onItemTouchEnd(event: EventTouch): void {\n        if (!Constants.isCanClick || !Constants.currentDragNode) return;\n\n        let item: Node = event.target;\n\n        Constants.isTouching = false;\n        \n        if(this.pickingStep !== GameCommon.currentStep || !this.checkImpactArea(Constants.sameArea)) {\n            this.turnBack(Constants.currentDragNode, item);\n            this.AudioManager.playSound(Constants.SoundTrack.WrongSound);\n        }\n    }\n\n\n    private convertToNodeSpace(screenPos: Vec2): Vec3 {\n        let pos = new Vec3((screenPos.x - 160), (screenPos.y - 240), 0);\n        return pos;\n    }\n\n\n    private scaleUpNode(Node: Node): void {\n        log(\"saleUp ```\")\n\n        let scaleNumber: number = 2;\n\n        if(Node.name === \"item_16\" || Node.name === \"item_17\" || Node.name === \"item_8\") scaleNumber = 3.5;\n\n        tween(Node)\n            .to(0.5, { scale: new Vec3(scaleNumber, scaleNumber, scaleNumber) }, { easing: easing.elasticOut })\n            .start();\n    }\n\n\n    private turnBack(dragNode: Node, item: Node): void {\n        log(\"TurnBack ```\")\n\n        Constants.isCanClick = false;\n        this.node.getComponent(ScrollView).enabled = true;\n\n        tween(dragNode)\n            .to(0.5, { scale: new Vec3(1, 1, 1), position: this.prevPos })\n            .call(() => {\n                this.prevPos = null;\n\n                item.children[0].getComponent(Sprite).enabled = true;\n\n                dragNode.active = false;\n\n                Constants.currentDragNode = null;\n\n                this.node.getComponent(ScrollView).enabled = true;\n\n                Constants.isCanClick = true;\n            }).start();\n    }\n\n\n    private checkImpactArea(area: Node): boolean {\n        if (Constants.currentDragNode) {\n            let nodeBdx = Constants.currentDragNode.getComponent(UITransform).getBoundingBox();\n            let impactArea = area.getComponent(UITransform).getBoundingBox();\n\n            if (impactArea.intersects(nodeBdx)) return true;\n            else return false;\n        }\n    }\n}\n"]}